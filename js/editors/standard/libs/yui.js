;var Device=function(){}
Device.detect=function(){this.type='browser';}
Device.setDeviceType=function(type){this.type=type;}
Device.getDeviceType=function(){return this.type;}
Device.detect();;;var PrelaoderModel=Backbone.Model.extend({defaults:function(){return{}},});;;var PreladerView=Backbone.View.extend({className:'preloader-view',template:_.template($('#preloader-view-template').html()),render:function(){var template=this.template(this.serializeData());this.$el.html(template);return this;},serializeData:function(){return{};}});var ProjectsListControllerLoader=PreladerView.extend({});var NotEditableProjectViewLoader=PreladerView.extend({className:'loader preloader-view',events:{'close':'remove'},});var CropWindowLoader=PreladerView.extend({className:'loader preloader-view',events:{'close':'remove'},});var PreviewProjectLoader=PreladerView.extend({className:'preloader-view preloader-view-preview',template:_.template($('#preloader-view-preview-template').html()),});var LoadProjectLoader=PreladerView.extend({});;;function PreloaderFactory(){}
PreloaderFactory.createDefaultLoader=function(){var loader=new PreladerView({model:new PrelaoderModel()});return loader;}
PreloaderFactory.createProjectsListControllerLoader=function(){var loader=new ProjectsListControllerLoader({model:new PrelaoderModel()});return loader;}
PreloaderFactory.createNotEditableProjectViewLoader=function(){var loader=new NotEditableProjectViewLoader({model:new PrelaoderModel()});return loader;}
PreloaderFactory.createCropWindowLoader=function(){var loader=new CropWindowLoader({model:new PrelaoderModel()});return loader;}
PreloaderFactory.createPreviewProjectLoader=function(){var loader=new PreviewProjectLoader({model:new PrelaoderModel()});return loader;}
PreloaderFactory.createLoadProjectLoader=function(){var loader=new LoadProjectLoader({model:new PrelaoderModel()});return loader;};;var DeleteEventsVisitor=function(){}
DeleteEventsVisitor.prototype.visit=function(view){var _that=this;view.undelegateEvents();for(var i=0;i<view.capabilitiesParmasList.length;i++){var param=view.capabilitiesParmasList[i];var ev=param.event==undefined?'click':param.event;if(!param.value){if(_.isFunction(view.events)){var viewEvents=view.events();delete viewEvents[ev+' '+param.identifier];view.events=viewEvents;}
if(_.isObject(view.events)){var viewEvents=view.events;delete viewEvents[ev+' '+param.identifier];}
view.$el.find(param.identifier).click(function(){_that.openFunctionNotAvailableWindow();});view.$el.find(param.identifier).addClass('element-disabled');}};delete view.capabilitiesParmasList;view.delegateEvents();}
DeleteEventsVisitor.prototype.openFunctionNotAvailableWindow=function(){var functionNotAvailableWindow=WindowFactory.createFunctionNotAvailableWindow();$('body').append(functionNotAvailableWindow.render().$el);}
DeleteEventsVisitor.getInstance=function(){return this.instance||(this.instance=new DeleteEventsVisitor());};;var DeletePageEventsVisitor=function(){}
DeletePageEventsVisitor.prototype.visit=function(view){var _that=this;view.undelegateEvents();for(var i=0;i<view.capabilitiesParmasList.length;i++){var param=view.capabilitiesParmasList[i];var ev=param.event==undefined?'click':param.event;if(!param.value){if(_.isFunction(view.events)){var viewEvents=view.events();delete viewEvents[ev+' '+param.identifier];view.events=viewEvents;}
if(_.isObject(view.events)){var viewEvents=view.events;delete viewEvents[ev+' '+param.identifier];}
view.$el.find(param.identifier).addClass('element-disabled');}};delete view.capabilitiesParmasList;view.delegateEvents();}
DeletePageEventsVisitor.getInstance=function(){return this.instance||(this.instance=new DeletePageEventsVisitor());};;var AddEventsVisitor=function(){}
AddEventsVisitor.prototype.visit=function(view){view.undelegateEvents();for(var i=0;i<view.capabilitiesParmasList.length;i++){var param=view.capabilitiesParmasList[i];var ev=param.event==undefined?'click':param.event;if(param.value){if(_.isFunction(view.events)){var viewEvents=view.events();viewEvents[ev+' '+param.identifier]=param.fun;view.events=viewEvents;}
if(_.isObject(view.events)){var viewEvents=view.events;viewEvents[ev+' '+param.identifier]=param.fun;}
view.$el.find(param.identifier).removeClass('element-disabled');}};delete view.capabilitiesParmasList;view.delegateEvents();}
AddEventsVisitor.getInstance=function(){return this.instance||(this.instance=new AddEventsVisitor());};;function EventDispatcher()
{this.listeners={};}
EventDispatcher.prototype.dispatchEvent=function(type,params,sender)
{if(this.listeners[type]!=null)
this.listeners[type](params,sender);}
EventDispatcher.prototype.addEventListener=function(type,callback)
{this.listeners[type]=callback;}
EventDispatcher.prototype.removeEventListener=function(type)
{delete this.listeners[type];}
function DarkanEditorAplicationAPI(data){var _that=this;this.origin=DarkanEditorAplicationAPI.PREVENT_ORIGIN;this.controller=DarkanEditorController;window.addEventListener('message',function(e){_that.onMessageApiComming(e);},false);}
DarkanEditorAplicationAPI.ON_CONNECT='on-connect';DarkanEditorAplicationAPI.ON_PAGE_ADDED='on-page-added';DarkanEditorAplicationAPI.ON_PAGES_REMOVED='on-pages-removed';DarkanEditorAplicationAPI.ON_PAGE_SELECTED='on-page-selected';DarkanEditorAplicationAPI.ON_PROJECT_LOADED='on-project-loaded';DarkanEditorAplicationAPI.ON_PAGES_COLLECTION_CHANGED='on-pages-collection-chenged';DarkanEditorAplicationAPI.ON_COMPONENT_CHANGED='on-component-chenged';DarkanEditorAplicationAPI.ON_PROJECT_CHANGED='on-project-chenged';DarkanEditorAplicationAPI.GO_TO_NEXT_PAGE='go-to-next-page';DarkanEditorAplicationAPI.PREVENT_ORIGIN='*';DarkanEditorAplicationAPI.DARKAN_SENDER='darkan';DarkanEditorAplicationAPI.prototype=new EventDispatcher();DarkanEditorAplicationAPI.prototype.onMessageApiComming=function(e){_log('MESSAGE TO APPLICATION',e,_log.apidata);try{var jData=JSON.parse(e.data);var action=jData.action;var sender=jData.sender;if(sender==undefined||sender==DarkanEditorAplicationAPI.DARKAN_SENDER){return;}
_log('DarkanEditorAplicationAPI data',jData);switch(action){case'no-message':_log('no-message',jData);break;case'go-to-page':this.controller.goToPage(jData.data,this);break;case'go-to-next-page':this.controller.goToNextPage(jData.data,this);break;case'go-to-prew-page':this.controller.goToPrewPage(jData.data,this);break;case'go-to-prev-page':this.controller.goToPrevPage(jData.data,this);break;case'send-credentials':this.controller.sendCredentials(jData.data,this);break;case'sort-pages':this.controller.sortPages(jData.data,this);break;}}catch(ex){_log('ex',ex,_log.apierror);}}
DarkanEditorAplicationAPI.prototype.connect=function(data){this.execute(DarkanEditorAplicationAPI.ON_CONNECT,data);}
DarkanEditorAplicationAPI.prototype.pageSelected=function(data){this.execute(DarkanEditorAplicationAPI.ON_PAGE_SELECTED,data);}
DarkanEditorAplicationAPI.prototype.pageAdded=function(data){this.execute(DarkanEditorAplicationAPI.ON_PAGE_ADDED,data);}
DarkanEditorAplicationAPI.prototype.pagesRemoved=function(data){this.execute(DarkanEditorAplicationAPI.ON_PAGES_REMOVED,data);}
DarkanEditorAplicationAPI.prototype.projectLoaded=function(data){this.execute(DarkanEditorAplicationAPI.ON_PROJECT_LOADED,data);}
DarkanEditorAplicationAPI.prototype.pagesCollectionChanged=function(data){this.execute(DarkanEditorAplicationAPI.ON_PAGES_COLLECTION_CHANGED,data);}
DarkanEditorAplicationAPI.prototype.componentChanged=function(data){this.execute(DarkanEditorAplicationAPI.ON_COMPONENT_CHANGED,data);}
DarkanEditorAplicationAPI.prototype.projectChanged=function(data){this.execute(DarkanEditorAplicationAPI.ON_PROJECT_CHANGED,data);}
DarkanEditorAplicationAPI.prototype.execute=function(action,data){data=data==undefined?{}:data;action=action==undefined?'no-action':action;var e={};e.action=action;e.sender=DarkanEditorAplicationAPI.DARKAN_SENDER;e.data=data;var se=JSON.stringify(e);_log('try to send message ',se);top.postMessage(se,this.origin);}
DarkanEditorAplicationAPI.prototype.setApiController=function(controller){this.controller=controller;}
DarkanEditorAplicationAPI.getInstance=function(){return this.instance||(this.instance=new DarkanEditorAplicationAPI());};;function DarkanEditorController()
{}
DarkanEditorController.goToPage=function(data,sender){ProjectView.instance.goToPage(data);}
DarkanEditorController.goToNextPage=function(data,sender){ProjectView.instance.goToNextPage(data);}
DarkanEditorController.goToPrewPage=function(data,sender){ProjectView.instance.goToPrewPage(data);}
DarkanEditorController.goToPrevPage=function(data,sender){ProjectView.instance.goToPrevPage(data);}
DarkanEditorController.sendCredentials=function(data,sender){DataAccess.loginExternal(data,function(rdata){_log('sendCredentials result',rdata,_log.dataaccessOutResult);},function(rdata){_log('sendCredentials fault',rdata,_log.dataaccessOutFault);});}
DarkanEditorController.sortPages=function(data,sender){ProjectView.instance.sortPages(data);};;var State=function(){}
State.NORMAL='normal';State.BASIC='basic';State.TESTDRIVE='test-drive';State.detect=function(){if(__meta__.projectID==0){this.state=State.TESTDRIVE;}else{this.state=State.NORMAL;}}
State.getStateType=function(state){this.state=state;}
State.getStateType=function(){return this.state;}
State.isTestDrive=function(){return this.state==State.TESTDRIVE?true:false;}
State.detect();;;var Utils={};Utils.getURLParam=function()
{url=window.location.search.substring(0);var result={};var searchIndex=url.indexOf("?");if(searchIndex==-1)return result;var sPageURL=url.substring(searchIndex+1);var sURLVariables=sPageURL.split('&');for(var i=0;i<sURLVariables.length;i++)
{var sParameterName=sURLVariables[i].split('=');result[sParameterName[0]]=sParameterName[1];}
return result;}
Utils.getMinutesUntilNextHour=function(){return((60-new Date().getMinutes())*60)-(60-new Date().getSeconds())};Utils.setModalText=function(textValues,showRefreshButton){if(!_.isUndefined(textValues.main)){_layout.load_project_modal.find('.main').html(textValues.main);}
if(!_.isUndefined(textValues.extra)){_layout.load_project_modal.find('.extra').html(textValues.extra);}
if(showRefreshButton){_layout.load_project_modal.find('.extra').append('<figcaption class="extra"><button class="refresh-page-btn editor-settings-button" onClick="window.location.reload()">'+'<i class="fa fa-refresh"></i> '+_lang('ERROR_OCCURED_REFRESH')+'</button></figcaption>');}}
Utils.showErrorModal=function(){$('#unexpected-error-modal').fadeIn(500).css({'z-index':'99999'});}
Utils.showNormalModal=function(){_layout.load_project_modal.show();}
Backbone.Model.prototype.toJSON=function(){var json=_.clone(this.attributes);for(var attr in json){if((json[attr]instanceof Backbone.Model)||(json[attr]instanceof Backbone.Collection)){json[attr]=json[attr].toJSON();}}
return json;};function isFirefox(){return navigator.userAgent.toLowerCase().indexOf('firefox')>-1;}
Utils.isFirefox=function(){return navigator.userAgent.toLowerCase().indexOf('firefox')>-1;}
Utils.isChrome=function(){return navigator.userAgent.toLowerCase().indexOf('chrome')>-1;}
Utils.getInternetExplorerVersion=function()
{var rv=-1;if(navigator.appName=='Microsoft Internet Explorer')
{var ua=navigator.userAgent;var re=new RegExp("MSIE ([0-9]{1,}[\.0-9]{0,})");if(re.exec(ua)!=null)
rv=parseFloat(RegExp.$1);}
else if(navigator.appName=='Netscape')
{var ua=navigator.userAgent;var re=new RegExp("Trident/.*rv:([0-9]{1,}[\.0-9]{0,})");if(re.exec(ua)!=null)
rv=parseFloat(RegExp.$1);}
return rv;}
Utils.selectWholeText=function(el){if(isFirefox()){return Utils.placeCaretAtEnd($(el).closest('.note-editable')[0]);}
var sel,range;if(window.getSelection&&document.createRange){range=document.createRange();range.selectNodeContents(el);sel=window.getSelection();sel.removeAllRanges();sel.addRange(range);}else if(document.body.createTextRange){}}
Utils.placeCaretAtEnd=function(el){el.focus();if(typeof window.getSelection!="undefined"&&typeof document.createRange!="undefined"){var range=document.createRange();range.selectNodeContents(el);range.collapse(false);var sel=window.getSelection();sel.removeAllRanges();sel.addRange(range);}else if(typeof document.body.createTextRange!="undefined"){var textRange=document.body.createTextRange();textRange.moveToElementText(el);textRange.collapse(false);textRange.select();}
$(el).mouseup();}
Utils.generateUniqueHash=function(){var ra=Math.floor((Math.random()*100000));var da=new Date().getTime();var str=ra.toString()+da.toString();var ha=CryptoJS.MD5(str).toString();return ha;}
function _lang(translationString){return Lang.get('editor.'+translationString);}
(function(){var oldSetOption=$.ui.resizable.prototype._setOption;$.ui.resizable.prototype._setOption=function(key,value){oldSetOption.apply(this,arguments);if(key==="aspectRatio"){this._aspectRatio=!!value;}};})();Utils.arrayAreEqual=function(array1,array2){return array1.length==array2.length&&array1.every(function(element,index){return element===array2[index];});}
Utils.reduce=function(arr){arr.reduce(function(a,b){return(a===b)?a:"";});}
Utils.rgb2hex=function(rgb){var isHexColor=/^#[0-9A-F]{6}$/i.test(rgb);if(!isHexColor&&rgb.length!=4){if(rgb.substr(0,3)=='rgb'&&rgb.substr(0,4)!='rgba'){rgb=rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);}else if(rgb.substr(0,4)=='rgba'){rgb=rgb.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\S+))?\)$/);}else{rgb=new Array();}
function hex(x){return("0"+parseInt(x).toString(16)).slice(-2);}
return"#"+hex(rgb[1])+hex(rgb[2])+hex(rgb[3]);}else{return rgb;}}
Utils.isDarkanExtension=function(e){if(e.originalEvent&&e.originalEvent.dataTransfer){_log('e.originalEvent',e.originalEvent);if(e.originalEvent.dataTransfer.files.length==0){return false;}else{var file=e.originalEvent.dataTransfer.files[0];var fileName=file.name;var rePsd=new RegExp("^.*\."+'darkan'+"$");if(rePsd.test(fileName)){return true;}}}else{return false;}
return false;}
Utils.setCookie=function(cname,cvalue,exdays){var d=new Date();d.setTime(d.getTime()+(exdays*24*60*60*1000));var expires="expires="+d.toUTCString();document.cookie=cname+"="+cvalue+"; "+expires;},Utils.getCookie=function(cname){var name=cname+"=";var ca=document.cookie.split(';');for(var i=0;i<ca.length;i++){var c=ca[i];while(c.charAt(0)==' ')c=c.substring(1);if(c.indexOf(name)==0)return c.substring(name.length,c.length);}
return"";}
Utils.mapKeyCode=function(keyCode){var keyboardMap=["","","","CANCEL","","","HELP","","BACK_SPACE","TAB","","","CLEAR","ENTER","RETURN","","SHIFT","CONTROL","ALT","PAUSE","CAPS_LOCK","KANA","EISU","JUNJA","FINAL","HANJA","","ESCAPE","CONVERT","NONCONVERT","ACCEPT","MODECHANGE","SPACE","PAGE_UP","PAGE_DOWN","END","HOME","LEFT","UP","RIGHT","DOWN","SELECT","PRINT","EXECUTE","PRINTSCREEN","INSERT","DELETE","","0","1","2","3","4","5","6","7","8","9","COLON","SEMICOLON","LESS_THAN","EQUALS","GREATER_THAN","QUESTION_MARK","AT","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","WIN","","CONTEXT_MENU","","SLEEP","NUMPAD0","NUMPAD1","NUMPAD2","NUMPAD3","NUMPAD4","NUMPAD5","NUMPAD6","NUMPAD7","NUMPAD8","NUMPAD9","MULTIPLY","ADD","SEPARATOR","SUBTRACT","DECIMAL","DIVIDE","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12","F13","F14","F15","F16","F17","F18","F19","F20","F21","F22","F23","F24","","","","","","","","","NUM_LOCK","SCROLL_LOCK","WIN_OEM_FJ_JISHO","WIN_OEM_FJ_MASSHOU","WIN_OEM_FJ_TOUROKU","WIN_OEM_FJ_LOYA","WIN_OEM_FJ_ROYA","","","","","","","","","","CIRCUMFLEX","EXCLAMATION","DOUBLE_QUOTE","HASH","DOLLAR","PERCENT","AMPERSAND","UNDERSCORE","OPEN_PAREN","CLOSE_PAREN","ASTERISK","PLUS","PIPE","HYPHEN_MINUS","OPEN_CURLY_BRACKET","CLOSE_CURLY_BRACKET","TILDE","","","","","VOLUME_MUTE","VOLUME_DOWN","VOLUME_UP","","","SEMICOLON","EQUALS","COMMA","MINUS","PERIOD","SLASH","BACK_QUOTE","","","","","","","","","","","","","","","","","","","","","","","","","","","OPEN_BRACKET","BACK_SLASH","CLOSE_BRACKET","QUOTE","","META","ALTGR","","WIN_ICO_HELP","WIN_ICO_00","","WIN_ICO_CLEAR","","","WIN_OEM_RESET","WIN_OEM_JUMP","WIN_OEM_PA1","WIN_OEM_PA2","WIN_OEM_PA3","WIN_OEM_WSCTRL","WIN_OEM_CUSEL","WIN_OEM_ATTN","WIN_OEM_FINISH","WIN_OEM_COPY","WIN_OEM_AUTO","WIN_OEM_ENLW","WIN_OEM_BACKTAB","ATTN","CRSEL","EXSEL","EREOF","PLAY","ZOOM","","PA1","WIN_OEM_CLEAR",""];return keyboardMap[keyCode];}
Utils.ObjectLength=function(obj){var length=0;for(var o in obj){length++;}
return length;}
Utils.isYoutubeLink=function(url){var regExp=/^.*(youtu\.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;var match=url.match(regExp);if(match&&match[2].length==11){return true;}else{return false;}}
Utils.isImageLink=function(url){var regExp=/([a-z\-_0-9\/\:\.]*\.(jpg|jpeg|png|gif))/i;return regExp.test(url);}
Utils.setChatLanguage=function(){smartsupp('translate',{online:{title:_lang('SMARTSSUP_title'),infoTitle:_lang('SMARTSSUP_infoTitle'),infoDesc:_lang('SMARTSSUP_infoDesc')},offline:{title:_lang('SMARTSSUP_offlinetitle'),notice:_lang('SMARTSSUP_offlinenotice')},login:{title:_lang('SMARTSSUP_logintitle'),messageLabel:_lang('SMARTSSUP_loginessageLabel'),submit:_lang('SMARTSSUP_loginsubmit')},widget:{online:_lang('SMARTSSUP_widgetonline'),away:_lang('SMARTSSUP_widgetawaw'),offline:_lang('SMARTSSUP_widgetoffline'),},banner:{bubble:{text:_lang('SMARTSSUP_bannerbubbletext')},arrow:{title:_lang('SMARTSSUP_bannerarrowtitle'),desc:_lang('SMARTSSUP_bannerarrowdesc')}},button:{title:_lang('SMARTSSUP_buttontitle')}},'en');smartsupp('translate',{online:{title:_lang('SMARTSSUP_title'),infoTitle:_lang('SMARTSSUP_infoTitle'),infoDesc:_lang('SMARTSSUP_infoDesc')},offline:{title:_lang('SMARTSSUP_offlinetitle'),notice:_lang('SMARTSSUP_offlinenotice')},login:{title:_lang('SMARTSSUP_logintitle'),messageLabel:_lang('SMARTSSUP_loginessageLabel'),submit:_lang('SMARTSSUP_loginsubmit')},widget:{online:_lang('SMARTSSUP_widgetonline'),away:_lang('SMARTSSUP_widgetawaw'),offline:_lang('SMARTSSUP_widgetoffline'),},banner:{bubble:{text:_lang('SMARTSSUP_bannerbubbletext')},arrow:{title:_lang('SMARTSSUP_bannerarrowtitle'),desc:_lang('SMARTSSUP_bannerarrowdesc')}},button:{title:_lang('SMARTSSUP_buttontitle')}},'pl');smartsupp('language',__lang);}
Utils.setChatLanguage();(function($){$.fn.offsetRelative=function(top){var $this=$(this);var $parent=$this.offsetParent();var offset=$this.position();if(!top)return offset;else if($parent.get(0).tagName=="BODY")return offset;else if($(top,$parent).length)return offset;else if($parent[0]==$(top)[0])return offset;else{var parent_offset=$parent.offsetRelative(top);offset.top+=parent_offset.top;offset.left+=parent_offset.left;return offset;}};$.fn.positionRelative=function(top){return $(this).offsetRelative(top);};}(jQuery));;var HxOverrides=function(){}
HxOverrides.dateStr=function(date){var m=date.getMonth()+1;var d=date.getDate();var h=date.getHours();var mi=date.getMinutes();var s=date.getSeconds();return date.getFullYear()+"-"+(m<10?"0"+m:""+m)+"-"+(d<10?"0"+d:""+d)+" "+(h<10?"0"+h:""+h)+":"+(mi<10?"0"+mi:""+mi)+":"+(s<10?"0"+s:""+s);}
HxOverrides.strDate=function(s){switch(s.length){case 8:var k=s.split(":");var d=new Date();d.setTime(0);d.setUTCHours(k[0]);d.setUTCMinutes(k[1]);d.setUTCSeconds(k[2]);return d;case 10:var k=s.split("-");return new Date(k[0],k[1]-1,k[2],0,0,0);case 19:var k=s.split(" ");var y=k[0].split("-");var t=k[1].split(":");return new Date(y[0],y[1]-1,y[2],t[0],t[1],t[2]);default:throw"Invalid date format : "+s;}}
HxOverrides.cca=function(s,index){var x=s.charCodeAt(index);if(x!=x)return undefined;return x;}
HxOverrides.substr=function(s,pos,len){if(pos!=null&&pos!=0&&len!=null&&len<0)return"";if(len==null)len=s.length;if(pos<0){pos=s.length+pos;if(pos<0)pos=0;}else if(len<0)len=s.length+len-pos;return s.substr(pos,len);}
HxOverrides.remove=function(a,obj){var i=0;var l=a.length;while(i<l){if(a[i]==obj){a.splice(i,1);return true;}
i++;}
return false;}
HxOverrides.iter=function(a){return{cur:0,arr:a,hasNext:function(){return this.cur<this.arr.length;},next:function(){return this.arr[this.cur++];}};};;var StringTools=function(){}
StringTools.htmlEscape=function(s){return s.split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;");}
StringTools.htmlUnescape=function(s){return s.split("&gt;").join(">").split("&lt;").join("<").split("&amp;").join("&");}
StringTools.startsWith=function(s,start){return s.length>=start.length&&HxOverrides.substr(s,0,start.length)==start;}
StringTools.endsWith=function(s,end){var elen=end.length;var slen=s.length;return slen>=elen&&HxOverrides.substr(s,slen-elen,elen)==end;}
StringTools.isSpace=function(s,pos){var c=HxOverrides.cca(s,pos);return c>=9&&c<=13||c==32;}
StringTools.ltrim=function(s){var l=s.length;var r=0;while(r<l&&StringTools.isSpace(s,r))r++;if(r>0)return HxOverrides.substr(s,r,l-r);else return s;}
StringTools.rtrim=function(s){var l=s.length;var r=0;while(r<l&&StringTools.isSpace(s,l-r-1))r++;if(r>0)return HxOverrides.substr(s,0,l-r);else return s;}
StringTools.trim=function(s){return StringTools.ltrim(StringTools.rtrim(s));}
StringTools.rpad=function(s,c,l){var sl=s.length;var cl=c.length;while(sl<l)if(l-sl<cl){s+=HxOverrides.substr(c,0,l-sl);sl=l;}else{s+=c;sl+=cl;}
return s;}
StringTools.lpad=function(s,c,l){var ns="";var sl=s.length;if(sl>=l)return s;var cl=c.length;while(sl<l)if(l-sl<cl){ns+=HxOverrides.substr(c,0,l-sl);sl=l;}else{ns+=c;sl+=cl;}
return ns+s;}
StringTools.replace=function(s,sub,by){return s.split(sub).join(by);}
StringTools.hex=function(n,digits){var s="";var hexChars="0123456789ABCDEF";do{s=hexChars.charAt(n&15)+s;n>>>=4;}while(n>0);if(digits!=null)while(s.length<digits)s="0"+s;return s;}
StringTools.fastCodeAt=function(s,index){return s.charCodeAt(index);}
StringTools.isEOF=function(c){return c!=c;};;_log.pageOptions='background: #E1D42D; color: black;';_log.apidata='background: #5CF94A; color: black; border: 1px solid black;';_log.apierror='background: red; color: black;';_log.timeline='background: #2FE026; color: white; border: 1px solid black;';_log.updateComingInStage='background: #E85E32; color: white; border: 1px solid black;';_log.rightMenu='background: #2788E0; color: white; border: 1px solid black;';_log.dataaccessOutResult='background: #9158E0; color: white; border: 1px solid black;';_log.dataaccessOutFault='background: #810C29; color: white;';_log.dataaccessIn='background: #9D0DFF; color: white;';_log.error='background: red; color: white;';_log.message='background: pink;';_log.selector='background: #FF0EE8;';_log.componentView='background: #5FE1D6;';_log.stageView='background: #E0CD05;';_log.imageComponetView='background: #0AE18B;';_log.popup='background: #05E01C;';_log.trigger='background: #E88134;';_log.history='background: #000000; color: white;';_log.historyBack='background: #FF000F; color: white;';_log.api='background: #FF0DFF; color: white;';function _log(message,object,css){var hostname=window.location.hostname;var islocalhost=(hostname=='pio.pl'||hostname=='jerzy.pl'||hostname=='localhost');var DEBUG=islocalhost?true:false;if(DEBUG){css=css||_log.message;if(console&&console.log){console.log("%c%s",css,message,object);}}};;(function(factory){if(typeof define==='function'&&define.amd){define(['jquery'],factory);}else{factory(window.jQuery);}}(function($){if(!Array.prototype.reduce){Array.prototype.reduce=function(callback){var t=Object(this),len=t.length>>>0,k=0,value;if(arguments.length===2){value=arguments[1];}else{while(k<len&&!(k in t)){k++;}
if(k>=len){throw new TypeError('Reduce of empty array with no initial value');}
value=t[k++];}
for(;k<len;k++){if(k in t){value=callback(value,t[k],k,t);}}
return value;};}
if('function'!==typeof Array.prototype.filter){Array.prototype.filter=function(func){var t=Object(this),len=t.length>>>0;var res=[];var thisArg=arguments.length>=2?arguments[1]:void 0;for(var i=0;i<len;i++){if(i in t){var val=t[i];if(func.call(thisArg,val,i,t)){res.push(val);}}}
return res;};}
var isSupportAmd=typeof define==='function'&&define.amd;var isFontInstalled=function(fontName){var testFontName=fontName==='Comic Sans MS'?'Courier New':'Comic Sans MS';var $tester=$('<div>').css({position:'absolute',left:'-9999px',top:'-9999px',fontSize:'200px'}).text('mmmmmmmmmwwwwwww').appendTo(document.body);var originalWidth=$tester.css('fontFamily',testFontName).width();var width=$tester.css('fontFamily',fontName+','+testFontName).width();$tester.remove();return originalWidth!==width;};var agent={isMac:navigator.appVersion.indexOf('Mac')>-1,isMSIE:navigator.userAgent.indexOf('MSIE')>-1||navigator.userAgent.indexOf('Trident')>-1,isFF:navigator.userAgent.indexOf('Firefox')>-1,jqueryVersion:parseFloat($.fn.jquery),isSupportAmd:isSupportAmd,hasCodeMirror:isSupportAmd?require.specified('CodeMirror'):!!window.CodeMirror,isFontInstalled:isFontInstalled,isW3CRangeSupport:!!document.createRange};var func=(function(){var eq=function(itemA){return function(itemB){return itemA===itemB;};};var eq2=function(itemA,itemB){return itemA===itemB;};var peq2=function(propName){return function(itemA,itemB){return itemA[propName]===itemB[propName];};};var ok=function(){return true;};var fail=function(){return false;};var not=function(f){return function(){return!f.apply(f,arguments);};};var and=function(fA,fB){return function(item){return fA(item)&&fB(item);};};var self=function(a){return a;};var idCounter=0;var uniqueId=function(prefix){var id=++idCounter+'';return prefix?prefix+id:id;};var rect2bnd=function(rect){var $document=$(document);return{top:rect.top+$document.scrollTop(),left:rect.left+$document.scrollLeft(),width:rect.right-rect.left,height:rect.bottom-rect.top};};var invertObject=function(obj){var inverted={};for(var key in obj){if(obj.hasOwnProperty(key)){inverted[obj[key]]=key;}}
return inverted;};return{eq:eq,eq2:eq2,peq2:peq2,ok:ok,fail:fail,self:self,not:not,and:and,uniqueId:uniqueId,rect2bnd:rect2bnd,invertObject:invertObject};})();var list=(function(){var head=function(array){return array[0];};var last=function(array){return array[array.length-1];};var initial=function(array){return array.slice(0,array.length-1);};var tail=function(array){return array.slice(1);};var find=function(array,pred){for(var idx=0,len=array.length;idx<len;idx++){var item=array[idx];if(pred(item)){return item;}}};var all=function(array,pred){for(var idx=0,len=array.length;idx<len;idx++){if(!pred(array[idx])){return false;}}
return true;};var contains=function(array,item){return $.inArray(item,array)!==-1;};var sum=function(array,fn){fn=fn||func.self;return array.reduce(function(memo,v){return memo+fn(v);},0);};var from=function(collection){var result=[],idx=-1,length=collection.length;while(++idx<length){result[idx]=collection[idx];}
return result;};var clusterBy=function(array,fn){if(!array.length){return[];}
var aTail=tail(array);return aTail.reduce(function(memo,v){var aLast=last(memo);if(fn(last(aLast),v)){aLast[aLast.length]=v;}else{memo[memo.length]=[v];}
return memo;},[[head(array)]]);};var compact=function(array){var aResult=[];for(var idx=0,len=array.length;idx<len;idx++){if(array[idx]){aResult.push(array[idx]);}}
return aResult;};var unique=function(array){var results=[];for(var idx=0,len=array.length;idx<len;idx++){if(!contains(results,array[idx])){results.push(array[idx]);}}
return results;};var next=function(array,item){var idx=array.indexOf(item);if(idx===-1){return null;}
return array[idx+1];};var prev=function(array,item){var idx=array.indexOf(item);if(idx===-1){return null;}
return array[idx-1];};return{head:head,last:last,initial:initial,tail:tail,prev:prev,next:next,find:find,contains:contains,all:all,sum:sum,from:from,clusterBy:clusterBy,compact:compact,unique:unique};})();var NBSP_CHAR=String.fromCharCode(160);var ZERO_WIDTH_NBSP_CHAR='\ufeff';var dom=(function(){var isEditable=function(node){return node&&$(node).hasClass('note-editable');};var isControlSizing=function(node){return node&&$(node).hasClass('note-control-sizing');};var buildLayoutInfo=function($editor){var makeFinder;if($editor.hasClass('note-air-editor')){var id=list.last($editor.attr('id').split('-'));makeFinder=function(sIdPrefix){return function(){return $(sIdPrefix+id);};};return{editor:function(){return $editor;},editable:function(){return $editor;},popover:makeFinder('#note-popover-'),handle:makeFinder('#note-handle-'),dialog:makeFinder('#note-dialog-')};}else{makeFinder=function(sClassName){return function(){if(sClassName=='.note-toolbar'){return $('#menu-text').find('.note-toolbar');}else if(sClassName=='.note-dialog'){return $('.note-dialog');}else{return $editor.find(sClassName);}};};return{editor:function(){return window._textEditorOptions.componentEl.find('.note-editor');},toolbar:function(){return window._textEditorOptions.editorWrapper.find('.note-toolbar');},editable:function(){return window._textEditorOptions.componentEl.find('.note-editable');},popover:makeFinder('.note-popover'),handle:makeFinder('.note-handle'),dialog:makeFinder('.note-dialog')};}};var makePredByNodeName=function(nodeName){nodeName=nodeName.toUpperCase();return function(node){return node&&node.nodeName.toUpperCase()===nodeName;};};var isText=function(node){return node&&node.nodeType===3;};var isVoid=function(node){return node&&/^BR|^IMG|^HR/.test(node.nodeName.toUpperCase());};var isPara=function(node){if(isEditable(node)){return false;}
return node&&/^DIV|^P|^LI|^H[1-7]/.test(node.nodeName.toUpperCase());};var isLi=makePredByNodeName('LI');var isPurePara=function(node){return isPara(node)&&!isLi(node);};var isTable=makePredByNodeName('TABLE');var isInline=function(node){return!isBodyContainer(node)&&!isList(node)&&!isPara(node)&&!isTable(node)&&!isBlockquote(node);};var isList=function(node){return node&&/^UL|^OL/.test(node.nodeName.toUpperCase());};var isCell=function(node){return node&&/^TD|^TH/.test(node.nodeName.toUpperCase());};var isBlockquote=makePredByNodeName('BLOCKQUOTE');var isBodyContainer=function(node){return isCell(node)||isBlockquote(node)||isEditable(node);};var isAnchor=makePredByNodeName('A');var isParaInline=function(node){return isInline(node)&&!!ancestor(node,isPara);};var isBodyInline=function(node){return isInline(node)&&!ancestor(node,isPara);};var isBody=makePredByNodeName('BODY');var isClosestSibling=function(nodeA,nodeB){return nodeA.nextSibling===nodeB||nodeA.previousSibling===nodeB;};var withClosestSiblings=function(node,pred){pred=pred||func.ok;var siblings=[];if(node.previousSibling&&pred(node.previousSibling)){siblings.push(node.previousSibling);}
siblings.push(node);if(node.nextSibling&&pred(node.nextSibling)){siblings.push(node.nextSibling);}
return siblings;};var blankHTML=agent.isMSIE?'&nbsp;':'<br>';var nodeLength=function(node){if(isText(node)){return node.nodeValue.length;}
return node.childNodes.length;};var isEmpty=function(node){var len=nodeLength(node);if(len===0){return true;}else if(!dom.isText(node)&&len===1&&node.innerHTML===blankHTML){return true;}
return false;};var paddingBlankHTML=function(node){if(!isVoid(node)&&!nodeLength(node)){node.innerHTML=blankHTML;}};var ancestor=function(node,pred){while(node){if(pred(node)){return node;}
if(isEditable(node)){break;}
node=node.parentNode;}
return null;};var singleChildAncestor=function(node,pred){node=node.parentNode;while(node){if(nodeLength(node)!==1){break;}
if(pred(node)){return node;}
if(isEditable(node)){break;}
node=node.parentNode;}
return null;};var listAncestor=function(node,pred){pred=pred||func.fail;var ancestors=[];ancestor(node,function(el){if(!isEditable(el)){ancestors.push(el);}
return pred(el);});return ancestors;};var lastAncestor=function(node,pred){var ancestors=listAncestor(node);return list.last(ancestors.filter(pred));};var commonAncestor=function(nodeA,nodeB){var ancestors=listAncestor(nodeA);for(var n=nodeB;n;n=n.parentNode){if($.inArray(n,ancestors)>-1){return n;}}
return null;};var listPrev=function(node,pred){pred=pred||func.fail;var nodes=[];while(node){if(pred(node)){break;}
nodes.push(node);node=node.previousSibling;}
return nodes;};var listNext=function(node,pred){pred=pred||func.fail;var nodes=[];while(node){if(pred(node)){break;}
nodes.push(node);node=node.nextSibling;}
return nodes;};var listDescendant=function(node,pred){var descendents=[];pred=pred||func.ok;(function fnWalk(current){if(node!==current&&pred(current)){descendents.push(current);}
for(var idx=0,len=current.childNodes.length;idx<len;idx++){fnWalk(current.childNodes[idx]);}})(node);return descendents;};var wrap=function(node,wrapperName){var parent=node.parentNode;var wrapper=$('<'+wrapperName+'>')[0];parent.insertBefore(wrapper,node);wrapper.appendChild(node);return wrapper;};var insertAfter=function(node,preceding){var next=preceding.nextSibling,parent=preceding.parentNode;if(next){parent.insertBefore(node,next);}else{parent.appendChild(node);}
return node;};var appendChildNodes=function(node,aChild){$.each(aChild,function(idx,child){node.appendChild(child);});return node;};var isLeftEdgePoint=function(point){return point.offset===0;};var isRightEdgePoint=function(point){return point.offset===nodeLength(point.node);};var isEdgePoint=function(point){return isLeftEdgePoint(point)||isRightEdgePoint(point);};var isLeftEdgeOf=function(node,ancestor){while(node&&node!==ancestor){if(position(node)!==0){return false;}
node=node.parentNode;}
return true;};var isRightEdgeOf=function(node,ancestor){while(node&&node!==ancestor){if(position(node)!==nodeLength(node.parentNode)-1){return false;}
node=node.parentNode;}
return true;};var position=function(node){var offset=0;while((node=node.previousSibling)){offset+=1;}
return offset;};var hasChildren=function(node){return!!(node&&node.childNodes&&node.childNodes.length);};var prevPoint=function(point,isSkipInnerOffset){var node,offset;if(point.offset===0){if(isEditable(point.node)){return null;}
node=point.node.parentNode;offset=position(point.node);}else if(hasChildren(point.node)){node=point.node.childNodes[point.offset-1];offset=nodeLength(node);}else{node=point.node;offset=isSkipInnerOffset?0:point.offset-1;}
return{node:node,offset:offset};};var nextPoint=function(point,isSkipInnerOffset){var node,offset;if(nodeLength(point.node)===point.offset){if(isEditable(point.node)){return null;}
node=point.node.parentNode;offset=position(point.node)+1;}else if(hasChildren(point.node)){node=point.node.childNodes[point.offset];offset=0;}else{node=point.node;offset=isSkipInnerOffset?nodeLength(point.node):point.offset+1;}
return{node:node,offset:offset};};var isSamePoint=function(pointA,pointB){return pointA.node===pointB.node&&pointA.offset===pointB.offset;};var isVisiblePoint=function(point){if(isText(point.node)||!hasChildren(point.node)||isEmpty(point.node)){return true;}
var leftNode=point.node.childNodes[point.offset-1];var rightNode=point.node.childNodes[point.offset];if((!leftNode||isVoid(leftNode))&&(!rightNode||isVoid(rightNode))){return true;}
return false;};var prevPointUntil=function(point,pred){while(point){if(pred(point)){return point;}
point=prevPoint(point);}
return null;};var nextPointUntil=function(point,pred){while(point){if(pred(point)){return point;}
point=nextPoint(point);}
return null;};var walkPoint=function(startPoint,endPoint,handler,isSkipInnerOffset){var point=startPoint;while(point){handler(point);if(isSamePoint(point,endPoint)){break;}
var isSkipOffset=isSkipInnerOffset&&startPoint.node!==point.node&&endPoint.node!==point.node;point=nextPoint(point,isSkipOffset);}};var makeOffsetPath=function(ancestor,node){var ancestors=listAncestor(node,func.eq(ancestor));return $.map(ancestors,position).reverse();};var fromOffsetPath=function(ancestor,offsets){var current=ancestor;for(var i=0,len=offsets.length;i<len;i++){if(current.childNodes.length<=offsets[i]){current=current.childNodes[current.childNodes.length-1];}else{current=current.childNodes[offsets[i]];}}
return current;};var splitNode=function(point,isSkipPaddingBlankHTML){if(isText(point.node)){if(isLeftEdgePoint(point)){return point.node;}else if(isRightEdgePoint(point)){return point.node.nextSibling;}
return point.node.splitText(point.offset);}
var childNode=point.node.childNodes[point.offset];var clone=insertAfter(point.node.cloneNode(false),point.node);appendChildNodes(clone,listNext(childNode));if(!isSkipPaddingBlankHTML){paddingBlankHTML(point.node);paddingBlankHTML(clone);}
return clone;};var splitTree=function(root,point,isSkipPaddingBlankHTML){var ancestors=listAncestor(point.node,func.eq(root));if(!ancestors.length){return null;}else if(ancestors.length===1){return splitNode(point,isSkipPaddingBlankHTML);}
return ancestors.reduce(function(node,parent){var clone=insertAfter(parent.cloneNode(false),parent);if(node===point.node){node=splitNode(point,isSkipPaddingBlankHTML);}
appendChildNodes(clone,listNext(node));if(!isSkipPaddingBlankHTML){paddingBlankHTML(parent);paddingBlankHTML(clone);}
return clone;});};var splitPoint=function(point,isInline){var pred=isInline?isPara:isBodyContainer;var ancestors=listAncestor(point.node,pred);var topAncestor=list.last(ancestors)||point.node;var splitRoot,container;if(pred(topAncestor)){splitRoot=ancestors[ancestors.length-2];container=topAncestor;}else{splitRoot=topAncestor;container=splitRoot.parentNode;}
var pivot=splitRoot&&splitTree(splitRoot,point,isInline);return{rightNode:pivot,container:container};};var create=function(nodeName){return document.createElement(nodeName);};var createText=function(text){return document.createTextNode(text);};var remove=function(node,isRemoveChild){if(!node||!node.parentNode){return;}
if(node.removeNode){return node.removeNode(isRemoveChild);}
var parent=node.parentNode;if(!isRemoveChild){var nodes=[];var i,len;for(i=0,len=node.childNodes.length;i<len;i++){nodes.push(node.childNodes[i]);}
for(i=0,len=nodes.length;i<len;i++){parent.insertBefore(nodes[i],node);}}
parent.removeChild(node);};var removeWhile=function(node,pred){while(node){if(isEditable(node)||!pred(node)){break;}
var parent=node.parentNode;remove(node);node=parent;}};var replace=function(node,nodeName){if(node.nodeName.toUpperCase()===nodeName.toUpperCase()){return node;}
var newNode=create(nodeName);if(node.style.cssText){newNode.style.cssText=node.style.cssText;}
appendChildNodes(newNode,list.from(node.childNodes));insertAfter(newNode,node);remove(node);return newNode;};var isTextarea=makePredByNodeName('TEXTAREA');var html=function($node,isNewlineOnBlock){var markup=isTextarea($node[0])?$node.val():$node.html();if(isNewlineOnBlock){var regexTag=/<(\/?)(\b(?!!)[^>\s]*)(.*?)(\s*\/?>)/g;markup=markup.replace(regexTag,function(match,endSlash,name){name=name.toUpperCase();var isEndOfInlineContainer=/^DIV|^TD|^TH|^P|^LI|^H[1-7]/.test(name)&&!!endSlash;var isBlockNode=/^BLOCKQUOTE|^TABLE|^TBODY|^TR|^HR|^UL|^OL/.test(name);return match+((isEndOfInlineContainer||isBlockNode)?'\n':'');});markup=$.trim(markup);}
return markup;};var value=function($textarea,stripLinebreaks){var val=$textarea.val();if(stripLinebreaks){return val.replace(/[\n\r]/g,'');}
return val;};return{NBSP_CHAR:NBSP_CHAR,ZERO_WIDTH_NBSP_CHAR:ZERO_WIDTH_NBSP_CHAR,blank:blankHTML,emptyPara:'<p>'+blankHTML+'</p>',makePredByNodeName:makePredByNodeName,isEditable:isEditable,isControlSizing:isControlSizing,buildLayoutInfo:buildLayoutInfo,isText:isText,isVoid:isVoid,isPara:isPara,isPurePara:isPurePara,isInline:isInline,isBodyInline:isBodyInline,isBody:isBody,isParaInline:isParaInline,isList:isList,isTable:isTable,isCell:isCell,isBlockquote:isBlockquote,isBodyContainer:isBodyContainer,isAnchor:isAnchor,isDiv:makePredByNodeName('DIV'),isLi:isLi,isBR:makePredByNodeName('BR'),isSpan:makePredByNodeName('SPAN'),isB:makePredByNodeName('B'),isU:makePredByNodeName('U'),isS:makePredByNodeName('S'),isI:makePredByNodeName('I'),isImg:makePredByNodeName('IMG'),isTextarea:isTextarea,isEmpty:isEmpty,isEmptyAnchor:func.and(isAnchor,isEmpty),isClosestSibling:isClosestSibling,withClosestSiblings:withClosestSiblings,nodeLength:nodeLength,isLeftEdgePoint:isLeftEdgePoint,isRightEdgePoint:isRightEdgePoint,isEdgePoint:isEdgePoint,isLeftEdgeOf:isLeftEdgeOf,isRightEdgeOf:isRightEdgeOf,prevPoint:prevPoint,nextPoint:nextPoint,isSamePoint:isSamePoint,isVisiblePoint:isVisiblePoint,prevPointUntil:prevPointUntil,nextPointUntil:nextPointUntil,walkPoint:walkPoint,ancestor:ancestor,singleChildAncestor:singleChildAncestor,listAncestor:listAncestor,lastAncestor:lastAncestor,listNext:listNext,listPrev:listPrev,listDescendant:listDescendant,commonAncestor:commonAncestor,wrap:wrap,insertAfter:insertAfter,appendChildNodes:appendChildNodes,position:position,hasChildren:hasChildren,makeOffsetPath:makeOffsetPath,fromOffsetPath:fromOffsetPath,splitTree:splitTree,splitPoint:splitPoint,create:create,createText:createText,remove:remove,removeWhile:removeWhile,replace:replace,html:html,value:value};})();var range=(function(){var textRangeToPoint=function(textRange,isStart){var container=textRange.parentElement(),offset;var tester=document.body.createTextRange(),prevContainer;var childNodes=list.from(container.childNodes);for(offset=0;offset<childNodes.length;offset++){if(dom.isText(childNodes[offset])){continue;}
tester.moveToElementText(childNodes[offset]);if(tester.compareEndPoints('StartToStart',textRange)>=0){break;}
prevContainer=childNodes[offset];}
if(offset!==0&&dom.isText(childNodes[offset-1])){var textRangeStart=document.body.createTextRange(),curTextNode=null;textRangeStart.moveToElementText(prevContainer||container);textRangeStart.collapse(!prevContainer);curTextNode=prevContainer?prevContainer.nextSibling:container.firstChild;var pointTester=textRange.duplicate();pointTester.setEndPoint('StartToStart',textRangeStart);var textCount=pointTester.text.replace(/[\r\n]/g,'').length;while(textCount>curTextNode.nodeValue.length&&curTextNode.nextSibling){textCount-=curTextNode.nodeValue.length;curTextNode=curTextNode.nextSibling;}
var dummy=curTextNode.nodeValue;if(isStart&&curTextNode.nextSibling&&dom.isText(curTextNode.nextSibling)&&textCount===curTextNode.nodeValue.length){textCount-=curTextNode.nodeValue.length;curTextNode=curTextNode.nextSibling;}
container=curTextNode;offset=textCount;}
return{cont:container,offset:offset};};var pointToTextRange=function(point){var textRangeInfo=function(container,offset){var node,isCollapseToStart;if(dom.isText(container)){var prevTextNodes=dom.listPrev(container,func.not(dom.isText));var prevContainer=list.last(prevTextNodes).previousSibling;node=prevContainer||container.parentNode;offset+=list.sum(list.tail(prevTextNodes),dom.nodeLength);isCollapseToStart=!prevContainer;}else{node=container.childNodes[offset]||container;if(dom.isText(node)){return textRangeInfo(node,0);}
offset=0;isCollapseToStart=false;}
return{node:node,collapseToStart:isCollapseToStart,offset:offset};};var textRange=document.body.createTextRange();var info=textRangeInfo(point.node,point.offset);textRange.moveToElementText(info.node);textRange.collapse(info.collapseToStart);textRange.moveStart('character',info.offset);return textRange;};var WrappedRange=function(sc,so,ec,eo){this.sc=sc;this.so=so;this.ec=ec;this.eo=eo;var nativeRange=function(){if(agent.isW3CRangeSupport){var w3cRange=document.createRange();w3cRange.setStart(sc,so);w3cRange.setEnd(ec,eo);return w3cRange;}else{var textRange=pointToTextRange({node:sc,offset:so});textRange.setEndPoint('EndToEnd',pointToTextRange({node:ec,offset:eo}));return textRange;}};this.getPoints=function(){return{sc:sc,so:so,ec:ec,eo:eo};};this.getStartPoint=function(){return{node:sc,offset:so};};this.getEndPoint=function(){return{node:ec,offset:eo};};this.select=function(){var nativeRng=nativeRange();if(agent.isW3CRangeSupport){var selection=document.getSelection();if(selection.rangeCount>0){selection.removeAllRanges();}
selection.addRange(nativeRng);}else{nativeRng.select();}};this.normalize=function(){var getVisiblePoint=function(point){if(!dom.isVisiblePoint(point)){if(dom.isLeftEdgePoint(point)){point=dom.nextPointUntil(point,dom.isVisiblePoint);}else{point=dom.prevPointUntil(point,dom.isVisiblePoint);}}
return point;};var startPoint=getVisiblePoint(this.getStartPoint());var endPoint=getVisiblePoint(this.getEndPoint());return new WrappedRange(startPoint.node,startPoint.offset,endPoint.node,endPoint.offset);};this.nodes=function(pred,options){pred=pred||func.ok;var includeAncestor=options&&options.includeAncestor;var fullyContains=options&&options.fullyContains;var startPoint=this.getStartPoint();var endPoint=this.getEndPoint();var nodes=[];var leftEdgeNodes=[];dom.walkPoint(startPoint,endPoint,function(point){if(dom.isEditable(point.node)){return;}
var node;if(fullyContains){if(dom.isLeftEdgePoint(point)){leftEdgeNodes.push(point.node);}
if(dom.isRightEdgePoint(point)&&list.contains(leftEdgeNodes,point.node)){node=point.node;}}else if(includeAncestor){node=dom.ancestor(point.node,pred);}else{node=point.node;}
if(node&&pred(node)){nodes.push(node);}},true);return list.unique(nodes);};this.commonAncestor=function(){return dom.commonAncestor(sc,ec);};this.expand=function(pred){var startAncestor=dom.ancestor(sc,pred);var endAncestor=dom.ancestor(ec,pred);if(!startAncestor&&!endAncestor){return new WrappedRange(sc,so,ec,eo);}
var boundaryPoints=this.getPoints();if(startAncestor){boundaryPoints.sc=startAncestor;boundaryPoints.so=0;}
if(endAncestor){boundaryPoints.ec=endAncestor;boundaryPoints.eo=dom.nodeLength(endAncestor);}
return new WrappedRange(boundaryPoints.sc,boundaryPoints.so,boundaryPoints.ec,boundaryPoints.eo);};this.collapse=function(isCollapseToStart){if(isCollapseToStart){return new WrappedRange(sc,so,sc,so);}else{return new WrappedRange(ec,eo,ec,eo);}};this.splitText=function(){var isSameContainer=sc===ec;var boundaryPoints=this.getPoints();if(dom.isText(ec)&&!dom.isEdgePoint(this.getEndPoint())){ec.splitText(eo);}
if(dom.isText(sc)&&!dom.isEdgePoint(this.getStartPoint())){boundaryPoints.sc=sc.splitText(so);boundaryPoints.so=0;if(isSameContainer){boundaryPoints.ec=boundaryPoints.sc;boundaryPoints.eo=eo-so;}}
return new WrappedRange(boundaryPoints.sc,boundaryPoints.so,boundaryPoints.ec,boundaryPoints.eo);};this.deleteContents=function(){if(this.isCollapsed()){return this;}
var rng=this.splitText();var nodes=rng.nodes(null,{fullyContains:true});var point=dom.prevPointUntil(rng.getStartPoint(),function(point){return!list.contains(nodes,point.node);});var emptyParents=[];$.each(nodes,function(idx,node){var parent=node.parentNode;if(point.node!==parent&&dom.nodeLength(parent)===1){emptyParents.push(parent);}
dom.remove(node,false);});$.each(emptyParents,function(idx,node){dom.remove(node,false);});return new WrappedRange(point.node,point.offset,point.node,point.offset).normalize();};var makeIsOn=function(pred){return function(){var ancestor=dom.ancestor(sc,pred);return!!ancestor&&(ancestor===dom.ancestor(ec,pred));};};this.isOnEditable=makeIsOn(dom.isEditable);this.isOnList=makeIsOn(dom.isList);this.isOnAnchor=makeIsOn(dom.isAnchor);this.isOnCell=makeIsOn(dom.isCell);this.isLeftEdgeOf=function(pred){if(!dom.isLeftEdgePoint(this.getStartPoint())){return false;}
var node=dom.ancestor(this.sc,pred);return node&&dom.isLeftEdgeOf(this.sc,node);};this.isCollapsed=function(){return sc===ec&&so===eo;};this.wrapBodyInlineWithPara=function(){if(dom.isBodyContainer(sc)&&dom.isEmpty(sc)){sc.innerHTML=dom.emptyPara;return new WrappedRange(sc.firstChild,0,sc.firstChild,0);}
if(dom.isParaInline(sc)||dom.isPara(sc)){return this.normalize();}
var topAncestor;if(dom.isInline(sc)){var ancestors=dom.listAncestor(sc,func.not(dom.isInline));topAncestor=list.last(ancestors);if(!dom.isInline(topAncestor)){topAncestor=ancestors[ancestors.length-2]||sc.childNodes[so];}}else{topAncestor=sc.childNodes[so>0?so-1:0];}
var inlineSiblings=dom.listPrev(topAncestor,dom.isParaInline).reverse();inlineSiblings=inlineSiblings.concat(dom.listNext(topAncestor.nextSibling,dom.isParaInline));if(inlineSiblings.length){var para=dom.wrap(list.head(inlineSiblings),'p');dom.appendChildNodes(para,list.tail(inlineSiblings));}
return this.normalize();};this.insertNode=function(node){var rng=this.wrapBodyInlineWithPara().deleteContents();var info=dom.splitPoint(rng.getStartPoint(),dom.isInline(node));if(info.rightNode){info.rightNode.parentNode.insertBefore(node,info.rightNode);}else{info.container.appendChild(node);}
return node;};this.toString=function(){var nativeRng=nativeRange();return agent.isW3CRangeSupport?nativeRng.toString():nativeRng.text;};this.bookmark=function(editable){return{s:{path:dom.makeOffsetPath(editable,sc),offset:so},e:{path:dom.makeOffsetPath(editable,ec),offset:eo}};};this.paraBookmark=function(paras){return{s:{path:list.tail(dom.makeOffsetPath(list.head(paras),sc)),offset:so},e:{path:list.tail(dom.makeOffsetPath(list.last(paras),ec)),offset:eo}};};this.getClientRects=function(){var nativeRng=nativeRange();return nativeRng.getClientRects();};};return{create:function(sc,so,ec,eo){if(!arguments.length){if(agent.isW3CRangeSupport){var selection=document.getSelection();if(selection.rangeCount===0){return null;}else if(dom.isBody(selection.anchorNode)){return null;}
var nativeRng=selection.getRangeAt(0);sc=nativeRng.startContainer;so=nativeRng.startOffset;ec=nativeRng.endContainer;eo=nativeRng.endOffset;}else{var textRange=document.selection.createRange();var textRangeEnd=textRange.duplicate();textRangeEnd.collapse(false);var textRangeStart=textRange;textRangeStart.collapse(true);var startPoint=textRangeToPoint(textRangeStart,true),endPoint=textRangeToPoint(textRangeEnd,false);if(dom.isText(startPoint.node)&&dom.isLeftEdgePoint(startPoint)&&dom.isTextNode(endPoint.node)&&dom.isRightEdgePoint(endPoint)&&endPoint.node.nextSibling===startPoint.node){startPoint=endPoint;}
sc=startPoint.cont;so=startPoint.offset;ec=endPoint.cont;eo=endPoint.offset;}}else if(arguments.length===2){ec=sc;eo=so;}
return new WrappedRange(sc,so,ec,eo);},createFromNode:function(node){var sc=node;var so=0;var ec=node;var eo=dom.nodeLength(ec);if(dom.isVoid(sc)){so=dom.listPrev(sc).length-1;sc=sc.parentNode;}
if(dom.isBR(ec)){eo=dom.listPrev(ec).length-1;ec=ec.parentNode;}else if(dom.isVoid(ec)){eo=dom.listPrev(ec).length;ec=ec.parentNode;}
return this.create(sc,so,ec,eo);},createFromBookmark:function(editable,bookmark){var sc=dom.fromOffsetPath(editable,bookmark.s.path);var so=bookmark.s.offset;var ec=dom.fromOffsetPath(editable,bookmark.e.path);var eo=bookmark.e.offset;return new WrappedRange(sc,so,ec,eo);},createFromParaBookmark:function(bookmark,paras){var so=bookmark.s.offset;var eo=bookmark.e.offset;var sc=dom.fromOffsetPath(list.head(paras),bookmark.s.path);var ec=dom.fromOffsetPath(list.last(paras),bookmark.e.path);return new WrappedRange(sc,so,ec,eo);}};})();var settings={version:'0.6.1',options:{width:null,height:null,minHeight:null,maxHeight:null,focus:false,tabsize:4,styleWithSpan:true,disableLinkTarget:true,disableDragAndDrop:true,disableResizeEditor:true,shortcuts:false,placeholder:false,prettifyHtml:true,codemirror:{mode:'text/html',htmlMode:true,lineNumbers:true},lang:'en-US',direction:null,toolbar:[['style',['style']],['font',['bold','italic','underline','clear']],['fontname',['fontname']],['color',['color']],['para',['ul','ol','paragraph']],['height',['height']],['table',['table']],['insert',['link','picture','hr']],['view',['fullscreen','codeview']],['help',['help']]],airMode:false,airPopover:[['color',['color']],['font',['bold','underline','clear']],['para',['ul','paragraph']],['table',['table']],['insert',['link','picture']]],styleTags:['p','blockquote','pre','h1','h2','h3','h4','h5','h6'],defaultFontName:'Helvetica Neue',fontNames:['Lato','Alegreya','Arial','Average Sans','Advent Pro','Anaheim','Crete Round','Doppio One','Oxygen Mono','Quando','Righteous','Sanchez','Source Code Pro','Trykker','Futura'],fontNamesIgnoreCheck:[],colors:[['#000000','#424242','#636363','#9C9C94','#CEC6CE','#EFEFEF','#F7F7F7','#FFFFFF'],['#FF0000','#FF9C00','#FFFF00','#00FF00','#00FFFF','#0000FF','#9C00FF','#FF00FF'],['#F7C6CE','#FFE7CE','#FFEFC6','#D6EFD6','#CEDEE7','#CEE7F7','#D6D6E7','#E7D6DE'],['#E79C9C','#FFC69C','#FFE79C','#B5D6A5','#A5C6CE','#9CC6EF','#B5A5D6','#D6A5BD'],['#E76363','#F7AD6B','#FFD663','#94BD7B','#73A5AD','#6BADDE','#8C7BC6','#C67BA5'],['#CE0000','#E79439','#EFC631','#6BA54A','#4A7B8C','#3984C6','#634AA5','#A54A7B'],['#9C0000','#B56308','#BD9400','#397B21','#104A5A','#085294','#311873','#731842'],['#630000','#7B3900','#846300','#295218','#083139','#003163','#21104A','#4A1031']],lineHeights:['1.0','1.2','1.4','1.5','1.6','1.8','2.0','3.0'],insertTableMaxSize:{col:10,row:10},maximumImageFileSize:null,oninit:null,onfocus:null,onblur:null,onenter:null,onkeyup:null,onkeydown:null,onImageUpload:null,onImageUploadError:null,onMediaDelete:null,onToolbarClick:null,onsubmit:null,onCreateLink:function(sLinkUrl){if(sLinkUrl.indexOf('@')!==-1&&sLinkUrl.indexOf(':')===-1){sLinkUrl='mailto:'+sLinkUrl;}else if(sLinkUrl.indexOf('://')===-1){sLinkUrl='http://'+sLinkUrl;}
return sLinkUrl;},keyMap:{pc:{'ENTER':'insertParagraph','CTRL+Z':'undo','CTRL+Y':'redo','TAB':'tab','SHIFT+TAB':'untab','CTRL+B':'bold','CTRL+I':'italic','CTRL+U':'underline','CTRL+SHIFT+S':'strikethrough','CTRL+BACKSLASH':'removeFormat','CTRL+SHIFT+L':'justifyLeft','CTRL+SHIFT+E':'justifyCenter','CTRL+SHIFT+R':'justifyRight','CTRL+SHIFT+J':'justifyFull','CTRL+SHIFT+NUM7':'insertUnorderedList','CTRL+SHIFT+NUM8':'insertOrderedList','CTRL+LEFTBRACKET':'outdent','CTRL+RIGHTBRACKET':'indent','CTRL+NUM0':'formatPara','CTRL+NUM1':'formatH1','CTRL+NUM2':'formatH2','CTRL+NUM3':'formatH3','CTRL+NUM4':'formatH4','CTRL+NUM5':'formatH5','CTRL+NUM6':'formatH6','CTRL+ENTER':'insertHorizontalRule','CTRL+K':'showLinkDialog'},mac:{'ENTER':'insertParagraph','CMD+Z':'undo','CMD+SHIFT+Z':'redo','TAB':'tab','SHIFT+TAB':'untab','CMD+B':'bold','CMD+I':'italic','CMD+U':'underline','CMD+SHIFT+S':'strikethrough','CMD+BACKSLASH':'removeFormat','CMD+SHIFT+L':'justifyLeft','CMD+SHIFT+E':'justifyCenter','CMD+SHIFT+R':'justifyRight','CMD+SHIFT+J':'justifyFull','CMD+SHIFT+NUM7':'insertUnorderedList','CMD+SHIFT+NUM8':'insertOrderedList','CMD+LEFTBRACKET':'outdent','CMD+RIGHTBRACKET':'indent','CMD+NUM0':'formatPara','CMD+NUM1':'formatH1','CMD+NUM2':'formatH2','CMD+NUM3':'formatH3','CMD+NUM4':'formatH4','CMD+NUM5':'formatH5','CMD+NUM6':'formatH6','CMD+ENTER':'insertHorizontalRule','CMD+K':'showLinkDialog'}}},lang:{'en-US':{font:{bold:'Bold',italic:'Italic',underline:'Underline',clear:'Remove Font Style',height:'Line Height',name:'Font Family'},image:{image:'Picture',insert:'Insert Image',resizeFull:'Resize Full',resizeHalf:'Resize Half',resizeQuarter:'Resize Quarter',floatLeft:'Float Left',floatRight:'Float Right',floatNone:'Float None',shapeRounded:'Shape: Rounded',shapeCircle:'Shape: Circle',shapeThumbnail:'Shape: Thumbnail',shapeNone:'Shape: None',dragImageHere:'Drag image or text here',dropImage:'Drop image or Text',selectFromFiles:'Select from files',maximumFileSize:'Maximum file size',maximumFileSizeError:'Maximum file size exceeded.',url:'Image URL',remove:'Remove Image'},link:{link:'Link',insert:'Insert Link',unlink:'Unlink',edit:'Edit',textToDisplay:'Text to display',url:'To what URL should this link go?',openInNewWindow:'Open in new window'},table:{table:'Table'},hr:{insert:'Insert Horizontal Rule'},style:{style:'Style',normal:'Normal',blockquote:'Quote',pre:'Code',h1:'Header 1',h2:'Header 2',h3:'Header 3',h4:'Header 4',h5:'Header 5',h6:'Header 6'},lists:{unordered:'Unordered list',ordered:'Ordered list'},options:{help:'Help',fullscreen:'Full Screen',codeview:'Code View'},paragraph:{paragraph:'Paragraph',outdent:'Outdent',indent:'Indent',left:'Align left',center:'Align center',right:'Align right',justify:'Justify full'},color:{recent:'Recent Color',more:'More Color',background:'Background Color',foreground:'Foreground Color',transparent:'Transparent',setTransparent:'Set transparent',reset:'Reset',resetToDefault:'Reset to default'},shortcut:{shortcuts:'Keyboard shortcuts',close:'Close',textFormatting:'Text formatting',action:'Action',paragraphFormatting:'Paragraph formatting',documentStyle:'Document Style',extraKeys:'Extra keys'},history:{undo:'Undo',redo:'Redo'}}}};var async=(function(){var readFileAsDataURL=function(file){return $.Deferred(function(deferred){$.extend(new FileReader(),{onload:function(e){var sDataURL=e.target.result;deferred.resolve(sDataURL);},onerror:function(){deferred.reject(this);}}).readAsDataURL(file);}).promise();};var createImage=function(sUrl,filename){return $.Deferred(function(deferred){var $img=$('<img>');$img.one('load',function(){$img.off('error abort');deferred.resolve($img);}).one('error abort',function(){$img.off('load').detach();deferred.reject($img);}).css({display:'none'}).appendTo(document.body).attr({'src':sUrl,'data-filename':filename});}).promise();};return{readFileAsDataURL:readFileAsDataURL,createImage:createImage};})();var key={isEdit:function(keyCode){return list.contains([8,9,13,32],keyCode);},nameFromCode:{'8':'BACKSPACE','9':'TAB','13':'ENTER','32':'SPACE','48':'NUM0','49':'NUM1','50':'NUM2','51':'NUM3','52':'NUM4','53':'NUM5','54':'NUM6','55':'NUM7','56':'NUM8','66':'B','69':'E','73':'I','74':'J','75':'K','76':'L','82':'R','83':'S','85':'U','89':'Y','90':'Z','191':'SLASH','219':'LEFTBRACKET','220':'BACKSLASH','221':'RIGHTBRACKET'}};var Style=function(){var jQueryCSS=function($obj,propertyNames){if(agent.jqueryVersion<1.9){var result={};$.each(propertyNames,function(idx,propertyName){result[propertyName]=$obj.css(propertyName);});return result;}
return $obj.css.call($obj,propertyNames);};this.stylePara=function(rng,styleInfo){$.each(rng.nodes(dom.isPara,{includeAncestor:true}),function(idx,para){$(para).css(styleInfo);$(para).find('*').css(styleInfo);});};this.styleNodes=function(rng,options){rng=rng.splitText();var nodeName=options&&options.nodeName||'SPAN';var expandClosestSibling=!!(options&&options.expandClosestSibling);var onlyPartialContains=!!(options&&options.onlyPartialContains);if(rng.isCollapsed()){return rng.insertNode(dom.create(nodeName));}
var pred=dom.makePredByNodeName(nodeName);var nodes=$.map(rng.nodes(dom.isText,{fullyContains:true}),function(text){return dom.singleChildAncestor(text,pred)||dom.wrap(text,nodeName);});if(expandClosestSibling){if(onlyPartialContains){var nodesInRange=rng.nodes();pred=func.and(pred,function(node){return list.contains(nodesInRange,node);});}
return $.map(nodes,function(node){var siblings=dom.withClosestSiblings(node,pred);var head=list.head(siblings);var tails=list.tail(siblings);$.each(tails,function(idx,elem){dom.appendChildNodes(head,elem.childNodes);dom.remove(elem);});return list.head(siblings);});}else{return nodes;}};this.current=function(rng,target){var $cont=$(dom.isText(rng.sc)?rng.sc.parentNode:rng.sc);var properties=['font-family','font-size','text-align','list-style-type','line-height'];var styleInfo=jQueryCSS($cont,properties)||{};styleInfo['font-size']=parseInt(styleInfo['font-size'],10);styleInfo['font-bold']=document.queryCommandState('bold')?'bold':'normal';styleInfo['font-italic']=document.queryCommandState('italic')?'italic':'normal';styleInfo['font-underline']=document.queryCommandState('underline')?'underline':'normal';styleInfo['font-strikethrough']=document.queryCommandState('strikeThrough')?'strikethrough':'normal';styleInfo['font-superscript']=document.queryCommandState('superscript')?'superscript':'normal';styleInfo['font-subscript']=document.queryCommandState('subscript')?'subscript':'normal';if(!rng.isOnList()){styleInfo['list-style']='none';}else{var aOrderedType=['circle','disc','disc-leading-zero','square'];var isUnordered=$.inArray(styleInfo['list-style-type'],aOrderedType)>-1;styleInfo['list-style']=isUnordered?'unordered':'ordered';}
var para=dom.ancestor(rng.sc,dom.isPara);if(para&&para.style['line-height']){styleInfo['line-height']=para.style.lineHeight;}else{var lineHeight=parseInt(styleInfo['line-height'],10)/ parseInt(styleInfo['font-size'],10);styleInfo['line-height']=lineHeight.toFixed(1);}
styleInfo.image=dom.isImg(target)&&target;styleInfo.anchor=rng.isOnAnchor()&&dom.ancestor(rng.sc,dom.isAnchor);styleInfo.ancestors=dom.listAncestor(rng.sc,dom.isEditable);styleInfo.range=rng;return styleInfo;};};var Typing=function(){this.insertTab=function($editable,rng,tabsize){var tab=dom.createText(new Array(tabsize+1).join(dom.NBSP_CHAR));rng=rng.deleteContents();rng.insertNode(tab,true);rng=range.create(tab,tabsize);rng.select();};this.insertParagraph=function(){var rng=range.create();rng=rng.deleteContents();rng=rng.wrapBodyInlineWithPara();var splitRoot=dom.ancestor(rng.sc,dom.isPara);var nextPara;if(splitRoot){nextPara=dom.splitTree(splitRoot,rng.getStartPoint());var emptyAnchors=dom.listDescendant(splitRoot,dom.isEmptyAnchor);emptyAnchors=emptyAnchors.concat(dom.listDescendant(nextPara,dom.isEmptyAnchor));$.each(emptyAnchors,function(idx,anchor){dom.remove(anchor);});}else{var next=rng.sc.childNodes[rng.so];nextPara=$(dom.emptyPara)[0];if(next){rng.sc.insertBefore(nextPara,next);}else{rng.sc.appendChild(nextPara);}}
range.create(nextPara,0).normalize().select();};};var Table=function(){this.tab=function(rng,isShift){var cell=dom.ancestor(rng.commonAncestor(),dom.isCell);var table=dom.ancestor(cell,dom.isTable);var cells=dom.listDescendant(table,dom.isCell);var nextCell=list[isShift?'prev':'next'](cells,cell);if(nextCell){range.create(nextCell,0).select();}};this.createTable=function(colCount,rowCount){var tds=[],tdHTML;for(var idxCol=0;idxCol<colCount;idxCol++){tds.push('<td>'+dom.blank+'</td>');}
tdHTML=tds.join('');var trs=[],trHTML;for(var idxRow=0;idxRow<rowCount;idxRow++){trs.push('<tr>'+tdHTML+'</tr>');}
trHTML=trs.join('');return $('<table class="table table-bordered">'+trHTML+'</table>')[0];};};var Bullet=function(){this.insertOrderedList=function(){this.toggleList('OL');};this.insertUnorderedList=function(){this.toggleList('UL');};this.indent=function(){var self=this;var rng=range.create().wrapBodyInlineWithPara();var paras=rng.nodes(dom.isPara,{includeAncestor:true});var clustereds=list.clusterBy(paras,func.peq2('parentNode'));$.each(clustereds,function(idx,paras){var head=list.head(paras);if(dom.isLi(head)){self.wrapList(paras,head.parentNode.nodeName);}else{$.each(paras,function(idx,para){$(para).css('marginLeft',function(idx,val){return(parseInt(val,10)||0)+25;});});}});rng.select();};this.outdent=function(){var self=this;var rng=range.create().wrapBodyInlineWithPara();var paras=rng.nodes(dom.isPara,{includeAncestor:true});var clustereds=list.clusterBy(paras,func.peq2('parentNode'));$.each(clustereds,function(idx,paras){var head=list.head(paras);if(dom.isLi(head)){self.releaseList([paras]);}else{$.each(paras,function(idx,para){$(para).css('marginLeft',function(idx,val){val=(parseInt(val,10)||0);return val>25?val-25:'';});});}});rng.select();};this.toggleList=function(listName){var self=this;var rng=range.create().wrapBodyInlineWithPara();var paras=rng.nodes(dom.isPara,{includeAncestor:true});var bookmark=rng.paraBookmark(paras);var clustereds=list.clusterBy(paras,func.peq2('parentNode'));if(list.find(paras,dom.isPurePara)){var wrappedParas=[];$.each(clustereds,function(idx,paras){wrappedParas=wrappedParas.concat(self.wrapList(paras,listName));});paras=wrappedParas;}else{var diffLists=rng.nodes(dom.isList,{includeAncestor:true}).filter(function(listNode){return!$.nodeName(listNode,listName);});if(diffLists.length){$.each(diffLists,function(idx,listNode){dom.replace(listNode,listName);});}else{paras=this.releaseList(clustereds,true);}}
range.createFromParaBookmark(bookmark,paras).select();};this.wrapList=function(paras,listName){var head=list.head(paras);var last=list.last(paras);var prevList=dom.isList(head.previousSibling)&&head.previousSibling;var nextList=dom.isList(last.nextSibling)&&last.nextSibling;var listNode=prevList||dom.insertAfter(dom.create(listName||'UL'),last);paras=$.map(paras,function(para){return dom.isPurePara(para)?dom.replace(para,'LI'):para;});dom.appendChildNodes(listNode,paras);if(nextList){dom.appendChildNodes(listNode,list.from(nextList.childNodes));dom.remove(nextList);}
return paras;};this.releaseList=function(clustereds,isEscapseToBody){var releasedParas=[];$.each(clustereds,function(idx,paras){var head=list.head(paras);var last=list.last(paras);var headList=isEscapseToBody?dom.lastAncestor(head,dom.isList):head.parentNode;var lastList=headList.childNodes.length>1?dom.splitTree(headList,{node:last.parentNode,offset:dom.position(last)+1},true):null;var middleList=dom.splitTree(headList,{node:head.parentNode,offset:dom.position(head)},true);paras=isEscapseToBody?dom.listDescendant(middleList,dom.isLi):list.from(middleList.childNodes).filter(dom.isLi);if(isEscapseToBody||!dom.isList(headList.parentNode)){paras=$.map(paras,function(para){return dom.replace(para,'P');});}
$.each(list.from(paras).reverse(),function(idx,para){dom.insertAfter(para,headList);});var rootLists=list.compact([headList,middleList,lastList]);$.each(rootLists,function(idx,rootList){var listNodes=[rootList].concat(dom.listDescendant(rootList,dom.isList));$.each(listNodes.reverse(),function(idx,listNode){if(!dom.nodeLength(listNode)){dom.remove(listNode,true);}});});releasedParas=releasedParas.concat(paras);});return releasedParas;};};var Editor=function(){var style=new Style();var table=new Table();var typing=new Typing();var bullet=new Bullet();this.createRange=function($editable){$editable.focus();return range.create();};this.saveRange=function($editable,thenCollapse){$editable.focus();$editable.data('range',range.create());if(thenCollapse){range.create().collapse().select();}};this.saveNode=function($editable){var copy=[];for(var key=0,len=$editable[0].childNodes.length;key<len;key++){copy.push($editable[0].childNodes[key]);}
$editable.data('childNodes',copy);};this.restoreRange=function($editable){var rng=$editable.data('range');if(rng){rng.select();$editable.focus();}};this.restoreNode=function($editable){$editable.html('');var child=$editable.data('childNodes');for(var index=0,len=child.length;index<len;index++){$editable[0].appendChild(child[index]);}};this.currentStyle=function(target){var rng=range.create();return rng?rng.isOnEditable()&&style.current(rng,target):false;};var triggerOnBeforeChange=this.triggerOnBeforeChange=function($editable){var onBeforeChange=$editable.data('callbacks').onBeforeChange;if(onBeforeChange){onBeforeChange($editable.html(),$editable);}};var triggerOnChange=this.triggerOnChange=function($editable){var onChange=$editable.data('callbacks').onChange;if(onChange){onChange($editable.html(),$editable);}};this.undo=function($editable){triggerOnBeforeChange($editable);$editable.data('NoteHistory').undo();triggerOnChange($editable);};this.redo=function($editable){triggerOnBeforeChange($editable);$editable.data('NoteHistory').redo();triggerOnChange($editable);};var beforeCommand=this.beforeCommand=function($editable){triggerOnBeforeChange($editable);};var afterCommand=this.afterCommand=function($editable){$editable.data('NoteHistory').recordUndo();triggerOnChange($editable);};var commands=['bold','italic','underline','strikethrough','superscript','subscript','justifyLeft','justifyCenter','justifyRight','justifyFull','formatBlock','removeFormat','backColor','foreColor','insertHorizontalRule','fontName'];for(var idx=0,len=commands.length;idx<len;idx++){this[commands[idx]]=(function(sCmd){return function($editable,value){beforeCommand($editable);document.execCommand(sCmd,false,value);afterCommand($editable);};})(commands[idx]);}
this.tab=function($editable,options){var rng=range.create();if(rng.isCollapsed()&&rng.isOnCell()){table.tab(rng);}else{beforeCommand($editable);typing.insertTab($editable,rng,options.tabsize);afterCommand($editable);}};this.untab=function(){var rng=range.create();if(rng.isCollapsed()&&rng.isOnCell()){table.tab(rng,true);}};this.insertParagraph=function($editable){beforeCommand($editable);typing.insertParagraph($editable);afterCommand($editable);};this.insertOrderedList=function($editable){beforeCommand($editable);bullet.insertOrderedList($editable);afterCommand($editable);};this.insertUnorderedList=function($editable){beforeCommand($editable);bullet.insertUnorderedList($editable);afterCommand($editable);};this.indent=function($editable){beforeCommand($editable);bullet.indent($editable);afterCommand($editable);};this.outdent=function($editable){beforeCommand($editable);bullet.outdent($editable);afterCommand($editable);};this.insertImage=function($editable,sUrl,filename){async.createImage(sUrl,filename).then(function($image){beforeCommand($editable);$image.css({display:'',width:Math.min($editable.width(),$image.width())});range.create().insertNode($image[0]);range.createFromNode($image[0]).collapse().select();afterCommand($editable);}).fail(function(){var callbacks=$editable.data('callbacks');if(callbacks.onImageUploadError){callbacks.onImageUploadError();}});};this.insertNode=function($editable,node){beforeCommand($editable);var rng=this.createRange($editable);rng.insertNode(node);range.createFromNode(node).collapse().select();afterCommand($editable);};this.insertText=function($editable,text){beforeCommand($editable);var rng=this.createRange($editable);var textNode=rng.insertNode(dom.createText(text));range.create(textNode,dom.nodeLength(textNode)).select();afterCommand($editable);};this.formatBlock=function($editable,tagName){beforeCommand($editable);tagName=agent.isMSIE?'<'+tagName+'>':tagName;document.execCommand('FormatBlock',false,tagName);afterCommand($editable);};this.formatPara=function($editable){beforeCommand($editable);this.formatBlock($editable,'P');afterCommand($editable);};for(var idx=1;idx<=6;idx++){this['formatH'+idx]=function(idx){return function($editable){this.formatBlock($editable,'H'+idx);};}(idx);};this.fontSize=function($editable,value){beforeCommand($editable);var rng=this.createRange($editable);var spans=style.styleNodes(rng);$.each(spans,function(idx,span){$(span).css({'font-size':value+'px'});});afterCommand($editable);};this.lineHeight=function($editable,value){beforeCommand($editable);style.stylePara(range.create(),{lineHeight:value});afterCommand($editable);};this.unlink=function($editable){var rng=range.create();if(rng.isOnAnchor()){var anchor=dom.ancestor(rng.sc,dom.isAnchor);rng=range.createFromNode(anchor);rng.select();beforeCommand($editable);document.execCommand('unlink');afterCommand($editable);}};this.createLink=function($editable,linkInfo,options){var linkUrl=linkInfo.url;var linkText=linkInfo.text;var isNewWindow=linkInfo.newWindow;var rng=linkInfo.range;var isTextChanged=rng.toString()!==linkText;beforeCommand($editable);if(options.onCreateLink){linkUrl=options.onCreateLink(linkUrl);}
var anchors;if(isTextChanged){var anchor=rng.insertNode($('<A>'+linkText+'</A>')[0]);anchors=[anchor];}else{anchors=style.styleNodes(rng,{nodeName:'A',expandClosestSibling:true,onlyPartialContains:true});}
$.each(anchors,function(idx,anchor){$(anchor).attr({href:linkUrl,target:'_blank'});});var startRange=range.createFromNode(list.head(anchors)).collapse(true);var startPoint=startRange.getStartPoint();var endRange=range.createFromNode(list.last(anchors)).collapse();var endPoint=endRange.getEndPoint();range.create(startPoint.node,startPoint.offset,endPoint.node,endPoint.offset).select();afterCommand($editable);};this.getLinkInfo=function($editable){$editable.focus();var rng=range.create().expand(dom.isAnchor);var $anchor=$(list.head(rng.nodes(dom.isAnchor)));return{range:rng,text:rng.toString(),isNewWindow:true,url:$anchor.length?$anchor.attr('href'):''};};this.color=function($editable,sObjColor){var oColor=JSON.parse(sObjColor);var foreColor=oColor.foreColor,backColor=oColor.backColor;beforeCommand($editable);if(foreColor){document.execCommand('foreColor',false,foreColor);}
if(backColor){document.execCommand('backColor',false,backColor);}
afterCommand($editable);};this.insertTable=function($editable,sDim){var dimension=sDim.split('x');beforeCommand($editable);var rng=range.create();rng=rng.deleteContents();rng.insertNode(table.createTable(dimension[0],dimension[1]));afterCommand($editable);};this.floatMe=function($editable,value,$target){beforeCommand($editable);$target.css('float',value);afterCommand($editable);};this.imageShape=function($editable,value,$target){beforeCommand($editable);$target.removeClass('img-rounded img-circle img-thumbnail');if(value){$target.addClass(value);}
afterCommand($editable);};this.resize=function($editable,value,$target){beforeCommand($editable);$target.css({width:value*100+'%',height:''});afterCommand($editable);};this.resizeTo=function(pos,$target,bKeepRatio){var imageSize;if(bKeepRatio){var newRatio=pos.y / pos.x;var ratio=$target.data('ratio');imageSize={width:ratio>newRatio?pos.x:pos.y / ratio,height:ratio>newRatio?pos.x*ratio:pos.y};}else{imageSize={width:pos.x,height:pos.y};}
$target.css(imageSize);};this.removeMedia=function($editable,value,$target){beforeCommand($editable);$target.detach();var callbacks=$editable.data('callbacks');if(callbacks&&callbacks.onMediaDelete){callbacks.onMediaDelete($target,this,$editable);}
afterCommand($editable);};};var History=function($editable){var stack=[],stackOffset=-1;var editable=$editable[0];var makeSnapshot=function(){var rng=range.create();var emptyBookmark={s:{path:[0],offset:0},e:{path:[0],offset:0}};return{contents:$editable.html(),bookmark:(rng?rng.bookmark(editable):emptyBookmark)};};var applySnapshot=function(snapshot){if(snapshot.contents!==null){$editable.html(snapshot.contents);}
if(snapshot.bookmark!==null){range.createFromBookmark(editable,snapshot.bookmark).select();}};this.undo=function(){if(0<stackOffset){stackOffset--;applySnapshot(stack[stackOffset]);}};this.redo=function(){if(stack.length-1>stackOffset){stackOffset++;applySnapshot(stack[stackOffset]);}};this.recordUndo=function(){stackOffset++;if(stack.length>stackOffset){stack=stack.slice(0,stackOffset);}
stack.push(makeSnapshot());};this.recordUndo();};var Button=function(){this.update=function($container,styleInfo){var checkDropdownMenu=function($btn,value){$btn.find('.dropdown-menu li a').each(function(){var isChecked=($(this).data('value')+'')===(value+'');this.className=isChecked?'checked':'';});};var btnState=function(selector,pred){var $btn=$container.find(selector);$btn.toggleClass('active',pred());};if(styleInfo.image){var $img=$(styleInfo.image);btnState('button[data-event="imageShape"][data-value="img-rounded"]',function(){return $img.hasClass('img-rounded');});btnState('button[data-event="imageShape"][data-value="img-circle"]',function(){return $img.hasClass('img-circle');});btnState('button[data-event="imageShape"][data-value="img-thumbnail"]',function(){return $img.hasClass('img-thumbnail');});btnState('button[data-event="imageShape"]:not([data-value])',function(){return!$img.is('.img-rounded, .img-circle, .img-thumbnail');});var imgFloat=$img.css('float');btnState('button[data-event="floatMe"][data-value="left"]',function(){return imgFloat==='left';});btnState('button[data-event="floatMe"][data-value="right"]',function(){return imgFloat==='right';});btnState('button[data-event="floatMe"][data-value="none"]',function(){return imgFloat!=='left'&&imgFloat!=='right';});var style=$img.attr('style');btnState('button[data-event="resize"][data-value="1"]',function(){return!!/(^|\s)(max-)?width\s*:\s*100%/.test(style);});btnState('button[data-event="resize"][data-value="0.5"]',function(){return!!/(^|\s)(max-)?width\s*:\s*50%/.test(style);});btnState('button[data-event="resize"][data-value="0.25"]',function(){return!!/(^|\s)(max-)?width\s*:\s*25%/.test(style);});return;}
var $fontname=$container.find('.note-fontname');if($fontname.length){var selectedFont=styleInfo['font-family'];if(!!selectedFont){selectedFont=list.head(selectedFont.split(','));selectedFont=selectedFont.replace(/\'/g,'');$fontname.find('.note-current-fontname').text(selectedFont);checkDropdownMenu($fontname,selectedFont);}}
var $fontsize=$container.find('.note-fontsize');$fontsize.find('.note-current-fontsize').text(styleInfo['font-size']);checkDropdownMenu($fontsize,parseFloat(styleInfo['font-size']));var $lineHeight=$container.find('.note-height');checkDropdownMenu($lineHeight,parseFloat(styleInfo['line-height']));btnState('button[data-event="bold"]',function(){return styleInfo['font-bold']==='bold';});btnState('button[data-event="italic"]',function(){return styleInfo['font-italic']==='italic';});btnState('button[data-event="underline"]',function(){return styleInfo['font-underline']==='underline';});btnState('button[data-event="strikethrough"]',function(){return styleInfo['font-strikethrough']==='strikethrough';});btnState('button[data-event="superscript"]',function(){return styleInfo['font-superscript']==='superscript';});btnState('button[data-event="subscript"]',function(){return styleInfo['font-subscript']==='subscript';});btnState('button[data-event="justifyLeft"]',function(){return styleInfo['text-align']==='left'||styleInfo['text-align']==='start';});btnState('button[data-event="justifyCenter"]',function(){return styleInfo['text-align']==='center';});btnState('button[data-event="justifyRight"]',function(){return styleInfo['text-align']==='right';});btnState('button[data-event="justifyFull"]',function(){return styleInfo['text-align']==='justify';});btnState('button[data-event="insertUnorderedList"]',function(){return styleInfo['list-style']==='unordered';});btnState('button[data-event="insertOrderedList"]',function(){return styleInfo['list-style']==='ordered';});};this.updateRecentColor=function(button,eventName,value){};};var Toolbar=function(){var button=new Button();this.update=function($toolbar,styleInfo){button.update($toolbar,styleInfo);};this.updateRecentColor=function(buttonNode,eventName,value){button.updateRecentColor(buttonNode,eventName,value);};this.activate=function($toolbar){$toolbar.find('button').not('button[data-event="codeview"]').removeClass('disabled');};this.deactivate=function($toolbar){$toolbar.find('button').not('button[data-event="codeview"]').addClass('disabled');};this.updateFullscreen=function($container,bFullscreen){var $btn=$container.find('button[data-event="fullscreen"]');$btn.toggleClass('active',bFullscreen);};this.updateCodeview=function($container,isCodeview){var $btn=$container.find('button[data-event="codeview"]');$btn.toggleClass('active',isCodeview);};};var Popover=function(){var button=new Button();var posFromPlaceholder=function(placeholder,isAirMode){var $placeholder=$(placeholder);var pos=isAirMode?$placeholder.offset():$placeholder.position();var height=$placeholder.outerHeight(true);return{left:pos.left,top:pos.top+height};};var showPopover=function($popover,pos){$popover.css({display:'block',left:pos.left,top:pos.top});};var PX_POPOVER_ARROW_OFFSET_X=20;this.update=function($popover,styleInfo,isAirMode){button.update($popover,styleInfo);var $linkPopover=$popover.find('.note-link-popover');if(styleInfo.anchor){var $anchor=$linkPopover.find('a');var href=$(styleInfo.anchor).attr('href');$anchor.attr('href',href).html(href);showPopover($linkPopover,posFromPlaceholder(styleInfo.anchor,isAirMode));}else{$linkPopover.hide();}
var $imagePopover=$popover.find('.note-image-popover');if(styleInfo.image){showPopover($imagePopover,posFromPlaceholder(styleInfo.image,isAirMode));}else{$imagePopover.hide();}
var $airPopover=$popover.find('.note-air-popover');if(isAirMode&&!styleInfo.range.isCollapsed()){var rect=list.last(styleInfo.range.getClientRects());if(rect){var bnd=func.rect2bnd(rect);showPopover($airPopover,{left:Math.max(bnd.left+bnd.width / 2-PX_POPOVER_ARROW_OFFSET_X,0),top:bnd.top+bnd.height});}}else{$airPopover.hide();}};this.updateRecentColor=function(button,eventName,value){button.updateRecentColor(button,eventName,value);};this.hide=function($popover){$popover.children().hide();};};var Handle=function(){this.update=function($handle,styleInfo,isAirMode){var $selection=$handle.find('.note-control-selection');if(styleInfo.image){var $image=$(styleInfo.image);var pos=isAirMode?$image.offset():$image.position();var imageSize={w:$image.outerWidth(true),h:$image.outerHeight(true)};$selection.css({display:'block',left:pos.left,top:pos.top,width:imageSize.w,height:imageSize.h}).data('target',styleInfo.image);var sizingText=imageSize.w+'x'+imageSize.h;$selection.find('.note-control-selection-info').text(sizingText);}else{$selection.hide();}};this.hide=function($handle){$handle.children().hide();};};var Dialog=function(){var toggleBtn=function($btn,isEnable){$btn.toggleClass('disabled',!isEnable);$btn.attr('disabled',!isEnable);};this.showImageDialog=function($editable,$dialog){return $.Deferred(function(deferred){var $imageDialog=$dialog.find('.note-image-dialog');var $imageInput=$dialog.find('.note-image-input'),$imageUrl=$dialog.find('.note-image-url'),$imageBtn=$dialog.find('.note-image-btn');$imageDialog.one('shown.bs.modal',function(){$imageInput.replaceWith($imageInput.clone().on('change',function(){deferred.resolve(this.files||this.value);$imageDialog.modal('hide');}).val(''));$imageBtn.click(function(event){event.preventDefault();deferred.resolve($imageUrl.val());$imageDialog.modal('hide');});$imageUrl.on('keyup paste',function(event){var url;if(event.type==='paste'){url=event.originalEvent.clipboardData.getData('text');}else{url=$imageUrl.val();}
toggleBtn($imageBtn,url);}).val('').trigger('focus');}).one('hidden.bs.modal',function(){$imageInput.off('change');$imageUrl.off('keyup paste');$imageBtn.off('click');if(deferred.state()==='pending'){deferred.reject();}}).modal('show');});};this.showLinkDialog=function($editable,$dialog,linkInfo){return $.Deferred(function(deferred){var $linkDialog=$dialog.find('.note-link-dialog');var $linkText=$linkDialog.find('.note-link-text'),$linkUrl=$linkDialog.find('.note-link-url'),$linkBtn=$linkDialog.find('.note-link-btn'),$openInNewWindow=$linkDialog.find('input[type=checkbox]');$linkDialog.one('shown.bs.modal',function(){$linkText.val(linkInfo.text);$linkText.on('input',function(){linkInfo.text=$linkText.val();});if(!linkInfo.url){linkInfo.url=linkInfo.text;toggleBtn($linkBtn,linkInfo.text);}
$linkUrl.on('input',function(){toggleBtn($linkBtn,$linkUrl.val());if(!linkInfo.text){$linkText.val($linkUrl.val());}}).val(linkInfo.url).trigger('focus').trigger('select');$openInNewWindow.prop('checked',linkInfo.newWindow);$linkBtn.one('click',function(event){event.preventDefault();deferred.resolve({range:linkInfo.range,url:$linkUrl.val(),text:$linkText.val(),newWindow:$openInNewWindow.is(':checked')});$linkDialog.modal('hide');});}).one('hidden.bs.modal',function(){$linkText.off('input');$linkUrl.off('input');$linkBtn.off('click');if(deferred.state()==='pending'){deferred.reject();}}).modal('show');}).promise();};this.showHelpDialog=function($editable,$dialog){return $.Deferred(function(deferred){var $helpDialog=$dialog.find('.note-help-dialog');$helpDialog.one('hidden.bs.modal',function(){deferred.resolve();}).modal('show');}).promise();};};var CodeMirror;if(agent.hasCodeMirror){if(agent.isSupportAmd){require(['CodeMirror'],function(cm){CodeMirror=cm;});}else{CodeMirror=window.CodeMirror;}}
var EventHandler=function(){var $window=$(window);var $document=$(document);var $scrollbar=$('html, body');var editor=new Editor();var toolbar=new Toolbar(),popover=new Popover();var handle=new Handle(),dialog=new Dialog();this.getEditor=function(){return editor;};var makeLayoutInfo=function(descendant){var $editor=$(descendant);return dom.buildLayoutInfo($editor);var $target=$(descendant).closest('.note-editor, .note-air-editor, .note-air-layout');if(!$target.length){return null;}
var $editor;if($target.is('.note-editor, .note-air-editor')){$editor=$target;}else{$editor=$('#note-editor-'+list.last($target.attr('id').split('-')));}
return dom.buildLayoutInfo($editor);};var insertImages=function(layoutInfo,files){var $editor=layoutInfo.editor(),$editable=layoutInfo.editable();var callbacks=$editable.data('callbacks');var options=$editor.data('options');if(callbacks.onImageUpload){callbacks.onImageUpload(files,editor,$editable);}else{$.each(files,function(idx,file){var filename=file.name;if(options.maximumImageFileSize&&options.maximumImageFileSize<file.size){if(callbacks.onImageUploadError){callbacks.onImageUploadError(options.langInfo.image.maximumFileSizeError);}else{alert(options.langInfo.image.maximumFileSizeError);}}else{async.readFileAsDataURL(file).then(function(sDataURL){editor.insertImage($editable,sDataURL,filename);}).fail(function(){if(callbacks.onImageUploadError){callbacks.onImageUploadError();}});}});}};var commands={showLinkDialog:function(layoutInfo){var $editor=layoutInfo.editor(),$dialog=layoutInfo.dialog(),$editable=layoutInfo.editable(),linkInfo=editor.getLinkInfo($editable);var options=$editor.data('options');editor.saveRange($editable);dialog.showLinkDialog($editable,$dialog,linkInfo).then(function(linkInfo){editor.restoreRange($editable);editor.createLink($editable,linkInfo,options);popover.hide(layoutInfo.popover());}).fail(function(){editor.restoreRange($editable);});},showImageDialog:function(layoutInfo){var $dialog=layoutInfo.dialog(),$editable=layoutInfo.editable();editor.saveRange($editable);dialog.showImageDialog($editable,$dialog).then(function(data){editor.restoreRange($editable);if(typeof data==='string'){editor.insertImage($editable,data);}else{insertImages(layoutInfo,data);}}).fail(function(){editor.restoreRange($editable);});},showHelpDialog:function(layoutInfo){var $dialog=layoutInfo.dialog(),$editable=layoutInfo.editable();editor.saveRange($editable,true);dialog.showHelpDialog($editable,$dialog).then(function(){editor.restoreRange($editable);});},fullscreen:function(layoutInfo){var $editor=layoutInfo.editor(),$toolbar=layoutInfo.toolbar(),$editable=layoutInfo.editable(),$codable=layoutInfo.codable();var resize=function(size){$editable.css('height',size.h);$codable.css('height',size.h);if($codable.data('cmeditor')){$codable.data('cmeditor').setsize(null,size.h);}};$editor.toggleClass('fullscreen');var isFullscreen=$editor.hasClass('fullscreen');if(isFullscreen){$editable.data('orgheight',$editable.css('height'));$scrollbar.css('overflow','hidden');}else{$window.off('resize');resize({h:$editable.data('orgheight')});$scrollbar.css('overflow','visible');}
toolbar.updateFullscreen($toolbar,isFullscreen);},codeview:function(layoutInfo){var $editor=layoutInfo.editor(),$toolbar=layoutInfo.toolbar(),$editable=layoutInfo.editable(),$codable=layoutInfo.codable(),$popover=layoutInfo.popover(),$handle=layoutInfo.handle();var options=$editor.data('options');var cmEditor,server;$editor.toggleClass('codeview');var isCodeview=$editor.hasClass('codeview');if(isCodeview){$codable.val(dom.html($editable,options.prettifyHtml));$codable.height($editable.height());toolbar.deactivate($toolbar);popover.hide($popover);handle.hide($handle);$codable.focus();if(agent.hasCodeMirror){cmEditor=CodeMirror.fromTextArea($codable[0],options.codemirror);if(options.codemirror.tern){server=new CodeMirror.TernServer(options.codemirror.tern);cmEditor.ternServer=server;cmEditor.on('cursorActivity',function(cm){server.updateArgHints(cm);});}
cmEditor.setSize(null,$editable.outerHeight());$codable.data('cmEditor',cmEditor);}}else{if(agent.hasCodeMirror){cmEditor=$codable.data('cmEditor');$codable.val(cmEditor.getValue());cmEditor.toTextArea();}
$editable.html(dom.value($codable,options.prettifyHtml)||dom.emptyPara);$editable.height(options.height?$codable.height():'auto');toolbar.activate($toolbar);$editable.focus();}
toolbar.updateCodeview(layoutInfo.toolbar(),isCodeview);}};var hMousedown=function(event){if(dom.isImg(event.target)){event.preventDefault();}};var hToolbarAndPopoverUpdate=function(event){setTimeout(function(){var layoutInfo=makeLayoutInfo(event.currentTarget||event.target);var styleInfo=editor.currentStyle(event.target);if(!styleInfo){return;}
var isAirMode=layoutInfo.editor().data('options').airMode;if(!isAirMode){toolbar.update(layoutInfo.toolbar(),styleInfo);}
popover.update(layoutInfo.popover(),styleInfo,isAirMode);handle.update(layoutInfo.handle(),styleInfo,isAirMode);},0);};var hScroll=function(event){popover.hide(layoutInfo.popover());handle.hide(layoutInfo.handle());};var hPasteClipboardImage=function(event){var clipboardData=event.originalEvent.clipboardData;var layoutInfo=makeLayoutInfo(event.currentTarget||event.target);var $editable=layoutInfo.editable();if(!clipboardData||!clipboardData.items||!clipboardData.items.length){var callbacks=$editable.data('callbacks');if(!callbacks.onImageUpload){return;}
editor.saveNode($editable);editor.saveRange($editable);$editable.html('');setTimeout(function(){var $img=$editable.find('img');var datauri=$img[0].src;var data=atob(datauri.split(',')[1]);var array=new Uint8Array(data.length);for(var i=0;i<data.length;i++){array[i]=data.charCodeAt(i);}
var blob=new Blob([array],{type:'image/png'});blob.name='clipboard.png';editor.restoreNode($editable);editor.restoreRange($editable);insertImages(layoutInfo,[blob]);editor.afterCommand($editable);},0);return;}
var item=list.head(clipboardData.items);var isClipboardImage=item.kind==='file'&&item.type.indexOf('image/')!==-1;if(isClipboardImage){insertImages(layoutInfo,[item.getAsFile()]);}
editor.afterCommand($editable);};var hHandleMousedown=function(event){if(dom.isControlSizing(event.target)){event.preventDefault();event.stopPropagation();var layoutInfo=makeLayoutInfo(event.target),$handle=layoutInfo.handle(),$popover=layoutInfo.popover(),$editable=layoutInfo.editable(),$editor=layoutInfo.editor();var target=$handle.find('.note-control-selection').data('target'),$target=$(target),posStart=$target.offset(),scrollTop=$document.scrollTop();}};var hToolbarAndPopoverMousedown=function(event){var $btn=$(event.target).closest('[data-event]');if($btn.length){event.preventDefault();}};var hToolbarAndPopoverClick=function(event){var $btn=$(event.target).closest('[data-event]');if($btn.length){var eventName=$btn.attr('data-event'),value=$btn.attr('data-value'),hide=$btn.attr('data-hide');var layoutInfo=makeLayoutInfo(event.target);var $target;if($.inArray(eventName,['resize','floatMe','removeMedia','imageShape'])!==-1){var $selection=layoutInfo.handle().find('.note-control-selection');$target=$($selection.data('target'));}
if(hide){$btn.parents('.popover').hide();}
if($.isFunction($.summernote.pluginEvents[eventName])){$.summernote.pluginEvents[eventName](event,editor,layoutInfo,value);}else if(editor[eventName]){var $editable=layoutInfo.editable();$editable.trigger('focus');editor[eventName]($editable,value,$target);event.preventDefault();}else if(commands[eventName]){commands[eventName].call(this,layoutInfo);event.preventDefault();}
if($.inArray(eventName,['backColor','foreColor'])!==-1){var options=layoutInfo.editor().data('options',options);var module=options.airMode?popover:toolbar;module.updateRecentColor(list.head($btn),eventName,value);}
hToolbarAndPopoverUpdate(event);}};var EDITABLE_PADDING=24;var hStatusbarMousedown=function(event){event.preventDefault();event.stopPropagation();var $editable=makeLayoutInfo(event.target).editable();var nEditableTop=$editable.offset().top-$document.scrollTop();var layoutInfo=makeLayoutInfo(event.currentTarget||event.target);var options=layoutInfo.editor().data('options');};var PX_PER_EM=18;var hDimensionPickerMove=function(event,options){var $picker=$(event.target.parentNode);var $dimensionDisplay=$picker.next();var $catcher=$picker.find('.note-dimension-picker-mousecatcher');var $highlighted=$picker.find('.note-dimension-picker-highlighted');var $unhighlighted=$picker.find('.note-dimension-picker-unhighlighted');var posOffset;if(event.offsetX===undefined){var posCatcher=$(event.target).offset();posOffset={x:event.pageX-posCatcher.left,y:event.pageY-posCatcher.top};}else{posOffset={x:event.offsetX,y:event.offsetY};}
var dim={c:Math.ceil(posOffset.x / PX_PER_EM)||1,r:Math.ceil(posOffset.y / PX_PER_EM)||1};$highlighted.css({width:dim.c+'em',height:dim.r+'em'});$catcher.attr('data-value',dim.c+'x'+dim.r);if(3<dim.c&&dim.c<options.insertTableMaxSize.col){$unhighlighted.css({width:dim.c+1+'em'});}
if(3<dim.r&&dim.r<options.insertTableMaxSize.row){$unhighlighted.css({height:dim.r+1+'em'});}
$dimensionDisplay.html(dim.c+' x '+dim.r);};var handleDragAndDropEvent=function(layoutInfo,options){};var attachDragAndDropEvent=function(layoutInfo,options){};this.bindKeyMap=function(layoutInfo,keyMap){var $editor=layoutInfo.editor;var $editable=layoutInfo.editable;layoutInfo=makeLayoutInfo($editable);$editable.on('keydown',function(event){var aKey=[];if(event.metaKey){aKey.push('CMD');}
if(event.ctrlKey&&!event.altKey){aKey.push('CTRL');}
if(event.shiftKey){aKey.push('SHIFT');}
var keyName=key.nameFromCode[event.keyCode];if(keyName){aKey.push(keyName);}
var eventName=keyMap[aKey.join('+')];if(eventName){if($.summernote.pluginEvents[eventName]){var plugin=$.summernote.pluginEvents[eventName];if($.isFunction(plugin)){plugin(event,editor,layoutInfo);}}else if(editor[eventName]){editor[eventName]($editable,$editor.data('options'));event.preventDefault();}else if(commands[eventName]){commands[eventName].call(this,layoutInfo);event.preventDefault();}}else if(key.isEdit(event.keyCode)){editor.afterCommand($editable);}});};this.attach=function(layoutInfo,options){if(options.shortcuts){this.bindKeyMap(layoutInfo,options.keyMap[agent.isMac?'mac':'pc']);}
layoutInfo.editable.on('mousedown',hMousedown);layoutInfo.editable.on('keyup mouseup',hToolbarAndPopoverUpdate);layoutInfo.editable.on('paste',hPasteClipboardImage);layoutInfo.handle.on('mousedown',hHandleMousedown);layoutInfo.popover.on('click',hToolbarAndPopoverClick);layoutInfo.popover.on('mousedown',hToolbarAndPopoverMousedown);if(!options.airMode){layoutInfo.toolbar.on('click',hToolbarAndPopoverClick);layoutInfo.toolbar.on('mousedown',hToolbarAndPopoverMousedown);if(!options.disableResizeEditor){layoutInfo.statusbar.on('mousedown',hStatusbarMousedown);}}
var $catcherContainer=options.airMode?layoutInfo.popover:layoutInfo.toolbar;var $catcher=$catcherContainer.find('.note-dimension-picker-mousecatcher');layoutInfo.editor.data('options',options);if(!agent.isMSIE){setTimeout(function(){document.execCommand('styleWithCSS',0,options.styleWithSpan);},0);}
var history=new History(layoutInfo.editable);layoutInfo.editable.data('NoteHistory',history);if(options.onenter){layoutInfo.editable.keypress(function(event){if(event.keyCode===key.ENTER){options.onenter(event);}});}
if(options.onfocus){layoutInfo.editable.focus(options.onfocus);}
if(options.onblur){layoutInfo.editable.blur(options.onblur);}
if(options.onkeyup){layoutInfo.editable.keyup(options.onkeyup);}
if(options.onkeydown){layoutInfo.editable.keydown(options.onkeydown);}
if(options.onpaste){layoutInfo.editable.on('paste',options.onpaste);}
if(options.onToolbarClick){layoutInfo.toolbar.click(options.onToolbarClick);}
if(options.onChange){var hChange=function(){editor.triggerOnChange(layoutInfo.editable);};if(agent.isMSIE){var sDomEvents='DOMCharacterDataModified DOMSubtreeModified DOMNodeInserted';layoutInfo.editable.on(sDomEvents,hChange);}else{layoutInfo.editable.on('input',hChange);}}
layoutInfo.editable.data('callbacks',{onBeforeChange:options.onBeforeChange,onChange:options.onChange,onAutoSave:options.onAutoSave,onImageUpload:options.onImageUpload,onImageUploadError:options.onImageUploadError,onFileUpload:options.onFileUpload,onFileUploadError:options.onFileUpload,onMediaDelete:options.onMediaDelete});};this.detach=function(layoutInfo,options){layoutInfo.editable.off();layoutInfo.popover.off();layoutInfo.handle.off();layoutInfo.dialog.off();if(options&&!options.airMode){layoutInfo.toolbar.off();}};};var Renderer=function(){var tplButton=function(label,options){var event=options.event;var value=options.value;var title=options.title;var className=options.className;var dropdown=options.dropdown;var hide=options.hide;return'<button type="button"'+' class="btn btn-default btn-sm btn-small'+
(className?' '+className:'')+
(dropdown?' dropdown-toggle':'')+'"'+
(dropdown?' data-toggle="dropdown"':'')+
(title?' title="'+title+'"':'')+
(event?' data-event="'+event+'"':'')+
(value?' data-value=\''+value+'\'':'')+
(hide?' data-hide=\''+hide+'\'':'')+' tabindex="-1">'+
label+
(dropdown?' <span class="caret"></span>':'')+'</button>'+
(dropdown||'');};var tplIconButton=function(iconClassName,options){var label='<i class="'+iconClassName+'"></i>';return tplButton(label,options);};var tplPopover=function(className,content){return'<div class="'+className+' popover bottom in" style="display: none;">'+'<div class="arrow"></div>'+'<div class="popover-content">'+
content+'</div>'+'</div>';};var tplDialog=function(className,title,body,footer){return'<div class="'+className+' modal" aria-hidden="false">'+'<div class="modal-dialog">'+'<div class="modal-content">'+
(title?'<div class="modal-header">'+'<button type="button" class="close" aria-hidden="true" tabindex="-1">&times;</button>'+'<h4 class="modal-title">'+title+'</h4>'+'</div>':'')+'<form class="note-modal-form">'+'<div class="modal-body">'+body+'</div>'+
(footer?'<div class="modal-footer">'+footer+'</div>':'')+'</form>'+'</div>'+'</div>'+'</div>';};var tplButtonInfo={picture:function(lang){return tplIconButton('fa fa-picture-o',{event:'showImageDialog',title:lang.image.image,hide:true});},link:function(lang){return tplIconButton('fa fa-link',{event:'showLinkDialog',title:lang.link.link,hide:true});},table:function(lang){var dropdown='<ul class="note-table dropdown-menu">'+'<div class="note-dimension-picker">'+'<div class="note-dimension-picker-mousecatcher" data-event="insertTable" data-value="1x1"></div>'+'<div class="note-dimension-picker-highlighted"></div>'+'<div class="note-dimension-picker-unhighlighted"></div>'+'</div>'+'<div class="note-dimension-display"> 1 x 1 </div>'+'</ul>';return tplIconButton('fa fa-table',{title:lang.table.table,dropdown:dropdown});},style:function(lang,options){var items=options.styleTags.reduce(function(memo,v){var label=lang.style[v==='p'?'normal':v];return memo+'<li><a data-event="formatBlock" href="#" data-value="'+v+'">'+
((v==='p'||v==='pre')?label:'<'+v+'>'+label+'</'+v+'>')+'</a></li>';},'');return tplIconButton('fa fa-magic',{title:lang.style.style,dropdown:'<ul class="dropdown-menu">'+items+'</ul>'});},fontname:function(lang,options){var items=options.fontNames.reduce(function(memo,v){if(!agent.isFontInstalled(v)&&options.fontNamesIgnoreCheck.indexOf(v)===-1){return memo;}
return memo+'<li><a data-event="fontName" href="#" data-value="'+v+'" style="font-family:\''+v+'\'">'+'<i class="fa fa-check"></i> '+v+'</a></li>';},'');var label='<span class="note-current-fontname">'+
options.defaultFontName+'</span>';return tplButton(label,{title:lang.font.name,dropdown:'<ul class="dropdown-menu">'+items+'</ul>'});},color:function(lang){var colorButtonLabel='<i class="fa fa-font" style="color:black;background-color:yellow;"></i>';var colorButton=tplButton(colorButtonLabel,{className:'note-color btn-group',title:lang.color.recent,event:'color',value:'{"backColor":"yellow"}'});var dropdown='<ul class="dropdown-menu">'+'<li>'+'<div class="btn-group">'+'<div class="note-palette-title">'+_lang('FONT_COLOR')+'</div>'+'<div class="note-color-reset" data-event="foreColor" data-value="inherit" title="'+_lang('FONT_COLOR_RESET')+'">'+
_lang('FONT_COLOR_RESET')+'</div>'+'<div class="note-color-palette" data-target-event="foreColor"></div>'+'</div>'+'</li>'+'</ul>';var moreButton=tplButton('<i class="fa fa-font" style="color:#5082A5;"></i>',{title:lang.color.more,className:'note-color btn-group',dropdown:dropdown});return moreButton;},bold:function(lang){return tplIconButton('fa fa-bold',{event:'bold',title:lang.font.bold});},italic:function(lang){return tplIconButton('fa fa-italic',{event:'italic',title:lang.font.italic});},underline:function(lang){return tplIconButton('fa fa-underline',{event:'underline',title:lang.font.underline});},clear:function(lang){return tplIconButton('fa fa-eraser',{event:'removeFormat',title:lang.font.clear});},ul:function(lang){return tplIconButton('fa fa-list-ul',{event:'insertUnorderedList',title:lang.lists.unordered});},ol:function(lang){return tplIconButton('fa fa-list-ol',{event:'insertOrderedList',title:lang.lists.ordered});},paragraph:function(lang){var leftButton=tplIconButton('fa fa-align-left',{title:lang.paragraph.left,event:'justifyLeft'});var centerButton=tplIconButton('fa fa-align-center',{title:lang.paragraph.center,event:'justifyCenter'});var rightButton=tplIconButton('fa fa-align-right',{title:lang.paragraph.right,event:'justifyRight'});var justifyButton=tplIconButton('fa fa-align-justify',{title:lang.paragraph.justify,event:'justifyFull'});var outdentButton=tplIconButton('fa fa-outdent',{title:lang.paragraph.outdent,event:'outdent'});var indentButton=tplIconButton('fa fa-indent',{title:lang.paragraph.indent,event:'indent'});return'<div class="note-align btn-group">'+
leftButton+centerButton+rightButton+justifyButton+'</div>';},fontsize:function(lang){var dropdown='<ul class="dropdown-menu">'+'<li><a data-event="fontSize" data-value="8"><i class="fa fa-check icon-ok"></i> 8</a></li>'+'<li><a data-event="fontSize" data-value="9"><i class="fa fa-check icon-ok"></i> 9</a></li>'+'<li><a data-event="fontSize" data-value="10"><i class="fa fa-check icon-ok"></i> 10</a></li>'+'<li><a data-event="fontSize" data-value="11"><i class="fa fa-check icon-ok"></i> 11</a></li>'+'<li><a data-event="fontSize" data-value="12"><i class="fa fa-check icon-ok"></i> 12</a></li>'+'<li><a data-event="fontSize" data-value="14"><i class="fa fa-check icon-ok"></i> 14</a></li>'+'<li><a data-event="fontSize" data-value="16"><i class="fa fa-check icon-ok"></i> 16</a></li>'+'<li><a data-event="fontSize" data-value="18"><i class="fa fa-check icon-ok"></i> 18</a></li>'+'<li><a data-event="fontSize" data-value="20"><i class="fa fa-check icon-ok"></i> 20</a></li>'+'<li><a data-event="fontSize" data-value="24"><i class="fa fa-check icon-ok"></i> 24</a></li>'+'<li><a data-event="fontSize" data-value="28"><i class="fa fa-check icon-ok"></i> 28</a></li>'+'<li><a data-event="fontSize" data-value="30"><i class="fa fa-check icon-ok"></i> 30</a></li>'+'<li><a data-event="fontSize" data-value="32"><i class="fa fa-check icon-ok"></i> 32</a></li>'+'<li><a data-event="fontSize" data-value="36"><i class="fa fa-check icon-ok"></i> 36</a></li>'+'<li><a data-event="fontSize" data-value="42"><i class="fa fa-check icon-ok"></i> 42</a></li>'+'<li><a data-event="fontSize" data-value="50"><i class="fa fa-check icon-ok"></i> 50</a></li>'+'<li><a data-event="fontSize" data-value="66"><i class="fa fa-check icon-ok"></i> 66</a></li>'+'</ul>';return tplIconButton('fa note-current-fontsize',{dropdown:dropdown});},height:function(lang,options){var items=options.lineHeights.reduce(function(memo,v){return memo+'<li><a data-event="lineHeight" href="#" data-value="'+parseFloat(v)+'">'+'<i class="fa fa-check"></i> '+v+'</a></li>';},'');return tplIconButton('fa fa-text-height',{title:lang.font.height,dropdown:'<ul class="dropdown-menu">'+items+'</ul>'});},help:function(lang){return tplIconButton('fa fa-question',{event:'showHelpDialog',title:lang.options.help,hide:true});},fullscreen:function(lang){return tplIconButton('fa fa-arrows-alt',{event:'fullscreen',title:lang.options.fullscreen});},codeview:function(lang){return tplIconButton('fa fa-code',{event:'codeview',title:lang.options.codeview});},undo:function(lang){return tplIconButton('fa fa-undo',{event:'undo',title:lang.history.undo});},redo:function(lang){return tplIconButton('fa fa-repeat',{event:'redo',title:lang.history.redo});},hr:function(lang){return tplIconButton('fa fa-minus',{event:'insertHorizontalRule',title:lang.hr.insert});}};var tplPopovers=function(lang,options){var tplLinkPopover=function(){var linkButton=tplIconButton('fa fa-edit',{title:lang.link.edit,event:'showLinkDialog',hide:true});var unlinkButton=tplIconButton('fa fa-unlink',{title:lang.link.unlink,event:'unlink'});var content='<a href="http://www.google.com" target="_blank">www.google.com</a>&nbsp;&nbsp;'+'<div class="note-insert btn-group">'+
linkButton+unlinkButton+'</div>';return tplPopover('note-link-popover',content);};var tplImagePopover=function(){var fullButton=tplButton('<span class="note-fontsize-10">100%</span>',{title:lang.image.resizeFull,event:'resize',value:'1'});var halfButton=tplButton('<span class="note-fontsize-10">50%</span>',{title:lang.image.resizeHalf,event:'resize',value:'0.5'});var quarterButton=tplButton('<span class="note-fontsize-10">25%</span>',{title:lang.image.resizeQuarter,event:'resize',value:'0.25'});var leftButton=tplIconButton('fa fa-align-left',{title:lang.image.floatLeft,event:'floatMe',value:'left'});var rightButton=tplIconButton('fa fa-align-right',{title:lang.image.floatRight,event:'floatMe',value:'right'});var justifyButton=tplIconButton('fa fa-align-justify',{title:lang.image.floatNone,event:'floatMe',value:'none'});var roundedButton=tplIconButton('fa fa-square',{title:lang.image.shapeRounded,event:'imageShape',value:'img-rounded'});var circleButton=tplIconButton('fa fa-circle-o',{title:lang.image.shapeCircle,event:'imageShape',value:'img-circle'});var thumbnailButton=tplIconButton('fa fa-picture-o',{title:lang.image.shapeThumbnail,event:'imageShape',value:'img-thumbnail'});var noneButton=tplIconButton('fa fa-times',{title:lang.image.shapeNone,event:'imageShape',value:''});var removeButton=tplIconButton('fa fa-trash-o',{title:lang.image.remove,event:'removeMedia',value:'none'});var content='<div class="btn-group">'+fullButton+halfButton+quarterButton+'</div>'+'<div class="btn-group">'+leftButton+rightButton+justifyButton+'</div>'+'<div class="btn-group">'+roundedButton+circleButton+thumbnailButton+noneButton+'</div>'+'<div class="btn-group">'+removeButton+'</div>';return tplPopover('note-image-popover',content);};var tplAirPopover=function(){var content='';for(var idx=0,len=options.airPopover.length;idx<len;idx++){var group=options.airPopover[idx];content+='<div class="note-'+group[0]+' btn-group">';for(var i=0,lenGroup=group[1].length;i<lenGroup;i++){content+=tplButtonInfo[group[1][i]](lang,options);}
content+='</div>';}
return tplPopover('note-air-popover',content);};return'<div class="note-popover">'+
tplLinkPopover()+
tplImagePopover()+
(options.airMode?tplAirPopover():'')+'</div>';};var tplHandles=function(){return'<div class="note-handle">'+'<div class="note-control-selection">'+'<div class="note-control-selection-bg"></div>'+'<div class="note-control-holder note-control-nw"></div>'+'<div class="note-control-holder note-control-ne"></div>'+'<div class="note-control-holder note-control-sw"></div>'+'<div class="note-control-sizing note-control-se"></div>'+'<div class="note-control-selection-info"></div>'+'</div>'+'</div>';};var tplShortcut=function(title,keys){var keyClass='note-shortcut-col col-xs-6 note-shortcut-';var body=[];for(var i in keys){if(keys.hasOwnProperty(i)){body.push('<div class="'+keyClass+'key">'+keys[i].kbd+'</div>'+'<div class="'+keyClass+'name">'+keys[i].text+'</div>');}}
return'<div class="note-shortcut-row row"><div class="'+keyClass+'title col-xs-offset-6">'+title+'</div></div>'+'<div class="note-shortcut-row row">'+body.join('</div><div class="note-shortcut-row row">')+'</div>';};var tplShortcutText=function(lang){var keys=[{kbd:' + B',text:lang.font.bold},{kbd:' + I',text:lang.font.italic},{kbd:' + U',text:lang.font.underline},{kbd:' + \\',text:lang.font.clear}];return tplShortcut(lang.shortcut.textFormatting,keys);};var tplShortcutAction=function(lang){var keys=[{kbd:' + Z',text:lang.history.undo},{kbd:' +  + Z',text:lang.history.redo},{kbd:' + ]',text:lang.paragraph.indent},{kbd:' + [',text:lang.paragraph.outdent},{kbd:' + ENTER',text:lang.hr.insert}];return tplShortcut(lang.shortcut.action,keys);};var tplShortcutPara=function(lang){var keys=[{kbd:' +  + L',text:lang.paragraph.left},{kbd:' +  + E',text:lang.paragraph.center},{kbd:' +  + R',text:lang.paragraph.right},{kbd:' +  + J',text:lang.paragraph.justify},{kbd:' +  + NUM7',text:lang.lists.ordered},{kbd:' +  + NUM8',text:lang.lists.unordered}];return tplShortcut(lang.shortcut.paragraphFormatting,keys);};var tplShortcutStyle=function(lang){var keys=[{kbd:' + NUM0',text:lang.style.normal},{kbd:' + NUM1',text:lang.style.h1},{kbd:' + NUM2',text:lang.style.h2},{kbd:' + NUM3',text:lang.style.h3},{kbd:' + NUM4',text:lang.style.h4},{kbd:' + NUM5',text:lang.style.h5},{kbd:' + NUM6',text:lang.style.h6}];return tplShortcut(lang.shortcut.documentStyle,keys);};var tplExtraShortcuts=function(lang,options){var extraKeys=options.extraKeys;var keys=[];for(var key in extraKeys){if(extraKeys.hasOwnProperty(key)){keys.push({kbd:key,text:extraKeys[key]});}}
return tplShortcut(lang.shortcut.extraKeys,keys);};var tplShortcutTable=function(lang,options){var colClass='class="note-shortcut note-shortcut-col col-sm-6 col-xs-12"';var template=['<div '+colClass+'>'+tplShortcutAction(lang,options)+'</div>'+'<div '+colClass+'>'+tplShortcutText(lang,options)+'</div>','<div '+colClass+'>'+tplShortcutStyle(lang,options)+'</div>'+'<div '+colClass+'>'+tplShortcutPara(lang,options)+'</div>'];if(options.extraKeys){template.push('<div '+colClass+'>'+tplExtraShortcuts(lang,options)+'</div>');}
return'<div class="note-shortcut-row row">'+
template.join('</div><div class="note-shortcut-row row">')+'</div>';};var replaceMacKeys=function(sHtml){return sHtml.replace(//g,'Ctrl').replace(//g,'Shift');};var tplDialogInfo={image:function(lang,options){var imageLimitation='';if(options.maximumImageFileSize){var unit=Math.floor(Math.log(options.maximumImageFileSize)/ Math.log(1024));var readableSize=(options.maximumImageFileSize / Math.pow(1024,unit)).toFixed(2)*1+' '+' KMGTP'[unit]+'B';imageLimitation='<small>'+lang.image.maximumFileSize+' : '+readableSize+'</small>';}
var body='<div class="form-group row-fluid note-group-select-from-files">'+'<label>'+lang.image.selectFromFiles+'</label>'+'<input class="note-image-input" type="file" name="files" accept="image/*" multiple="multiple" />'+
imageLimitation+'</div>'+'<div class="form-group row-fluid">'+'<label>'+lang.image.url+'</label>'+'<input class="note-image-url form-control span12" type="text" />'+'</div>';var footer='<button href="#" class="btn btn-primary note-image-btn disabled" disabled>'+lang.image.insert+'</button>';return tplDialog('note-image-dialog',lang.image.insert,body,footer);},link:function(lang,options){var body='<div class="form-group row-fluid">'+'<label>'+_lang('INSERT_LINK_TXT_TO_DISPLAY')+'</label>'+'<input class="note-link-text form-control span12" type="text" />'+'</div>'+'<div class="form-group row-fluid">'+'<label>'+_lang('INSERT_LINK_URL')+'</label>'+'<input class="note-link-url form-control span12" type="text" />'+'</div>'+
(!options.disableLinkTarget?'<div class="checkbox">'+'<label>'+'<input type="checkbox" checked> '+
lang.link.openInNewWindow+'</label>'+'</div>':'');var footer='<button href="#" class="btn btn-primary note-link-btn disabled" disabled>'+_lang('INSERT_LINK')+'</button>';return tplDialog('note-link-dialog',_lang('INSERT_LINK'),body,footer);},help:function(lang,options){var body='<a class="modal-close pull-right" aria-hidden="true" tabindex="-1">'+lang.shortcut.close+'</a>'+'<div class="title">'+lang.shortcut.shortcuts+'</div>'+
(agent.isMac?tplShortcutTable(lang,options):replaceMacKeys(tplShortcutTable(lang,options)))+'<p class="text-center">'+'<a href="//summernote.org/" target="_blank">Summernote 0.6.1</a>  '+'<a href="//github.com/summernote/summernote" target="_blank">Project</a>  '+'<a href="//github.com/summernote/summernote/issues" target="_blank">Issues</a>'+'</p>';return tplDialog('note-help-dialog','',body,'');}};var tplDialogs=function(lang,options){var dialogs='';$.each(tplDialogInfo,function(idx,tplDialog){dialogs+=tplDialog(lang,options);});return'<div class="note-dialog">'+dialogs+'</div>';};var tplStatusbar=function(){return'<div class="note-resizebar">'+'<div class="note-icon-bar"></div>'+'<div class="note-icon-bar"></div>'+'<div class="note-icon-bar"></div>'+'</div>';};var representShortcut=function(str){if(agent.isMac){str=str.replace('CMD','').replace('SHIFT','');}
return str.replace('BACKSLASH','\\').replace('SLASH','/').replace('LEFTBRACKET','[').replace('RIGHTBRACKET',']');};var createTooltip=function($container,keyMap,sPlacement){var invertedKeyMap=func.invertObject(keyMap);var $buttons=$container.find('button');$buttons.each(function(i,elBtn){var $btn=$(elBtn);var sShortcut=invertedKeyMap[$btn.data('event')];if(sShortcut){$btn.attr('title',function(i,v){return v+' ('+representShortcut(sShortcut)+')';});}}).tooltip({container:'body',trigger:'hover',placement:sPlacement||'top'}).on('click',function(){$(this).tooltip('hide');});};var createPalette=function($container,options){var colorInfo=options.colors;$container.find('.note-color-palette').each(function(){var $palette=$(this),eventName=$palette.attr('data-target-event');var paletteContents=[];for(var row=0,lenRow=colorInfo.length;row<lenRow;row++){var colors=colorInfo[row];var buttons=[];for(var col=0,lenCol=colors.length;col<lenCol;col++){var color=colors[col];buttons.push(['<button type="button" class="note-color-btn" style="background-color:',color,';" data-event="',eventName,'" data-value="',color,'" title="',color,'" data-toggle="button" tabindex="-1"></button>'].join(''));}
paletteContents.push('<div class="note-color-row">'+buttons.join('')+'</div>');}
$palette.html(paletteContents.join(''));});};this.createLayoutByAirMode=function($holder,options){alert('air');var langInfo=options.langInfo;var keyMap=options.keyMap[agent.isMac?'mac':'pc'];var id=func.uniqueId();$holder.addClass('note-air-editor note-editable');$holder.attr({'id':'note-editor-'+id,'contentEditable':true});var body=document.body;var $popover=$(tplPopovers(langInfo,options));$popover.addClass('note-air-layout');$popover.attr('id','note-popover-'+id);$popover.appendTo(body);createTooltip($popover,keyMap);createPalette($popover,options);var $handle=$(tplHandles());$handle.addClass('note-air-layout');$handle.attr('id','note-handle-'+id);$handle.appendTo(body);var $dialog=$(tplDialogs(langInfo,options));$dialog.addClass('note-air-layout');$dialog.attr('id','note-dialog-'+id);$dialog.find('button.close, a.modal-close').click(function(){$(this).closest('.modal').modal('hide');});$dialog.appendTo(body);};this.createLayoutByFrame=function($holder,options){var langInfo=options.langInfo;var $editor=$('<div class="note-editor"></div>');if(options.width){$editor.width(options.width);}
var isContentEditable=!$holder.is(':disabled');var $editable=$('<div class="note-editable" contentEditable="'+isContentEditable+'"></div>').prependTo($editor);$editable.html(dom.html($holder));var toolbarHTML='';for(var idx=0,len=options.toolbar.length;idx<len;idx++){var groupName=options.toolbar[idx][0];var groupButtons=options.toolbar[idx][1];toolbarHTML+='<div class="note-'+groupName+' btn-group">';for(var i=0,btnLength=groupButtons.length;i<btnLength;i++){var buttonInfo=tplButtonInfo[groupButtons[i]];if(!$.isFunction(buttonInfo)){continue;}
toolbarHTML+=buttonInfo(langInfo,options);}
toolbarHTML+='</div>';}
toolbarHTML='<div class="note-toolbar btn-toolbar">'+toolbarHTML+'</div>';var menu_txt=$('#menu-text');menu_txt.find('.note-toolbar.btn-toolbar').remove();menu_txt.find('#text-editor-image').hide();var $toolbar=$(toolbarHTML);$toolbar.appendTo(menu_txt);var keyMap=options.keyMap[agent.isMac?'mac':'pc'];createPalette($toolbar,options);var $popover=$(tplPopovers(langInfo,options)).prependTo($editor);createPalette($popover,options);createTooltip($popover,keyMap);$(tplHandles()).prependTo($editor);var body=document.body;var $dialog=$(tplDialogs(langInfo,options)).appendTo(body);$dialog.find('button.close, a.modal-close').click(function(){$(this).closest('.modal').modal('hide');});$editor.insertAfter($holder);$holder.hide();};this.noteEditorFromHolder=function($holder){if($holder.hasClass('note-air-editor')){return $holder;}else if($holder.next().hasClass('note-editor')){return $holder.next();}else{return $();}};this.createLayout=function($holder,options){if(this.noteEditorFromHolder($holder).length){return;}
if(options.airMode){this.createLayoutByAirMode($holder,options);}else{this.createLayoutByFrame($holder,options);}};this.layoutInfoFromHolder=function($holder){var $editor=this.noteEditorFromHolder($holder);if(!$editor.length){return;}
var layoutInfo=dom.buildLayoutInfo($editor);for(var key in layoutInfo){if(layoutInfo.hasOwnProperty(key)){layoutInfo[key]=layoutInfo[key].call();}}
return layoutInfo;};this.removeLayout=function($holder,layoutInfo,options){layoutInfo.popover.remove();layoutInfo.handle.remove();layoutInfo.dialog.remove();$holder.html(layoutInfo.editable.html());layoutInfo.editor.off();layoutInfo.editor.remove();$holder.show();};this.getTemplate=function(){return{button:tplButton,iconButton:tplIconButton,dialog:tplDialog};};this.addButtonInfo=function(name,buttonInfo){tplButtonInfo[name]=buttonInfo;};this.addDialogInfo=function(name,dialogInfo){tplDialogInfo[name]=dialogInfo;};};$.summernote=$.summernote||{};$.extend($.summernote,settings);var renderer=new Renderer();var eventHandler=new EventHandler();$.extend($.summernote,{renderer:renderer,eventHandler:eventHandler,core:{agent:agent,dom:dom,range:range},pluginEvents:{}});$.summernote.addPlugin=function(plugin){if(plugin.buttons){$.each(plugin.buttons,function(name,button){renderer.addButtonInfo(name,button);});}
if(plugin.dialogs){$.each(plugin.dialogs,function(name,dialog){renderer.addDialogInfo(name,dialog);});}
if(plugin.events){$.each(plugin.events,function(name,event){$.summernote.pluginEvents[name]=event;});}
if(plugin.langs){$.each(plugin.langs,function(locale,lang){if($.summernote.lang[locale]){$.extend($.summernote.lang[locale],lang);}});}
if(plugin.options){$.extend($.summernote.options,plugin.options);}};$.fn.extend({summernote:function(options){options=$.extend({},$.summernote.options,options);window._textEditorOptions=options;options.langInfo=$.extend(true,{},$.summernote.lang['en-US'],$.summernote.lang[options.lang]);this.each(function(idx,holder){var $holder=$(holder);renderer.createLayout($holder,options);var info=renderer.layoutInfoFromHolder($holder);eventHandler.attach(info,options);if(dom.isTextarea($holder[0])){$holder.closest('form').submit(function(){var contents=$holder.code();$holder.val(contents);if(options.onsubmit){options.onsubmit(contents);}});}});if(this.first().length&&options.focus){var info=renderer.layoutInfoFromHolder(this.first());info.editable.focus();}
if(this.length&&options.oninit){options.oninit();}
return this;},code:function(sHTML){if(sHTML===undefined){var $holder=this.first();if(!$holder.length){return;}
var info=renderer.layoutInfoFromHolder($holder);if(!!(info&&info.editable)){var isCodeview=info.editor.hasClass('codeview');if(isCodeview&&agent.hasCodeMirror){info.codable.data('cmEditor').save();}
return isCodeview?info.codable.val():info.editable.html();}
return dom.isTextarea($holder[0])?$holder.val():$holder.html();}
this.each(function(i,holder){var info=renderer.layoutInfoFromHolder($(holder));if(info&&info.editable){info.editable.html(sHTML);}});return this;},destroySummernote:function(){this.each(function(idx,holder){var $holder=$(holder);var info=renderer.layoutInfoFromHolder($holder);if(!info||!info.editable){return;}
var options=info.editor.data('options');eventHandler.detach(info,options);renderer.removeLayout($holder,info,options);});window._textEditorOptions.editorWrapper.find('.note-toolbar').remove();return this;}});}));;;var ProjectWatcherModel=Backbone.Model.extend({defaults:function(){return{event:'add',}},initialize:function(){}});;;var ProjectWatcherItemView=Backbone.View.extend({tagName:"li",className:'project-watcher-item-view',template:_.template($('#project-watcher-item-template').html()),events:{},initialize:function(){},render:function(){var template=this.template(this.model.toJSON());this.$el.html(template);return this;}});;;var ProjectWatcherView=Backbone.View.extend({template:_.template($('#project-watcher-template').html()),events:{},initialize:function(){var _that=this;this.collection=new Backbone.Collection();DataAccess.watchProject({},function(data){_log('On project chenged result:',data,_log.error);_that.onProjectChanged(data);},function(data){_log('On project chenged fault:',data,_log.error);});},onProjectChanged:function(data){var _that=this;var stageView=StageView.instance;var rightMenuView=RightMenuView.instance;var projectModel=ProjectModel.instance;var event=data.event;switch(event){case'updateComponent':var components=data.components;var pageId=parseInt(data.pageId);if(!_.isNumber(pageId)){return false;}
if(!_.isArray(components)){return false;}
if(this.pageIsTheSame(pageId)){stageView.updateComponentsResultComing(data);}else{var pageModel=projectModel.getPageModelByPageId(pageId);if(pageModel){pageModel.updateComponentsCollection(data);}}
break;case'addComponents':var components=data.components;var pageId=parseInt(data.pageId);if(!_.isNumber(pageId)){return false;}
if(!_.isArray(components)){return false;}
if(this.pageIsTheSame(pageId)){stageView.addComponentsToStage(data);}else{var pageModel=projectModel.getPageModelByPageId(pageId);if(pageModel){pageModel.addComponents(data);}}
break;case'deleteComponents':var components=data.components;var pageId=parseInt(data.pageId);if(!_.isNumber(pageId)){return false;}
if(!_.isArray(components)){return false;}
if(this.pageIsTheSame(pageId)){stageView.onDeleteComponentsResultComing(data);}else{var pageModel=projectModel.getPageModelByPageId(pageId);if(pageModel){pageModel.deleteComponents(data);}}
break;case'pasteComponents':var components=data.components;var pageId=parseInt(data.pageId);if(!_.isNumber(pageId)){return false;}
if(!_.isArray(components)){return false;}
if(this.pageIsTheSame(pageId)){stageView.onPasteComponentsResult(data);}else{var pageModel=projectModel.getPageModelByPageId(pageId);if(pageModel){pageModel.pasteComponents(data);}}
break;case'cutComponents':var components=data.components;var pageId=parseInt(data.pageId);if(!_.isNumber(pageId)){return false;}
if(!_.isArray(components)){return false;}
if(this.pageIsTheSame(pageId)){stageView.onCutComponentsResultComing(data);}else{var pageModel=projectModel.getPageModelByPageId(pageId);if(pageModel){pageModel.cutComponents(data);}}
break;case'moveComponentsToLayer':var components=data.components;var pageId=parseInt(data.pageId);if(!_.isNumber(pageId)){return false;}
if(!_.isArray(components)){return false;}
if(this.pageIsTheSame(pageId)){stageView.onMoveComponentsResult(data);stageView.renderZIndex();}else{var pageModel=projectModel.getPageModelByPageId(pageId);if(pageModel){pageModel.moveComponentsToLayer(data);}}
break;case'sortRows':var pageId=parseInt(data.pageId);if(!_.isNumber(pageId)){return false;}
if(this.pageIsTheSame(pageId)){stageView.onSortRowsResult(data);}else{var pageModel=projectModel.getPageModelByPageId(pageId);if(pageModel){pageModel.sortRows(data);}}
break;case'updateRowOptions':var pageId=parseInt(data.pageId);if(!_.isNumber(pageId)){return false;}
if(this.pageIsTheSame(pageId)){stageView.updateRowOptionsResult(data);}else{var pageModel=projectModel.getPageModelByPageId(pageId);if(pageModel){pageModel.updateRowOptions(data);}}
break;case'addNewPage':ProjectView.instance.pagesList.onCreateBlankPageComing(data);ProjectView.instance.pagesList.render();ProjectView.instance.pagesList.afterRender();break;case'updatePageSort':ProjectView.instance.pagesList.onUpdatePageSortResult(data);break;case'updatePageOptions':var pageId=parseInt(data.pageId);var pageOptions=data.pageOptions;if(!_.isNumber(pageId)){return false;}
if(this.pageIsTheSame(pageId)){var pageModel=projectModel.getPageModelByPageId(pageId);if(pageModel){var changed=pageModel.updatePageOptions(data);}}else{var pageModel=projectModel.getPageModelByPageId(pageId);var changed=pageModel.updatePageOptions(data);}
break;case'deletePages':ProjectView.instance.pagesList.onPagesDeletedResult(data);break;case'duplicatePages':ProjectView.instance.pagesList.onPagesDuplicatedResultComing(data);break;case'updatePagesOptions':projectModel.updatePagesOptions(data);break;}},pageIsTheSame:function(pageId){return(pageId==StageView.instance.model.get('options').get('pageid')&&StageView.instance.canEdit);},remember:function(data){var _that=this;},render:function(){var template=this.template();this.$el.append(template);var projectWatcherModel=new ProjectWatcherModel();this.collection.add(projectWatcherModel);this.collection.each(this.addItem,this);return this;},addItem:function(itemModel){var itemView=new ProjectWatcherItemView({model:itemModel});this.$el.find('.project-watcher-list').append(itemView.render().$el);},clear:function(){this.collection.reset();this.render();}});;;var HistoryItemModel=Backbone.Model.extend({defaults:function(){return{id:'',action:'',login:'',date:'',params:{},}},initialize:function(){}});;;var HistoryItemsCollection=Backbone.Collection.extend({model:HistoryItemModel,searchStructore:function(value){var _that=this;filtered=this.filter(function(model){return(model.get("login")==value)?true:false;});return new HistoryItemsCollection(filtered);}});;;var HistoryItemView=Backbone.View.extend({tagName:"li",className:'history-item-view',template:_.template($('#history-item-template').html()),templateUpdateComponnets:_.template($('#history-item-update-components-template').html()),templateAddNewPage:_.template($('#history-item-add-new-page-template').html()),templateDeletePages:_.template($('#history-item-delete-pages-template').html()),templateUpdatePageOptions:_.template($('#history-item-update-page-options-template').html()),templateUpdatePageSort:_.template($('#history-item-update-page-sort-template').html()),templateUpdateProjectOptions:_.template($('#history-item-update-project-options-template').html()),templateMoveComponentsToLayers:_.template($('#move-components-to-layer-template').html()),templateSortRows:_.template($('#sort-rows-template').html()),selected:false,events:{'click':'goToHistoryItem'},initialize:function(){this.model.view=this;},goToHistoryItem:function(){this.trigger('go-to-history-item',this.model,this);},select:function(){this.$el.attr('selected','selected');this.selected=true;},unselect:function(){this.$el.attr('selected',false);this.selected=false;},render:function(){var action=this.model.get('action');switch(action){case'updateComponents':case'addComponents':case'deleteComponents':var template=this.templateUpdateComponnets(this.model.toJSON());this.$el.html(template);break;case'addNewPage':var template=this.templateAddNewPage(this.model.toJSON());this.$el.html(template);break;case'deletePages':var template=this.templateDeletePages(this.model.toJSON());this.$el.html(template);break;case'updatePageOptions':var template=this.templateUpdatePageOptions(this.model.toJSON());this.$el.html(template);break;case'updatePageSort':var template=this.templateUpdatePageSort(this.model.toJSON());this.$el.html(template);break;case'updateProjectOptions':var template=this.templateUpdateProjectOptions(this.model.toJSON());this.$el.html(template);break;case'moveComponentsToLayer':var template=this.templateMoveComponentsToLayers(this.model.toJSON());this.$el.html(template);break;case'sortRows':var template=this.templateSortRows(this.model.toJSON());this.$el.html(template);break;default:var template=this.template(this.model.toJSON());this.$el.html(template);break;}
this.$el.attr('selected',this.selected);return this;}});;;var HistoryListView=Backbone.View.extend({index:-1,template:_.template($('#history-list-template').html()),visible:false,isDisabled:false,events:{'click .history-back':'back','click .history-prev':'prev','click .toggle-history-list':'toggleHistoryList'},initialize:function(){this.collection=new HistoryItemsCollection();this.login=_.clone(__meta__.login);},toggleHistoryList:function(){var _that=this;if(this.visible){this.$el.find('.history-list-view').hide();this.visible=false;}else{this.$el.find('.history-list-view').show();this.visible=true;}},start:function(){_log('start watching history: ',{},_log.error);var _that=this;DataAccess.onHistoryChanged({},function(data){_log('Watch history result: ',data,_log.dataaccessOutResult);_that.isDisabled=false;_that.hideHistoryLoader();var event=data.event;switch(event){case'loadHistory':_that.collection.reset();_that.render();for(var i=0;i<data.actions.length;i++){_that.addItem(data.actions[i]);};break;case'addItem':_that.collection.reset();_that.render();for(var i=0;i<data.actions.length;i++){_that.addItem(data.actions[i]);};DarkanEditorAplicationAPI.getInstance().projectChanged({change:_.last(data.actions),event:{name:'project-changed'}});break;case'goToHistoryItem':var id=data.id;var selectedModel=_that.collection.findWhere({id:id});_that.trigger('load-history-project',data);if(selectedModel){_that.selectItem(selectedModel);}
DarkanEditorAplicationAPI.getInstance().projectChanged({change:data.nowAction,event:{name:'history-loaded'}});_that.projectChanged(data.nowAction);break;case'goToHistoryItemPage':_log('goToHistoryItemPage',data);var id=data.id;var selectedModel=_that.collection.findWhere({id:id});_that.trigger('load-history-page',data);if(selectedModel){_that.selectItem(selectedModel);}
DarkanEditorAplicationAPI.getInstance().projectChanged({change:data.nowAction,event:{name:'history-loaded'}});_that.projectChanged(data.nowAction);break;case'deleteSitempas':_that.collection.reset();_that.render();for(var i=0;i<data.actions.length;i++){_that.addItem(data.actions[i]);};break;}},function(data){_log('Watch history fault: ',data,_log.dataaccessOutFault);_that.isDisabled=false;_that.hideHistoryLoader();});},projectChanged:function(action){var pagesList=ProjectView.instance.pagesList;switch(action.action){case'duplicatePages':case'deletePages':case'addNewPage':DarkanEditorAplicationAPI.getInstance().pagesCollectionChanged({pagesLength:pagesList.getPagesLength()});break;}},remember:function(data){var _that=this;},selectModel:function(index,data){},setPageModel:function(pageJson){},render:function(){var historyListTemplate=this.template({});this.$el.html(historyListTemplate);if(this.visible){this.$el.find('.history-list-view').show();}else{this.$el.find('.history-list-view').hide();}
return this;},addItem:function(data){var historyItemModel=new HistoryItemModel(data);this.collection.add(historyItemModel);this.selectItem(historyItemModel);},selectItem:function(itemModel){var login=this.login;if(itemModel.get('login')!=login){return;}
this.lastItemModel=itemModel;},navigateToHistory:function(itemModel){var login=this.login;var userCollection=this.collection.searchStructore(login);if(userCollection.indexOf(itemModel)!==-1){this.goToHistoryItem(itemModel);}},goToHistoryItem:function(itemModel){this.isDisabled=true;this.showHistoryLoader();this.selectItem(itemModel);var id=itemModel.get('id');var direction=itemModel.get('direction');DataAccess.goToHistoryItem({id:id,direction:direction},function(data){_log('Go to history item result: ',data,_log.dataaccessOutResult);},function(data){_log('Go to history item fault: ',data,_log.dataaccessOutFault);});},back:function(){if(this.isDisabled){return;}
var login=this.login;var userCollection=this.collection.searchStructore(login);var id=this.lastItemModel.get('id');_log('back id',id);var lim=userCollection.findWhere({id:id});_log('back lim',lim);var index=userCollection.indexOf(lim);var itemModel=userCollection.at(index-1);_log('back itemModel',itemModel);if(itemModel){itemModel.set('direction','back');this.goToHistoryItem(itemModel);}},prev:function(){if(this.isDisabled){return;}
var login=this.login;var userCollection=this.collection.searchStructore(login);var id=this.lastItemModel.get('id');_log('back id',id);var lim=userCollection.findWhere({id:id});_log('back lim',lim);var index=userCollection.indexOf(lim);var itemModel=userCollection.at(index+1);_log('back itemModel',itemModel);if(itemModel){itemModel.set('direction','prev');this.goToHistoryItem(itemModel);}},clear:function(){},showHistoryLoader:function(){this.historyLoader=new HistoryLoader();$('body').append(this.historyLoader.render().$el);},hideHistoryLoader:function(){if(this.historyLoader){this.historyLoader.remove();}}});var HistoryLoader=Backbone.View.extend({className:'history-loader',template:_.template($('#history-loader').html()),render:function(){var template=this.template(this.serializeData());this.$el.html(template);return this;},serializeData:function(){return{};}});;;function WebService(){}
WebService.create=function(type){switch(type){case'php':return new PhpWebservice();break;case'node':return new NodeWebservice();break;case'fake':return new FakeWebservice();break;default:return new FakeWebservice();break;}}
WebService.prototype.connect=function(params,onResult,onFault)
{}
WebService.prototype.watchProject=function(data,onResult,onFault)
{}
WebService.prototype.loadProject=function(data,onResult,onFault)
{}
WebService.prototype.createBlankPage=function(params,onResult,onFault,onProgress)
{}
WebService.prototype.updatePage=function(params,onResult,onFault,onProgress)
{}
WebService.prototype.deletePage=function(data,onResult,onFault)
{}
WebService.prototype.copyPage=function(data,onResult,onFault)
{}
WebService.prototype.updatePageSort=function(data,onResult,onFault)
{}
WebService.prototype.saveProjectOptions=function(data,onResult,onFault)
{}
WebService.prototype.updateComponent=function(data,onResult,onFault)
{}
WebService.prototype.updateTimeline=function(data,onResult,onFault)
{}
WebService.prototype.updatePageOptions=function(data,onResult,onFault)
{}
WebService.prototype.saveFileOnServer=function(params,onResult,onFault,onProgress)
{}
WebService.prototype.updateSettings=function(settings,params)
{settings=settings||{};for(var item in params)
{settings[item]=params[item];}}
WebService.prototype.sendAndLoad=function(url,settings,onResult,onFault)
{};;function NodeWebservice(){this.connectionString='http://jerzy.pl:3700/';}
NodeWebservice.prototype=new WebService();NodeWebservice.prototype.joinToRoom=function(){this.socket.emit('joinToRoom',{projectID:__meta__.projectID,userID:__meta__.userID,meta:__meta__});}
NodeWebservice.prototype.showWorkingAsOffline=function()
{$('.online-working-status').attr('status','offline');}
NodeWebservice.prototype.showWorkingAsOnline=function()
{$('.online-working-status').attr('status','online');}
NodeWebservice.prototype.connect=function(params,onResult,onFault)
{var _that=this;$('#unexpected-error-modal').hide();if(_.isUndefined(__meta__.userID)){Utils.setModalText({main:_lang('MODAL_INFO_NOTLOGGED')});}
this.socket=io.connect(this.connectionString,{'reconnection':true,'reconnectionDelay':1000,'reconnectionDelayMax':5000,'reconnectionAttempts':5});this.socket.on('darkan-node-error',function(e){Utils.showErrorModal();});switch(__meta__.external){case 0:this.socket.on('connect',function(){_that.joinToRoom();});break;case 1:Utils.setModalText({main:_lang('WAITING_FOR_APIKEY'),extra:_lang('WAITING_FOR_APIKEY_EXTRA')});break;}
this.socket.on('connect_error',function(err){_that.showWorkingAsOffline();});this.socket.on('verifyAccessToProject',function(verifyData){console.log(verifyData);if(verifyData.userHaveAccess){if(verifyData.userHaveAccess=='notexist'){Utils.setModalText({main:_lang('PROJECTNOT_EXIST'),extra:_lang('PROJECTNOT_EXIST_EXTRA')});_layout.darkanapp.html('');}else{Utils.setModalText({main:_lang('PROJECT_GETTING_FROM_OSC'),extra:_lang('PROJECT_LOADING_EXTRA')});DataAccess.downloadFromOcs({project:__meta__.projectID},function(data){try{var ocsData=JSON.parse(data);_log('OCS data',ocsData,_log.error);switch(ocsData.status){case'success':Utils.setModalText({main:_lang('PROJECT_LOADING'),extra:_lang('PROJECT_LOADING_EXTRA')});_log('verifyData',verifyData);__meta__.ownerID=verifyData.ownerID;__meta__.login=verifyData.login;_layout.load_project_modal.fadeOut(500);_that.showWorkingAsOnline();_that.projectDownloadedFromOcs({},function(){onResult();$('#topmenu-user-login').html(__meta__.login);},function(){onFault();});break;case'notexists':Utils.setModalText({main:_lang('PROJECTNOT_EXIST'),extra:_lang('PROJECTNOT_EXIST_EXTRA')});break;case'noaccess':Utils.setModalText({main:_lang('YOU_HAVE_NO_ACCESS'),extra:_lang('YOU_HAVE_NO_ACCESS_EXTRA')+' <a target="_blank" href="http://'+__meta__.serverLink+'/auth/login">'+
_lang('YOU_HAVE_NO_ACCESS_EXTRA_2')+'</a> '},true);break;case'ocsbusy':Utils.setModalText({main:_lang('OCS_BUSY'),extra:_lang('OCS_BUSY_EXTRA')},true);break;case'error':Utils.showErrorModal();break;}}catch(err){Utils.setModalText({main:_lang('OCS_BUSY'),extra:_lang('OCS_BUSY_EXTRA')},true);}},function(data){Utils.showErrorModal();});}}else{Utils.setModalText({main:_lang('YOU_HAVE_NO_ACCESS'),extra:_lang('YOU_HAVE_NO_ACCESS_EXTRA')+' <a target="_blank" href="http://'+__meta__.serverLink+'/auth/login">'+
_lang('YOU_HAVE_NO_ACCESS_EXTRA_2')+'</a> '},true);$('#darkanapp').html('');}});this.socket.on('pageFileChanged',function(data){});}
NodeWebservice.prototype.projectDownloadedFromOcs=function(data,onResult,onFault)
{var _that=this;this.socket.emit('projectDownloadedFromOcs',data);this.socket.off('projectDownloadedFromOcs');this.socket.on('projectDownloadedFromOcs',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});}
NodeWebservice.prototype.watchProject=function(data,onResult,onFault)
{var _that=this;this.socket.emit('watchProject',data);this.socket.off('onProjectChanged');this.socket.on('onProjectChanged',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});}
NodeWebservice.prototype.goToHistoryItem=function(data,onResult,onFault)
{var _that=this;this.socket.emit('goToHistoryItem',data);this.socket.off('goToHistoryItem');this.socket.on('goToHistoryItem',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});}
NodeWebservice.prototype.onHistoryChanged=function(data,onResult,onFault)
{var _that=this;this.socket.off('onHistoryChanged');this.socket.on('onHistoryChanged',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});}
NodeWebservice.prototype.getAllProjectsList=function(data,onResult,onFault)
{var _that=this;this.socket.emit('getAllProjectsList',data);this.socket.off('getAllProjectsList');this.socket.on('getAllProjectsList',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});}
NodeWebservice.prototype.getTemplatesProjectsList=function(data,onResult,onFault)
{var _that=this;this.socket.emit('getTemplatesProjectsList',data);this.socket.off('getTemplatesProjectsList');this.socket.on('getTemplatesProjectsList',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});}
NodeWebservice.prototype.loadProjectById=function(data,onResult,onFault)
{var _that=this;this.socket.emit('loadProjectById',data);this.socket.off('loadProjectById');this.socket.on('loadProjectById',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});}
NodeWebservice.prototype.loadProject=function(data,onResult,onFault)
{var _that=this;this.socket.emit('loadProject',data);this.socket.off('loadProject');this.socket.on('loadProject',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});}
NodeWebservice.prototype.createBlankPage=function(params,onResult,onFault,onProgress)
{var _that=this;this.socket.emit('createBlankPage',params);this.socket.off('createBlankPage');this.socket.on('createBlankPage',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});}
NodeWebservice.prototype.updatePage=function(params,onResult,onFault,onProgress)
{var _that=this;this.socket.emit('updatePage',params);this.socket.off('updatePage');this.socket.on('updatePage',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});}
NodeWebservice.prototype.deletePages=function(data,onResult,onFault)
{var _that=this;this.socket.emit('deletePages',data);this.socket.off('deletePages');this.socket.on('deletePages',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});}
NodeWebservice.prototype.deletePage=function(data,onResult,onFault)
{var _that=this;this.socket.emit('deletePage',data);this.socket.off('deletePage');this.socket.on('deletePage',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});}
NodeWebservice.prototype.copyPage=function(data,onResult,onFault)
{var _that=this;this.socket.emit('copyPage',data);this.socket.off('copyPage');this.socket.on('copyPage',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});}
NodeWebservice.prototype.updatePageSort=function(data,onResult,onFault)
{var _that=this;this.socket.emit('updatePageSort',data);this.socket.off('updatePageSort');this.socket.on('updatePageSort',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});}
NodeWebservice.prototype.saveProjectOptions=function(data,onResult,onFault)
{var _that=this;this.socket.emit('saveProjectOptions',data);this.socket.off('saveProjectOptions');this.socket.on('saveProjectOptions',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});}
NodeWebservice.prototype.addComponents=function(data,onResult,onFault)
{var _that=this;this.socket.emit('addComponents',data);this.socket.off('addComponents');this.socket.on('addComponents',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});}
NodeWebservice.prototype.deleteComponents=function(data,onResult,onFault)
{var _that=this;this.socket.emit('deleteComponents',data);this.socket.off('deleteComponents');this.socket.on('deleteComponents',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});}
NodeWebservice.prototype.updateComponents=function(data,onResult,onFault)
{var _that=this;this.socket.emit('updateComponents',data);this.socket.off('updateComponents');this.socket.on('updateComponents',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});}
NodeWebservice.prototype.cutComponents=function(data,onResult,onFault)
{var _that=this;this.socket.emit('cutComponents',data);this.socket.off('cutComponents');this.socket.on('cutComponents',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});}
NodeWebservice.prototype.pasteComponents=function(data,onResult,onFault)
{var _that=this;this.socket.emit('pasteComponents',data);this.socket.off('pasteComponents');this.socket.on('pasteComponents',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});}
NodeWebservice.prototype.duplicateComponents=function(data,onResult,onFault)
{var _that=this;this.socket.emit('duplicateComponents',data);this.socket.off('duplicateComponents');this.socket.on('duplicateComponents',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});}
NodeWebservice.prototype.moveComponentsToLayer=function(data,onResult,onFault)
{var _that=this;this.socket.emit('moveComponentsToLayer',data);this.socket.off('moveComponentsToLayer');this.socket.on('moveComponentsToLayer',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});}
NodeWebservice.prototype.sortRows=function(data,onResult,onFault)
{var _that=this;this.socket.emit('sortRows',data);this.socket.off('sortRows');this.socket.on('sortRows',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});}
NodeWebservice.prototype.duplicatePages=function(data,onResult,onFault)
{var _that=this;this.socket.emit('duplicatePages',data);this.socket.off('duplicatePages');this.socket.on('duplicatePages',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});}
NodeWebservice.prototype.duplicatePagesFromOtherProject=function(data,onResult,onFault)
{var _that=this;this.socket.emit('duplicatePagesFromOtherProject',data);this.socket.off('duplicatePagesFromOtherProject');this.socket.on('duplicatePagesFromOtherProject',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});}
NodeWebservice.prototype.getComponentsListToPaste=function(data,onResult,onFault)
{var _that=this;this.socket.emit('getComponentsListToPaste',data);this.socket.off('getComponentsListToPaste');this.socket.on('getComponentsListToPaste',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});}
NodeWebservice.prototype.updateComponent=function(data,onResult,onFault)
{var _that=this;this.socket.emit('updateComponent',data);this.socket.off('updateComponent');this.socket.on('updateComponent',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});}
NodeWebservice.prototype.updateTimeline=function(data,onResult,onFault)
{var _that=this;this.socket.emit('updateTimeline',data);this.socket.off('updateTimeline');this.socket.on('updateTimeline',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});}
NodeWebservice.prototype.updateTimelineOptions=function(data,onResult,onFault)
{var _that=this;this.socket.emit('updateTimelineOptions',data);this.socket.off('updateTimelineOptions');this.socket.on('updateTimelineOptions',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});}
NodeWebservice.prototype.updatePageOptions=function(data,onResult,onFault)
{var _that=this;this.socket.emit('updatePageOptions',data);this.socket.off('updatePageOptions');this.socket.on('updatePageOptions',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});}
NodeWebservice.prototype.updatePagesOptions=function(data,onResult,onFault)
{var _that=this;this.socket.emit('updatePagesOptions',data);this.socket.off('updatePagesOptions');this.socket.on('updatePagesOptions',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});}
NodeWebservice.prototype.onMessageBack=function(responce,onResult,onFault)
{if(responce.error==undefined){onResult(responce);}else{onFault(responce);}}
NodeWebservice.prototype.sendAndLoad=function(settings,onResult,onFault)
{this.serverSocket.sendMessage(settings,onResult,onFault);}
NodeWebservice.prototype.uploadImage=function(data,onResult,onFault,onComplete,onProgress)
{var _that=this;var actionkey=data.actionkey;this.socket.off('uploadImageComplete'+actionkey);this.socket.on('uploadImageComplete'+actionkey,function(responseData){_that.socket.off('uploadImageComplete'+responseData.actionkey);_that.socket.off('uploadImageProgress'+responseData.actionkey);onComplete(responseData);});this.socket.off('uploadImageProgress'+actionkey);this.socket.on('uploadImageProgress'+actionkey,function(responseData){onProgress(responseData);});this.socket.off('uploadImage'+actionkey);this.socket.on('uploadImage'+actionkey,function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('uploadImage',data);}
NodeWebservice.prototype.uploadAudio=function(data,onResult,onFault,onComplete,onProgress)
{var _that=this;var actionkey=data.actionkey;this.socket.off('uploadAudioComplete'+actionkey);this.socket.on('uploadAudioComplete'+actionkey,function(responseData){_that.socket.off('uploadAudioComplete'+responseData.actionkey);_that.socket.off('uploadAudioProgress'+responseData.actionkey);onComplete(responseData);});this.socket.off('uploadAudioProgress'+actionkey);this.socket.on('uploadAudioProgress'+actionkey,function(responseData){onProgress(responseData);});this.socket.off('uploadAudio'+actionkey);this.socket.on('uploadAudio'+actionkey,function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('uploadAudio',data);}
NodeWebservice.prototype.uploadVideo=function(data,onResult,onFault,onComplete,onProgress)
{var _that=this;var actionkey=data.actionkey;this.socket.off('uploadVideoComplete'+actionkey);this.socket.on('uploadVideoComplete'+actionkey,function(responseData){_that.socket.off('uploadVideoComplete'+responseData.actionkey);_that.socket.off('uploadVideoProgress'+responseData.actionkey);onComplete(responseData);});this.socket.off('uploadVideoProgress'+actionkey);this.socket.on('uploadVideoProgress'+actionkey,function(responseData){onProgress(responseData);});this.socket.off('uploadVideo'+actionkey);this.socket.on('uploadVideo'+actionkey,function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('uploadVideo',data);}
NodeWebservice.prototype.uploadSwf=function(data,onResult,onFault,onComplete,onProgress)
{var _that=this;var actionkey=data.actionkey;this.socket.off('uploadSwfComplete'+actionkey);this.socket.on('uploadSwfComplete'+actionkey,function(responseData){_that.socket.off('uploadSwfComplete'+responseData.actionkey);_that.socket.off('uploadSwfProgress'+responseData.actionkey);onComplete(responseData);});this.socket.off('uploadSwfProgress'+actionkey);this.socket.on('uploadSwfProgress'+actionkey,function(responseData){onProgress(responseData);});this.socket.off('uploadSwf'+actionkey);this.socket.on('uploadSwf'+actionkey,function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('uploadSwf',data);}
NodeWebservice.prototype.uploadFile=function(data,onResult,onFault,onComplete,onProgress)
{var _that=this;var actionkey=data.actionkey;this.socket.off('uploadFileComplete'+actionkey);this.socket.on('uploadFileComplete'+actionkey,function(responseData){_that.socket.off('uploadFileComplete'+responseData.actionkey);_that.socket.off('uploadFileProgress'+responseData.actionkey);onComplete(responseData);});this.socket.off('uploadFileProgress'+actionkey);this.socket.on('uploadFileProgress'+actionkey,function(responseData){onProgress(responseData);});this.socket.off('uploadFile'+actionkey);this.socket.on('uploadFile'+actionkey,function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('uploadFile',data);}
NodeWebservice.prototype.uploadSounds=function(data,onResult,onFault,onComplete,onProgress)
{var _that=this;var actionkey=data.actionkey;this.socket.off('uploadSoundsComplete'+actionkey);this.socket.on('uploadSoundsComplete'+actionkey,function(responseData){_that.socket.off('uploadSoundsComplete'+responseData.actionkey);_that.socket.off('uploadSoundsProgress'+responseData.actionkey);onComplete(responseData);});this.socket.off('uploadSoundsProgress'+actionkey);this.socket.on('uploadSoundsProgress'+actionkey,function(responseData){onProgress(responseData);});this.socket.off('uploadSounds'+actionkey);this.socket.on('uploadSounds'+actionkey,function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('uploadSounds',data);}
NodeWebservice.prototype.uploadGallery=function(data,onResult,onFault,onComplete,onProgress)
{var _that=this;var actionkey=data.actionkey;this.socket.off('uploadGalleryComplete'+actionkey);this.socket.on('uploadGalleryComplete'+actionkey,function(responseData){_that.socket.off('uploadGalleryComplete'+responseData.actionkey);_that.socket.off('uploadGalleryProgress'+responseData.actionkey);onComplete(responseData);});this.socket.off('uploadGalleryProgress'+actionkey);this.socket.on('uploadGalleryProgress'+actionkey,function(responseData){onProgress(responseData);});this.socket.off('uploadGallery'+actionkey);this.socket.on('uploadGallery'+actionkey,function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('uploadGallery',data);}
NodeWebservice.prototype.uploadPageSound=function(data,onResult,onFault,onComplete,onProgress)
{var _that=this;var actionkey=data.actionkey;this.socket.off('uploadPageSoundComplete'+actionkey);this.socket.on('uploadPageSoundComplete'+actionkey,function(responseData){_that.socket.off('uploadPageSoundComplete'+responseData.actionkey);_that.socket.off('uploadPageSoundProgress'+responseData.actionkey);onComplete(responseData);});this.socket.off('uploadPageSoundProgress'+actionkey);this.socket.on('uploadPageSoundProgress'+actionkey,function(responseData){onProgress(responseData);});this.socket.off('uploadPageSound'+actionkey);this.socket.on('uploadPageSound'+actionkey,function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('uploadPageSound',data);}
NodeWebservice.prototype.uploadProjectSound=function(data,onResult,onFault,onComplete,onProgress)
{var _that=this;var actionkey=data.actionkey;this.socket.off('uploadProjectSoundComplete'+actionkey);this.socket.on('uploadProjectSoundComplete'+actionkey,function(responseData){_that.socket.off('uploadProjectSoundComplete'+responseData.actionkey);_that.socket.off('uploadProjectSoundProgress'+responseData.actionkey);onComplete(responseData);});this.socket.off('uploadProjectSoundProgress'+actionkey);this.socket.on('uploadProjectSoundProgress'+actionkey,function(responseData){onProgress(responseData);});this.socket.off('uploadProjectSound'+actionkey);this.socket.on('uploadProjectSound'+actionkey,function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('uploadProjectSound',data);}
NodeWebservice.prototype.uploadPageImage=function(data,onResult,onFault,onComplete,onProgress)
{var _that=this;var actionkey=data.actionkey;this.socket.off('uploadPageImageComplete'+actionkey);this.socket.on('uploadPageImageComplete'+actionkey,function(responseData){_that.socket.off('uploadPageImageComplete'+responseData.actionkey);_that.socket.off('uploadPageImageProgress'+responseData.actionkey);onComplete(responseData);});this.socket.off('uploadPageImageProgress'+actionkey);this.socket.on('uploadPageImageProgress'+actionkey,function(responseData){onProgress(responseData);});this.socket.off('uploadPageImage'+actionkey);this.socket.on('uploadPageImage'+actionkey,function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('uploadPageImage',data);}
NodeWebservice.prototype.uploadImportPdf=function(data,onResult,onFault,onComplete,onProgress)
{var _that=this;var actionkey=data.actionkey;this.socket.off('uploadImportPdfComplete'+actionkey);this.socket.on('uploadImportPdfComplete'+actionkey,function(responseData){_that.socket.off('uploadImportPdfComplete'+responseData.actionkey);_that.socket.off('uploadImportPdfProgress'+responseData.actionkey);onComplete(responseData);});this.socket.off('uploadImportPdfProgress'+actionkey);this.socket.on('uploadImportPdfProgress'+actionkey,function(responseData){onProgress(responseData);});this.socket.off('uploadImportPdf'+actionkey);this.socket.on('uploadImportPdf'+actionkey,function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('uploadImportPdf',data);}
NodeWebservice.prototype.uploadImportPsd=function(data,onResult,onFault,onComplete,onProgress)
{var _that=this;var actionkey=data.actionkey;this.socket.off('uploadImportPsdComplete'+actionkey);this.socket.on('uploadImportPsdComplete'+actionkey,function(responseData){_that.socket.off('uploadImportPsdComplete'+responseData.actionkey);_that.socket.off('uploadImportPsdProgress'+responseData.actionkey);onComplete(responseData);});this.socket.off('uploadImportPsdProgress'+actionkey);this.socket.on('uploadImportPsdProgress'+actionkey,function(responseData){onProgress(responseData);});this.socket.off('uploadImportPsd'+actionkey);this.socket.on('uploadImportPsd'+actionkey,function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('uploadImportPsd',data);}
NodeWebservice.prototype.uploadImportImage=function(data,onResult,onFault,onComplete,onProgress)
{var _that=this;var actionkey=data.actionkey;this.socket.off('uploadImportImageComplete'+actionkey);this.socket.on('uploadImportImageComplete'+actionkey,function(responseData){_that.socket.off('uploadImportImageComplete'+responseData.actionkey);_that.socket.off('uploadImportImageProgress'+responseData.actionkey);onComplete(responseData);});this.socket.off('uploadImportImageProgress'+actionkey);this.socket.on('uploadImportImageProgress'+actionkey,function(responseData){onProgress(responseData);});this.socket.off('uploadImportImage'+actionkey);this.socket.on('uploadImportImage'+actionkey,function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('uploadImportImage',data);}
NodeWebservice.prototype.uploadPublishIcon=function(data,onResult,onFault,onComplete,onProgress)
{var _that=this;var actionkey=data.actionkey;this.socket.off('uploadPublishIconComplete'+actionkey);this.socket.on('uploadPublishIconComplete'+actionkey,function(responseData){_that.socket.off('uploadPublishIconComplete'+responseData.actionkey);_that.socket.off('uploadPublishIconProgress'+responseData.actionkey);onComplete(responseData);});this.socket.off('uploadPublishIconProgress'+actionkey);this.socket.on('uploadPublishIconProgress'+actionkey,function(responseData){onProgress(responseData);});this.socket.off('uploadPublishIcon'+actionkey);this.socket.on('uploadPublishIcon'+actionkey,function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('uploadPublishIcon',data);}
NodeWebservice.prototype.uploadPublishBannerIcon=function(data,onResult,onFault,onComplete,onProgress)
{var _that=this;var actionkey=data.actionkey;this.socket.off('uploadPublishBannerIconComplete'+actionkey);this.socket.on('uploadPublishBannerIconComplete'+actionkey,function(responseData){_that.socket.off('uploadPublishBannerIconComplete'+responseData.actionkey);_that.socket.off('uploadPublishBannerIconProgress'+responseData.actionkey);onComplete(responseData);});this.socket.off('uploadPublishBannerIconProgress'+actionkey);this.socket.on('uploadPublishBannerIconProgress'+actionkey,function(responseData){onProgress(responseData);});this.socket.off('uploadPublishBannerIcon'+actionkey);this.socket.on('uploadPublishBannerIcon'+actionkey,function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('uploadPublishBannerIcon',data);}
NodeWebservice.prototype.uploadAudioProgress=function(actionkey,data)
{this.socket.emit('uploadAudioProgress',data);}
NodeWebservice.prototype.uploadImageProgress=function(actionkey,data)
{this.socket.emit('uploadImageProgress',data);}
NodeWebservice.prototype.uploadVideoProgress=function(actionkey,data)
{this.socket.emit('uploadVideoProgress',data);}
NodeWebservice.prototype.uploadSwfProgress=function(actionkey,data)
{this.socket.emit('uploadSwfProgress',data);}
NodeWebservice.prototype.uploadFileProgress=function(actionkey,data)
{this.socket.emit('uploadFileProgress',data);}
NodeWebservice.prototype.uploadSoundsProgress=function(actionkey,data)
{this.socket.emit('uploadSoundsProgress',data);}
NodeWebservice.prototype.uploadGalleryProgress=function(actionkey,data)
{this.socket.emit('uploadGalleryProgress',data);}
NodeWebservice.prototype.uploadPageSoundProgress=function(actionkey,data)
{this.socket.emit('uploadPageSoundProgress',data);}
NodeWebservice.prototype.uploadProjectSoundProgress=function(actionkey,data)
{this.socket.emit('uploadProjectSoundProgress',data);}
NodeWebservice.prototype.uploadPageImageProgress=function(actionkey,data)
{this.socket.emit('uploadPageImageProgress',data);}
NodeWebservice.prototype.uploadImportPdfProgress=function(actionkey,data)
{this.socket.emit('uploadImportPdfProgress',data);}
NodeWebservice.prototype.uploadImportPsdProgress=function(actionkey,data)
{this.socket.emit('uploadImportPsdProgress',data);}
NodeWebservice.prototype.uploadImportImageProgress=function(actionkey,data)
{this.socket.emit('uploadImportImageProgress',data);}
NodeWebservice.prototype.uploadPublishIconProgress=function(actionkey,data)
{this.socket.emit('uploadPublishIconProgress',data);}
NodeWebservice.prototype.uploadPublishBannerIconProgress=function(actionkey,data)
{this.socket.emit('uploadPublishIconProgress',data);}
NodeWebservice.prototype.clearProject=function(data,onResult,onFault)
{var _that=this;this.socket.off('clearProject');this.socket.on('clearProject',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('clearProject',data);}
NodeWebservice.prototype.preparePreview=function(data,onResult,onFault,onProgress)
{var _that=this;this.socket.off('preparePreview');this.socket.on('preparePreview',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.off('preparePreviewProgress');this.socket.on('preparePreviewProgress',function(responseData){if(onProgress){onProgress(responseData);}});this.socket.emit('preparePreview',data);}
NodeWebservice.prototype.createPageThumb=function(data,onResult,onFault)
{var _that=this;this.socket.off('pageThumbCreated');this.socket.on('pageThumbCreated',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('createPageThumb',data);}
NodeWebservice.prototype.copyComponents=function(data,onResult,onFault)
{var _that=this;this.socket.off('copyComponents');this.socket.on('copyComponents',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('copyComponents',data);}
NodeWebservice.prototype.copyComponentsFromOtherProject=function(data,onResult,onFault)
{var _that=this;this.socket.off('copyComponentsFromOtherProject');this.socket.on('copyComponentsFromOtherProject',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('copyComponentsFromOtherProject',data);}
NodeWebservice.prototype.deleteSharedUser=function(data,onResult,onFault)
{var _that=this;this.socket.off('deleteSharedUser');this.socket.on('deleteSharedUser',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('deleteSharedUser',data);}
NodeWebservice.prototype.shareProjectToUser=function(data,onResult,onFault)
{var _that=this;this.socket.off('shareProjectToUser');this.socket.on('shareProjectToUser',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('shareProjectToUser',data);}
NodeWebservice.prototype.shareProjectToNoExistsUser=function(data,onResult,onFault)
{var _that=this;this.socket.off('shareProjectToNoExistsUser');this.socket.on('shareProjectToNoExistsUser',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('shareProjectToNoExistsUser',data);}
NodeWebservice.prototype.getSharedUsers=function(data,onResult,onFault)
{var _that=this;this.socket.off('getSharedUsers');this.socket.on('getSharedUsers',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('getSharedUsers',data);}
NodeWebservice.prototype.changeLanguage=function(data,onResult,onFault)
{var _that=this;this.socket.off('changeLanguage');this.socket.on('changeLanguage',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('changeLanguage',data);}
NodeWebservice.prototype.createPdfImageList=function(data,onResult,onFault,onComplete,onProgress)
{var _that=this;this.socket.off('createPdfImageListComplete');this.socket.on('createPdfImageListComplete',function(responseData){_that.socket.off('createPdfImageListComplete');_that.socket.off('createPdfImageListProgress');onComplete(responseData);});this.socket.off('createPdfImageListProgress');this.socket.on('createPdfImageListProgress',function(responseData){onProgress(responseData);});this.socket.off('createPdfImageList');this.socket.on('createPdfImageList',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('createPdfImageList',data);}
NodeWebservice.prototype.stopCreatePdfImageList=function(data,onResult,onFault)
{var _that=this;this.socket.off('stopCreatePdfImageList');this.socket.on('stopCreatePdfImageList',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('stopCreatePdfImageList',data);}
NodeWebservice.prototype.convertPdfPageToImage=function(data,onResult,onFault)
{var _that=this;this.socket.off('convertPdfPageToImage');this.socket.on('convertPdfPageToImage',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('convertPdfPageToImage',data);}
NodeWebservice.prototype.copyLibraryFileToImage=function(data,onResult,onFault)
{var _that=this;this.socket.off('copyLibraryFileToImage');this.socket.on('copyLibraryFileToImage',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('copyLibraryFileToImage',data);}
NodeWebservice.prototype.getPublishedData=function(data,onResult,onFault)
{var _that=this;this.socket.off('getPublishedData');this.socket.on('getPublishedData',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('getPublishedData',data);}
NodeWebservice.prototype.newPublication=function(data,onResult,onFault)
{var _that=this;this.socket.off('newPublication');this.socket.on('newPublication',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('newPublication',data);}
NodeWebservice.prototype.overridePublication=function(data,onResult,onFault)
{var _that=this;this.socket.off('overridePublication');this.socket.on('overridePublication',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('overridePublication',data);}
NodeWebservice.prototype.setPublicationOptions=function(data,onResult,onFault)
{var _that=this;this.socket.off('setPublicationOptions');this.socket.on('setPublicationOptions',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('setPublicationOptions',data);}
NodeWebservice.prototype.changeStageBackgroundLibrary=function(data,onResult,onFault)
{var _that=this;this.socket.off('changeStageBackgroundLibrary');this.socket.on('changeStageBackgroundLibrary',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('changeStageBackgroundLibrary',data);}
NodeWebservice.prototype.cropImage=function(data,onResult,onFault)
{var _that=this;this.socket.off('cropImage');this.socket.on('cropImage',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('cropImage',data);}
NodeWebservice.prototype.resizeImage=function(data,onResult,onFault)
{var _that=this;this.socket.off('resizeImage');this.socket.on('resizeImage',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('resizeImage',data);}
NodeWebservice.prototype.getImageSize=function(data,onResult,onFault)
{var _that=this;this.socket.off('getImageSize');this.socket.on('getImageSize',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('getImageSize',data);}
NodeWebservice.prototype.convertLinkToImage=function(data,onResult,onFault)
{var _that=this;this.socket.off('convertLinkToImage');this.socket.on('convertLinkToImage',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('convertLinkToImage',data);}
NodeWebservice.prototype.saveHistory=function(data,onResult,onFault)
{var _that=this;this.socket.off('saveHistory');this.socket.on('saveHistory',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('saveHistory',data);}
NodeWebservice.prototype.calculateProjectSize=function(data,onResult,onFault)
{var _that=this;this.socket.off('calculateProjectSize');this.socket.on('calculateProjectSize',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('calculateProjectSize',data);}
NodeWebservice.prototype.createPsdPage=function(data,onResult,onFault,onComplete,onProgress)
{var _that=this;this.socket.off('createPsdPageComplete');this.socket.on('createPsdPageComplete',function(responseData){_that.socket.off('createPsdPageComplete');_that.socket.off('createPsdPageProgress');onComplete(responseData);});this.socket.off('createPsdPageProgress');this.socket.on('createPsdPageProgress',function(responseData){onProgress(responseData);});this.socket.off('createPsdPage');this.socket.on('createPsdPage',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});}
NodeWebservice.prototype.submitTestDriveEmail=function(data,onResult,onFault)
{var _that=this;this.socket.off('submitTestDriveEmail');this.socket.on('submitTestDriveEmail',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('submitTestDriveEmail',data);}
NodeWebservice.prototype.getServerDate=function(data,onResult,onFault)
{var _that=this;this.socket.off('getServerDate');this.socket.on('getServerDate',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('getServerDate',data);}
NodeWebservice.prototype.getCapabilities=function(data,onResult,onFault)
{var _that=this;this.socket.off('getCapabilities');this.socket.on('getCapabilities',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('getCapabilities',data);}
NodeWebservice.prototype.loginExternal=function(data,onResult,onFault)
{this.joinToRoom();}
NodeWebservice.prototype.selectPageByUser=function(data,onResult,onFault)
{this.socket.emit('selectPageByUser',data);}
NodeWebservice.prototype.onSelectPageByUser=function(data,onResult,onFault)
{var _that=this;this.socket.off('onSelectPageByUser');this.socket.on('onSelectPageByUser',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});}
NodeWebservice.prototype.selectComponentsByUser=function(data,onResult,onFault)
{this.socket.emit('selectComponentsByUser',data);}
NodeWebservice.prototype.onSelectComponentsByUser=function(data,onResult,onFault)
{var _that=this;this.socket.off('onSelectComponentsByUser');this.socket.on('onSelectComponentsByUser',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});}
NodeWebservice.prototype.setProjectPermissions=function(data,onResult,onFault)
{var _that=this;this.socket.off('setProjectPermissions');this.socket.on('setProjectPermissions',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('setProjectPermissions',data);}
NodeWebservice.prototype.getFoldersStructure=function(data,onResult,onFault)
{var _that=this;this.socket.off('getFoldersStructure');this.socket.on('getFoldersStructure',function(responseData){_that.onMessageBack(responseData,onResult,onFault);});this.socket.emit('getFoldersStructure',data);};;var ServerSocket=function(address){var that=this;this.address=address;this.socket=new WebSocket(address);this.receivedData={};this.socket.onopen=function(){console.log('connected');};}
ServerSocket.prototype.sendMessage=function(data,onResult,onFault){this.socket.onmessage=function(responseData){try{var responce=JSON.parse(responseData.data);console.log("responseData "+responce);if(responce.error==undefined){onResult(responce);}else{onFault(responce);}}catch(ex){onFault(JSON.stringify({responce:{error:"Parse Json error"},ex:ex}));}};this.socket.send(JSON.stringify(data));};;var ServerSocketIo=function(address){var that=this;this.socket=io.connect(address);}
ServerSocketIo.prototype.sendMessage=function(data,onResult,onFault){this.socket.on('message',function(responseData){if(responseData.message){console.log("responseData ");console.log(responseData);try{var responce=JSON.parse(responseData.message.data);console.log("responseData "+responce);if(responce.error==undefined){onResult(responce);}else{onFault(responce);}}catch(ex){onFault(JSON.stringify({responce:{error:"Parse Json error"},ex:ex}));}}else{console.log("There is a problem:",responseData);}});this.socket.emit(data.fn,{message:data});};;function PhpWebservice(){}
PhpWebservice.prototype=new WebService();PhpWebservice.prototype.searchImages=function(data,onResult,onFault){this.sendAndLoad(__meta__.APP_LINK+'searchimages',data,onResult,onFault);};PhpWebservice.prototype.searchYoutube=function(data,onResult,onFault){this.sendAndLoad(__meta__.app_folder+'Modules/Editor/Youtube/searchyoutube.php',data,onResult,onFault);};PhpWebservice.prototype.searchVimeo=function(data,onResult,onFault){this.sendAndLoad(__meta__.app_folder+'Modules/Editor/Vimeo/searchvimeo.php',data,onResult,onFault);};PhpWebservice.prototype.libraryRequest=function(data,onResult,onFault){this.sendAndLoad(__meta__.APP_LINK+'darkanlibrary',data,onResult,onFault);};PhpWebservice.prototype.projectVersioinRequest=function(data,onResult,onFault){this.sendAndLoad(__meta__.APP_LINK+'projectversion',data,onResult,onFault);};PhpWebservice.prototype.publicationRequest=function(data,onResult,onFault){this.sendAndLoad(__meta__.APP_LINK+'publication',data,onResult,onFault);};PhpWebservice.prototype.sendMails=function(data,onResult,onFault){this.sendAndLoad(__meta__.APP_LINK+'mailings',data,onResult,onFault);};PhpWebservice.prototype.keepSession=function(data,onResult,onFault){this.sendAndLoad(__meta__.APP_LINK+'keepsession',data,onResult,onFault);};PhpWebservice.prototype.changeLanguage=function(data,onResult,onFault){this.sendAndLoad(__meta__.APP_LINK+'changelang/'+data.lang,data,onResult,onFault);};PhpWebservice.prototype.loadProjectById=function(data,onResult,onFault){var projectData={project:data.projectId};this.sendAndLoad(__meta__.APP_LINK+'downloadFromOcs',projectData,onResult,onFault,false);};PhpWebservice.prototype.downloadFromOcs=function(data,onResult,onFault){this.sendAndLoad(__meta__.APP_LINK+'downloadFromOcs',data,onResult,onFault,false);};PhpWebservice.prototype.shareProjectToUser=function(data,onResult,onFault){this.sendAndLoad(__meta__.APP_LINK+'shareproject',data,onResult,onFault,false);};PhpWebservice.prototype.loginExternal=function(data,onResult,onFault){var request={request:1,data:data,__meta__:__meta__};this.sendAndLoad(__meta__.APP_LINK+'login/login_external',{request:JSON.stringify(request)},onResult,onFault,true);};PhpWebservice.prototype.editPhotopeaImage=function(data,onResult,onFault){this.sendAndLoad(__meta__.APP_LINK+'photopea',data,onResult,onFault);};PhpWebservice.prototype.sendAndLoad=function(url,settings,onResult,onFault,async)
{var async=async||true;$.ajax({type:'POST',url:url,cache:false,dataType:'text',data:settings,async:async,success:function(data)
{onResult(data);},error:function()
{onFault();}});};;function FakeWebservice(){}
FakeWebservice.prototype=new WebService();FakeWebservice.prototype.createBlankPage=function(params,onResult,onFault,onProgress)
{this.sendAndLoad();}
FakeWebservice.prototype.saveFileOnServer=function(params,onResult,onFault,onProgress)
{console.log('Save file on server');}
FakeWebservice.prototype.sendAndLoad=function(url,settings,onResult,onFault)
{console.log('Fake webservice send');};;function DataAccess(){}
DataAccess.connect=function(data,onResult,onFault)
{_log("connect",data,_log.dataaccessIn);this.nodeWebService=WebService.create('node');this.phpWebService=WebService.create('php');this.nodeWebService.connect(data,onResult,onFault);}
DataAccess.watchProject=function(data,onResult,onFault)
{_log("watchProject",data,_log.dataaccessIn);this.nodeWebService.watchProject(data,onResult,onFault);}
DataAccess.onHistoryChanged=function(data,onResult,onFault)
{_log("onHistoryChanged",data,_log.dataaccessIn);this.nodeWebService.onHistoryChanged(data,onResult,onFault);}
DataAccess.getAllProjectsList=function(data,onResult,onFault)
{_log("getAllProjectsList",data,_log.dataaccessIn);this.nodeWebService.getAllProjectsList(data,onResult,onFault);}
DataAccess.getTemplatesProjectsList=function(data,onResult,onFault)
{_log("getTemplatesProjectsList",data,_log.dataaccessIn);this.nodeWebService.getTemplatesProjectsList(data,onResult,onFault);}
DataAccess.loadProjectById=function(data,onResult,onFault)
{var _that=this;this.phpWebService.loadProjectById(data,function(){_that.nodeWebService.loadProjectById(data,onResult,onFault);},onFault);}
DataAccess.loadProject=function(data,onResult,onFault)
{_log("loadProject",data,_log.dataaccessIn);this.nodeWebService.loadProject(data,onResult,onFault);}
DataAccess.createBlankPage=function(data,onResult,onFault)
{_log("createBlankPage",data,_log.dataaccessIn);this.nodeWebService.createBlankPage(data,onResult,onFault);}
DataAccess.updatePage=function(data,onResult,onFault)
{_log("updatePage",data,_log.dataaccessIn);this.nodeWebService.updatePage(data,onResult,onFault);}
DataAccess.deletePages=function(data,onResult,onFault)
{_log("deletePages",data,_log.dataaccessIn);this.nodeWebService.deletePages(data,onResult,onFault);}
DataAccess.deletePage=function(data,onResult,onFault)
{_log("deletePage",data,_log.dataaccessIn);this.nodeWebService.deletePage(data,onResult,onFault);}
DataAccess.copyPage=function(data,onResult,onFault)
{_log("copyPage",data,_log.dataaccessIn);this.nodeWebService.copyPage(data,onResult,onFault);}
DataAccess.updatePageSort=function(data,onResult,onFault)
{_log("updatePageSort",data,_log.dataaccessIn);this.nodeWebService.updatePageSort(data,onResult,onFault);}
DataAccess.saveProjectOptions=function(data,onResult,onFault)
{_log("saveProjectOptions",data,_log.dataaccessIn);this.nodeWebService.saveProjectOptions(data,onResult,onFault);}
DataAccess.addComponents=function(data,onResult,onFault)
{_log("addComponents",data,_log.dataaccessIn);this.nodeWebService.addComponents(data,onResult,onFault);}
DataAccess.deleteComponents=function(data,onResult,onFault)
{_log("deleteComponents",data,_log.dataaccessIn);this.nodeWebService.deleteComponents(data,onResult,onFault);}
DataAccess.updateComponents=function(data,onResult,onFault)
{_log("updateComponents",data,_log.dataaccessIn);this.nodeWebService.updateComponents(data,onResult,onFault);}
DataAccess.cutComponents=function(data,onResult,onFault)
{_log("cutComponents",data,_log.dataaccessIn);this.nodeWebService.cutComponents(data,onResult,onFault);}
DataAccess.pasteComponents=function(data,onResult,onFault)
{_log("pasteComponents",data,_log.dataaccessIn);this.nodeWebService.pasteComponents(data,onResult,onFault);}
DataAccess.duplicateComponents=function(data,onResult,onFault)
{_log("duplicateComponents",data,_log.dataaccessIn);this.nodeWebService.duplicateComponents(data,onResult,onFault);}
DataAccess.moveComponentsToLayer=function(data,onResult,onFault)
{_log("moveComponentsToLayer",data,_log.dataaccessIn);this.nodeWebService.moveComponentsToLayer(data,onResult,onFault);}
DataAccess.sortRows=function(data,onResult,onFault)
{_log("sortRows",data,_log.dataaccessIn);this.nodeWebService.sortRows(data,onResult,onFault);}
DataAccess.duplicatePages=function(data,onResult,onFault)
{_log("duplicatePages",data,_log.dataaccessIn);this.nodeWebService.duplicatePages(data,onResult,onFault);}
DataAccess.duplicatePagesFromOtherProject=function(data,onResult,onFault)
{_log("duplicatePagesFromOtherProject",data,_log.dataaccessIn);this.nodeWebService.duplicatePagesFromOtherProject(data,onResult,onFault);}
DataAccess.getComponentsListToPaste=function(data,onResult,onFault)
{_log("getComponentsListToPaste",data,_log.dataaccessIn);this.nodeWebService.getComponentsListToPaste(data,onResult,onFault);}
DataAccess.updateTimeline=function(data,onResult,onFault)
{_log("updateTimeline",data,_log.dataaccessIn);this.nodeWebService.updateTimeline(data,onResult,onFault);}
DataAccess.updateTimelineOptions=function(data,onResult,onFault)
{_log("updateTimelineOptions",data,_log.dataaccessIn);this.nodeWebService.updateTimelineOptions(data,onResult,onFault);}
DataAccess.uploadImage=function(data,onResult,onFault,onComplete,onProgress)
{return this.nodeWebService.uploadImage(data,onResult,onFault,onComplete,onProgress);}
DataAccess.uploadAudio=function(data,onResult,onFault,onComplete,onProgress)
{return this.nodeWebService.uploadAudio(data,onResult,onFault,onComplete,onProgress);}
DataAccess.uploadVideo=function(data,onResult,onFault,onComplete,onProgress)
{return this.nodeWebService.uploadVideo(data,onResult,onFault,onComplete,onProgress);}
DataAccess.uploadSwf=function(data,onResult,onFault,onComplete,onProgress)
{return this.nodeWebService.uploadSwf(data,onResult,onFault,onComplete,onProgress);}
DataAccess.uploadFile=function(data,onResult,onFault,onComplete,onProgress)
{return this.nodeWebService.uploadFile(data,onResult,onFault,onComplete,onProgress);}
DataAccess.uploadSounds=function(data,onResult,onFault,onComplete,onProgress)
{return this.nodeWebService.uploadSounds(data,onResult,onFault,onComplete,onProgress);}
DataAccess.uploadGallery=function(data,onResult,onFault,onComplete,onProgress)
{return this.nodeWebService.uploadGallery(data,onResult,onFault,onComplete,onProgress);}
DataAccess.uploadPageSound=function(data,onResult,onFault,onComplete,onProgress)
{return this.nodeWebService.uploadPageSound(data,onResult,onFault,onComplete,onProgress);}
DataAccess.uploadProjectSound=function(data,onResult,onFault,onComplete,onProgress)
{return this.nodeWebService.uploadProjectSound(data,onResult,onFault,onComplete,onProgress);}
DataAccess.uploadProjectSoundProgress=function(data,onResult,onFault,onComplete,onProgress)
{return this.nodeWebService.uploadProjectSoundProgress(data,onResult,onFault,onComplete,onProgress);}
DataAccess.uploadPageImage=function(data,onResult,onFault,onComplete,onProgress)
{return this.nodeWebService.uploadPageImage(data,onResult,onFault,onComplete,onProgress);}
DataAccess.uploadPublishIcon=function(data,onResult,onFault,onComplete,onProgress)
{return this.nodeWebService.uploadPublishIcon(data,onResult,onFault,onComplete,onProgress);}
DataAccess.uploadPublishBannerIcon=function(data,onResult,onFault,onComplete,onProgress)
{return this.nodeWebService.uploadPublishBannerIcon(data,onResult,onFault,onComplete,onProgress);}
DataAccess.uploadAudioProgress=function(actionkey,data)
{this.nodeWebService.uploadAudioProgress(actionkey,data);}
DataAccess.uploadImageProgress=function(actionkey,data)
{this.nodeWebService.uploadImageProgress(actionkey,data);}
DataAccess.uploadVideoProgress=function(actionkey,data)
{this.nodeWebService.uploadVideoProgress(actionkey,data);}
DataAccess.uploadSwfProgress=function(actionkey,data)
{this.nodeWebService.uploadSwfProgress(actionkey,data);}
DataAccess.uploadFileProgress=function(actionkey,data)
{this.nodeWebService.uploadFileProgress(actionkey,data);}
DataAccess.uploadSoundsProgress=function(actionkey,data)
{this.nodeWebService.uploadSoundsProgress(actionkey,data);}
DataAccess.uploadGalleryProgress=function(actionkey,data)
{this.nodeWebService.uploadGalleryProgress(actionkey,data);}
DataAccess.uploadPageSoundProgress=function(actionkey,data)
{this.nodeWebService.uploadPageSoundProgress(actionkey,data);}
DataAccess.uploadPageImageProgress=function(actionkey,data)
{this.nodeWebService.uploadPageImageProgress(actionkey,data);}
DataAccess.uploadImportImageProgress=function(actionkey,data)
{this.nodeWebService.uploadImportImageProgress(actionkey,data);}
DataAccess.uploadImportPdfProgress=function(actionkey,data)
{this.nodeWebService.uploadImportPdfProgress(actionkey,data);}
DataAccess.uploadImportPsdProgress=function(actionkey,data)
{this.nodeWebService.uploadImportPsdProgress(actionkey,data);}
DataAccess.uploadImportImage=function(data,onResult,onFault,onComplete,onProgress)
{return this.nodeWebService.uploadImportImage(data,onResult,onFault,onComplete,onProgress);}
DataAccess.uploadImportPdf=function(data,onResult,onFault,onComplete,onProgress)
{return this.nodeWebService.uploadImportPdf(data,onResult,onFault,onComplete,onProgress);}
DataAccess.uploadImportPsd=function(data,onResult,onFault,onComplete,onProgress)
{return this.nodeWebService.uploadImportPsd(data,onResult,onFault,onComplete,onProgress);}
DataAccess.uploadPublishIconProgress=function(data,onResult,onFault,onComplete,onProgress)
{return this.nodeWebService.uploadPublishIconProgress(data,onResult,onFault,onComplete,onProgress);}
DataAccess.uploadPublishBannerIconProgress=function(data,onResult,onFault,onComplete,onProgress)
{return this.nodeWebService.uploadPublishBannerIconProgress(data,onResult,onFault,onComplete,onProgress);}
DataAccess.updatePageOptions=function(data,onResult,onFault)
{this.nodeWebService.updatePageOptions(data,onResult,onFault);}
DataAccess.updatePagesOptions=function(data,onResult,onFault)
{_log("updatePagesOptions",data,_log.dataaccessIn);this.nodeWebService.updatePagesOptions(data,onResult,onFault);}
DataAccess.clearProject=function(data,onResult,onFault)
{this.nodeWebService.clearProject(data,onResult,onFault);}
DataAccess.preparePreview=function(data,onResult,onFault,onProggres)
{this.nodeWebService.preparePreview(data,onResult,onFault,onProggres);}
DataAccess.createPageThumb=function(data,onResult,onFault)
{this.nodeWebService.createPageThumb(data,onResult,onFault);}
DataAccess.copyComponents=function(data,onResult,onFault)
{_log("copyComponents",data,_log.dataaccessIn);this.nodeWebService.copyComponents(data,onResult,onFault);}
DataAccess.copyComponentsFromOtherProject=function(data,onResult,onFault)
{_log("copyComponentsFromOtherProject",data,_log.dataaccessIn);this.nodeWebService.copyComponentsFromOtherProject(data,onResult,onFault);}
DataAccess.shareProjectToUser=function(data,onResult,onFault)
{this.phpWebService.shareProjectToUser(data,onResult,onFault);}
DataAccess.shareProjectToNoExistsUser=function(data,onResult,onFault)
{this.nodeWebService.shareProjectToNoExistsUser(data,onResult,onFault);}
DataAccess.getSharedUsers=function(data,onResult,onFault)
{this.nodeWebService.getSharedUsers(data,onResult,onFault);}
DataAccess.deleteSharedUser=function(data,onResult,onFault)
{this.nodeWebService.deleteSharedUser(data,onResult,onFault);}
DataAccess.changeLanguage=function(data,onResult,onFault)
{this.phpWebService.changeLanguage(data,onResult,onFault);}
DataAccess.searchImages=function(data,onResult,onFault)
{this.phpWebService.searchImages(data,onResult,onFault);}
DataAccess.searchYoutube=function(data,onResult,onFault)
{this.phpWebService.searchYoutube(data,onResult,onFault);}
DataAccess.searchVimeo=function(data,onResult,onFault)
{this.phpWebService.searchVimeo(data,onResult,onFault);}
DataAccess.libraryRequest=function(data,onResult,onFault)
{this.phpWebService.libraryRequest(data,onResult,onFault);}
DataAccess.createPdfImageList=function(data,onResult,onFault,onComplete,onProgress)
{this.nodeWebService.createPdfImageList(data,onResult,onFault,onComplete,onProgress);}
DataAccess.stopCreatePdfImageList=function(data,onResult,onFault,onComplete,onProgress)
{this.nodeWebService.stopCreatePdfImageList(data,onResult,onFault,onComplete,onProgress);}
DataAccess.convertPdfPageToImage=function(data,onResult,onFault,onComplete,onProgress)
{this.nodeWebService.convertPdfPageToImage(data,onResult,onFault,onComplete,onProgress);}
DataAccess.copyLibraryFileToImage=function(data,onResult,onFault,onComplete,onProgress)
{_log("copyLibraryFileToImage",data,_log.dataaccessIn);this.nodeWebService.copyLibraryFileToImage(data,onResult,onFault,onComplete,onProgress);}
DataAccess.getPublishedData=function(data,onResult,onFault,onComplete,onProgress)
{this.nodeWebService.getPublishedData(data,onResult,onFault,onComplete,onProgress);}
DataAccess.newPublication=function(data,onResult,onFault,onComplete,onProgress)
{this.nodeWebService.newPublication(data,onResult,onFault,onComplete,onProgress);}
DataAccess.overridePublication=function(data,onResult,onFault,onComplete,onProgress)
{this.nodeWebService.overridePublication(data,onResult,onFault,onComplete,onProgress);}
DataAccess.setPublicationOptions=function(data,onResult,onFault,onComplete,onProgress)
{this.nodeWebService.setPublicationOptions(data,onResult,onFault,onComplete,onProgress);}
DataAccess.changeStageBackgroundLibrary=function(data,onResult,onFault,onComplete,onProgress)
{this.nodeWebService.changeStageBackgroundLibrary(data,onResult,onFault,onComplete,onProgress);}
DataAccess.cropImage=function(data,onResult,onFault,onComplete,onProgress)
{this.nodeWebService.cropImage(data,onResult,onFault,onComplete,onProgress);}
DataAccess.resizeImage=function(data,onResult,onFault,onComplete,onProgress)
{this.nodeWebService.resizeImage(data,onResult,onFault,onComplete,onProgress);}
DataAccess.getImageSize=function(data,onResult,onFault,onComplete,onProgress)
{this.nodeWebService.getImageSize(data,onResult,onFault,onComplete,onProgress);}
DataAccess.convertLinkToImage=function(data,onResult,onFault,onComplete,onProgress)
{this.nodeWebService.convertLinkToImage(data,onResult,onFault,onComplete,onProgress);}
DataAccess.projectVersioinRequest=function(data,onResult,onFault,onComplete,onProgress)
{var _that=this;if(data.request.request==12){this.nodeWebService.setProjectPermissions(data,function(){_that.phpWebService.projectVersioinRequest(data,onResult,onFault,onComplete,onProgress);},function(){});}else{this.phpWebService.projectVersioinRequest(data,onResult,onFault,onComplete,onProgress);}}
DataAccess.publicationRequest=function(data,onResult,onFault,onComplete,onProgress)
{this.phpWebService.publicationRequest(data,onResult,onFault,onComplete,onProgress);}
DataAccess.saveHistory=function(data,onResult,onFault)
{_log("saveHistory",data,_log.dataaccessIn);this.nodeWebService.saveHistory(data,onResult,onFault);}
DataAccess.sendMails=function(data,onResult,onFault,onComplete,onProgress)
{this.phpWebService.sendMails(data,onResult,onFault,onComplete,onProgress);}
DataAccess.keepSession=function(data,onResult,onFault,onComplete,onProgress)
{this.phpWebService.keepSession(data,onResult,onFault,onComplete,onProgress);}
DataAccess.calculateProjectSize=function(data,onResult,onFault)
{this.nodeWebService.calculateProjectSize(data,onResult,onFault);}
DataAccess.createPsdPage=function(data,onResult,onFault,onComplete,onProgress)
{this.nodeWebService.createPsdPage(data,onResult,onFault,onComplete,onProgress);}
DataAccess.downloadFromOcs=function(data,onResult,onFault,onComplete,onProgress)
{this.phpWebService.downloadFromOcs(data,onResult,onFault,onComplete,onProgress);}
DataAccess.submitTestDriveEmail=function(data,onResult,onFault,onComplete,onProgress)
{this.nodeWebService.submitTestDriveEmail(data,onResult,onFault,onComplete,onProgress);}
DataAccess.getServerDate=function(data,onResult,onFault,onComplete,onProgress)
{this.nodeWebService.getServerDate(data,onResult,onFault,onComplete,onProgress);}
DataAccess.getCapabilities=function(data,onResult,onFault,onComplete,onProgress)
{this.nodeWebService.getCapabilities(data,onResult,onFault,onComplete,onProgress);}
DataAccess.goToHistoryItem=function(data,onResult,onFault)
{this.nodeWebService.goToHistoryItem(data,onResult,onFault);}
DataAccess.selectPageByUser=function(data,onResult,onFault)
{this.nodeWebService.selectPageByUser(data,onResult,onFault);}
DataAccess.onSelectPageByUser=function(data,onResult,onFault)
{this.nodeWebService.onSelectPageByUser(data,onResult,onFault);}
DataAccess.selectComponentsByUser=function(data,onResult,onFault)
{this.nodeWebService.selectComponentsByUser(data,onResult,onFault);}
DataAccess.onSelectComponentsByUser=function(data,onResult,onFault)
{this.nodeWebService.onSelectComponentsByUser(data,onResult,onFault);}
DataAccess.getFoldersStructure=function(data,onResult,onFault)
{_log("getFoldersStructure",data,_log.dataaccessIn);this.nodeWebService.getFoldersStructure(data,onResult,onFault);}
DataAccess.generatePdf=function(data,onResult,onFault)
{var _that=this;_log("generatePdf",data,_log.dataaccessIn);this.nodeWebService.setProjectPermissions(data,function(){_that.phpWebService.publicationRequest(data,onResult,onFault);},function(){});}
DataAccess.loginExternal=function(data,onResult,onFault)
{var _that=this;this.phpWebService.loginExternal(data,function(rdata){var jData=JSON.parse(rdata);if(jData.status=='success'){__meta__.userID=jData.userId;__meta__.login=jData.login;_that.nodeWebService.loginExternal(jData,onResult,onFault);}else{Utils.setModalText({main:_lang('YOU_HAVE_NO_ACCESS'),extra:_lang('YOU_HAVE_NO_ACCESS_EXTRA')},true);$('#darkanapp').html('');onFault(jData);}},onFault);}
DataAccess.editPhotopeaImage=function(data,onResult,onFault)
{this.phpWebService.editPhotopeaImage(data,onResult,onFault);};;var Capabilities=Backbone.Model.extend({defaults:{"login":false,"register":false,"createProjects":false,"haveProjects":false,"publish":false,"publishOnPrimary":false,"hasOwnChannel":false,"exportscorm":false,"exporthtml5":false,"exportpdf":false,"importpdf":false,"importpsd":false,"publishfacebook":false,"mailing":false,"versioning":false,"adminPanel":false},getCapabilities:function(){var _that=this;var state=State.getStateType();_log('SSTATTETE',state);switch(state){case'normal':DataAccess.getCapabilities({},function(data){_log('getCapabilities data',data);for(var item in data){_that.set(item,data[item],{silent:true});};_that.trigger('change',_that);},function(){});break;case'test-drive':DataAccess.getCapabilities({},function(data){_log('getCapabilities data',data);for(var item in data){_that.set(item,false,{silent:true});};_that.trigger('change',_that);},function(){});break;default:break;}},createParams:function(paramsList){for(var i=0;i<paramsList.length;i++){var param=paramsList[i];param.value=this.get(param.name);};return paramsList;}});Capabilities.getInstance=function(){return this.instance||(this.instance=new Capabilities());};;FileUploader=function(){this.blockSize=100000;this.type="";}
FileUploader.prototype=new Backbone.Model();FileUploader.create=function(path,componentModle,componentView){var type=this.checkExt(path,componentModle);componentModle.uploadingNow=false;switch(type){case'file':var fileFileUploader=new FileFileUploader();fileFileUploader.setView(componentModle);fileFileUploader.setView2(componentView);return fileFileUploader;break;case'pagesound':var fileFileUploader=new PageSoundFileUploader();fileFileUploader.setView(componentModle);fileFileUploader.setView2(componentView);return fileFileUploader;break;case'pageimage':var fileFileUploader=new PageImageFileUploader();fileFileUploader.setView(componentModle);fileFileUploader.setView2(componentView);return fileFileUploader;break;case'image':var imageFileUploader=new ImageFileUploader();imageFileUploader.setView(componentModle);imageFileUploader.setView2(componentView);return imageFileUploader;break;case'audio':var audioFileUploader=new AudioFileUploader();audioFileUploader.setView(componentModle);audioFileUploader.setView2(componentView);return audioFileUploader;break;case'sound':var soundsFileUploader=new SoundsFileUploader();soundsFileUploader.setView(componentModle);soundsFileUploader.setView2(componentView);return soundsFileUploader;break;case'video':var videoFileUploader=new VideoFileUploader();videoFileUploader.setView(componentModle);videoFileUploader.setView2(componentView);return videoFileUploader;break;case'swf':var swfFileUploader=new SwfFileUploader();swfFileUploader.setView(componentModle);swfFileUploader.setView2(componentView);return swfFileUploader;break;case'gallery':var galleryFileUploader=new GalleryFileUploader();galleryFileUploader.setView(componentModle);galleryFileUploader.setView2(componentView);return galleryFileUploader;break;default:return undefined;break;}}
FileUploader.prototype.visit=function(view){},FileUploader.prototype.setView=function(componentModle){this.componentModle=componentModle;}
FileUploader.prototype.setView2=function(componentView){this.componentView=componentView;}
FileUploader.createOnClick=function(e,input,componentModle,componentView){var properties=this.getInputProperties(e,input);return FileUploader.create(properties.data.name,componentModle,componentView);}
FileUploader.createOnOnDrop=function(e,componentModle,componentView){var properties=this.getDropProperties(e);return FileUploader.create(properties.data.name,componentModle,componentView);}
FileUploader.prototype.sendFile=function(properties,onResult,onFault,onComplete,onProgress){}
FileUploader.prototype.calculatePartBinaryFile=function(reader,file,data,actionkey){var _that=this;var newFile;var blockSize=_that.blockSize;var fileSize=file.size;var place=data.place*blockSize;if(file.slice){newFile=file.slice(place,place+Math.min(blockSize,(fileSize-place)));}else{newFile=file.mozSlice(place,place+Math.min(blockSize,(fileSize-place)));}
_log("calculatePartBinaryFile");if(reader.readAsBinaryString!=undefined){reader.readAsBinaryString(newFile);reader.onload=function(evt){var imageData=evt.target.result;_that.sendBinaryPart(imageData,actionkey);}}else{reader.readAsDataURL(newFile);reader.onload=function(evt){var imageData=evt.target.result;if(imageData){imageData=imageData.replace(/^[^,]+,/,'');}
var byteCharacters=atob(imageData);_that.sendBinaryPart(byteCharacters,actionkey);}}}
FileUploader.prototype.uint8ToString=function(buf){var i,length,out='';for(i=0,length=buf.length;i<length;i+=1){out+=String.fromCharCode(buf[i]);}
return out;}
FileUploader.prototype.b64EncodeUnicode=function(str){return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,function(match,p1){return String.fromCharCode('0x'+p1);}));}
FileUploader.prototype.b64_to_utf8=function(str){return decodeURIComponent(escape(window.atob(str)));}
FileUploader.prototype.sendBinaryPart=function(imageData,actionkey){}
FileUploader.prototype.onStartUploadingFile=function(){this.componentModle.uploadingNow=true;}
FileUploader.prototype.onCompleteUploadingFile=function(){this.componentModle.uploadingNow=false;}
FileUploader.prototype.isUploadingNow=function(){return this.componentModle.uploadingNow;}
FileUploader.checkExt=function(path,componentModle){var exts=componentModle.getExtensionFilesArray();for(var i=0;i<exts.length;i++){var ext=exts[i];var re=new RegExp("^.*\."+ext+"$");if(re.test(path)){return'file';}};var exts=componentModle.getExtensionPageSoundArray();for(var i=0;i<exts.length;i++){var ext=exts[i];var re=new RegExp("^.*\."+ext+"$");if(re.test(path)){return'pagesound';}};var exts=componentModle.getExtensionPageImageArray();for(var i=0;i<exts.length;i++){var ext=exts[i];var re=new RegExp("^.*\."+ext+"$");if(re.test(path)){return'pageimage';}};var exts=componentModle.getExtensioAudioArray();for(var i=0;i<exts.length;i++){var ext=exts[i];var re=new RegExp("^.*\."+ext+"$");if(re.test(path)){return'audio';}};var exts=componentModle.getExtensionImagesArray();for(var i=0;i<exts.length;i++){var ext=exts[i];var re=new RegExp("^.*\."+ext+"$");if(re.test(path)){return'image';}};var exts=componentModle.getExtensionSoundsArray();for(var i=0;i<exts.length;i++){var ext=exts[i];var re=new RegExp("^.*\."+ext+"$");if(re.test(path)){return'sound';}};var exts=componentModle.getExtensionVideosArray();for(var i=0;i<exts.length;i++){var ext=exts[i];var re=new RegExp("^.*\."+ext+"$");if(re.test(path)){return'video';}};var exts=componentModle.getExtensionSwfArray();for(var i=0;i<exts.length;i++){var ext=exts[i];var re=new RegExp("^.*\."+ext+"$");if(re.test(path)){return'swf';}};var exts=componentModle.getExtensionGalleryArray();for(var i=0;i<exts.length;i++){var ext=exts[i];var re=new RegExp("^.*\."+ext+"$");if(re.test(path)){return'gallery';}};return undefined;}
FileUploader.prototype.onResult=function(data){}
FileUploader.prototype.onFault=function(data){}
FileUploader.prototype.onProgress=function(data){}
FileUploader.prototype.onComplete=function(data){}
FileUploader.getInputProperties=function(e,sender){var file=e.originalEvent.target.files[0];_log('getInputProperties',file);var imageName=sender.value.split('\\').pop();var imageData=e.target.result;var data={name:imageName,data:imageData,size:file.size};return{file:file,data:data};}
FileUploader.getDropProperties=function(e){var file=e.originalEvent.dataTransfer.files[0];var imageName=file.name;var imageData=e.originalEvent.dataTransfer.result;var data={name:imageName,data:imageData,size:file.size};return{file:file,data:data};}
FileUploader.showProgressPercent=function(data,view){view.$el.find('.progress-bar').fadeIn(500);var percentage=parseInt(data.percent);view.$el.find('.progress-bar-text').text(_lang('ADD_SOUND_FILE_NAME_LOADING')+' '+percentage+'%');view.$el.find('.progress-bar-inner').css('width',percentage+'%');}
FileUploader.hideProgressPercent=function(data,view){view.$el.find('.progress-bar-text').text(_lang('ADD_SOUND_FILE_NAME_LOADING')+' 100%');view.$el.find('.progress-bar-inner').css('width','100%');setTimeout(function(){view.$el.find('.progress-bar').fadeOut(500,function(){});},500);}
FileUploader.createPublishIconLoader=function(path,model,view){var exts=view.getExtensionArray();for(var i=0;i<exts.length;i++){var ext=exts[i];var re=new RegExp("^.*\."+ext+"$");if(re.test(path)){var fileFileUploader=new PublishIconFileUploader();fileFileUploader.setView(model);fileFileUploader.setView2(view);return fileFileUploader;}};return undefined;}
FileUploader.createPublishBannerIconLoader=function(path,model,view){var exts=view.getExtensionArray();for(var i=0;i<exts.length;i++){var ext=exts[i];var re=new RegExp("^.*\."+ext+"$");if(re.test(path)){var fileFileUploader=new PublishBannerIconFileUploader();fileFileUploader.setView(model);fileFileUploader.setView2(view);return fileFileUploader;}};return undefined;}
FileUploader.prototype.componentIsDeleted=function(){return this.componentModle.isDeleted;};;ImageFileUploader=function(){}
ImageFileUploader.prototype=new FileUploader();ImageFileUploader.prototype.sendFile=function(properties){var _that=this;this.onStartUploadingFile();this.properties=properties;var reader=new FileReader();var file=properties.file;var uploadData=properties.data;var actionkey=this.componentModle.get('actionkey');uploadData.actionkey=actionkey;uploadData.type=this.type;uploadData.componentType=this.componentModle.get('type');uploadData.specialData=properties.specialData;DataAccess.uploadImage(uploadData,function(data){_that.onResult(data);_that.trigger('on-result',data);},function(data){_that.onFault(data);_that.trigger('on-fault',data);},function(data){_that.onCompleteUploadingFile();_that.onComplete(data);_that.trigger('on-complete',data);},function(data){_that.onProgress(data);_that.trigger('on-progress',data);_that.calculatePartBinaryFile(reader,file,data,actionkey);});}
ImageFileUploader.prototype.sendBinaryPart=function(imageData,actionkey){DataAccess.uploadImageProgress(actionkey,{'data':imageData,actionkey:actionkey,isDeleted:this.componentIsDeleted()});}
ImageFileUploader.prototype.tempUploadImage=function(file){var _that=this;var tempReader=new FileReader();tempReader.onload=function(evt){_that.componentModle.view.$el.find('img').attr('src',evt.target.result);}
tempReader.readAsDataURL(file);}
ImageFileUploader.prototype.onResult=function(data){var file=this.properties.file;this.tempUploadImage(file);}
ImageFileUploader.prototype.onComplete=function(data){this.componentModle.setFileName(data);};;AudioFileUploader=function(){this.type="audio";}
AudioFileUploader.prototype=new FileUploader();AudioFileUploader.prototype.sendFile=function(properties){var _that=this;this.onStartUploadingFile();this.properties=properties;var reader=new FileReader();var file=properties.file;var uploadData=properties.data;var actionkey=this.componentModle.get('actionkey');uploadData.actionkey=actionkey;uploadData.type=this.type;DataAccess.uploadAudio(uploadData,function(data){_that.onResult(data);_that.trigger('on-result',data);},function(data){_that.onFault(data);_that.trigger('on-fault',data);},function(data){_that.onCompleteUploadingFile();_that.onComplete(data);_that.trigger('on-complete',data);},function(data){_that.onProgress(data);_that.trigger('on-progress',data);_that.calculatePartBinaryFile(reader,file,data,actionkey);});}
AudioFileUploader.prototype.sendBinaryPart=function(imageData,actionkey){DataAccess.uploadAudioProgress(actionkey,{'data':imageData,actionkey:actionkey,isDeleted:this.componentIsDeleted()});}
AudioFileUploader.prototype.onComplete=function(data){this.componentModle.setAudioFileName(data);};;VideoFileUploader=function(){this.type="video";}
VideoFileUploader.prototype=new FileUploader();VideoFileUploader.prototype.sendFile=function(properties){var _that=this;this.onStartUploadingFile();this.properties=properties;var reader=new FileReader();var file=properties.file;var uploadData=properties.data;var actionkey=this.componentModle.get('actionkey');uploadData.actionkey=actionkey;uploadData.type=this.type;DataAccess.uploadVideo(uploadData,function(data){_that.onResult(data);_that.trigger('on-result',data);},function(data){_that.onFault(data);_that.trigger('on-fault',data);},function(data){_that.onCompleteUploadingFile();_that.onComplete(data);_that.trigger('on-complete',data);},function(data){_that.onProgress(data);_that.trigger('on-progress',data);_that.calculatePartBinaryFile(reader,file,data,actionkey);});}
VideoFileUploader.prototype.sendBinaryPart=function(imageData,actionkey){DataAccess.uploadVideoProgress(actionkey,{'data':imageData,actionkey:actionkey,isDeleted:this.componentIsDeleted()});}
VideoFileUploader.prototype.onComplete=function(data){this.componentModle.setFileName(data);};;PageSoundFileUploader=function(){this.type="pagesound";}
PageSoundFileUploader.prototype=new FileUploader();PageSoundFileUploader.prototype.sendFile=function(properties){var _that=this;this.onStartUploadingFile();this.properties=properties;var reader=new FileReader();var file=properties.file;var uploadData=properties.data;var pageID=this.componentModle.get('pageid');uploadData.actionkey=pageID;uploadData.type=this.type;var actionkey=pageID;DataAccess.uploadPageSound(uploadData,function(data){_that.onResult(data);_that.trigger('on-result',data);},function(data){_that.onFault(data);_that.trigger('on-fault',data);},function(data){_that.onCompleteUploadingFile();_that.onComplete(data);_that.trigger('on-complete',data);},function(data){_that.onProgress(data);_that.trigger('on-progress',data);_that.calculatePartBinaryFile(reader,file,data,actionkey);});}
PageSoundFileUploader.prototype.sendBinaryPart=function(imageData,pageID){DataAccess.uploadPageSoundProgress(pageID,{'data':imageData,actionkey:pageID,isDeleted:this.componentIsDeleted()});}
PageSoundFileUploader.prototype.onComplete=function(data){this.componentModle.setFileName(data);};;PageImageFileUploader=function(){this.type="pagesound";}
PageImageFileUploader.prototype=new FileUploader();PageImageFileUploader.prototype.sendFile=function(properties){var _that=this;this.onStartUploadingFile();this.properties=properties;var reader=new FileReader();var file=properties.file;var uploadData=properties.data;var pageID=this.componentModle.get('pageid');uploadData.actionkey=pageID;uploadData.type=this.type;var actionkey=pageID;DataAccess.uploadPageImage(uploadData,function(data){_that.onResult(data);_that.trigger('on-result',data);},function(data){_that.onFault(data);_that.trigger('on-fault',data);},function(data){_that.onCompleteUploadingFile();_that.onComplete(data);_that.trigger('on-complete',data);},function(data){_that.onProgress(data);_that.trigger('on-progress',data);_that.calculatePartBinaryFile(reader,file,data,actionkey);});}
PageImageFileUploader.prototype.sendBinaryPart=function(imageData,pageID){DataAccess.uploadPageImageProgress(pageID,{'data':imageData,actionkey:pageID,isDeleted:this.componentIsDeleted()});}
PageImageFileUploader.prototype.onComplete=function(data){this.componentModle.setImageFileName(data);};;SwfFileUploader=function(){this.type="swf";}
SwfFileUploader.prototype=new FileUploader();SwfFileUploader.prototype.sendFile=function(properties){var _that=this;this.onStartUploadingFile();this.properties=properties;var reader=new FileReader();var file=properties.file;var uploadData=properties.data;var actionkey=this.componentModle.get('actionkey');uploadData.actionkey=actionkey;uploadData.type=this.type;DataAccess.uploadSwf(uploadData,function(data){_that.onResult(data);_that.trigger('on-result',data);},function(data){_that.onFault(data);_that.trigger('on-fault',data);},function(data){_that.onCompleteUploadingFile();_that.onComplete(data);_that.trigger('on-complete',data);},function(data){_that.onProgress(data);_that.trigger('on-progress',data);_that.calculatePartBinaryFile(reader,file,data,actionkey);});}
SwfFileUploader.prototype.sendBinaryPart=function(imageData,actionkey){DataAccess.uploadSwfProgress(actionkey,{'data':imageData,actionkey:actionkey,isDeleted:this.componentIsDeleted()});}
SwfFileUploader.prototype.onComplete=function(data){this.componentModle.setFileName(data);this.componentModle.view.putSwf(data);};;FileFileUploader=function(){this.type="file";}
FileFileUploader.prototype=new FileUploader();FileFileUploader.prototype.sendFile=function(properties){var _that=this;this.onStartUploadingFile();this.properties=properties;var reader=new FileReader();var file=properties.file;var uploadData=properties.data;var actionkey=this.componentModle.get('actionkey');uploadData.actionkey=actionkey;uploadData.type=this.type;DataAccess.uploadFile(uploadData,function(data){_that.onResult(data);_that.trigger('on-result',data);},function(data){_that.onFault(data);_that.trigger('on-fault',data);},function(data){_that.onCompleteUploadingFile();_that.onComplete(data);_that.trigger('on-complete',data);},function(data){_that.onProgress(data);_that.trigger('on-progress',data);_that.calculatePartBinaryFile(reader,file,data,actionkey);});}
FileFileUploader.prototype.sendBinaryPart=function(imageData,actionkey){DataAccess.uploadFileProgress(actionkey,{'data':imageData,actionkey:actionkey,isDeleted:this.componentIsDeleted()});}
FileFileUploader.prototype.onComplete=function(data){this.componentModle.setFileName(data);};;SoundsFileUploader=function(){this.type="sounds";}
SoundsFileUploader.prototype=new FileUploader();SoundsFileUploader.prototype.sendFile=function(properties){var _that=this;this.onStartUploadingFile();this.properties=properties;var reader=new FileReader();var file=properties.file;var uploadData=properties.data;var actionkey=this.componentModle.get('actionkey');uploadData.actionkey=actionkey;uploadData.type=this.type;uploadData.componentType=this.componentModle.get('type');uploadData.specialData=properties.specialData;DataAccess.uploadSounds(uploadData,function(data){_that.onResult(data);_that.trigger('on-result',data);},function(data){_that.onFault(data);_that.trigger('on-fault',data);},function(data){_that.onCompleteUploadingFile();_that.onComplete(data);_that.trigger('on-complete',data);},function(data){_that.onProgress(data);_that.trigger('on-progress',data);_that.calculatePartBinaryFile(reader,file,data,actionkey);});}
SoundsFileUploader.prototype.sendBinaryPart=function(imageData,actionkey){DataAccess.uploadSoundsProgress(actionkey,{'data':imageData,actionkey:actionkey,isDeleted:this.componentIsDeleted()});}
SoundsFileUploader.prototype.onComplete=function(data){this.componentModle.setSoundFileName(data);};;GalleryFileUploader=function(){this.type="gallery";}
GalleryFileUploader.prototype=new FileUploader();GalleryFileUploader.prototype.sendFile=function(properties){var _that=this;this.onStartUploadingFile();this.properties=properties;var reader=new FileReader();var file=properties.file;var uploadData=properties.data;var actionkey=this.componentModle.get('actionkey');uploadData.actionkey=actionkey;uploadData.type=this.type;DataAccess.uploadGallery(uploadData,function(data){_that.onResult(data);_that.trigger('on-result',data);},function(data){_that.onFault(data);_that.trigger('on-fault',data);},function(data){_that.onCompleteUploadingFile();_that.onComplete(data);_that.trigger('on-complete',data);},function(data){_that.onProgress(data);_that.trigger('on-progress',data);_that.calculatePartBinaryFile(reader,file,data,actionkey);});}
GalleryFileUploader.prototype.sendBinaryPart=function(imageData,actionkey){DataAccess.uploadGalleryProgress(actionkey,{'data':imageData,actionkey:actionkey,isDeleted:this.componentIsDeleted()});}
GalleryFileUploader.prototype.onComplete=function(data){_log('GalleryFileUploader onComplete data',data);_log('GalleryFileUploader onComplete this.componentModle',this.componentModle);var galleryFiles=this.componentModle.get('galleryFiles');galleryFiles.push(data.fileName);this.componentModle.setFileName(galleryFiles);this.componentModle.trigger('change');this.componentModle.setGalleryFile();};;ImportFileUploader=function(){this.blockSize=100000;this.type="";}
ImportFileUploader.prototype=new FileUploader();ImportFileUploader.create=function(path,componentModle,componentView){var type=this.checkExt(path,componentView);switch(type){case'pdf':var fileploader=new ImportPdfFileUploader();fileploader.setView(componentModle);fileploader.setView2(componentView);return fileploader;break;case'image':var fileploader=new ImportImageFileUploader();fileploader.setView(componentModle);fileploader.setView2(componentView);return fileploader;break;case'psd':var fileploader=new ImportPsdFileUploader();fileploader.setView(componentModle);fileploader.setView2(componentView);return fileploader;break;default:return undefined;break;}}
ImportFileUploader.prototype.sendFile=function(properties){}
ImportFileUploader.prototype.sendBinaryPart=function(imageData,actionkey){}
ImportFileUploader.checkExt=function(path,componentView){var exts=componentView.getExtensionImagesArray();for(var i=0;i<exts.length;i++){var ext=exts[i];var re=new RegExp("^.*\."+ext+"$");if(re.test(path)){return'image';}};var exts=componentView.getExtensionPdfArray();for(var i=0;i<exts.length;i++){var ext=exts[i];var re=new RegExp("^.*\."+ext+"$");if(re.test(path)){return'pdf';}};var exts=componentView.getExtensionPsdArray();for(var i=0;i<exts.length;i++){var ext=exts[i];var re=new RegExp("^.*\."+ext+"$");if(re.test(path)){return'psd';}};}
ImportFileUploader.prototype.onComplete=function(data){};;ImportPdfFileUploader=function(){this.type="importpdf";}
ImportPdfFileUploader.prototype=new ImportFileUploader();ImportPdfFileUploader.prototype.sendFile=function(properties){var _that=this;this.onStartUploadingFile();this.properties=properties;var reader=new FileReader();var file=properties.file;var uploadData=properties.data;var pageID=ProjectModel.instance.get('options').get('lastPageId');uploadData.actionkey=pageID;uploadData.type=this.type;var actionkey=pageID;DataAccess.uploadImportPdf(uploadData,function(data){_that.onResult(data);_that.trigger('on-result',data);},function(data){_that.onFault(data);_that.trigger('on-fault',data);},function(data){_that.onCompleteUploadingFile();_that.onComplete(data);_that.trigger('on-complete-upload-pdf',data);},function(data){_that.onProgress(data);_that.trigger('on-progress',data);_that.calculatePartBinaryFile(reader,file,data,actionkey);});}
ImportPdfFileUploader.prototype.sendBinaryPart=function(imageData,pageID){DataAccess.uploadImportPdfProgress(pageID,{data:imageData,actionkey:pageID});}
ImportPdfFileUploader.prototype.onComplete=function(data){var _that=this;};;ImportImageFileUploader=function(){this.blockSize=100000;this.type="importimage";}
ImportImageFileUploader.prototype=new ImportFileUploader();ImportImageFileUploader.prototype.sendFile=function(properties){var _that=this;this.onStartUploadingFile();var rightMenuView=RightMenuView.instance;var stageView=StageView.instance;var newPageModel=ProjectModel.instance.createNewPageModel();rightMenuView.pageListView.addNewBlankPage(newPageModel,false,function(pageModel){_that.properties=properties;var reader=new FileReader();var file=properties.file;var uploadData=properties.data;var pageID=pageModel.get('options').get('pageid');uploadData.actionkey=pageID;uploadData.type=_that.type;var actionkey=pageID;DataAccess.uploadImportImage(uploadData,function(data){_that.onResult(data);_that.trigger('on-result',data);},function(data){_that.onFault(data);_that.trigger('on-fault',data);},function(data){pageModel.get('options').set('image',data.fileName);_that.onCompleteUploadingFile();_that.onComplete(data);_that.trigger('on-complete',data);_that.trigger('on-complete-upload-image',data);},function(data){_that.onProgress(data);_that.trigger('on-progress',data);_that.calculatePartBinaryFile(reader,file,data,actionkey);});},function(data){});}
ImportImageFileUploader.prototype.sendBinaryPart=function(imageData,pageID){DataAccess.uploadImportImageProgress(pageID,{'data':imageData,actionkey:pageID});}
ImportImageFileUploader.prototype.onComplete=function(data){};;ImportPsdFileUploader=function(){this.type="importpsd";}
ImportPsdFileUploader.prototype=new ImportFileUploader();ImportPsdFileUploader.prototype.sendFile=function(properties){var _that=this;this.onStartUploadingFile();this.properties=properties;var reader=new FileReader();var file=properties.file;var uploadData=properties.data;var pageID=ProjectModel.instance.get('options').get('lastPageId');uploadData.actionkey=pageID;uploadData.type=this.type;var actionkey=pageID;DataAccess.uploadImportPsd(uploadData,function(data){_that.onResult(data);_that.trigger('on-result',data);},function(data){_that.onFault(data);_that.trigger('on-fault',data);},function(data){_that.onCompleteUploadingFile();_that.onComplete(data);_that.trigger('on-complete',data);},function(data){_that.onProgress(data);_that.trigger('on-progress',data);_that.calculatePartBinaryFile(reader,file,data,actionkey);});}
ImportPsdFileUploader.prototype.sendBinaryPart=function(imageData,pageID){DataAccess.uploadImportPsdProgress(pageID,{data:imageData,actionkey:pageID});}
ImportPsdFileUploader.prototype.onComplete=function(data){var _that=this;};;PublishIconFileUploader=function(){this.type="publish-icon";}
PublishIconFileUploader.prototype=new FileUploader();PublishIconFileUploader.prototype.sendFile=function(properties){var _that=this;this.onStartUploadingFile();this.properties=properties;var reader=new FileReader();var file=properties.file;var uploadData=properties.data;var actionkey="publish-icon";uploadData.actionkey=actionkey;uploadData.type=this.type;DataAccess.uploadPublishIcon(uploadData,function(data){_that.onResult(data);_that.trigger('on-result',data);},function(data){_that.onFault(data);_that.trigger('on-fault',data);},function(data){_that.onCompleteUploadingFile();_that.onComplete(data);_that.trigger('on-complete',data);},function(data){_that.onProgress(data);_that.trigger('on-progress',data);_that.calculatePartBinaryFile(reader,file,data,actionkey);});}
PublishIconFileUploader.prototype.sendBinaryPart=function(imageData,actionkey){DataAccess.uploadPublishIconProgress(actionkey,{'data':imageData,actionkey:actionkey,isDeleted:this.componentIsDeleted()});}
PublishIconFileUploader.prototype.onComplete=function(data){var thumb='projects/'+__meta__.ownerID+'/'+__meta__.projectID+'/thumb/'+data.fileName;this.componentModle.set('thumb',thumb);};;PublishBannerIconFileUploader=function(){this.type="publish-icon";}
PublishBannerIconFileUploader.prototype=new FileUploader();PublishBannerIconFileUploader.prototype.sendFile=function(properties){var _that=this;this.onStartUploadingFile();this.properties=properties;var reader=new FileReader();var file=properties.file;var uploadData=properties.data;var actionkey="publish-banner-icon";uploadData.actionkey=actionkey;uploadData.type=this.type;uploadData.hash=this.componentModle.get('path');this.uploadData=uploadData;DataAccess.uploadPublishBannerIcon(uploadData,function(data){_that.onResult(data);_that.trigger('on-result',data);},function(data){_that.onFault(data);_that.trigger('on-fault',data);},function(data){_that.onCompleteUploadingFile();_that.onComplete(data);_that.trigger('on-complete',data);},function(data){_that.onProgress(data);_that.trigger('on-progress',data);_that.calculatePartBinaryFile(reader,file,data,actionkey);});}
PublishBannerIconFileUploader.prototype.sendBinaryPart=function(imageData,actionkey){DataAccess.uploadPublishBannerIconProgress(actionkey,{'data':imageData,actionkey:actionkey,isDeleted:this.componentIsDeleted()});}
PublishBannerIconFileUploader.prototype.onComplete=function(data){var thumb=data.fileName;var thumb=__meta__.publications_link+this.uploadData.hash+'/thumb/'+thumb;this.componentModle.set('thumb',thumb);this.componentView.renderImage();this.componentView.saveToServer();};;ProjectSoundUploader=function(){this.type="projectsound";}
ProjectSoundUploader.prototype=new FileUploader();ProjectSoundUploader.prototype.sendFile=function(properties){var _that=this;this.onStartUploadingFile();this.properties=properties;var reader=new FileReader();var file=properties.file;var uploadData=properties.data;var pageID='project';uploadData.actionkey=pageID;uploadData.type=this.type;var actionkey=pageID;DataAccess.uploadProjectSound(uploadData,function(data){_that.onResult(data);_that.trigger('on-result',data);},function(data){_that.onFault(data);_that.trigger('on-fault',data);},function(data){_that.onCompleteUploadingFile();_that.onComplete(data);_that.trigger('on-complete',data);},function(data){_that.onProgress(data);_that.trigger('on-progress',data);_that.calculatePartBinaryFile(reader,file,data,actionkey);});}
ProjectSoundUploader.prototype.sendBinaryPart=function(imageData,pageID){DataAccess.uploadProjectSoundProgress(pageID,{'data':imageData,actionkey:pageID,isDeleted:this.componentIsDeleted()});}
ProjectSoundUploader.prototype.onComplete=function(data){this.componentModle.setFileName(data);};;var ItemView=Backbone.View.extend({onMouseDown:function(e){if(this.checkCondition()){return;}
ContextMenuContainer.closeMenu();switch(e.button){case 0:this.mouseDown(e);break;case 1:this.scroll(e);break;case 2:e.stopPropagation();this.mouseDown(e);this.showContextMenu(e);break;}},checkCondition:function(e){return this.model.get('locked');},mouseDown:function(e){},scroll:function(e){},showContextMenu:function(e){var contextMenuView=new ContextMenuView({model:this.getModel(),view:this});ContextMenuContainer.addMenu(contextMenuView,e);},getModel:function(){return this.model;}});;;var ComponentModel=Backbone.Model.extend({defaults:function(){return{actionkey:null,type:"",x:10,y:10,compl:0,action:99,width:0,height:0,draggable:true,aspectRatio:false,aspectRatioProportions:0,'require-credit':false,'credit-points':0,'selected-by':-1,triggers:[],'point-sound':'','volume':100,autoplaySound:true,title:'',wcag:false,wcagMessage:'',lifetime:0,showtime:0,hidden:false,locked:false,flipX:'xnormal',flipY:'ynormal'}},active:false,startX:0,startY:0,initialize:function(){this.checkStyles();var animationExsists=this.get('animations');if(!animationExsists){var blankAnimationsObject=this.createAnimationsObject();this.set('animations',blankAnimationsObject,{silent:true});}
var premadeStylesExsists=this.get('premade-style');if(!premadeStylesExsists){var blankPremadeStyleObject=[];this.set('premade-style',blankPremadeStyleObject,{silent:true});}
var parallaxExsists=this.get('parallax');if(!parallaxExsists){var blankParallaxObject=this.createParallaxObject();this.set('parallax',blankParallaxObject,{silent:true});}
this.afterInitialize();},setActionkey:function(actionkey){this.set('actionkey',actionkey,{silent:true});this.onActionkeySet();},onActionkeySet:function(actionkey){},pasteStyle:function(style,silent){if(style==undefined){return;}
silent=silent==undefined?false:silent;var type=this.get('type');var componentStyle=style[type];if(componentStyle!=undefined){this.set({styles:JSON.parse(componentStyle)},{silent:silent});this.forceRender();}},pastePosition:function(position,silent){silent=silent==undefined?false:silent;var x=position.x;var y=position.y;this.set({x:x,y:y},{silent:silent});this.forceRender();},pasteDimension:function(dimensions,silent){silent=silent==undefined?false:silent;var width=dimensions.width;var height=dimensions.height;this.set({width:width,height:height},{silent:silent});this.forceRender();},pasteTrigger:function(triggers,silent){silent=silent==undefined?false:silent;this.set('triggers',JSON.parse(JSON.stringify(triggers)),{silent:silent});},toPasteTrigger:function(triggerActions,silent){silent=silent==undefined?false:silent;var triggers=this.get('triggers');for(var i=0;i<triggerActions.length;i++){var triggerAction=JSON.parse(JSON.stringify(triggerActions[i]));_log('toPasteTrigger',triggerAction);triggers.push(triggerAction);};this.set('triggers',triggers,{silent:silent});},checkStyles:function(){var stylesExsists=this.get('styles');if(!stylesExsists){var blankStylesObject=this.createStylesObject();this.set('styles',blankStylesObject,{silent:true});}},createStylesObject:function(){return{};},createShadowObject:function(){},createBorderRadiusObject:function(){},createBorderObject:function(){},createParallaxObject:function(){var parallax={cursor:{sens:0,dir:false,on:false},scroll:{sens:0,on:false}}
return parallax;},createAnimationsObject:function(){var animations={animIn:{animationName:'none',animationPrettyName:_lang('ANIMATION_NONE'),animationTime:1.3},animOut:{animationName:'none',animationPrettyName:_lang('ANIMATION_NONE'),animationTime:1.3},animOver:{animationName:'none',animationPrettyName:_lang('ANIMATION_NONE'),animationTime:1.3},animEndless:{animationName:'none',animationPrettyName:_lang('ANIMATION_NONE'),animationTime:1.3}}
return animations;},active:false,afterInitialize:function(){},onComponentDrag:function(data){this.trigger('on-component-drag',data);},onComponentResize:function(data){this.trigger('on-component-resize',data);},onComponentRotate:function(data){this.trigger('on-component-rotate',data);},setActive:function(active,multiSelectedModels,params){if(this.active!=active){this.trigger('set-active',active,multiSelectedModels,params);}
this.active=active;},setProportions:function(){this.set('aspectRatioProportions',(parseInt(this.get('height'))*100)/ parseInt(this.get('width')),{silent:true});},selectedByMiniature:function(value){this.trigger('selected-by-miniature',value);},selectedByPickerMiniature:function(value){this.trigger('selected-by-picker-miniature-1',value);this.trigger('selected-by-picker-miniature-2',value);},selectedByTrigger:function(value){this.trigger('selected-by-trigger',value);},setZIndex:function(zIndex){this.trigger('set-zindex',zIndex);},setSelectedBy:function(options){this.trigger('set-selected-coming',options);},updateComing:function(options){this.trigger('update-coming',options);},deleteComing:function(){this.trigger('delete-coming');},forceRender:function(){this.trigger('force-render');},getTriggerWhenDoIt:function(){var triggerWhenDoIt=new TriggerActionsCollection();var triggerActionModel=new TriggerActionsCollection();var triggerActionModel=new TriggerActionModel({group:_lang('TRIGGER_EVENT_TIMELINE'),options:[{name:_lang('TRIGGER_EVENT_ON_SHOW'),value:'onShow'},{name:_lang('TRIGGER_EVENT_ON_HIDE'),value:'onHide'}]});triggerWhenDoIt.add(triggerActionModel);var triggerActionModel=new TriggerActionModel({group:_lang('TRIGGER_EVENT_SOUND'),options:[{name:_lang('TRIGGER_EVENT_ON_SOUND_ENDED'),value:'onSoundEnded'},]});triggerWhenDoIt.add(triggerActionModel);var isDndElement=this.isDndElement();_log('isDndElement',isDndElement);if(isDndElement){var triggerActionModel=new TriggerActionsCollection();var triggerActionModel=new TriggerActionModel({group:_lang('TRIGGER_EVENT_ON_DRAG'),options:[{name:_lang('TRIGGER_EVENT_ON_START_DRAG'),value:'onStartDrag'},{name:_lang('TRIGGER_EVENT_ON_STOP_DRAG'),value:'onStopDrag'}]});triggerWhenDoIt.add(triggerActionModel);var triggerActionModel=new TriggerActionsCollection();var triggerActionModel=new TriggerActionModel({group:_lang('TRIGGER_EVENT_ON_DROP'),options:[{name:_lang('TRIGGER_EVENT_ON_DROP_GOOD'),value:'onDropGoodAnswer'},{name:_lang('TRIGGER_EVENT_ON_DROP_WRONG'),value:'onDropWrongAnswer'},]});triggerWhenDoIt.add(triggerActionModel);}
var isDndElementDropable=this.isDndElementDropable();if(isDndElementDropable){var triggerActionModel=new TriggerActionsCollection();var triggerActionModel=new TriggerActionModel({group:_lang('TRIGGER_EVENT_ON_DROP'),options:[{name:_lang('TRIGGER_EVENT_ON_DROP_TO_OBJECT'),value:'onDropToObject'},]});triggerWhenDoIt.add(triggerActionModel);}
return triggerWhenDoIt.toJSON();},getTriggerWhatToDo:function(){return[];},getStyles:function(){return[];},setFileName:function(data){},setSoundFileName:function(data){this.set('point-sound',data.fileName);},setAudioFileName:function(data){this.set('sound',data.fileName);},setStyle:function(allStyles,templateStyles){var styleClass='unnamed';var componentStyles=this.get('styles');if(Array.isArray(componentStyles)){componentStyles={};}
_.each(allStyles[templateStyles],function(st,className){styleClass=className;var sty=JSON.stringify(allStyles[templateStyles][styleClass]);componentStyles[styleClass]=JSON.parse(sty);});this.set('styles',componentStyles);this.trigger('change:styles');this.trigger('change');},refreshTimelineEditor:function(){this.trigger('refresh-timeline-editor-numbers');},disable:function(){this.trigger('disable-component');},refreshEditor:function(){this.trigger('refresh-bottom-editor');},getExtensionPageSoundArray:function(){return[];},getExtensionPageImageArray:function(){return[];},getExtensionFilesArray:function(){return[];},getExtensioAudioArray:function(){return[];},getExtensionImagesArray:function(){return[];},getExtensionSoundsArray:function(){return['mp3'];},getExtensionVideosArray:function(){return[];},getExtensionSwfArray:function(){return[];},getExtensionGalleryArray:function(){return[];},getAcceptTypeFormat:function(){return'.mp3';},triggerChanged:function(){this.trigger('trigger-changed',this);},isDndElement:function(){var _that=this;var exist=false;var dndsComponents=StageView.instance.model.getDndsComponents();dndsComponents.each(function(model){_log('dnd el',model.toJSON());var draggableObjs=model.get('draggableObjs');var answers=model.get('answers');for(var i=0;i<draggableObjs.length;i++){var actionkey=draggableObjs[i];if(actionkey==_that.get('actionkey')){exist=true;break;}};for(var item in answers){var pa=answers[item].pa;if(pa){for(var j=0;j<pa.length;j++){var actionkey=pa[j];if(actionkey==_that.get('actionkey')){exist=true;break;}};}};});return exist;},isDndElementDropable:function(){var _that=this;var exist=false;var dndsComponents=StageView.instance.model.getDndsComponents();dndsComponents.each(function(model){_log('dnd el',model.toJSON());var answers=model.get('answers');for(var item in answers){if(item==_that.get('actionkey')){exist=true;break;}};});return exist;},isExercise:function(){var type=this.get('type');switch(type){case'crossword':case'quiz':case'quiz-connectlines':case'quiz-dnd':case'quiz-inputtext':case'quiz-select':case'quiz-wordsearch':return true;break;}
return false;},flipX:function(){var flipX=this.get('flipX');var flipY=this.get('flipY');if(flipX=='xnormal'){this.set('flipX','xflip');}else{this.set('flipX','xnormal');}},flipY:function(){var flipX=this.get('flipX');var flipY=this.get('flipY');if(flipY=='ynormal'){this.set('flipY','yflip');}else{this.set('flipY','ynormal');}},});;;var ExerciseComponentModel=ComponentModel.extend({defaults:function(){return _.extend({},ComponentModel.prototype.defaults(),{'click .edit-component-button':'startEditing'})},startEditing:function(){},getTriggerWhenDoIt:function(){var triggerWhenDoIt=new TriggerActionsCollection();var triggerActionModelQuestions=new TriggerActionModel({group:_lang('TRIGGER_EVENT_QUESTION'),options:[{name:_lang('TRIGGER_EVENT_QUESTION_PASSED'),value:'custom_questionpassed'},{name:_lang('TRIGGER_EVENT_QUESTION_FAILED'),value:'custom_questionfailed'},{name:_lang('TRIGGER_EVENT_QUESTION_BADANSWER'),value:'custom_questionbadanswer'}]});triggerWhenDoIt.add(triggerActionModelQuestions);var triggerActionModelTimeline=new TriggerActionModel({group:_lang('TRIGGER_EVENT_TIMELINE'),options:[{name:_lang('TRIGGER_EVENT_ON_SHOW'),value:'onShow'},{name:_lang('TRIGGER_EVENT_ON_HIDE'),value:'onHide'}]});triggerWhenDoIt.add(triggerActionModelTimeline);return triggerWhenDoIt.toJSON();}});;;var TextModel=ComponentModel.extend({defaults:function(){return _.extend({},ComponentModel.prototype.defaults(),{type:"text",action:99,width:300,height:120,padding:10,contents:'<span style="font-size:18px">'+_lang('SIMPLETEXT_INSERTTEXT')+'</span>','enable-scrollbar':false,bgcolor:''})},setTextEditor:function(el){this.trigger('set-text-editor',el);}});;;var ImageModel=ComponentModel.extend({defaults:function(){return _.extend({},ComponentModel.prototype.defaults(),{type:"image",action:99,width:200,height:163,opacity:1,imageFileName:'',audioFileName:'',library:'',rand:0})},getExtensionImagesArray:function(){return['jpg','png','gif','JPG','JPEG','jpeg'];},getAcceptTypeFormat:function(){var _mainTypes=this.getExtensionImagesArray();var _soundTypes=this.getExtensionSoundsArray();var acceptTypeString='';_.each(_mainTypes,function(option){acceptTypeString+='.'+option+',';});_.each(_soundTypes,function(option){acceptTypeString+='.'+option+',';});return acceptTypeString;},setFileName:function(data){var rand=new Date().getTime();this.set({imageFileName:data.fileName,rand:rand},{silent:true});this.trigger('change');},setComponentAsImage:function(){var _that=this;this.getExtensionImagesArray=function(){return['jpg','png','gif','JPG','JPEG','jpeg'];}
this.getExtensionGalleryArray=function(){return[];}
this.getExtensionFilesArray=function(){return[];}
this.getExtensioAudioArray=function(){return[];}
this.setFileName=function(data){var rand=new Date().getTime();_that.set({imageFileName:data.fileName,rand:rand},{silent:true});_that.trigger('change');}},});;;var VideoModel=ComponentModel.extend({defaults:function(){return _.extend({},ComponentModel.prototype.defaults(),{type:"video",action:99,width:420,height:236,videoFileName:"",videoLoop:false,videoAutoplay:false,videoControls:true,videoType:1,videoLink:''})},setFileName:function(data){this.set('videoFileName',data.fileName);},getExtensionVideosArray:function(){return['mp4'];},getAcceptTypeFormat:function(){var _mainTypes=this.getExtensionVideosArray();var _soundTypes=this.getExtensionSoundsArray();var acceptTypeString='';_.each(_mainTypes,function(option){acceptTypeString+='.'+option+',';});_.each(_soundTypes,function(option){acceptTypeString+='.'+option+',';});return acceptTypeString;},getTriggerWhenDoIt:function(){var triggerWhenDoIt=new TriggerActionsCollection();var triggerActionModel=new TriggerActionsCollection();var triggerActionModel=new TriggerActionModel({group:_lang('TRIGGER_EVENT_TIMELINE'),options:[{name:_lang('TRIGGER_EVENT_ON_SHOW'),value:'onShow'},{name:_lang('TRIGGER_EVENT_ON_HIDE'),value:'onHide'}]});triggerWhenDoIt.add(triggerActionModel);var videoType=this.get('videoType');switch(videoType){case 1:var triggerActionModelQuestions=new TriggerActionModel({group:_lang('TRIGGER_VIDEO'),options:[{name:_lang('TRIGGER_EVENT_VIDEO_LOADED'),value:'onVideoLoaded'},{name:_lang('TRIGGER_EVENT_VIDEO_ENDED'),value:'onVideoEnded'},{name:_lang('TRIGGER_EVENT_VIDEO_TIME_UPADATE'),value:'onVideoTimeUpdate'},{name:_lang('TRIGGER_EVENT_VIDEO_TIME_ON_PLAY'),value:'onVideoPlay'},{name:_lang('TRIGGER_EVENT_VIDEO_TIME_ON_PAUSE'),value:'onVideoPause'},{name:_lang('TRIGGER_EVENT_VIDEO_TIME_ON_STOP'),value:'onVideoStop'},{name:_lang('TRIGGER_EVENT_VIDEO_TIME_GO_TO_POSITION'),value:'onVideoGoToPosition'}]});triggerWhenDoIt.add(triggerActionModelQuestions);break;case 2:var triggerActionModelQuestions=new TriggerActionModel({group:_lang('TRIGGER_VIDEO'),options:[{name:_lang('TRIGGER_EVENT_VIDEO_LOADED'),value:'onVideoLoaded'},{name:_lang('TRIGGER_EVENT_VIDEO_ENDED'),value:'onVideoEnded'},{name:_lang('TRIGGER_EVENT_VIDEO_TIME_ON_PLAY'),value:'onVideoPlay'},{name:_lang('TRIGGER_EVENT_VIDEO_TIME_ON_PAUSE'),value:'onVideoPause'},{name:_lang('TRIGGER_EVENT_VIDEO_TIME_ON_STOP'),value:'onVideoStop'},]});triggerWhenDoIt.add(triggerActionModelQuestions);break;default:break;}
return triggerWhenDoIt.toJSON();}});;;var QuizModel=ExerciseComponentModel.extend({defaults:function(){return _.extend({},ExerciseComponentModel.prototype.defaults(),{type:"quiz",action:99,width:400,height:200,backgroundColor:'',textColor:'',buttonBackgroundColor:'',buttonTextColor:'',feedbackShow:true,feedbackSign:true,buttonShow:true,feedbackGood:_lang('FEEDBACK_GOOD_DEFAULT'),feedbackBad:_lang('FEEDBACK_BAD_DEFAULT'),multiselect:true,incrementQuestion:2,attempts:'','premade-style':'qmulti-template-default',submitButton:{left:275,top:120,text:_lang('QMULTI_SUBMIT_LBL')},answers:{'#0':{text:_lang('QMULTI_ANSWER_LBL')+' 1',goodAnswer:true,left:50,top:30,choosen:false},'#1':{text:_lang('QMULTI_ANSWER_LBL')+' 2',goodAnswer:false,left:50,top:65,choosen:false}},scoreSuccess:0,scoreFail:0,scoreBadAnswer:0,markQuestions:true,reportName:'',fontSize:16})},createStylesObject:function(){var styles={"quiz-body":{"background":"rgba(0, 0, 0, 0.7)","border-radius":"10px","color":"#fff"},"quiz-submit-button":{"background":"#5082A5","color":"#fff","border":"none"}};return styles;}});var QuizRadioModel=ExerciseComponentModel.extend({defaults:function(){return _.extend({},ExerciseComponentModel.prototype.defaults(),{type:"quiz",action:99,width:400,height:200,backgroundColor:'',textColor:'',buttonBackgroundColor:'',buttonTextColor:'',feedbackShow:true,feedbackSign:true,buttonShow:true,feedbackGood:_lang('FEEDBACK_GOOD_DEFAULT'),feedbackBad:_lang('FEEDBACK_BAD_DEFAULT'),multiselect:false,incrementQuestion:2,attempts:'','premade-style':'qmulti-template-default',submitButton:{left:275,top:120,text:_lang('QMULTI_SUBMIT_LBL')},answers:{'#0':{text:_lang('QMULTI_ANSWER_LBL')+' 1',goodAnswer:true,left:50,top:30,choosen:false},'#1':{text:_lang('QMULTI_ANSWER_LBL')+' 2',goodAnswer:false,left:50,top:65,choosen:false}},markQuestions:true,fontSize:16})},createStylesObject:function(){var styles={"quiz-body":{"background":"rgba(0, 0, 0, 0.7)","border-radius":"10px","color":"#fff"},"quiz-submit-button":{"background":"#5082A5","color":"#fff","border":"none"}};return styles;}});var QuizTrueFalseModel=ExerciseComponentModel.extend({defaults:function(){return _.extend({},ExerciseComponentModel.prototype.defaults(),{type:"quiz",action:99,width:400,height:200,backgroundColor:'',textColor:'',buttonBackgroundColor:'',buttonTextColor:'',feedbackShow:true,feedbackSign:true,buttonShow:true,feedbackGood:_lang('FEEDBACK_GOOD_DEFAULT'),feedbackBad:_lang('FEEDBACK_BAD_DEFAULT'),multiselect:false,incrementQuestion:2,attempts:'','premade-style':'qmulti-template-default',submitButton:{left:275,top:120,text:_lang('QMULTI_SUBMIT_LBL')},answers:{'#0':{text:_lang('QMULTI_TRUE'),goodAnswer:true,left:50,top:30,choosen:false},'#1':{text:_lang('QMULTI_FALSE'),goodAnswer:false,left:50,top:65,choosen:false}},markQuestions:true,fontSize:16})},createStylesObject:function(){var styles={"quiz-body":{"background":"rgba(0, 0, 0, 0.7)","border-radius":"10px","color":"#fff"},"quiz-submit-button":{"background":"#5082A5","color":"#fff","border":"none"}};return styles;}});var QuizSelectOneModel=ExerciseComponentModel.extend({defaults:function(){return _.extend({},ExerciseComponentModel.prototype.defaults(),{type:"quiz-selectone",action:99,width:700,height:150,backgroundColor:'',textColor:'',buttonBackgroundColor:'',buttonTextColor:'',feedbackShow:true,feedbackSign:true,buttonShow:true,feedbackGood:_lang('FEEDBACK_GOOD_DEFAULT'),feedbackBad:_lang('FEEDBACK_BAD_DEFAULT'),multiselect:true,incrementQuestion:2,attempts:'','premade-style':'selectone-template-default',answers:{'#0':{text:_lang('QMULTI_TRUE'),goodAnswer:true,left:50,top:50,choosen:false},'#1':{text:_lang('QMULTI_FALSE'),goodAnswer:false,left:400,top:50,choosen:false}},markQuestions:true,fontSize:16})},createStylesObject:function(){var styles={"quiz-body":{"background":"rgba(0, 0, 0, 0.7)","border-radius":"10px","color":"#000"},"quiz-submit-button":{"background":"#5082A5","color":"#000","border":"none"}};return styles;}});;;var QuizFillInBlanksModel=ExerciseComponentModel.extend({defaults:function(){return _.extend({},ExerciseComponentModel.prototype.defaults(),{type:"quiz-fillinblanks",action:99,width:300,height:120,backgroundColor:'',textColor:'',buttonBackgroundColor:'',buttonTextColor:'',feedbackShow:true,feedbackSign:true,buttonShow:true,feedbackGood:'',feedbackBad:'',multiselect:true,incrementQuestion:2,answers:{'#1':{placeholder:'',type:'input',goodanswers:[{text:'darkan',iscorrect:true}]}},scoreSuccess:0,scoreFail:0,scoreBadAnswer:0,feedbackGood:_lang('FEEDBACK_GOOD_DEFAULT'),feedbackBad:_lang('FEEDBACK_BAD_DEFAULT'),markQuestions:false,reportName:'',padding:10,contents:'<span style="font-size:18px">'+_lang('SIMPLETEXT_INSERTTEXT')+' <input aid="1"></span>','enable-scrollbar':false,bgcolor:'',checkSelf:false})},setTextEditor:function(el){this.trigger('set-text-editor',el);}});;;var QuizDnDModel=ExerciseComponentModel.extend({defaults:function(){return _.extend({},ExerciseComponentModel.prototype.defaults(),{type:"quiz-dnd",action:99,width:150,height:50,buttonTitle:_lang('QMULTI_SUBMIT_LBL'),'premade-style':'dnd-template-default',feedbackGood:_lang('FEEDBACK_GOOD_DEFAULT'),feedbackBad:_lang('FEEDBACK_BAD_DEFAULT'),attempts:'',feedbackShow:true,feedbackSign:true,answers:{"ghjghj":[]},userSelection:{},draggableObjs:[],opts:{disableOnGoodDrop:false,feedbacks:true,revertObjects:true},scoreSuccess:0,scoreFail:0,scoreBadAnswer:0,padding:10,contents:'<div style="text-align:center"><span style="font-size:18px">'+_lang('QMULTI_SUBMIT_LBL')+'</span></div>','enable-scrollbar':false,bgcolor:'',markQuestions:true,reportName:''})},createStylesObject:function(){var styles={'component-inner':{'background':'#5082A5','color':'#fff','border':0}};return styles;}});;;var QuizConnectLinesModel=ExerciseComponentModel.extend({defaults:function(){return _.extend({},ComponentModel.prototype.defaults(),{type:"quiz-connectlines",action:99,width:150,height:50,buttonTitle:_lang('QMULTI_SUBMIT_LBL'),'premade-style':'dnd-template-default',feedbackGood:_lang('FEEDBACK_GOOD_DEFAULT'),feedbackBad:_lang('FEEDBACK_BAD_DEFAULT'),attempts:'',feedbackShow:true,feedbackSign:true,answers:[],objs:{},opts:{afterBadAnswer:'donothing',allowBadAnswers:true,feedbacks:true,onlySourceTarget:false},scoreSuccess:0,scoreFail:0,scoreBadAnswer:0,padding:10,contents:'<div style="text-align:center"><span style="font-size:18px">'+_lang('QMULTI_SUBMIT_LBL')+'</span></div>','enable-scrollbar':false,bgcolor:'',markQuestions:false,reportName:''})},createStylesObject:function(){var styles={'component-inner':{'background':'#5082A5','color':'#fff','border':0}};return styles;}});;;var QuizWordsearchModel=ExerciseComponentModel.extend({activeCellID:'0-0',editingMode:false,defaults:function(){return _.extend({},ComponentModel.prototype.defaults(),{type:"quiz-wordsearch",action:99,width:200,height:150,answers:[{objs:[],opts:[]}],objs:{'0-0':'','0-1':'','0-2':'','0-3':'','1-0':'','1-1':'','1-2':'','1-3':'','2-0':'','2-1':'','2-2':'','2-3':''},minAnswersNumber:1,requireAnswersToAllQuestions:true,timeLimitOption:false,varToChange:'',wordSearchTimeOut:0,userSelection:{},scoreSuccess:0,scoreFail:0,scoreBadAnswer:0,feedbackGood:_lang('FEEDBACK_GOOD_DEFAULT'),feedbackBad:_lang('FEEDBACK_BAD_DEFAULT'),markQuestions:false,reportName:''})},setActieCellID:function(cellID){this.trigger('set-active-cell-id',cellID,this);},getTriggerWhenDoIt:function(){var triggerWhenDoIt=new TriggerActionsCollection();var triggerActionModelQuestions=new TriggerActionModel({group:_lang('TRIGGER_EVENT_QUESTION'),options:[{name:_lang('TRIGGER_EVENT_QUESTION_PASSED'),value:'custom_questionpassed'},{name:_lang('TRIGGER_EVENT_QUESTION_FAILED'),value:'custom_questionfailed'},{name:_lang('TRIGGER_EVENT_ON_WORD_SELECTED_CORRECT'),value:'onWordSelectedCorrect'},]});triggerWhenDoIt.add(triggerActionModelQuestions);var triggerActionModelTimeline=new TriggerActionModel({group:_lang('TRIGGER_EVENT_TIMELINE'),options:[{name:_lang('TRIGGER_EVENT_ON_SHOW'),value:'onShow'},{name:_lang('TRIGGER_EVENT_ON_HIDE'),value:'onHide'}]});triggerWhenDoIt.add(triggerActionModelTimeline);return triggerWhenDoIt.toJSON();}});;;var ScrollerModel=ComponentModel.extend({defaults:function(){return _.extend({},ComponentModel.prototype.defaults(),{type:"scroller",action:99,width:30,height:30,adv:'none',scrollTime:2})},pastePosition:function(dimensions){},pasteDimension:function(dimensions){},pasteTrigger:function(dimensions){},pasteStyle:function(dimensions){}});;;var CrosswordModel=ExerciseComponentModel.extend({activeCellID:'0-0',imagesExtensions:[],soundsExtensions:[],defaults:function(){return _.extend({},ComponentModel.prototype.defaults(),{type:"crossword",action:99,width:200,height:150,colorizeCrosswordAfterWriteLastWord:false,colorizeGoodAnswer:true,colorizeGoodWord:true,fieldType:'text',minAnswersNumber:1,ob:{},objs:{'0-0':{type:'answer',text:'',gender:'',opts:{questionType:'text',soundFile:'',imageFile:''}},'0-1':{type:'answer',text:'',gender:'',opts:{questionType:'text',soundFile:'',imageFile:''}},'0-2':{type:'answer',text:'',gender:'',opts:{questionType:'text',soundFile:'',imageFile:''}},'0-3':{type:'answer',text:'',gender:'',opts:{questionType:'text',soundFile:'',imageFile:''}},'1-0':{type:'answer',text:'',gender:'',opts:{questionType:'text',soundFile:'',imageFile:''}},'1-1':{type:'answer',text:'',gender:'',opts:{questionType:'text',soundFile:'',imageFile:''}},'1-2':{type:'answer',text:'',gender:'',opts:{questionType:'text',soundFile:'',imageFile:''}},'1-3':{type:'answer',text:'',gender:'',opts:{questionType:'text',soundFile:'',imageFile:''}},'2-0':{type:'answer',text:'',gender:'',opts:{questionType:'text',soundFile:'',imageFile:''}},'2-1':{type:'answer',text:'',gender:'',opts:{questionType:'text',soundFile:'',imageFile:''}},'2-2':{type:'answer',text:'',gender:'',opts:{questionType:'text',soundFile:'',imageFile:''}},'2-3':{type:'answer',text:'',gender:'',opts:{questionType:'text',soundFile:'',imageFile:''}}},opts:{},qcrosswordTimeout:0,requireAnswersToAllQuestions:true,timeLimitOption:false,varToChange:'',userSelection:{},scoreSuccess:0,scoreFail:0,scoreBadAnswer:0,feedbackGood:_lang('FEEDBACK_GOOD_DEFAULT'),feedbackBad:_lang('FEEDBACK_BAD_DEFAULT'),markQuestions:false,reportName:''})},setActieCellID:function(cellID){this.trigger('set-active-cell-id',cellID,this);},uploadImage:function(data){this.trigger('upload-image',data);},uploadSound:function(data){this.trigger('upload-sound',data);},setFileName:function(data){var objs=this.get('objs');objs[this.activeCellID].opts.imageFile=data.fileName;this.set('objs',objs);this.trigger('change');},setSoundFileName:function(data){var objs=this.get('objs');objs[this.activeCellID].opts.soundFile=data.fileName;this.set('objs',objs);this.trigger('change');},getAcceptTypeFormat:function(){var _mainTypes=this.getExtensionImagesArray();var _soundTypes=this.getExtensionSoundsArray();var acceptTypeString='';_.each(_mainTypes,function(option){acceptTypeString+='.'+option+',';});_.each(_soundTypes,function(option){acceptTypeString+='.'+option+',';});return acceptTypeString;},getExtensionImagesArray:function(){return this.imagesExtensions;},getExtensionSoundsArray:function(){return this.soundsExtensions;}});;;var FormInputTextModel=ComponentModel.extend({defaults:function(){return _.extend({},ComponentModel.prototype.defaults(),{type:"form-inputtext",action:99,width:200,height:35,inputvalue:'',placeholder:'',defaultValue:'',goodAnswers:'',caseSensitive:false,fontSize:14,maxLength:100,textAlign:'left',checkSelf:false,scoreSuccess:0,scoreFail:0,scoreBadAnswer:0,feedbackGood:_lang('FEEDBACK_GOOD_DEFAULT'),feedbackBad:_lang('FEEDBACK_BAD_DEFAULT'),feedbackShow:false,reportName:''})}});;;var FormUploadModel=ImageModel.extend({defaults:function(){return _.extend({},ComponentModel.prototype.defaults(),{type:"form-upload",action:99,width:100,height:100,imageFileName:'',library:'buttons/link',rand:0,opacity:1,goodExtensions:''})},});;;var QuizInputTextModel=ExerciseComponentModel.extend({defaults:function(){return _.extend({},ComponentModel.prototype.defaults(),{type:"quiz-inputtext",action:99,width:200,height:35,inputvalue:'',placeholder:'',defaultValue:'',goodAnswers:'',caseSensitive:false,fontSize:14,maxLength:100,textAlign:'left',checkSelf:true,scoreSuccess:0,scoreFail:0,scoreBadAnswer:0,feedbackGood:_lang('FEEDBACK_GOOD_DEFAULT'),feedbackBad:_lang('FEEDBACK_BAD_DEFAULT'),feedbackShow:false,markQuestions:true,reportName:''})}});;;var FormTextareaModel=ComponentModel.extend({defaults:function(){return _.extend({},ComponentModel.prototype.defaults(),{type:"form-textarea",action:99,width:200,height:70,inputvalue:'',placeholder:'',defaultValue:'',goodAnswers:'',caseSensitive:false,fontSize:14,maxLength:100,textAlign:'left',checkSelf:false,scoreSuccess:0,scoreFail:0,scoreBadAnswer:0,feedbackGood:_lang('FEEDBACK_GOOD_DEFAULT'),feedbackBad:_lang('FEEDBACK_BAD_DEFAULT'),feedbackShow:false,reportName:''})}});;;var FormCheckboxModel=ComponentModel.extend({defaults:function(){return _.extend({},ComponentModel.prototype.defaults(),{type:"form-checkbox",action:99,width:320,height:25,contents:'<span style="font-size:18px">'+_lang('SIMPLETEXT_INSERTTEXT')+'</span>',inputSize:25,correctValue:false,defaultValue:false,groupName:'default',checkSelf:false,scoreSuccess:0,scoreFail:0,scoreBadAnswer:0,feedbackGood:_lang('FEEDBACK_GOOD_DEFAULT'),feedbackBad:_lang('FEEDBACK_BAD_DEFAULT'),feedbackShow:false,reportName:''})}});;;var FormRadioModel=ComponentModel.extend({defaults:function(){return _.extend({},ComponentModel.prototype.defaults(),{type:"form-radio",action:99,width:320,height:25,contents:'<span style="font-size:18px">'+_lang('SIMPLETEXT_INSERTTEXT')+'</span>',inputSize:25,correctValue:false,defaultValue:false,groupName:'default',checkSelf:false,scoreSuccess:0,scoreFail:0,scoreBadAnswer:0,feedbackGood:_lang('FEEDBACK_GOOD_DEFAULT'),feedbackBad:_lang('FEEDBACK_BAD_DEFAULT'),feedbackShow:false,reportName:''})}});;;var FormSelectModel=ComponentModel.extend({defaults:function(){return _.extend({},ComponentModel.prototype.defaults(),{type:"form-select",action:99,width:200,height:35,inputvalue:'',defaultValue:'',fontSize:14,formData:{selectOptions:[{option:_lang('FORM_SELECT_NEWOPTION'),require:false,startValue:true}]},checkSelf:false,scoreSuccess:0,scoreFail:0,scoreBadAnswer:0,feedbackGood:_lang('FEEDBACK_GOOD_DEFAULT'),feedbackBad:_lang('FEEDBACK_BAD_DEFAULT'),feedbackShow:false,reportName:''})}});;;var QuizSelectModel=ExerciseComponentModel.extend({defaults:function(){return _.extend({},ComponentModel.prototype.defaults(),{type:"quiz-select",action:99,width:200,height:35,inputvalue:'',defaultValue:'',fontSize:14,formData:{selectOptions:[{option:_lang('FORM_SELECT_NEWOPTION'),require:false,startValue:true}]},checkSelf:true,scoreSuccess:0,scoreFail:0,scoreBadAnswer:0,feedbackGood:_lang('FEEDBACK_GOOD_DEFAULT'),feedbackBad:_lang('FEEDBACK_BAD_DEFAULT'),feedbackShow:false,markQuestions:true,reportName:''})}});;;var FormSubmitModel=ExerciseComponentModel.extend({defaults:function(){return _.extend({},ComponentModel.prototype.defaults(),{type:"form-submit",action:99,width:180,height:45,buttonTitle:_lang('QMULTI_SUBMIT_LBL'),feedbacks:true,feedbackShow:true,feedbackGood:_lang('FEEDBACK_GOOD_DEFAULT'),feedbackBad:_lang('FEEDBACK_BAD_DEFAULT'),formFields:[],'premade-style':'dnd-template-default',padding:10,contents:'<div style="text-align:center"><span style="font-size:18px">'+_lang('QMULTI_SUBMIT_LBL')+'</span></div>','enable-scrollbar':false,bgcolor:'',reportName:''})},createStylesObject:function(){var styles={'component-inner':{'background':'#5082A5','color':'#fff','border':0}};return styles;},getTriggerWhenDoIt:function(){var triggerWhenDoIt=new TriggerActionsCollection();var triggerActionModelQuestions=new TriggerActionModel({group:_lang('TRIGGER_EVENT_QUESTION'),options:[{name:_lang('TRIGGER_EVENT_QUESTIONS_PASSED'),value:'custom_questionpassed'},{name:_lang('TRIGGER_EVENT_QUESTIONS_FAILED'),value:'custom_questionfailed'}]});triggerWhenDoIt.add(triggerActionModelQuestions);var triggerActionModelTimeline=new TriggerActionModel({group:_lang('TRIGGER_EVENT_TIMELINE'),options:[{name:_lang('TRIGGER_EVENT_ON_SHOW'),value:'onShow'},{name:_lang('TRIGGER_EVENT_ON_HIDE'),value:'onHide'}]});triggerWhenDoIt.add(triggerActionModelTimeline);return triggerWhenDoIt.toJSON();}});;;var IframeModel=ComponentModel.extend({defaults:function(){return _.extend({},ComponentModel.prototype.defaults(),{type:"iframe",action:99,width:150,height:100,link:''})}});;;var SwfModel=ComponentModel.extend({defaults:function(){return _.extend({},ComponentModel.prototype.defaults(),{type:"swf",action:99,width:100,height:100,swfFileName:''})},setFileName:function(data){this.set('swfFileName',data.fileName);},getExtensionSwfArray:function(){return['swf'];},getAcceptTypeFormat:function(){var _mainTypes=this.getExtensionSwfArray();var _soundTypes=this.getExtensionSoundsArray();var acceptTypeString='';_.each(_mainTypes,function(option){acceptTypeString+='.'+option+',';});_.each(_soundTypes,function(option){acceptTypeString+='.'+option+',';});return acceptTypeString;}});;;var InfoPointPopupModel=ImageModel.extend({defaults:function(){return _.extend({},ComponentModel.prototype.defaults(),{type:"infopoint-popup",action:99,width:100,height:100,title:_lang('INFOPOINT_POPUP_TITLE_DEFAULT'),text:_lang('INFOPOINT_POPUP_MESSAGE_DEFAULT'),imageFileName:'',library:'buttons/info',rand:0,opacity:1})},});;;var InfoPointLinkModel=ImageModel.extend({defaults:function(){return _.extend({},ComponentModel.prototype.defaults(),{type:"infopoint-link",action:99,width:100,height:100,link:'',openInIframe:false,imageFileName:'',library:'buttons/link',rand:0,opacity:1})},});;;var InfoPointSoundModel=ImageModel.extend({defaults:function(){return _.extend({},ComponentModel.prototype.defaults(),{type:"infopoint-sound",action:99,width:100,height:100,sound:'',autoplaySound:false,imageFileName:'',library:'buttons/sound',rand:0,opacity:1})},setFileName:function(data){this.set('soundFileName',data.fileName);},getExtensioAudioArray:function(){return['mp3'];},getAcceptTypeFormat:function(){var _soundTypes=this.getExtensionSoundsArray();var acceptTypeString='';_.each(_soundTypes,function(option){acceptTypeString+='.'+option+',';});return acceptTypeString;},setComponentAsSound:function(){var _that=this;this.getExtensionImagesArray=function(){return[];}
this.getExtensioAudioArray=function(){return['mp3'];}
this.setFileName=function(data){_that.set('soundFileName',data.fileName);}},});;;var InfoPointSoundControlModel=ImageModel.extend({defaults:function(){return _.extend({},ComponentModel.prototype.defaults(),{type:"infopoint-sound-control",action:99,width:520,height:90,sound:'',autoplaySound:false,rand:0,opacity:1,noskin:false})},setFileName:function(data){this.set('soundFileName',data.fileName);},getExtensioAudioArray:function(){return['mp3'];},getAcceptTypeFormat:function(){var _soundTypes=this.getExtensionSoundsArray();var acceptTypeString='';_.each(_soundTypes,function(option){acceptTypeString+='.'+option+',';});return acceptTypeString;},setComponentAsSound:function(){var _that=this;this.getExtensionImagesArray=function(){return[];}
this.getExtensioAudioArray=function(){return['mp3'];}
this.setFileName=function(data){_that.set('soundFileName',data.fileName);}},});;;var InfoPointSoundRecordModel=ImageModel.extend({defaults:function(){return _.extend({},ComponentModel.prototype.defaults(),{type:"infopoint-soundrecord",action:99,width:100,height:100,imageFileName:'',library:'',rand:0,opacity:1})},});;;var InfoPointGalleryModel=ImageModel.extend({defaults:function(){return _.extend({},ComponentModel.prototype.defaults(),{type:"infopoint-gallery",action:99,width:100,height:100,imageFileName:'',library:'buttons/gallery',rand:0,opacity:1})},afterInitialize:function(){var galleryFiles=this.get('galleryFiles');if(!galleryFiles){this.set('galleryFiles',[],{silent:true});}},setGalleryFile:function(){this.trigger('set-gallery-file');},setFileName:function(galleryFiles){this.set('galleryFiles',galleryFiles);},setComponentAsGallery:function(){var _that=this;this.getExtensionImagesArray=function(){return[];}
this.getExtensionGalleryArray=function(){return['jpg','png','gif','JPG','JPEG','jpeg'];}
this.setFileName=function(galleryFiles){_that.set('galleryFiles',galleryFiles);}},getExtensionGalleryArray:function(){return['jpg','png','gif','JPG','JPEG','jpeg'];},getAcceptTypeFormat:function(){var _mainTypes=this.getExtensionGalleryArray();var _soundTypes=this.getExtensionSoundsArray();var acceptTypeString='';_.each(_mainTypes,function(option){acceptTypeString+='.'+option+',';});_.each(_soundTypes,function(option){acceptTypeString+='.'+option+',';});return acceptTypeString;},});;;var InfoPointDownloadModel=ImageModel.extend({defaults:function(){return _.extend({},ComponentModel.prototype.defaults(),{type:"infopoint-download",action:99,width:100,height:100,sound:'',fileToDownload:'',imageFileName:'',library:'buttons/download',rand:0,opacity:1})},getExtensionFilesArray:function(){return['zip','rar','pdf','jpg','png','gif','JPG','JPEG','jpeg','mp3','doc','docx','xls','xlsx','dot','ppt','pptx','assdb','mdb','rtf','odt','dot','mdt','accda','odt','ods','odp'];},getAcceptTypeFormat:function(){var _mainTypes=this.getExtensionFilesArray();var _soundTypes=this.getExtensionSoundsArray();var acceptTypeString='';_.each(_mainTypes,function(option){acceptTypeString+='.'+option+',';});_.each(_soundTypes,function(option){acceptTypeString+='.'+option+',';});return acceptTypeString;},setFileName:function(data){this.set('fileToDownload',data.fileName);},setComponentAsDownload:function(){var _that=this;this.getExtensionImagesArray=function(){return[];}
this.getExtensionFilesArray=function(){return['zip','rar','pdf','jpg','png','gif','JPG','JPEG','jpeg','mp3','doc','docx','xls','xlsx','dot','ppt','pptx','assdb','mdb','rtf','odt','dot','mdt','accda','odt','ods','odp'];}
this.setFileName=function(data){_that.set('fileToDownload',data.fileName);}},});;;var DrawedInfoPointLinkModel=InfoPointLinkModel.extend({defaults:function(){return _.extend({},InfoPointLinkModel.prototype.defaults(),{type:"drawedinfopoint-link",action:99,width:150,height:100,activeBorderColor:'#A80000',deactiveBorderColor:'#00FF33',showShadow:false,borderSize:2})}});;;var DrawedInfoPointDownloadModel=InfoPointDownloadModel.extend({defaults:function(){return _.extend({},InfoPointDownloadModel.prototype.defaults(),{type:"drawedinfopoint-download",action:99,width:150,height:100,activeBorderColor:'#A80000',deactiveBorderColor:'#00FF33',showShadow:false,borderSize:2})}});;;var DrawedInfoPointGalleryModel=InfoPointGalleryModel.extend({defaults:function(){return _.extend({},InfoPointGalleryModel.prototype.defaults(),{type:"drawedinfopoint-gallery",action:99,width:150,height:100,activeBorderColor:'#A80000',deactiveBorderColor:'#00FF33',showShadow:false,borderSize:2})}});;;var DrawedInfoPointPopupModel=InfoPointPopupModel.extend({defaults:function(){return _.extend({},InfoPointPopupModel.prototype.defaults(),{type:"drawedinfopoint-popup",action:99,width:150,height:100,activeBorderColor:'#A80000',deactiveBorderColor:'#00FF33',showShadow:false,borderSize:2})}});;;var TimerModel=TextModel.extend({defaults:function(){return _.extend({},ComponentModel.prototype.defaults(),{type:"timer",width:160,height:70,padding:10,contents:'<span name="hours" style="font-size:30px">00</span>                       <span name="separator-hours" style="font-size:30px"></span>                       <span name="minutes" style="font-size:30px">00</span>                       <span name="separator-minutes" style="font-size:30px"></span>                       <span name="seconds" style="font-size:30px">00</span>','enable-scrollbar':false,bgcolor:'',hours:0,minutes:5,seconds:30,hoursEnabled:true,minutesEnabled:true,secondsEnabled:true,counterAutostart:true,timerId:""})},onActionkeySet:function(){var actionkey=this.get('actionkey');var prefix=actionkey.split("-");var timerId=this.get('timerId');this.set('timerId','timer-'+prefix[1]+"-"+prefix[2],{silent:true});},getTriggerWhenDoIt:function(){var triggerWhenDoIt=new TriggerActionsCollection();var triggerActionModel=new TriggerActionsCollection();var triggerActionModel=new TriggerActionModel({group:'Timer',options:[{name:_lang('TIMER_ON_TIMER_COMPLETE'),value:'onTimerComplete'},{name:_lang('TIMER_ON_TIMER_TICK'),value:'onTimerTick'}]});triggerWhenDoIt.add(triggerActionModel);return triggerWhenDoIt.toJSON();},getTriggerWhatToDo:function(){return[];}});;;var QuizResultModel=TextModel.extend({defaults:function(){return _.extend({},ComponentModel.prototype.defaults(),{type:"quiz-result",action:99,width:380,height:120,padding:10,contents:'<span style="font-size:18px">'+_lang('_score')+': {%_score%}</span><br><span style="font-size:18px">'+_lang('_maxscore')+': {%_maxscore%}</span><br><span style="font-size:18px">'+_lang('_percentscore')+': {%_percentscore%}%</span>','enable-scrollbar':false,bgcolor:'',backgroundColor:'',textColor:'',feedbackGood:_lang('FEEDBACK_GOOD_DEFAULT'),feedbackBad:_lang('FEEDBACK_BAD_DEFAULT'),markQuestions:true})}});;;var ComponentView=ItemView.extend({tagName:'div',className:'component test-component',multiSelectedComponentsModels:null,isRotatable:false,transformTool:{el:undefined,exists:false},events:{'mousedown':'onMouseDown','mouseup':'onMouseUp','multi-select':'multiSelect','click':'onMouseClick','dragenter':'onFileDragOver','dragleave .loaded-dropzone':'onFileDragOut','drop .loaded-dropzone':'uploadOnFileDrop'},bindings:{'[name="type"]':'type','[name="position-x"]':'x','[name="position-y"]':'y','[name="width"]':'width','[name="height"]':'height'},template:_.template($('#component-template').html()),isEditing:false,initialize:function(data){var _that=this;this.model.view=this;this.addListeners();this.addComponentListeners();this.addEventsToModel();this.addEventsToView();this.$el.off('data-picker-picked-object');this.$el.on('data-picker-picked-object',function(){_that.dataPickerPicked();});this.$el.off('data-picker-picked-exercise');this.$el.on('data-picker-picked-exercise',function(){_that.dataPickerPicked();});this.$el.off('data-picker-picked-timer');this.$el.on('data-picker-picked-timer',function(){_that.dataPickerPicked();});this.$el.off('data-picker-picked-video');this.$el.on('data-picker-picked-video',function(){_that.dataPickerPicked();});this.$el.off('data-picker-picked-text');this.$el.on('data-picker-picked-text',function(){_that.dataPickerPicked();});this.afterInitialize();},onMouseClick:function(e){},darkenComponent:function(){this.$el.css({opacity:'.5'});this.$el.addClass('darkenComponent');},unDarkenComponent:function(){this.$el.css({opacity:'1'});this.$el.removeClass('darkenComponent');},addBorder:function(){var borderWindow=WindowFactory.createBorderWindow();$('body').append(borderWindow.render().$el);borderWindow.setWindowPosition();},onMouseDown:function(e){e.stopPropagation();ContextMenuContainer.closeMenu();if(document.activeElement!=undefined){if(document.activeElement.localName==='input'||document.activeElement.localName==='textarea'){document.activeElement.blur();}}
switch(e.button){case 0:this.mouseDown(e);break;case 1:this.scroll(e);break;case 2:if(this.model.get('locked')){StageView.instance.showContextMenu(e);return;}
this.mouseDown(e);this.showContextMenu(e);break;}},afterInitialize:function(){return false;},addEventsToView:function(){var _that=this;this.$el.off("multi-select");this.$el.on("multi-select",function(){_that.multiSelect();});},addEventsToModel:function(){var _that=this;this.model.off("change");this.model.on("change",function(e){_that.trigger('save-changes',_that.model,e);StageView.instance.model.updateDinamicPageThumb();});this.model.off("set-active");this.model.on("set-active",function(active,multiSelectedModels,params){_that.multiSelectedComponentsModels=multiSelectedModels;if(_that.multiSelectedComponentsModels!=undefined){_that.multiSelectedComponentsModels.each(function(componetModel){componetModel.startX=componetModel.get('x');componetModel.startY=componetModel.get('y');});}
_that.renderActive(active,params);_that.active=active;});this.model.off("set-zindex");this.model.on("set-zindex",function(zIndex){_that.renderZIndex(zIndex);});this.model.off("update-coming");this.model.on("update-coming",function(options){_that.updateComing();});this.model.off("selected-by-miniature");this.model.on("selected-by-miniature",this.renderSelectByMinaiture,this);this.model.off("selected-by-picker-miniature-1");this.model.on("selected-by-picker-miniature-1",this.renderSelectByPickerMinaiture,this);this.model.off("selected-by-trigger");this.model.on("selected-by-trigger",function(value){_that.renderSelectByTrigger(value);});this.model.off("force-render");this.model.on("force-render",function(){_that.forceRender();});this.model.off("locked-render");this.model.on("locked-render",function(){_that.renderLocked();});this.model.off("disable-component");this.model.on("disable-component",function(){_that.renderDisabled();});},updateComing:function(){var _that=this;if(_that.$el.is('.ui-resizable')){_that.$el.resizable("destroy");}
_that.specificUpdateComing();_that.model.trigger('update-editor',_that.model,this);_that.render();},specificUpdateComing:function(){},forceRender:function(){this.render();this.afterRender();this.unselectComponent();this.selectComponent();},renderLocked:function(){var locked=this.model.get('locked');this.$el.attr('locked',locked);if(locked){this.resizableDestroy();this.draggableDestroy();}else{this.makeDraggable();}},renderDisabled:function(){this.$el.css('opacity','0.5');},renderStyle:function(className){var _that=this;var styles=this.model.get('styles');_.each(styles,function(style,className){_that.$el.find('.'+className).css(styles[className]);});this.onRenderStyle();},changeRenderStyles:function(){this.renderStyle();this.render();this.afterRender();this.resizableDestroy();this.makeResizable();},onRenderStyle:function(){},renderSelectByTrigger:function(value){this.$el.attr('selected-by-trigger',value);},renderSelectByPickerMinaiture:function(value){this.$el.attr('selected-by-miniature',value);},renderSelectByMinaiture:function(value){this.$el.attr('selected-by-miniature',value);_log('renderSelectByMinaiture component',value,_log.error);},renderSelectedBy:function(selectedBy,user){var selected=selectedBy.length>0?true:false;if(selected){this.$el.attr('selected-by',true);this.$el.attr('user',selectedBy);}else{this.$el.attr('selected-by',false);this.$el.attr('user',selectedBy);}
_log('renderSelectedBy c selectedBy',selectedBy);},multiSelect:function(){this.trigger('multi-select',this.model);},dataPickerPicked:function(){this.trigger('data-picker-picked-object',this.model,this);},mouseDown:function(e){_log('mouseDown e',e)
if($(e.target).is('.ui-resizable-handle')){return;}
if(this.model.get('locked')){StageView.instance.onMouseDown(e,this.model);return;}
if(e.shiftKey){this.trigger('select-component',this.model,e);this.unstickit();}else{if(this.multiSelectedComponentsModels==null){this.trigger('select-component',this.model,e);this.unstickit();}}},showContextMenu:function(e){if(StageView.instance.selectedComponentsCollection.length>1){var contextMenuView=new MultiComponentContextMenuView({model:this.getModel(),view:this});ContextMenuContainer.addMenu(contextMenuView,e);}else{var contextMenuView=new ComponentContextMenuView({model:this.getModel(),view:this});ContextMenuContainer.addMenu(contextMenuView,e);}},selectComponent:function(){this.makeResizable();this.select();},unselectComponent:function(){this.resizableDestroy();this.beforeUnselect();this.unselect();},select:function(){},beforeUnselect:function(){},unselect:function(){},onMouseUp:function(e){if(e.which==3){return;}
if(StageView.instance.selectedComponentsCollection.length==1){return;}
if(this.model.get('x')!=this.model.startX||this.model.get('y')!=this.model.startY){}else{if(!e.shiftKey){this.trigger('select-component',this.model,e);}}
StageView.instance.selectedComponentsCollection.each(function(cModel){if(!cModel.get('locked')&&!cModel.get('hidden')){cModel.startX=cModel.get('x');cModel.startY=cModel.get('y');}});},addListeners:function(){this.listenTo(this.model,'change:x',this.renderXPosition);this.listenTo(this.model,'change:y',this.renderYPosition);this.listenTo(this.model,'change:width',this.renderWidth);this.listenTo(this.model,'change:height',this.renderHeight);this.listenTo(this.model,'change:styles',this.changeRenderStyles);this.listenTo(this.model,'change:point-sound',this.renderPointSound);this.listenTo(this.model,'change:locked',this.renderLocked);this.listenTo(this.model,'change:border',this.renderBorder);this.listenTo(this.model,'change:borderRadius',this.renderRadius);this.listenTo(this.model,'change:shadow',this.renderShadow);this.listenTo(this.model,'change:flipX',this.renderFlipX);this.listenTo(this.model,'change:flipY',this.renderFlipY);},renderBorder:function(){var styles=this.model.get('styles');var border={'border-top-width':typeof styles['component-inner']['border-top-width']!=='undefined'?styles['component-inner']['border-top-width']:'0px','border-left-width':typeof styles['component-inner']['border-left-width']!=='undefined'?styles['component-inner']['border-left-width']:'0px','border-right-width':typeof styles['component-inner']['border-right-width']!=='undefined'?styles['component-inner']['border-right-width']:'0px','border-bottom-width':typeof styles['component-inner']['border-bottom-width']!=='undefined'?styles['component-inner']['border-bottom-width']:'0px','border-color':typeof styles['component-inner']['border-color']!=='undefined'?styles['component-inner']['border-color']:'#000','border-style':typeof styles['component-inner']['border-style']!=='undefined'?styles['component-inner']['border-style']:'solid'};this.$el.find('.component-inner').css(border);},renderRadius:function(){var styles=this.model.get('styles');var borderRadius={'border-top-right-radius':typeof styles['component-inner']['border-top-right-radius']!=='undefined'?styles['component-inner']['border-top-right-radius']:'0px','border-top-left-radius':typeof styles['component-inner']['border-top-left-radius']!=='undefined'?styles['component-inner']['border-top-left-radius']:'0px','border-bottom-right-radius':typeof styles['component-inner']['border-bottom-right-radius']!=='undefined'?styles['component-inner']['border-bottom-right-radius']:'0px','border-bottom-left-radius':typeof styles['component-inner']['border-bottom-left-radius']!=='undefined'?styles['component-inner']['border-bottom-left-radius']:'0px'};this.$el.find('.component-inner').css(borderRadius);},renderShadow:function(){var styles=this.model.get('styles');if(typeof styles['component-inner']['box-shadow']!=='undefined'){this.$el.find('.component-inner').css('box-shadow',styles['component-inner']['box-shadow']);}
if(typeof styles['component-inner']['-webkit-box-shadow']!=='undefined'){this.$el.find('.component-inner').css('-webkit-box-shadow',styles['component-inner']['-webkit-box-shadow']);}
if(typeof styles['component-inner']['-moz-box-shadow']!=='undefined'){this.$el.find('.component-inner').css('-moz-box-shadow',styles['component-inner']['-moz-box-shadow']);}},addComponentListeners:function(){},renderZIndex:function(zIndex){this.$el.css('z-index',zIndex);},renderTriggers:function(){var triggers=this.model.get('triggers').length>0?true:false;this.$el.attr('triggers',triggers);},renderPointSound:function(){var sound=this.model.get('point-sound')==''?false:true;this.$el.attr('sound',sound);},renderActive:function(active,params){var display=active==true?'block':'none';this.$el.attr('active',active);this.$el.find('.ui-resizable-handle, .ui-rotatable-handle').css('display',display);if(active==true){this.selectComponent(params);}else{this.unselectComponent();}},renderWidth:function(){this.$el.css('width',this.model.get('width')+'px');},renderHeight:function(){this.$el.css('height',this.model.get('height')+'px');},renderXPosition:function(){this.$el.css('left',this.model.get('x')+'px');},renderYPosition:function(){this.$el.css('top',this.model.get('y')+'px');},beforeRender:function(){},renderForNotEditing:function(){},render:function(){_that=this;this.endEditing();this.beforeRender();this.model.setProportions();this.$el.html("");var componentTemplate=this.template(this.model.toJSON());this.$el.html(componentTemplate);var hidden=this.model.get('hidden');hidden?this.$el.attr('hidden','hidden'):this.$el.removeAttr('hidden');this.setPositionToComponent();this.makeDraggable();this.renderStyle();this.renderPointSound();this.renderTriggers();this.renderPath();this.renderFlip();this.renderRotate();this.renderLocked();this.renderSelectedBy(this.model.selectedBy||[]);this.stickit();this.renderForNotEditing();return this;},getElementToRotate:function(){var elementToRotate=this.$el.find('.component-inner');if(this.$el.find('.component-styles').push()>0){elementToRotate=this.$el.find('.component-styles');}
return elementToRotate;},renderRotate:function(){var angle=this.model.get('rotate')||0;var elementToRotate=this.getElementToRotate();elementToRotate.css('transform','rotate('+angle+'rad)');elementToRotate.css('-moz-transform','rotate('+angle+'rad)');elementToRotate.css('-webkit-transform','rotate('+angle+'rad)');elementToRotate.css('-o-transform','rotate('+angle+'rad)');},afterRender:function(){},renderPath:function(){},setPositionToComponent:function(){this.$el.css('position','absolute');this.$el.css('top',this.model.get('y')+'px');this.$el.css('left',this.model.get('x')+'px');this.$el.css('width',this.model.get('width')+'px');this.$el.css('height',this.model.get('height')+'px');},makeRotatable:function(){var _that=this;var elementToRotate=this.getElementToRotate();elementToRotate.rotatable({angle:_that.model.get('rotate'),rotate:function(e,rotateData){_that.model.set('rotate',rotateData.angle.current,{silent:true});_that.model.onComponentRotate(rotateData.angle.current);},stop:function(e,rotateData){_that.model.set('rotate',rotateData.angle.current);_that.model.onComponentRotate(rotateData.angle.current);_that.model.trigger('change');}});},rotatableDestroy:function(){if(this.$el.is('.ui-rotatable')){var elementToRotate=this.getElementToRotate();this.$el.rotatable("destroy");}},makeDraggable:function(data){if(!StageView.instance.canEdit){return;}
if(this.model.get('locked')){return;}
var _that=this;this.draggableTimeout=null;data=typeof data==='undefined'?{}:data;var axis=typeof data.axis!==undefined?data.axis:false;var handle='';switch(this.model.get('type')){case'text':case'timer':case'quiz-result':case'form-checkbox':case'form-radio':case'form-submit':case'quiz-connectlines':case'quiz-dnd':case'quiz-fillinblanks':case'infopoint-sound-control':handle='.text-component-handle';break;default:handle='';break;}
this.$el.draggable({cursor:'move',axis:axis,handle:handle,start:function(e,obj){e.stopPropagation();var $this=$(this);StageView.instance.selectedComponentsCollection.each(function(cModel){if(!cModel.get('locked')&&!cModel.get('hidden')){cModel.startX=cModel.get('x');cModel.startY=cModel.get('y');}});},stop:function(){var $this=$(this);var left=parseInt($this.css('left'));var top=parseInt($this.css('top'));_that.calculatePosition(left,top);_that.setPositionChanges(left,top);StageView.instance.selectedComponentsCollection.each(function(cModel){if(!cModel.get('hidden')){cModel.startX=cModel.get('x');cModel.startY=cModel.get('y');}});},drag:function(e){e.stopPropagation();var $this=$(this);var left=parseInt($this.css('left'));var top=parseInt($this.css('top'));_that.calculatePosition(left,top);_that.model.onComponentDrag({left:left,top:top});}});},moveComponent:function(e){var left=this.model.get('x');var top=this.model.get('y');var moveGrid=parseInt(ProjectModel.instance.get('options').get('move_grid'));switch(e.which){case 37:left-=moveGrid;break;case 39:left+=moveGrid;break;case 38:top-=moveGrid;break;case 40:top+=moveGrid;break;}
this.calculatePosition(left,top,true);this.setPositionChanges(left,top);this.model.onComponentDrag({left:left,top:top});},setPositionChanges:function(left,top){this.model.set({x:left,y:top},{silent:true});if(StageView.instance.selectedComponentsCollection!=null){StageView.instance.selectedComponentsCollection.each(function(cModel){if(!cModel.get('locked')&&!cModel.get('hidden')){cModel.set({x:cModel.get('x'),y:cModel.get('y')});}});}
this.model.trigger('change',['x','y']);},calculatePosition:function(left,top,takeSelf){var _that=this;if(StageView.instance.selectedComponentsCollection!=null){StageView.instance.selectedComponentsCollection.each(function(cModel){if(!cModel.get('locked')&&!cModel.get('hidden')){var calculatedX=cModel.startX+(left-_that.model.startX);var calculatedY=cModel.startY+(top-_that.model.startY);cModel.set('x',calculatedX,{silent:true});cModel.set('y',calculatedY,{silent:true});if(cModel.cid!=_that.model.cid){cModel.view.setPositionToComponent();}}});if(takeSelf==true){this.setPositionToComponent();}}},makeResizable:function(){var _that=this;if(!StageView.instance.canEdit){return;}
if(this.model.get('locked')){return;}
this.$el.resizable({handles:"n, e, s, w, nw, ne, sw, se",start:function(e){var aspectRatio=_that.model.get('aspectRatio');$(this).resizable("option","aspectRatio",aspectRatio);},resize:function(event,obj){_that.objectOnResize(event,$(obj.element));var width=parseInt($(this).css('width'));var height=parseInt($(this).css('height'));_that.model.onComponentResize({width:width,height:height})},stop:function(){var width=parseInt($(this).css('width'));var height=parseInt($(this).css('height'));var x=parseInt($(this).css('left'));var y=parseInt($(this).css('top'));_that.model.set({width:width,height:height,x:x,y:y},{silent:true});_that.model.setProportions();_that.model.trigger('change',['width','height','aspectRatioProportions']);_that.afterResize();}});this.makeRotatable();},afterResize:function(){},resizableDestroy:function(){if(this.$el.is('.ui-resizable')){this.$el.resizable("destroy");}
this.rotatableDestroy();},draggableDestroy:function(){if(this.$el.is('.ui-draggable')){this.$el.draggable("destroy");}},objectOnResize:function(event,obj){},getModel:function(){return this.model;},destroy:function(){_log('destroy',this);this.model.off();this.beforeDestroy();this.unselect();this.unbind();this.draggableDestroy();this.resizableDestroy();this.remove();},othersComponentsDestroyed:function(allComponentsCollection){this.model.trigger('other-components-destroyed');},beforeDestroy:function(){},checkIfCanEditing:function(){if(StageView.instance.selectedComponentsCollection.length>1||this.model.get('locked')||!StageView.instance.canEdit){return false;}else{return true;}},startEditing:function(){},endEditing:function(){},preventDragging:function(e){e.preventDefault();},renderFlipX:function(){this.renderFlip();},renderFlipY:function(){this.renderFlip();},renderFlip:function(){var flipX=this.model.get('flipX');var flipY=this.model.get('flipY');var componentInner=this.$el.find('.component-inner');componentInner.removeClass('xnormal-ynormal xflip-ynormal xnormal-yflip xflip-yflip');componentInner.addClass(flipX+'-'+flipY);},onComponentAdded:function(data){},copyComponentsFromOtherProject:function(){this.trigger('copy-components-from-other-project',this.model);},});ComponentView.createNotEditableComponentClass=function(Class){var component=Class.extend({makeDraggable:function(){},makeResizable:function(){},startEditing:function(){},endEditing:function(){},renderForNotEditing:function(){this.$el.find('.loaded-dropzone').remove();this.$el.find('.edit-component-button').remove();},renderActive:function(active){var display=active==true?'block':'none';this.$el.attr('active',active);this.$el.attr('selected-second',active);if(active==true){this.selectComponent();}else{this.unselectComponent();}},showContextMenu:function(e){if(this.multiSelectedComponentsModels.length>1){var contextMenuView=new MultiComponentContextMenuViewNotEditable({model:this.getModel(),view:this});ContextMenuContainer.addMenu(contextMenuView,e);}else{var contextMenuView=new ComponentContextMenuViewNotEditable({model:this.getModel(),view:this});ContextMenuContainer.addMenu(contextMenuView,e);}},});return component;};;var LoadedComponentView=ComponentView.extend({resizeImage:false,events:function(){return _.extend({},ComponentView.prototype.events,{'click .upload':'uploadOnClick','dragenter':'onFileDragOver','dragleave .loaded-dropzone':'onFileDragOut','drop .loaded-dropzone':'uploadOnFileDrop'});},onFileDragOver:function(e){if(!StageView.instance.canEdit){return;}
if(this.model.get('locked')){return;}
e.stopPropagation();this.$el.find('.loaded-dropzone').fadeIn(200);},onFileDragOut:function(e){if(!StageView.instance.canEdit){return;}
if(this.model.get('locked')){return;}
e.stopPropagation(e);this.$el.find('.loaded-dropzone').fadeOut(200);},getAcceptTypeFormat:function(){return this.model.getAcceptTypeFormat();},getDropProperties:function(e){return FileUploader.getDropProperties(e);},getInputProperties:function(e,input){return FileUploader.getInputProperties(e,input);},showImageWindow:function(){this.trigger('show-image-window',this)},uploadOnClick:function(){if(!StageView.instance.canEdit){return;}
var _that=this;var acceptTypeFormat=this.getAcceptTypeFormat();var input=$('<input type="file" name="files[]" accept="'+acceptTypeFormat+'">');input.css({display:'none'});this.$el.append(input);input.click();input.change(function(e){_that.uploadOnInputData(e,this,false);$(this).remove();});},uploadOnInputData:function(e,input,resizeImage){this.resizeImage=resizeImage;var properties=this.getInputProperties(e,input);this.runUploadProcess(properties);},uploadOnFileDrop:function(e,resizeImage){if(Utils.isDarkanExtension(e)){return;};e.stopPropagation(e);e.preventDefault();if(!StageView.instance.canEdit){return;}
this.resizeImage=resizeImage;this.$el.find('.loaded-dropzone').fadeOut(500);var properties=this.getDropProperties(e);this.runUploadProcess(properties);},runUploadProcess:function(properties){if(this.model.uploadingNow){return;}
_log('runUploadProcess',properties);properties.specialData=this.getSpecialProperties();this.fileUploader=FileUploader.create(properties.data.name,this.model,this);if(this.fileUploader==undefined){this.showPupup({content:_lang('FILETYPE_NOT_ACCEPTED'),title:_lang('MODAL_INFO_ERROR')},this);return;}
if(this.fileUploader.isUploadingNow()){}
this.fileUploader.sendFile(properties);this.fileUploader.on('on-result',this.onResult,this);this.fileUploader.on('on-fault',this.onFault,this);this.fileUploader.on('on-complete',this.onComplete,this);this.fileUploader.on('on-progress',this.onProgress,this);},onResult:function(data){if(data.key==1){this.showPupup({content:_lang('FILETYPE_NOT_ACCEPTED'),title:_lang('MODAL_INFO_ERROR')},this);return;}},onFault:function(data){this.showPupup({content:_lang('ERROR_ON_UPLOAD'),title:_lang('MODAL_INFO_ERROR')},this);},onComplete:function(data){this.hideProgressPercent(data);this.fileUploader.off();this.fileUploader=undefined;this.afterOnComplete();},afterOnComplete:function(){},onProgress:function(data){this.showProgressPercent(data);},showProgressPercent:function(data){FileUploader.showProgressPercent(data,this);},hideProgressPercent:function(data){FileUploader.hideProgressPercent(data,this);},showPupup:function(data,sender){var popup=PopupFactory.createErrorPopup(data,sender);$('body').append(popup.render(data).$el);},getSpecialProperties:function(){return{};}});;;var ExerciseComponentView=LoadedComponentView.extend({startEditing:function(){},endEditing:function(){this.$el.find('.quiz-component-handle').show();this.$el.find('.answer-text').show();this.$el.find('.answer-input').remove();this.$el.find('.answer-remove').remove();this.$el.find('.add-new-answer').remove();}});;;var TextComponentView=LoadedComponentView.extend({className:'component text-component',template:_.template($('#text-component-template').html()),defaultContent:'<span style="font-size:18px">'+_lang('SIMPLETEXT_INSERTTEXT')+'</span>',defaultText:_lang('SIMPLETEXT_INSERTTEXT'),defaultStrings:['Kliknij podwjnie, aby edytowa.','Double click to edit.'],events:function(){return _.extend({},ComponentView.prototype.events,{'dblclick .text-component-handle':'startEditing','set-text-editor':'setTextEditor','dragstart .note-editor':'preventDragging'});},setTextEditor:function(editorEl){},addComponentListeners:function(){this.listenTo(this.model,"change:enable-scrollbar",this.renderScrollbar,this);},afterInitialize:function(){},afterRender:function(){if(this.isContentADefaultString()){var contents=$(this.model.get('contents'));contents.text(this.defaultText);this.model.set('contents',contents[0].outerHTML);this.render();}
this.renderScrollbar();},isContentADefaultString:function(){var isStartingString=false;try{var contents=this.model.get('contents');var actualContent=$(contents);if(actualContent.length===1){_.each(this.defaultStrings,function(val){if(actualContent.text()==val){isStartingString=true;}});}}catch(err){}
return isStartingString;},renderPadding:function(){var padding=this.model.get('padding');this.$el.find('.component-inner, .note-editor').css({padding:padding+'px'});},renderScrollbar:function(){var enableScrollbar=this.model.get('enable-scrollbar');this.$el.find('.component-inner').css({overflow:enableScrollbar?'auto':'hidden'});},renderBackgroundColor:function(){var color=this.$el.find('.component-inner').css('background');this.$el.find('.note-editor').css({background:color});},onRenderStyle:function(){},copyStylesToEditor:function(){var styles=this.model.get('styles');this.renderPadding();this.renderBackgroundColor();if(styles["component-inner"]){this.$el.find('.note-editor').css(styles["component-inner"]);}
if(styles["component-gradient"]){this.$el.find('.note-editor').css(styles["component-gradient"]);}},startEditing:function(changeTab){var _that=this;this.isEditing=true;changeTab=_.isUndefined(changeTab)?true:changeTab;var canEditing=this.checkIfCanEditing();if(canEditing==false){return;}
this.$el.find('.note-editor').remove();this.$el.find('.text-component-handle').hide();_layout.text_editor_image.hide();this.$el.find('.text-component-inner').summernote({onChange:function(contents,$editable){_that.model.set('contents',contents,{silent:true});_that.onTextChanged(contents,$editable);clearTimeout(_that.contentsTimeout);_that.contentsTimeout=setTimeout(function(){_that.model.trigger('change',['contents']);},1500);},componentEl:_that.$el,componentModel:_that.model,editorWrapper:$('#menu-text'),toolbar:[['style',['bold','italic','underline','clear']],['para',['ul','ol']],['para',['paragraph']],['table',['table']],['height',['height']],['fontname',['fontname']],['fontsize',['fontsize']],['insert',['link']],['color',['color']]]});if(changeTab){_layout.menu_top_tabs.tabs("option","active",2);}
Utils.placeCaretAtEnd(this.$el.find('.note-editable')[0]);if(this.model.get('contents')==this.defaultContent){Utils.selectWholeText(this.$el.find('.note-editable')[0]);}
this.copyStylesToEditor();},onTextChanged:function(contents,$editable){},select:function(){},unselect:function(){if(!this.isEditing){return;}
_log('unselect',this.model.toJSON(),_log.trigger);window.getSelection().removeAllRanges();this.$el.find('.note-editable').blur();this.$el.find('.note-editable').focusout();this.$el.find('.text-component-handle').show();if(this.$el.find('.note-editor').push()>0){this.$el.find('.note-editor').off();this.$el.find('.text-component-inner').destroySummernote();}
this.$el.find('.text-component-inner *').removeAttr('contenteditable');this.$el.find('.text-component-inner *').blur();_layout.text_editor_image.show();},specificUpdateComing:function(){this.endEditing();},endEditing:function(){if(this.isEditing){this.unselect();this.isEditing=false;}},setText:function(text){this.model.set('contents','<span style="font-size:18px">'+text+'</span>');this.forceRender();}});var TextComponentViewNotEditable=ComponentView.createNotEditableComponentClass(TextComponentView);;;var ImageComponentView=LoadedComponentView.extend({className:'component image-component',template:_.template($('#image-component-template').html()),resizeTimeOut:null,uploadOnFileDrop:function(e,resizeImage){if(Utils.isDarkanExtension(e)){_log('is darkan extension true');return;};_log('is darkan extension false');if(!StageView.instance.canEdit){return;}
this.model.setComponentAsImage();this.resizeImage=resizeImage;this.$el.find('.loaded-dropzone').fadeOut(500);var properties=this.getDropProperties(e);var imageUrl=properties.imageUrl;_log('e',e);_log('properties',properties);if(imageUrl!=undefined){this.uploadOnLink(imageUrl,resizeImage);}else{this.runUploadProcess(properties);}},uploadOnFileDrop2:function(e,resizeImage){_log('is darkan extension false');if(!StageView.instance.canEdit){return;}
this.model.setComponentAsImage();this.resizeImage=resizeImage;this.$el.find('.loaded-dropzone').fadeOut(500);var properties=e;var imageUrl=properties.imageUrl;_log('e',e);_log('properties',properties);if(imageUrl!=undefined){this.uploadOnLink(imageUrl,resizeImage);}else{this.runUploadProcess(properties);}},getDropProperties:function(e){var imageUrl;var file=e.originalEvent.dataTransfer.files[0];var data;if(file!=undefined){var imageName=file.name;var imageData=e.originalEvent.dataTransfer.result;data={name:imageName,data:imageData,size:file.size};}else{imageUrl=e.originalEvent.dataTransfer.getData('text');}
return{file:file,data:data,imageUrl:imageUrl};},uploadOnPaste:function(e,blob,resizeImage){var _that=this;if(!StageView.instance.canEdit){return;}
if(this.model.get('locked')){return;}
this.model.setComponentAsImage();this.resizeImage=resizeImage;var reader=new FileReader();reader.onload=function(e){var data={name:'copyimage.png',data:event.target.result,size:blob.size};_that.runUploadProcess({file:blob,data:data});};reader.readAsDataURL(blob);},uploadOnLink:function(imageUrl,resizeImage){var _that=this;if(!StageView.instance.canEdit){return;}
if(this.model.get('locked')){return;}
this.model.setComponentAsImage();this.resizeImage=resizeImage;var _that=this;this.showLoader();DataAccess.convertLinkToImage({imageUrl:imageUrl,pageId:StageView.instance.model.get('options').get('pageid'),page:StageView.instance.model,actionkey:this.model.get('actionkey')},function(data){_that.hideLoader();_that.model.set('imageFileName',data.fileName);_that.model.forceRender();if(_that.resizeImage){_that.resizeImageToProperDimentions();}
_that.createMiniature();},function(data){_that.hideLoader();});},addComponentListeners:function(){this.listenTo(this.model,'change:opacity',this.changeOpacity);this.listenTo(this.model,'change:imageFileName',this.renderPath);},changeOpacity:function(){this.$el.find('.img-wrapper').css('opacity',this.model.get('opacity'));},resizeImageToProperDimentions:function(){var _that=this;var imageSrc=this.$el.find('img').attr('src');var img=new Image;img.onload=function(){var newWidth=img.width;var newHeight=img.height;var pageWidth=StageView.instance.model.get('options').get('width')-20;var pageHeight=StageView.instance.model.get('options').get('height')-20;if(newWidth>pageWidth){newWidth=pageWidth;newHeight=(newWidth*img.height)/ img.width;}
if(newHeight>pageHeight){newHeight=pageHeight;newWidth=(newHeight*img.width)/ img.height;}
_that.model.set({width:newWidth,height:newHeight});}
img.src=imageSrc;},onComplete:function(data){this.hideProgressPercent(data);this.fileUploader.off();this.fileUploader=undefined;if(this.resizeImage){this.resizeImageToProperDimentions();}
this.trigger('select-component',this.model);StageView.instance.model.updateDinamicPageThumb();},createMiniature:function(){var _that=this;clearTimeout(this.resizeTimeOut);this.resizeTimeOut=setTimeout(function(){var pageID=StageView.instance.model.get('options').get('pageid');var actionkey=_that.model.get('actionkey');var fileName=_that.model.get('imageFileName');var width=_that.model.get('width');var height=_that.model.get('height');DataAccess.resizeImage({pageID:pageID,actionkey:actionkey,action:"resizeImage",fileName:fileName,width:width,height:height},function(data){},function(data){_log('data',data)});},1500);},afterInitialize:function(){this.model.view=this;},afterResize:function(){this.createMiniature();},renderPath:function(){var appLink=__meta__.APP_LINK;var imageFileName=this.model.get('imageFileName');var type=this.model.get('type');if(imageFileName==''){var src='images/buttons/'+type+'.png';this.$el.find('img').attr('src',src);}else{var userId=this.model.ownerId
var projectId=this.model.projectId;var actionkey=this.model.get('actionkey');var pageId=parseInt(actionkey.split('-').pop());var r='?r='+this.model.get('rand');var src=__meta__.projects_link+userId+'/'+projectId+'/pre/exported_view/'+pageId+'/images/'+actionkey+'/'+imageFileName+r;this.$el.find('img').attr('src',src);}},createImageLibrary:function(data,input,resizeImage){var _that=this;this.resizeImage=resizeImage;var itemDir=data.itemDir;var actionkey=this.model.get('actionkey');var pageID=StageView.instance.model.get('options').get('pageid');var oldFileName=this.model.get('imageFileName');_log('copyLibraryFileToImage',itemDir);this.showLoader();DataAccess.copyLibraryFileToImage({itemDir:itemDir,actionkey:actionkey,pageID:pageID,oldFileName:oldFileName},function(data){_that.hideLoader();_log('Copy library file to image result: ',data,_log.dataaccessOutResult);_that.model.set('library',itemDir,{silent:true});_that.model.set('imageFileName',data.fileName,{silent:true});_that.model.trigger('change',['imageFileName','library']);var src=__meta__.projects_link+__meta__.ownerID+'/'+__meta__.projectID+'/pre/exported_view/'+pageID+'/images/'+actionkey+'/'+data.fileName;_that.$el.find('.img-wrapper img').attr('src',src);_that.trigger('select-component',_that.model);if(_that.resizeImage){_that.resizeImageToProperDimentions();}},function(data){_log('Copy library file to image fault: ',data,_log.dataaccessOutResult);_that.hideLoader();});},onPhotopeaSaved:function(){this.renderPath();this.resizeImageToProperDimentions();this.createMiniature();StageView.instance.model.updateDinamicPageThumb();},showCropWindow:function(){var _that=this;var pageID=StageView.instance.model.get('options').get('pageid');var actionkey=this.model.get('actionkey');var fileName=this.model.get('imageFileName');var imgSrc=pageID+'/images/'+actionkey+'/'+fileName;if(this.cropWindowView==undefined){this.cropWindowView=new CropWindowView({componentModel:this.model,imgSrc:imgSrc});this.cropWindowView.on('on-close',function(){_that.cropWindowView=undefined;});this.cropWindowView.on('on-crop-image',function(data){_log('cropWindowView',data);var imageFileName=data.newFileName;var rand=new Date().getTime();_that.model.set({rand:rand,imageFileName:imageFileName});_that.resizableDestroy();_that.render();_that.makeResizable();_that.resizeImageToProperDimentions();_that.createMiniature();});var dataToRender={};$('body').append(this.cropWindowView.render(dataToRender).$el);}},showContextMenu:function(e){if(StageView.instance.selectedComponentsCollection.length>1){var contextMenuView=new MultiComponentContextMenuView({model:this.getModel(),view:this});ContextMenuContainer.addMenu(contextMenuView,e);}else{var contextMenuView=new ImageComponentContextMenuView({model:this.getModel(),view:this});ContextMenuContainer.addMenu(contextMenuView,e);}},showLoader:function(){this.imageLoader=new ImageLoader();this.$el.append(this.imageLoader.render().$el);},hideLoader:function(){if(this.imageLoader){this.imageLoader.remove();}}});var ImageLoader=Backbone.View.extend({className:'image-loader',template:_.template($('#image-loader').html()),render:function(){var template=this.template(this.serializeData());this.$el.html(template);return this;},serializeData:function(){return{};}});var ImageComponentViewNotEditable=ComponentView.createNotEditableComponentClass(ImageComponentView);;;var VideoComponentView=LoadedComponentView.extend({className:'component video-component',template:_.template($('#video-component-template').html()),putVideoLink:function(data){var videoLink=data.videoLink;var videoType=data.videoType;this.model.set({'videoLink':videoLink,'videoType':videoType});this.render();this.unselectComponent();this.selectComponent();},uploadOnFileDrop2:function(e,resizeImage){_log('is darkan extension false');if(!StageView.instance.canEdit){return;}
this.resizeImage=resizeImage;this.$el.find('.loaded-dropzone').fadeOut(500);var properties=e;var imageUrl=properties.imageUrl;_log('e',e);_log('properties',properties);if(imageUrl!=undefined){this.uploadOnLink(imageUrl,resizeImage);}else{this.runUploadProcess(properties);}},addComponentListeners:function(){},setYoutubeVideoLink:function(videoLink){this.putVideoLink({'videoLink':videoLink,'videoType':2});},afterRender:function(){},});var VideoComponentViewNotEditable=ComponentView.createNotEditableComponentClass(VideoComponentView);;;var QuizComponentView=ExerciseComponentView.extend({className:'component quiz-component quiz',template:_.template($('#quiz-component-template').html()),events:function(){return _.extend({},ComponentView.prototype.events,{'click .edit-component-button':'startEditing','click .answer-remove':'answerRemove','click .add-new-answer':'addNewAnswer','keyup .answer-input':'changeAnswerText','click .answer-checkbox':'checkGoodAnswer'});},addComponentListeners:function(){this.listenTo(this.model,'change:multiselect',this.render);this.listenTo(this.model,'change:buttonShow',this.renderButtonShow);this.listenTo(this.model,'change:fontSize',this.renderFontSize);},renderFontSize:function(model){var fontSize=this.model.get('fontSize');this.$el.find('.answer-text').css('font-size',fontSize+'px');},renderButtonShow:function(model){var display=this.model.get('buttonShow')?'inline-block':'none';this.$el.find('.quiz-submit-button').css('display',display);},checkGoodAnswer:function(e){var it=$(e.target).attr('it');var answers=this.model.get('answers');var multiselect=this.model.get('multiselect');if(!multiselect){_.each(answers,function(option,i){answers[i].goodAnswer=false;});}
answers[it].goodAnswer=$(e.target).is(':checked');this.model.set('answers',answers);this.model.trigger('change');},changeAnswerText:function(e){var it=$(e.target).attr('it');var answers=this.model.get('answers');answers[it].text=$(e.target).val();this.model.set('answers',answers);this.model.trigger('change');},addNewAnswer:function(e){var answers=this.model.get('answers');var incrementQuestion=this.model.get('incrementQuestion');var highestTopValue=0;var highestLeftValue=0;_.each(answers,function(answer,i){if(highestTopValue<answer.top){highestTopValue=answer.top;}
if(highestLeftValue<answer.left){highestLeftValue=answer.left;}});highestTopValue+=30;answers['#'+incrementQuestion]={text:'',goodAnswer:false,left:highestLeftValue,top:highestTopValue,choosen:false};this.model.set({answers:answers,incrementQuestion:incrementQuestion+1},{silent:true});this.model.trigger('change',['answers','incrementQuestion']);this.render();this.startEditing();},answerRemove:function(e){var it=$(e.target).attr('it');var answers=this.model.get('answers');delete answers[it];this.model.set('answers',answers);this.model.trigger('change');if(Object.keys(answers).length===0){this.addNewAnswer();}
this.unselect();this.render();this.startEditing();},startEditing:function(){var canEditing=this.checkIfCanEditing();if(canEditing==false){return;}
var _that=this;this.$el.find('.quiz-component-handle').hide();var addNewAnswerButton=$('<div class="add-new-answer">+ dodaj now odpowied</div>');addNewAnswerButton.appendTo(this.$el);var answers=this.$el.find('.answer-text').push();var i=0;this.$el.find('.answer-text').each(function(){i++;var it=$(this).attr('it');if(i===answers)
$(this).hide().parent().append('<input class="answer-input" type="text" value="'+$(this).text()+'" it="'+it+'"><div class="answer-remove" it="'+it+'"></div><div class="answer-move"></div>');else
$(this).hide().parent().append('<input class="answer-input" type="text" value="'+$(this).text()+'" it="'+it+'"><div class="answer-remove" it="'+it+'"></div><div class="answer-move"></div>');});this.$el.find('.quiz-submit-button').draggable({containment:this.$el,stop:function(){var buttonData={left:parseInt($(this).css('left')),top:parseInt($(this).css('top')),text:$(this).text()};_that.model.set('submitButton',buttonData);}});this.$el.find('.answer-wrapper').draggable({containment:this.$el,stop:function(){var answers=_that.model.get('answers');var it=$(this).find('.answer-checkbox').attr('it');answers[it].left=parseInt($(this).css('left'));answers[it].top=parseInt($(this).css('top'));_that.model.set('answers',answers);_that.model.trigger('change');}});},unselect:function(){this.$el.find('.quiz-component-handle').show();this.$el.find('.answer-text').show();this.$el.find('.answer-input').remove();this.$el.find('.answer-remove').remove();this.$el.find('.add-new-answer').remove();this.render();},afterRender:function(){if(this.$el.is('.ui-resizable')){this.$el.resizable("destroy");this.makeResizable();}}});var QuizComponentViewNotEditable=ComponentView.createNotEditableComponentClass(QuizComponentView);;;var QuizSelectOneComponentView=ExerciseComponentView.extend({className:'component quiz-component quiz',template:_.template($('#quizselectone-component-template').html()),events:function(){return _.extend({},ComponentView.prototype.events,{'click .edit-component-button':'startEditing','click .answer-remove':'answerRemove','click .add-new-answer':'addNewAnswer','keyup .answer-input':'changeAnswerText','click .mark-as-good-answer':'checkGoodAnswer'});},addComponentListeners:function(){this.listenTo(this.model,'change:multiselect',this.render);},checkGoodAnswer:function(e){var it=$(e.target).attr('it');var answers=this.model.get('answers');_.each(answers,function(option,i){answers[i].goodAnswer=false;});answers[it].goodAnswer=$(e.target).is(':checked');this.model.set('answers',answers);this.model.trigger('change');},changeAnswerText:function(e){var it=$(e.target).attr('it');var answers=this.model.get('answers');answers[it].text=$(e.target).val();this.model.set('answers',answers);this.model.trigger('change');},addNewAnswer:function(e){var answers=this.model.get('answers');var incrementQuestion=this.model.get('incrementQuestion');var highestTopValue=0;var highestLeftValue=0;_.each(answers,function(answer,i){if(highestTopValue<answer.top){highestTopValue=answer.top;}
if(highestLeftValue<answer.left){highestLeftValue=answer.left;}});highestTopValue+=30;answers['#'+incrementQuestion]={text:_lang('MULTISELECTQUIZ_ANSWER'),goodAnswer:false,left:highestLeftValue,top:highestTopValue,choosen:false};this.model.set({answers:answers,incrementQuestion:incrementQuestion+1});this.unselect();this.render();this.startEditing();},answerRemove:function(e){var it=$(e.target).attr('it');var answers=this.model.get('answers');delete answers[it];this.model.set('answers',answers);this.model.trigger('change');if(Object.keys(answers).length===0){this.addNewAnswer();}
this.unselect();this.render();this.startEditing();},startEditing:function(){var canEditing=this.checkIfCanEditing();if(canEditing==false){return;}
var _that=this;this.$el.find('.quiz-component-handle').hide();var addNewAnswerButton=$('<div class="add-new-answer">'+_lang('QUIZ_INLINE_EDITOR_ADD_ANSWER')+'</div>');addNewAnswerButton.appendTo(this.$el);var answersObject=this.model.get('answers');var answers=this.$el.find('.selectone-block-answer').push();var i=0;this.$el.find('.selectone-block-answer').each(function(){i++;var it=$(this).attr('it');var answerData=answersObject[it];var checked=answerData.goodAnswer?'checked':'';if(i===answers)
$(this).hide().parent().append('<input type="radio" '+checked+' it="'+it+'" class="mark-as-good-answer" name="'+_that.model.get('actionkey')+'"><input class="answer-input block-answer-input" type="text" value="'+$(this).text()+'" it="'+it+'"><div class="answer-remove" it="'+it+'"></div><div class="answer-move"></div>');else
$(this).hide().parent().append('<input type="radio" '+checked+' it="'+it+'" class="mark-as-good-answer" name="'+_that.model.get('actionkey')+'"><input class="answer-input block-answer-input" type="text" value="'+$(this).text()+'" it="'+it+'"><div class="answer-remove" it="'+it+'"></div><div class="answer-move"></div>');});this.$el.find('.answer-wrapper').draggable({containment:this.$el,stop:function(){var answers=_that.model.get('answers');var it=$(this).find('.selectone-block-answer').attr('it');answers[it].left=parseInt($(this).css('left'));answers[it].top=parseInt($(this).css('top'));_that.model.set('answers',answers);_that.model.trigger('change');}});},unselect:function(){this.$el.find('.quiz-component-handle').show();this.$el.find('.selectone-block-answer').show();this.$el.find('.answer-input').remove();this.$el.find('.answer-remove').remove();this.$el.find('.add-new-answer').remove();this.render();},afterRender:function(){if(this.$el.is('.ui-resizable')){this.$el.resizable("destroy");this.makeResizable();}}});var QuizSelectOneComponentViewNotEditable=ComponentView.createNotEditableComponentClass(QuizSelectOneComponentView);;;var QuizFillInBlanksComponentView=TextComponentView.extend({className:'component quizfillinblanks-component quiz',template:_.template($('#quizfillinblanks-component-template').html()),events:function(){return _.extend({},ComponentView.prototype.events,{'dblclick .text-component-handle':'startEditing','set-text-editor':'setTextEditor','dragstart .note-editor':'preventDragging','mouseup .note-editor':'showInputOptions','click .change-to-interactive':'changeSelectionToInteractive','click select':'openQuizfillInBlanksOptionsWindow','click input':'openQuizfillInBlanksOptionsWindow','click textarea':'openQuizfillInBlanksOptionsWindow',});},possibleInteractionTypes:['input','select','textarea'],lastContents:'',afterInitialize:function(){this.lastContents=this.model.get('contents');},onTextChanged:function(contents,$editable){},openQuizfillInBlanksOptionsWindow:function(e){e.preventDefault();var _that=this;var answerId=$(e.currentTarget).attr('aid');if(answerId){var answers=this.model.get('answers');var answerData=answers['#'+answerId];if(answerData){var dataForWindow={answerData:answerData,componentModel:this.model,componentView:this,answerId:answerId};if(this.optionsWindow){this.optionsWindow.close();}
this.optionsWindow=WindowFactory.createQuizfillInBlanksOptionsWindow(dataForWindow);this.optionsWindow.on('answerChange',function(answerDataChanged){answerData=answerDataChanged;var answerObject=_that.model.get('answers');answerObject['#'+answerId]=answerDataChanged;_that.model.set('answers',answerObject,{silent:true});_that.model.trigger('change',['answers']);});$('body').append(this.optionsWindow.render().$el);var left=e.clientX+this.optionsWindow.$el.width()+60;var top=e.clientY+this.optionsWindow.$el.height();var windowPosition={left:left,top:top};this.optionsWindow.setWindowPosition(windowPosition);this.optionsWindow.initTags();}}},showInputOptions:function(e){var selectedText=this.getSelectionText();if(selectedText&&selectedText.length>0){this.showOptionsWrapper(e);}else{this.hideOptionsWrapper();}},hideOptionsWrapper:function(){var optionsWrapper=this.$el.find('.input-options-wrapper');optionsWrapper.hide();},showOptionsWrapper:function(e){var optionsWrapper=this.$el.find('.input-options-wrapper');var left=e.clientX-this.$el.offset().left-optionsWrapper.width()/2;var top=e.clientY-this.$el.offset().top-optionsWrapper.height()-20;optionsWrapper.css({left:left+'px',top:top+'px'});optionsWrapper.show();},changeSelectionToInteractive:function(e){var clickedObject=$(e.currentTarget);var interactionType=clickedObject.attr('inter');this.hideOptionsWrapper();if(this.possibleInteractionTypes.indexOf(interactionType)===-1){return;}
var selectedText=this.getSelectionText();var answerId=this.addNewInputToAnswersObject(selectedText,interactionType);var contents=this.replaceSelectedText(interactionType,selectedText,answerId);this.model.set('contents',contents,{silent:true});this.model.trigger('change',['incrementQuestion','contents','answers']);this.onTextChanged(this.model.get('contents'));},addNewInputToAnswersObject:function(replacedText,inputType){var answerId=this.model.get('incrementQuestion');var answersObject=this.model.get('answers');var goodanswers=[];goodanswers.push({text:replacedText,iscorrect:true});answersObject['#'+answerId]={placeholder:replacedText,type:inputType,goodanswers:goodanswers};this.model.set('answers',answersObject);this.model.set('incrementQuestion',answerId+1,{silent:true});return answerId;},replaceSelectedText:function(elementType,selectedText,answerId){var sel,range;if(window.getSelection){sel=window.getSelection();if(sel.rangeCount){range=sel.getRangeAt(0);range.deleteContents();var inputElement=document.createElement(elementType);$(inputElement).attr({placeholder:selectedText,aid:answerId});if(elementType=='select'){$(inputElement).append('<option value="'+selectedText+'">'+selectedText+'</option>');}
range.insertNode(inputElement);}}else if(document.selection&&document.selection.createRange){}
return this.$el.find('.note-editable').html();},getSelectionText:function(){var text="";if(window.getSelection){text=window.getSelection().toString();}else if(document.selection&&document.selection.type!="Control"){text=document.selection.createRange().text;}
return text;},beforeUnselect:function(){if(this.optionsWindow){this.optionsWindow.close();}
this.hideOptionsWrapper();},});var QuizFillInBlanksComponentViewNotEditable=ComponentView.createNotEditableComponentClass(QuizFillInBlanksComponentView);;;var QuizDnDComponentView=TextComponentView.extend({className:'component quizdnd-component quiz',template:_.template($('#quizdnd-component-template').html()),addComponentListeners:function(){this.listenTo(this.model,'change:buttonTitle',this.renderButtonShow);},renderButtonShow:function(model){this.$el.find('.quiz-dnd-component-inner').text(model.get('buttonTitle'));},afterRender:function(){this.objectOnResize();},onRenderStyle:function(){this.objectOnResize();}});var QuizDnDComponentViewNotEditable=ComponentView.createNotEditableComponentClass(QuizDnDComponentView);;;var QuizConnectLinesComponentView=TextComponentView.extend({className:'component quizconnectlines-component quiz',template:_.template($('#quizconnectlines-component-template').html()),addComponentListeners:function(){this.listenTo(this.model,'change:buttonTitle',this.renderButtonShow);},renderButtonShow:function(model){this.$el.find('.quiz-connectlines-component-inner').text(model.get('buttonTitle'));},afterRender:function(){this.objectOnResize();},beforeUnselect:function(){this.resetDots();},resetDots:function(){jsPlumb.deleteEveryEndpoint();},paintDots:function(){var _that=this;_that.resetDots();_that.instance=jsPlumb.getInstance({DragOptions:{cursor:'pointer',zIndex:500},PaintStyle:{strokeStyle:'#5082A5'},EndpointHoverStyle:{fillStyle:"orange"},HoverPaintStyle:{strokeStyle:"orange"},EndpointStyle:{width:20,height:16,strokeStyle:'#5082A5'},Endpoint:"Rectangle",Anchors:["TopCenter","TopCenter"],Container:$('#scene')});var connectorType="Straight";var endpointFrom=false,endpointTo=false;var objectsInitedArray=[];var answers=this.model.get('answers');var objs=this.model.get('objs');for(var i=0;i<answers.length;i++){var answer=answers[i];if(answer.from.length>0){var screenElementFrom=StageView.instance.getComponentModelByActionkey(answer.from).view.$el;var options=objs[answer.from];var maxConnections1=options.maxConnections;maxConnections1=maxConnections1==0?maxConnections1=-1:maxConnections1;var point1={endpoint:["Dot",{radius:options.size}],paintStyle:{fillStyle:options.color},connectorStyle:{strokeStyle:options.color,lineWidth:options.lineWidth},connector:connectorType,dropOptions:{tolerance:"touch"},maxConnections:maxConnections1,isSource:false,isTarget:false}
endpointFrom=jsPlumb.addEndpoint(screenElementFrom,{anchor:options.align},point1);objectsInitedArray.push(answer.from);}
for(var k=0;k<answer.to.length;k++){var to=answer.to[k];var screenElementTo=StageView.instance.getComponentModelByActionkey(to).view.$el;var options=objs[to];var maxConnections1=options.maxConnections;maxConnections1=maxConnections1==0?maxConnections1=-1:maxConnections1;var point1={endpoint:["Dot",{radius:options.size}],paintStyle:{fillStyle:options.color},connectorStyle:{strokeStyle:options.color,lineWidth:options.lineWidth},connector:connectorType,dropOptions:{tolerance:"touch"},maxConnections:maxConnections1,isSource:false,isTarget:false}
endpointTo=jsPlumb.addEndpoint(screenElementTo,{anchor:options.align},point1);if(endpointFrom&&endpointTo){jsPlumb.connect({source:endpointFrom,target:endpointTo});}
objectsInitedArray.push(to);};};for(var o in objs){if(objectsInitedArray.indexOf(o)===-1){var options=objs[o];var qclScreenOb=StageView.instance.getComponentModelByActionkey(o).view.$el;var align=options.align;var color1=options.color;var size1=options.size;var lineWidth1=options.lineWidth;var endpointOptions={endpoint:["Dot",{radius:size1}],paintStyle:{fillStyle:color1},connectorStyle:{strokeStyle:color1,lineWidth:lineWidth1},connector:"Straight",dropOptions:{tolerance:"touch"},maxConnections:0,isSource:false,isTarget:false}
jsPlumb.addEndpoint(qclScreenOb,{anchor:align},endpointOptions);}}
jsPlumb.repaintEverything();},onRenderStyle:function(){this.objectOnResize();}});var QuizConnectLinesComponentViewNotEditable=ComponentView.createNotEditableComponentClass(QuizConnectLinesComponentView);;;var QuizWordsearchComponentView=ExerciseComponentView.extend({className:'component quizwordsearch-component quiz',template:_.template($('#quizwordsearch-component-template').html()),imagesExtensions:[],soundsExtensions:[],events:function(){return _.extend({},ComponentView.prototype.events,{'keyup .wordsearch-cell':'changeCellValue','click .edit-component-button':'startEditing',});},afterInitialize:function(){this.model.view=this;},addComponentListeners:function(){this.model.view=this;this.listenTo(this.model,'change:objs',this.render);this.model.on('upload-image',this.uploadImage,this);this.model.on('upload-sound',this.uploadSound,this);},getSpecialProperties:function(){var specilaData={componentType:'crossword'};return specilaData;},changeCellValue:function(e){var cellValue=$(e.target).val();var cellID=$(e.target).attr('cellid');var objs=this.model.get('objs');objs[cellID]=cellValue;this.model.set('objs',objs);this.model.trigger('change');},setActiveCell:function(e){var cellID=$(e.target).attr('cellid');this.model.setActieCellID(cellID);this.activeCellID=cellID;},afterInitialize:function(){this.calculateRowsAndCols();},afterRender:function(){this.onWordsearchResize();},calculateRowsAndCols:function(){var objs=this.model.get('objs');var _rows=[];var _cols=[];var _tmp;var cols;var rows;_.each(objs,function(val,key){_tmp=key.split('-');_rows.push(_tmp[0]);_cols.push(_tmp[1]);});cols=_.uniq(_cols);rows=_.uniq(_rows);this.model.set('cols',cols);this.model.set('rows',rows);},objectOnResize:function(event,obj){this.onWordsearchResize();},onWordsearchResize:function(){var objectWrapperWidth=this.$el.width();var objectWrapperHeight=this.$el.height();var qcrosswordWrapper=this.$el.find('.quizwordsearch-component-inner');var crosswordHeight=qcrosswordWrapper.height();var crosswordWidth=qcrosswordWrapper.width();var newCrosswordWidth=objectWrapperWidth;var newCrosswordHeight=((crosswordHeight*newCrosswordWidth)/ crosswordWidth);if(newCrosswordHeight<10){newCrosswordHeight=10;}
if(newCrosswordHeight>objectWrapperHeight){newCrosswordHeight=objectWrapperHeight;newCrosswordWidth=(crosswordWidth*newCrosswordHeight)/ crosswordHeight;}
var row_count=this.model.get('rows').length;var cell_size=(newCrosswordHeight / row_count);this.$el.find('.wordsearch-row').css('height',cell_size+'px');this.$el.find('.wordsearch-cell-background').css({height:cell_size+"px",width:cell_size+"px",'line-height':cell_size+"px"});this.$el.find('.wordsearch-cell[celltype="answer"]').css({'line-height':cell_size*0.95+"px",'font-size':cell_size/1.5+"px"});this.$el.find('.wordsearch-cell[celltype="question"]').css({'line-height':cell_size/3.5+"px",'font-size':cell_size/3.5+"px"});this.$el.find('.wordsearch-cell-password').css({height:cell_size*0.3+"px",width:cell_size*0.3+"px",'line-height':cell_size*0.3+"px"});},startEditing:function(){var canEditing=this.checkIfCanEditing();if(canEditing==false){return;}
this.$el.find('.quiz-component-handle').hide();this.model.editingMode=true;},unselect:function(){this.$el.find('.quiz-component-handle').show();this.model.editingMode=false;}});var QuizWordsearchComponentViewNotEditable=ComponentView.createNotEditableComponentClass(QuizWordsearchComponentView);;;var ScrollerComponentView=ComponentView.extend({className:'component scroller-component',template:_.template($('#scroller-component-template').html()),afterInitialize:function(){this.stageView=StageView.instance;var stageHeight=this.stageView.model.get('options').get('height');},render:function(){that=this;this.$el.html("");var componentTemplate=this.template(this.model.toJSON());this.$el.html(componentTemplate);this.setPositionToComponent();this.makeDraggable({axis:'y'});this.renderSelectedBy(this.model.get('selected-by'));this.stickit();return this;}});var ScrollerComponentViewNotEditable=ComponentView.createNotEditableComponentClass(ScrollerComponentView);;;var CrosswordComponentView=ExerciseComponentView.extend({className:'component crossword-component quiz',template:_.template($('#crossword-component-template').html()),cellValueTimeout:null,events:function(){return _.extend({},ComponentView.prototype.events,{'focusin .crossword-cell':'setActiveCell','keyup .crossword-cell':'changeCellValue','click .edit-component-button':'startEditing',});},addComponentListeners:function(){this.listenTo(this.model,'change:objs',this.render);this.model.on('upload-image',this.uploadImage,this);this.model.on('upload-sound',this.uploadSound,this);},afterOnComplete:function(){this.dinamicRender();},dinamicRender:function(){var _that=this;var objs=this.model.get('objs');var cellSize=this.$el.find('.crossword-cell-background').width();_.each(objs,function(val,key){_that.$el.find('.crossword-cell[cellid="'+key+'"]').parent().attr('gender',val.gender);_that.$el.find('.crossword-cell[cellid="'+key+'"]').attr('style','');if(val.type==='answer'){_that.$el.find('.crossword-cell[cellid="'+key+'"]').css('font-size',cellSize/1.5+'px').css('line-height',cellSize/0.95+'px');_that.$el.find('.crossword-cell[cellid="'+key+'"]').attr('maxlength','1');_that.$el.find('.crossword-cell[cellid="'+key+'"]').removeClass('crossword-cell-question').attr('celltype','answer');}else{if(val.opts.questionType==='text'){_that.$el.find('.crossword-cell[cellid="'+key+'"]').removeAttr('readonly');}else{_that.$el.find('.crossword-cell[cellid="'+key+'"]').attr('readonly','');}
_that.$el.find('.crossword-cell[cellid="'+key+'"]').css('font-size',cellSize/3.5+'px').css('line-height',cellSize/3.5+'px');_that.$el.find('.crossword-cell[cellid="'+key+'"]').removeAttr('maxlength');_that.$el.find('.crossword-cell[cellid="'+key+'"]').addClass('crossword-cell-question').attr('celltype','question');}
_that.$el.find('.crossword-cell[cellid="'+key+'"]').val(val.text);});_that.$el.find('.crossword-cell[cellid="'+this.activeCellID+'"]').focus();this.questions();},uploadImage:function(data){this.model.soundsExtensions=[];this.model.imagesExtensions=['jpg','png','jpeg'];this.model.activeCellID=this.activeCellID;this.uploadOnClick();},uploadSound:function(data){this.model.soundsExtensions=['mp3'];this.model.imagesExtensions=[];this.model.activeCellID=this.activeCellID;this.uploadOnClick();},getSpecialProperties:function(){var objs=this.model.get('objs');var activeCellID=this.model.activeCellID
var specilaData={componentType:'crossword',activeCellID:activeCellID,opts:objs[activeCellID].opts};return specilaData;},changeCellValue:function(e){var _that=this;clearTimeout(this.cellValueTimeout);this.cellValueTimeout=setTimeout(function(){var cellValue=$(e.target).val();var cellID=$(e.target).attr('cellid');var objs=_that.model.get('objs');objs[cellID].text=cellValue;_that.model.set('objs',objs);_that.model.trigger('change');},500);},setActiveCell:function(e){var cellID=$(e.target).attr('cellid');this.model.setActieCellID(cellID);this.activeCellID=cellID;},questions:function(){var _that=this;var objs=this.model.get('objs');var actionkey=this.model.get('actionkey');_.each(objs,function(val,key){if(val.type==='question'){_that.$el.find('.crossword-cell[cellid="'+key+'"]').val(val.text).css('background-image','');if(val.opts.questionType==='image'){var imageUrl=__meta__.projects_link+__meta__.ownerID+'/'+__meta__.projectID+'/pre/exported_view/'+actionkey.split('-').pop()+'/images/'+actionkey+'/'+val.opts.imageFile;_that.$el.find('.crossword-cell[cellid="'+key+'"]').css('background',"url('"+imageUrl+"') no-repeat").css('background-size','contain');}
if(val.opts.questionType==='audio'){var imageUrl=__meta__.APP_LINK+'content_template/css/images/crossword/audioplay.png';_that.$el.find('.crossword-cell[cellid="'+key+'"]').css('background-image',"url('"+imageUrl+"')");}}});},afterInitialize:function(){this.model.view=this;this.calculateRowsAndCols();},afterRender:function(){this.calculateRowsAndCols();this.onCrosswordResize();this.questions();},calculateRowsAndCols:function(){var objs=this.model.get('objs');var _rows=[];var _cols=[];var _tmp;var cols;var rows;_.each(objs,function(val,key){_tmp=key.split('-');_rows.push(_tmp[0]);_cols.push(_tmp[1]);});cols=_.uniq(_cols);rows=_.uniq(_rows);this.model.set('cols',cols);this.model.set('rows',rows);},objectOnResize:function(event,obj){this.onCrosswordResize();},onCrosswordResize:function(){var objectWrapperWidth=this.$el.width();var objectWrapperHeight=this.$el.height();var qcrosswordWrapper=this.$el.find('.crossword-component-inner');var crosswordHeight=qcrosswordWrapper.height();var crosswordWidth=qcrosswordWrapper.width();var newCrosswordWidth=objectWrapperWidth;var newCrosswordHeight=((crosswordHeight*newCrosswordWidth)/ crosswordWidth);if(newCrosswordHeight<10){newCrosswordHeight=10;}
if(newCrosswordHeight>objectWrapperHeight){newCrosswordHeight=objectWrapperHeight;newCrosswordWidth=(crosswordWidth*newCrosswordHeight)/ crosswordHeight;}
var row_count=this.model.get('rows').length;var cell_size=(newCrosswordHeight / row_count);this.$el.find('.crossword-row').css('height',cell_size+'px');this.$el.find('.crossword-cell-background').css({height:cell_size+"px",width:cell_size+"px",'line-height':cell_size+"px"});this.$el.find('.crossword-cell[celltype="answer"]').css({'line-height':cell_size*0.95+"px",'font-size':cell_size/1.5+"px"});this.$el.find('.crossword-cell[celltype="question"]').css({'line-height':cell_size/3.5+"px",'font-size':cell_size/3.5+"px"});this.$el.find('.crossword-cell-password').css({height:cell_size*0.3+"px",width:cell_size*0.3+"px",'line-height':cell_size*0.3+"px"});},startEditing:function(){this.$el.find('.quiz-component-handle').hide();},unselect:function(){this.$el.find('.quiz-component-handle').show();}});var CrosswordComponentViewNotEditable=ComponentView.createNotEditableComponentClass(CrosswordComponentView);;;var FormInputTextComponentView=LoadedComponentView.extend({className:'component forminputtext-component form',template:_.template($('#forminputtext-component-template').html()),events:function(){return _.extend({},ComponentView.prototype.events,{'keyup input':'changeValue'});},addComponentListeners:function(){this.listenTo(this.model,'change:placeholder',this.changePlaceholder);this.listenTo(this.model,'change:defaultValue',this.changeDefaultValue);this.listenTo(this.model,'change:fontSize',this.changeFontSize);},changeFontSize:function(model){this.$el.find('input').css('font-size',model.get('fontSize')+'px');},changePlaceholder:function(model){this.$el.find('input').attr('placeholder',model.get('placeholder'));},changeDefaultValue:function(model){this.$el.find('input').val(model.get('defaultValue'));}});var FormInputTextComponentViewNotEditable=ComponentView.createNotEditableComponentClass(FormInputTextComponentView);;;var FormUploadComponentView=ImageComponentView.extend({className:'component formupload-component',template:_.template($('#formupload-component-template').html()),onComponentAdded:function(data){this.renderPath();}});var FormUploadComponentViewNotEditable=ComponentView.createNotEditableComponentClass(FormUploadComponentView);;;var QuizInputTextComponentView=LoadedComponentView.extend({className:'component quizinputtext-component quiz',template:_.template($('#quizinputtext-component-template').html()),events:function(){return _.extend({},ComponentView.prototype.events,{'keyup input':'changeValue'});},addComponentListeners:function(){this.listenTo(this.model,'change:placeholder',this.changePlaceholder);this.listenTo(this.model,'change:defaultValue',this.changeDefaultValue);this.listenTo(this.model,'change:fontSize',this.changeFontSize);},changeFontSize:function(model){this.$el.find('input').css('font-size',model.get('fontSize')+'px');},changePlaceholder:function(model){this.$el.find('input').attr('placeholder',model.get('placeholder'));},changeDefaultValue:function(model){this.$el.find('input').val(model.get('defaultValue'));}});var QuizInputTextComponentViewNotEditable=ComponentView.createNotEditableComponentClass(QuizInputTextComponentView);;;var FormTextareaComponentView=LoadedComponentView.extend({className:'component formtextarea-component form',template:_.template($('#formtextarea-component-template').html()),addComponentListeners:function(){this.listenTo(this.model,'change:defaultValue',this.changeDefaultValue);this.listenTo(this.model,'change:fontSize',this.changeFontSize);},changeFontSize:function(model){this.$el.find('textarea').css('font-size',model.get('fontSize')+'px');},changeDefaultValue:function(model){this.$el.find('textarea').text(model.get('defaultValue'));}});var FormTextareaComponentViewNotEditable=ComponentView.createNotEditableComponentClass(FormTextareaComponentView);;;var FormSelectComponentView=LoadedComponentView.extend({className:'component formselect-component form',template:_.template($('#formselect-component-template').html()),addComponentListeners:function(){this.listenTo(this.model,'change:defaultValue',this.changeDefaultValue);this.listenTo(this.model,'change:fontSize',this.changeFontSize);},changeFontSize:function(model){this.$el.find('textarea').css('font-size',model.get('fontSize')+'px');},changeDefaultValue:function(model){this.$el.find('textarea').text(model.get('defaultValue'));}});var FormSelectComponentViewNotEditable=ComponentView.createNotEditableComponentClass(FormSelectComponentView);;;var QuizSelectComponentView=LoadedComponentView.extend({className:'component quizselect-component form',template:_.template($('#quizselect-component-template').html()),addComponentListeners:function(){this.listenTo(this.model,'change:defaultValue',this.changeDefaultValue);this.listenTo(this.model,'change:fontSize',this.changeFontSize);},changeFontSize:function(model){this.$el.find('textarea').css('font-size',model.get('fontSize')+'px');},changeDefaultValue:function(model){this.$el.find('textarea').text(model.get('defaultValue'));}});var QuizSelectComponentViewNotEditable=ComponentView.createNotEditableComponentClass(QuizSelectComponentView);;;var FormCheckboxComponentView=LoadedComponentView.extend({className:'component formcheckbox-component form',template:_.template($('#formcheckbox-component-template').html()),events:function(){return _.extend({},ComponentView.prototype.events,{'click input':'changeDefaultValue','dblclick .text-component-handle':'startEditing','dragstart .note-editor':'preventDragging'});},afterInitialize:function(){this.listenTo(this.model,'change:inputSize',this.changeInputSize);this.listenTo(this.model,'change:defaultValue',this.selectOrDeselectInputOnScreen);},changeDefaultValue:function(){this.model.set('defaultValue',!this.model.get('defaultValue'));},afterRender:function(){this.selectOrDeselectInputOnScreen();},changeInputSize:function(){var _that=this;this.$el.find('input[type="checkbox"]').css({width:_that.model.get('inputSize')+"px",height:_that.model.get('inputSize')+"px"});},selectOrDeselectInputOnScreen:function(){this.$el.find('input[type="checkbox"]').prop('checked',this.model.get('defaultValue'));},startEditing:function(changeTab){var _that=this;changeTab=_.isUndefined(changeTab)?true:changeTab;var canEditing=this.checkIfCanEditing();if(canEditing==false){return;}
this.$el.find('.note-editor').remove();this.$el.find('.text-component-handle').hide();_layout.text_editor_image.hide();this.$el.find('.text-wrapper').summernote({onChange:function(contents,$editable){_that.model.set('contents',contents);},componentEl:_that.$el,componentModel:_that.model,editorWrapper:$('#menu-text'),toolbar:[['style',['bold','italic','underline','clear']],['para',['ul','ol']],['para',['paragraph']],['table',['table']],['height',['height']],['fontname',['fontname']],['fontsize',['fontsize']],['color',['color']]]});if(changeTab){_layout.menu_top_tabs.tabs("option","active",2);}
Utils.placeCaretAtEnd(this.$el.find('.note-editable')[0]);if(this.model.get('contents')==this.defaultContent){Utils.selectWholeText(this.$el.find('.note-editable')[0]);}},select:function(){},unselect:function(){window.getSelection().removeAllRanges();this.$el.find('.note-editable').blur();this.$el.find('.note-editable').focusout();this.$el.find('.text-component-handle').show();if(this.$el.find('.note-editor').push()>0){this.$el.find('.note-editor').off();this.$el.find('.text-wrapper').destroySummernote();}
this.$el.find('.text-component-inner *').removeAttr('contenteditable');this.$el.find('.text-component-inner *').blur();_layout.text_editor_image.show();},});var FormCheckboxComponentViewNotEditable=ComponentView.createNotEditableComponentClass(FormCheckboxComponentView);;;var FormRadioComponentView=LoadedComponentView.extend({className:'component formradio-component form',template:_.template($('#formradio-component-template').html()),events:function(){return _.extend({},ComponentView.prototype.events,{'dblclick .text-component-handle':'startEditing','dragstart .note-editor':'preventDragging'});},afterInitialize:function(){this.listenTo(this.model,'change:inputSize',this.changeInputSize);this.listenTo(this.model,'change:defaultValue',this.selectOrDeselectInputOnScreen);this.listenTo(this.model,'change:groupName',this.changeGroupName);},changeGroupName:function(){this.$el.find('input[type="radio"]').attr('name',this.model.get('groupName'));this.selectOrDeselectInputOnScreen();},changeDefaultValue:function(){this.model.set('defaultValue',!this.model.get('defaultValue'));},afterRender:function(){this.selectOrDeselectInputOnScreen();},selectOrDeselectInputOnScreen:function(){this.$el.find('input[type="radio"]').prop('checked',this.model.get('defaultValue'));},changeInputSize:function(){var _that=this;this.$el.find('input[type="radio"]').css({width:_that.model.get('inputSize')+"px",height:_that.model.get('inputSize')+"px"});},startEditing:function(changeTab){var _that=this;changeTab=_.isUndefined(changeTab)?true:changeTab;var canEditing=this.checkIfCanEditing();if(canEditing==false){return;}
this.$el.find('.note-editor').remove();this.$el.find('.text-component-handle').hide();_layout.text_editor_image.hide();this.$el.find('.text-wrapper').summernote({onChange:function(contents,$editable){_that.model.set('contents',contents);},componentEl:_that.$el,componentModel:_that.model,editorWrapper:$('#menu-text'),toolbar:[['style',['bold','italic','underline','clear']],['para',['ul','ol']],['para',['paragraph']],['table',['table']],['height',['height']],['fontname',['fontname']],['fontsize',['fontsize']],['color',['color']]]});if(changeTab){_layout.menu_top_tabs.tabs("option","active",2);}
Utils.placeCaretAtEnd(this.$el.find('.note-editable')[0]);if(this.model.get('contents')==this.defaultContent){Utils.selectWholeText(this.$el.find('.note-editable')[0]);}},select:function(){},unselect:function(){window.getSelection().removeAllRanges();this.$el.find('.note-editable').blur();this.$el.find('.note-editable').focusout();this.$el.find('.text-component-handle').show();if(this.$el.find('.note-editor').push()>0){this.$el.find('.note-editor').off();this.$el.find('.text-wrapper').destroySummernote();}
this.$el.find('.text-component-inner *').removeAttr('contenteditable');this.$el.find('.text-component-inner *').blur();_layout.text_editor_image.show();},});var FormRadioComponentViewNotEditable=ComponentView.createNotEditableComponentClass(FormRadioComponentView);;;var FormSubmitComponentView=TextComponentView.extend({className:'component formsubmit-component form',template:_.template($('#formsubmit-component-template').html()),afterRender:function(){this.objectOnResize();},objectOnResize:function(){var fontSize=(this.$el.height()/6)<15?15:(this.$el.height()/6);this.$el.find('.formsubmit-component-inner').css({'font-size':fontSize+"px"});},onRenderStyle:function(){this.objectOnResize();}});var FormSubmitComponentViewNotEditable=ComponentView.createNotEditableComponentClass(FormSubmitComponentView);;;var IframeComponentView=LoadedComponentView.extend({className:'component iframe-component',template:_.template($('#iframe-component-template').html()),addComponentListeners:function(){this.listenTo(this.model,'change:link',this.renderIframe);},renderIframe:function(model){var link=model.get('link')
this.$el.find('iframe').attr('src',link);}});var IframeComponentViewNotEditable=ComponentView.createNotEditableComponentClass(IframeComponentView);;;var SwfComponentView=LoadedComponentView.extend({className:'component swf-component',template:_.template($('#swf-component-template').html()),putSwf:function(){var swfFileName=this.model.get('swfFileName');if(swfFileName.length){var actionkey=this.model.get('actionkey');var swfPath='projects/'+__meta__.ownerID+'/'+__meta__.projectID+'/pre/exported_view/'+actionkey.split('-').pop()+'/swf/'+actionkey+'/'+swfFileName;this.$el.find('.swf-wrapper').text('')
this.$el.find('.swf-wrapper').css({border:'none','vertical-align':'middle','text-align':'center','background-color':''});this.$el.find('.swf-wrapper').flash({swf:swfPath,encodeParams:false,wmode:'transparent',loop:false});}else{this.$el.find('.swf-wrapper').text('swf')
this.$el.find('.swf-wrapper').css({border:'1px dashed #ccc','vertical-align':'middle','text-align':'center','background-color':'#D4E4EF'});}},afterInitialize:function(){this.model.view=this;},afterRender:function(){this.putSwf();},objectOnResize:function(event,obj){}});var SwfComponentViewNotEditable=ComponentView.createNotEditableComponentClass(SwfComponentView);;;var InfoPointPopupComponentView=ImageComponentView.extend({className:'component infopointpopup-component',template:_.template($('#infopointpopup-component-template').html()),onComponentAdded:function(data){this.renderPath();}});var InfoPointPopupComponentViewNotEditable=ComponentView.createNotEditableComponentClass(InfoPointPopupComponentView);;;var InfoPointLinkComponentView=ImageComponentView.extend({className:'component infopointlink-component',template:_.template($('#infopointlink-component-template').html()),setLink:function(imageUrl){this.model.set('link',imageUrl);},onComponentAdded:function(data){this.renderPath();}});var InfoPointLinkComponentViewNotEditable=ComponentView.createNotEditableComponentClass(InfoPointLinkComponentView);;;var InfoPointSoundComponentView=ImageComponentView.extend({className:'component infopointsound-component',template:_.template($('#infopointsound-component-template').html()),uploadOnSoundFileDrop:function(e,resizeImage){if(!StageView.instance.canEdit){return;}
this.model.setComponentAsSound();this.resizeImage=resizeImage;this.$el.find('.loaded-dropzone').fadeOut(500);var properties=e;var imageUrl=properties.imageUrl;if(imageUrl!=undefined){this.uploadOnLink(imageUrl,resizeImage);}else{this.runUploadProcess(properties);}},onComponentAdded:function(data){this.renderPath();},showContextMenu:function(e){if(StageView.instance.selectedComponentsCollection.length>1){var contextMenuView=new MultiComponentContextMenuView({model:this.getModel(),view:this});ContextMenuContainer.addMenu(contextMenuView,e);}else{var contextMenuView=new AudioComponentContextMenuView({model:this.getModel(),view:this});ContextMenuContainer.addMenu(contextMenuView,e);}},});var InfoPointSoundComponentViewNotEditable=ComponentView.createNotEditableComponentClass(InfoPointSoundComponentView);;;var InfoPointSoundControlComponentView=LoadedComponentView.extend({className:'component infopointsoundcontrol-component',template:_.template($('#infopointsoundcontrol-component-template').html()),getSound:function(){var actionkey=this.model.get('actionkey');var componentSound=this.model.get('sound');if(componentSound.length){var audioSrc=__meta__.directLocation+'exported_view/'+actionkey.split('-').pop()+'/audio/'+actionkey+'/'+componentSound;return audioSrc;}
return false;},getSwfLocation:function(){var swfLocation=__meta__.directLocation+'js/libs/jplayer';return swfLocation;},onNoSkin:function(){this.render();this.unselectComponent();this.selectComponent();},afterRender:function(){var _that=this;this.listenTo(this.model,'change:noskin',this.onNoSkin);var actionkey=this.model.get('actionkey');var playerId=actionkey.split('-')[1];this.$el.find('#audio-player-'+playerId).jPlayer({ready:function(event){$(this).jPlayer("setMedia",{mp3:_that.getSound(),});},supplied:"mp3",cssSelectorAncestor:'#jp-container-'+playerId,wmode:"window",useStateClassSkin:true,autoBlur:false,smoothPlayBar:true,keyEnabled:true,remainingDuration:true,toggleDuration:true});},uploadOnSoundFileDrop:function(e,resizeImage){if(!StageView.instance.canEdit){return;}
this.model.setComponentAsSound();this.resizeImage=resizeImage;this.$el.find('.loaded-dropzone').fadeOut(500);var properties=this.getDropProperties(e);var imageUrl=properties.imageUrl;if(imageUrl!=undefined){this.uploadOnLink(imageUrl,resizeImage);}else{this.runUploadProcess(properties);}},onComponentAdded:function(data){var _that=this;setTimeout(function(){_that.renderPath();},200);}});var InfoPointSoundControlComponentViewNotEditable=ComponentView.createNotEditableComponentClass(InfoPointSoundControlComponentView);;;var InfoPointSoundRecordComponentView=ImageComponentView.extend({className:'component infopointsoundrecord-component',template:_.template($('#infopointsoundrecord-component-template').html()),onComponentAdded:function(data){this.renderPath();}});var InfoPointSoundRecordComponentViewNotEditable=ComponentView.createNotEditableComponentClass(InfoPointSoundRecordComponentView);;;var InfoPointGalleryComponentView=ImageComponentView.extend({className:'component infopointgallery-component',template:_.template($('#infopointgallery-component-template').html()),onComponentAdded:function(data){this.renderPath();}});var InfoPointGalleryComponentViewNotEditable=ComponentView.createNotEditableComponentClass(InfoPointGalleryComponentView);;;var InfoPointDownloadComponentView=ImageComponentView.extend({className:'component infopointdownload-component',template:_.template($('#infopointdownload-component-template').html()),uploadOnDownloadFileDrop:function(e,resizeImage){if(!StageView.instance.canEdit){return;}
this.model.setComponentAsDownload();this.resizeImage=resizeImage;this.$el.find('.loaded-dropzone').fadeOut(500);var properties=e;var imageUrl=properties.imageUrl;if(imageUrl!=undefined){this.uploadOnLink(imageUrl,resizeImage);}else{this.runUploadProcess(properties);}},onComponentAdded:function(data){this.renderPath();}});var InfoPointDownloadComponentViewNotEditable=ComponentView.createNotEditableComponentClass(InfoPointDownloadComponentView);;;var DrawedInfoPointLinkComponentView=LoadedComponentView.extend({className:'component drawedinfopointlink-component',template:_.template($('#drawedinfopointlink-component-template').html()),addComponentListeners:function(){}});var DrawedInfoPointLinkComponentViewNotEditable=ComponentView.createNotEditableComponentClass(DrawedInfoPointLinkComponentView);;;var DrawedInfoPointDownloadComponentView=LoadedComponentView.extend({className:'component drawedinfopointdownload-component',template:_.template($('#drawedinfopointdownload-component-template').html()),addComponentListeners:function(){},getExtensionFilesArray:function(){return['zip','rar','pdf','jpg','png','gif','JPG','JPEG','jpeg','mp3','doc','docx','xls','xlsx','dot','ppt','pptx','assdb','mdb','rtf','odt','dot','mdt','accda','odt','ods','odp'];},getAcceptTypeFormat:function(){var _mainTypes=this.getExtensionFilesArray();var _soundTypes=this.getExtensionSoundsArray();var acceptTypeString='';_.each(_mainTypes,function(option){acceptTypeString+='.'+option+',';});_.each(_soundTypes,function(option){acceptTypeString+='.'+option+',';});return acceptTypeString;},});var DrawedInfoPointDownloadComponentViewViewNotEditable=ComponentView.createNotEditableComponentClass(DrawedInfoPointDownloadComponentView);;;var DrawedInfoPointGalleryComponentView=InfoPointGalleryComponentView.extend({className:'component drawedinfopointgallery-component',template:_.template($('#drawedinfopointgallery-component-template').html()),});var DrawedInfoPointGalleryComponentViewNotEditable=ComponentView.createNotEditableComponentClass(DrawedInfoPointGalleryComponentView);;;var DrawedInfoPointPopupComponentView=LoadedComponentView.extend({className:'component drawedinfopointpopup-component',template:_.template($('#drawedinfopointpopup-component-template').html()),addComponentListeners:function(){},});var DrawedInfoPointPopupComponentViewNotEditable=ComponentView.createNotEditableComponentClass(DrawedInfoPointPopupComponentView);;;var TimerComponentView=TextComponentView.extend({className:'component timer-component',template:_.template($('#timer-component-template').html()),defaultContent:'<span name="hours" style="font-size:30px">00</span><span name="minutes" style="font-size:30px">00</span><span name="seconds" style="font-size:30px">00</span>',defaultText:_lang('TIMER_INSERTTEXT'),addComponentListeners:function(){this.listenTo(this.model,'change:hours',this.renderTime);this.listenTo(this.model,'change:minutes',this.renderTime);this.listenTo(this.model,'change:seconds',this.renderTime);this.listenTo(this.model,'change:hoursEnabled',this.renderTime);this.listenTo(this.model,'change:minutesEnabled',this.renderTime);this.listenTo(this.model,'change:secondsEnabled',this.renderTime);this.listenTo(this.model,"change:enable-scrollbar",this.renderScrollbar,this);},renderTime:function(){var hours=this.retValue(this.model.get('hours'));var minutes=this.retValue(this.model.get('minutes'));var seconds=this.retValue(this.model.get('seconds'));var hoursEnabled=this.model.get('hoursEnabled');var minutesEnabled=this.model.get('minutesEnabled');var secondsEnabled=this.model.get('secondsEnabled');if(!secondsEnabled){seconds="";}
if(!minutesEnabled){minutes="";}
if(!hoursEnabled){hours="";}
this.$el.find('span[name="hours"]').text(hours);this.$el.find('span[name="minutes"]').text(minutes);this.$el.find('span[name="seconds"]').text(seconds);var separatorHours=":";var separatorMinutes=":";if(!secondsEnabled){separatorMinutes="";}
if(!minutesEnabled){separatorMinutes="";}
if(!hoursEnabled){separatorHours="";}
if(hoursEnabled&&(secondsEnabled||minutesEnabled)){separatorHours=":";}
if(hoursEnabled&&(!secondsEnabled&&!minutesEnabled)){separatorHours="";}
this.$el.find('span[name="separator-hours"]').text(separatorHours);this.$el.find('span[name="separator-minutes"]').text(separatorMinutes);},retValue:function(value){var ret=value<10?'0'+value:value;return ret;},afterRender:function(){this.renderTime();this.renderScrollbar();}});var TimerComponentViewNotEditable=ComponentView.createNotEditableComponentClass(TimerComponentView);;;var QuizResultComponentView=TextComponentView.extend({className:'component text-component quiz-result',template:_.template($('#quiz-result-template').html())});var QuizResultComponentViewNotEditable=ComponentView.createNotEditableComponentClass(QuizResultComponentView);;;var ComponentMiniatureView=ItemView.extend({tagName:"li",className:'component-miniature timeline-item component-miniature-delete-option',template:_.template($('#timelineitem-template').html()),events:{'mousedown':'onMouseDown','mouseover':'onMouseOver','mouseout':'onMouseOut','click':'onMouseClick'},onMouseClick:function(e){if(!e.shiftKey){this.$el.trigger('select-comp',[this.model,e]);}},onMouseOver:function(e){this.model.selectedByMiniature(true);},onMouseOut:function(e){this.model.selectedByMiniature(false);},mouseDown:function(e){this.model.selectedByMiniature(false);this.model.selectedByTrigger(false);},addEventsToModel:function(){var _that=this;},initialize:function(){var _that=this;_that.addEventsToModel();},render:function(){var _that=this;var timelineItemTemplate=this.template(this.model.toJSON());this.$el.html(timelineItemTemplate);this.delegateEvents();return this;}});;;var ComponentCollection=Backbone.Collection.extend({model:ComponentModel,events:{'update-sort':'updateSort'},updateSort:function(event,model,position){console.log("updateSort");}});;;var TriggerActionModel=Backbone.Model.extend({defaults:function(){return{group:'',options:[]}}});;;var TriggerActionsCollection=Backbone.Collection.extend({model:TriggerActionModel});;;;;var ComponentView=Backbone.View.extend({tagName:'div',className:'component-selector',initialize:function(data){var _that=this;},events:{'mousedown':'onMouseDown','mouseup':'onMouseUp'},onMouseDown:function(e){e.stopPropagation();},onMouseUp:function(){},render:function(){},makeDraggable:function(){var _that=this;this.$el.draggable({cursor:'move',stop:function(){}});},makeResizable:function(){var _that=this;this.$el.resizable({handles:"n, e, s, w, nw, ne, sw, se",resize:function(){}});}});;;var EditorView=Backbone.View.extend({tagName:'div',template:_.template($('#editor-template').html()),events:{'force-refresh-editor-view':'forceRefreshEditorView'},forceRefreshEditorView:function(){},render:function(){this.beforeRender();CKEDITOR.instances={};var editorTemplate=this.template(this.getJsonModel());this.$el.html(editorTemplate);this.renderPanels();this.disableIfNotActive();this.stickit();this.delegateEvents();return this;},getJsonModel:function(){return this.model.toJSON();},beforeRender:function(){},afterRender:function(){},renderPanels:function(){},newRender:function(){return this;},bindings:{},initialize:function(){this.model=new ComponentModel();this.addListeners();this.onBeforeInitialize();},disableIfNotActive:function(){},onBeforeInitialize:function(){},addListeners:function(){},setModel:function(model){this.unstickit();this.model=model;this.onSetModel();},onSetModel:function(){},setCollection:function(collection){this.unstickit();this.collection=collection;this.onSetCollection(collection);},onSetCollection:function(collection){},destroy:function(){this.unbind();this.remove();}});;;var ExerciseEditorView=EditorView.extend({startEditFeedbackGood:function(){var _that=this;try{this.feedbackGoodEditor=CKEDITOR.replace(this.$el.find('.feedback-good')[0],{height:'100px',plugins:'basicstyles,wysiwygarea,toolbar,list,blockquote,fakeobjects,stylescombo,dialogui,dialog,undo'});this.$el.find('.feedback-good-edit').attr('class','feedback-save feedback-good-save').text(_lang('SAVE'));}catch(msg){_log('ckeditor error',msg,_log.error);}},startEditFeedbackBad:function(){var _that=this;try{this.feedbackBadEditor=CKEDITOR.replace(this.$el.find('.feedback-bad')[0],{height:'100px',plugins:'basicstyles,wysiwygarea,toolbar,list,blockquote,fakeobjects,stylescombo,dialogui,dialog,undo'});this.$el.find('.feedback-bad-edit').attr('class','feedback-save feedback-bad-save').text(_lang('SAVE'));}catch(msg){_log('ckeditor error',msg,_log.error);}},changeFeedbackGood:function(){var feedback=this.feedbackGoodEditor.getData();this.model.set('feedbackGood',feedback);this.render();},changeFeedbackBad:function(feedback){var feedback=this.feedbackBadEditor.getData();this.model.set('feedbackBad',feedback);this.render();},});;;var MultipleEditorView=EditorView.extend({template:_.template($('#multiple-editor-template').html()),disableIfNotActive:function(){var menuBottomTabs=$('#menu-bottom-tabs')
menuBottomTabs.tabs({disabled:[1,2,5,6,7,8]});var active=menuBottomTabs.tabs("option","active");if(active!=0){menuBottomTabs.tabs("option","active",0);StageView.instance.timeline.afterRender();}}});;;var SizeAndPositionEditorView=EditorView.extend({template:_.template($('#size-and-position-editor-template').html()),events:{'click .flip-x-button':'flipX','click .flip-y-button':'flipY'},bindings:{'[name="type"]':'type','[name="position-x"]':{observe:'x',onSet:function(val){return parseInt(val);}},'[name="position-y"]':{observe:'y',onSet:function(val){return parseInt(val);}},'[name="width"]':{observe:'width',onSet:function(val){if(this.model.get('aspectRatio')){var proportions=parseFloat(this.model.get('aspectRatioProportions'));if(parseInt(val)>0){this.model.set('height',parseInt((parseFloat(val)*proportions)/100));}}else{if(this.model){this.model.setProportions();}}
return parseInt(val);}},'[name="height"]':{observe:'height',onSet:function(val){if(this.model.get('aspectRatio')){var proportions=parseFloat(this.model.get('aspectRatioProportions'));if(parseInt(val)>0){this.model.set('width',parseInt((parseFloat(val)*100)/proportions));}}else{if(this.model){this.model.setProportions();}}
return parseInt(val);}},'#rotateAngle':{observe:'rotate',onSet:function(degrees){var radians=degrees*(Math.PI/180);var elementToRotate=this.model.view.getElementToRotate();elementToRotate.rotatable('angle',radians);return radians;},onGet:function(radians){return parseInt((radians>0?radians:(2*Math.PI+radians))*360 /(2*Math.PI));}},'#aspectRatio':'aspectRatio'},onSetModel:function(){this.model.off('on-component-drag');this.model.on('on-component-drag',this.onComponentDrag,this);this.model.off('on-component-resize');this.model.on('on-component-resize',this.onComponentResize,this);this.model.off('on-component-rotate');this.model.on('on-component-rotate',this.onComponentRotate,this);this.model.off('on-component-flip');this.model.on('on-component-flip',this.onComponentFlip,this);this.render();this.addTooltips();},onComponentDrag:function(data){this.$el.find('input[name="position-x"]').val(data.left);this.$el.find('input[name="position-y"]').val(data.top);},onComponentResize:function(data){this.$el.find('input[name="width"]').val(data.width);this.$el.find('input[name="height"]').val(data.height);},onComponentRotate:function(data){this.$el.find('#rotateAngle').val(this.radiansToDegrees(data));},onComponentFlip:function(data){},radiansToDegrees:function(val){return parseInt((val>0?val:(2*Math.PI+val))*360 /(2*Math.PI));},flipX:function(){if(this.model instanceof PageModel){return;}
this.model.flipX();},flipY:function(){if(this.model instanceof PageModel){return;}
this.model.flipY();},addTooltips:function(){this.$el.find('.flip-button').tooltip({placement:'bottom'});}});;;var MultipleSizeAndPositionEditorView=SizeAndPositionEditorView.extend({bindings:{'[name="type"]':'type','[name="position-x"]':'x','[name="position-y"]':'y','[name="width"]':'width','[name="height"]':'height','#aspectRatio':'aspectRatio'},onSetCollection:function(collection){this.model.off('change');this.model.on('change',this.onModelChanged,this);var arrX=[],arrY=[],arrW=[],arrH=[],arrFX=[],arrFY=[];collection.each(function(model){arrX.push(model.get('x'));arrY.push(model.get('y'));arrW.push(model.get('width'));arrH.push(model.get('height'));arrFX.push(model.get('flipX'));arrFY.push(model.get('flipY'));});var x=arrX.reduce(function(a,b){return(a===b)?a:"";});var y=arrY.reduce(function(a,b){return(a===b)?a:"";});var width=arrW.reduce(function(a,b){return(a===b)?a:"";});var height=arrH.reduce(function(a,b){return(a===b)?a:"";});var flipX=arrFX.reduce(function(a,b){return(a===b)?a:"";});var flipY=arrFY.reduce(function(a,b){return(a===b)?a:"";});this.model.set('x',x,{silent:true});this.model.set('y',y,{silent:true});this.model.set('width',width,{silent:true});this.model.set('height',height,{silent:true});this.model.set('flipX',flipX,{silent:true});this.model.set('flipY',flipY,{silent:true});this.render();},onModelChanged:function(model){var _that=this;var x=this.model.get('x');var y=this.model.get('y');var width=this.model.get('width');var height=this.model.get('height');var flipX=this.model.get('flipX');var flipY=this.model.get('flipY');this.collection.each(function(model){if(x!="")model.set('x',x,{silent:true});if(y!="")model.set('y',y,{silent:true});if(width!="")model.set('width',width,{silent:true});if(height!="")model.set('height',height,{silent:true});if(flipX!="")model.set('flipX',flipX,{silent:true});if(flipY!="")model.set('flipY',flipY,{silent:true});model.view.unselectComponent();model.view.render();model.view.selectComponent();model.trigger('change',['x','y','width','height','flipX','flipY']);});}});;;var AlignEditorView=EditorView.extend({template:_.template($('#align-editor-template').html()),alignTimeout:null,events:{'click .align-li':'alignComponents'},bindings:{},findEdge:function(direction){var _that=this;var edge;var _edge;this.collection.each(function(model,index){if(index===0){switch(direction){case'down':edge=parseInt(model.get('y'))+parseInt(model.get('height'));break;case'top':edge=parseInt(model.get('y'));break;case'right':edge=parseInt(model.get('x'))+parseInt(model.get('width'));break;case'left':edge=parseInt(model.get('x'));break;}}
switch(direction){case'down':_edge=parseInt(model.get('y'))+parseInt(model.get('height'));if(_edge>edge){edge=_edge;}
break;case'top':_edge=parseInt(model.get('y'));if(_edge<edge){edge=_edge;}
break;case'right':_edge=parseInt(model.get('x'))+parseInt(model.get('width'));if(_edge>edge){edge=_edge;}
break;case'left':_edge=parseInt(model.get('x'));if(_edge<edge){edge=_edge;}
break;}});return edge;},setNewPosition:function(direction,edge){var _edge;this.collection.each(function(model){switch(direction){case'down':_edge=edge-parseInt(model.get('height'));model.set('y',_edge);break;case'top':model.set('y',edge);break;case'right':_edge=edge-parseInt(model.get('width'));model.set('x',_edge);break;case'left':model.set('x',edge);break;}});},setMiddle:function(direction){var minA,minB;this.collection.each(function(model,index){if(index===0){switch(direction){case'middlex':minA=parseInt(model.get('y'));minB=parseInt(model.get('y'))+parseInt(model.get('height'));break;case'middley':minA=parseInt(model.get('x'));minB=parseInt(model.get('x'))+parseInt(model.get('width'));break;}}else{switch(direction){case'middlex':if(parseInt(model.get('y'))<minA){minA=parseInt(model.get('y'));}
if(parseInt(model.get('y'))+parseInt(model.get('height'))>minB){minB=parseInt(model.get('y'))+parseInt(model.get('height'));}
break;case'middley':if(parseInt(model.get('x'))<minA){minA=parseInt(model.get('x'));}
if(parseInt(model.get('x'))+parseInt(model.get('width'))>minB){minB=parseInt(model.get('x'))+parseInt(model.get('width'));}
break;}}});var middle=(minB-minA)/ 2+minA;this.collection.each(function(model,index){var objW=parseInt(model.get('width'));var objH=parseInt(model.get('height'));switch(direction){case'middlex':var val=middle-(objH / 2);model.set('y',val);break;case'middley':var val=middle-(objW / 2);model.set('x',val);break;}});},setRedistribute:function(direction){var length=0;var lengthAllObjects=0;var min;var max;var sortedCollection=[];this.collection.each(function(model,index){if(index===0){switch(direction){case'redistributex':min=parseInt(model.get('x'));max=parseInt(model.get('x'))+parseInt(model.get('width'));break;case'redistributey':min=parseInt(model.get('y'));max=parseInt(model.get('y'))+parseInt(model.get('height'));break;}}
switch(direction){case'redistributex':lengthAllObjects+=parseInt(model.get('width'));if(parseInt(model.get('x'))<min){min=parseInt(model.get('x'));}
if(parseInt(model.get('x'))+parseInt(model.get('width'))>max){max=parseInt(model.get('x'))+parseInt(model.get('width'));}
sortedCollection.push({val:parseInt(model.get('x')),model:model});break;case'redistributey':lengthAllObjects+=parseInt(model.get('height'));if(parseInt(model.get('y'))<min){min=parseInt(model.get('y'));}
if(parseInt(model.get('y'))+parseInt(model.get('height'))>max){max=parseInt(model.get('y'))+parseInt(model.get('height'));}
sortedCollection.push({val:parseInt(model.get('y')),model:model});break;}});length=max-min;var space=(length-lengthAllObjects)/(this.collection.length-1);sortedCollection.sort(function(a,b){return a.val-b.val;});var lastPosition=min;_.each(sortedCollection,function(obj,index){switch(direction){case'redistributex':obj.model.set('x',lastPosition);lastPosition+=(parseInt(obj.model.get('width'))+space);break;case'redistributey':obj.model.set('y',lastPosition);lastPosition+=(parseInt(obj.model.get('height'))+space);break;}});},alignComponents:function(e){if(this.collection){var _that=this;var target=$(e.currentTarget);var alignDirection=target.attr('align');switch(alignDirection){case'top':case'down':case'left':case'right':var edge=this.findEdge(alignDirection);this.setNewPosition(alignDirection,edge);break;case'middlex':case'middley':this.setMiddle(alignDirection);break;case'redistributex':case'redistributey':this.setRedistribute(alignDirection);break;}}},onSetCollection:function(){this.$el.css('opacity','1');},deactivate:function(){this.$el.css('opacity','.3');}});;;var TimelineEditorView=EditorView.extend({tagName:'div',template:_.template($('#timeline-editor-template').html()),events:{'click .timeline-editor-add-animation-in':'addAnimationIn','click .timeline-editor-add-animation-out':'addAnimationOut','click .timeline-editor-add-animation-over':'addAnimationOver','click .timeline-editor-add-animation-endless':'addAnimationEndless','force-refresh-editor-view':'forceRefreshEditorView'},addAnimationIn:function(e){var animationType='animIn';this.openAnimationWindow(e,animationType);},addAnimationOut:function(e){var animationType='animOut';this.openAnimationWindow(e,animationType);},addAnimationOver:function(e){var animationType='animOver';this.openAnimationWindow(e,animationType);},addAnimationEndless:function(e){var animationType='animEndless';this.openAnimationWindow(e,animationType);},});;;var TimelineMultiEditorView=TimelineEditorView.extend({setCollection:function(componentsCollection){this.componentsCollection=componentsCollection;},afterRender:function(){var objectsData={animIn:[],animOut:[],animOver:[],animEndless:[],lifetime:[]};this.componentsCollection.each(function(cModel){objectsData.animIn.push(cModel.get('animations').animIn.animationPrettyName);objectsData.animOut.push(cModel.get('animations').animOut.animationPrettyName);objectsData.animOver.push(cModel.get('animations').animOver.animationPrettyName);objectsData.animEndless.push(cModel.get('animations').animEndless.animationPrettyName);objectsData.lifetime.push(cModel.get('lifetime'));});var valuesToPopulate={animIn:objectsData.animIn.reduce(function(a,b){return(a===b)?a:"----";}),animOut:objectsData.animOut.reduce(function(a,b){return(a===b)?a:"----";}),animOver:objectsData.animOver.reduce(function(a,b){return(a===b)?a:"----";}),animEndless:objectsData.animEndless.reduce(function(a,b){return(a===b)?a:"----";}),lifetime:objectsData.lifetime.reduce(function(a,b){return(a===b)?a:0;})}
this.$el.find('.timeline-editor-add-animation-in').attr('value',valuesToPopulate.animIn);this.$el.find('.timeline-editor-add-animation-out').attr('value',valuesToPopulate.animOut);this.$el.find('.timeline-editor-add-animation-over').attr('value',valuesToPopulate.animOver);this.$el.find('.timeline-editor-add-animation-endless').attr('value',valuesToPopulate.animEndless);this.$el.find('.timeline-editor-object-lifetime').val(valuesToPopulate.lifetime);},openAnimationWindow:function(e,windowType){var _that=this;if(this.animationWindowView==undefined){var animationData=this.componentsCollection.at(0).get('animations')[windowType];this.animationWindowView=WindowFactory.createAnimateWindow(animationData);this.animationWindowView.on('on-close',function(){_that.animationWindowView=undefined;});this.animationWindowView.on('on-animation-selected',function(choosenAnimationData){_that.animationWindowView=undefined;_that.componentsCollection.each(function(cModel){cModel.get('animations')[windowType]=choosenAnimationData;cModel.trigger('change');});_that.render();_that.afterRender();});$('body').append(this.animationWindowView.render({title:_lang('ANIMATIONWINDOW_TITLE_'+windowType),animations:window._layout.animations[windowType],animationMainType:windowType}).$el);var windowPosition={top:e.pageY,left:e.pageX}
this.animationWindowView.setWindowPosition(windowPosition);}},changeComponentsLifetime:function(e){var lifetimeValue=parseInt($(e.target).val());this.componentsCollection.each(function(cModel){cModel.set('lifetime',lifetimeValue);});},setRowModel:function(rowModel){this.model=rowModel;}});;;var TimelineComponentEditorView=TimelineEditorView.extend({template:_.template($('#timeline-editor-template').html()),bindings:{'.timeline-editor-object-lifetime':{observe:'lifetime',onGet:function(val){val=parseInt(val);return val===0?'':val;}},'.timeline-editor-object-showtime':{observe:'showtime'}},events:function(){return _.extend({},TimelineEditorView.prototype.events,{'change .timeline-editor-object-lifetime':'renderComponent','keyup .timeline-editor-object-lifetime':'renderComponent','paste .timeline-editor-object-lifetime':'renderComponent','mousewheel .timeline-editor-object-lifetime':'renderComponent','change .timeline-editor-object-showtime':'renderComponent','keyup .timeline-editor-object-showtime':'renderComponent','paste .timeline-editor-object-showtime':'renderComponent','mousewheel .timeline-editor-object-showtime':'renderComponent'});},openAnimationWindow:function(e,windowType){var _that=this;if(this.animationWindowView==undefined){var animationData=this.model.get('animations')[windowType];this.animationWindowView=WindowFactory.createAnimateWindow(animationData);this.animationWindowView.on('on-close',function(){_that.animationWindowView=undefined;});this.animationWindowView.on('on-animation-selected',function(choosenAnimationData){_that.animationWindowView=undefined;_that.model.get('animations')[windowType]=choosenAnimationData;_that.model.trigger('change');_that.render();_that.afterRender();});$('body').append(this.animationWindowView.render({title:_lang('ANIMATIONWINDOW_TITLE_'+windowType),animations:window._layout.animations[windowType],animationMainType:windowType}).$el);var windowPosition={top:e.pageY,left:e.pageX};this.animationWindowView.setWindowPosition(windowPosition);}},afterRender:function(){this.$el.find('.timeline-editor-add-animation-in').attr('value',this.model.get('animations').animIn.animationPrettyName);this.$el.find('.timeline-editor-add-animation-out').attr('value',this.model.get('animations').animOut.animationPrettyName);this.$el.find('.timeline-editor-add-animation-over').attr('value',this.model.get('animations').animOver.animationPrettyName);this.$el.find('.timeline-editor-add-animation-endless').attr('value',this.model.get('animations').animEndless.animationPrettyName);},onSetModel:function(){var _that=this;this.model.off('refresh-timeline-editor-numbers');this.model.on('refresh-timeline-editor-numbers',function(){_that.refreshNumberFields();});},refreshNumberFields:function(){var lifetime=parseInt(this.model.get('lifetime'));var lifetimeVal=lifetime===0?'':lifetime;this.$el.find('.timeline-editor-object-lifetime').val(lifetimeVal);this.$el.find('.timeline-editor-object-showtime').val(this.model.get('showtime'));},renderComponent:function(){this.model.miniatureView.afterRender();}});;;var TimelineComponentsCollectionEditorView=TimelineMultiEditorView.extend({template:_.template($('#timeline-editor-collection-template').html()),events:function(){return _.extend({},TimelineEditorView.prototype.events,{'change .timeline-editor-object-lifetime':'changeComponentsLifetime',});}});;;var TimelineRowEditorView=TimelineMultiEditorView.extend({template:_.template($('#timeline-editor-row-template').html()),events:function(){return _.extend({},TimelineEditorView.prototype.events,{'change .timeline-editor-object-lifetime':'changeComponentsLifetime','change .timeline-editor-line-delay':'changeRowDelay'});},bindings:{'.timeline-editor-line-delay':{observe:'delay',onSet:this.changeRowDelay}},changeRowDelay:function(){var _that=this;DataAccess.updateTimelineOptions({pageId:StageView.instance.model.getPageId(),rowOptions:_that.model},function(data){_log('Update timeline options result: ',data,_log.dataaccessOutResult)},function(data){_log('Update timeline options fault: ',data,_log.dataaccessOutFault)});StageView.instance.timeline.render();StageView.instance.timeline.afterRender();}});;;var TimelineStageEditorView=TimelineEditorView.extend({template:_.template($('#timeline-editor-stage-template').html()),events:{'click .change-timeline-button':'changeTimeline'},bindings:{'.timeline-editor-stage-lifetime':{observe:'stageLifetime',onSet:function(val){if(!$.isNumeric(val)){val=60;}
return val;}}},changeTimeline:function(){this.trigger('change-timeline');},changeStageLifetime:function(e){var stageLifetime=parseInt($(e.target).val());this.model.set('stageLifetime',stageLifetime);}});;;var WcagEditorView=EditorView.extend({template:_.template($('#wcag-editor-template').html()),bindings:{'.wcag-editor-consider':{observe:'wcag',afterUpdate:function(val){this.render();return val;},onSet:function(val){this.render();return val;}},'.wcag-editor-to-read':'wcagMessage'},onSetModel:function(){this.render();}});;;var MultipleWcagEditorView=WcagEditorView.extend({template:_.template($('#multiple-editor-template').html()),onSetCollection:function(collection){this.render();}});;;var ScoreEditorView=EditorView.extend({template:_.template($('#score-editor-template').html()),bindings:{'#scoring-reqire-pages':'require_pages','#scoring-reqire-points':'require_score','#scoring-reqire-points-percent':'require_score_points','#scoring-reqire-points-number':'max_points_number','#content-continue-popup':'continue_method','#content-continue-auto':'continue_method','#content-continue-none':'continue_method','#scoring-calculate_points-automatically':'calc_points_automatically',},events:function(){return _.extend({},EditorView.prototype.events,{'change #scoring-reqire-pages':'onChangeRequirePages',});},initialize:function(){this.projectModel=ProjectModel.instance;var optionsModel=this.projectModel.get('options');this.model=optionsModel;},renderCalcPointsAutomatically:function(){var calcPointsAutomatically=this.model.get('calc_points_automatically');if(calcPointsAutomatically){this.$el.find('#scoring-reqire-points-number').attr('disabled','disabled');ProjectModel.instance.calculateAllScoreSuccessPoints();}else{this.$el.find('#scoring-reqire-points-number').removeAttr('disabled');}},onChangeRequirePages:function(e){var value=$(e.target).prop('checked');this.model.set('require_pages',value);},beforeRender:function(){this.unstickit();},afterRender:function(){this.stickit();},onProjectOptionChangesComing:function(projectOptions){this.renderEditor();},setModel:function(){this.model.off('change:calc_points_automatically',this.renderCalcPointsAutomatically,this);this.model.off('option-changes-coming',this.onProjectOptionChangesComing,this);this.projectModel=ProjectModel.instance;var optionsModel=this.projectModel.get('options');this.model=optionsModel;this.model.on('change:calc_points_automatically',this.renderCalcPointsAutomatically,this);this.model.on('option-changes-coming',this.onProjectOptionChangesComing,this);this.renderEditor();},renderEditor:function(){this.render();this.renderCalcPointsAutomatically();}});;;var ReportEditorView=EditorView.extend({template:_.template($('#report-editor-template').html()),bindings:{},renderPanels:function(){var panel=MenuPanelsFactory.createReportsPanel();panel.setModel(this.model);this.$el.append(panel.render().$el);panel.afterRender();},onSetModel:function(){},});;;var MultipleReportEditorView=ReportEditorView.extend({template:_.template($('#multiple-editor-template').html()),onSetCollection:function(collection){}});;;var PublishScoreEditorView=ScoreEditorView.extend({el:'',template:_.template($('#publish-score-editor-template').html())});;;var ScoreExerciseEditorView=EditorView.extend({templateExercise:_.template($('#score-exercise-editor-template').html()),templateEmptyExercise:_.template($('#score-exercise-empty-editor-template').html()),bindings:{'.scoring-reqire-exercise-points-aaccess':'scoreSuccess','.scoring-reqire-exercise-points-fail':'scoreFail','.scoring-reqire-exercise-points-bad-answer':'scoreBadAnswer','input[name="attempts"]':{observe:'attempts',onSet:function(val){return val==0?'':val;},onGet:function(val){return val==0?'':val;}}},initialize:function(){this.template=this.templateEmptyExercise;},beforeRender:function(){},afterRender:function(){},setModel:function(model){if(model instanceof Backbone.Model){if(this.checkIfExercise(model)){this.template=this.templateExercise;model.on('trigger-changed',this.renderEditor,this);}else{this.template=this.templateEmptyExercise;}}else if(model instanceof Backbone.Collection){this.template=this.templateEmptyExercise;}
this.model=model;this.onSetModel();this.render();this.addTitleToButtons();},checkIfExercise:function(model){switch(model.get('type')){case'quiz':case'quiz-selectone':case'quiz-connectlines':case'quiz-dnd':case'quiz-inputtext':case'quiz-select':case'quiz-wordsearch':case'crossword':return true;break;default:return false;break;}},renderEditor:function(model){if(model.changed.scoreSuccess!=undefined||model.changed.scoreFail!=undefined||model.changed.scoreBadAnswer!=undefined){}else{this.render();this.addTitleToButtons();}},getTriggerChangeVarValueAction:function(){if(!this.checkIfExercise(this.model)){return true;}
var triggers=this.model.get('triggers');if(triggers==undefined){return true;}
var changeValueActionPassed=[];var changeValueActionFailed=[];var changeValueActionBadAnswer=[];for(var i=0;i<triggers.length;i++){var trigger=triggers[i];var subtriggers=trigger.subtriggers;var whenDoIt=trigger.whendoit;if(whenDoIt=='custom_questionpassed'){for(var j=0;j<subtriggers.length;j++){var subtrigger=subtriggers[j];var whattodo=subtrigger.whattodo;var objs=subtrigger.objs;if(whattodo=='changevarvalue'&&objs.varName=='00000000000000000000000000000000'){changeValueActionPassed.push(whattodo);this.passedSubtrigger=subtrigger;}
if(whattodo=='changevarvalue'&&objs.varName=='00000000000000000000000000000000'&&objs.varAction!='add'&&objs.varAction!=''){changeValueActionPassed.push(whattodo);}}}
if(whenDoIt=='custom_questionfailed'){for(var j=0;j<subtriggers.length;j++){var subtrigger=subtriggers[j];var whattodo=subtrigger.whattodo;var objs=subtrigger.objs;if(whattodo=='changevarvalue'&&objs.varName=='00000000000000000000000000000000'){changeValueActionFailed.push(whattodo);this.failedSubtrigger=subtrigger;}
if(whattodo=='changevarvalue'&&objs.varName=='00000000000000000000000000000000'&&objs.varAction!='add'&&objs.varAction!=''){changeValueActionFailed.push(whattodo);}}}
if(whenDoIt=='custom_questionbadanswer'){for(var j=0;j<subtriggers.length;j++){var subtrigger=subtriggers[j];var whattodo=subtrigger.whattodo;var objs=subtrigger.objs;if(whattodo=='changevarvalue'&&objs.varName=='00000000000000000000000000000000'){changeValueActionBadAnswer.push(whattodo);this.badanswerSubtrigger=subtrigger;}
if(whattodo=='changevarvalue'&&objs.varName=='00000000000000000000000000000000'&&objs.varAction!='add'&&objs.varAction!=''){changeValueActionBadAnswer.push(whattodo);}}}};var action={changeValueActionPassed:changeValueActionPassed,changeValueActionFailed:changeValueActionFailed,changeValueActionBadAnswer:changeValueActionBadAnswer}
if(changeValueActionPassed.length==0){if(this.model.get('scoreSuccess')!=0){this.model.set('scoreSuccess',0,{silent:true});this.model.trigger('change');}}
if(changeValueActionFailed.length==0){if(this.model.get('scoreFail')!=0){this.model.set('scoreFail',0,{silent:true});this.model.trigger('change');}}
if(changeValueActionBadAnswer.length==0){if(this.model.get('scoreBadAnswer')!=0){this.model.set('scoreBadAnswer',0,{silent:true});this.model.trigger('change');}}
return action;},getJsonModel:function(){return{model:this.model.toJSON(),changeValueAction:this.getTriggerChangeVarValueAction()};},addTitleToButtons:function(){this.$el.find('[title]').tooltip({html:true,animated:'fade',placement:'right',width:300,height:200});},findSubtriggerOpts:function(){var triggers=this.model.get('triggers');if(triggers==undefined){return undefined;}
for(var i=0;i<triggers.length;i++){var trigger=triggers[i];var subtriggers=trigger.subtriggers;var whenDoIt=trigger.whendoit;if(whenDoIt=='custom_questionpassed'){for(var j=0;j<subtriggers.length;j++){var subtrigger=subtriggers[j];var whattodo=subtrigger.whattodo;var objs=subtrigger.objs;if(whattodo=='changevarvalue'&&objs.varName=='00000000000000000000000000000000'&&objs.varAction=='add'){return{objs:objs,triggerId:i,subtriggerId:j};}}}}
return undefined;},});;;var MultipleScoreEditorView=ScoreEditorView.extend({template:_.template($('#multiple-editor-template').html()),onSetCollection:function(collection){this.render();}});;;var PagenoteEditorView=EditorView.extend({template:_.template($('#pagenote-editor-template').html()),bindings:{'textarea[name="page-note"]':'note'},onSetModel:function(){this.render()}});;;var SoundEditorView=EditorView.extend({template:_.template($('#sound-editor-template').html()),bindings:{'.autoplay-sound':'autoplaySound',},events:function(){return _.extend({},EditorView.prototype.events,{'click .add-sound-file-to-component':'addSoundToComponent','click .add-sound-file-to-page':'addSoundToPage','click .editor-delete-page-sound-file':'deleteSoundToPage','click .editor-delete-component-sound-file':'deleteSoundToComponent','change [name="sound-volume"]':'changeSoundVolume'});},changeSoundVolume:function(e){var val=$(e.currentTarget).val();this.model.set('volume',val);},deleteSoundToComponent:function(){var fileName=this.model.get('sound');var actionkey=this.model.get('actionkey');if(fileName===''){fileName=this.model.get('point-sound');}
this.deleteFileSoundOnServer(actionkey,fileName);},deleteFileSoundOnServer:function(actionkey,fileName){var _that=this;DataAccess.updateComponents({components:[_that.model],action:"delete-file-sound",fileName:fileName,actionkey:actionkey,pageId:StageView.instance.model.getPageId()},function(data){_log('Update component result: ',data,_log.dataaccessOutResult);_that.model.set('sound','',{silent:true});_that.model.set('point-sound','',{silent:true});_that.render();},function(data){_log('Update component fault: ',data,_log.dataaccessOutFault);});},deleteSoundToPage:function(){this.model.setFileName({fileName:''});this.render();this.model.view.deleteSound(this.model);},addSoundToPage:function(){this.model.view.uploadOnClick();},addSoundToComponent:function(){this.model.view.uploadOnClick();},setModel:function(model){var options=model.get('options');this.unstickit();if(options===undefined){this.model=model;}else{this.model=options;this.pageModel=this.model;}
this.onSetModel();},onSetModel:function(){if(this.model.get('sound')!==undefined){this.listenTo(this.model,'change:sound',this.render);}else
if(this.model.get('point-sound')!==undefined){this.listenTo(this.model,'change:point-sound',this.render);}else
if(this.model.get('soundfilename')!==undefined){this.listenTo(this.model,'change:soundfilename',this.render);}}});;;var LoadedSoundUploaderView=EditorView.extend({events:function(){return _.extend({},EditorView.prototype.events,{'dragenter':'onFileDragOver','dragleave .loaded-dropzone':'onFileDragOut','drop .loaded-dropzone':'uploadOnFileDrop'});},onFileDragOver:function(e){e.stopPropagation();this.$el.find('.loaded-dropzone').fadeIn(200);},onFileDragOut:function(e){e.stopPropagation(e);this.$el.find('.loaded-dropzone').fadeOut(200);},getAcceptTypeFormat:function(){return this.model.getAcceptTypeFormat();},getDropProperties:function(e){var imageUrl;var file=e.originalEvent.dataTransfer.files[0];var data;if(file!=undefined){var imageName=file.name;var imageData=e.originalEvent.dataTransfer.result;data={name:imageName,data:imageData,size:file.size};}else{imageUrl=e.originalEvent.dataTransfer.getData('text');}
return{file:file,data:data,imageUrl:imageUrl};},uploadOnPaste:function(e,blob,resizeImage){var _that=this;if(!StageView.instance.canEdit){return;}
if(this.model.get('locked')){return;}
this.resizeImage=resizeImage;var reader=new FileReader();reader.onload=function(e){var data={name:'copyimage.png',data:event.target.result,size:blob.size};_that.runUploadProcess({file:blob,data:data});};reader.readAsDataURL(blob);},getInputProperties:function(e,input){return FileUploader.getInputProperties(e,input);},uploadOnClick:function(){var _that=this;var acceptTypeFormat=this.getAcceptTypeFormat();var input=$('<input type="file" name="files[]" accept="'+acceptTypeFormat+'">');input.css({display:'none'});this.$el.append(input);input.click();input.change(function(e){_that.uploadOnInputData(e,this,false);$(this).remove();});},uploadOnFileDrop:function(e,resizeImage){if(Utils.isDarkanExtension(e)){return;};if(!StageView.instance.canEdit){return;}
this.resizeImage=resizeImage;this.$el.find('.loaded-dropzone').fadeOut(500);var properties=this.getDropProperties(e);var imageUrl=properties.imageUrl;if(imageUrl!=undefined){this.uploadOnLink(imageUrl,resizeImage);}else{this.runUploadProcess(properties);}},createLoaderImage:function(){var img=$('<img>');img.attr('src','content_template/css/gif-load.gif');img.addClass('page-item-loader-link');return img;},uploadOnInputData:function(e,input,resizeImage){this.resizeImage=resizeImage;var properties=this.getInputProperties(e,input);this.runUploadProcess(properties);},runUploadProcess:function(properties){if(this.model.uploadingNow){return;}
var specialData=this.getSpecialProperties();var toSend=$.extend({},properties,specialData);this.fileUploader=new ProjectSoundUploader();this.fileUploader.setView(this.model);this.fileUploader.setView2(this);if(this.fileUploader==undefined){this.showPupup({content:_lang('FILETYPE_NOT_ACCEPTED'),title:_lang('MODAL_INFO_ERROR')},this);return;}
this.fileUploader.sendFile(toSend);this.fileUploader.on('on-result',this.onResult,this);this.fileUploader.on('on-fault',this.onFault,this);this.fileUploader.on('on-complete',this.onComplete,this);this.fileUploader.on('on-progress',this.onProgress,this);},onResult:function(data){if(data.key==1){this.showPupup({content:_lang('FILETYPE_NOT_ACCEPTED'),title:_lang('MODAL_INFO_ERROR')},this);return;}},onFault:function(data){this.showPupup({content:_lang('FILETYPE_NOT_ACCEPTED'),title:_lang('MODAL_INFO_ERROR')},this);},showPupup:function(data,sender){var popup=PopupFactory.createErrorPopup(data,sender);$('body').append(popup.render(data).$el);},onComplete:function(data){var _that=this;this.hideProgressPercent(data);this.fileUploader.off();this.fileUploader=undefined;this.render();},onProgress:function(data){this.showProgressPercent(data);},getSpecialProperties:function(){return{};},showProgressPercent:function(data){FileUploader.showProgressPercent(data,this);},hideProgressPercent:function(data){FileUploader.hideProgressPercent(data,this);},});;;var SoundUploaderEditorView=LoadedSoundUploaderView.extend({template:_.template($('#sound-uploader-editor-template').html()),bindings:{'#loop-sound-project-checkbox':'sound_loop',},events:function(){return _.extend({},LoadedSoundUploaderView.prototype.events,{'click .add-sound-to-project':'addSoundToProject','click .editor-delete-project-sound-file':'deleteProjectSound','click #loop-sound-project-checkbox':'changeSoundLoop','change [name="sound-volume"]':'changeSoundVolume'});},addSoundToProject:function(e){var _that=this;var acceptTypeFormat='.mp3';var input=$('<input type="file" name="files[]" accept="'+acceptTypeFormat+'">');input.css({display:'none'});this.$el.append(input);input.click();input.change(function(e){_that.uploadOnInputData(e,this,false);$(this).remove();});},changeSoundVolume:function(e){var val=$(e.currentTarget).val();this.model.set('sound_vol',val);},changeSoundLoop:function(e){var val=$(e.currentTarget).prop('checked');this.model.set('sound_loop',val);},deleteProjectSound:function(actionkey,fileName){this.model.set('soundfilename','');this.render();},setModel:function(model){this.model=model;},});;;var MultipleSoundEditorView=SoundEditorView.extend({template:_.template($('#multiple-editor-template').html()),onSetCollection:function(collection){this.render();}});;;var TextEditorView=EditorView.extend({template:_.template($('#text-editor-template').html()),bindings:{'[class="enable-scrollbar"]':'enable-scrollbar','#text-editor-padding':'padding'},events:function(){return _.extend({},EditorView.prototype.events,{'change .enable-scrollbar':'onEnableScrollbar','click .editor-add-border-button':'showBorderWindow'});},showBorderWindow:function(){this.model.view.addBorder();},onSetModel:function(){var _that=this;this.model.off('refresh-bottom-editor');this.model.on('refresh-bottom-editor',function(){_that.afterRender();});},forceRefreshEditorView:function(){this.afterRender();},afterRender:function(){var _that=this;this.colorPicker();this.listenTo(this.model,'change:padding',this.onPaddingChange);},colorPicker:function(){var _that=this;var styles=_that.model.get('styles');var gradientSaveTimeout=null;var background='#FFF';if(_.isUndefined(styles['component-gradient'])){styles['component-gradient']={};}
if(!_.isUndefined(styles['component-gradient']['background'])){background=styles['component-gradient']['background'];}
this.textBgColorPicker=new GradientPickerView({color:background});this.$el.find('.text-color-picker-container').html(this.textBgColorPicker.render().$el);this.textBgColorPicker.afterRender();this.textBgColorPicker.on('move',function(data){styles['component-gradient']['background']=data.color;_that.model.set('styles',styles,{silent:true});_that.model.view.$el.find('.component-inner').css('background',data.color);_that.$el.find('.picker-container').css('background',data.color);});this.textBgColorPicker.on('gradient-change',function(data){_that.model.view.$el.find('.component-inner').css('background',data.color);clearTimeout(gradientSaveTimeout);styles['component-gradient']['background']=data.color;_that.model.set('styles',styles,{silent:true});gradientSaveTimeout=setTimeout(function(){_that.model.trigger('change');},500);});this.textBgColorPicker.on('hide',function(data){_that.model.trigger('change');});},onPaddingChange:function(){this.model.view.renderPadding();},onEnableScrollbar:function(e){var value=$(e.target).prop('checked');this.model.set('enable-scrollbar',value);}});;;var TextToolbarEditorView=EditorView.extend({el:$('menu-text'),bindings:{},events:{},onSetModel:function(){this.render()}});;;var ImageEditorView=EditorView.extend({template:_.template($('#image-editor-template').html()),bindings:{'[name="opacity"]':'opacity'},events:function(){return _.extend({},EditorView.prototype.events,{'change input[name="opacity"]':'onOpacityChanged','click .add-image-file':'addNewImage','click .editor-crop-image-button':'showCropWindow','click .editor-resize-to-stage-button':'resizeToStage','click .editor-original-size-button':'originalSize','click .editor-add-border-button':'showBorderWindow','click .edit-image-file':'editImage'});},showBorderWindow:function(){this.model.view.addBorder();},editImage:function(){var photopeaWindowView=WindowFactory.createPhotopeaWindow({componentModel:this.model});$('body').append(photopeaWindowView.render().$el);},resizeToStage:function(){var pageWidth=StageView.instance.model.get('options').get('width');var pageHeight=StageView.instance.model.get('options').get('height');this.model.set('x',0);this.model.set('y',0);this.model.set('width',pageWidth);this.model.set('height',pageHeight);this.model.view.createMiniature();this.render();},originalSize:function(){var _that=this;var pageID=StageView.instance.model.get('options').get('pageid');var actionkey=this.model.get('actionkey');var fileName=this.model.get('imageFileName');DataAccess.getImageSize({pageID:pageID,actionkey:actionkey,fileName:fileName},function(data){var dim=data.size.split('x');var width=parseInt(dim[0]);var height=parseInt(dim[1]);_that.model.set('width',width);_that.model.set('height',height);_that.model.view.createMiniature();},function(data){_log('data',data)});},resizeImage:function(){var pageID=StageView.instance.model.get('options').get('pageid');var actionkey=this.model.get('actionkey');var fileName=this.model.get('imageFileName');var width=this.model.get('width');var height=this.model.get('height');DataAccess.resizeImage({pageID:pageID,actionkey:actionkey,fileName:fileName,width:width,height:height},function(data){},function(data){_log('data',data)});},showCropWindow:function(){var _that=this;this.model.view.showCropWindow();},addNewImage:function(){this.model.setComponentAsImage();this.model.view.showImageWindow();},onSetModel:function(){this.listenTo(this.model,'change:imageFileName',this.render);},onOpacityChanged:function(e){var value=$(e.target).val();_log('onOpacityChanged',value);this.model.set('opacity',value);}});;;var VideoEditorView=EditorView.extend({template:_.template($('#video-editor-template').html()),events:function(){return _.extend({},EditorView.prototype.events,{'click .editor-video-add-file':'addVideo','click .editor-video-delete-file':'deleteVideo'});},bindings:{'.video-editor-link-holder':'videoLink','input[name="video-autoplay-chck"]':'videoAutoplay','input[name="video-controls-chck"]':'videoControls','input[name="video-loop-chck"]':'videoLoop',},deleteVideo:function(){var actionkey=this.model.get('actionkey');var fileName=this.model.get('videoFileName');this.deleteFileVideoOnServer(actionkey,fileName);},deleteFileVideoOnServer:function(actionkey,fileName){var _that=this;DataAccess.updateComponents({components:[_that.model],action:"delete-file-video",fileName:fileName,actionkey:actionkey,pageId:StageView.instance.model.getPageId()},function(data){_that.model.set('videoFileName','',{silent:true});_that.render();},function(data){_log('Update component fault: ',data,_log.dataaccessOutFault)});},addVideo:function(){this.model.view.uploadOnClick();},onSetModel:function(){this.listenTo(this.model,'change:videoFileName',this.render);}});;;var QuizEditorView=ExerciseEditorView.extend({template:_.template($('#quiz-editor-template').html()),events:function(){return _.extend({},EditorView.prototype.events,{'click .feedback-good-edit':'startEditFeedbackGood','click .feedback-bad-edit':'startEditFeedbackBad','click .feedback-good-save':'changeFeedbackGood','click .feedback-bad-save':'changeFeedbackBad','change .quiz-font-size':'changeFontSize'});},bindings:{'input[name="multiselect"]':{observe:'multiselect',onSet:function(val){if(!val){var iter=0;var answers=this.model.get('answers');_.each(answers,function(option,i){if(iter===0){answers[i].goodAnswer=true;}else{answers[i].goodAnswer=false;}
iter++;});this.model.set('answers',answers);this.model.trigger('change');}
return val;}},'input[name="feedback-show"]':'feedbackShow','input[name="feedback-sign"]':'feedbackSign','input[name="attempts"]':'attempts','input[name="button-show"]':'buttonShow','input[name="mark-questions"]':'markQuestions','input[name="quiz-font-size"]':'fontSize'},changeFontSize:function(e){var value=parseInt($(e.target).val());this.model.set('fontSize',value);this.model.view.render();this.model.view.startEditing();},onSetModel:function(){this.feedbackBadEditor=null;this.feedbackGoodEditor=null;}});;;var QuizSelectOneEditorView=ExerciseEditorView.extend({template:_.template($('#quizselectone-editor-template').html()),events:function(){return _.extend({},EditorView.prototype.events,{'click input[name="multiselect"]':'changeMultiselect','click .feedback-good-edit':'startEditFeedbackGood','click .feedback-bad-edit':'startEditFeedbackBad','click .feedback-good-save':'changeFeedbackGood','click .feedback-bad-save':'changeFeedbackBad'});},bindings:{'input[name="multiselect"]':'multiselect','input[name="feedback-show"]':'feedbackShow','input[name="feedback-sign"]':'feedbackSign','input[name="attempts"]':'attempts','input[name="button-show"]':'buttonShow','input[name="mark-questions"]':'markQuestions'},changeMultiselect:function(e){if($(e.target).is(':checked')){}else{var iter=0;var answers=this.model.get('answers');_.each(answers,function(option,i){if(iter===0){answers[i].goodAnswer=true;}else{answers[i].goodAnswer=false;}
iter++;});this.model.set('answers',answers);this.model.trigger('change');}
this.render();},onSetModel:function(){this.feedbackBadEditor=null;this.feedbackGoodEditor=null;}});;;var QuizFillInBlanksEditorView=EditorView.extend({template:_.template($('#quizfillinblanks-editor-template').html()),bindings:{'[class="enable-scrollbar"]':'enable-scrollbar','#text-editor-padding':'padding'},events:function(){return _.extend({},EditorView.prototype.events,{'click input[name="multiselect"]':'changeMultiselect','click input[name="feedback-show"]':'changeFeedbackShow','click input[name="feedback-sign"]':'changeFeedbackSign','click input[name="check-self"]':'changecheckSelf','click input[name="button-show"]':'changeButtonShow','keyup .feedback-good':'changeFeedbackGood','keyup .feedback-bad':'changeFeedbackBad','change .enable-scrollbar':'onEnableScrollbar','click .editor-add-border-button':'showBorderWindow'});},afterRender:function(){var _that=this;this.listenTo(this.model,'change:padding',this.onPaddingChange);},showBorderWindow:function(){this.model.view.addBorder();},changeFeedbackGood:function(e){this.model.set('feedbackGood',$(e.target).val());},changeFeedbackBad:function(e){this.model.set('feedbackBad',$(e.target).val());},changeMultiselect:function(e){if($(e.target).is(':checked')){}else{var iter=0;var answers=this.model.get('answers');_.each(answers,function(option,i){if(iter===0){answers[i].goodAnswer=true;}else{answers[i].goodAnswer=false;}
iter++;});this.model.set('answers',answers);this.model.trigger('change');}
this.model.set('multiselect',$(e.target).is(':checked'));this.render();},changeFeedbackShow:function(e){this.model.set('feedbackShow',$(e.target).is(':checked'));},changeFeedbackSign:function(e){this.model.set('feedbackSign',$(e.target).is(':checked'));},changecheckSelf:function(e){this.model.set('checkSelf',$(e.target).is(':checked'));},changeButtonShow:function(e){this.model.set('buttonShow',$(e.target).is(':checked'));},onPaddingChange:function(){this.model.view.renderPadding();},onEnableScrollbar:function(e){var value=$(e.target).prop('checked');this.model.set('enable-scrollbar',value);}});;;var QuizDnDEditorView=ExerciseEditorView.extend({template:_.template($('#quizdnd-editor-template').html()),events:function(){return _.extend({},EditorView.prototype.events,{'keyup .dnd-submit-btn-text':'changeButtonTitle','click .dnd-picker-container[dndm]':'runDataPicker','click .dnd-picker-goodanswer[dndm]':'runDataPicker','click .dnd-editor-draggableobjs-addobjects':'runDataPicker','click .dnd-container-delete':'deleteContainer','click .dnd-object-good':'deleteGoodObject','click .dnd-object':'deleteObject','mouseenter .ex-object':'highlightOnStage','mouseleave .ex-object':'unhighlightOnStage','click .dnd-container-edit':'editContainer','click .dnd-options-answers':'editDnDoptions','click .dnd-container-editall-container':'editAllContainer','click .feedback-good-edit':'startEditFeedbackGood','click .feedback-bad-edit':'startEditFeedbackBad','click .feedback-good-save':'changeFeedbackGood','click .feedback-bad-save':'changeFeedbackBad'});},bindings:{'#quiz-dnd-attempts':'attempts'},initialize:function(data){this.stageView=data.stageView;},highlightOnStage:function(e){var actionkey=$(e.currentTarget).attr('actionkey');if(actionkey){var cModel=StageView.instance.getComponentModelByActionkey(actionkey);if(cModel){cModel.selectedByPickerMiniature(true);}}},unhighlightOnStage:function(e){var actionkey=$(e.currentTarget).attr('actionkey');if(actionkey){var cModel=StageView.instance.getComponentModelByActionkey(actionkey);if(cModel){cModel.selectedByPickerMiniature(false);}}},editDnDoptions:function(e){var windowOption={left:e.pageX,top:e.pageY};this.showDnDOptionsWindow(windowOption);},editContainer:function(e){this.showEditWindow(e);},editAllContainer:function(e){var windowOption={left:e.pageX,top:e.pageY};this.showEditAllWindow(windowOption);},changeButtonTitle:function(e){var buttonTitle=$(e.target).val();this.model.set('buttonTitle',buttonTitle);},deleteObject:function(e){var objActionkey=$(e.target).attr('dndb');var answers=this.model.get('answers');var draggableObjs=this.model.get('draggableObjs');var paID=draggableObjs.indexOf(objActionkey);if(paID!==-1){draggableObjs.splice(paID,1);}
_.each(answers,function(val,containerActionkey){paID=val.pa.indexOf(objActionkey);if(paID!==-1){val.pa.splice(paID,1);}});this.model.set('answers',answers);this.model.trigger('change');this.unhighlightOnStage(e);this.render();this.afterRender();},deleteGoodObject:function(e){var goodActionkey=$(e.target).attr('dndg');var containerActionkey=$(e.target).attr('dndm');var answers=this.model.get('answers');var objs=this.model.get('draggableObjs');if(!_.isUndefined(answers[containerActionkey])){this.deleteFromAllObjects(goodActionkey);var paID=answers[containerActionkey].pa.indexOf(goodActionkey);if(paID!==-1){answers[containerActionkey].pa.splice(paID,1);}
this.model.set('answers',answers);this.model.set('objs',objs);this.model.trigger('change');this.unhighlightOnStage(e);this.render();this.afterRender();}},deleteContainer:function(e){var _that=this;var container=$(e.target).attr('dndm');var answers=this.model.get('answers');if(!_.isUndefined(answers[container])){_.each(answers[container].pa,function(objActionkey){_that.deleteFromAllObjects(objActionkey);});delete answers[container];this.model.set('answers',answers);this.model.trigger('change');this.render();this.afterRender();}},deleteFromAllObjects:function(actionkey){var allObjects=this.model.get('draggableObjs');if(this.timesObjectExistsInEditor(actionkey)===1){var objID=allObjects.indexOf(actionkey);if(objID!==-1){allObjects.splice(objID,1);}}},timesObjectExistsInEditor:function(actionkey){var existTimes=0;var allAnswers=this.model.get('answers');_.each(allAnswers,function(container,containerActionkey){_.each(container.pa,function(paActionkey){if(paActionkey===actionkey)existTimes++;});});return existTimes;},runDataPicker:function(e){var _that=this;var button=$(e.target);var containerId=$(e.target).attr('dndm');var answers=this.model.get('answers');var objs=this.model.get('draggableObjs');var _array=[];if(button.hasClass('dnd-picker-container')){_array=answers[containerId]==undefined?_array:[containerId];this.showDataPicker(function(model){_array.push(model.get('actionkey'));_that.updateContainer(model,button);},$(e.target),_array);}else if(button.hasClass('dnd-picker-goodanswer')){if(!_.isUndefined(answers[containerId])){_.each(answers[containerId].pa,function(val){_array.push(val);});}
this.showDataPicker(function(model){_array.push(model.get('actionkey'));_that.updateGoodAnswers(model,button);},$(e.target),_array);}else if(button.hasClass('dnd-editor-draggableobjs-addobjects')){_.each(objs,function(val){_array.push(val);});this.showDataPicker(function(model){_array.push(model.get('actionkey'));_that.updateAnswers(model,button);},$(e.target),_array);}},showDataPicker:function(callback,target,actionKeyArray){var _that=this;if(this.dataPicker==undefined){this.dataPicker=new DataPickerView({collection:actionKeyArray});this.dataPicker.on('data-picker-close',function(){_that.dataPicker=undefined;});this.dataPicker.on('data-picker-picked',function(model){callback.call(_that,model,target,_that);});$('body').append(this.dataPicker.render().$el);}},showEditWindow:function(event){var _that=this;var target=$(event.target);var windowPosition={top:event.pageY,left:event.pageX};var containerActionkey=target.attr('dndm');if(this.containerEditorView==undefined){this.containerEditorView=new ContainerEditWindowView({componentModel:this.model,containerActionkey:containerActionkey});this.containerEditorView.on('on-close',function(){_that.containerEditorView=undefined;});var dataToRender={componentModel:this.model.toJSON(),containerActionkey:containerActionkey};$('body').append(this.containerEditorView.render(dataToRender).$el);this.containerEditorView.setWindowPosition(windowPosition);}},showEditAllWindow:function(windowPosition){var _that=this;var answers=this.model.get('answers');var componentModel={answers:{'all':{opts:{autoArrangeAnswers:false,dropandhide:false,enoughAnswers:0,forceGoodSequence:false,maxAnswers:0,onlygoodanswers:false,revertType:'revertOnlyBad'}}}}
var iter=0;_.each(answers,function(object,key){if(iter===0){componentModel.answers['all'].opts.autoArrangeAnswers=object.opts.autoArrangeAnswers;componentModel.answers['all'].opts.dropandhide=object.opts.dropandhide;componentModel.answers['all'].opts.enoughAnswers=object.opts.enoughAnswers;componentModel.answers['all'].opts.forceGoodSequence=object.opts.forceGoodSequence;componentModel.answers['all'].opts.maxAnswers=object.opts.maxAnswers;componentModel.answers['all'].opts.onlygoodanswers=object.opts.onlygoodanswers;componentModel.answers['all'].opts.revertType=object.opts.revertType;}else{if(object.opts.autoArrangeAnswers!==componentModel.answers['all'].opts.autoArrangeAnswers){componentModel.answers['all'].opts.autoArrangeAnswers=false;componentModel.answers['all'].opts.autoArrangeAnswersAll=true;}
if(object.opts.dropandhide!==componentModel.answers['all'].opts.dropandhide){componentModel.answers['all'].opts.dropandhide=false;componentModel.answers['all'].opts.dropandhideAll=true;}
if(object.opts.enoughAnswers!==componentModel.answers['all'].opts.enoughAnswers){componentModel.answers['all'].opts.enoughAnswers=0;componentModel.answers['all'].opts.enoughAnswersAll=true;}
if(object.opts.forceGoodSequence!==componentModel.answers['all'].opts.forceGoodSequence){componentModel.answers['all'].opts.forceGoodSequence=false;componentModel.answers['all'].opts.forceGoodSequenceAll=true;}
if(object.opts.maxAnswers!==componentModel.answers['all'].opts.maxAnswers){componentModel.answers['all'].opts.maxAnswers=0;componentModel.answers['all'].opts.maxAnswersAll=true;}
if(object.opts.onlygoodanswers!==componentModel.answers['all'].opts.onlygoodanswers){componentModel.answers['all'].opts.onlygoodanswers=false;componentModel.answers['all'].opts.onlygoodanswersAll=true;}
if(object.opts.revertType!==componentModel.answers['all'].opts.revertType){componentModel.answers['all'].opts.revertType='revertOnlyBad';componentModel.answers['all'].opts.revertTypeAll=true;}}
iter++;});if(this.containerEditorView==undefined){this.containerEditorView=new AllContainerEditWindowView({componentModel:this.model});this.containerEditorView.on('on-close',function(){_that.containerEditorView=undefined;});var dataToRender={componentModel:componentModel,containerActionkey:'all'};$('body').append(this.containerEditorView.render(dataToRender).$el);this.containerEditorView.setWindowPosition(windowPosition);}},showDnDOptionsWindow:function(windowPosition){var _that=this;if(this.dndOptionsView==undefined){this.dndOptionsView=new DnDOptionsWindowView({componentModel:this.model});this.dndOptionsView.on('on-close',function(){_that.dndOptionsView=undefined;});var dataToRender=this.model.toJSON();$('body').append(this.dndOptionsView.render(dataToRender).$el);this.dndOptionsView.setWindowPosition(windowPosition);}},updateContainer:function(model,target){var actionkey=model.get('actionkey');var dndm=target.attr('dndm');var answers=this.model.get('answers');var userSelection=this.model.get('userSelection');if(dndm==='new'){if(_.isUndefined(answers[actionkey])){answers[actionkey]={opts:{autoArrangeAnswers:true,dropandhide:false,enoughAnswers:0,forceGoodSequence:false,maxAnswers:0,onlygoodanswers:false,revertType:'revertOnlyBad'},pa:[],userSelection:[]}
userSelection[actionkey]=[];this.model.set('answers',answers);this.model.set('userSelection',userSelection);this.model.trigger('change');this.render();this.afterRender();}}else{answers[actionkey]=answers[dndm];delete answers[dndm];if(answers[actionkey]){if(answers[actionkey].pa){var paID=answers[actionkey].pa.indexOf(actionkey);if(paID!==-1){answers[actionkey].pa.splice(paID,1);}}}
this.model.set('answers',answers);this.model.trigger('change');this.render();this.afterRender();}},updateGoodAnswers:function(model,target){var answerActionkey=model.get('actionkey');var container=target.attr('dndm');var answers=this.model.get('answers');if(!_.isUndefined(answers[container])&&answerActionkey!==container){if(answers[container].pa.indexOf(answerActionkey)===-1){answers[container].pa.push(answerActionkey);}
var draggableObjs=this.model.get('draggableObjs');if(draggableObjs.indexOf(answerActionkey)===-1){draggableObjs.push(answerActionkey);this.model.set('draggableObjs',draggableObjs);}
this.model.set('answers',answers);this.model.trigger('change');this.render();this.afterRender();}},updateAnswers:function(model,target){var actionkey=model.get('actionkey');var draggableObjs=this.model.get('draggableObjs');if(draggableObjs.indexOf(actionkey)===-1){draggableObjs.push(actionkey);this.model.set('draggableObjs',draggableObjs);this.model.trigger('change');this.render();this.afterRender();}},beforeRender:function(){var allObjects=this.model.get('draggableObjs');var changedExist=false;for(var i=0;i<allObjects.length;i++){var actionkey=allObjects[i];var exist=StageView.instance.componentExist(actionkey);if(!exist){changedExist=true;allObjects.splice(i,1);}};this.model.set('draggableObjs',allObjects);var answers=this.model.get('answers');for(var item in answers){var actionkey=item;var exist=StageView.instance.componentExist(actionkey);if(!exist){changedExist=true;delete answers[item];}
if(answers[item]){var pa=answers[item].pa;if(pa!=undefined){for(var j=0;j<pa.length;j++){var actionkey=pa[j];var exist=StageView.instance.componentExist(actionkey);if(!exist){changedExist=true;pa.splice(j,1);}}}}};this.model.set('answers',answers);if(changedExist){this.model.trigger('change');}},afterRender:function(){var _that=this;var allObjects=this.model.get('draggableObjs');var userSelection=this.model.get('userSelection');userSelection={};var answers=this.model.get('answers');_.each(answers,function(key,actionkey){if(actionkey){var cModel=StageView.instance.getComponentModelByActionkey(actionkey);if(cModel){_that.$el.find('div[actionkey="'+actionkey+'"]').attr('componenttype',cModel.get('type'));}
userSelection[actionkey]=[];}});this.model.set('userSelection',userSelection);_.each(allObjects,function(actionkey){if(actionkey){var cModel=StageView.instance.getComponentModelByActionkey(actionkey);if(cModel){_that.$el.find('div[actionkey="'+actionkey+'"]').attr('componenttype',cModel.get('type'));}}});},});;;var QuizConnectLinesEditorView=ExerciseEditorView.extend({template:_.template($('#quizconnectlines-editor-template').html()),events:function(){return _.extend({},EditorView.prototype.events,{'keyup .qcl-submit-btn-text':'changeButtonTitle','click .connectlines-editor-draggableobjs-addobjects':'runDataPicker','click .connectlines-picker-target[dndm]':'runDataPicker','click .connectlines-picker-source[dndm]':'runDataPicker','click .connectlines-object':'showContextMenu','mouseenter .ex-object':'highlightOnStage','mouseleave .ex-object':'unhighlightOnStage','click .connectlines-object-good':'showContextMenuGoodAnswer','click .connectlines-container-delete':'deleteContainer','click .connectlines-container-edit':'editLine','click .connectlines-options-answers':'editQclOptionis','click .connectlines-editall-objs':'editAllObjs','click .feedback-good-edit':'startEditFeedbackGood','click .feedback-bad-edit':'startEditFeedbackBad','click .feedback-good-save':'changeFeedbackGood','click .feedback-bad-save':'changeFeedbackBad','click .ex-object-container':'showContextMenuContainer'});},bindings:{'#quiz-qcl-attempts':'attempts'},initialize:function(data){this.stageView=data.stageView;},highlightOnStage:function(e){var actionkey=$(e.currentTarget).attr('actionkey');if(actionkey){var cModel=StageView.instance.getComponentModelByActionkey(actionkey);cModel.selectedByPickerMiniature(true);}},unhighlightOnStage:function(e){var actionkey=$(e.currentTarget).attr('actionkey');if(actionkey){var cModel=StageView.instance.getComponentModelByActionkey(actionkey);cModel.selectedByPickerMiniature(false);}},editQclOptionis:function(e){var windowOption={top:e.pageY,left:e.pageX};this.showQclOptionsWindow(windowOption);},editLine:function(e){this.showEditWindow(e);},editAllObjs:function(e){var windowOption={top:e.pageY,left:e.pageX};this.showEditAllWindow(windowOption);},changeButtonTitle:function(e){var buttonTitle=$(e.target).val();this.model.set('buttonTitle',buttonTitle);},showContextMenu:function(e){var contextMenuView=new QclContextMenuView({model:this.model,view:this,e:e});ContextMenuContainer.addMenu(contextMenuView,e);},showContextMenuGoodAnswer:function(e){var contextMenuView=new QclGoodAnswerContextMenuView({model:this.model,view:this,e:e});ContextMenuContainer.addMenu(contextMenuView,e);},showContextMenuContainer:function(e){var contextMenuView=new QclContainerContextMenuView({model:this.model,view:this,e:e});ContextMenuContainer.addMenu(contextMenuView,e);},deleteObject:function(e){var objActionkey=$(e.target).attr('dndb');var answers=this.model.get('answers');var objs=this.model.get('objs');delete objs[objActionkey];_.each(answers,function(ob,key){if(ob.from===objActionkey){ob.from='';}else{var toID=ob.to.indexOf(objActionkey);if(toID!==-1){ob.to.splice(toID,1);}}});this.model.set('answers',answers);this.model.trigger('change');this.unhighlightOnStage(e);this.render();this.afterRender();},deleteGoodObject:function(e){var goodActionkey=$(e.target).attr('dndg');var containerActionkey=$(e.target).attr('dndm');var answers=this.model.get('answers');var line=$(e.target).attr('line');this.deleteFromAllObjects(goodActionkey);var toID=answers[line].to.indexOf(goodActionkey);if(toID!==-1){answers[line].to.splice(toID,1);}
this.model.set('answers',answers);this.model.trigger('change');this.unhighlightOnStage(e);this.render();this.afterRender();},deleteContainer:function(e){var _that=this;var container=$(e.target).attr('dndm');var answers=this.model.get('answers');var line=$(e.target).attr('line');var objs=this.model.get('objs');_.each(answers[line].to,function(objActionkey){_that.deleteFromAllObjects(objActionkey);});answers.splice(line,1);this.model.set('answers',answers);this.model.trigger('change');this.render();this.afterRender();},runDataPicker:function(e){var _that=this;var button=$(e.target);var line=$(e.target).attr('line');var answers=this.model.get('answers');var objs=this.model.get('objs');var _array=[];if(button.hasClass('connectlines-picker-source')){_array=answers[line]==undefined?_array:[answers[line].from];this.showDataPicker(function(model){_array.push(model.get('actionkey'));_that.updateSource(model,button);},$(e.target),_array);}else if(button.hasClass('connectlines-picker-target')){_.each(answers[line].to,function(val,key){_array.push(val);});this.showDataPicker(function(model){_array.push(model.get('actionkey'));_that.updateTarget(model,button);},$(e.target),_array);}else if(button.hasClass('connectlines-editor-draggableobjs-addobjects')){_.each(objs,function(val,key){_array.push(key);});this.showDataPicker(function(model){_array.push(model.get('actionkey'));_that.updateAnswers(model,button);},$(e.target),_array);}},showDataPicker:function(callback,target,actionKeyArray){var _that=this;if(this.dataPicker==undefined){this.dataPicker=new DataPickerView({collection:actionKeyArray});this.dataPicker.on('data-picker-close',function(){_that.dataPicker=undefined;});this.dataPicker.on('data-picker-picked',function(model){callback.call(_that,model,target,_that);});$('body').append(this.dataPicker.render().$el);}},showEditWindowForOneObject:function(event){var _that=this;var actionkey=$(event.target).attr('actionkey');var line=actionkey;var objs=this.model.get('objs');var oneObject=objs[line];var componentModel={objs:{'all':oneObject}}
var windowPosition={top:event.pageY,left:event.pageX};if(this.qclConnectionEditorView==undefined){this.qclConnectionEditorView=new QclOneConnectionsEditWindowView({actionkey:actionkey,componentModel:this.model,line:line});this.qclConnectionEditorView.on('on-close',function(){_that.qclConnectionEditorView=undefined;});var dataToRender={componentModel:componentModel,line:'all'};$('body').append(this.qclConnectionEditorView.render(dataToRender).$el);this.qclConnectionEditorView.setWindowPosition(windowPosition);}else{this.qclConnectionEditorView.close();this.showEditWindowForOneObject(event);}},showEditWindow:function(event){var _that=this;var target=$(event.target);var line=target.attr('line');var objs=this.model.get('objs');var answers=this.model.get('answers');var windowPosition={top:event.pageY,left:event.pageX};var componentModel={objs:{'all':{align:false,color:false,lineWidth:0,maxConnections:false,size:0}}}
var iter=0;var _objs=[];if(answers[line].form!=='')
_objs.push(answers[line].from);_.each(answers[line].to,function(actionkey,index){_objs.push(actionkey);});_.each(_objs,function(object,key){if(iter===0){componentModel.objs['all'].align=objs[object].align;componentModel.objs['all'].color=objs[object].color;componentModel.objs['all'].lineWidth=objs[object].lineWidth;componentModel.objs['all'].maxConnections=objs[object].maxConnections;componentModel.objs['all'].size=objs[object].size;}else{if(objs[object].align!==componentModel.objs['all'].align){componentModel.objs['all'].align='None';}
if(objs[object].color!==componentModel.objs['all'].color){componentModel.objs['all'].color='';}
if(objs[object].lineWidth!==componentModel.objs['all'].lineWidth){componentModel.objs['all'].lineWidth='';}
if(objs[object].maxConnections!==componentModel.objs['all'].maxConnections){componentModel.objs['all'].maxConnections='';}
if(objs[object].size!==componentModel.objs['all'].size){componentModel.objs['all'].size='';}}
iter++;});if(this.qclConnectionEditorView==undefined){this.qclConnectionEditorView=new QclConnectionEditWindowView({componentModel:this.model,line:line});this.qclConnectionEditorView.on('on-close',function(){_that.qclConnectionEditorView=undefined;});var dataToRender={componentModel:componentModel,line:'all'};$('body').append(this.qclConnectionEditorView.render(dataToRender).$el);this.qclConnectionEditorView.setWindowPosition(windowPosition);}else{this.qclConnectionEditorView.close();this.showEditWindow(event);}},showEditAllWindow:function(windowOption){var _that=this;var answers=this.model.get('answers');var objs=this.model.get('objs');var componentModel={objs:{'all':{align:false,color:false,lineWidth:0,maxConnections:false,size:0}}}
var iter=0;_.each(objs,function(object,key){if(iter===0){componentModel.objs['all'].align=object.align;componentModel.objs['all'].color=object.color;componentModel.objs['all'].lineWidth=object.lineWidth;componentModel.objs['all'].maxConnections=object.maxConnections;componentModel.objs['all'].size=object.size;}else{if(object.align!==componentModel.objs['all'].align){componentModel.objs['all'].align='None';}
if(object.color!==componentModel.objs['all'].color){componentModel.objs['all'].color='';}
if(object.lineWidth!==componentModel.objs['all'].lineWidth){componentModel.objs['all'].lineWidth='';}
if(object.maxConnections!==componentModel.objs['all'].maxConnections){componentModel.objs['all'].maxConnections='';}
if(object.size!==componentModel.objs['all'].size){componentModel.objs['all'].size='';}}
iter++;});if(this.qclConnectionEditorView==undefined){this.qclConnectionEditorView=new QclAllConnectionsEditWindowView({componentModel:this.model});this.qclConnectionEditorView.on('on-close',function(){_that.qclConnectionEditorView=undefined;});var dataToRender={componentModel:componentModel,line:'all'};$('body').append(this.qclConnectionEditorView.render(dataToRender).$el);this.qclConnectionEditorView.setWindowPosition(windowOption);}else{this.qclConnectionEditorView.close();this.showEditAllWindow(event);}},showQclOptionsWindow:function(windowOption){var _that=this;if(this.qclOptionsView==undefined){this.qclOptionsView=new QclOptionsWindowView({componentModel:this.model});this.qclOptionsView.on('on-close',function(){_that.qclOptionsView=undefined;});var dataToRender=this.model.toJSON();$('body').append(this.qclOptionsView.render(dataToRender).$el);this.qclOptionsView.setWindowPosition(windowOption);}},updateSource:function(model,target){var actionkey=model.get('actionkey');var dndm=target.attr('dndm');var answers=this.model.get('answers');var objs=this.model.get('objs');if(typeof objs[actionkey]==='undefined'){objs[actionkey]={align:'TopCenter',color:'#67ABD6',isSource:true,isTarget:false,lineWidth:4,maxConnections:0,size:20};}else{objs[actionkey].isSource=true;}
if(dndm==='new'){var ob={from:actionkey,to:[]};answers.push(ob);}else{var line=target.attr('line');answers[line].from=actionkey;var toID=answers[line].to.indexOf(actionkey);if(toID!==-1){answers[line].to.splice(toID,1);}}
this.model.set('answers',answers);this.model.trigger('change');this.render();this.afterRender();},updateTarget:function(model,target){var targeetActionkey=model.get('actionkey');var sourceActionkey=target.attr('dndm');var line=target.attr('line');var objs=this.model.get('objs');var answers=this.model.get('answers');if(answers[line].to.indexOf(targeetActionkey)===-1){if(answers[line].from!==targeetActionkey){answers[line].to.push(targeetActionkey);if(typeof objs[targeetActionkey]==='undefined'){objs[targeetActionkey]={align:'TopCenter',color:'#67ABD6',isSource:false,isTarget:true,lineWidth:4,maxConnections:0,size:20};}else{objs[targeetActionkey].isTarget=true;}
this.model.set('answers',answers);this.model.trigger('change');this.render();this.afterRender();}}},updateAnswers:function(model,target){var actionkey=model.get('actionkey');var objs=this.model.get('objs');if(typeof objs[actionkey]==='undefined'){objs[actionkey]={align:'TopCenter',color:'#67ABD6',isSource:false,isTarget:false,lineWidth:4,maxConnections:0,size:20};this.model.set('objs',objs);this.model.trigger('change');this.render();this.afterRender();}},deleteFromAllObjects:function(actionkey){var allObjects=this.model.get('objs');if(this.timesObjectExistsInEditor(actionkey)===1){delete allObjects[actionkey];}},timesObjectExistsInEditor:function(actionkey){var existTimes=0;var allAnswers=this.model.get('answers');_.each(allAnswers,function(answerObject){if(answerObject.from===actionkey)existTimes++;_.each(answerObject.to,function(paActionkey){if(paActionkey===actionkey)existTimes++;});});return existTimes;},resetDots:function(){jsPlumb.deleteEveryEndpoint();},paintDots:function(){this.model.view.paintDots();},afterRender:function(){var _that=this;this.paintDots();var objs=this.model.get('objs');_.each(objs,function(key,actionkey){if(actionkey){var cModel=StageView.instance.getComponentModelByActionkey(actionkey);_that.$el.find('div[actionkey="'+actionkey+'"]').attr('componenttype',cModel.get('type'));}});}});;;var QuizWordsearchEditorView=ExerciseEditorView.extend({template:_.template($('#quizwordsearch-editor-template').html()),events:function(){return _.extend({},EditorView.prototype.events,{'click .wordsearch-options-add-new-row':'addNewRow','click .wordsearch-options-add-new-column':'addNewColumn','click .wordsearch-options-setting':'showSetting','click .wordsearch-letter-picker':'runDataPicker','click .wordsearch-delete-word':'deleteWord','click .wordsearch-letter':'deleteLetter','click .feedback-good-edit':'startEditFeedbackGood','click .feedback-bad-edit':'startEditFeedbackBad','click .feedback-good-save':'changeFeedbackGood','click .feedback-bad-save':'changeFeedbackBad'});},render:function(){return this.newRender();},newRender:function(){var options={activeCellID:this.activeCellID};var toSend=$.extend({},this.model.toJSON(),options);var editorTemplate=this.template(toSend);this.$el.html(editorTemplate);this.stickit();return this;},onSetModel:function(){this.model.off('set-active-cell-id');this.model.on('set-active-cell-id',this.setActiveCellID,this);},addNewWord:function(){var answers=this.model.get('answers');answers.push({objs:[],opts:[]});this.model.set('answers',answers);this.model.trigger('change');},deleteLetter:function(e){var word=parseInt($(e.target).attr('word'));var letter=$(e.target).attr('letter');var answers=this.model.get('answers');var letterID=answers[word].objs.indexOf(letter);if(letterID!==-1){answers[word].objs.splice(letterID,1);}
this.model.set('answers',answers);this.model.trigger('change');this.render();},deleteWord:function(e){if($(e.target).attr('word')!=='new'){var wordID=parseInt($(e.target).attr('word'));var answers=this.model.get('answers');answers.splice(wordID,1);this.model.set('answers',answers);this.model.trigger('change');this.render();}},setActiveCellID:function(cellID){this.activeCellID=cellID;this.render();},onBeforeInitialize:function(){this.activeCellID='';},showSetting:function(e){var _that=this;var windowPosition={top:e.pageY,left:e.pageX};if(this.containerSettingView==undefined){this.containerSettingView=new QuizWordsearchSettingWindow({componentModel:this.model});this.containerSettingView.on('on-close',function(){_that.containerSettingView=undefined;});var dataToRender={componentModel:this.model.toJSON()};$('body').append(this.containerSettingView.render(dataToRender).$el);this.containerSettingView.setWindowPosition(windowPosition);}},calculateRowsAndCols:function(){var objs=this.model.get('objs');var _rows=[];var _cols=[];var _tmp;var cols;var rows;_.each(objs,function(val,key){_tmp=key.split('-');_rows.push(_tmp[0]);_cols.push(_tmp[1]);});cols=_.uniq(_cols);rows=_.uniq(_rows);this.model.set('cols',cols);this.model.set('rows',rows);},addNewRow:function(){var cols=this.model.get('cols');var rows=this.model.get('rows');var objs=this.model.get('objs');var newRow=rows.length;_.each(cols,function(val){objs[newRow+'-'+val]='';});this.calculateRowsAndCols();this.model.set('objs',objs);this.model.trigger('change:objs');this.model.trigger('change');this.render();this.model.view.afterRender();},addNewColumn:function(){var cols=this.model.get('cols');var rows=this.model.get('rows');var objs=this.model.get('objs');var newCol=cols.length;_.each(rows,function(val){objs[val+'-'+newCol]='';});this.calculateRowsAndCols();this.model.set('objs',objs);this.model.trigger('change:objs');this.model.trigger('change');this.render();this.model.view.afterRender();},runDataPicker:function(e){if(!this.model.editingMode){this.model.view.startEditing();}
var word=$(e.target).attr('word');this.showDataPicker(this.addLetter,$(e.target));},showDataPicker:function(callback,target,cells){var _that=this;if(this.dataPicker==undefined){this.dataPicker=new SimpleDataPickerView({collection:cells,picker:'wordsearch-cell',componentView:this.model.view});this.dataPicker.on('data-picker-close',function(){_that.dataPicker=undefined;});this.dataPicker.on('data-picker-picked',function(model){callback.call(_that,model,target,_that);});$('body').append(this.dataPicker.render().$el);}else{this.dataPicker.closeDataPicker();this.showDataPicker(callback,target,cells);}},addLetter:function(model,sender){_log('model',model);_log('sender',sender);var word=sender.attr('word');var cellID=model.attr('cellid');var answers=this.model.get('answers');var w;if(word==='new'){this.addNewWord();w=answers.length-1;sender.attr('word',w);}else{w=parseInt(word);}
var inArray;if(typeof answers[w]==='object'){inArray=answers[w].objs.indexOf(cellID);if(inArray===-1){answers[w].objs.push(cellID);}}
this.model.set('answers',answers);this.model.trigger('change');this.render();}});;;var ScrollerEditorView=EditorView.extend({template:_.template($('#scroller-editor-template').html()),bindings:{'[name="scroller-opt"]':'changeAdv','#scroller-opt-scrolltime':'scrollTime'},});;;var CrosswordEditorView=ExerciseEditorView.extend({template:_.template($('#crossword-editor-template').html()),events:function(){return _.extend({},EditorView.prototype.events,{'click .qcrossword-options-change-to-question':'changeToQuestion','click .qcrossword-options-change-to-answer':'changeToAnswer','click .qcrossword-options-add-new-row':'addNewRow','click .qcrossword-options-add-new-column':'addNewColumn','click .qcrossword-options-setting':'showSetting','click .qcrossword-options-arrow':'setArrow','change .qcrossword-field-type':'changeFieldType','click .qcrossword-upload-image-button':'uploadImage','click .qcrossword-upload-audio-button':'uploadAudio','click .qcrossword-options-remove-arrow':'removeArrow','click .feedback-good-edit':'startEditFeedbackGood','click .feedback-bad-edit':'startEditFeedbackBad','click .feedback-good-save':'changeFeedbackGood','click .feedback-bad-save':'changeFeedbackBad'});},render:function(){return this.newRender();},newRender:function(){var options={activeCellID:this.activeCellID};var toSend=$.extend({},this.model.toJSON(),options);var editorTemplate=this.template(toSend);this.$el.html(editorTemplate);this.stickit();return this;},onSetModel:function(){this.model.off('set-active-cell-id');this.model.on('set-active-cell-id',this.setActiveCellID,this);},uploadImage:function(){var objs=this.model.get('objs');var files={soundFile:objs[this.activeCellID].opts.soundFile,imageFile:objs[this.activeCellID].opts.imageFile};this.model.uploadImage(files);},uploadAudio:function(){var objs=this.model.get('objs');var files={soundFile:objs[this.activeCellID].opts.soundFile,imageFile:objs[this.activeCellID].opts.imageFile};this.model.uploadSound(files);},changeFieldType:function(e){var _that=this;var fieldType=$(e.target).val();var objs=this.model.get('objs');objs[this.activeCellID].opts.questionType=fieldType;this.model.set('objs',objs);this.model.trigger('change');this.model.view.questions();this.model.view.dinamicRender();this.render();var fileName='';var type;var actionkey=this.model.get('actionkey');if(objs[this.activeCellID].opts.imageFile!==''){fileName=objs[this.activeCellID].opts.imageFile;type='image';}else{fileName=objs[this.activeCellID].opts.soundFile;type='sound';}
if(fileName!==''){DataAccess.updateComponents({components:[_that.model],actionkey:actionkey,fileName:fileName,type:type,page:StageView.instance.model,activeCellID:_that.activeCellID,action:'delete-file-crossword',pageId:StageView.instance.model.getPageId()},function(data){var objsx=_that.model.get('objs');if(type==='image'){objsx[_that.activeCellID].opts.imageFile='';}else{objsx[_that.activeCellID].opts.soundFile='';}
_that.model.set('objs',objsx);},function(data){});}},setActiveCellID:function(cellID){this.activeCellID=cellID;this.render();},onBeforeInitialize:function(){this.activeCellID='';},setArrow:function(e){var arrowID=$(e.target).attr('arrow-id');var objs=this.model.get('objs');objs[this.activeCellID].gender=arrowID;this.model.set('objs',objs);this.model.trigger('change');this.render();this.model.view.dinamicRender();},removeArrow:function(){var objs=this.model.get('objs');objs[this.activeCellID].gender='';this.model.trigger('change');this.render();this.model.view.dinamicRender();},showSetting:function(e){var _that=this;var windowPosition={top:e.pageY,left:e.pageX};if(this.containerSettingView==undefined){this.containerSettingView=new CrosswordSettingWindow({componentModel:this.model});this.containerSettingView.on('on-close',function(){_that.containerSettingView=undefined;});var dataToRender={componentModel:this.model.toJSON()};$('body').append(this.containerSettingView.render(dataToRender).$el);this.containerSettingView.setWindowPosition(windowPosition);}},calculateRowsAndCols:function(){var objs=this.model.get('objs');var _rows=[];var _cols=[];var _tmp;var cols;var rows;_.each(objs,function(val,key){_tmp=key.split('-');_rows.push(_tmp[0]);_cols.push(_tmp[1]);});cols=_.uniq(_cols);rows=_.uniq(_rows);this.model.set('cols',cols);this.model.set('rows',rows);},addNewRow:function(){var cols=this.model.get('cols');var rows=this.model.get('rows');var objs=this.model.get('objs');var newRow=rows.length;_.each(cols,function(val){objs[newRow+'-'+val]={type:'answer',text:'',gender:'',opts:{questionType:'text',soudFile:'',imageFile:''}};});this.calculateRowsAndCols();this.model.set('objs',objs);this.model.trigger('change:objs');this.model.trigger('change');this.model.forceRender();this.model.view.$el.find('.quiz-component-handle').hide();this.model.view.afterRender();},addNewColumn:function(){var cols=this.model.get('cols');var rows=this.model.get('rows');var objs=this.model.get('objs');var newCol=cols.length;_.each(rows,function(val){objs[val+'-'+newCol]={type:'answer',text:'',gender:'',opts:{questionType:'text',soudFile:'',imageFile:''}};});this.calculateRowsAndCols();this.model.set('objs',objs);this.model.trigger('change:objs');this.model.trigger('change');this.model.forceRender();this.model.view.$el.find('.quiz-component-handle').hide();this.model.view.afterRender();},changeToAnswer:function(e){var objs=this.model.get('objs');if(this.activeCellID!==''){objs[this.activeCellID].type='answer';objs[this.activeCellID].gender='';objs[this.activeCellID].text='';this.model.set('objs',objs);this.model.trigger('change');this.render();this.model.view.dinamicRender();}},changeToQuestion:function(e){var objs=this.model.get('objs');if(this.activeCellID!==''){objs[this.activeCellID].type='question';objs[this.activeCellID].text='';this.model.set('objs',objs);this.model.trigger('change');this.render();this.model.view.dinamicRender();}}});;;var StageEditorView=EditorView.extend({template:_.template($('#stage-editor-template').html()),bindings:{'[class="pagename"]':'pagename','.page-prop-lock-navi-input':'locknavi','.page-prop-turn-off-scroll-input':'lockscroll','.after-finish-page-goto-next':'goToNextPage','.after-finish-page-highlight-navigation-buttons':'highlightButtons'},events:function(){return _.extend({},EditorView.prototype.events,{'keyup .pagename':'onPagenameChanged','click .add-image-background-to-page':'getImage','click .editor-delete-background-file':'deleteBackground'});},onPagenameChanged:function(e){var value=$(e.target).val();this.model.set('pagename',value);},deleteBackground:function(){this.deleteFileImageOnServer();},afterRender:function(){var _that=this;var color=this.model.get('bgcolor')!==''?this.model.get('bgcolor'):'#FFF';this.colorPickerStageBackground=new ColorPickerView({color:color});this.$el.find('.stage-background-color-picker').html(this.colorPickerStageBackground.render().$el);this.colorPickerStageBackground.on('move',function(data){_that.model.set('bgcolor',data.color,{silent:true});StageView.instance.renderBackgroundColor(data.color);_that.model.trigger('update-dintamic-page-thumb');});this.colorPickerStageBackground.on('change',function(data){});this.colorPickerStageBackground.on('hide',function(data){_that.model.trigger('change');_that.model.trigger('update-dintamic-page-thumb');});},deleteFileImageOnServer:function(){var _that=this;DataAccess.updatePageOptions({pageOptions:this.model,action:'delete-page-background',pageId:StageView.instance.model.getPageId()},function(data){_that.model.set('image','');},function(data){_log('Update page options fault: ',data,_log.dataaccessOutFault)});},getImage:function(){this.model.view.openImageWindow();},onSetModel:function(){var _that=this;this.render();this.listenTo(this.model,'change:image',this.render);},});;;var FormInputTextEditorView=ExerciseEditorView.extend({template:_.template($('#forminputtext-editor-template').html()),events:function(){return _.extend({},EditorView.prototype.events,{'keyup input[name="placeholder"]':'changePlaceholder','keyup input[name="defaultvalue"]':'changeDefalutValue','keyup input[name="fontsize"]':'changeFontSize','keyup input[name="maxlength"]':'changeMaxLength','change select[name="textalign"]':'changeTextAlign','click .feedback-good-edit':'startEditFeedbackGood','click .feedback-bad-edit':'startEditFeedbackBad','click .feedback-good-save':'changeFeedbackGood','click .feedback-bad-save':'changeFeedbackBad'});},bindings:{'input[name="placeholder"]':'placeholder','input[name="defaultvalue"]':'defaultValue','input[name="fontsize"]':'fontSize','input[name="maxlength"]':'maxLength','select[name="textalign"]':'textAlign','input[name="casesensitive"]':'caseSensitive','input[name="checkself"]':'checkSelf','input[name="feedback-show"]':'feedbackShow'},updateGoodAnswers:function(){this.model.set('goodAnswers',this.goodAnswersInput.val());},afterRender:function(){var _that=this;this.goodAnswersInput=this.$el.find('.forminputtext-goodanswers');this.goodAnswersInput.val('');this.goodAnswersInput.tagsInput({defaultText:_lang('FORM_INPUT_ADDTAG'),height:'auto',width:'auto',onAddTag:function(){_that.updateGoodAnswers();},onRemoveTag:function(){_that.updateGoodAnswers();}});this.goodAnswersInput.importTags(this.model.get('goodAnswers'));},changePlaceholder:function(e){this.model.set('placeholder',$(e.target).val());},changeDefalutValue:function(e){this.model.set('defaultValue',$(e.target).val());},changeFontSize:function(e){this.model.set('fontSize',$(e.target).val());},changeMaxLength:function(e){var maxLength=parseInt($(e.target).val());var defaultVal=this.model.get('defaultValue');this.model.set('maxLength',maxLength);if(defaultVal.length>maxLength){this.model.set('defaultValue',defaultVal.substring(0,maxLength));}
this.$el.find('input[name="defaultvalue"]').attr('maxLength',maxLength);},changeTextAlign:function(e){this.model.set('textAlign',$(e.target).val());this.model.forceRender();}});;;var FormUploadEditorView=ImageEditorView.extend({template:_.template($('#formupload-editor-template').html()),events:function(){return _.extend({},EditorView.prototype.events,{'keyup input[name="link"]':'changeLink','click input[name="iframe"]':'changeIframe','change input[name="opacity"]':'onOpacityChanged','click .add-image-file':'addNewImage','click .editor-crop-image-button':'showCropWindow','click .editor-resize-to-stage-button':'resizeToStage','click .editor-original-size-button':'originalSize','click .editor-add-border-button':'showBorderWindow'});},afterRender:function(){var _that=this;},updateGoodExtensions:function(){},});;;var QuizInputTextEditorView=ExerciseEditorView.extend({template:_.template($('#quizinputtext-editor-template').html()),events:function(){return _.extend({},EditorView.prototype.events,{'keyup input[name="placeholder"]':'changePlaceholder','keyup input[name="defaultvalue"]':'changeDefalutValue','keyup input[name="fontsize"]':'changeFontSize','keyup input[name="maxlength"]':'changeMaxLength','change select[name="textalign"]':'changeTextAlign','click .feedback-good-edit':'startEditFeedbackGood','click .feedback-bad-edit':'startEditFeedbackBad','click .feedback-good-save':'changeFeedbackGood','click .feedback-bad-save':'changeFeedbackBad'});},bindings:{'input[name="placeholder"]':'placeholder','input[name="defaultvalue"]':'defaultValue','input[name="fontsize"]':'fontSize','input[name="maxlength"]':'maxLength','select[name="textalign"]':'textAlign','input[name="casesensitive"]':'caseSensitive','input[name="checkself"]':'checkSelf','input[name="feedback-show"]':'feedbackShow','input[name="mark-questions"]':'markQuestions'},updateGoodAnswers:function(){this.model.set('goodAnswers',this.goodAnswersInput.val());},afterRender:function(){var _that=this;this.goodAnswersInput=this.$el.find('.forminputtext-goodanswers');this.goodAnswersInput.val('');this.goodAnswersInput.tagsInput({defaultText:_lang('FORM_INPUT_ADDTAG'),height:'auto',width:'auto',onAddTag:function(){_that.updateGoodAnswers();},onRemoveTag:function(){_that.updateGoodAnswers();}});this.goodAnswersInput.importTags(this.model.get('goodAnswers'));},changePlaceholder:function(e){this.model.set('placeholder',$(e.target).val());},changeDefalutValue:function(e){this.model.set('defaultValue',$(e.target).val());},changeFontSize:function(e){this.model.set('fontSize',$(e.target).val());},changeMaxLength:function(e){var maxLength=parseInt($(e.target).val());var defaultVal=this.model.get('defaultValue');this.model.set('maxLength',maxLength);if(defaultVal.length>maxLength){this.model.set('defaultValue',defaultVal.substring(0,maxLength));}
this.$el.find('input[name="defaultvalue"]').attr('maxLength',maxLength);},changeTextAlign:function(e){this.model.set('textAlign',$(e.target).val());this.model.forceRender();}});;;var FormTextareaEditorView=FormInputTextEditorView.extend({template:_.template($('#formtextarea-editor-template').html()),events:function(){return _.extend({},EditorView.prototype.events,{'keyup input[name="defaultvalue"]':'changeDefalutValue','keyup input[name="fontsize"]':'changeFontSize','keyup input[name="maxlength"]':'changeMaxLength','change select[name="textalign"]':'changeTextAlign','click .feedback-good-edit':'startEditFeedbackGood','click .feedback-bad-edit':'startEditFeedbackBad','click .feedback-good-save':'changeFeedbackGood','click .feedback-bad-save':'changeFeedbackBad'});},bindings:{'input[name="defaultvalue"]':'defaultValue','input[name="fontsize"]':'fontSize','input[name="maxlength"]':'maxLength','select[name="textalign"]':'textAlign','input[name="casesensitive"]':'caseSensitive','input[name="checkself"]':'checkSelf','input[name="feedback-show"]':'feedbackShow'},updateGoodAnswers:function(){this.model.set('goodAnswers',this.goodAnswersInput.val());},afterRender:function(){var _that=this;this.goodAnswersInput=this.$el.find('.formtextarea-goodanswers');this.goodAnswersInput.val('');this.goodAnswersInput.tagsInput({defaultText:_lang('FORM_INPUT_ADDTAG'),height:'auto',width:'auto',onAddTag:function(){_that.updateGoodAnswers();},onRemoveTag:function(){_that.updateGoodAnswers();}});this.goodAnswersInput.importTags(this.model.get('goodAnswers'));},changeDefalutValue:function(e){this.model.set('defaultValue',$(e.target).val());},changeFontSize:function(e){this.model.set('fontSize',$(e.target).val());},changeMaxLength:function(e){var maxLength=parseInt($(e.target).val());var defaultVal=this.model.get('defaultValue');this.model.set('maxLength',maxLength);if(defaultVal.length>maxLength){this.model.set('defaultValue',defaultVal.substring(0,maxLength));}
this.$el.find('input[name="defaultvalue"]').attr('maxLength',maxLength);},changeTextAlign:function(e){this.model.set('textAlign',$(e.target).val());this.model.forceRender();}});;;var FormSelectEditorView=ExerciseEditorView.extend({template:_.template($('#formselect-editor-template').html()),events:function(){return _.extend({},EditorView.prototype.events,{'change input[name="fontsize"]':'changeFontSize','click .add-new-option':'addNewOption','keyup .option-name':'changeOptionName','change .option-require':'changeRequire','click .option-startvalue':'changeStartValue','click .formselect-delete-option':'deleteOption','click .feedback-good-edit':'startEditFeedbackGood','click .feedback-bad-edit':'startEditFeedbackBad','click .feedback-good-save':'changeFeedbackGood','click .feedback-bad-save':'changeFeedbackBad'});},bindings:{'input[name="fontsize"]':'fontSize','input[name="checkself"]':'checkSelf','input[name="feedback-show"]':'feedbackShow'},afterRender:function(){this.$el.find('.formselect-answers').sortable({update:function(){}});},deleteOption:function(e){var it=parseInt($(e.target).attr('it'));var formData=this.model.get('formData');formData.selectOptions.splice(it,1);this.model.set('formData',formData);this.model.trigger('change');this.render();this.model.forceRender();},changeStartValue:function(e){var it=parseInt($(e.target).attr('it'));var formData=this.model.get('formData');_.each(formData.selectOptions,function(option,i){if(it===i){formData.selectOptions[i].startValue=true;}else{formData.selectOptions[i].startValue=false;}});this.model.set('formData',formData);this.model.trigger('change');this.model.forceRender();},changeRequire:function(e){var it=parseInt($(e.target).attr('it'));var formData=this.model.get('formData');formData.selectOptions[it].require=$(e.target).is(':checked');this.model.set('formData',formData);this.model.trigger('change');},changeOptionName:function(e){var it=parseInt($(e.target).attr('it'));var formData=this.model.get('formData');formData.selectOptions[it].option=$(e.target).val();this.model.set('formData',formData);this.model.trigger('change');this.model.forceRender();},addNewOption:function(e){var newOption={option:_lang('FORM_SELECT_NEWOPTION'),require:true,startValue:false};var formData=this.model.get('formData');formData.selectOptions.push(newOption);this.model.set('formData',formData);this.model.trigger('change');this.render();},changeFontSize:function(e){this.model.set('fontSize',$(e.target).val());this.model.forceRender();}});;;var QuizSelectEditorView=ExerciseEditorView.extend({template:_.template($('#quizselect-editor-template').html()),events:function(){return _.extend({},EditorView.prototype.events,{'change input[name="fontsize"]':'changeFontSize','click .add-new-option':'addNewOption','keyup .option-name':'changeOptionName','change .option-require':'changeRequire','click .option-startvalue':'changeStartValue','click .formselect-delete-option':'deleteOption','click .feedback-good-edit':'startEditFeedbackGood','click .feedback-bad-edit':'startEditFeedbackBad','click .feedback-good-save':'changeFeedbackGood','click .feedback-bad-save':'changeFeedbackBad'});},bindings:{'input[name="fontsize"]':'fontSize','input[name="checkself"]':'checkSelf','input[name="feedback-show"]':'feedbackShow','input[name="mark-questions"]':'markQuestions'},afterRender:function(){this.$el.find('.formselect-answers').sortable({update:function(){}});},deleteOption:function(e){var it=parseInt($(e.target).attr('it'));var formData=this.model.get('formData');formData.selectOptions.splice(it,1);this.model.set('formData',formData);this.model.trigger('change');this.render();this.model.forceRender();},changeStartValue:function(e){var it=parseInt($(e.target).attr('it'));var formData=this.model.get('formData');_.each(formData.selectOptions,function(option,i){if(it===i){formData.selectOptions[i].startValue=true;}else{formData.selectOptions[i].startValue=false;}});this.model.set('formData',formData);this.model.trigger('change');this.model.forceRender();},changeRequire:function(e){var it=parseInt($(e.target).attr('it'));var formData=this.model.get('formData');formData.selectOptions[it].require=$(e.target).is(':checked');this.model.set('formData',formData);this.model.trigger('change');},changeOptionName:function(e){var it=parseInt($(e.target).attr('it'));var formData=this.model.get('formData');formData.selectOptions[it].option=$(e.target).val();this.model.set('formData',formData);this.model.trigger('change');this.model.forceRender();},addNewOption:function(e){var newOption={option:_lang('FORM_SELECT_NEWOPTION'),require:true,startValue:false};var formData=this.model.get('formData');formData.selectOptions.push(newOption);this.model.set('formData',formData);this.model.trigger('change');this.render();},changeFontSize:function(e){this.model.set('fontSize',$(e.target).val());this.model.forceRender();}});;;var FormCheckboxEditorView=ExerciseEditorView.extend({template:_.template($('#formcheckbox-editor-template').html()),events:function(){return _.extend({},EditorView.prototype.events,{'click .feedback-good-edit':'startEditFeedbackGood','click .feedback-bad-edit':'startEditFeedbackBad','click .feedback-good-save':'changeFeedbackGood','click .feedback-bad-save':'changeFeedbackBad'});},bindings:{'.form-checkbox-size':'inputSize','.form-input-correct':'correctValue','.form-radio-group':'groupName','.form-input-default-value':'defaultValue','input[name="checkself"]':'checkSelf','input[name="feedback-show"]':'feedbackShow'},afterRender:function(){},});;;var FormRadioEditorView=ExerciseEditorView.extend({template:_.template($('#formradio-editor-template').html()),events:function(){return _.extend({},EditorView.prototype.events,{'click .feedback-good-edit':'startEditFeedbackGood','click .feedback-bad-edit':'startEditFeedbackBad','click .feedback-good-save':'changeFeedbackGood','click .feedback-bad-save':'changeFeedbackBad'});},bindings:{'.form-radio-size':'inputSize','.form-radio-correct':'correctValue','.form-input-default-value':'defaultValue','.form-radio-group':'groupName','input[name="checkself"]':'checkSelf','input[name="feedback-show"]':'feedbackShow'}});;;var FormSubmitEditorView=ExerciseEditorView.extend({template:_.template($('#formsubmit-editor-template').html()),initialize:function(data){this.stageView=data.stageView;},bindings:{'input[name="feedback-show"]':'feedbackShow'},events:function(){return _.extend({},EditorView.prototype.events,{'click .formsubmit-editor-addobjects':'runDataPicker','click .formsubmit-options-answers':'showOptionsWindow','click .feedback-good-edit':'startEditFeedbackGood','click .feedback-bad-edit':'startEditFeedbackBad','click .feedback-good-save':'changeFeedbackGood','click .feedback-bad-save':'changeFeedbackBad','mouseenter .form-object':'highlightOnStage','mouseleave .form-object':'unhighlightOnStage','click .form-object':'deleteObject'});},highlightOnStage:function(e){var actionkey=$(e.currentTarget).attr('formob');if(actionkey){var cModel=StageView.instance.getComponentModelByActionkey(actionkey);cModel.selectedByTrigger(true);}},unhighlightOnStage:function(e){var actionkey=$(e.currentTarget).attr('formob');if(actionkey){var cModel=StageView.instance.getComponentModelByActionkey(actionkey);cModel.selectedByTrigger(false);}},startEditFeedbackGood:function(){var _that=this;try{this.feedbackGoodEditor=CKEDITOR.replace(this.$el.find('.feedback-good')[0],{height:'100px',plugins:'basicstyles,wysiwygarea,toolbar,list,blockquote,fakeobjects,stylescombo,dialogui,dialog,undo'});this.$el.find('.feedback-good-edit').attr('class','feedback-save feedback-good-save').text(_lang('SAVE'));}catch(msg){}},startEditFeedbackBad:function(){var _that=this;try{this.feedbackBadEditor=CKEDITOR.replace(this.$el.find('.feedback-bad')[0],{height:'100px',plugins:'basicstyles,wysiwygarea,toolbar,list,blockquote,fakeobjects,stylescombo,dialogui,dialog,undo'});this.$el.find('.feedback-bad-edit').attr('class','feedback-save feedback-bad-save').text(_lang('SAVE'));}catch(msg){}},changeFeedbackGood:function(){var feedback=this.feedbackGoodEditor.getData();this.model.set('feedbackGood',feedback);this.render();this.afterRender();},changeFeedbackBad:function(feedback){var feedback=this.feedbackBadEditor.getData();this.model.set('feedbackBad',feedback);this.render();this.afterRender();},deleteObject:function(e){var objActionkey=$(e.target).attr('formob');var formFields=this.model.get('formFields');var formFieldID=formFields.indexOf(objActionkey);if(formFieldID!==-1){formFields.splice(formFieldID,1);}
this.model.set('formFields',formFields);this.model.trigger('change');this.unhighlightOnStage(e);this.render();this.afterRender();},showDataPicker:function(callback,target,actionKeyArray){var _that=this;if(this.dataPicker==undefined){this.dataPicker=new DataPickerView({collection:actionKeyArray});this.dataPicker.on('data-picker-close',function(){_that.dataPicker=undefined;});this.dataPicker.on('data-picker-picked',function(model){callback.call(_that,model,target,_that);});$('body').append(this.dataPicker.render().$el);}},runDataPicker:function(e){var _that=this;var button=$(e.target);var objs=this.model.get('formFields');var _array=[];_.each(objs,function(val){_array.push(val);});this.showDataPicker(function(model){_array.push(model.get('actionkey'));_that.updateElementsToCheck(model,button);},$(e.target),_array);},updateElementsToCheck:function(model,target){if(model.cid==this.model.cid){return;}
var actionkey=model.get('actionkey');var formFields=this.model.get('formFields');if(formFields.indexOf(actionkey)===-1){formFields.push(actionkey);this.model.set('formFields',formFields);this.model.trigger('change');this.render();this.afterRender();}},showOptionsWindow:function(e){var _that=this;var windowPosition={left:e.pageX,top:e.pageY};if(this.optionsWindowView==undefined){this.optionsWindowView=new FormSubmitOptionsWindowView({componentModel:this.model});this.optionsWindowView.on('on-close',function(){_that.optionsWindowView=undefined;});var dataToRender=this.model.toJSON();$('body').append(this.optionsWindowView.render(dataToRender).$el);this.optionsWindowView.setWindowPosition(windowPosition);}},onSetModel:function(){this.feedbackBadEditor=null;this.feedbackGoodEditor=null;},afterRender:function(){var _that=this;var objs=this.model.get('formFields');_.each(objs,function(actionkey){if(actionkey){var cModel=StageView.instance.getComponentModelByActionkey(actionkey);_that.$el.find('div[formob="'+actionkey+'"]').attr('componenttype',cModel.get('type'));}});}});;;var IframeEditorView=EditorView.extend({template:_.template($('#iframe-editor-template').html()),changeLinkTimeout:null,events:{'keyup .iframe-obj-editor-input':'changeLink'},bindings:{},changeLink:function(e){var _that=this;var link=$(e.target).val();clearTimeout(this.changeLinkTimeout);this.changeLinkTimeout=setTimeout(function(){_that.model.set('link',link);},1000);}});;;var SwfEditorView=EditorView.extend({template:_.template($('#swf-editor-template').html()),events:function(){return _.extend({},EditorView.prototype.events,{'click .add-swf-file':'addSwfToComponent'});},bindings:{},addSwfToComponent:function(){this.model.view.uploadOnClick();},afterRender:function(){var swfFileName=this.model.get('swfFileName');var actionkey=this.model.get('actionkey');var swfPath='projects/'+__meta__.ownerID+'/'+__meta__.projectID+'/pre/exported_view/'+actionkey.split('-').pop()+'/swf/'+actionkey+'/'+swfFileName;this.$el.find('.editor-swf-container').flash(swfPath);},onSetModel:function(){this.listenTo(this.model,'change:swfFileName',this.render);}});;;var InfoPointPopupEditorView=ImageEditorView.extend({template:_.template($('#infopointpopup-editor-template').html()),events:function(){return _.extend({},EditorView.prototype.events,{'click .title-edit':'startEditTitle','click .message-edit':'startEditMessage','click .title-save':'changeTitle','click .message-save':'changeMessage','change input[name="opacity"]':'onOpacityChanged','click .add-image-file':'addNewImage','click .editor-crop-image-button':'showCropWindow','click .editor-resize-to-stage-button':'resizeToStage','click .editor-original-size-button':'originalSize','click .editor-add-border-button':'showBorderWindow'});},startEditTitle:function(){var _that=this;try{this.titleEditor=CKEDITOR.replace(this.$el.find('.ckeditor-replace-title')[0],{height:'50px',plugins:'basicstyles,wysiwygarea,toolbar,list,blockquote,fakeobjects,stylescombo,dialogui,dialog,undo'});this.$el.find('.title-edit').addClass('feedback-save title-save').text(_lang('SAVE'));}catch(msg){_log('ckeditor error',msg,_log.error);}},startEditMessage:function(){var _that=this;try{this.messageEditor=CKEDITOR.replace(this.$el.find('.ckeditor-replace-message')[0],{height:'80px',plugins:'basicstyles,wysiwygarea,toolbar,list,blockquote,fakeobjects,stylescombo,dialogui,dialog,undo'});this.$el.find('.message-edit').addClass('feedback-save message-save').text(_lang('SAVE'));}catch(msg){_log('ckeditor error',msg,_log.error);}},changeTitle:function(){var feedback=this.titleEditor.getData();this.model.set('title',feedback);this.render();},changeMessage:function(){var feedback=this.messageEditor.getData();this.model.set('text',feedback);this.render();},onSetModel:function(){this.titleEditor=null;this.messageEditor=null;}});;;var InfoPointLinkEditorView=ImageEditorView.extend({template:_.template($('#infopointlink-editor-template').html()),events:function(){return _.extend({},EditorView.prototype.events,{'keyup input[name="link"]':'changeLink','click input[name="iframe"]':'changeIframe','change input[name="opacity"]':'onOpacityChanged','click .add-image-file':'addNewImage','click .editor-crop-image-button':'showCropWindow','click .editor-resize-to-stage-button':'resizeToStage','click .editor-original-size-button':'originalSize','click .editor-add-border-button':'showBorderWindow'});},bindings:{},changeIframe:function(e){this.model.set('openInIframe',$(e.target).is(':checked'));},changeLink:function(e){this.model.set('link',$(e.target).val());}});;;var InfoPointSoundEditorView=ImageEditorView.extend({template:_.template($('#infopointsound-editor-template').html()),events:function(){return _.extend({},EditorView.prototype.events,{'click .add-sound-file':'addSound','click .editor-delete-sound-file':'deleteFileSound','change input[name="sound-volume"]':'soundVolume','change input[name="opacity"]':'onOpacityChanged','click .add-image-file':'addNewImage','click .editor-crop-image-button':'showCropWindow','click .editor-resize-to-stage-button':'resizeToStage','click .editor-original-size-button':'originalSize','click .editor-add-border-button':'showBorderWindow'});},bindings:{},onSetModel:function(){this.listenTo(this.model,'change:sound',this.render);},soundVolume:function(e){var volume=parseInt($(e.target).val());this.model.set('volume',volume);},deleteFileSound:function(){var actionkey=this.model.get('actionkey');var fileName=this.model.get('sound');this.deleteFileSoundOnServer(actionkey,fileName);},deleteFileSoundOnServer:function(actionkey,fileName){var _that=this;DataAccess.updateComponents({page:StageView.instance.model,components:[_that.model],action:"delete-file-sound",fileName:fileName,actionkey:actionkey,pageId:StageView.instance.model.getPageId()},function(data){_that.model.set('sound','');_that.render();},function(data){_log('Update component fault: ',data,_log.dataaccessOutFault)});},addSound:function(e){this.model.setComponentAsSound();this.model.view.uploadOnClick();},});;;var InfoPointSoundControlEditorView=EditorView.extend({template:_.template($('#infopointsoundcontrol-editor-template').html()),events:function(){return _.extend({},EditorView.prototype.events,{'click .add-sound-file':'addSound','click .editor-delete-sound-file':'deleteFileSound',});},bindings:{'#soundcontrol-noskin':'noskin'},onSetModel:function(){var _that=this;this.listenTo(this.model,'change:sound',this.render);},soundVolume:function(e){var volume=parseInt($(e.target).val());this.model.set('volume',volume);},deleteFileSound:function(){var actionkey=this.model.get('actionkey');var fileName=this.model.get('sound');this.deleteFileSoundOnServer(actionkey,fileName);},deleteFileSoundOnServer:function(actionkey,fileName){var _that=this;DataAccess.updateComponents({components:[_that.model],action:"delete-file-sound",fileName:fileName,actionkey:actionkey,pageId:StageView.instance.model.getPageId()},function(data){_log('Update component result: ',data,_log.dataaccessOutResult);_that.model.set('sound','',{silent:true});_that.model.set('point-sound','',{silent:true});_that.render();},function(data){_log('Update component fault: ',data,_log.dataaccessOutFault);});},addSound:function(e){this.model.setComponentAsSound();this.model.view.uploadOnClick();},});;;var InfoPointSoundRecordEditorView=ImageEditorView.extend({template:_.template($('#infopointsoundrecord-editor-template').html()),events:function(){return _.extend({},EditorView.prototype.events,{'click .record-sound':'recordSound','change input[name="opacity"]':'onOpacityChanged','click .add-image-file':'addNewImage','click .editor-crop-image-button':'showCropWindow','click .editor-resize-to-stage-button':'resizeToStage','click .editor-original-size-button':'originalSize','click .editor-add-border-button':'showBorderWindow'});},bindings:{},recordSound:function(e){}});;;var InfoPointGalleryEditorView=ImageEditorView.extend({template:_.template($('#infopointgallery-editor-template').html()),events:function(){return _.extend({},EditorView.prototype.events,{'click .gallery-file-delete':'deleteFile','click .add-gallery-file':'addGalleryFile','change input[name="opacity"]':'onOpacityChanged','click .add-image-file':'addNewImage','click .editor-crop-image-button':'showCropWindow','click .editor-resize-to-stage-button':'resizeToStage','click .editor-original-size-button':'originalSize','click .editor-add-border-button':'showBorderWindow'});},bindings:{},onSetModel:function(){this.model.off('set-gallery-file');this.model.on('set-gallery-file',this.render,this);this.model.off("update-editor");this.model.on("update-editor",this.render,this);},addGalleryFile:function(){this.model.setComponentAsGallery();this.model.view.uploadOnClick();},deleteFile:function(e){var _that=this;var index=parseInt($(e.target).attr('index'));var galleryFiles=this.model.get('galleryFiles');var actionkey=this.model.get('actionkey');var fileName=galleryFiles[index];DataAccess.updateComponents({page:StageView.instance.model,components:[_that.model],action:"delete-file-gallery",fileName:fileName,actionkey:actionkey,pageId:StageView.instance.model.getPageId()},function(data){_log('Update component result: ',data,_log.dataaccessOutResult);var component=data.components[0];_that.model.set('galleryFiles',component.galleryFiles,{silent:true});_that.render();},function(data){_log('Update component fault: ',data,_log.dataaccessOutFault);});},});;;var InfoPointDownloadEditorView=ImageEditorView.extend({template:_.template($('#infopointdownload-editor-template').html()),events:function(){return _.extend({},EditorView.prototype.events,{'click .add-download-file':'addFile','click .editor-delete-file-file':'deleteFile','change input[name="opacity"]':'onOpacityChanged','click .add-image-file':'addNewImage','click .editor-crop-image-button':'showCropWindow','click .editor-resize-to-stage-button':'resizeToStage','click .editor-original-size-button':'originalSize','click .editor-add-border-button':'showBorderWindow'});},bindings:{},onSetModel:function(){this.listenTo(this.model,'change:sound',this.render);this.listenTo(this.model,'change:fileToDownload',this.render);},deleteFile:function(){var actionkey=this.model.get('actionkey');var fileName=this.model.get('fileToDownload');this.deleteFileOnServer(actionkey,fileName);},deleteFileOnServer:function(actionkey,fileName){var _that=this;DataAccess.updateComponents({page:StageView.instance.model,components:[_that.model],action:"delete-file-file",fileName:fileName,actionkey:actionkey,pageId:StageView.instance.model.getPageId()},function(data){_log('Update component result: ',data,_log.dataaccessOutResult);_that.model.set('fileToDownload','',{silent:true});_that.render();},function(data){_log('Update component fault: ',data,_log.dataaccessOutFault);});},addFile:function(e){this.model.setComponentAsDownload();this.model.view.uploadOnClick();}});;;var DrawedInfoPointLinkEditorView=InfoPointLinkEditorView.extend({template:_.template($('#drawedinfopointlink-editor-template').html()),events:function(){return _.extend({},EditorView.prototype.events,{'keyup input[name="editor-border-size-input"]':'changeBorderSize','click input[name="editor-shadow-checkbox"]':'changeShowShadow'});},changeShowShadow:function(e){var showShadow=$(e.target).is(':checked');this.model.set('showShadow',showShadow);},changeBorderSize:function(e){var borderSize=parseInt($(e.target).val());this.model.set('borderSize',borderSize);}});;;var DrawedInfoPointDownloadEditorView=InfoPointDownloadEditorView.extend({template:_.template($('#drawedinfopointdownload-editor-template').html()),events:function(){return _.extend({},EditorView.prototype.events,{'keyup input[name="editor-border-size-input"]':'changeBorderSize','click input[name="editor-shadow-checkbox"]':'changeShowShadow'});},changeShowShadow:function(e){var showShadow=$(e.target).is(':checked');this.model.set('showShadow',showShadow);},changeBorderSize:function(e){var borderSize=parseInt($(e.target).val());this.model.set('borderSize',borderSize);}});;;var DrawedInfoPointGalleryEditorView=InfoPointGalleryEditorView.extend({template:_.template($('#drawedinfopointgallery-editor-template').html()),events:function(){return _.extend({},EditorView.prototype.events,{'keyup input[name="editor-border-size-input"]':'changeBorderSize','click input[name="editor-shadow-checkbox"]':'changeShowShadow'});},changeShowShadow:function(e){var showShadow=$(e.target).is(':checked');this.model.set('showShadow',showShadow);},changeBorderSize:function(e){var borderSize=parseInt($(e.target).val());this.model.set('borderSize',borderSize);}});;;var DrawedInfoPointPopupEditorView=InfoPointPopupEditorView.extend({template:_.template($('#drawedinfopointpopup-editor-template').html()),events:function(){return _.extend({},EditorView.prototype.events,{'keyup input[name="editor-border-size-input"]':'changeBorderSize','click input[name="editor-shadow-checkbox"]':'changeShowShadow'});},changeShowShadow:function(e){var showShadow=$(e.target).is(':checked');this.model.set('showShadow',showShadow);},changeBorderSize:function(e){var borderSize=parseInt($(e.target).val());this.model.set('borderSize',borderSize);}});;;var ParallaxeEditorView=EditorView.extend({template:_.template($('#parallaxe-editor-template').html()),events:function(){return _.extend({},EditorView.prototype.events,{'change #parallax-switcher-cursor':'onParallaxSwitcherCursorChanged','change #parallax-direction-cursor':'onParallaxDirectionCursorChanged','change #parallax-sensitivity-cursor':'onParallaxSensitivityCursorChanged','change #parallax-switcher-scroll':'onParallaxSwitcherScrollChanged','change #parallax-sensitivity-scroll':'onParallaxSensitivityScrollChanged'});},bindings:{},onParallaxSwitcherCursorChanged:function(e){var value=$(e.target).prop('checked');var parallax=this.model.get('parallax');parallax.cursor.on=value;this.model.set('parallax',parallax);this.model.trigger('change');this.render();},onParallaxDirectionCursorChanged:function(e){var value=$(e.target).prop('checked');var parallax=this.model.get('parallax');parallax.cursor.dir=value;this.model.set('parallax',parallax);this.model.trigger('change');},onParallaxSensitivityCursorChanged:function(e){var value=$(e.target).val();var parallax=this.model.get('parallax');parallax.cursor.sens=value;this.model.set('parallax',parallax);_log('parallax',this.model);this.model.trigger('change');},onParallaxSwitcherScrollChanged:function(e){var value=$(e.target).prop('checked');var parallax=this.model.get('parallax');parallax.scroll.on=value;this.model.set('parallax',parallax);this.model.trigger('change');this.render();},onParallaxSensitivityScrollChanged:function(e){var value=$(e.target).val();var parallax=this.model.get('parallax');parallax.scroll.sens=value;this.model.set('parallax',parallax);this.model.trigger('change');},onSetModel:function(){this.render();this.$el.find('[title]').tooltip({html:true,animated:'fade',placement:'top',width:500,height:200});},getJsonModel:function(){_log('render',this.model.toJSON());return this.model.toJSON();},});;;var MultipleParallaxeEditorView=ParallaxeEditorView.extend({template:_.template($('#multiple-editor-template').html()),onSetCollection:function(collection){this.render();}});;;var TimerEditorView=TextEditorView.extend({template:_.template($('#timer-editor-template').html()),bindings:{'[class="enable-scrollbar"]':'enable-scrollbar','#text-editor-padding':'padding','.counter-hourstocount':'hours','.counter-minutestocount':'minutes','.counter-secondstocount':'seconds','.counter-hoursenabled':'hoursEnabled','.counter-minutesenabled':'minutesEnabled','.counter-secondsenabled':'secondsEnabled','.counter-autostart':'counterAutostart','.counter-id':'timerId'},events:function(){return _.extend({},EditorView.prototype.events,{'change .enable-scrollbar':'onEnableScrollbar','click .editor-add-border-button':'showBorderWindow'});},showBorderWindow:function(){this.model.view.addBorder();},onSetModel:function(){var _that=this;this.model.off('refresh-bottom-editor');this.model.on('refresh-bottom-editor',function(){_that.afterRender();});},forceRefreshEditorView:function(){this.afterRender();},afterRender:function(){var _that=this;this.colorPicker();this.listenTo(this.model,'change:padding',this.onPaddingChange);this.$el.find('[title]').tooltip({html:true,animated:'fade',placement:'right',width:300,height:200,'container':'body'});},colorPicker:function(){var _that=this;var styles=_that.model.get('styles');var gradientSaveTimeout=null;var background='#FFF';if(_.isUndefined(styles['component-gradient'])){styles['component-gradient']={};}
if(!_.isUndefined(styles['component-gradient']['background'])){background=styles['component-gradient']['background'];}
this.textBgColorPicker=new GradientPickerView({color:background});this.$el.find('.text-color-picker-container').html(this.textBgColorPicker.render().$el);this.textBgColorPicker.afterRender();this.textBgColorPicker.on('move',function(data){styles['component-gradient']['background']=data.color;_that.model.set('styles',styles,{silent:true});_that.model.view.$el.find('.component-inner').css('background',data.color);_that.$el.find('.picker-container').css('background',data.color);});this.textBgColorPicker.on('gradient-change',function(data){_that.model.view.$el.find('.component-inner').css('background',data.color);clearTimeout(gradientSaveTimeout);styles['component-gradient']['background']=data.color;_that.model.set('styles',styles,{silent:true});gradientSaveTimeout=setTimeout(function(){_that.model.trigger('change');},500);});this.textBgColorPicker.on('hide',function(data){_that.model.trigger('change');});},onPaddingChange:function(){this.model.view.renderPadding();},onEnableScrollbar:function(e){var value=$(e.target).prop('checked');this.model.set('enable-scrollbar',value);}});;;function EditorsFactory(){}
EditorsFactory.createScoreEditor=function(){var editor=new ScoreEditorView();return editor;}
EditorsFactory.createPublishScoreEditor=function(){var editor=new PublishScoreEditorView();return editor;}
EditorsFactory.createScoreExerciseEditor=function(){var editor=new ScoreExerciseEditorView();return editor;}
EditorsFactory.createFormInputTextEditor=function(){var editor=new FormInputTextEditorView();return editor;}
EditorsFactory.createFormUploadEditor=function(){var editor=new FormUploadEditorView();return editor;}
EditorsFactory.createTimerEditor=function(){var editor=new TimerEditorView();return editor;}
EditorsFactory.createFormTextareaEditor=function(){var editor=new FormTextareaEditorView();return editor;}
EditorsFactory.createFormSelectEditor=function(){var editor=new FormSelectEditorView();return editor;}
EditorsFactory.createFormCheckboxEditor=function(){var editor=new FormCheckboxEditorView();return editor;}
EditorsFactory.createFormRadioEditor=function(){var editor=new FormRadioEditorView();return editor;}
EditorsFactory.createFormSubmitEditor=function(stageView){var editor=new FormSubmitEditorView({stageView:stageView});return editor;}
EditorsFactory.createIframeEditor=function(){var editor=new IframeEditorView();return editor;}
EditorsFactory.createSwfEditor=function(){var editor=new SwfEditorView();return editor;}
EditorsFactory.createDrawedInfoPointLinkEditor=function(){var editor=new DrawedInfoPointLinkEditorView();return editor;}
EditorsFactory.createDrawedInfoPointDownloadEditor=function(){var editor=new DrawedInfoPointDownloadEditorView();return editor;}
EditorsFactory.createDrawedInfoPointGalleryEditor=function(){var editor=new DrawedInfoPointGalleryEditorView();return editor;}
EditorsFactory.createDrawedInfoPointPopupEditor=function(){var editor=new DrawedInfoPointPopupEditorView();return editor;}
EditorsFactory.createInfoPointPopupEditor=function(){var editor=new InfoPointPopupEditorView();return editor;}
EditorsFactory.createInfoPointLinkEditor=function(){var editor=new InfoPointLinkEditorView();return editor;}
EditorsFactory.createInfoPointSoundEditor=function(){var editor=new InfoPointSoundEditorView();return editor;}
EditorsFactory.createInfoPointSoundControlEditor=function(){var editor=new InfoPointSoundControlEditorView();return editor;}
EditorsFactory.createInfoPointSoundRecordEditor=function(){var editor=new InfoPointSoundRecordEditorView();return editor;}
EditorsFactory.createInfoPointGalleryEditor=function(){var editor=new InfoPointGalleryEditorView();return editor;}
EditorsFactory.createInfoPointDownloadEditor=function(){var editor=new InfoPointDownloadEditorView();return editor;}
EditorsFactory.createSizeAndPositionEditorView=function(){var editor=new SizeAndPositionEditorView();return editor;}
EditorsFactory.createAlignEditorView=function(){var editor=new AlignEditorView();return editor;}
EditorsFactory.createTextEditor=function(){var editor=new TextEditorView();return editor;}
EditorsFactory.createTextToolbarEditor=function(){var editor=new TextToolbarEditorView();return editor;}
EditorsFactory.createImageEditor=function(){var editor=new ImageEditorView();return editor;}
EditorsFactory.createVideoEditor=function(){var editor=new VideoEditorView();return editor;}
EditorsFactory.createQuizEditor=function(){var editor=new QuizEditorView();return editor;}
EditorsFactory.createQuizSelectOneEditor=function(){var editor=new QuizSelectOneEditorView();return editor;}
EditorsFactory.createQuizFillInBlanksEditor=function(){var editor=new QuizFillInBlanksEditorView();return editor;}
EditorsFactory.createQuizDnDEditor=function(stageView){var editor=new QuizDnDEditorView({stageView:stageView});return editor;}
EditorsFactory.createQuizConnectLinesEditor=function(stageView){var editor=new QuizConnectLinesEditorView({stageView:stageView});return editor;}
EditorsFactory.createQuizWordsearchEditor=function(stageView){var editor=new QuizWordsearchEditorView({stageView:stageView});return editor;}
EditorsFactory.createScrollerEditor=function(){var editor=new ScrollerEditorView();return editor;}
EditorsFactory.createCrosswordEditor=function(){var editor=new CrosswordEditorView();return editor;}
EditorsFactory.createStageEditor=function(){var editor=new StageEditorView();return editor;}
EditorsFactory.createPagenoteEditor=function(){var editor=new PagenoteEditorView();return editor;}
EditorsFactory.createSoundEditor=function(){var editor=new SoundEditorView();return editor;}
EditorsFactory.createProjectSoundEditor=function(){var editor=new SoundUploaderEditorView();return editor;}
EditorsFactory.createTimelineEditor=function(){var editor=new TimelineEditorView();return editor;}
EditorsFactory.createTimelineComponentEditor=function(){var editor=new TimelineComponentEditorView();return editor;}
EditorsFactory.createTimelineComponentsCollectionEditor=function(){var editor=new TimelineComponentsCollectionEditorView();return editor;}
EditorsFactory.createTimelineRowEditor=function(){var editor=new TimelineRowEditorView();return editor;}
EditorsFactory.createTimelineStageEditor=function(){var editor=new TimelineStageEditorView();return editor;}
EditorsFactory.createWcagEditor=function(){var editor=new WcagEditorView();return editor;}
EditorsFactory.createParallaxeEditor=function(){var editor=new ParallaxeEditorView();return editor;}
EditorsFactory.createMultipleEditor=function(){var editor=new MultipleEditorView();return editor;}
EditorsFactory.createMultipleSizeAndPositionEditor=function(){var editor=new MultipleSizeAndPositionEditorView();return editor;}
EditorsFactory.createMultipleScoreEditor=function(){var editor=new MultipleScoreEditorView();return editor;}
EditorsFactory.createMultipleWcagEditor=function(){var editor=new MultipleWcagEditorView();return editor;}
EditorsFactory.createMultipleSoundEditor=function(){var editor=new MultipleSoundEditorView();return editor;}
EditorsFactory.createMultipleParallaxeEditor=function(){var editor=new MultipleParallaxeEditorView();return editor;}
EditorsFactory.createQuizInputTextEditor=function(){var editor=new QuizInputTextEditorView();return editor;}
EditorsFactory.createQuizSelectEditor=function(){var editor=new QuizSelectEditorView();return editor;}
EditorsFactory.createReportEditor=function(){var editor=new ReportEditorView();return editor;}
EditorsFactory.createMultipleReportEditor=function(){var editor=new MultipleReportEditorView();return editor;};;function StyleEditorsFactory(){}
StyleEditorsFactory.createQuizSelectEditor=function(){var editor=new QuizSelectStyleEditorView();return editor;}
StyleEditorsFactory.createQuizInputTextEditor=function(){var editor=new QuizInputTextStyleEditorView();return editor;}
StyleEditorsFactory.createFormInputTextEditor=function(){var editor=new FormInputTextStyleEditorView();return editor;}
StyleEditorsFactory.createFormUploadEditor=function(){var editor=new FormUploadStyleEditorView();return editor;}
StyleEditorsFactory.createFormTextareaEditor=function(){var editor=new FormTextareaStyleEditorView();return editor;}
StyleEditorsFactory.createFormSelectEditor=function(){var editor=new FormSelectStyleEditorView();return editor;}
StyleEditorsFactory.createFormCheckboxEditor=function(){var editor=new FormCheckboxStyleEditorView();return editor;}
StyleEditorsFactory.createFormRadioEditor=function(){var editor=new FormRadioStyleEditorView();return editor;}
StyleEditorsFactory.createFormSubmitEditor=function(){var editor=new FormSubmitStyleEditorView();return editor;}
StyleEditorsFactory.createIframeEditor=function(){var editor=new IframeStyleEditorView();return editor;}
StyleEditorsFactory.createSwfEditor=function(){var editor=new SwfStyleEditorView();return editor;}
StyleEditorsFactory.createDrawedInfoPointLinkEditor=function(){var editor=new DrawedInfoPointLinkStyleEditorView();return editor;}
StyleEditorsFactory.createDrawedInfoPointDownloadEditor=function(){var editor=new DrawedInfoPointDownloadStyleEditorView();return editor;}
StyleEditorsFactory.createDrawedInfoPointGalleryEditor=function(){var editor=new DrawedInfoPointGalleryStyleEditorView();return editor;}
StyleEditorsFactory.createDrawedInfoPointPopupEditor=function(){var editor=new DrawedInfoPointPopupStyleEditorView();return editor;}
StyleEditorsFactory.createInfoPointPopupEditor=function(){var editor=new InfoPointPopupStyleEditorView();return editor;}
StyleEditorsFactory.createInfoPointLinkEditor=function(){var editor=new InfoPointLinkStyleEditorView();return editor;}
StyleEditorsFactory.createInfoPointSoundEditor=function(){var editor=new InfoPointSoundStyleEditorView();return editor;}
StyleEditorsFactory.createInfoPointSoundControlEditor=function(){var editor=new InfoPointSoundControlStyleEditorView();return editor;}
StyleEditorsFactory.createInfoPointSoundRecordEditor=function(){var editor=new InfoPointSoundRecordStyleEditorView();return editor;}
StyleEditorsFactory.createInfoPointGalleryEditor=function(){var editor=new InfoPointGalleryStyleEditorView();return editor;}
StyleEditorsFactory.createInfoPointDownloadEditor=function(){var editor=new InfoPointDownloadStyleEditorView();return editor;}
StyleEditorsFactory.createSizeAndPositionEditorView=function(){var editor=new SizeAndPositionStyleEditorView();return editor;}
StyleEditorsFactory.createTextEditor=function(){var editor=new TextStyleEditorView();return editor;}
StyleEditorsFactory.createTimerEditor=function(){var editor=new TimerStyleEditorView();return editor;}
StyleEditorsFactory.createTextToolbarEditor=function(){var editor=new TextToolbarStyleEditorView();return editor;}
StyleEditorsFactory.createImageEditor=function(){var editor=new ImageStyleEditorView();return editor;}
StyleEditorsFactory.createVideoEditor=function(){var editor=new VideoStyleEditorView();return editor;}
StyleEditorsFactory.createQuizEditor=function(){var editor=new QuizStyleEditorView();return editor;}
StyleEditorsFactory.createQuizSelectOneEditor=function(){var editor=new QuizSelectOneStyleEditorView();return editor;}
StyleEditorsFactory.createQuizFillInBlanksEditor=function(){var editor=new QuizFillInBlanksStyleEditorView();return editor;}
StyleEditorsFactory.createQuizDnDEditor=function(stageView){var editor=new QuizDnDStyleEditorView({stageView:stageView});return editor;}
StyleEditorsFactory.createQuizConnectLinesEditor=function(stageView){var editor=new QuizConnectLinesStyleEditorView({stageView:stageView});return editor;}
StyleEditorsFactory.createQuizWordsearchEditor=function(stageView){var editor=new QuizWordsearchStyleEditorView({stageView:stageView});return editor;}
StyleEditorsFactory.createScrollerEditor=function(){var editor=new ScrollerStyleEditorView();return editor;}
StyleEditorsFactory.createCrosswordEditor=function(){var editor=new CrosswordStyleEditorView();return editor;}
StyleEditorsFactory.createStageEditor=function(){var editor=new StageStyleEditorView();return editor;};;var StyleEditorView=EditorView.extend({template:_.template($('#style-editor-template').html()),events:{'click .style-template':'setStyleToComponentModel','click .reset-style-template':'resetStyleTemplate'},resetStyleTemplate:function(){var style=this.model.createStylesObject();this.model.set('styles',style);this.model.view.renderStyle();},disableIfNotActive:function(){},setStyleToComponentModel:function(e){var st=$(e.currentTarget).attr('st');var type=$(e.currentTarget).attr('type');var style=stylesImage;switch(type){case'image':sytle=stylesImage;break;case'text':style=stylesText;break;case'gradient':style=stylesGradient;break;case'questions':style=stylesQuestion;break;case'dnd':style=stylesDnd;break;case'inputtext':style=stylesInputText;break;}
this.model.setStyle(style,st);this.model.refreshEditor();},onSetModel:function(){},afterRender:function(){this.runStylesFactory();},runStylesFactory:function(){}});;;var ImageStyleEditorView=StyleEditorView.extend({template:_.template($('#have-style-editor-template').html()),events:function(){return _.extend({},StyleEditorView.prototype.events,{'click .avatar-item':'changeImageLibrary'});},disableIfNotActive:function(){},onSetModel:function(){this.listenTo(this.model,'change:library',this.runStylesLibrary);},changeImageLibrary:function(e){var _that=this;var target=$(e.currentTarget);var itemDir=target.attr('item-dir');var actionkey=this.model.get('actionkey');var pageID=StageView.instance.model.get('options').get('pageid');var oldFileName=this.model.get('imageFileName');DataAccess.copyLibraryFileToImage({itemDir:itemDir,actionkey:actionkey,pageID:pageID,oldFileName:oldFileName},function(data){var sizeW=parseInt(data.size.split('x')[0]);var sizeH=parseInt(data.size.split('x')[1]);var oldW=parseInt(_that.model.get('width'));var oldH=parseInt(_that.model.get('height'));var newWidth=(parseInt(_that.model.get('height'))*sizeW)/ sizeH;_that.model.set('width',newWidth);_that.model.set('library',itemDir,{silent:true});_that.model.set('imageFileName',data.fileName);var src=__meta__.projects_link+__meta__.ownerID+'/'+__meta__.projectID+'/pre/exported_view/'+pageID+'/images/'+actionkey+'/'+data.fileName;_that.$el.find('.img-wrapper img').attr('src',src);_that.model.forceRender();_that.model.view.createMiniature();},function(data){_log('data',data)});},runStylesLibrary:function(){var _that=this;var library=this.model.get('library');if(library!=''){var _library=library.split('/');var id=_library[1];var fo=_library[0];var request={request:2,path1:fo,path2:id};var libraryContainer=$('<div>',{class:'template-styles-container2'});DataAccess.libraryRequest({request:JSON.stringify(request)},function(data){var dataJ=JSON.parse(data);libraryContainer.html(dataJ.html);_that.$el.append(libraryContainer);_that.$el.find('.template-styles-container, .template-styles-container2').css({width:'50%',float:'left'});},function(data){_log('data',data)});}},runStylesFactory:function(){var _that=this;var styles=StylesFactory.getImageStyles();this.$el.find('.template-styles-container').append(styles);var library=this.model.get('library');_log('runStylesFactory',library);_log('this.model',this.model);if(library!=''){this.runStylesLibrary();}}});;;var CrosswordStyleEditorView=StyleEditorView.extend({});;;var DrawedInfoPointDownloadStyleEditorView=StyleEditorView.extend({runStylesFactory:function(){var styles=StylesFactory.getGradientStyles();this.$el.find('.template-styles-container').append(styles);}});;;var DrawedInfoPointGalleryStyleEditorView=StyleEditorView.extend({runStylesFactory:function(){var styles=StylesFactory.getGradientStyles();this.$el.find('.template-styles-container').append(styles);}});;;var DrawedInfoPointLinkStyleEditorView=StyleEditorView.extend({runStylesFactory:function(){var styles=StylesFactory.getGradientStyles();this.$el.find('.template-styles-container').append(styles);}});;;var DrawedInfoPointPopupStyleEditorView=StyleEditorView.extend({runStylesFactory:function(){var styles=StylesFactory.getGradientStyles();this.$el.find('.template-styles-container').append(styles);}});;;var FormInputTextStyleEditorView=StyleEditorView.extend({});;;var FormUploadStyleEditorView=ImageStyleEditorView.extend({});;;var QuizInputTextStyleEditorView=StyleEditorView.extend({template:_.template($('#have-style-editor-template').html()),runStylesFactory:function(){var styles=StylesFactory.getInputTextStyles();this.$el.find('.template-styles-container').append(styles);}});;;var FormSelectStyleEditorView=StyleEditorView.extend({});;;var QuizSelectStyleEditorView=StyleEditorView.extend({});;;var FormCheckboxStyleEditorView=StyleEditorView.extend({});;;var FormRadioStyleEditorView=StyleEditorView.extend({});;;var FormTextareaStyleEditorView=StyleEditorView.extend({runStylesFactory:function(){var styles=StylesFactory.getGradientStyles();this.$el.find('.template-styles-container').append(styles);}});;;var FormSubmitStyleEditorView=StyleEditorView.extend({template:_.template($('#have-style-editor-template').html()),runStylesFactory:function(){var styles=StylesFactory.getDndStyles();this.$el.find('.template-styles-container').append(styles);}});;;var IframeStyleEditorView=StyleEditorView.extend({runStylesFactory:function(){var styles=StylesFactory.getGradientStyles();this.$el.find('.template-styles-container').append(styles);}});;;var InfoPointDownloadStyleEditorView=ImageStyleEditorView.extend({});;;var InfoPointGalleryStyleEditorView=ImageStyleEditorView.extend({});;;var InfoPointLinkStyleEditorView=ImageStyleEditorView.extend({});;;var InfoPointPopupStyleEditorView=ImageStyleEditorView.extend({});;;var InfoPointSoundStyleEditorView=ImageStyleEditorView.extend({});;;var InfoPointSoundControlStyleEditorView=StyleEditorView.extend({});;;var InfoPointSoundRecordStyleEditorView=StyleEditorView.extend({});;;var QuizStyleEditorView=StyleEditorView.extend({template:_.template($('#have-style-editor-template').html()),runStylesFactory:function(){var _that=this;var styles=StylesFactory.getQuestionsStyles();this.$el.find('.template-styles-container').append(styles);var stylesOwn=this.createOwnTempate();this.stylesOwnContainer=$('<div>',{class:'template-styles-container2'});this.stylesOwnContainer.append(stylesOwn);this.$el.append(this.stylesOwnContainer);this.$el.find('.template-styles-container, .template-styles-container2').css({width:'50%',float:'left'});this.listenTo(this.model,'change',this.colorPicker);this.colorPicker();},colorPicker:function(){var styles=_that.model.get('styles');var backgroundColor='#FFF';var textColor='#FFF';var buttonBackgroundColor='#FFF';var buttonTextColor='#FFF';if(typeof styles['quiz-body']==='undefined'){styles['quiz-body']={};}
if(typeof styles['quiz-body']['background']!=='undefined'){backgroundColor=styles['quiz-body']['background'];}
if(typeof styles['quiz-body']['color']!=='undefined'){textColor=styles['quiz-body']['color'];}
if(typeof styles['quiz-submit-button']==='undefined'){styles['quiz-submit-button']={};}
if(typeof styles['quiz-submit-button']['background']!=='undefined'){buttonBackgroundColor=styles['quiz-submit-button']['background'];}
if(typeof styles['quiz-submit-button']['color']!=='undefined'){buttonTextColor=styles['quiz-submit-button']['color'];}
this.colorPickerBackground=new ColorPickerView({color:backgroundColor});this.$el.find('.quiz-background-color-picker').html(this.colorPickerBackground.render().$el);this.colorPickerBackground.on('move',function(data){styles['quiz-body']['background']=data.color;_that.model.set('styles',styles,{silent:true});_that.model.view.$el.find('.quiz-body').css('background',data.color);_that.stylesOwnContainer.find('.quiz-body').css('background',data.color);});this.colorPickerBackground.on('hide',function(data){_that.model.trigger('change');_that.colorPickerBackground.updateColorPicker({color:_that.model.get('styles')['quiz-body']['background']});});this.colorPickerText=new ColorPickerView({color:textColor});this.$el.find('.quiz-text-color-picker').html(this.colorPickerText.render().$el);this.colorPickerText.on('move',function(data){styles['quiz-body']['color']=data.color;_that.model.set('styles',styles,{silent:true});_that.model.view.$el.find('.quiz-body').css('color',data.color);_that.stylesOwnContainer.find('.quiz-body').css('color',data.color);});this.colorPickerText.on('hide',function(data){_that.model.trigger('change');_that.colorPickerText.updateColorPicker({color:_that.model.get('styles')['quiz-body']['color']});});this.colorPickerButtonBackground=new ColorPickerView({color:buttonBackgroundColor});this.$el.find('.quiz-button-background-color-picker').html(this.colorPickerButtonBackground.render().$el);this.colorPickerButtonBackground.on('move',function(data){styles['quiz-submit-button']['background']=data.color;_that.model.set('styles',styles,{silent:true});_that.model.view.$el.find('.quiz-submit-button').css('background',data.color);_that.stylesOwnContainer.find('.quiz-own-button').css('background',data.color);});this.colorPickerButtonBackground.on('hide',function(data){_that.model.trigger('change');_that.colorPickerButtonBackground.updateColorPicker({color:_that.model.get('styles')['quiz-submit-button']['background']});});this.colorPickerButtonText=new ColorPickerView({color:buttonTextColor});this.$el.find('.quiz-button-text-color-picker').html(this.colorPickerButtonText.render().$el);this.colorPickerButtonText.on('move',function(data){styles['quiz-submit-button']['color']=data.color;_that.model.set('styles',styles,{silent:true});_that.model.view.$el.find('.quiz-submit-button').css('color',data.color);_that.stylesOwnContainer.find('.quiz-own-button').css('color',data.color);});this.colorPickerButtonText.on('hide',function(data){_that.model.trigger('change');_that.colorPickerButtonText.updateColorPicker({color:_that.model.get('styles')['quiz-submit-button']['color']});});},createOwnTempate:function(){var background=this.model.get('backgroundColor')!==''?'background:'+this.model.get('backgroundColor')+';':'';var text=this.model.get('textColor')!==''?'color:'+this.model.get('textColor')+';':'';var buttonBackground=this.model.get('buttonBackgroundColor')!==''?'background:'+this.model.get('buttonBackgroundColor')+';':'';var buttonText=this.model.get('buttonTextColor')!==''?'color:'+this.model.get('buttonTextColor')+';':'';var html='<div class="quiz-own-container-template '+this.model.get('premade-style')+'">';html+='<div class="quiz-body" style="'+background+text+'">';html+='<div class="quiz-own-answer-wrapper">';html+='<label>';html+='<input class="quiz-own-answer-checkbox" type="checkbox">';html+='<span class="quiz-own-answer-text">Answer 1</span>';html+='</label>';html+='</div>';html+='<div class="quiz-own-answer-wrapper">';html+='<label>';html+='<input class="quiz-own-answer-checkbox" type="checkbox">';html+='<span class="quiz-own-answer-text">Answer 2</span>';html+='</label>';html+='</div>';html+='<div class="quiz-own-button" style="'+buttonBackground+buttonText+'">OK</div>';html+='</div>';html+='</div>';html+='<div class="quiz-color-picker-container">';html+='<div class="quiz-background-color-picker"></div>';html+='<div class="quiz-text-color-picker"></div>';html+='<div class="quiz-button-background-color-picker"></div>';html+='<div class="quiz-button-text-color-picker"></div>';html+='</div>';return html;}});;;var QuizSelectOneStyleEditorView=StyleEditorView.extend({events:function(){return _.extend({},StyleEditorView.prototype.events,{'click .style-template':'setStyle'});},});;;var QuizWordsearchStyleEditorView=StyleEditorView.extend({});;;var QuizConnectLinesStyleEditorView=StyleEditorView.extend({template:_.template($('#have-style-editor-template').html()),runStylesFactory:function(){var styles=StylesFactory.getDndStyles();this.$el.find('.template-styles-container').append(styles);}});;;var QuizDnDStyleEditorView=StyleEditorView.extend({template:_.template($('#have-style-editor-template').html()),runStylesFactory:function(){var styles=StylesFactory.getDndStyles();this.$el.find('.template-styles-container').append(styles);}});;;var QuizFillInBlanksStyleEditorView=StyleEditorView.extend({runStylesFactory:function(){var styles=StylesFactory.getGradientStyles();this.$el.find('.template-styles-container').append(styles);}});;;var ScrollerStyleEditorView=StyleEditorView.extend({});;;var StageStyleEditorView=StyleEditorView.extend({events:function(){return _.extend({},StyleEditorView.prototype.events,{'click .avatar-item':'changeStageBackground','click .avatar-folder':'getFolderData','click .background-back':'runStylesFactory'});},changeStageBackground:function(e){var _that=this;var target=$(e.currentTarget);var itemDir=target.attr('item-dir');var pageID=StageView.instance.model.get('options').get('pageid');var oldFileName=this.model.get('image');DataAccess.changeStageBackgroundLibrary({itemDir:itemDir,pageID:pageID,oldFileName:oldFileName},function(data){_that.model.set('image',data.fileName);setTimeout(function(){StageView.instance.model.updateDinamicPageThumb();},100);},function(data){_log('data',data)});},getFolderData:function(e){var _that=this;var backgroundsContainer=$('<div>',{class:'template-styles-container2'});var target=$(e.currentTarget);var id=target.attr('folder-name');var fo=target.attr('folder-lib');var request={request:2,path1:fo,path2:id};DataAccess.libraryRequest({request:JSON.stringify(request)},function(data){var dataJ=JSON.parse(data);var backBackgroundButton='<div class="background-back"></div>';backgroundsContainer.html(backBackgroundButton+dataJ.html);_that.$el.html(backgroundsContainer);},function(data){_log('data',data)});},runStylesFactory:function(){var _that=this;var backgroundsContainer=$('<div>',{class:'template-styles-container2'});var request={request:1,path:'backgrounds'};DataAccess.libraryRequest({request:JSON.stringify(request)},function(data){var dataJ=JSON.parse(data);backgroundsContainer.html(dataJ.html);_that.$el.html(backgroundsContainer);},function(data){_log('data',data)});}});;;var SwfStyleEditorView=StyleEditorView.extend({});;;var TextStyleEditorView=StyleEditorView.extend({template:_.template($('#have-style-editor-template').html()),runStylesFactory:function(){var stylesText=StylesFactory.getSimpletextStyles();var stylesGradients=StylesFactory.getGradientStyles();this.$el.find('.template-styles-container').append(stylesText);var gradientContainer=$('<div>',{class:'template-styles-container2'});gradientContainer.append(stylesGradients);this.$el.append(gradientContainer);this.$el.find('.template-styles-container, .template-styles-container2').css({width:'50%',float:'left'});}});;;var VideoStyleEditorView=StyleEditorView.extend({});;;var TimerStyleEditorView=StyleEditorView.extend({template:_.template($('#have-style-editor-template').html()),runStylesFactory:function(){var stylesText=StylesFactory.getSimpletextStyles();var stylesGradients=StylesFactory.getGradientStyles();this.$el.find('.template-styles-container').append(stylesText);var gradientContainer=$('<div>',{class:'template-styles-container2'});gradientContainer.append(stylesGradients);this.$el.append(gradientContainer);this.$el.find('.template-styles-container, .template-styles-container2').css({width:'50%',float:'left'});}});;;var EditorNavigationItemModel=Backbone.Model.extend({defaults:{name:'',type:'',isBinding:true,},isDisabled:false,initialize:function(){}});;;var EditorsNavigationCollection=Backbone.Collection.extend({model:EditorNavigationItemModel,});;;var EditorNavigationItemView=ItemView.extend({tagName:'li',className:'editor-navigation-item-view',template:_.template($('#editor-navigation-item-template').html()),events:{'click .editor-navigation-selector':'selectEditor','mousedown':'onMouseDown','drop-item':'dropItem',},initialize:function(){this.model.off('disable-editor-item',this.disableEditorItem,this);this.model.off('enable-editor-item',this.enableEditorItem,this);this.model.on('disable-editor-item',this.disableEditorItem,this);this.model.on('enable-editor-item',this.enableEditorItem,this);},dropItem:function(event,index){this.$el.trigger('update-sort',[this.model,index]);},render:function(){var template=this.template(this.serializeData());this.$el.html(template);this.renderIsDisabled();return this;},renderIsDisabled:function(){if(this.model.isDisabled){this.$el.attr('editordisabled',true);}},renderIsBinding:function(){if(this.model.get('isBinding')){this.$el.show();}else{this.$el.hide();}},serializeData:function(){return this.model.toJSON();},closeEditor:function(){this.trigger('close-editor',this.model);},selectEditor:function(){if(this.model.isDisabled){return;}
this.model.collection.each(function(model){model.view2.$el.attr('active',false);});this.$el.attr('active',true);this.trigger('select-editor',this.model);},showContextMenu:function(e){var contextMenuView=new EditorContextMenuView({model:this.model,view:this});ContextMenuContainer.addMenu(contextMenuView,e);},disableEditorItem:function(){if(!this.model.isDisabled){this.$el.attr('editordisabled',true);this.model.isDisabled=true;}},enableEditorItem:function(){if(this.model.isDisabled){this.$el.removeAttr('editordisabled');this.model.isDisabled=false;}},unbindEditor:function(){this.trigger('unbind-editor',this.model);}});;;var ToogelButtonnEditorItemView=Backbone.View.extend({tagName:'div',className:'toggle-button-editor-item-view',template:_.template($('#toggle-button-item-view-template').html()),events:{'click':'toggleEditors'},initialize:function(){},render:function(){var template=this.template(this.serializeData());this.$el.html(template);return this;},afterRender:function(){},serializeData:function(){return{};},toggleEditors:function(){this.trigger('toogle',this);}});;;var EditorsNavigation=Backbone.View.extend({tagName:'ul',className:'editors-navigation',template:_.template($('#editors-navigation-template').html()),events:{'update-sort':'updateSort',},initialize:function(){this.collection=new EditorsNavigationCollection();this.collection.add(new EditorNavigationItemModel({type:'timeline',name:Lang.get('editor.MENU_TIMELINE')}));this.collection.add(new EditorNavigationItemModel({type:'properties',name:Lang.get('editor.MENU_PROPERTIES')}));this.collection.add(new EditorNavigationItemModel({type:'styles',name:Lang.get('editor.MENU_STYLES')}));this.collection.add(new EditorNavigationItemModel({type:'score',name:Lang.get('editor.MENU_SCORES')}));this.collection.add(new EditorNavigationItemModel({type:'parallax',name:Lang.get('editor.MENU_PARALLAX')}));this.collection.add(new EditorNavigationItemModel({type:'note',name:Lang.get('editor.MENU_NOTE')}));this.collection.add(new EditorNavigationItemModel({type:'wcag',name:Lang.get('editor.MENU_WCAG')}));this.collection.add(new EditorNavigationItemModel({type:'sounds',name:Lang.get('editor.MENU_POINT_SOUNDS')}));this.collection.add(new EditorNavigationItemModel({type:'reaports',name:Lang.get('editor.MENU_REAPORTS')}));_log('EditorsNavigationCollection',this.collection);},render:function(){var template=this.template(this.serializeData());this.$el.html(template);this.makeSortable();this.renderEditorssList();return this;},renderEditorssList:function(){this.addToggleButton();this.collection.each(this.renderOneItem,this);if(this.collection.length>0){this.addPlusButton();}},renderIsBindingList:function(){this.collection.each(this.renderIsBindingOneItem,this);},renderIsBindingOneItem:function(model){model.view2.renderIsBinding();},renderOneItem:function(model){var editorNavigationItemView=new EditorNavigationItemView({model:model});model.view2=editorNavigationItemView;editorNavigationItemView.on('close-editor',this.closeEditor,this);editorNavigationItemView.on('select-editor',this.selectEditor,this);editorNavigationItemView.on('unbind-editor',this.unbindEditor,this);this.$el.append(editorNavigationItemView.render().$el);_log('editorNavigationItemView',editorNavigationItemView);_log('model',model);if(!model.get('isBinding')){editorNavigationItemView.$el.hide();}},unbindEditor:function(model){this.trigger('unbind-editor',model);this.renderIsBindingList();},afterRender:function(){this.selectFirstEditor();},serializeData:function(){return{};},selectFirstEditor:function(){var first=this.collection.first();if(first){first.view2.selectEditor(first);}},addPlusButton:function(){},addToggleButton:function(){var toggelButtonView=new ToogelButtonnEditorItemView();toggelButtonView.on('toogle',this.toggleEditors,this);this.$el.append(toggelButtonView.render().$el);},toggleEditors:function(view){this.trigger('toogle',view);},makeSortable:function(){this.$el.sortable({delay:100,items:".editor-navigation-item-view",update:function(event,ui){ui.item.trigger('drop-item',ui.item.index());}});},closeEditor:function(model){this.collection.remove(model);this.render();this.trigger('on-editor-closed',model);},selectEditor:function(model){this.trigger('on-editor-selected',model);},updateSort:function(event,model,position){this.collection.remove(model);this.collection.add(model,{at:position});},changeTabEditor:function(params){var params=params||{};var tabName=params.tabName;var editorItemModel=this.collection.findWhere({'type':tabName});_log('this.collection',this.collection);_log('editorItemModel',editorItemModel);if(!editorItemModel){return;}
this.selectEditor(editorItemModel);},goToTab:function(params){params=params||{};var tabName=params.tabName;if(_.isUndefined(tabName)){return;}
var editorModel=this.collection.findWhere({type:tabName});_log('editorModel',editorModel);if(_.isUndefined(editorModel)){return;}
editorModel.view2.selectEditor();}});;;var EditorItemView=Backbone.View.extend({tagName:'li',className:'editor-item-view',template:_.template($('#editor-item-view-template').html()),events:{},isSelected:false,initialize:function(){this.editorItemModel={};this.editorItemModel.trigger=function(){};this.editorItemModel.get=function(){return true;};this.model=StageView.instance.model;},show:function(){this.$el.show();this.isSelected=true;this.setModelToEditor(this.model);},hide:function(){if(this.editorItemModel.get('isBinding')){this.$el.hide();this.isSelected=false;}},render:function(){var template=this.template(this.serializeData());this.$el.html(template);return this;},serializeData:function(){return{};},afterRender:function(){},setModel:function(pageModel){},setModelToEditor:function(model){},setStageModelToEditor:function(pModel){},goToTimelineTab:function(tabName){this.goToTab('timeline');},goToTab:function(tabName){this.trigger('go-to-tab',{tabName:tabName});},checkIfDisableEditor:function(model){},disableEditor:function(){this.editorItemModel.trigger('disable-editor-item');},enableEditor:function(){this.editorItemModel.trigger('enable-editor-item');},onWindowResize:function(e){}});;;var TimelineEditorItemView=EditorItemView.extend({className:'timeline-editor-item-view',template:_.template($('#timeline-editor-item-view-template').html()),timelineType:'classic',initialize:function(){var _that=this;this.model=StageView.instance.model;this.timelineEditor=function(){};this.timelineEditor.destroy=function(){};this.timelineEditor.setCollection=function(){};this.timelineEditor.setModel=function(){};this.timelineComponentsCollectionEditorView=EditorsFactory.createTimelineComponentsCollectionEditor();this.timelineComponentEditorView=EditorsFactory.createTimelineComponentEditor();this.timelineStageEditorView=EditorsFactory.createTimelineStageEditor();this.timelineRowEditorView=EditorsFactory.createTimelineRowEditor();$(window).resize(function(e){if(e.target==window){_that.onWindowResize(e);}});},onWindowResize:function(e){this.timeline.onWindowResize();},afterRender:function(){this.timeline=new ClassicTimelineView();this.timeline.collection=new ComponentCollection();this.addListenersToTimeline();this.$el.find('.botmenu-timeline-rows-wrapper').append(this.timeline.render().$el);this.timeline.afterRender();},setModelToEditor:function(model){_log('render timeline');this.model=model;if(this.editorItemModel.get('isBinding')){if(!this.isSelected){return;}}
this.timeline.afterRender();this.timelineEditor.destroy();if(model instanceof ComponentModel){_log('ComponentModel',model);this.timelineEditor=this.timelineComponentEditorView;this.timelineEditor.setModel(model);this.$el.find('.botmenu-timeline-editor-wrapper').html(this.timelineEditor.render().$el);this.timelineEditor.afterRender();return;}
if(model instanceof PageModel){_log('PageModel',model);this.timelineEditor=this.timelineStageEditorView;this.timelineEditor.on('change-timeline',this.changeTimeline,this);this.timelineEditor.setModel(model.get('options'));this.$el.find('.botmenu-timeline-editor-wrapper').html(this.timelineEditor.render().$el);this.timelineEditor.afterRender();return;}
if(model instanceof ComponentCollection){_log('ComponentCollection',model);this.timelineEditor=this.timelineComponentsCollectionEditorView;this.timelineEditor.setCollection(model);this.$el.find('.botmenu-timeline-editor-wrapper').html(this.timelineEditor.render().$el);this.timelineEditor.afterRender();return;}
if(model instanceof TimelineRowModel){_log('TimelineRowModel',model);if(model.cid!=model.collection.last().cid){this.timelineEditor=this.timelineRowEditorView;this.timelineEditor.setCollection(model.get('objects'));this.timelineEditor.setRowModel(model.get('options'));this.$el.find('.botmenu-timeline-editor-wrapper').html(this.timelineEditor.render().$el);this.timelineEditor.afterRender();}
return;}},changeTimeline:function(){this.timeline.remove();if(this.timelineType=='layers'){this.timelineType='classic';this.timeline=new ClassicTimelineView();}else if(this.timelineType=='classic'){this.timelineType='layers';this.timeline=new LayersTimelineView();}
this.timeline.setModel(this.model);this.addListenersToTimeline();this.$el.find('.botmenu-timeline-rows-wrapper').html(this.timeline.render().$el);this.timeline.afterRender();},setStageModelToEditor:function(pModel){this.timeline.setModel(pModel);this.timeline.render();this.timeline.afterRender();this.timeline.selectRow(pModel.get('lines').first());},addListenersToTimeline:function(){var _that=this;this.timeline.off('data-picker-picked');this.timeline.on('data-picker-picked',function(cModel){_that.trigger('data-picker-picked',cModel);});this.timeline.on('update-stage',function(){_that.renderZIndex();});this.timeline.on('select-component',function(cModel,e){_log('select-component',cModel,_log.error);if(!cModel.get('locked')){StageView.instance.selectOneComponent(cModel,e);}});this.timeline.on('select-row',function(rowModel){_that.onRowSelected(rowModel);});this.timeline.on('update-sort-in-one-line',function(model,position,line,lineFromRemove){_that.saveTimeline('update-sort-in-one-line',model,position,line,lineFromRemove);});this.timeline.on('update-sort-in-two-line',function(model,position,line,lineFromRemove){_that.saveTimeline('update-sort-in-two-line',model,position,line,lineFromRemove);});this.timeline.on('update-sort-add-new-line',function(model,position,line){_that.saveTimeline('update-sort-add-new-line',model,position,line);});this.timeline.on('update-sort-sort-rows',function(model,position,line){_that.saveTimeline('update-sort-sort-rows',model,position,line);});this.timeline.on('unselect-model',function(model){StageView.instance.stageSelector.reset();});},changeTimeline:function(){this.timeline.remove();if(this.timelineType=='layers'){this.timelineType='classic';this.timeline=new ClassicTimelineView();}else if(this.timelineType=='classic'){this.timelineType='layers';this.timeline=new LayersTimelineView();}
this.timeline.collection=this.model.get('lines');this.timeline.model=this.model;this.addListenersToTimeline();this.$el.find('.botmenu-timeline-rows-wrapper').html(this.timeline.render().$el);this.timeline.afterRender();},onRowSelected:function(rowModel){var _that=this;StageView.instance.stageSelector.reset();rowModel.get('objects').each(function(componentModel){StageView.instance.selectMultiComponentsSilent(componentModel);});this.trigger('on-row-selected',rowModel,this);},saveTimeline:function(action,componentModel,position,line,lineFromRemove){var _that=this;DataAccess.updateTimeline({page:_that.model,action:"UpdateTimeline",component:componentModel,position:position,line:line,lineFromRemove:lineFromRemove,action:action},function(data){_log('Update timeline result: ',data,_log.dataaccessOutResult)},function(data){_log('Update timeline fault: ',data,_log.dataaccessOutFault)});},});;;var PropertiesEditorItemView=EditorItemView.extend({className:'properties-editor-item-view',template:_.template($('#editor-item-view-template').html()),initialize:function(){var _that=this;this.model=StageView.instance.model;this.editor=function(){};this.editor.destroy=function(){};this.editor.setModel=function(){};this.styleEditor=function(){};this.styleEditor.destroy=function(){};this.styleEditor.setModel=function(){};this.stageEditorView=EditorsFactory.createStageEditor();this.deafultEditorView=new EditorView();},afterRender:function(){},setModelToEditor:function(model){_log('set model to proprties',model);this.model=model;this.checkIfDisableEditor(model);if(this.editorItemModel.get('isBinding')){if(!this.isSelected){return;}}
_log('render proprties',model);if(model instanceof ComponentModel){this.editor.destroy();var type=model.get('type');switch(type){case'text':case'quiz-result':this.editor=EditorsFactory.createTextEditor();break;case'timer':this.editor=EditorsFactory.createTimerEditor();break;case'image':this.editor=EditorsFactory.createImageEditor();break;case'video':this.editor=EditorsFactory.createVideoEditor();break;case'quiz':this.editor=EditorsFactory.createQuizEditor();break;case'quiz-selectone':this.editor=EditorsFactory.createQuizSelectOneEditor();break;case'quiz-dnd':this.editor=EditorsFactory.createQuizDnDEditor(this.stageView);break;case'quiz-connectlines':this.editor=EditorsFactory.createQuizConnectLinesEditor(this.stageView);break;case'quiz-wordsearch':this.editor=EditorsFactory.createQuizWordsearchEditor(this.stageView);break;case'scroller':this.editor=EditorsFactory.createScrollerEditor();break;case'crossword':this.editor=EditorsFactory.createCrosswordEditor();break;case'form-inputtext':this.editor=EditorsFactory.createFormInputTextEditor();break;case'form-upload':this.editor=EditorsFactory.createFormUploadEditor();break;case'form-textarea':this.editor=EditorsFactory.createFormTextareaEditor();break;case'form-select':this.editor=EditorsFactory.createFormSelectEditor();break;case'form-checkbox':this.editor=EditorsFactory.createFormCheckboxEditor();break;case'form-radio':this.editor=EditorsFactory.createFormRadioEditor();break;case'form-submit':this.editor=EditorsFactory.createFormSubmitEditor(this.stageView);break;case'iframe':this.editor=EditorsFactory.createIframeEditor();this.styleEditor=StyleEditorsFactory.createIframeEditor();break;case'swf':this.editor=EditorsFactory.createSwfEditor();break;case'drawedinfopoint-link':this.editor=EditorsFactory.createDrawedInfoPointLinkEditor();break;case'drawedinfopoint-download':this.editor=EditorsFactory.createDrawedInfoPointDownloadEditor();break;case'drawedinfopoint-gallery':this.editor=EditorsFactory.createDrawedInfoPointGalleryEditor();break;case'drawedinfopoint-popup':this.editor=EditorsFactory.createDrawedInfoPointPopupEditor();break;case'infopoint-popup':this.editor=EditorsFactory.createInfoPointPopupEditor();break;case'infopoint-link':this.editor=EditorsFactory.createInfoPointLinkEditor();break;case'infopoint-sound':this.editor=EditorsFactory.createInfoPointSoundEditor();break;case'infopoint-soundrecord':this.editor=EditorsFactory.createInfoPointSoundRecordEditor();break;case'infopoint-gallery':this.editor=EditorsFactory.createInfoPointGalleryEditor();break;case'infopoint-download':this.editor=EditorsFactory.createInfoPointDownloadEditor();break;case'quiz-inputtext':this.editor=EditorsFactory.createQuizInputTextEditor();break;case'quiz-select':this.editor=EditorsFactory.createQuizSelectEditor();break;case'infopoint-sound-control':this.editor=EditorsFactory.createInfoPointSoundControlEditor();break;case'quiz-fillinblanks':this.editor=EditorsFactory.createQuizFillInBlanksEditor();break;default:this.editor=this.deafultEditorView;console.log("No editor");break;}
this.editor.setModel(model);this.$el.html(this.editor.render().$el);this.editor.afterRender();return;}
if(model instanceof PageModel){var options=this.model.get('options');this.editor.destroy();this.editor=this.stageEditorView;this.editor.setModel(options);this.$el.html(this.editor.render().$el);this.editor.afterRender();return;}
if(model instanceof ComponentCollection){this.editor.destroy();this.editor=this.deafultEditorView;this.$el.html(this.editor.render().$el);this.editor.afterRender();this.goToTimelineTab();return;}
if(model instanceof TimelineRowModel){this.editor.destroy();this.editor=this.deafultEditorView;this.$el.html(this.editor.render().$el);this.editor.afterRender();return;}},setStageModelToEditor:function(pModel){},checkIfDisableEditor:function(model){this.enableEditor();if(model instanceof ComponentCollection){this.disableEditor();return;}
if(model instanceof TimelineRowModel){this.disableEditor();return;}},});;;var StylesEditorItemView=EditorItemView.extend({className:'styles-editor-item-view',template:_.template($('#editor-item-view-template').html()),initialize:function(){var _that=this;this.model=StageView.instance.model;this.styleEditor=function(){};this.styleEditor.destroy=function(){};this.styleEditor.setModel=function(){};StylesFactory.createAllStyles();this.stageStyleEditor=StyleEditorsFactory.createStageEditor();this.deafultStyleEditor=new StyleEditorView();},afterRender:function(){},setModelToEditor:function(model){_log('render styles 1',model);this.model=model;this.checkIfDisableEditor(model);if(this.editorItemModel.get('isBinding')){if(!this.isSelected){return;}}
_log('render styles 2',this.model);if(model instanceof ComponentModel){this.styleEditor.destroy();var type=model.get('type');switch(type){case'text':case'quiz-result':this.styleEditor=StyleEditorsFactory.createTextEditor();break;case'timer':this.styleEditor=StyleEditorsFactory.createTimerEditor();break;case'image':this.styleEditor=StyleEditorsFactory.createImageEditor();break;case'video':this.styleEditor=StyleEditorsFactory.createVideoEditor();this.disableEditor();break;case'quiz':this.styleEditor=StyleEditorsFactory.createQuizEditor();break;case'quiz-selectone':this.styleEditor=StyleEditorsFactory.createQuizSelectOneEditor();break;case'quiz-dnd':this.styleEditor=StyleEditorsFactory.createQuizDnDEditor(this.stageView);break;case'quiz-connectlines':this.styleEditor=StyleEditorsFactory.createQuizConnectLinesEditor(this.stageView);break;case'quiz-wordsearch':this.styleEditor=StyleEditorsFactory.createQuizWordsearchEditor(this.stageView);break;case'scroller':this.styleEditor=StyleEditorsFactory.createScrollerEditor();break;case'crossword':this.styleEditor=StyleEditorsFactory.createCrosswordEditor();break;case'form-inputtext':this.styleEditor=StyleEditorsFactory.createFormInputTextEditor();break;case'form-upload':this.styleEditor=StyleEditorsFactory.createFormUploadEditor();break;case'form-textarea':this.styleEditor=StyleEditorsFactory.createFormTextareaEditor();break;case'form-select':this.styleEditor=StyleEditorsFactory.createFormSelectEditor();break;case'form-checkbox':this.styleEditor=StyleEditorsFactory.createFormCheckboxEditor();break;case'form-radio':this.styleEditor=StyleEditorsFactory.createFormRadioEditor();break;case'form-submit':this.styleEditor=StyleEditorsFactory.createFormSubmitEditor(this.stageView);break;case'iframe':this.styleEditor=StyleEditorsFactory.createIframeEditor();break;case'swf':this.styleEditor=StyleEditorsFactory.createSwfEditor();break;case'drawedinfopoint-link':this.styleEditor=StyleEditorsFactory.createDrawedInfoPointLinkEditor();break;case'drawedinfopoint-download':this.styleEditor=StyleEditorsFactory.createDrawedInfoPointDownloadEditor();break;case'drawedinfopoint-gallery':this.styleEditor=StyleEditorsFactory.createDrawedInfoPointGalleryEditor();break;case'drawedinfopoint-popup':this.styleEditor=StyleEditorsFactory.createDrawedInfoPointPopupEditor();break;case'infopoint-popup':this.styleEditor=StyleEditorsFactory.createInfoPointPopupEditor();break;case'infopoint-link':this.styleEditor=StyleEditorsFactory.createInfoPointLinkEditor();break;case'infopoint-sound':this.styleEditor=StyleEditorsFactory.createInfoPointSoundEditor();break;case'infopoint-soundrecord':this.styleEditor=StyleEditorsFactory.createInfoPointSoundRecordEditor();break;case'infopoint-gallery':this.styleEditor=StyleEditorsFactory.createInfoPointGalleryEditor();break;case'infopoint-download':this.styleEditor=StyleEditorsFactory.createInfoPointDownloadEditor();break;case'quiz-inputtext':this.styleEditor=StyleEditorsFactory.createQuizInputTextEditor();break;case'quiz-select':this.styleEditor=StyleEditorsFactory.createQuizSelectEditor();break;case'infopoint-sound-control':this.styleEditor=StyleEditorsFactory.createInfoPointSoundControlEditor();break;case'quiz-fillinblanks':this.styleEditor=StyleEditorsFactory.createQuizFillInBlanksEditor();break;default:this.styleEditor=this.deafultStyleEditor;console.log("No editor");break;}
this.styleEditor.setModel(model);this.$el.html(this.styleEditor.render().$el);this.styleEditor.afterRender();return;}
if(model instanceof PageModel){var options=this.model.get('options');this.styleEditor.destroy();this.styleEditor=this.stageStyleEditor;this.styleEditor.setModel(options);this.$el.html(this.styleEditor.render().$el);this.styleEditor.afterRender();return;}
if(model instanceof ComponentCollection){this.styleEditor.destroy();this.styleEditor=this.deafultStyleEditor;this.$el.html(this.styleEditor.render().$el);this.styleEditor.afterRender();this.goToTimelineTab();this.disableEditor();return;}
if(model instanceof TimelineRowModel){this.styleEditor.destroy();this.styleEditor=this.deafultStyleEditor;this.$el.html(this.styleEditor.render().$el);this.styleEditor.afterRender();return;}},setStageModelToEditor:function(pModel){},checkIfDisableEditor:function(model){this.enableEditor();if(model instanceof ComponentModel){var type=model.get('type');switch(type){case'video':case'scroller':case'crossword':case'quiz-wordsearch':this.disableEditor();break;}}
if(model instanceof ComponentCollection){this.disableEditor();}
if(model instanceof TimelineRowModel){this.disableEditor();}},});;;var ReaportsEditorItemView=EditorItemView.extend({className:'reaports-editor-item-view',template:_.template($('#editor-item-view-template').html()),initialize:function(){var _that=this;this.model=StageView.instance.model;this.reportEditor=function(){};this.reportEditor.destroy=function(){};this.reportEditor.setModel=function(){};this.reportEditorView=EditorsFactory.createReportEditor();this.multipleReportEditorView=EditorsFactory.createMultipleReportEditor();this.deafultReportEditorView=new EditorView();},afterRender:function(){},setModelToEditor:function(model){this.model=model;this.checkIfDisableEditor(model);if(this.editorItemModel.get('isBinding')){if(!this.isSelected){return;}}
if(model instanceof ComponentModel){var type=model.get('type');this.reportEditor.destroy();switch(type){case'quiz':this.reportEditor=this.reportEditorView;break;case'quiz-selectone':this.reportEditor=this.reportEditorView;break;case'quiz-fillinblinds':this.reportEditor=this.reportEditorView;break;case'quiz-dnd':this.reportEditor=this.reportEditorView;break;case'quiz-connectlines':this.reportEditor=this.reportEditorView;break;case'quiz-wordsearch':this.reportEditor=this.reportEditorView;break;case'crossword':this.reportEditor=this.reportEditorView;break;case'form-inputtext':this.reportEditor=this.reportEditorView;break;case'form-textarea':this.reportEditor=this.reportEditorView;break;case'form-select':this.reportEditor=this.reportEditorView;break;case'form-checkbox':this.reportEditor=this.reportEditorView;break;case'form-radio':this.reportEditor=this.reportEditorView;break;case'quiz-inputtext':this.reportEditor=this.reportEditorView;break;case'quiz-select':this.reportEditor=this.reportEditorView;break;case'quiz-fillinblanks':this.reportEditor=this.reportEditorView;break;default:this.reportEditor=this.deafultReportEditorView;console.log("No editor");break;}
this.reportEditor.setModel(model);this.$el.html(this.reportEditor.render().$el);this.reportEditor.afterRender();return;}
if(model instanceof PageModel){this.reportEditor=this.deafultReportEditorView;this.reportEditor.setModel(model);this.$el.html(this.reportEditor.render().$el);this.reportEditor.afterRender();return;}
if(model instanceof ComponentCollection){this.reportEditor=this.deafultReportEditorView;this.reportEditor.setModel(model);this.$el.html(this.reportEditor.render().$el);this.reportEditor.afterRender();this.goToTimelineTab();return;}
if(model instanceof TimelineRowModel){this.reportEditor=this.deafultReportEditorView;this.reportEditor.setModel(model);this.$el.html(this.reportEditor.render().$el);this.reportEditor.afterRender();return;}},setStageModelToEditor:function(pModel){},checkIfDisableEditor:function(model){this.enableEditor();if(model instanceof ComponentModel){var type=model.get('type');switch(type){case'quiz':case'quiz-selectone':case'quiz-fillinblinds':case'quiz-dnd':case'quiz-connectlines':case'quiz-wordsearch':case'crossword':case'form-inputtext':case'form-textarea':case'form-select':case'form-checkbox':case'form-radio':case'quiz-inputtext':case'quiz-select':case'quiz-fillinblanks':break;default:this.disableEditor();break;}
return;}
if(model instanceof PageModel){this.disableEditor();return;}
if(model instanceof ComponentCollection){this.disableEditor();return;}
if(model instanceof TimelineRowModel){this.disableEditor();return;}},});;;var SoundsEditorItemView=EditorItemView.extend({className:'sounds-editor-item-view',template:_.template($('#editor-item-view-template').html()),initialize:function(){var _that=this;this.model=StageView.instance.model;this.soundEditor=function(){};this.soundEditor.destroy=function(){};this.soundEditor.setModel=function(){};this.soundEditorView=EditorsFactory.createSoundEditor();this.multipleSoundEditorView=EditorsFactory.createMultipleSoundEditor();},afterRender:function(){},setModelToEditor:function(model){this.model=model;this.checkIfDisableEditor(model);if(this.editorItemModel.get('isBinding')){if(!this.isSelected){return;}}
if(model instanceof ComponentModel){this.soundEditor.destroy();this.soundEditor=this.soundEditorView;this.soundEditor.setModel(this.model);this.$el.html(this.soundEditor.render().$el);this.soundEditor.afterRender();return;}
if(model instanceof PageModel){var options=this.model.get('options');this.soundEditor.destroy();this.soundEditor=this.soundEditorView;this.soundEditor.setModel(options);this.$el.html(this.soundEditor.render().$el);this.soundEditor.afterRender();return;}
if(model instanceof ComponentCollection){this.soundEditor.destroy();this.soundEditor=this.multipleSoundEditorView;this.$el.html(this.soundEditor.render().$el);this.soundEditor.afterRender();this.goToTimelineTab();return;}
if(model instanceof TimelineRowModel){this.soundEditor.destroy();this.soundEditor=this.multipleSoundEditorView;this.$el.html(this.soundEditor.render().$el);this.soundEditor.afterRender();return;}},setStageModelToEditor:function(pModel){},checkIfDisableEditor:function(model){this.enableEditor();if(model instanceof ComponentCollection){this.disableEditor();return;}
if(model instanceof TimelineRowModel){this.disableEditor();return;}},});;;var WcagEditorItemView=EditorItemView.extend({className:'wcag-editor-item-view',template:_.template($('#editor-item-view-template').html()),initialize:function(){var _that=this;this.model=StageView.instance.model;this.wcagEditor=function(){};this.wcagEditor.destroy=function(){};this.wcagEditor.setModel=function(){};this.wcagEditorView=EditorsFactory.createWcagEditor();this.deafultEditorView=new EditorView();},afterRender:function(){},setModelToEditor:function(model){this.model=model;this.checkIfDisableEditor(model);if(this.editorItemModel.get('isBinding')){if(!this.isSelected){return;}}
if(model instanceof ComponentModel){this.wcagEditor.destroy();this.wcagEditor=this.wcagEditorView;this.wcagEditor.setModel(this.model);this.$el.html(this.wcagEditor.render().$el);this.wcagEditor.afterRender();return;}
if(model instanceof PageModel){var options=this.model.get('options');this.wcagEditor.destroy();this.wcagEditor=this.deafultEditorView;this.$el.html(this.wcagEditor.render().$el);this.wcagEditor.afterRender();return;}
if(model instanceof ComponentCollection){this.wcagEditor.destroy();this.wcagEditor=this.deafultEditorView;this.$el.html(this.wcagEditor.render().$el);this.wcagEditor.afterRender();this.goToTimelineTab();return;}
if(model instanceof TimelineRowModel){this.wcagEditor.destroy();this.wcagEditor=this.deafultEditorView;this.$el.html(this.wcagEditor.render().$el);this.wcagEditor.afterRender();return;}},setStageModelToEditor:function(pModel){},checkIfDisableEditor:function(model){this.enableEditor();if(model instanceof PageModel){this.disableEditor();return;}
if(model instanceof ComponentCollection){this.disableEditor();return;}
if(model instanceof TimelineRowModel){this.disableEditor();return;}},});;;var NoteEditorItemView=EditorItemView.extend({className:'note-editor-item-view',template:_.template($('#editor-item-view-template').html()),events:{},initialize:function(){var _that=this;this.model=StageView.instance.model;this.noteEditor=function(){};this.noteEditor.destroy=function(){};this.noteEditor.setModel=function(){};this.pagenoteEditorView=EditorsFactory.createPagenoteEditor();this.deafultEditorView=new EditorView();},afterRender:function(){},setModelToEditor:function(model){this.model=model;this.checkIfDisableEditor(model);if(!this.isSelected){return;}
if(model instanceof ComponentModel){this.noteEditor.destroy();this.noteEditor=this.deafultEditorView;this.$el.html(this.noteEditor.render().$el);this.noteEditor.afterRender();return;}
if(model instanceof PageModel){var options=this.model.get('options');this.noteEditor.destroy();this.noteEditor=this.pagenoteEditorView;this.noteEditor.setModel(options);this.$el.html(this.noteEditor.render().$el);this.noteEditor.afterRender();return;}
if(model instanceof ComponentCollection){this.noteEditor.destroy();this.noteEditor=this.deafultEditorView;this.$el.html(this.noteEditor.render().$el);this.noteEditor.afterRender();this.goToTimelineTab();return;}
if(model instanceof TimelineRowModel){this.noteEditor.destroy();this.noteEditor=this.deafultEditorView;this.$el.html(this.noteEditor.render().$el);this.noteEditor.afterRender();return;}},setStageModelToEditor:function(pModel){},checkIfDisableEditor:function(model){this.enableEditor();if(model instanceof ComponentModel){this.disableEditor();return;}
if(model instanceof ComponentCollection){this.disableEditor();return;}
if(model instanceof TimelineRowModel){this.disableEditor();return;}},});;;var ParallaxEditorItemView=EditorItemView.extend({className:'parallax-editor-item-view',template:_.template($('#editor-item-view-template').html()),initialize:function(){var _that=this;this.model=StageView.instance.model;this.parallaxEditor=function(){};this.parallaxEditor.destroy=function(){};this.parallaxEditor.setModel=function(){};this.parallaxeEditorView=EditorsFactory.createParallaxeEditor();this.deafultEditorView=new EditorView();},afterRender:function(){},setModelToEditor:function(model){this.model=model;this.checkIfDisableEditor(model);if(this.editorItemModel.get('isBinding')){if(!this.isSelected){return;}}
if(model instanceof ComponentModel){this.parallaxEditor.destroy();this.parallaxEditor=this.parallaxeEditorView;this.parallaxEditor.setModel(model);this.$el.html(this.parallaxEditor.render().$el);this.parallaxEditor.afterRender();return;}
if(model instanceof PageModel){var options=this.model.get('options');this.parallaxEditor.destroy();this.parallaxEditor=this.deafultEditorView;this.$el.html(this.parallaxEditor.render().$el);this.parallaxEditor.afterRender();return;}
if(model instanceof ComponentCollection){this.parallaxEditor.destroy();this.parallaxEditor=this.deafultEditorView;this.$el.html(this.parallaxEditor.render().$el);this.parallaxEditor.afterRender();this.goToTimelineTab();return;}
if(model instanceof TimelineRowModel){this.parallaxEditor.destroy();this.parallaxEditor=this.deafultEditorView;this.$el.html(this.parallaxEditor.render().$el);this.parallaxEditor.afterRender();return;}},setStageModelToEditor:function(pModel){},checkIfDisableEditor:function(model){this.enableEditor();if(model instanceof PageModel){this.disableEditor();return;}
if(model instanceof ComponentCollection){this.disableEditor();return;}
if(model instanceof TimelineRowModel){this.disableEditor();return;}},});;;var ScoreEditorItemView=EditorItemView.extend({className:'score-editor-item-view',template:_.template($('#editor-item-view-template').html()),initialize:function(){var _that=this;this.model=StageView.instance.model;this.scoreEditor=function(){};this.scoreEditor.destroy=function(){};this.scoreEditor.setModel=function(){};this.scoreExerciseEditor=function(){};this.scoreExerciseEditor.destroy=function(){};this.scoreExerciseEditor.setModel=function(){};this.scoreEditorView=EditorsFactory.createScoreEditor();this.scoreExerciseEditorView=EditorsFactory.createScoreExerciseEditor();this.deafultEditorView=new EditorView();},afterRender:function(){},setModelToEditor:function(model){this.model=model;this.checkIfDisableEditor(model);if(this.editorItemModel.get('isBinding')){if(!this.isSelected){return;}}
this.scoreExerciseEditor.destroy();this.scoreEditor.destroy();this.$el.html('');if(model instanceof ComponentModel){var options=StageView.instance.model.get('options');this.scoreExerciseEditor=this.scoreExerciseEditorView;this.scoreExerciseEditor.setModel(this.model);this.$el.append(this.scoreExerciseEditor.render().$el);this.scoreExerciseEditor.afterRender();this.scoreEditor=this.scoreEditorView;this.scoreEditor.setModel(options);this.$el.append(this.scoreEditor.render().$el);this.scoreEditor.afterRender();return;}
if(model instanceof PageModel){var options=this.model.get('options');this.scoreEditor=this.scoreEditorView;this.scoreEditor.setModel(options);this.$el.append(this.scoreEditor.render().$el);this.scoreEditor.afterRender();return;}
if(model instanceof ComponentCollection){var options=StageView.instance.model.get('options');this.scoreEditor=this.scoreEditorView;this.scoreEditor.setModel(options);this.$el.append(this.scoreEditor.render().$el);this.scoreEditor.afterRender();this.goToTimelineTab();return;}
if(model instanceof TimelineRowModel){var options=StageView.instance.model.get('options');this.scoreEditor=this.scoreEditorView;this.scoreEditor.setModel(options);this.$el.append(this.scoreEditor.render().$el);this.scoreEditor.afterRender();}},setStageModelToEditor:function(pModel){},checkIfDisableEditor:function(model){this.enableEditor();if(model instanceof ComponentCollection){this.disableEditor();return;}
if(model instanceof TimelineRowModel){this.disableEditor();return;}},});;;var SizeAndPositionEditorItemView=EditorItemView.extend({tagName:'div',className:'size-and-position-editor-item-view',template:_.template($('#editor-item-view-template').html()),events:{},initialize:function(){var _that=this;this.model=StageView.instance.model;this.sizeAndPositionEditor=function(){};this.sizeAndPositionEditor.destroy=function(){};this.sizeAndPositionEditor.setModel=function(){};this.sizeAndPositionEditor.setCollection=function(){};this.sizeAndPositionEditorView=EditorsFactory.createSizeAndPositionEditorView();this.multipleSizeAndPositionEditorView=EditorsFactory.createMultipleSizeAndPositionEditor();this.deafultEditorView=new EditorView();},afterRender:function(){},setModelToEditor:function(model){this.model=model;if(model instanceof ComponentModel){this.sizeAndPositionEditor.destroy();this.sizeAndPositionEditor=this.sizeAndPositionEditorView;this.sizeAndPositionEditor.setModel(this.model);this.$el.html(this.sizeAndPositionEditor.render().$el);this.sizeAndPositionEditor.afterRender();return;}
if(model instanceof PageModel){var options=this.model.get('options');this.sizeAndPositionEditor.destroy();this.sizeAndPositionEditor=this.sizeAndPositionEditorView;this.sizeAndPositionEditor.setModel(options);this.$el.html(this.sizeAndPositionEditor.render().$el);this.sizeAndPositionEditor.afterRender();return;}
if(model instanceof ComponentCollection){this.sizeAndPositionEditor.destroy();this.sizeAndPositionEditor=this.multipleSizeAndPositionEditorView;this.sizeAndPositionEditor.setCollection(this.model);this.$el.html(this.sizeAndPositionEditor.render().$el);this.sizeAndPositionEditor.afterRender();return;}
if(model instanceof TimelineRowModel){this.sizeAndPositionEditor.destroy();this.sizeAndPositionEditor=this.multipleSizeAndPositionEditorView;this.sizeAndPositionEditor.setCollection(this.model.get('objects'));this.$el.html(this.sizeAndPositionEditor.render().$el);this.sizeAndPositionEditor.afterRender();return;}},setStageModelToEditor:function(pModel){}});;;var AlignEditorItemView=EditorItemView.extend({tagName:'div',className:'align-editor-item-view',template:_.template($('#editor-item-view-template').html()),events:{},initialize:function(){var _that=this;this.model=StageView.instance.model;this.alignEditor=function(){};this.alignEditor.destroy=function(){};this.alignEditor.setCollection=function(){};this.alignEditor.deactivate=function(){};this.alignEditorView=EditorsFactory.createAlignEditorView();this.deafultEditorView=new EditorView();this.alignEditor=this.alignEditorView;},afterRender:function(){this.$el.html(this.alignEditor.render().$el);this.alignEditor.afterRender();},setModelToEditor:function(model){this.model=model;var options=this.model.get('options');if(options){this.alignEditor.deactivate();return;}else{var type=model.get('type');if(type){this.alignEditor.deactivate();return;}else{this.alignEditor.setCollection(this.model);this.alignEditor.render();this.alignEditor.afterRender();}}},setStageModelToEditor:function(pModel){}});;;var OpenEditorsList=Backbone.View.extend({tagName:'ul',className:'open-editors-list',template:_.template($('#open-editors-list-template').html()),events:{},initialize:function(){this.collection=new EditorsNavigationCollection();this.constanceEditorsViews=[];},render:function(){var template=this.template(this.serializeData());this.$el.html(template);return this;},serializeData:function(){return{};},afterRender:function(){this.createEditors();},createEditors:function(){var _that=this;this.collection.each(function(eModel){_that.createEditorView(eModel);});this.createConstanceEditors();},createEditorConatinerWindow:function(model){var editorContainerWindow=WindowFactory.createEditorConatinerWindow({editorModel:model});editorContainerWindow.on('on-close',this.onEditorWindowClose,this);var type=model.get('type').toUpperCase();var title=Lang.get('editor.MENU_'+type);$('body').append(editorContainerWindow.render({title:title}).$el);return editorContainerWindow;},createEditorView:function(editorItemModel){var container=this.$el;switch(editorItemModel.get('type')){case'timeline':var editorItemView=new TimelineEditorItemView();editorItemView.editorItemModel=editorItemModel;editorItemView.on('on-row-selected',this.onRowSelected,this);editorItemView.on('data-picker-picked',this.dataPickerPicked,this);editorItemView.on('go-to-tab',this.goToTab,this);editorItemView.hide();editorItemModel.view=editorItemView;container.append(editorItemView.render().$el);editorItemView.afterRender();break;case'properties':var editorItemView=new PropertiesEditorItemView();editorItemView.editorItemModel=editorItemModel;editorItemView.on('go-to-tab',this.goToTab,this);editorItemView.hide();editorItemModel.view=editorItemView;container.append(editorItemView.render().$el);editorItemView.afterRender();break;case'styles':var editorItemView=new StylesEditorItemView();editorItemView.editorItemModel=editorItemModel;editorItemView.on('go-to-tab',this.goToTab,this);editorItemView.hide();editorItemModel.view=editorItemView;container.append(editorItemView.render().$el);editorItemView.afterRender();break;case'reaports':var editorItemView=new ReaportsEditorItemView();editorItemView.editorItemModel=editorItemModel;editorItemView.on('go-to-tab',this.goToTab,this);editorItemView.hide();editorItemModel.view=editorItemView;container.append(editorItemView.render().$el);editorItemView.afterRender();break;case'sounds':var editorItemView=new SoundsEditorItemView();editorItemView.editorItemModel=editorItemModel;editorItemView.on('go-to-tab',this.goToTab,this);editorItemView.hide();editorItemModel.view=editorItemView;container.append(editorItemView.render().$el);editorItemView.afterRender();break;case'wcag':var editorItemView=new WcagEditorItemView();editorItemView.editorItemModel=editorItemModel;editorItemView.on('go-to-tab',this.goToTab,this);editorItemView.hide();editorItemModel.view=editorItemView;container.append(editorItemView.render().$el);editorItemView.afterRender();break;case'note':var editorItemView=new NoteEditorItemView();editorItemView.editorItemModel=editorItemModel;editorItemView.on('go-to-tab',this.goToTab,this);editorItemView.hide();editorItemModel.view=editorItemView;container.append(editorItemView.render().$el);editorItemView.afterRender();break;case'parallax':var editorItemView=new ParallaxEditorItemView();editorItemView.editorItemModel=editorItemModel;editorItemView.on('go-to-tab',this.goToTab,this);editorItemView.hide();editorItemModel.view=editorItemView;container.append(editorItemView.render().$el);editorItemView.afterRender();break;case'score':var editorItemView=new ScoreEditorItemView();editorItemView.editorItemModel=editorItemModel;editorItemView.on('go-to-tab',this.goToTab,this);editorItemView.hide();editorItemModel.view=editorItemView;container.append(editorItemView.render().$el);editorItemView.afterRender();break;default:var editorItemView=new EditorItemView({model:pageModel});editorItemView.editorItemModel=editorItemModel;editorItemView.on('go-to-tab',this.goToTab,this);editorItemView.hide();editorItemModel.view=editorItemView;container.append(editorItemView.render().$el);editorItemView.afterRender();break;}},goToTab:function(params){this.trigger('go-to-tab',params);},dataPickerPicked:function(model){this.trigger('data-picker-picked',model);},selectEditor:function(editorItemModel){this.collection.each(function(pm){pm.view.hide();});editorItemModel.view.show();},createConstanceEditors:function(){var editorItemView=new SizeAndPositionEditorItemView();$('#size-and-position-container').html(editorItemView.render().$el);editorItemView.afterRender();this.constanceEditorsViews.push(editorItemView);var editorItemView=new AlignEditorItemView();$('#align-container').html(editorItemView.render().$el);editorItemView.afterRender();this.constanceEditorsViews.push(editorItemView);},closeEditor:function(editorItemModel){var index=this.collection.indexOf(editorItemModel);this.collection.remove(editorItemModel);editorItemModel.view.remove();var nexteditorItemModel=this.collection.at(index-1)||this.collection.first();this.selectEditor(nexteditorItemModel);},setModel:function(pageModel){this.model=pageModel;this.collection.each(function(model){model.view.setModel(pageModel);});},setModelToOpenEditors:function(model){this.collection.each(function(eModel){eModel.view.setModelToEditor(model);});for(var i=0;i<this.constanceEditorsViews.length;i++){var view=this.constanceEditorsViews[i];view.setModelToEditor(model);};},setStageModel:function(pModel){this.collection.each(function(eModel){eModel.view.setStageModelToEditor(pModel);});},onRowSelected:function(rowModel){this.setModelToOpenEditors(rowModel);},unbindEditor:function(editorItemModel){_log('unbindEditor',editorItemModel);editorItemModel.set('isBinding',false);_log('this.collection',this.collection);var editorContainerWindow=this.createEditorConatinerWindow(editorItemModel);editorContainerWindow.appendEditor(editorItemModel);},onEditorWindowClose:function(sender,editorItemModel){_log('onEditorWindowClose',editorItemModel);editorItemModel.view.remove();editorItemModel.set('isBinding',true);this.$el.append(editorItemModel.view.render().$el);editorItemModel.view.afterRender();this.selectEditor(editorItemModel);editorItemModel.view.setStageModelToEditor(StageView.instance.model);editorItemModel.view.setModelToEditor(editorItemModel.view.model);this.trigger('on-editor-window-close');},});;;var EditorsController=Backbone.View.extend({className:'editors-controller',template:_.template($('#editors-controller-template').html()),events:{},visible:true,initialize:function(){},render:function(){var _that=this;var template=this.template(this.serializeData());this.$el.html(template);this.$el.resizable({handles:'n',resize:function(event,ui){_that.onResize();}});return this;},afterRender:function(){this.editorsNavigation=new EditorsNavigation();this.openEditorsList=new OpenEditorsList();this.openEditorsList.on('data-picker-picked',this.dataPickerPicked,this);this.openEditorsList.on('go-to-tab',this.goToTab,this);this.openEditorsList.on('on-editor-window-close',this.onEditorWindowClose,this);this.$el.find('.open-editors-list-wrapper').append(this.openEditorsList.render().$el);this.openEditorsList.collection=this.editorsNavigation.collection;this.openEditorsList.afterRender();this.$el.find('.editors-navigation-wrapper').append(this.editorsNavigation.render().$el);this.editorsNavigation.on('on-editor-selected',this.onEditorSelected,this);this.editorsNavigation.on('on-editor-closed',this.onEditorClosed,this);this.editorsNavigation.on('toogle',this.toggleEditors,this);this.editorsNavigation.on('unbind-editor',this.unbindEditor,this);this.editorsNavigation.afterRender();if($(document).width()<=1366){this.hideMenu();}},onEditorWindowClose:function(){this.editorsNavigation.renderIsBindingList();},unbindEditor:function(model){this.openEditorsList.unbindEditor(model);},goToTab:function(params){this.editorsNavigation.goToTab(params);},dataPickerPicked:function(model){this.trigger('data-picker-picked',model);},toggleEditors:function(view){var _that=this;tiggleIcon=view.$el;_log('tiggleIcon',tiggleIcon);_log('this.$el',this.$el);this.hideMenu()||this.showMenu();},serializeData:function(){return{};},onEditorSelected:function(editorItemModel){_log('onEditorSelected',editorItemModel);this.openEditorsList.selectEditor(editorItemModel,this.model);if(!this.visible){this.showMenu();}},onEditorClosed:function(editorItemModel){_log('onEditorClosed',editorItemModel);this.openEditorsList.closeEditor(editorItemModel);},setModel:function(pageModel){this.model=pageModel;this.openEditorsList.setModel(pageModel);},setModelToOpenEditors:function(model){this.openEditorsList.setModelToOpenEditors(model);},setStageModel:function(pModel){this.openEditorsList.setStageModel(pModel);},changeTabEditor:function(params){this.editorsNavigation.changeTabEditor(params);},onResize:function(){var _that=this;this.$el.css('top','auto');this.changeToggleButonArrow();this.trigger('on-resize',this);},hideMenu:function(onComplete){var _that=this;if(!this.visible)return false;this.visible=false;var _that=this;this.$el.animate({height:'40px'},300,function(){if(_.isFunction(onComplete)){onComplete();}
_that.onResize();});return true;},showMenu:function(){var _that=this;if(this.visible)return false;this.visible=true;var _that=this;this.$el.animate({height:'210px'},300,function(){_that.onResize();});return true;},changeToggleButonArrow:function(onComplete){var menuHeight=this.$el.height();this.toggleButton=this.toggleButton||this.$el.find('.toggle-button-editor-item-view');if(menuHeight>45){this.toggleButton.html('&#9660;');this.visible=true;}else{this.toggleButton.html('&#9650;');this.visible=false;}}});;;var ColorPickerView=Backbone.View.extend({tagName:'div',className:'color-picker-view',colorTemplate:_.template($('#color-picker-template').html()),events:function(){},initialize:function(data){var _that=this;this.color=data.color;},updateColorPicker:function(data){this.color=data.color;this.render();},render:function(){return this.renderColorPicker();},renderColorPicker:function(){var _that=this;var template=this.colorTemplate();this.$el.html(template);this.$el.css('background-color',this.color);this.$el.spectrum({showAlpha:true,color:_that.color,showInput:true,move:function(color){_that.$el.css('background-color',color.toRgbString());_that.trigger('move',{color:color.toRgbString()});},change:function(color){_that.$el.css('background-color',color.toRgbString());_that.trigger('move',{color:color.toRgbString()});_that.trigger('change',{color:color.toRgbString()});},hide:function(color){_that.$el.css('background-color',color.toRgbString());_that.trigger('hide',{color:color.toRgbString()});}});return this;}});;;var GradientPickerView=ColorPickerView.extend({tagName:'div',className:'color-picker-view',pickerType:'color',colorTemplate:_.template($('#color-picker-2-template').html()),gradientTemplate:_.template($('#gradient-picker-template').html()),events:{'click .change-picker-type':'changePickerType'},changePickerType:function(e){this.pickerType=$(e.target).attr('picker-type');switch(this.pickerType){case'color':this.renderGradientPicker();this.afterRender();break;case'gradient':this.renderColorPicker();break;}},renderGradientPicker:function(){var _that=this;var template=this.gradientTemplate();this.$el.html(template);return this;},afterRender:function(){var _that=this;var gradient_colors=new Array(),color_to_pass=new Array(),gradient_angle;var element_gradient=this.color;var rgbaRegex=/(rgba?\([^\)]+\)|[a-z\d]*|[a-z]*)/g;gradient_colors=jQuery.grep(element_gradient.match(rgbaRegex),function(s){return jQuery.trim(s)!=''});if(gradient_colors.length>1){for(i=0;i<gradient_colors.length;++i){if(gradient_colors[i].substr(0,3)=='rgb'||gradient_colors[i].substr(0,4)=='rgba'){var gradient_style=gradient_colors[i]+' '+gradient_colors[i+1]+'%';color_to_pass.push(gradient_style);}
if(gradient_colors[i].substr(gradient_colors[i].length-3)=='deg'){gradient_angle=gradient_colors[i];}}}
if(!gradient_angle){gradient_angle='180deg';}
_log('this.color',this.color);_log('color_to_pass',color_to_pass);if(color_to_pass.push()==0){var colorRgb=this.color;if(this.color=="#FFF"){colorRgb='rgb(255, 255, 255)';}
color_to_pass=[colorRgb+" 0%",colorRgb+" 100%"];}
_log('color_to_pass',color_to_pass);var gradientContainer=this.$el.find('.gradient-container');gradientContainer.gradientPicker({fillDirection:gradient_angle,controlPoints:color_to_pass,change:function(points,styles){_that.trigger('gradient-change',{color:styles[0]});}});},renderColorPicker:function(){var _that=this;var template=this.colorTemplate();this.$el.html(template);var pikcerContainer=this.$el.find('.picker-container');pikcerContainer.css('background-color',this.color);pikcerContainer.spectrum({showAlpha:true,color:_that.color,showInput:true,move:function(color){_that.trigger('move',{color:color.toRgbString()});},change:function(color){_that.trigger('move',{color:color.toRgbString()});_that.trigger('change',{color:color.toRgbString()});},hide:function(color){_that.trigger('hide',{color:color.toRgbString()});}});return this;},render:function(){var colorType=this.color.indexOf('linear-gradient')!==-1?'gradient':'solid';switch(colorType){case'solid':return this.renderColorPicker();break;case'gradient':return this.renderGradientPicker();break;default:return this.renderColorPicker();break;}},});;;function StylesFactory(){}
StylesFactory.createAllStyles=function(){this.allStyles={};StylesFactory.createImageStyles();StylesFactory.createSimpletextStyles();StylesFactory.createQuestionsStyles();StylesFactory.createDndStyles();StylesFactory.createInputTextStyles();}
StylesFactory.getImageStyles=function(){return this.allStyles['image'];}
StylesFactory.getSimpletextStyles=function(){return this.allStyles['text'];}
StylesFactory.getQuestionsStyles=function(){return this.allStyles['questions'];}
StylesFactory.getShapeStyles=function(){return this.allStyles['shape'];}
StylesFactory.getDndStyles=function(){return this.allStyles['dnd'];}
StylesFactory.getInputTextStyles=function(){return this.allStyles['inputtext'];}
StylesFactory.getFormSubmitStyles=function(){return this.allStyles['form-submit'];}
StylesFactory.getQuizResultsStyles=function(){return this.allStyles['quiz-result'];}
StylesFactory.getGradientStyles=function(){return this.allStyles['gradient'];}
StylesFactory.createImageStyles=function(){var type='image';var defaultStyle='img-template';this.allStyles[type]=StylesFactory.createStyle(stylesImage,defaultStyle,type);}
StylesFactory.createStyle=function(styles,defaultStyle,type){var container=$('<div>',{class:'style-container'});_.each(styles,function(style,index){var div=$('<div>',{class:defaultStyle+' style-template',st:index,type:type});div.css(style['component-inner']);container.append(div);});return container;}
StylesFactory.createStyleText=function(styles,defaultStyle,type){var container=$('<div>',{class:'style-container'});_.each(styles,function(style,index){var div=$('<div>',{class:defaultStyle+' style-template',st:index,type:type});div.css(style['component-styles']);var htmlText='A B C';div.html(htmlText);container.append(div);});return container;}
StylesFactory.createStyleDnd=function(styles,defaultStyle,type){var container=$('<div>',{class:'style-container'});_.each(styles,function(style,index){var div=$('<div>',{class:defaultStyle+' style-template',st:index,type:type});div.css(style['component-inner']);var htmlText='A B C';div.html(htmlText);container.append(div);});return container;}
StylesFactory.createStyleInputText=function(styles,defaultStyle,type){var container=$('<div>',{class:'style-container'});_.each(styles,function(style,index){var div=$('<div>',{class:defaultStyle+' style-template',st:index,type:type});div.css(style['quizinputtext-input']);var htmlText='A B C';div.html(htmlText);container.append(div);});return container;}
StylesFactory.createStyleGradient=function(styles,defaultStyle,type){var container=$('<div>',{class:'style-container'});_.each(styles,function(style,index){var div=$('<div>',{class:defaultStyle+' style-template',st:index,type:type});div.css(style['component-gradient']);container.append(div);});return container;}
StylesFactory.createQuestionStyle=function(styles,defaultStyle,type){var container=$('<div>',{class:'style-container'});_.each(styles,function(style,index){var div=$('<div>',{class:defaultStyle+' style-template',style:"position:relative",st:index,type:type});var quizBody=$('<div>',{class:'quiz-body',style:'width:100%;height:100%;'});quizBody.css(style['quiz-body']);div.append(quizBody);var quizSubmitButton=$('<div>',{class:'quiz-submit-button',style:'position:absolute;right:10px;bottom:10px;width:60px;height:15px;text-align:center;',text:'ok'});quizSubmitButton.css(style['quiz-submit-button']);quizBody.append(quizSubmitButton);var answer1=$('<div>',{class:'quiz-answer-template',style:'top:15px',text:'lorem...'});quizBody.append(answer1);var answer2=$('<div>',{class:'quiz-answer-template',style:'top:35px;',text:'ipsum...'});quizBody.append(answer2);container.append(div);});return container;}
StylesFactory.createSimpletextStyles=function(){var type='text';var defaultStyle='simpletext-sfs';this.allStyles[type]=StylesFactory.createStyleText(stylesText,defaultStyle,type);this.allStyles['gradient']=StylesFactory.createStyleGradient(stylesGradient,defaultStyle,'gradient');}
StylesFactory.createQuestionsStyles=function(){var type='questions';var defaultStyle='qmulti-template';this.allStyles[type]=StylesFactory.createQuestionStyle(stylesQuestion,defaultStyle,type);}
StylesFactory.createShapeStyles=function(){var type='shape';var prefix='shape-template';var defaultStyle='shape-template';var styles=['image','first','second','third','fourth','fifth','sixth','seventh','eighth','ninth','tenth','eleventh','twelfth','threeteenth','fourteenth','fifteenth','sixteenth','seventeenth','eightennth','nineteenth','pastel1','pastel2','pastel3','pastel4','pastel5','pastel6','pastel7','pastel8','pastel9','pastel10','plastic1','plastic2','plastic3','plastic4'];StylesFactory.createStyle(type,styles,prefix,defaultStyle);}
StylesFactory.createQuizResultsStyles=function(){var type='quiz-results';var prefix='quiz-template';var defaultStyle='quiz-template';var styles=['defaut','first'];StylesFactory.createStyle(type,styles,prefix,defaultStyle);}
StylesFactory.createDndStyles=function(){var type='dnd';var defaultStyle='button-template';this.allStyles[type]=StylesFactory.createStyleDnd(stylesDnd,defaultStyle,type);}
StylesFactory.createInputTextStyles=function(){var type='inputtext';var defaultStyle='button-template';this.allStyles[type]=StylesFactory.createStyleInputText(stylesInputText,defaultStyle,type);}
StylesFactory.createFormSubmitStyles=function(){var type='form-submit';var prefix='form-submit';var defaultStyle='form-submit';var styles=['default','first','second','euroforum','euroforum2','euroforum3'];StylesFactory.createStyle(type,styles,prefix,defaultStyle);}
StylesFactory.createQuestionStyleBlocks=function(type,templateStylesArray,prefix,defaultStyle){var container=$('<div>',{class:'style-container'});for(var i=0;i<templateStylesArray.length;i++){var templateStyle=prefix+'-'+templateStylesArray[i];var div=$('<div>',{class:templateStyle+' '+defaultStyle+' style-template',style:"position:relative"});var quizBody=$('<div>',{class:'quiz-body',style:'width:100%;height:100%;'});div.append(quizBody);var quizSubmitButton=$('<div>',{class:'quiz-submit-button',style:'position:absolute;right:10px;bottom:10px;width:60px;height:15px;text-align:center;',text:'ok'});quizBody.append(quizSubmitButton);var answer1=$('<div>',{class:'quiz-answer-template',style:'top:15px',text:'lorem...'});quizBody.append(answer1);var answer2=$('<div>',{class:'quiz-answer-template',style:'top:35px;',text:'ipsum...'});quizBody.append(answer2);div.attr('templatestyle',templateStyle);container.append(div);};this.allStyles[type]=container;}
StylesFactory.createStyleOld=function(type,templateStylesArray,prefix,defaultStyle,htmlText){var container=$('<div>',{class:'style-container'});for(var i=0;i<templateStylesArray.length;i++){var templateStyle=prefix+'-'+templateStylesArray[i];var div=$('<div>',{class:templateStyle+' '+defaultStyle+' style-template'});var htmlText=htmlText==undefined?'':htmlText;div.html(htmlText);div.attr('templatestyle',templateStyle);container.append(div);};this.allStyles[type]=container;};;function ComponentFactory(){}
ComponentFactory.createComponentByType=function(type,model){switch(type){case'text':return ComponentFactory.createTextComponent(model);break;case'image':return ComponentFactory.createImageComponent(model);break;case'video':return ComponentFactory.createVideoComponent(model);break;case'quiz':return ComponentFactory.createQuizComponent(model);break;case'quiz-radio':return ComponentFactory.createQuizRadioComponent(model);break;case'quiz-truefalse':return ComponentFactory.createQuizTruefalseComponent(model);break;case'quiz-selectone':return ComponentFactory.createQuizSelectOneComponent(model);break;case'quiz-fillinblanks':return ComponentFactory.createQuizFillInBlanksComponent(model);break;case'quiz-dnd':return ComponentFactory.createQuizDnDComponent(model);break;case'quiz-connectlines':return ComponentFactory.createQuizConnectLinesComponent(model);break;case'quiz-wordsearch':return ComponentFactory.createQuizWordsearchComponent(model);break;case'scroller':return ComponentFactory.createScrollerComponent(model);break;case'crossword':return ComponentFactory.createCrosswordComponent(model);break;case'form-inputtext':return ComponentFactory.createFormInputTextComponent(model);break;case'form-textarea':return ComponentFactory.createFormTextareaComponent(model);break;case'form-select':return ComponentFactory.createFormSelectComponent(model);break;case'form-checkbox':return ComponentFactory.createFormCheckboxComponent(model);break;case'form-radio':return ComponentFactory.createFormRadioComponent(model);break;case'form-submit':return ComponentFactory.createFormSubmitComponent(model);break;case'form-upload':return ComponentFactory.createFormUplaodComponent(model);break;case'iframe':return ComponentFactory.createIframeComponent(model);break;case'swf':return ComponentFactory.createSwfComponent(model);break;case'drawedinfopoint-link':return ComponentFactory.createDrawedInfoPointLinkComponent(model);break;case'drawedinfopoint-download':return ComponentFactory.createDrawedInfoPointDownloadComponent(model);break;case'drawedinfopoint-gallery':return ComponentFactory.createDrawedInfoPointGalleryComponent(model);break;case'drawedinfopoint-popup':return ComponentFactory.createDrawedInfoPointPopupComponent(model);break;case'infopoint-popup':return ComponentFactory.createInfoPointPopupComponent(model);break;case'infopoint-link':return ComponentFactory.createInfoPointLinkComponent(model);break;case'infopoint-sound':return ComponentFactory.createInfoPointSoundComponent(model);break;case'infopoint-sound-control':return ComponentFactory.createInfoPointSoundControlComponent(model);break;case'infopoint-soundrecord':return ComponentFactory.createInfoPointSoundRecordComponent(model);break;case'infopoint-gallery':return ComponentFactory.createInfoPointGalleryComponent(model);break;case'infopoint-download':return ComponentFactory.createInfoPointDownloadComponent(model);break;case'timer':return ComponentFactory.createTimerComponent(model);break;case'quiz-result':return ComponentFactory.createQuizResultComponent(model);break;case'quiz-inputtext':return ComponentFactory.createQuizInputTextComponent(model);break;case'quiz-select':return ComponentFactory.createQuizSelectComponent(model);break;default:console.log("No component: "+type);break;}}
ComponentFactory.updateOptionsModel=function(model,options){for(var item in options){model.set(item,options[item],{silent:true});}}
ComponentFactory.createComponentModelByType=function(type,options){var opts=options||{};switch(type){case'text':var model=new TextModel();this.updateOptionsModel(model,opts);return model;break;case'image':var model=new ImageModel();this.updateOptionsModel(model,opts);return model;break;case'video':var model=new VideoModel();this.updateOptionsModel(model,opts);return model;break;case'quiz':var model=new QuizModel();this.updateOptionsModel(model,opts);return model;break;case'quiz-radio':var model=new QuizRadioModel();this.updateOptionsModel(model,opts);return model;break;case'quiz-truefalse':var model=new QuizTrueFalseModel();this.updateOptionsModel(model,opts);return model;break;case'quiz-selectone':var model=new QuizSelectOneModel();this.updateOptionsModel(model,opts);return model;break;case'quiz-fillinblanks':var model=new QuizFillInBlanksModel();this.updateOptionsModel(model,opts);return model;break;case'quiz-dnd':var model=new QuizDnDModel();this.updateOptionsModel(model,opts);return model;break;case'quiz-connectlines':var model=new QuizConnectLinesModel();this.updateOptionsModel(model,opts);return model;break;case'quiz-wordsearch':var model=new QuizWordsearchModel();this.updateOptionsModel(model,opts);return model;break;case'scroller':var model=new ScrollerModel();this.updateOptionsModel(model,opts);return model;break;case'crossword':var model=new CrosswordModel();this.updateOptionsModel(model,opts);return model;break;case'form-inputtext':var model=new FormInputTextModel();this.updateOptionsModel(model,opts);return model;break;case'form-textarea':var model=new FormTextareaModel();this.updateOptionsModel(model,opts);return model;break;case'form-select':var model=new FormSelectModel();this.updateOptionsModel(model,opts);return model;break;case'form-checkbox':var model=new FormCheckboxModel();this.updateOptionsModel(model,opts);return model;break;case'form-radio':var model=new FormRadioModel();this.updateOptionsModel(model,opts);return model;break;case'form-submit':var model=new FormSubmitModel();this.updateOptionsModel(model,opts);return model;break;case'form-upload':var model=new FormUploadModel();this.updateOptionsModel(model,opts);return model;break;case'iframe':var model=new IframeModel();this.updateOptionsModel(model,opts);return model;break;case'swf':var model=new SwfModel();this.updateOptionsModel(model,opts);return model;break;case'drawedinfopoint-link':var model=new DrawedInfoPointLinkModel();this.updateOptionsModel(model,opts);return model;break;case'drawedinfopoint-download':var model=new DrawedInfoPointDownloadModel();this.updateOptionsModel(model,opts);return model;break;case'drawedinfopoint-gallery':var model=new DrawedInfoPointGalleryModel();this.updateOptionsModel(model,opts);return model;break;case'drawedinfopoint-popup':var model=new DrawedInfoPointPopupModel();this.updateOptionsModel(model,opts);return model;break;case'infopoint-popup':var model=new InfoPointPopupModel();this.updateOptionsModel(model,opts);return model;break;case'infopoint-link':var model=new InfoPointLinkModel();this.updateOptionsModel(model,opts);return model;break;case'infopoint-sound':var model=new InfoPointSoundModel();this.updateOptionsModel(model,opts);return model;break;case'infopoint-sound-control':var model=new InfoPointSoundControlModel();this.updateOptionsModel(model,opts);return model;break;case'infopoint-soundrecord':var model=new InfoPointSoundRecordModel();this.updateOptionsModel(model,opts);return model;break;case'infopoint-gallery':var model=new InfoPointGalleryModel();this.updateOptionsModel(model,opts);return model;break;case'infopoint-download':var model=new InfoPointDownloadModel();this.updateOptionsModel(model,opts);return model;break;case'timer':var model=new TimerModel();this.updateOptionsModel(model,opts);return model;break;case'quiz-result':var model=new QuizResultModel();this.updateOptionsModel(model,opts);return model;break;case'quiz-inputtext':var model=new QuizInputTextModel();this.updateOptionsModel(model,opts);return model;break;case'quiz-select':var model=new QuizSelectModel();this.updateOptionsModel(model,opts);return model;break;default:console.log("No type: "+type);break;}}
ComponentFactory.createQuizSelectComponent=function(model){model=model||new QuizSelectModel();var componentView=new QuizSelectComponentView({model:model});return componentView;}
ComponentFactory.createQuizInputTextComponent=function(model){model=model||new QuizInputTextModel();var componentView=new QuizInputTextComponentView({model:model});return componentView;}
ComponentFactory.createFormInputTextComponent=function(model){model=model||new FormInputTextModel();var componentView=new FormInputTextComponentView({model:model});return componentView;}
ComponentFactory.createFormTextareaComponent=function(model){model=model||new FormTextareaModel();var componentView=new FormTextareaComponentView({model:model});return componentView;}
ComponentFactory.createFormSelectComponent=function(model){model=model||new FormSelectModel();var componentView=new FormSelectComponentView({model:model});return componentView;}
ComponentFactory.createFormSubmitComponent=function(model){model=model||new FormSubmitModel();var componentView=new FormSubmitComponentView({model:model});return componentView;}
ComponentFactory.createFormUplaodComponent=function(model){model=model||new FormUploadModel();var componentView=new FormUploadComponentView({model:model});return componentView;}
ComponentFactory.createFormCheckboxComponent=function(model){model=model||new FormCheckboxModel();var componentView=new FormCheckboxComponentView({model:model});return componentView;}
ComponentFactory.createFormRadioComponent=function(model){model=model||new FormRadioModel();var componentView=new FormRadioComponentView({model:model});return componentView;}
ComponentFactory.createIframeComponent=function(model){model=model||new IframeModel();var componentView=new IframeComponentView({model:model});return componentView;}
ComponentFactory.createSwfComponent=function(model){model=model||new SwfModel();var componentView=new SwfComponentView({model:model});return componentView;}
ComponentFactory.createDrawedInfoPointLinkComponent=function(model){model=model||new DrawedInfoPointLinkModel();var componentView=new DrawedInfoPointLinkComponentView({model:model});return componentView;}
ComponentFactory.createDrawedInfoPointDownloadComponent=function(model){model=model||new DrawedInfoPointDownloadModel();var componentView=new DrawedInfoPointDownloadComponentView({model:model});return componentView;}
ComponentFactory.createDrawedInfoPointGalleryComponent=function(model){model=model||new DrawedInfoPointGalleryModel();var componentView=new DrawedInfoPointGalleryComponentView({model:model});return componentView;}
ComponentFactory.createDrawedInfoPointPopupComponent=function(model){model=model||new DrawedInfoPointPopupModel();var componentView=new DrawedInfoPointPopupComponentView({model:model});return componentView;}
ComponentFactory.createInfoPointPopupComponent=function(model){model=model||new InfoPointPopupModel();var componentView=new InfoPointPopupComponentView({model:model});return componentView;}
ComponentFactory.createInfoPointLinkComponent=function(model){model=model||new InfoPointLinkModel();var componentView=new InfoPointLinkComponentView({model:model});return componentView;}
ComponentFactory.createInfoPointSoundComponent=function(model){model=model||new InfoPointSoundModel();var componentView=new InfoPointSoundComponentView({model:model});return componentView;}
ComponentFactory.createInfoPointSoundControlComponent=function(model){model=model||new InfoPointSoundControlModel();var componentView=new InfoPointSoundControlComponentView({model:model});return componentView;}
ComponentFactory.createInfoPointSoundRecordComponent=function(model){model=model||new InfoPointSoundRecordModel();var componentView=new InfoPointSoundRecordComponentView({model:model});return componentView;}
ComponentFactory.createInfoPointGalleryComponent=function(model){model=model||new InfoPointGalleryModel();var componentView=new InfoPointGalleryComponentView({model:model});return componentView;}
ComponentFactory.createInfoPointDownloadComponent=function(model){model=model||new InfoPointDownloadModel();var componentView=new InfoPointDownloadComponentView({model:model});return componentView;}
ComponentFactory.createComponentByModel=function(model){var type=model.get('type');return ComponentFactory.createComponentByType(type,model);}
ComponentFactory.createTextComponent=function(model){model=model||new TextModel();var componentView=new TextComponentView({model:model});return componentView;}
ComponentFactory.createImageComponent=function(model){model=model||new ImageModel();var componentView=new ImageComponentView({model:model});return componentView;}
ComponentFactory.createVideoComponent=function(model){model=model||new VideoModel();var componentView=new VideoComponentView({model:model});return componentView;}
ComponentFactory.createQuizComponent=function(model){model=model||new QuizModel();var componentView=new QuizComponentView({model:model});return componentView;}
ComponentFactory.createQuizRadioComponent=function(model){model=model||new QuizRadioModel();var componentView=new QuizComponentView({model:model});return componentView;}
ComponentFactory.createQuizTruefalseComponent=function(model){model=model||new QuizTrueFalseModel();var componentView=new QuizComponentView({model:model});return componentView;}
ComponentFactory.createQuizSelectOneComponent=function(model){model=model||new QuizSelectOneModel();var componentView=new QuizSelectOneComponentView({model:model});return componentView;}
ComponentFactory.createQuizFillInBlanksComponent=function(model){model=model||new QuizFillInBlanksModel();var componentView=new QuizFillInBlanksComponentView({model:model});return componentView;}
ComponentFactory.createQuizDnDComponent=function(model){model=model||new QuizDnDModel();var componentView=new QuizDnDComponentView({model:model});return componentView;}
ComponentFactory.createQuizConnectLinesComponent=function(model){model=model||new QuizConnectLinesModel();var componentView=new QuizConnectLinesComponentView({model:model});return componentView;}
ComponentFactory.createQuizWordsearchComponent=function(model){model=model||new QuizWordsearchModel();var componentView=new QuizWordsearchComponentView({model:model});return componentView;}
ComponentFactory.createScrollerComponent=function(model){model=model||new ScrollerModel();var componentView=new ScrollerComponentView({model:model});return componentView;}
ComponentFactory.createCrosswordComponent=function(model){model=model||new CrosswordModel();var componentView=new CrosswordComponentView({model:model});return componentView;}
ComponentFactory.createTimerComponent=function(model){model=model||new TimerModel();var componentView=new TimerComponentView({model:model});return componentView;}
ComponentFactory.createQuizResultComponent=function(model){model=model||new QuizResultModel();var componentView=new QuizResultComponentView({model:model});return componentView;};;function ComponentFactoryNotEditable(){}
ComponentFactoryNotEditable.createComponentByType=function(type,model){switch(type){case'text':return ComponentFactoryNotEditable.createTextComponent(model);break;case'image':return ComponentFactoryNotEditable.createImageComponent(model);break;case'video':return ComponentFactoryNotEditable.createVideoComponent(model);break;case'quiz':return ComponentFactoryNotEditable.createQuizComponent(model);break;case'quiz-radio':return ComponentFactoryNotEditable.createQuizRadioComponent(model);break;case'quiz-truefalse':return ComponentFactoryNotEditable.createQuizTruefalseComponent(model);break;case'quiz-selectone':return ComponentFactoryNotEditable.createQuizSelectOneComponent(model);break;case'quiz-fillinblanks':return ComponentFactoryNotEditable.createQuizFillInBlanksComponent(model);break;case'quiz-dnd':return ComponentFactoryNotEditable.createQuizDnDComponent(model);break;case'quiz-connectlines':return ComponentFactoryNotEditable.createQuizConnectLinesComponent(model);break;case'quiz-wordsearch':return ComponentFactoryNotEditable.createQuizWordsearchComponent(model);break;case'scroller':return ComponentFactoryNotEditable.createScrollerComponent(model);break;case'crossword':return ComponentFactoryNotEditable.createCrosswordComponent(model);break;case'form-inputtext':return ComponentFactoryNotEditable.createFormInputTextComponent(model);break;case'form-textarea':return ComponentFactoryNotEditable.createFormTextareaComponent(model);break;case'form-select':return ComponentFactoryNotEditable.createFormSelectComponent(model);break;case'form-checkbox':return ComponentFactoryNotEditable.createFormCheckboxComponent(model);break;case'form-radio':return ComponentFactoryNotEditable.createFormRadioComponent(model);break;case'form-submit':return ComponentFactoryNotEditable.createFormSubmitComponent(model);break;case'form-upload':return ComponentFactoryNotEditable.createFormUplaodComponent(model);break;case'iframe':return ComponentFactoryNotEditable.createIframeComponent(model);break;case'swf':return ComponentFactoryNotEditable.createSwfComponent(model);break;case'drawedinfopoint-link':return ComponentFactoryNotEditable.createDrawedInfoPointLinkComponent(model);break;case'drawedinfopoint-download':return ComponentFactoryNotEditable.createDrawedInfoPointDownloadComponent(model);break;case'drawedinfopoint-gallery':return ComponentFactoryNotEditable.createDrawedInfoPointGalleryComponent(model);break;case'drawedinfopoint-popup':return ComponentFactoryNotEditable.createDrawedInfoPointPopupComponent(model);break;case'infopoint-popup':return ComponentFactoryNotEditable.createInfoPointPopupComponent(model);break;case'infopoint-link':return ComponentFactoryNotEditable.createInfoPointLinkComponent(model);break;case'infopoint-sound':return ComponentFactoryNotEditable.createInfoPointSoundComponent(model);break;case'infopoint-soundrecord':return ComponentFactoryNotEditable.createInfoPointSoundRecordComponent(model);break;case'infopoint-sound-control':return ComponentFactoryNotEditable.createInfoPointSoundControlComponent(model);break;case'infopoint-gallery':return ComponentFactoryNotEditable.createInfoPointGalleryComponent(model);break;case'infopoint-download':return ComponentFactoryNotEditable.createInfoPointDownloadComponent(model);break;case'timer':return ComponentFactoryNotEditable.createTimerComponent(model);break;case'quiz-result':return ComponentFactoryNotEditable.createQuizResultComponent(model);break;case'quiz-inputtext':return ComponentFactoryNotEditable.createQuizInputTextComponent(model);break;case'quiz-select':return ComponentFactoryNotEditable.createQuizSelectComponent(model);break;default:console.log("No component: "+type);break;}}
ComponentFactoryNotEditable.updateOptionsModel=function(model,options){for(var item in options){model.set(item,options[item],{silent:true});}}
ComponentFactoryNotEditable.createComponentModelByType=function(type,options){var opts=options||{};switch(type){case'text':var model=new TextModel();this.updateOptionsModel(model,opts);return model;break;case'image':var model=new ImageModel();this.updateOptionsModel(model,opts);return model;break;case'video':var model=new VideoModel();this.updateOptionsModel(model,opts);return model;break;case'quiz':var model=new QuizModel();this.updateOptionsModel(model,opts);return model;break;case'quiz-radio':var model=new QuizRadioModel();this.updateOptionsModel(model,opts);return model;break;case'quiz-truefalse':var model=new QuizTrueFalseModel();this.updateOptionsModel(model,opts);return model;break;case'quiz-selectone':var model=new QuizSelectOneModel();this.updateOptionsModel(model,opts);return model;break;case'quiz-fillinblanks':var model=new QuizFillInBlanksModel();this.updateOptionsModel(model,opts);return model;break;case'quiz-dnd':var model=new QuizDnDModel();this.updateOptionsModel(model,opts);return model;break;case'quiz-connectlines':var model=new QuizConnectLinesModel();this.updateOptionsModel(model,opts);return model;break;case'quiz-wordsearch':var model=new QuizWordsearchModel();this.updateOptionsModel(model,opts);return model;break;case'scroller':var model=new ScrollerModel();this.updateOptionsModel(model,opts);return model;break;case'crossword':var model=new CrosswordModel();this.updateOptionsModel(model,opts);return model;break;case'form-inputtext':var model=new FormInputTextModel();this.updateOptionsModel(model,opts);return model;break;case'form-textarea':var model=new FormTextareaModel();this.updateOptionsModel(model,opts);return model;break;case'form-select':var model=new FormSelectModel();this.updateOptionsModel(model,opts);return model;break;case'form-checkbox':var model=new FormCheckboxModel();this.updateOptionsModel(model,opts);return model;break;case'form-radio':var model=new FormRadioModel();this.updateOptionsModel(model,opts);return model;break;case'form-submit':var model=new FormSubmitModel();this.updateOptionsModel(model,opts);return model;break;case'form-upload':var model=new FormUploadModel();this.updateOptionsModel(model,opts);return model;break;case'iframe':var model=new IframeModel();this.updateOptionsModel(model,opts);return model;break;case'swf':var model=new SwfModel();this.updateOptionsModel(model,opts);return model;break;case'drawedinfopoint-link':var model=new DrawedInfoPointLinkModel();this.updateOptionsModel(model,opts);return model;break;case'drawedinfopoint-download':var model=new DrawedInfoPointDownloadModel();this.updateOptionsModel(model,opts);return model;break;case'drawedinfopoint-gallery':var model=new DrawedInfoPointGalleryModel();this.updateOptionsModel(model,opts);return model;break;case'drawedinfopoint-popup':var model=new DrawedInfoPointPopupModel();this.updateOptionsModel(model,opts);return model;break;case'infopoint-popup':var model=new InfoPointPopupModel();this.updateOptionsModel(model,opts);return model;break;case'infopoint-link':var model=new InfoPointLinkModel();this.updateOptionsModel(model,opts);return model;break;case'infopoint-sound':var model=new InfoPointSoundModel();this.updateOptionsModel(model,opts);return model;break;case'infopoint-sound-control':var model=new InfoPointSoundControlModel();this.updateOptionsModel(model,opts);return model;break;case'infopoint-soundrecord':var model=new InfoPointSoundRecordModel();this.updateOptionsModel(model,opts);return model;break;case'infopoint-gallery':var model=new InfoPointGalleryModel();this.updateOptionsModel(model,opts);return model;break;case'infopoint-download':var model=new InfoPointDownloadModel();this.updateOptionsModel(model,opts);return model;break;case'timer':var model=new TimerModel();this.updateOptionsModel(model,opts);return model;break;case'quiz-result':var model=new QuizResultModel();this.updateOptionsModel(model,opts);return model;break;case'quiz-inputtext':var model=new QuizInputTextModel();this.updateOptionsModel(model,opts);return model;break;case'quiz-select':var model=new QuizSelectModel();this.updateOptionsModel(model,opts);return model;break;default:console.log("No type: "+type);break;}}
ComponentFactoryNotEditable.createQuizSelectComponent=function(model){model=model||new QuizSelectModel();var componentView=new QuizSelectComponentViewNotEditable({model:model});return componentView;}
ComponentFactoryNotEditable.createQuizInputTextComponent=function(model){model=model||new QuizInputTextModel();var componentView=new QuizInputTextComponentViewNotEditable({model:model});return componentView;}
ComponentFactoryNotEditable.createFormInputTextComponent=function(model){model=model||new FormInputTextModel();var componentView=new FormInputTextComponentViewNotEditable({model:model});return componentView;}
ComponentFactoryNotEditable.createFormTextareaComponent=function(model){model=model||new FormTextareaModel();var componentView=new FormTextareaComponentViewNotEditable({model:model});return componentView;}
ComponentFactoryNotEditable.createFormSelectComponent=function(model){model=model||new FormSelectModel();var componentView=new FormSelectComponentViewNotEditable({model:model});return componentView;}
ComponentFactoryNotEditable.createFormSubmitComponent=function(model){model=model||new FormSubmitModel();var componentView=new FormSubmitComponentViewNotEditable({model:model});return componentView;}
ComponentFactoryNotEditable.createFormUplaodComponent=function(model){model=model||new FormUploadModel();var componentView=new FormUploadComponentViewNotEditable({model:model});return componentView;}
ComponentFactoryNotEditable.createFormCheckboxComponent=function(model){model=model||new FormCheckboxModel();var componentView=new FormCheckboxComponentViewNotEditable({model:model});return componentView;}
ComponentFactoryNotEditable.createFormRadioComponent=function(model){model=model||new FormRadioModel();var componentView=new FormRadioComponentViewNotEditable({model:model});return componentView;}
ComponentFactoryNotEditable.createIframeComponent=function(model){model=model||new IframeModel();var componentView=new IframeComponentViewNotEditable({model:model});return componentView;}
ComponentFactoryNotEditable.createSwfComponent=function(model){model=model||new SwfModel();var componentView=new SwfComponentViewNotEditable({model:model});return componentView;}
ComponentFactoryNotEditable.createDrawedInfoPointLinkComponent=function(model){model=model||new DrawedInfoPointLinkModel();var componentView=new DrawedInfoPointLinkComponentViewNotEditable({model:model});return componentView;}
ComponentFactoryNotEditable.createDrawedInfoPointDownloadComponent=function(model){model=model||new DrawedInfoPointDownloadModel();var componentView=new DrawedInfoPointDownloadComponentViewNotEditable({model:model});return componentView;}
ComponentFactoryNotEditable.createDrawedInfoPointGalleryComponent=function(model){model=model||new DrawedInfoPointGalleryModel();var componentView=new DrawedInfoPointGalleryComponentViewNotEditable({model:model});return componentView;}
ComponentFactoryNotEditable.createDrawedInfoPointPopupComponent=function(model){model=model||new DrawedInfoPointPopupModel();var componentView=new DrawedInfoPointPopupComponentViewNotEditable({model:model});return componentView;}
ComponentFactoryNotEditable.createInfoPointPopupComponent=function(model){model=model||new InfoPointPopupModel();var componentView=new InfoPointPopupComponentViewNotEditable({model:model});return componentView;}
ComponentFactoryNotEditable.createInfoPointLinkComponent=function(model){model=model||new InfoPointLinkModel();var componentView=new InfoPointLinkComponentViewNotEditable({model:model});return componentView;}
ComponentFactoryNotEditable.createInfoPointSoundComponent=function(model){model=model||new InfoPointSoundModel();var componentView=new InfoPointSoundComponentViewNotEditable({model:model});return componentView;}
ComponentFactoryNotEditable.createInfoPointSoundControlComponent=function(model){model=model||new InfoPointSoundControlModel();var componentView=new InfoPointSoundControlComponentViewNotEditable({model:model});return componentView;}
ComponentFactoryNotEditable.createInfoPointSoundRecordComponent=function(model){model=model||new InfoPointSoundRecordModel();var componentView=new InfoPointSoundRecordComponentViewNotEditable({model:model});return componentView;}
ComponentFactoryNotEditable.createInfoPointGalleryComponent=function(model){model=model||new InfoPointGalleryModel();var componentView=new InfoPointGalleryComponentViewNotEditable({model:model});return componentView;}
ComponentFactoryNotEditable.createInfoPointDownloadComponent=function(model){model=model||new InfoPointDownloadModel();var componentView=new InfoPointDownloadComponentViewNotEditable({model:model});return componentView;}
ComponentFactoryNotEditable.createComponentByModel=function(model){var type=model.get('type');return ComponentFactoryNotEditable.createComponentByType(type,model);}
ComponentFactoryNotEditable.createTextComponent=function(model){model=model||new TextModel();var componentView=new TextComponentViewNotEditable({model:model});return componentView;}
ComponentFactoryNotEditable.createImageComponent=function(model){model=model||new ImageModel();var componentView=new ImageComponentViewNotEditable({model:model});return componentView;}
ComponentFactoryNotEditable.createVideoComponent=function(model){model=model||new VideoModel();var componentView=new VideoComponentViewNotEditable({model:model});return componentView;}
ComponentFactoryNotEditable.createQuizComponent=function(model){model=model||new QuizModel();var componentView=new QuizComponentViewNotEditable({model:model});return componentView;}
ComponentFactoryNotEditable.createQuizRadioComponent=function(model){model=model||new QuizRadioModel();var componentView=new QuizComponentViewNotEditable({model:model});return componentView;}
ComponentFactoryNotEditable.createQuizTruefalseComponent=function(model){model=model||new QuizTrueFalseModel();var componentView=new QuizComponentViewNotEditable({model:model});return componentView;}
ComponentFactoryNotEditable.createQuizSelectOneComponent=function(model){model=model||new QuizSelectOneModel();var componentView=new QuizSelectOneComponentViewNotEditable({model:model});return componentView;}
ComponentFactoryNotEditable.createQuizFillInBlanksComponent=function(model){model=model||new QuizFillInBlanksModel();var componentView=new QuizFillInBlanksComponentViewNotEditable({model:model});return componentView;}
ComponentFactoryNotEditable.createQuizDnDComponent=function(model){model=model||new QuizDnDModel();var componentView=new QuizDnDComponentViewNotEditable({model:model});return componentView;}
ComponentFactoryNotEditable.createQuizConnectLinesComponent=function(model){model=model||new QuizConnectLinesModel();var componentView=new QuizConnectLinesComponentViewNotEditable({model:model});return componentView;}
ComponentFactoryNotEditable.createQuizWordsearchComponent=function(model){model=model||new QuizWordsearchModel();var componentView=new QuizWordsearchComponentViewNotEditable({model:model});return componentView;}
ComponentFactoryNotEditable.createScrollerComponent=function(model){model=model||new ScrollerModel();var componentView=new ScrollerComponentViewNotEditable({model:model});return componentView;}
ComponentFactoryNotEditable.createCrosswordComponent=function(model){model=model||new CrosswordModel();var componentView=new CrosswordComponentViewNotEditable({model:model});return componentView;}
ComponentFactoryNotEditable.createTimerComponent=function(model){model=model||new TimerModel();var componentView=new TimerComponentViewNotEditable({model:model});return componentView;}
ComponentFactoryNotEditable.createQuizResultComponent=function(model){model=model||new QuizResultModel();var componentView=new QuizResultComponentViewNotEditable({model:model});return componentView;};;var TimelineItemCollection=Backbone.Collection.extend({model:ComponentModel,initialize:function(){this.bind("add",this.onAddNewComponent);},onAddNewComponent:function(addedModel){},});;;var TimelineRowOptionsModel=Backbone.Model.extend({defaults:{id:0,hidden:false,locked:false,delay:0}});var TimelineRowModel=Backbone.Model.extend({defaults:{objects:new TimelineItemCollection(),options:new TimelineRowOptionsModel(),type:'line',action:''},addExistingComponent:function(componentModel){this.get('objects').add(componentModel);},addNewComponent:function(componentModel){this.get('objects').add(componentModel,{at:0});},removeComponent:function(componentModel){this.get('objects').remove(componentModel);this.trigger('remove-coming',componentModel);},updateSortComing:function(model,position){this.trigger('update-sort-coming',model,position);},updateOptionComing:function(options){this.trigger('update-options-coming',options);},setActive:function(value){this.trigger('set-active',value,this);},selectedByMiniature:function(value){this.trigger('selected-by-miniature',value);},selectedByTrigger:function(value){this.trigger('selected-by-trigger',value);},selectedByPickerMiniature:function(value){this.trigger('selected-by-picker-miniature-1',value);},});;;var TimelineRowCollection=Backbone.Collection.extend({model:TimelineRowModel,getLineById:function(lineId){var foundLine=false;this.each(function(lineModel){if(lineModel.get('options').get('id')==lineId){foundLine=lineModel;}});return foundLine;}});;;var TimelineView=Backbone.View.extend({tagName:'div',className:'timeline-classic-rows-wrapper',template:_.template($('#timeline-template').html()),events:{'sort-rows-back':'sortRows','data-picker-picked-object1':'dataPickerPickedObject','data-picker-picked-line1':'dataPickerPickedLine'},dataPickerPickedObject:function(event,cModel){this.trigger('data-picker-picked',cModel);},dataPickerPickedLine:function(event,rowModel){this.trigger('data-picker-picked',rowModel);},initialize:function(){},updateTimeline:function(){this.render();this.afterRender();},onWindowResize:function(e){this.collection.each(function(rowModel){rowModel.view.onResize(e);});},sortRows:function(event,model,position){var _that=this;var rowId=model.get('options').get('id');DataAccess.sortRows({rowId:rowId,position:position,pageId:StageView.instance.model.getPageId()},function(data){_log('Sort rows result: ',data,_log.dataaccessOutResult);_that.onSortRowsResult(data);},function(data){_log('Sort rows fault: ',data,_log.dataaccessOutFault);});},onSortRowsResult:function(data){this.model.sortRows(data);this.render();this.afterRender();StageView.instance.renderZIndex();},updateRowOptionsResult:function(data){var rowModel=this.model.updateRowOptions(data);if(!rowModel){return;}
rowModel.view.render();rowModel.view.afterRender();},addListenersToRow:function(rowItemView){var _that=this;rowItemView.on('select-row',function(selectedRowModel){_that.selectRow(selectedRowModel);selectedRowModel.view.render();selectedRowModel.view.afterRender();_that.trigger('select-row',selectedRowModel,this);});rowItemView.on('select-component',function(selectedComponentModel,e){_that.trigger('select-component',selectedComponentModel,e);});rowItemView.on('unselect-model',function(componentModel,e){_that.trigger('unselect-model',componentModel,e);});rowItemView.on('move-components-to-layer',this.moveComponentsToLayer,this);rowItemView.on('render-timeline',function(){_log('render-timeline _that.model',_that.model);_that.render();_that.afterRender();});rowItemView.on('scroll-to-active-component',this.scrollToActiveComponent,this);},moveComponentsToLayer:function(rowId,position){var _that=this;_log('rowId',rowId);_log('position',position);var scc=StageView.instance.selectedComponentsCollection;_log('selectedComponentsCollection',scc);var actionkeys=_.pluck(scc.toJSON(),'actionkey');_log('actionkeys',actionkeys);DataAccess.moveComponentsToLayer({rowId:rowId,actionkeys:actionkeys,position:position,pageId:StageView.instance.model.getPageId()},function(data){_log('Move components to layer result: ',data,_log.dataaccessOutResult);_that.onMoveComponentsResult(data);},function(data){_log('Move components to layer fault: ',data,_log.dataaccessOutFault);});},onMoveComponentsResult:function(data){var _that=this;_log('onMoveComponentsResult this.model',this.model);var cc=this.model.moveComponentsToLayer(data);this.render();this.afterRender();this.scrollToActiveComponent(cc.first());StageView.instance.renderZIndex();},removeLayersByIds:function(deletedLayersIds){var _that=this;var emptyRowsToRemove=[];for(var i=0;i<deletedLayersIds.length;i++){var lineId=deletedLayersIds[i];var line=this.getRowModelByLineId(lineId);emptyRowsToRemove.push(line);};this.collection.remove(emptyRowsToRemove);},renderSingleRow:function(rowItem,i){},updateSortAddNewLine:function(data){var line=data.line;var lineFromRemove=data.lineFromRemove;var component=data.component;var componentModel=this.getComponentModelByActionkey(component.actionkey);var rowFromRemoveModel=this.getRowModelByComponentModel(componentModel);rowFromRemoveModel.get('objects').remove(componentModel);var rowModel=this.addNewLineComing(line);rowModel.get('objects').add(componentModel);this.render();},updateSortInTwoLineComing:function(data){var position=data.position;var line=data.line;var component=data.component;for(var j=0;j<component.length;j++){var comp=component[j];var componentModel=this.getComponentModelByActionkey(comp.actionkey);var rowModel=this.getRowModelByLineId(line);var rowFromRemoveModel=this.getRowModelByComponentModel(componentModel);rowFromRemoveModel.get('objects').remove(componentModel);if(rowModel!=undefined){rowModel.get('objects').add(componentModel,{at:position});}}
this.render();this.afterRender();},updateSortInOneLineComing:function(data){var position=data.position;var line=data.line;var component=data.component;var rowModel=this.getRowModelByLineId(line);for(var j=0;j<component.length;j++){var comp=component[j];var componentModel=this.getComponentModelByActionkey(comp.actionkey);var rowFromRemoveModel=this.getRowModelByComponentModel(componentModel);rowFromRemoveModel.get('objects').remove(componentModel);if(rowModel!=undefined){rowModel.get('objects').add(componentModel,{at:position});}}
this.render();this.afterRender();var activeRow=this.getSelectedRow();this.selectRow(activeRow);},updateSortSortRows:function(data){var position=data.position;var lineId=data.line;var rowModel=this.getRowModelByLineId(lineId);this.collection.remove(rowModel);this.collection.add(rowModel,{at:position});this.render();this.afterRender();this.trigger('update-stage',this.collection);},getComponentModelByActionkey:function(actionkey){return this.model.getComponentModelByActionkey(actionkey);},deleteComponentModel:function(componentModel){this.collection.each(function(item){var objects=item.get('objects');objects.remove(componentModel);});componentModel.isDeleted=true;componentModel.view.destroy();},removeComponentModelFromCollection:function(componentModel){this.collection.each(function(line){var objects=line.get('objects');var index=objects.indexOf(componentModel);if(index!==-1){objects.remove(componentModel);return line;}});return false;},getRowModelByLineId:function(rowId){return this.model.getRowModelByLineId(rowId);},renderEmptyRow:function(){},getRowModelByComponentModel:function(componentModel){var actionkey=componentModel.get('actionkey');var rowModel;this.collection.each(function(row){row.get('objects').each(function(model){if(model.get('actionkey')==actionkey){rowModel=row;}});});return rowModel;},addNewLineComing:function(rowId){var timelineRowModel=new TimelineRowModel({options:new TimelineRowOptionsModel({id:this.model.get('options').get('lastLineId')}),objects:new TimelineItemCollection()});this.collection.add(timelineRowModel);if(this.collection.length==1){this.selectRow(timelineRowModel);}
return timelineRowModel;},addLine:function(newLine){var timelineRowOptionsModel=new TimelineRowOptionsModel(newLine.options);var timelineRowModel=new TimelineRowModel(newLine);timelineRowModel.set('options',timelineRowOptionsModel);timelineRowModel.set('objects',new ComponentCollection);this.collection.add(timelineRowModel);},getNextLineId:function(lastLineId){var rowModel=this.getRowModelByLineId(lastLineId);if(rowModel){return this.getNextLineId(lastLineId+1);}else{return lastLineId;}},selectRow:function(selectedRowModel){if(selectedRowModel!=undefined){User.getModel().set('activeRowId',selectedRowModel.get('options').get('id'));this.collection.each(function(row){row.setActive(false);});selectedRowModel.setActive(true);}},selectComponentsInRow:function(row){this.collection.each(function(rowModel){if(rowModel.cid!=row.cid){rowModel.get('objects').each(function(model){model.setActive(false);});}});row.get('objects').each(function(model){model.setActive(true);})},getSelectedRow:function(){var activeRowId=User.getModel().get('activeRowId');var activeRow;this.collection.each(function(row){if(row.get('options').get('id')==activeRowId){activeRow=row;}});if(activeRow==undefined){var index=this.collection.length-2;if(index<0){index=0;}
activeRow=this.collection.at(index);}
return activeRow;},setModel:function(pModel){this.model=pModel;this.collection=pModel.get('lines');this.model.on('update-timeline',this.updateTimeline,this);this.render();},disableComponentModel:function(componentModel){componentModel.disable();},findNotLockedRow:function(activeRow){return this.model.findNotLockedRow(activeRow);},sortCollectionByRow:function(componentsCollection){var _that=this;var tempArray=[];componentsCollection.each(function(model){var rowModel=_that.getRowModelByComponentModel(model);var componentIndex=rowModel.get('objects').indexOf(model);var rowIndex=_that.collection.indexOf(rowModel);var tempString=_that.pad(rowIndex)+_that.pad(componentIndex);tempArray.push({model:model,id:tempString});tempArray.sort(function(a,b){if(a.id<b.id)return-1;if(a.id>b.id)return 1;return 0;});});var tempCollection=new ComponentCollection();for(var i=0;i<tempArray.length;i++){var model=tempArray[i].model;tempCollection.add(model);};return tempCollection;},pad:function(val,len){val=String(val);len=len||3;while(val.length<len)val="0"+val;return val;},resetTimeline:function(){User.getModel().set('activeRowId',0);this.collection.reset();this.render();},renderComing:function(){this.render(true);this.afterRender();},renderEmptyRow:function(){var _that=this;},render:function(coming){var _that=this;this.collection.each(function(rowModel){rowModel.get('objects').each(function(cModel){cModel.trigger('selected-by-miniature',false);});});var timelineTemplate=this.template();this.$el.html(timelineTemplate);this.lineShowtime=0;this.collection.each(this.renderSingleRow,this);var activeRow=this.getSelectedRow();this.selectRow(activeRow);return this;},afterRender:function(){this.collection.each(function(rowModel){rowModel.view.afterRender();},this);},renderRows:function(){this.collection.each(function(rowModel){rowModel.view.afterRender();},this);},getAllComponents:function(){var componentsCollection=new ComponentCollection();this.collection.each(function(row){row.get('objects').each(function(model){componentsCollection.add(model);});});return componentsCollection;},componentExist:function(actionkey){return this.model.componentExist(actionkey);},replaceComponentModel:function(oldComponentModel,newComponentModel){return this.model.replaceComponentModel(oldComponentModel,newComponentModel);},scrollToActiveComponent:function(cModel){var activeMiniatureOffset=cModel.miniatureView.$el.offsetRelative('.botmenu-timeline-rows-wrapper').top;var activeMiniatureHeight=cModel.miniatureView.$el.height();var timelineHeight=this.$el.parent().height();this.$el.parent().scrollTop(activeMiniatureOffset-timelineHeight/2-activeMiniatureHeight/2);_log('scrollToActiveComponent',cModel);_log('activeMiniatureOffset',activeMiniatureOffset);_log('activeMiniatureHeight',activeMiniatureHeight);_log('timelineHeight',timelineHeight);_log('scrollTop',activeMiniatureOffset-timelineHeight/2-activeMiniatureHeight/2);_log('this.$el',this.$el);},});;;var TimelineRowView=ItemView.extend({tagName:'li',className:'timeline-main-list timelinerow',template:_.template($('#timelinerow-template').html()),rowFromRemove:null,events:{'update-sort':'updateSort','add-to-collection':'addToCollection','remove-from-collection':'removeFromCollection','click .timelinerow-label':'selectRow','mousedown .timelinerow-label':'onMouseDown','select-comp':'selectComponent','sort-rows':'sortRows','click .timelinerow-showhide':'hideShowAllComponents','click .timelinerow-block':'blockLine','click .timelinerow-block':'blockLine','click .timeline-row-edit-name':'activeEditingRowName'},activeEditingRowName:function(e){},onResize:function(e){},addEventsToModel:function(options){var _that=this;this.model.off('update-sort-coming');this.model.on('update-sort-coming',function(model,position){_that.updateSortComing(model,position);});this.model.off('remove-coming');this.model.on('remove-coming',function(model,position){});this.model.off('set-active');this.model.on("set-active",function(active){_that.renderActive(active);});this.$el.off('data-picker-picked-line');this.$el.on('data-picker-picked-line',function(){_that.dataPickerPicked();});this.model.off('selected-by-miniature');this.model.on('selected-by-miniature',function(value){_that.renderSelectByMinaiture(value);});this.model.off('selected-by-picker-miniature-1');this.model.on('selected-by-picker-miniature-1',function(value){_that.renderSelectByMinaiture(value);});this.model.off("selected-by-trigger");this.model.on("selected-by-trigger",function(value){_that.renderSelectByTrigger(value);});this.model.off("update-options-coming");this.model.on("update-options-coming",function(options){_that.renderOptions(options);});this.model.get('objects').off("add");this.model.get('objects').off("remove");this.model.get('objects').on("add remove",function(){setTimeout(function(){_that.trigger('render-timeline');},5);});},scroll:function(e){this.hideShowAllComponents();},showContextMenu:function(e){var isEmpty=$(e.target).parent().hasClass('timeline-empty-row');if(isEmpty){var contextMenuView=new TimelineEmptyRowContextMenuView({model:this.getModel(),view:this});ContextMenuContainer.addMenu(contextMenuView,e);}else{var contextMenuView=new TimelineRowContextMenuView({model:this.getModel(),view:this});ContextMenuContainer.addMenu(contextMenuView,e);}
this.selectRow();},blockLine:function(e){e.stopPropagation();var _that=this;var components=this.model.get('objects');var options=this.model.get('options');var isLocked=options.get('locked');options.set('locked',!isLocked);components.each(function(cModel){cModel.set('locked',!isLocked,{silent:true});cModel.trigger('locked-render');if(!isLocked){_that.trigger('unselect-model',cModel);}});this.render();this.afterRender();this.updateTimelineOptions(options);this.updateComponents(components);},hideShowAllComponents:function(e){e.stopPropagation();var components=this.model.get('objects');var options=this.model.get('options');var isHidden=options.get('hidden');options.set('hidden',!isHidden);components.each(function(cModel){cModel.set('hidden',!isHidden,{silent:true});cModel.view.unselectComponent();cModel.view.render();cModel.view.afterRender();});StageView.instance.unsetActiveComponents();this.render();this.afterRender();this.updateTimelineOptions(options);this.updateComponents(components);},updateComponents:function(components){DataAccess.updateComponents({components:components,action:"update",pageId:StageView.instance.model.getPageId()},function(data){_log('Update component result: ',data,_log.dataaccessOutResult)},function(data){_log('Update component fault: ',data,_log.dataaccessOutFault)});},updateTimelineOptions:function(rowOptions){DataAccess.updateTimelineOptions({rowOptions:rowOptions,pageId:StageView.instance.model.getPageId()},function(data){_log('Update timeline result: ',data,_log.dataaccessOutResult)},function(data){_log('Update timeline fault: ',data,_log.dataaccessOutFault)});},sortRows:function(event,position){this.$el.trigger('sort-rows-back',[this.model,position]);},selectComponent:function(event,componentModel,e){this.trigger('select-component',componentModel,e);},selectRow:function(){this.trigger('select-row',this.model);this.$el.find('.timelinerow-label-classic').attr('active',true);this.$el.find('.timelinerow-label').attr('active',true);},removeFromCollection:function(event,model,index,rowModel){this.rowFromRemove=rowModel;},addToCollection:function(event,model,position,canRender){},addToCollectionNewLine:function(event,model,position,canRender){},updateSort:function(event,model,position,canRender){var rowId=this.model.get('options').get('id');this.moveComponentsToLayer(rowId,position);},updateSortComing:function(model,position){var collection=this.model.get('objects');collection.remove(model);collection.add(model,{at:position});this.render();this.afterRender();},initialize:function(data){},moveComponentsToLayer:function(rowId,position){this.trigger('move-components-to-layer',rowId,position);},renderOptions:function(options){},renderSelectByMinaiture:function(value){this.$el.attr('selected-by-miniature',value);},renderSelectByTrigger:function(value){this.$el.attr('selected-by-trigger',value);},dataPickerPicked:function(){this.$el.trigger('data-picker-picked-line1',this.model);},renderActive:function(active){},render:function(){},addItem:function(rowItem){},sortableDestroy:function(){},afterRender:function(){this.model.get('objects').each(function(componentModel){componentModel.miniatureView.afterRender();},this);},getRowName:function(){var rowName=this.model.get('options').get('rowName')||_lang('TIMELINE_LINE_NAME_PREFIX')+' '+(this.model.collection.indexOf(this.model)+1);return rowName;},scrollToActiveComponent:function(cModel){this.trigger('scroll-to-active-component',cModel);},});;;var TimelineRowItemView=ComponentMiniatureView.extend({tagName:"li",className:'component-miniature timeline-item',multiSelectedComponentsModels:null,events:function(){return _.extend({},ComponentMiniatureView.prototype.events,{'drop-item':'dropItem','remove-from':'removeFromCollection','add-to':'addToCollection','add-to-multi':'addToCollectionMulti','add-new-row':'addNewRow','data-picker-selected-by-miniature':'dataPickerSelectedByMiniature','data-picker-unselected-by-miniature':'dataPickerUnSelectedByMiniature',});},initialize:function(){this.addEventsToModel();},onResize:function(e){},addEventsToModel:function(){var _that=this;var _that=this;this.$el.off('data-picker-picked-object');this.$el.on('data-picker-picked-object',function(){_that.dataPickerPicked();});this.$el.off('data-picker-picked-timer');this.$el.on('data-picker-picked-timer',function(){_that.dataPickerPicked();});this.$el.off('data-picker-picked-exercise');this.$el.on('data-picker-picked-exercise',function(){_that.dataPickerPicked();});this.$el.off('data-picker-picked-video');this.$el.on('data-picker-picked-video',function(){_that.dataPickerPicked();});this.$el.off('data-picker-picked-text');this.$el.on('data-picker-picked-text',function(){_that.dataPickerPicked();});this.model.on("selected-by-trigger",this.renderSelectByTrigger,this);this.listenTo(this.model,'change:point-sound',this.renderPointSound);this.listenTo(this.model,'change:triggers',this.renderTriggers);this.listenTo(this.model,'change:locked',this.renderLocked);this.listenTo(this.model,'change:wcag',this.renderWcag);},renderLocked:function(){this.$el.attr('locked',this.model.get('locked'));},renderTriggers:function(){var triggers=this.model.get('triggers').length>0?true:false;this.$el.attr('triggers',triggers);},renderPointSound:function(){var sound=this.model.get('point-sound')==''?false:true;this.$el.attr('sound',sound);},renderWcag:function(){var wcag=this.model.get('wcag')?true:false;this.$el.attr('wcag',wcag);},dataPickerPicked:function(){this.$el.trigger('data-picker-picked-object1',this.model,this);},renderActive:function(active){this.$el.find('.timelineItem').attr('active',active);},mouseDown:function(e){if(e.shiftKey){this.$el.trigger('select-comp',[this.model,e]);}else{if(!StageView.instance.selectedComponentsCollection.contains(this.model)){this.$el.trigger('select-comp',[this.model,e]);}}},scroll:function(e){this.$el.trigger('select-comp',[this.model,e]);this.showhideComponent();},showContextMenu:function(e){if(StageView.instance.selectedComponentsCollection.length>1){var contextMenuView=new MultiComponentContextMenuView({model:this.getModel(),view:this});ContextMenuContainer.addMenu(contextMenuView,e);}else{var contextMenuView=new ComponentContextMenuView({model:this.getModel(),view:this});ContextMenuContainer.addMenu(contextMenuView,e);}},showhideComponent:function(){var hidden=this.model.get('hidden');this.model.set('hidden',!hidden);this.render();this.afterRender();this.model.forceRender();},addToCollectionMulti:function(event,index,componentsCollection){this.model.selectedByMiniature(false);this.$el.trigger('add-to-collection-multi',[componentsCollection,index]);},addToCollection:function(event,index){this.model.selectedByMiniature(false);this.$el.trigger('add-to-collection',[this.model,index]);},removeFromCollection:function(event,index,rowModel){this.model.selectedByMiniature(false);rowModel.get('objects').remove(this.model);this.$el.trigger('remove-from-collection',[this.model,index,rowModel]);console.log("removeFromCollection",this.model);},dropItem:function(event,index){this.model.selectedByMiniature(false);this.$el.trigger('update-sort',[this.model,index]);console.log("drop");},addNewRow:function(event,index){this.model.selectedByMiniature(false);this.$el.trigger('create-new-row',[this.model,index]);},onSetActive:function(active){var _that=this;_that.multiSelectedComponentsModels=StageView.instance.selectedComponentsCollection;_that.renderActive(active);},render:function(){var _that=this;this.model.off("set-active",this.onSetActive,this);this.model.on("set-active",this.onSetActive,this);this.model.off("selected-by-picker-miniature-2");this.model.on("selected-by-picker-miniature-2",this.renderSelectByPickerMinaiture,this);var timelineItemTemplate=this.template(this.model.toJSON());this.$el.html(timelineItemTemplate);if(this.model.get('hidden')){this.$el.css({opacity:'.6'});}else{this.$el.css({opacity:'1'});}
this.delegateEvents();this.renderPointSound();this.renderWcag();this.renderTriggers();this.renderLocked();this.renderActive(this.model.active);this.renderClassType();this.makeResizable();this.makeDraggable();return this;},makeDraggable:function(){},makeResizable:function(){},renderHandles:function(){},afterRender:function(){},renderSelectByMinaiture:function(value){this.$el.attr('selected-by-miniature',value);_log('renderSelectByMinaiture miniature',value,_log.error);},renderSelectByTrigger:function(value){this.$el.attr('selected-by-trigger',value);},dataPickerSelectedByMiniature:function(){this.model.selectedByPickerMiniature(true);},dataPickerUnSelectedByMiniature:function(){this.model.selectedByPickerMiniature(false);},renderClassType:function(){var type=this.model.get('type');this.$el.addClass(type+'-component-miniature');if(this.model.isExercise()){this.$el.addClass('quiz-component-miniature');}},renderSelectByPickerMinaiture:function(value){_log('renderSelectByPickerMinaiture',value);this.$el.attr('selected-by-miniature',value);this.scrollToActiveComponent(value);},scrollToActiveComponent:function(value){var dataPickerSelector=$('body').find('.data-picker-selector');if(dataPickerSelector.length>0){return;}
if(value){this.trigger('scroll-to-active-component',this.model);}},});;;var LayersTimelineView=TimelineView.extend({tagName:'div',dataPickerPickedObject:function(event,cModel){this.trigger('data-picker-picked',cModel);},dataPickerPickedLine:function(event,rowModel){this.trigger('data-picker-picked',rowModel);},initialize:function(){this.$el.sortable({items:"> .timeline-main-list:not(.timeline-empty-row)",placeholder:"timeline-highlight-container",delay:150,handle:'.timelinerow-label',stop:function(event,ui){ui.item.trigger('sort-rows',ui.item.index());}});},renderSingleRow:function(rowItem,i){var _that=this;this.lineShowtime+=parseFloat(rowItem.get('options').get('delay'));var rowItemView=new LayersTimelineRowView({model:rowItem,showtime:this.lineShowtime});this.addListenersToRow(rowItemView);this.$el.append(rowItemView.render().el);}});;;var LayersTimelineRowView=TimelineRowView.extend({tagName:'li',className:'timeline-main-list timelinerow',template:_.template($('#timelinerow-template').html()),rowFromRemove:null,events:{'update-sort':'updateSort','add-to-collection':'addToCollection','remove-from-collection':'removeFromCollection','click .timelinerow-label':'selectRow','mousedown .timelinerow-label':'onMouseDown','select-comp':'selectComponent','sort-rows':'sortRows','click .timelinerow-showhide':'hideShowAllComponents','click .timelinerow-block':'blockLine','click .timelinerow-block':'blockLine','click .timeline-row-edit-name':'activeEditingRowName'},activeEditingRowName:function(e){var _that=this;e.stopPropagation();var options=this.model.get('options');var rowName=this.getRowName();var rowInput=$('<input name="pagename" class="timeline-row-edit-name-input-layers"  type="text">');var timelinerowLabel=this.$el.find('.timelinerow-label');timelinerowLabel.html('').append(rowInput);rowInput.focus();rowInput.val(rowName);rowInput.on('focusout',function(e2){var value=$(e2.target).val();var rowEditName=$('<div class="edit-name timeline-row-edit-name"></div>                                    <div class="timeline-row-edit-name-layers">'+value+'</div>                                </div>');timelinerowLabel.html(rowEditName);$(e2.target).remove();options.set('rowName',value);_that.updateTimelineOptions(options);_that.delegateEvents();});rowInput.on('keyup',function(e2){if(e2.which==13){$(this).trigger('focusout');}});rowInput.on('click mousedown mouseup',function(e2){e2.stopPropagation();e2.stopImmediatePropagation();});},initialize:function(data){var _that=this;this.model.view=this;this.showtime=data.showtime;this.addEventsToModel();},renderOptions:function(options){this.$el.find('.timelinerow-showhide').attr('hide',this.model.get('options').get('hidden'));this.$el.find('.timelinerow-block').attr('block',this.model.get('options').get('locked'));},renderActive:function(active){this.$el.attr('active',active);this.$el.find('.timelinerow-label').attr('active',active);},render:function(){var _that=this;var renderData=this.model.toJSON();renderData.showtime=this.showtime;renderData.last=this.false;renderData.rowName=this.getRowName();if(this.model.cid==this.model.collection.last().cid){renderData.last=true;this.$el.addClass('timeline-empty-row');}
var timelineRowTemplate=this.template(renderData);this.$el.html(timelineRowTemplate);this.model.get('objects').each(this.addItem,this);if(!this.model.get('options').get('locked')){this.$el.find('.timelinerow-items-holder').sortable({items:'li',placeholder:"timeline-placeholder",connectWith:".timelinerow-items-holder",delay:150,tolerance:'pointer',remove:function(event,ui){},receive:function(event,ui){},stop:function(event,ui){var position=ui.item.index();ui.item.trigger('drop-item',ui.item.index());},start:function(e,ui){$(ui).find('.timelineItem').addClass('startedDragging');},helper:function(e,item){item.addClass('mainDragObject');var elements=[];var elementsToDelete=[];var iterator=0;$('.botmenu-timeline-rows-wrapper .timelineItem[active="true"]').each(function(){var originalLi=$(this).parent();var clonedLi=$(this).parent().clone(true);if(!originalLi.hasClass('mainDragObject')){elementsToDelete.push(originalLi);}
clonedLi.css({left:(iterator*10)+'px',top:-(iterator*10)+'px','z-index':500-iterator});iterator++;elements.push(clonedLi);});var helper=$('<ul/>',{class:'timeline-sortable-helper'});helper.css({position:'absolute',top:item.offset().top+"px",left:item.offset().left+"px"})
helper.append(elements);setTimeout(function(){_.each(elementsToDelete,function(element){element.hide();});},2);return helper;}});}
this.renderOptions();this.delegateEvents();return this;},addItem:function(rowItem){var itemView=new LayersTimelineRowItemView({model:rowItem});itemView.on('scroll-to-active-component',this.scrollToActiveComponent,this);this.$el.find('.timelinerow-items-holder').append(itemView.render().el);},sortableDestroy:function(){if(this.$el.find('.timelinerow-items-holder').is('.ui-sortable')){this.$el.find('.timelinerow-items-holder').sortable("destroy");}}});;;var LayersTimelineRowItemView=TimelineRowItemView.extend({tagName:"li",className:'component-miniature timeline-item',multiSelectedComponentsModels:null,initialize:function(){this.model.miniatureView=this;this.addEventsToModel();}});;;var ClassicTimelineView=TimelineView.extend({tagName:'div',initialize:function(){var _that=this;this.$el.sortable({items:"> .timeline-main-list:not(.timeline-empty-row)",placeholder:"timeline-highlight-container",delay:150,handle:'.timelinerow-label-classic',start:function(event,ui){ui.item.trigger('forceCollapseRowItems');},stop:function(event,ui){ui.item.trigger('forceUncollapseRowItems');ui.item.trigger('sort-rows',ui.item.index());}});},renderSingleRow:function(rowModel){var _that=this;var rowItemView=new ClassicTimelineRowView({model:rowModel,showtime:this.lineShowtime});this.addListenersToRow(rowItemView);this.$el.append(rowItemView.render().el);}});;;var ClassicTimelineRowView=TimelineRowView.extend({tagName:'li',className:'timeline-main-list timelinerow-classic',template:_.template($('#timelinerow-template-classic').html()),events:{'update-sort':'updateSort','add-to-collection':'addToCollection','remove-from-collection':'removeFromCollection','click .timelinerow-label-classic':'selectRow','mousedown .timelinerow-label-classic':'onMouseDown','select-comp':'selectComponent','sort-rows':'sortRows','click .timelinerow-showhide':'hideShowAllComponents','click .timelinerow-block':'blockLine','click .timeline-row-edit-name':'activeEditingRowName','click .timeline-collapse-classic':'collapseUncollapseRowItems'},activeEditingRowName:function(e){var _that=this;e.stopPropagation();var options=this.model.get('options');var rowName=this.getRowName();var rowInput=$('<input name="pagename" class="timeline-row-edit-name-input-classic"  type="text">');$(e.target).html('').append(rowInput);rowInput.focus();rowInput.val(rowName);rowInput.on('focusout',function(e2){var value=$(e2.target).val();$(e2.target).parent().html(value);$(e2.target).remove();options.set('rowName',value);_that.updateTimelineOptions(options);});rowInput.on('keyup',function(e2){if(e2.which==13){$(this).trigger('focusout');}});},initialize:function(data){var _that=this;this.$el.off('forceCollapseRowItems');this.$el.on('forceCollapseRowItems',function(){_that.forceCollapseRowItems();});this.$el.off('forceUncollapseRowItems');this.$el.on('forceUncollapseRowItems',function(){_that.forceUncollapseRowItems();});this.model.view=this;this.showtime=data.showtime;this.addEventsToModel();},onResize:function(e){this.model.get('objects').each(function(componentModel){componentModel.miniatureView.onResize();},this);},collapsed:false,collapseUncollapseRowItems:function(e){var _that=this;e.stopPropagation();this.$el.find('.timelinerow-items-holder-classic').animate({height:"toggle"},300);this.collapsed=!this.collapsed;this.renderCollapseIcon();},forceCollapseRowItems:function(){var _that=this;this.$el.find('.timelinerow-items-holder-classic').animate({height:"toggle"},300);this.collapsed=true;this.renderCollapseIcon();},forceUncollapseRowItems:function(){var _that=this;this.$el.find('.timelinerow-items-holder-classic').animate({height:"toggle"},300);this.collapsed=false;this.renderCollapseIcon();},renderCollapseIcon:function(){var collapseIcon=this.$el.find('.timeline-collapse-classic');var rotation=this.collapsed?'0deg':'135deg';collapseIcon.css({transform:'rotate('+rotation+')'});},render:function(){var _that=this;var renderData=this.model.toJSON();renderData.showtime=this.showtime;renderData.last=false;renderData.rowName=this.getRowName();if(this.model.cid==this.model.collection.last().cid){renderData.last=true;this.$el.addClass('timeline-empty-row');}
var timelineRowTemplate=this.template(renderData);this.$el.html(timelineRowTemplate);this.model.get('objects').each(this.addItem,this);if(!this.model.get('options').get('locked')){this.$el.find('.timelinerow-items-holder-classic').sortable({items:'li',placeholder:"timeline-placeholder-classic",connectWith:".timelinerow-items-holder-classic",delay:150,tolerance:'pointer',remove:function(event,ui){},receive:function(event,ui){},stop:function(event,ui){var position=ui.item.index();ui.item.trigger('drop-item',ui.item.index());},start:function(e,ui){$(ui).find('.timelineItem').addClass('startedDragging');},helper:function(e,item){item.addClass('mainDragObject');var elements=[];var elementsToDelete=[];var iterator=0;$('.botmenu-timeline-rows-wrapper .timelineItem[active="true"]').each(function(){var originalLi=$(this).closest('li.timeline-item');var clonedLi=$(this).closest('li.timeline-item').clone(true);if(!originalLi.hasClass('mainDragObject')){elementsToDelete.push(originalLi);}
clonedLi.css({left:(iterator*10)+'px',top:-(iterator*10)+'px','z-index':500-iterator});iterator++;elements.push(clonedLi);});var helper=$('<ul/>',{class:'timeline-sortable-helper'});helper.css({position:'absolute',top:item.offset().top+"px",left:item.offset().left+"px"})
helper.append(elements);setTimeout(function(){_.each(elementsToDelete,function(element){element.hide();});},2);return helper;}});this.renderCollapseIcon();}
this.renderOptions();this.delegateEvents();return this;},addItem:function(rowItem){var itemView=new ClassicTimelineRowItemView({model:rowItem});itemView.on('scroll-to-active-component',this.scrollToActiveComponent,this);this.$el.find('.timelinerow-items-holder-classic').append(itemView.render().el);},renderActive:function(active){this.$el.attr('active',active);this.$el.find('.timelinerow-label-classic').attr('active',active);}});;;var ClassicTimelineRowItemView=TimelineRowItemView.extend({className:'timeline-item timeline-item-classic',template:_.template($('#timelineitem-template-classic').html()),grid:10,singleMove:1,minBlockWidth:25,events:function(){return _.extend({},ComponentMiniatureView.prototype.events,{'save-model':'saveModel','drop-item':'dropItem','remove-from':'removeFromCollection','add-to':'addToCollection','add-to-multi':'addToCollectionMulti','add-new-row':'addNewRow','data-picker-selected-by-miniature':'dataPickerSelectedByMiniature','data-picker-unselected-by-miniature':'dataPickerUnSelectedByMiniature'});},tempPositionObject:{},others:[],initialize:function(){var _that=this;this.model.miniatureView=this;this.addEventsToModel();this.listenTo(StageView.instance.model.get('options'),'change:stageLifetime',this.onStageLifetimeChange);},onStageLifetimeChange:function(model){this.render();this.afterRender();},saveModel:function(event,params){this.model.set(params,{silent:true});},rememberPositions:function(sender,direction){var _that=this;var draggingObjectsData=[];var selectedObjectsWithoutDraggedOne=StageView.instance.selectedComponentsCollection;selectedObjectsWithoutDraggedOne.each(function(model){if(model.cid!=_that.model.cid){draggingObjectsData.push({left:parseInt(model.miniatureView.$el.find('.timeline-classic-block').css('left')),width:parseInt(model.miniatureView.$el.find('.timeline-classic-block').css('width')),lifetime:parseInt(model.get('lifetime')),showtime:parseInt(model.get('showtime')),ob:model.miniatureView.$el,model:model});}});this.tempPositionObject={left:parseInt(sender.css('left')),width:parseInt(sender.css('width')),draggingObjectsData:draggingObjectsData,selectedObjectsWithoutDraggedOne:selectedObjectsWithoutDraggedOne,lifetime:this.model.get('lifetime'),showtime:this.model.get('showtime')};},setPositions:function(sender,direction){var _that=this;var actualPositionX=parseInt(this.$el.find('.timeline-classic-block').css('left'));var others=this.tempPositionObject.draggingObjectsData;for(var i=0;i<others.length;i++){var other=others[i].ob.find('.timeline-classic-block');if(direction=='left'){var delta=actualPositionX-_that.tempPositionObject.left;var positionX=_that.tempPositionObject.draggingObjectsData[i].left+delta;var width=_that.tempPositionObject.draggingObjectsData[i].width-delta;if(positionX>=0&&width>_that.minBlockWidth){other.css({left:positionX+'px',width:width+'px'});_that.saveTime(other,others[i].model,true);_that.renderHandles(others[i].model,other);}}else if(direction=='right'){var width=parseInt(this.$el.find('.timeline-classic-block').css('width'));var delta=width-_that.tempPositionObject.width;var w=_that.tempPositionObject.draggingObjectsData[i].width+delta;var maxWidth=parseInt(others[i].ob.find('.timeline-classic-block-wrapper').css('width'));if(w>=0&&w<=maxWidth){other.css('width',w+'px');_that.saveTime(other,others[i].model,true);_that.renderHandles(others[i].model,other);}}else if(direction=='drag'){var delta=actualPositionX-_that.tempPositionObject.left;var positionX=_that.tempPositionObject.draggingObjectsData[i].left+delta;if(positionX>=0){other.css('left',positionX+'px');}else{other.css('left',0+'px');}
_that.saveTime(other,others[i].model,true);_that.renderHandles(others[i].model,other);}};},makeDraggable:function(){var _that=this;if(this.model.get('locked')){return;}
this.$el.find('.timeline-classic-block').draggable({containment:'.timeline-classic-block-wrapper',axis:'x',start:function(e){e.stopPropagation();$(e.target).css({cursor:'grabbing',cursor:'-ms-grabbing',cursor:'-o-grabbing',cursor:'-moz-grabbing',cursor:'-webkit-grabbing'}).attr('is-draging',true);_that.rememberPositions($(e.target),'left');},stop:function(e){e.stopPropagation();$(e.target).css({cursor:'grab',cursor:'-ms-grab',cursor:'-o-grab',cursor:'-moz-grab',cursor:'-webkit-grab'}).removeAttr('is-draging');_that.saveTime($(this),_that.model,false);_that.setPositions($(e.target),'drag');_that.model.trigger('change');},drag:function(e){e.stopPropagation();_that.setPositions($(e.target),'drag');_that.saveTime($(this),_that.model,true);_that.renderHandles(_that.model,_that.$el);}});},makeResizable:function(){var _that=this;if(this.model.get('locked')){this.$el.find('.timeline-classic-block').resizable({containment:'parent',handles:'e, w',minWidth:_that.minBlockWidth});this.$el.find('.timeline-classic-block').resizable('disable');}else{this.$el.find('.timeline-classic-block').resizable({containment:'parent',handles:'e, w',minWidth:_that.minBlockWidth,resize:function(e){e.stopPropagation();if(_that.handler=='e'){_that.setPositions($(e.target),'right');}else if(_that.handler=='w'){_that.setPositions($(e.target),'left');}
_that.saveTime($(this),_that.model,true);_that.renderHandles(_that.model,_that.$el);},start:function(e){e.stopPropagation();$(e.target).attr('is-draging',true);if($(e.toElement).hasClass('ui-resizable-e')){_that.rememberPositions($(e.target),'right');_that.handler='e';}else{_that.rememberPositions($(e.target),'left');_that.handler='w';}},stop:function(e){e.stopPropagation();$(e.target).removeAttr('is-draging',true);_that.saveTime($(this),_that.model,false);_that.model.trigger('change');}});}},renderHandles:function(model,el){var showtime=parseInt(model.get('showtime'));var lifetime=parseInt(model.get('lifetime'));var timelineGrid=this.calculateTimelineGrid();var hidetime=(parseInt(showtime)+parseInt(lifetime));this.rowTime=StageView.instance.model.get('options').get('stageLifetime');if((lifetime+showtime)>=this.rowTime||lifetime==0){hidetime='&infin;';this.model.set('lifetime',0);}
el.find('.ui-resizable-w').text(showtime);el.find('.ui-resizable-e').html(hidetime);},renderWidth:function(){var x1=this.model.get('showtime');var x2=this.model.get('lifetime');var timelineGrid=this.calculateTimelineGrid();var showtime=parseInt(x1*timelineGrid)+'px';var hidetime=parseInt(x2*timelineGrid)+'px';if(x1==0&&x2==0){hidetime='100%';}
if(x2==0){hidetime=parseInt(this.$el.find('.timeline-classic-block-wrapper').css('width'))-parseInt(showtime)+'px';}
this.$el.find('.timeline-classic-block').css('left',showtime);this.$el.find('.timeline-classic-block').css('width',hidetime);},calculateTimelineGrid:function(){var width=this.$el.find('.timeline-classic-block-wrapper').css('width');this.rowTime=StageView.instance.model.get('options').get('stageLifetime');var timelineGrid=(parseInt(width)*this.singleMove)/ this.rowTime;return parseInt(timelineGrid);},displayTime:function(sender){var _that=this;var timelineGrid=this.calculateTimelineGrid();var showtime=this.model.get('showtime');var hidetime=parseInt(this.model.get('showtime'))+parseInt(this.model.get('lifetime'));sender.find('.ui-resizable-w').text(showtime);sender.find('.ui-resizable-e').text(hidetime);},saveTime:function(sender,model,silent){var timelineGrid=this.calculateTimelineGrid();var width=parseInt(sender.css('width'));var showtime=parseInt(parseInt(sender.css('left'))/ timelineGrid);var lifetime=parseInt(width / timelineGrid);if((lifetime+showtime)>=this.rowTime){lifetime=0;}
model.set({lifetime:lifetime,showtime:showtime},{silent:silent});if(silent){model.refreshTimelineEditor();}},renderActive:function(active){this.$el.attr('active',active);this.$el.find('.timelineItem').attr('active',active);},afterRender:function(){this.renderHandles(this.model,this.$el);this.renderWidth();},onResize:function(){this.afterRender();}});;;var PageOptions=Backbone.Model.extend({pdfSelected:true,pdfNoteSelected:true,defaults:{pagename:"",name:"",bgcolor:"",width:860,height:500,bg_pos_x:0,bg_pos_y:0,active:1,pageid:0,order:0,soundfilename:"",volume:100,locknavi:false,locknavitrigger:false,lockscroll:false,'page-end-action':"none",image:"",note:"",lastLineId:0,lastComponentId:0,slideTime:60,activeComponent:null,triggers:[],title:'',wcag:'',stageLifetime:60,selectedBy:[],timeOnPage:0,goToNextPage:false,highlightButtons:true},initialize:function(){var parallaxExsists=this.get('parallax');if(!parallaxExsists){var blankParallaxObject=this.createParallaxObject();this.set('parallax',blankParallaxObject,{silent:true});}},createParallaxObject:function(){var parallax={cursor:{sens:0,dir:false,on:false},scroll:{sens:0,on:false}}
return parallax;},getTriggerWhenDoIt:function(){var triggerWhenDoIt=new TriggerActionsCollection();var triggerActionModel=new TriggerActionModel({group:_lang('NEW_PAGE_TITLE'),options:[{name:_lang('TRIGGER_PAGE_LOAD'),value:'onPageLoaded'}]});triggerWhenDoIt.add(triggerActionModel);var triggerActionModel=new TriggerActionModel({group:_lang('TRIGGER_KEYBOARD'),options:[{name:_lang('TRIGGER_ON_KEY_DOWN'),value:'keydown'}]});triggerWhenDoIt.add(triggerActionModel);return triggerWhenDoIt.toJSON();},getTriggerWhatToDo:function(){var triggerWhatToDo=new TriggerActionsCollection();var triggerActionModel=new TriggerActionModel({group:_lang('TRIGGER_LINE'),options:[{name:_lang('TRIGGER_SHOW_NEXT_LINE'),value:'showNextLine'}]});triggerWhatToDo.add(triggerActionModel);return triggerWhatToDo.toJSON();},setProportions:function(){return;},setFileName:function(data){this.set('soundfilename',data.fileName);},setImageFileName:function(data){this.set('image',data.fileName);},getExtensionPageSoundArray:function(){return['mp3'];},getExtensionPageImageArray:function(){return['png','jpg','jpeg'];},getExtensionFilesArray:function(){return[];},getExtensioAudioArray:function(){return[];},getExtensionImagesArray:function(){return[];},getExtensionSoundsArray:function(){return[];},getExtensionVideosArray:function(){return[];},getExtensionSwfArray:function(){return[];},getExtensionGalleryArray:function(){return[];},getAcceptTypeFormat:function(){var _mainTypes=this.getExtensionPageImageArray();var _soundTypes=this.getExtensionPageSoundArray();var acceptTypeString='';_.each(_mainTypes,function(option){acceptTypeString+='.'+option+',';});_.each(_soundTypes,function(option){acceptTypeString+='.'+option+',';});return acceptTypeString;},setStyle:function(templateStyle){this.set('premade-style',templateStyle);},triggerChanged:function(){this.trigger('trigger-changed',this);},isDndElement:function(){return false;},});var PageModel=Backbone.Model.extend({isSelected:false,projectId:__meta__.projectID,userId:__meta__.userID,ownerId:__meta__.ownerID,defaults:{options:new PageOptions(),lines:new TimelineRowCollection(),draw:[],type:'page'},initialize:function(){this.ownerId=__meta__.ownerID;},setCheckboxSelected:function(value){this.trigger('checkbox-selected',value,this);},updateComing:function(m){this.trigger('update-coming',m);},setActive:function(value){this.trigger('set-active',value);},selectedByMiniature:function(value){this.trigger('selected-by-miniature',value);},selectedByPickerMiniature:function(value){this.trigger('selected-by-picker-miniature-1',value);},selectedByTrigger:function(value){this.trigger('selected-by-trigger',value);},addNewLine:function(){},updateDinamicPageThumb:function(){this.trigger('update-dintamic-page-thumb');},setActiveComponent:function(componentModel){this.get('options').set('activeComponent',componentModel);},getActiveComponent:function(){var activeComponent=this.get('options').get('activeComponent');return activeComponent;},saveChanges:function(){var _that=this;DataAccess.updatePage(_that,function(data){console.log('Update page successed: ',data)},function(data){console.log('Update page failed: ',data)});},getAllComponentsCollection:function(){var componentCollection=new ComponentCollection();var linesCollection=this.get('lines');linesCollection.each(function(rowModel){var objects=rowModel.get('objects');objects.each(function(cModel){componentCollection.add(cModel);});});return componentCollection;},updateComponentsCollection:function(data){var cc=new ComponentCollection();var components=data.components;if(!_.isArray(components)){return cc;}
var actionkeys=_.pluck(components,'actionkey');var linesCollection=this.get('lines');linesCollection.each(function(rowModel){var objects=rowModel.get('objects');objects.each(function(cModel){var actionkey=cModel.get('actionkey');var index=actionkeys.indexOf(actionkey);if(index!==-1){var component=components[index];cModel.onlyRefresh=true;for(var item in component){cModel.set(item,component[item]);};cModel.onlyRefresh=false;cc.add(cModel);}});});return cc;},actionkeyExists:function(actionkey){var allComponentsCollection=this.getAllComponentsCollection();var findExistingActionkey=allComponentsCollection.where({actionkey:actionkey});if(findExistingActionkey.length>0)return true;return false;},createActionkey:function(){var loginHashed=__meta__.loginHashed;var lastComponentId=this.get('options').get('lastComponentId');var pageid=this.get('options').get('pageid');var actionkey=loginHashed+'-'+lastComponentId+'-'+pageid;if(!this.actionkeyExists(actionkey)){_log('THIS ACTIONKEY NOT EXISTS YET, GO ALONG',actionkey);this.get('options').set('lastComponentId',lastComponentId+1);return actionkey;}else{_log('WHOA! this actionkey already exists on stage, make new one',actionkey,_log.error);this.get('options').set('lastComponentId',lastComponentId+1);return this.createActionkey();}},updatePagethumb:function(){this.trigger('update-pagethumb');},getLineById:function(lineId){},getComponentsByType:function(type){var componentCollection=new ComponentCollection();var linesCollection=this.get('lines');linesCollection.each(function(rowModel){var objects=rowModel.get('objects');objects.each(function(cModel){if(cModel.get('type')==type){componentCollection.add(cModel);}});});return componentCollection;},getDndsComponents:function(){return this.getComponentsByType('quiz-dnd');},getPageId:function(){return this.get('options').get('pageid');},getComponentModelByActionkey:function(actionkey){var componentModel;this.get('lines').each(function(item){var objects=item.get('objects');objects.each(function(model){if(model.get('actionkey')==actionkey){componentModel=model;}});});return componentModel;},componentExist:function(actionkey){var exist=false;this.get('lines').each(function(row){row.get('objects').each(function(model){if(model.get('actionkey')==actionkey){exist=true;}});});return exist;},getSortedComponentsCollection:function(cc){var sortedCC=new ComponentCollection();this.get('lines').each(function(item){var objects=item.get('objects');objects.each(function(model){cc.each(function(fCModel){if(model.cid==fCModel.cid){sortedCC.add(fCModel);}});});});return sortedCC;},findNotLockedRow:function(activeRow){var _that=this;var notLockedRow;var lines=this.get('lines');var activeRowIndex=lines.indexOf(activeRow);lines.each(function(row){if(notLockedRow==undefined){var options=row.get('options');var rowIndex=lines.indexOf(row);if(rowIndex>=activeRowIndex&&options.get('locked')==false){notLockedRow=row;}}});return notLockedRow;},replaceComponentModel:function(oldComponentModel,newComponentModel){var selectedRow;var actionkey=oldComponentModel.get('actionkey');var lines=this.get('lines');lines.each(function(row){var objects=row.get('objects');objects.each(function(model){if(model.get('actionkey')==actionkey){var position=objects.indexOf(model);objects.remove(model);objects.add(newComponentModel,{at:position});selectedRow=row;}});});return selectedRow;},deleteComponentModel:function(componentModel){this.get('lines').each(function(item){var objects=item.get('objects');objects.remove(componentModel);});componentModel.isDeleted=true;if(componentModel.view){componentModel.view.destroy();}},removeComponentModelFromCollection:function(componentModel){this.get('lines').each(function(line){var objects=line.get('objects');var index=objects.indexOf(componentModel);if(index!==-1){objects.remove(componentModel);return line;}});return false;},removeLayersByIds:function(deletedLayersIds){var _that=this;var emptyRowsToRemove=[];for(var i=0;i<deletedLayersIds.length;i++){var lineId=deletedLayersIds[i];var line=this.getRowModelByLineId(lineId);emptyRowsToRemove.push(line);};this.get('lines').remove(emptyRowsToRemove);},getRowModelByLineId:function(rowId){var finedRow;var selectedRowId=parseInt(rowId);this.get('lines').each(function(row){if(row.get('options').get('id')==selectedRowId){finedRow=row;}});return finedRow;},addLine:function(newLine){var timelineRowOptionsModel=new TimelineRowOptionsModel(newLine.options);var timelineRowModel=new TimelineRowModel(newLine);timelineRowModel.set('options',timelineRowOptionsModel);timelineRowModel.set('objects',new ComponentCollection);this.get('lines').add(timelineRowModel);},deleteComponents:function(data){var cc=new ComponentCollection();var components=data.components;var deletedLayersIds=data.deletedLayersIds;for(var i=0;i<components.length;i++){var component=components[i];var componentModel=this.getComponentModelByActionkey(component.actionkey);cc.add(componentModel);if(componentModel){this.deleteComponentModel(componentModel);}};this.removeLayersByIds(deletedLayersIds);return cc;},addComponents:function(data){var _that=this;var selectedRow=_that.getRowModelByLineId(data.selectedRowId);var newLine=data.newLine;var lastLineId=data.lastLineId;var lastComponentId=data.lastComponentId;var newProjectVariables=data.newProjectVariables;this.get('options').set('lastLineId',lastLineId,{silent:true});this.get('options').set('lastComponentId',lastComponentId,{silent:true});var components=data.components;var cc=new ComponentCollection();for(var i=0;i<components.length;i++){var component=components[i];var componentModel=ComponentFactory.createComponentModelByType(component.type,component);cc.add(componentModel);selectedRow.addNewComponent(componentModel);};if(newLine){this.addLine(newLine);}
if(newProjectVariables){ProjectModel.instance.get('options').set('projectVariables',newProjectVariables,{silent:true});}
return cc;},cutComponents:function(data){var components=data.components;var deletedLayersIds=data.deletedLayersIds;var cc=new ComponentCollection();for(var i=0;i<components.length;i++){var component=components[i];var componentModel=this.getComponentModelByActionkey(component.actionkey);cc.add(componentModel);if(componentModel){this.deleteComponentModel(componentModel);}};this.removeLayersByIds(deletedLayersIds);return cc;},pasteComponents:function(data){return this.addComponents(data);},moveComponentsToLayer:function(data){var _that=this;var selectedRow=this.getRowModelByLineId(data.rowId);var newLine=data.newLine;var lastLineId=data.lastLineId;var lastComponentId=data.lastComponentId;var position=data.position;var deletedLayersIds=data.deletedLayersIds;_log('selectedRow',selectedRow);this.get('options').set('lastLineId',lastLineId,{silent:true});this.get('options').set('lastComponentId',lastComponentId,{silent:true});var components=data.components;var cc=new ComponentCollection();for(var i=0;i<components.length;i++){var component=components[i];var componentModel=this.getComponentModelByActionkey(component.actionkey);cc.add(componentModel);};var objects=selectedRow.get('objects');var dIndex=0;cc.each(function(m1){objects.each(function(m2){if(m1.cid==m2.cid){var index=objects.indexOf(m2);if(index<position){dIndex++;}}});});dIndex=dIndex>0?dIndex-1:0;var newPosition=position-dIndex;_log('dIndex',dIndex,_log.error);_log('oldPosition',position,_log.error);_log('newPosition',newPosition,_log.error);var sortedCC=this.getSortedComponentsCollection(cc);for(var i=0;i<cc.length;i++){var cModel=cc.at(i);this.removeComponentModelFromCollection(cModel);};for(var i=sortedCC.length-1;i>=0;i--){var cModel=sortedCC.at(i);selectedRow.get('objects').add(cModel,{at:newPosition});};this.removeLayersByIds(deletedLayersIds);if(newLine){this.addLine(newLine);}
return cc;},sortRows:function(data){var rowId=parseInt(data.rowId);var position=parseInt(data.position);if(!_.isNumber(rowId)){return false;}
if(!_.isNumber(position)){return false;}
var rowModel=this.getRowModelByLineId(rowId);if(!rowModel){return false;}
_log('sortRows rowModel',rowModel);this.get('lines').remove(rowModel);this.get('lines').add(rowModel,{at:position});return true;},updateRowOptions:function(data){var rowOptions=data.rowOptions;var id=rowOptions.id;var rowModel=this.getRowModelByLineId(id);if(!rowModel){return false;}
for(var item in rowOptions){var options=rowModel.get('options');options.set(item,rowOptions[item],{silent:true});};return rowModel;},updatePageOptions:function(data){var pageOptions=data.pageOptions;if(!_.isObject(pageOptions)){return false;}
var pageOptionsModel=this.get('options');_log('updatePageOptions',pageOptionsModel,_log.timeline);var changed=[];pageOptionsModel.onlyRefresh=true;for(var item in pageOptions){if(pageOptionsModel.get(item)!=pageOptions[item]){_log('changed '+item,pageOptions[item]);changed.push(item);pageOptionsModel.set(item,pageOptions[item]);}}
pageOptionsModel.onlyRefresh=false;_log('updatePageOptions',pageOptionsModel,_log.error);return changed;},});var PageCollection=Backbone.Collection.extend({model:PageModel,getPageModelByPageId:function(pageId){var pageModel=false;this.each(function(model){if(model.get('options').get('pageid')==pageId){pageModel=model;}});return pageModel;}});;;var PageItemView=ItemView.extend({tagName:'li',className:'page',template:_.template($('#page-template').html()),pageSelectedByListTemplate:_.template($('#page-selected-by-list-template').html()),dinamicPageThumbEl:undefined,dinamicPageThumbExists:undefined,changesWereMade:false,active:false,events:{'click .page-thumb':'onClick','click .dinamic-page-thumb-overlay':'onClick','mousedown':'onMouseDown','mousedown .page-notes':'onMouseDown','drop-item':'dropItem','click .page-show':'changePageShow','click .page-sound':'showPageSoundWindow','click .page-label':'activeEditingPageName','click .page-notes':'pageNote','blur input[name="pagename"]':'changePageName','keyup input[name="pagename"]':'changePageName','change .page-checkbox':'selectPage'},reloadEvents:function(){this.model.get('options').off();this.model.off();this.$el.off();this.createListeners();this.delegateEvents();},copyTrigger:function(){this.$el.trigger('copy-page-trigger',this.model,this);},pasteTrigger:function(pageTrigger){this.model.get('options').set('triggers',JSON.parse(pageTrigger));this.$el.trigger('on-paste-page-trigger',this.model,this);},pageNote:function(){appController.bottomMenuView.$el.find('#menu-bottom-tabs').tabs('option','active',5);appController.bottomMenuView.showMenu();},showContextMenu:function(e){var itemsSelectedNumb=0;this.model.collection.each(function(model){if(model.isSelected){itemsSelectedNumb++;}});if(itemsSelectedNumb<=1){this.unselectAllPages();this.model.isSelected=true;this.model.setCheckboxSelected(true);}
var contextMenuView=new PageContextMenuView({model:this.getModel(),view:this});ContextMenuContainer.addMenu(contextMenuView,e);},updateDinamicPageThumb:function(afterCreate){if(!this.dinamicPageThumbExists){this.createDinamicPageThumb();}
if(this.dinamicPageThumbExists){if(!afterCreate){this.model.changesWereMade=true;}
var thumbHtml=StageView.instance.$el.html().replace(/name="[^"]*"/g,"");this.dinamicPageThumbEl.html(thumbHtml);var options=this.model.get('options').toJSON();var backgroundImageDiv=$('<div></div>',{class:'page-thumb-background-image'}).css({width:options.width+"px",height:options.height+"px",'background-color':options.bgcolor});if(options.image){backgroundImageDiv.css({'background-image':'url("'+__meta__.projects_link+__meta__.ownerID+'/'+__meta__.projectID+'/pre/exported_view/'+options.pageid+'/imgpage/'+options.image+'")'});}
this.dinamicPageThumbEl.prepend(backgroundImageDiv);}},createDinamicPageThumb:function(){var _that=this;if(!this.dinamicPageThumbExists){_log('PAGE PAGE',this);this.model.changesWereMade=false;var zoom=150 / StageView.instance.model.get('options').get('width');var options=this.model.get('options').toJSON();this.dinamicPageThumbEl=$('<div>',{class:'dinamic-page-thumb-container'});this.dinamicPageThumbEl.css({width:'100%',height:'100%',top:0,left:0,position:'absolute','transform':'scale('+zoom+')','transform':'scale('+zoom+')','-moz-transform':'scale('+zoom+')','-ms-transform':'scale('+zoom+')','-o-transform':'scale('+zoom+')','-webkit-transform':'scale('+zoom+')','transform-origin':'0px 0px'});var overlay=$('<div>',{class:'dinamic-page-thumb-overlay'});overlay.css({width:'100%',height:'100%',top:0,left:0,position:'absolute','z-index':5});this.$el.find('.page-thumb').hide();this.$el.find('.dinamic-page-thumb-wrapper').html('');this.$el.find('.dinamic-page-thumb-wrapper').html(this.dinamicPageThumbEl);this.$el.find('.dinamic-page-thumb-wrapper').append(overlay);this.$el.find('.dinamic-page-thumb-wrapper').show();this.dinamicPageThumbExists=true;this.updateDinamicPageThumb(true);}},destroyDinamicPageThumb:function(){if(this.dinamicPageThumbExists){this.dinamicPageThumbEl.remove();this.$el.find('.dinamic-page-thumb').remove();this.$el.find('.dinamic-page-thumb-wrapper').hide();this.dinamicPageThumbEl=undefined;this.dinamicPageThumbExists=false;}},selectPage:function(e){var selected=$(e.target).is(':checked');this.model.isSelected=selected;},unselectAllPages:function(){this.model.collection.each(function(model){model.isSelected=false;model.setCheckboxSelected(false);model.view.closeSettingsWindows();});this.$el.trigger('unselect-all-pages');},dropItem:function(event,index){this.$el.trigger('update-sort',[this.model,index]);},onClick:function(e){if(e.shiftKey){var pagesCollection=this.model.collection;var indexModel=pagesCollection.indexOf(this.model);var chFrom=0;var chTo=0;var check=false
for(var i=indexModel;i>=0;i--){var model=pagesCollection.at(i);if(model.isSelected){chFrom=i;chTo=indexModel;check=true;break;}}
if(!check){for(var i=indexModel;i<this.model.collection.length;i++){var model=pagesCollection.at(i);if(model.isSelected){chFrom=indexModel;chTo=i;check=true;break;}}}
if(check){pagesCollection.each(function(model,iModel){if((iModel<chFrom)||(iModel>chTo)){model.isSelected=false;model.setCheckboxSelected(false);}else{model.isSelected=true;model.setCheckboxSelected(true);}});}}else if(e.ctrlKey){if(this.model.isSelected){this.model.isSelected=false;this.model.setCheckboxSelected(false);}else{this.model.isSelected=true;this.model.setCheckboxSelected(true);}}else{this.unselectAllPages();this.model.isSelected=true;this.model.setCheckboxSelected(true);this.setPage();}},unsetPageComing:function(login){var selectedBy=this.model.get('options').get('selectedBy');for(var i=0;i<selectedBy.length;i++){var item=selectedBy[i];if(item.login==login){selectedBy.splice(i,1);this.model.get('options').set('selectedBy',selectedBy,{silent:true});this.renderSelectedBy();}};},unsetPage:function(){},setPage:function(){this.trigger('setpage',this.model,this);},setSectionBy:function(){},initialize:function(){this.createListeners();},createListeners:function(){var _that=this;this.model.get('options').view=this;this.model.view=this;this.addModelEvents();this.model.on('update-pagethumb',this.updatePagethumb,this);this.model.off('update-dintamic-page-thumb');this.model.on('update-dintamic-page-thumb',function(){clearTimeout(_that.pageThumbTimeout);_that.pageThumbTimeout=setTimeout(function(){_that.updateDinamicPageThumb();},50);});this.model.get('options').on('update-dintamic-page-thumb',function(){clearTimeout(_that.pageThumbTimeout);_that.pageThumbTimeout=setTimeout(function(){_that.updateDinamicPageThumb();},50);});this.$el.on('data-picker-picked-page',this.dataPickerPicked,this);this.model.on('selected-by-miniature',this.renderSelectByMinaiture,this);this.model.off("selected-by-trigger");this.model.on("selected-by-trigger",this.renderSelectByTrigger,this);this.model.get('options').on("change",this.savePageOptions,this);this.listenTo(this.model,'checkbox-selected',this.renderSelectedCheckbox);this.listenTo(this.model.get('options'),'change:pagename',this.renderPageName);this.listenTo(this.model.get('options'),'change:active',this.onChangePageShow);this.listenTo(this.model.get('options'),'change:note',this.changeNoteIcon);this.listenTo(this.model.get('options'),'change:image',this.onImageChanged);this.listenTo(this.model.get('options'),'change:soundfilename',this.onSoundChanged);},updatePagethumb:function(){var _that=this;this.model.changesWereMade=false;var pageOptions=_that.model.get('options').toJSON();_log('updatePagethumb',pageOptions);var thumPath=__meta__.projects_link+__meta__.ownerID+"/"+__meta__.projectID+"/pre/exported_view/"+pageOptions.pageid+"/pagethumb.jpg?r="+new Date().getUTCMilliseconds();var loadQueue=new createjs.LoadQueue();loadQueue.on("complete",function(){_that.$el.find('.page-thumb').css({'background-image':"url('"+thumPath+"')"}).show();_that.destroyDinamicPageThumb();});loadQueue.loadFile(thumPath);},onImageChanged:function(){this.updateDinamicPageThumb();},onSoundChanged:function(){this.render();},changeNoteIcon:function(){var note=this.model.get('options').get('note');if(note===''){this.$el.find('.page-notes').removeClass('page-notes-on');}else{this.$el.find('.page-notes').addClass('page-notes-on');}},renderSelectedCheckbox:function(value){this.$el.find('.page-checkbox').prop('checked',value);},renderPageName:function(){var options=this.model.get('options');var pageName=options.get('pagename');this.$el.find('.page-label').text(pageName);},dataPickerPicked:function(){this.trigger('data-picker-picked',this.model,this);},addModelEvents:function(){var _that=this;this.model.on('set-active',function(value){_that.setActive(value);});},showPageSoundWindow:function(e){var _that=this;var windowPosition={top:e.pageY,left:e.pageX};var options=this.model.get('options');if(this.pageSoundSettingView==undefined){this.pageSoundSettingView=new PageSoundSettingWindow({model:options});this.pageSoundSettingView.on('on-close',function(){_that.pageSoundSettingView=undefined;});this.pageSoundSettingView.on('delete-sound',function(model){_that.deleteSound(model);});var dataToRender={pageModel:options.toJSON()};$('body').append(this.pageSoundSettingView.render(dataToRender).$el);this.pageSoundSettingView.setWindowPosition(windowPosition);}},activeEditingPageName:function(e){var options=this.model.get('options');var pageName=options.get('pagename');var pageInput=$('<input name="pagename"  onfocus="this.value = this.value;" type="text" value="'+pageName+'">');$(e.target).html('').append(pageInput);pageInput.focus();},changePageName:function(e){var _that=this;var pageName=undefined;clearTimeout(this.changePageNameTO);this.changePageNameTO=setTimeout(function(){switch(e.type){case'focusout':pageName=$(e.target).val();break;case'keyup':if(e.keyCode===27||e.keyCode===13){pageName=$(e.target).val();}
break;}
if(pageName!=undefined){_that.setPageName(pageName);}},10);},setPageName:function(name){var options=this.model.get('options');options.set('pagename',name);this.$el.find('.page-label').text(name);},changePageShow:function(e){var options=this.model.get('options');var active=parseInt(options.get('active'));if(active===1){options.set('active',0);}else{options.set('active',1);}},onChangePageShow:function(e){var options=this.model.get('options');var active=parseInt(options.get('active'));if(active===0){this.$el.find('.page-show').addClass('page-hide');}else{this.$el.find('.page-show').removeClass('page-hide');}},setActive:function(value){this.active=value;this.$el.attr('active',value);},render:function(){var pageCollection=this.model.collection;var order=0;if(pageCollection!=undefined){var order=pageCollection.indexOf(this.model)+1;}
var options={options:this.model.get('options').toJSON(),isSelected:this.model.isSelected,order:order}
var pageTemplate=this.template(options);this.$el.html(pageTemplate);this.renderSelectedBy();this.delegateEvents();this.dinamicPageThumbExists=false;this.addTitleToButtons();return this;},addTitleToButtons:function(){this.$el.find('[title]').tooltip({html:true,animated:'fade',placement:'right',width:300,height:200});},deleteSound:function(pageOptionsModel){var _that=this;_log('updatePageOptions',_that.model.get('options'),_log.dataaccessIn);if(pageOptionsModel.onlyRefresh){return;}
DataAccess.updatePageOptions({pageOptions:pageOptionsModel,action:'delete-page-sound',pageId:_that.model.getPageId()},function(data){_log('Update page options result: ',data,_log.dataaccessOutResult)},function(data){_log('Update page options fault: ',data,_log.dataaccessOutFault)});},savePageOptions:function(){var _that=this;var pageOptionsModel=_that.model.get('options');_log('updatePageOptions',pageOptionsModel,_log.dataaccessIn);if(pageOptionsModel.onlyRefresh){return;}
var picked=[];for(var item in pageOptionsModel.changed){picked.push(item);}
_log('picked',picked,_log.dataaccessIn);var shortedPageOptions=_.pickFromArray(pageOptionsModel.toJSON(),picked);_log('shortedPageOptions',shortedPageOptions,_log.dataaccessIn);DataAccess.updatePageOptions({pageOptions:pageOptionsModel,pageId:_that.model.getPageId()},function(data){_log('Update page options result: ',data,_log.dataaccessOutResult)},function(data){_log('Update page options fault: ',data,_log.dataaccessOutFault)});},renderSelectByMinaiture:function(value){this.$el.attr('selected-by-miniature',value);},renderSelectByTrigger:function(value){this.$el.attr('selected-by-trigger',value);},renderSelectedBy:function(){},closeSettingsWindows:function(){if(this.pageSoundSettingView!=undefined){this.pageSoundSettingView.remove();this.pageSoundSettingView=undefined;}},renderFlip:function(){},beforeDestroy:function(){},destroy:function(){this.beforeDestroy();this.unbind();this.remove();},});;;var LoadedItemPageView=PageItemView.extend({events:function(){return _.extend({},PageItemView.prototype.events,{'dragenter':'onFileDragOver','dragleave .loaded-dropzone':'onFileDragOut','drop .loaded-dropzone':'uploadOnFileDrop'});},onFileDragOver:function(e){e.stopPropagation();this.$el.find('.loaded-dropzone').fadeIn(200);},onFileDragOut:function(e){e.stopPropagation(e);this.$el.find('.loaded-dropzone').fadeOut(200);},getAcceptTypeFormat:function(){return this.model.get('options').getAcceptTypeFormat();},getDropProperties:function(e){var imageUrl;var file=e.originalEvent.dataTransfer.files[0];var data;if(file!=undefined){var imageName=file.name;var imageData=e.originalEvent.dataTransfer.result;data={name:imageName,data:imageData,size:file.size};}else{imageUrl=e.originalEvent.dataTransfer.getData('text');}
return{file:file,data:data,imageUrl:imageUrl};},uploadOnPaste:function(e,blob,resizeImage){var _that=this;if(!StageView.instance.canEdit){return;}
if(this.model.get('locked')){return;}
this.resizeImage=resizeImage;var reader=new FileReader();reader.onload=function(e){var data={name:'copyimage.png',data:event.target.result,size:blob.size};_that.runUploadProcess({file:blob,data:data});};reader.readAsDataURL(blob);},getInputProperties:function(e,input){return FileUploader.getInputProperties(e,input);},uploadOnClick:function(){var _that=this;var acceptTypeFormat=this.getAcceptTypeFormat();var input=$('<input type="file" name="files[]" accept="'+acceptTypeFormat+'">');input.css({display:'none'});this.$el.append(input);input.click();input.change(function(e){_that.uploadOnInputData(e,this,false);$(this).remove();});},uploadOnFileDrop:function(e,resizeImage){if(Utils.isDarkanExtension(e)){return;};if(!StageView.instance.canEdit){return;}
this.resizeImage=resizeImage;this.$el.find('.loaded-dropzone').fadeOut(500);var properties=this.getDropProperties(e);var imageUrl=properties.imageUrl;if(imageUrl!=undefined){this.uploadOnLink(imageUrl,resizeImage);}else{this.runUploadProcess(properties);}},createLoaderImage:function(){var img=$('<img>');img.attr('src','content_template/css/gif-load.gif');img.addClass('page-item-loader-link');return img;},uploadOnLink:function(imageUrl,resizeImage){if(!StageView.instance.canEdit){return;}
if(this.model.get('locked')){return;}
this.resizeImage=resizeImage;var _that=this;var img=this.createLoaderImage();this.$el.append(img);DataAccess.convertLinkToImage({imageUrl:imageUrl,pageId:StageView.instance.model.get('options').get('pageid')},function(data){_that.$el.find('.page-item-loader-link').remove();_that.model.get('options').set('image',data.fileName);},function(data){_that.$el.find('.page-item-loader-link').remove();});},uploadOnInputData:function(e,input,resizeImage){this.resizeImage=resizeImage;var properties=this.getInputProperties(e,input);this.runUploadProcess(properties);},runUploadProcess:function(properties){if(this.model.get('options').uploadingNow){return;}
var specialData=this.getSpecialProperties();var toSend=$.extend({},properties,specialData);this.fileUploader=FileUploader.create(properties.data.name,this.model.get('options'),this);if(this.fileUploader==undefined){this.showPupup({content:_lang('FILETYPE_NOT_ACCEPTED'),title:_lang('MODAL_INFO_ERROR')},this);return;}
this.fileUploader.sendFile(toSend);this.fileUploader.on('on-result',this.onResult,this);this.fileUploader.on('on-fault',this.onFault,this);this.fileUploader.on('on-complete',this.onComplete,this);this.fileUploader.on('on-progress',this.onProgress,this);},onResult:function(data){if(data.key==1){this.showPupup({content:_lang('FILETYPE_NOT_ACCEPTED'),title:_lang('MODAL_INFO_ERROR')},this);return;}},onFault:function(data){this.showPupup({content:_lang('FILETYPE_NOT_ACCEPTED'),title:_lang('MODAL_INFO_ERROR')},this);},showPupup:function(data,sender){var popup=PopupFactory.createErrorPopup(data,sender);$('body').append(popup.render(data).$el);},onComplete:function(data){var _that=this;this.hideProgressPercent(data);this.model.updatePagethumb();this.fileUploader.off();this.fileUploader=undefined;setTimeout(function(){_that.model.updateDinamicPageThumb();},100);},onProgress:function(data){this.showProgressPercent(data);},getSpecialProperties:function(){return{};},showProgressPercent:function(data){FileUploader.showProgressPercent(data,this);},hideProgressPercent:function(data){FileUploader.hideProgressPercent(data,this);},openImageWindow:function(){var _that=this;var sender=this;var activeTab=0;var imageWindow=WindowFactory.createImageWindow(activeTab,_that.model.view);imageWindow.on('on-close',function(fileData){_that.imageWindow=undefined;});imageWindow.on('imageupload-ondrop',function(fileData){_that.model.view.uploadOnFileDrop(fileData,true);});imageWindow.on('imageupload-onclick',function(fileData,input){_that.model.view.uploadOnInputData(fileData,input,true);});imageWindow.on('imageupload-link',function(imageUrl){_that.model.view.uploadOnLink(imageUrl,true);});imageWindow.on('imageupload-on-paste',function(event,blob){_that.model.view.uploadOnPaste(event,blob,true);});$('body').append(imageWindow.render().$el);imageWindow.$el.find('.darkan-tabs').tabs("option","active",activeTab);this.imageWindow=imageWindow;},});;;var PagesListView=Backbone.View.extend({el:".pages",selectedPageModel:null,initialize:function(data){this.collection=data.collection;$('#pages-list-wrapper').perfectScrollbar({useKeyboard:false,suppressScrollX:true});},events:{},clearList:function(){this.collection.reset();this.render();},render:function(){this.$el.html("");if(this.collection!=undefined){this.collection.each(this.addPageItem,this);this.$el.sortable({delay:50,update:function(event,ui){ui.item.trigger('drop-item',ui.item.index());}});var activePageModel=this.getActivePage(User.getModel().get('activePageId'));this.setActivePageModel(activePageModel);}
return this;},getActivePage:function(pageId){var activePageModel;this.collection.each(function(pModel,index){if(pModel.get('options').get('pageid')==pageId){activePageModel=pModel;}});return activePageModel;},loadProject:function(collection,firstPageModel){this.collection=collection;this.render();if(firstPageModel!=undefined){firstPageModel.view.setPage();this.setActivePageModel(firstPageModel);firstPageModel.view.setSectionBy();}},getSelectedPageModel:function(){return this.selectedPageModel;},addCopyPage:function(pageListToCopy,userId,projectId){var _that=this;var oldPageId=this.selectedPageModel==undefined?undefined:this.selectedPageModel.get('options').get('pageid');StageView.instance.createPageThumb(function(){DataAccess.copyPage({pageListToCopy:pageListToCopy,sourceUserId:userId,sourceProjectId:projectId,oldPageId:oldPageId},function(data){_that.onPageCopiedResult(data)},_that.onPageCopiedFault);});},onPageCopiedResult:function(data){this.trigger('on-copy-page',data,this);},onPageCopiedFault:function(data){_log('Copy page failed:',data)},addPageItem:function(pageModel){var _that=this;var pageItemView=new LoadedItemPageView({model:pageModel});this.$el.append(pageItemView.render().el);pageItemView.on('setpage',function(model,sender){if(_that.collection.length>1){var activePageModel=_that.getActivePage(User.getModel().get('activePageId'));_log('activePageModel',activePageModel,_log.timeline)
if(activePageModel!=undefined&&activePageModel.cid!=model.cid){if(activePageModel.view!=undefined){activePageModel.view.unsetPage();}
_that.setActivePageModel(model);_that.selectedPageModel=model;model.view.setSectionBy();_that.trigger('onsetpage',model);}}});pageItemView.on('data-picker-picked',function(model){_that.trigger('data-picker-picked',model);});this.selectedPageModel=pageModel;},selectPageModel:function(lastPageModel){this.collection.each(function(model){if(model.cid!=lastPageModel.cid){model.isSelected=false;}else{model.isSelected=true;}});this.render();},setActivePageModel:function(model){this.collection.each(function(pageModel){pageModel.setActive(false);});if(model!=undefined){User.getModel().set('activePage',model);User.getModel().set('activePageId',model.get('options').get('pageid'));model.setActive(true);this.selectedPageModel=model;}},getPageModelByPageId:function(pageId){var pageModel;this.collection.each(function(model){if(model.get('options').get('pageid')==pageId){pageModel=model;}});return pageModel;},getPageIndexByPageModel:function(pageModel){var index=this.collection.indexOf(pageModel);return index;},getIdsFromSelectedPages:function(pageCollection){var pageIdsListToCopy=[];pageCollection.each(function(model){if(model.isSelected){console.log('kopiuje strone');pageIdsListToCopy.push(model.get('options').get('pageid'));}});return pageIdsListToCopy;},unsetAllPagesComing:function(login){this.collection.each(function(model){model.view.unsetPageComing(login);});},unsetSelectionBy:function(){}});;;var FirstPagesListView=PagesListView.extend({copiedPageTrigger:[],events:function(){return _.extend({},PagesListView.prototype.events,{'update-sort':'updateSort','copy-page-trigger':'copyTrigger','on-paste-page-trigger':'onPasteTrigger'});},resetList:function(){this.copiedPageTrigger=[];},onPasteTrigger:function(event,model){if(this.selectedPageModel.cid==model.cid){this.trigger('onsetpage',model);}},copyTrigger:function(event,model){this.copiedPageTrigger=JSON.stringify(model.toJSON().options.triggers);},updatePageSortComing:function(data){var _that=this;this.onUpdatePageSortResult(data);this.render();},updateSort:function(event,pageModel,position){var _that=this;var pageId=pageModel.get('options').get('pageid');DataAccess.updatePageSort({pageId:pageId,position:position},function(data){_log('Update page successed: ',data,_log.dataaccessOutResult);_that.collection.remove(pageModel);_that.collection.add(pageModel,{at:position});},function(data){_log('Update page failed: ',data,_log.dataaccessOutFault);});},onUpdatePageSortResult:function(data){var pageId=parseInt(data.pageId);var position=parseInt(data.position);if(!_.isNumber(pageId)){return;}
if(!_.isNumber(position)){return;}
var pageModel=this.getPageModelByPageId(pageId);if(!pageModel){return;}
this.collection.remove(pageModel);this.collection.add(pageModel,{at:position});this.render();},getMap:function(){var pages=[];this.collection.each(function(pModel,index){pages.push(pModel.get('options').get('pageid'));});var map=new ProjectMap();map.set('pages',pages);return map;},getPagesMap:function(){var pages=[];this.collection.each(function(pModel,index){pages.push(pModel.get('options').get('pageid'));});return pages;},updatePageOptionsComing:function(pageOptions){var pageId=pageModel.get('options').get('pageid');this.collection.each(function(pModel,index){if(pModel.get('options').get('pageid')==pageId){pModel.set('options',pageOptions,{silent:true});pModel.view.renderSelectedBy();}},this);},updatePageModelComing:function(pageModel){var _that=this;var pageId=pageModel.get('options').get('pageid');var actualPageModel;this.collection.each(function(pModel,index){if(pModel.get('options').get('pageid')==pageId){actualPageModel=pModel;var pageOptions1=pageModel.get('options').toJSON();for(var item in pageOptions1){pModel.get('options').set(item,pageOptions1[item],{silent:true});}
pModel.set('lines',pageModel.get('lines'),{silent:true});pModel.set('draw',pageModel.get('draw'),{silent:true});}},this);return actualPageModel;},addNewBlankPage:function(newPageModel,setPage,onResult,onFault,setingOldPageId){var _that=this;setPage=setPage==undefined?true:setPage;var oldPageId=this.selectedPageModel==undefined?undefined:this.selectedPageModel.get('options').get('pageid');if(setingOldPageId){oldPageId=setingOldPageId;}
_log('oldPageId',oldPageId);var pages=_that.getPagesMap();DataAccess.createBlankPage({oldPageId:oldPageId,page:newPageModel,map:{pages:pages}},function(data){_log('Create page successed: ',data,_log.dataaccessOutResult);var pageModel=_that.onCreateBlankPage(data);if(setPage){_that.selectedPageModel=pageModel;_that.trigger('on-page-are-created',pageModel);}
if(onResult!=undefined){onResult(pageModel);}},function(data){console.log('Create page failed: ',data);if(onFault!=undefined){onFault(data);}});},onCreateBlankPage:function(data){var _that=this;var pageModel=ProjectModel.instance.createPageModel(data.page);var lastPageId=parseInt(data.lastPageId);ProjectModel.instance.get('options').set('last_page_id',lastPageId,{silent:true});var oldPageId=data.oldPageId;if(oldPageId!=undefined){var oldPageIndex=data.oldPageIndex;_that.collection.add(pageModel,{at:oldPageIndex});}else{_that.collection.add(pageModel);}
DarkanEditorAplicationAPI.getInstance().pageAdded({pagesLength:_that.getPagesLength()});_log('_that.collection',_that.collection.toJSON());ProjectModel.instance.set('collection',_that.collection);_that.render();return pageModel;},addCopyPageComing:function(data){var oldPageId=data.oldPageId;var oldPageModel=this.getPageModelByPageId(oldPageId);var oldPageIndex=this.getPageIndexByPageModel(oldPageModel)+1;for(var i=data.pages.length-1;i>=0;i--){var copyPageModel=this.model.createPageModel(data.pages[i]);this.collection.add(copyPageModel,{at:oldPageIndex});};this.render();return this.collection;},getPagesLength:function(){return this.collection.length;},deletePage:function(pageCollection,selectedPageModel,onResult,onFault){var _that=this;},deletePageFromListComing:function(pageId){var _that=this;var activePageModel=this.getActivePage(User.getModel().get('activePageId'));var selectedPageModel;this.collection.each(function(pModel,index){if(pModel!=undefined){if(pModel.get('options').get('pageid')==pageId){_log('activePageModel',activePageModel.cid);_log('pModel',pModel.cid);if(pModel.cid==activePageModel.cid){var index=_that.collection.indexOf(activePageModel);selectedPageModel=_that.collection.at(index-1);}else{selectedPageModel=activePageModel;}
_that.collection.remove(pModel);_that.render();}}});if(selectedPageModel==undefined){selectedPageModel=this.collection.first();}
this.selectedPageModel=selectedPageModel;DarkanEditorAplicationAPI.getInstance().pagesRemoved({pagesLength:this.getPagesLength(),comming:true});return selectedPageModel;}});;;var SecondPageItemView=PageItemView.extend({tagName:'li',className:'page',template:_.template($('#second-page-template').html()),events:{'click .page-thumb':'onClick','click .dinamic-page-thumb-overlay':'onClick','mousedown':'onMouseDown','change .page-checkbox':'selectPage'},showContextMenu:function(e){var itemsSelectedNumb=0;this.model.collection.each(function(model){if(model.isSelected){itemsSelectedNumb++;}});if(itemsSelectedNumb<=1){this.unselectAllPages();this.model.isSelected=true;this.model.setCheckboxSelected(true);}
var contextMenuView=new SecondPageContextMenuView({model:this.getModel(),view:this});ContextMenuContainer.addMenu(contextMenuView,e);},updateDinamicPageThumb:function(){return},createDinamicPageThumb:function(){return},destroyDinamicPageThumb:function(){return}});;;var SecondPagesListView=PagesListView.extend({el:"#other-projects-container",selectedPageModel:null,events:{'change .second-pages-list-select':'secondPagesListChanged','click .second-pages-list-copy-page':'copyPages','click .select-all-pages':'selectedAllPages','click .second-pages-list-open-page':'openInNewTab'},initialize:function(data){this.$el.find('#second-pages-list-wrapper').perfectScrollbar();var userProjectData=data.data.userProjectData;var shareProjectData=data.data.shareProjectData;var shareTemplateProjectData=data.data.shareTemplateProjectData;var templateProjectData=data.data.templateProjectData;var secondPagesListSelect=$('.second-pages-list-select');var firstOption=$('<option />').html(_lang('TOOLBAR_OPEN_SECOND_SELECT_TITLE'));secondPagesListSelect.append(firstOption);this.loadSelect(_lang('TOOLBAR_SECOND_PROJECT_SELECT_MINE'),userProjectData,secondPagesListSelect);this.loadSelect(_lang('TOOLBAR_SECOND_PROJECT_SELECT_MINE_TEMPLATES'),templateProjectData,secondPagesListSelect);this.loadSelect(_lang('TOOLBAR_SECOND_PROJECT_SELECT_SHARED'),shareProjectData,secondPagesListSelect);this.loadSelect(_lang('TOOLBAR_SECOND_PROJECT_SELECT_SHARED_TEMPLATES'),shareTemplateProjectData,secondPagesListSelect);this.$el.find('.second-pages-list-select').chosen({width:'130px'});},openInNewTab:function(){var select=this.$el.find('.second-pages-list-select');var projectId=select.val();var userId=select.find(':selected').attr('userid');var href=window.location.href;var arr=href.split('/');arr[arr.length-1]=projectId;href=arr.join('/');window.open(href,'_blank');},selectedAllPages:function(){var pagesCollection=this.collection;var setActive=true;var _act=true;var _uni=true;pagesCollection.each(function(childModel,index){if(index==0){_act=childModel.isSelected;}
if(_uni&&_act!==childModel.isSelected){_uni=false;}});if(_uni){if(_act==false)
setActive=true;else
setActive=false;}
pagesCollection.each(function(childModel){childModel.isSelected=setActive;childModel.setCheckboxSelected(setActive);});},copyPages:function(){var _that=this;var select=this.$el.find('.second-pages-list-select');var projectId=select.val();var userId=select.find(':selected').attr('userid');var pageIdsListToCopy=this.getIdsFromSelectedPages(this.collection);this.addCopyPage(pageIdsListToCopy,userId,projectId);},addCopyPage:function(pageListToCopy,userId,projectId){var _that=this;var oldPageId=User.getModel().get('activePageId');DataAccess.copyPage({pageListToCopy:pageListToCopy,sourceUserId:userId,sourceProjectId:projectId,oldPageId:oldPageId},function(data){_that.onPageCopiedResult(data)},_that.onPageCopiedFault);},secondPagesListChanged:function(e){var sender=$(e.target);var projectId=sender.val();var userId=sender.find(':selected').attr('userid');var openPageButton=this.$el.find('.second-pages-list-open-page');if(projectId!=''){openPageButton.removeAttr('disabled');}else{openPageButton.attr('disabled','disabled');}
this.clearList();this.trigger('get-project-by-id',{projectId:projectId,userId:userId});},loadSelect:function(group,list,select){var optionGroup=$('<optgroup>',{label:group});select.append(optionGroup);for(var i=0;i<list.length;i++){var item=list[i];var option=$('<option />').html(item.name).val(item.project_id).attr('userid',item.user_id)
optionGroup.append(option);};},clearList:function(){if(this.collection){this.collection.reset();this.render();}},render:function(){this.$el.find('.second-pages').html("");this.collection.each(this.addPageItem,this);return this;},addPageItem:function(pageModel){var _that=this;var secondPageView=new SecondPageItemView({model:pageModel});secondPageView.on('setpage',function(model,sender){_that.trigger('onsetpage',model);});this.$el.find('.second-pages').append(secondPageView.render().el);this.selectedPageModel=pageModel;},showList:function(collection){this.collection=collection;this.render();}});;;var DarkanApp=Backbone.View.extend({events:{},initialize:function(){},render:function(){return this;},getBlankPageModel:function(){var lines=new TimelineRowCollection([new TimelineRowModel({objects:new TimelineItemCollection([])})]);var pageModel=new PageModel({lines:lines});return pageModel;}});;;var StageSelector=Backbone.View.extend({scc:new ComponentCollection(),initialize:function(){},start:function(){this.startListenOnSelectComponentsByUser();this.scc.on('add',this.onAdd,this);this.scc.on('remove',this.onRemove,this);this.scc.on('reset',this.onReset,this);this.scc.on('add remove reset',this.onChange,this);},endEditing:function(){this.scc.each(function(cModel){if(cModel.view){cModel.view.endEditing();}});},selectOneComponent:function(cModel,e){var _that=this;e=e||{};var scc=this.scc;this.add(cModel,e.shiftKey);},selectMultiComponents:function(cModel,e){var _that=this;e=e||{};var scc=this.scc;this.addMulti(cModel,true);},selectMultiComponentsSilent:function(cModel,e){var _that=this;e=e||{};var scc=this.scc;this.addMultiSilent(cModel,true);},add:function(cModel,shiftKey){if(cModel.get('locked')){return;}
if(shiftKey){if(this.scc.contains(cModel)){this.scc.remove(cModel);return;}else{this.scc.add(cModel);return;}}
this.reset();this.scc.add(cModel);},addMulti:function(cModel,shiftKey){if(cModel.get('locked')){return;}
if(cModel.get('hidden')){return;}
this.scc.add(cModel);},addMultiSilent:function(cModel,shiftKey){if(cModel.get('locked')){return;}
this.scc.add(cModel,{s:true});},remove:function(cModel){this.scc.remove(cModel);},reset:function(){this.scc.each(this.onRemove,this);this.scc.reset();},onAdd:function(cModel,cc,params){cModel.setActive(true,this.scc,params);},onRemove:function(cModel,i){cModel.setActive(false);},onReset:function(models){},onChange:function(cModel,cc,params){_log('onChange',params);this.trigger('change',this.scc,params);},createSelector:function(e){var _that=this;this.selection=$('<div>').addClass('selection-box');this.$el.append(this.selection);var offset=this.$el.offset();var scrollTopStart=_that.$el.scrollTop();var scrollLeftStart=_that.$el.scrollLeft();_log('scrollTopStart',scrollTopStart);_log('offset',offset);var click_x=e.pageX-offset.left-5+scrollLeftStart;var click_y=e.pageY-offset.top-5+scrollTopStart;_that.selection.css({'top':click_y+'px','left':click_x+'px','width':'0px','height':'0px'});$('body').on('mousemove',function(e){var scrollTop=_that.$el.scrollTop();var scrollLeft=_that.$el.scrollLeft();var move_x=e.pageX-offset.left+scrollLeft-5;var move_y=e.pageY-offset.top+scrollTop-5;var width=Math.abs(move_x-click_x),height=Math.abs(move_y-click_y),new_x,new_y;new_x=(move_x<click_x)?(click_x-width):click_x;new_y=(move_y<click_y)?(click_y-height):click_y;_that.selection.css({'width':width,'height':height,'top':new_y,'left':new_x});}).one('mouseup',function(e){_that.reset();var w=parseInt(_that.selection.css('width'));var h=parseInt(_that.selection.css('height'));if(w>=5||h>=5){_that.findComponents(_that.selection);}
$('body').off('mousemove');_that.selection.remove();});},findComponents:function(selection){var _that=this;var scrollTop=this.$el.scrollTop();var scrollLeft=this.$el.scrollLeft();var stageOffset=this.$el.find('.stage-view').offset();var menuLeftWidth=$('#menu-left').width();var menuTopHeight=$('#menu-top-tabs').height();var stageViewPaddingTop=parseInt(this.$el.css('padding-top'));var stageViewPaddingLeft=parseInt(this.$el.css('padding-left'));if(scrollLeft==0){stageViewPaddingLeft=stageOffset.left-menuLeftWidth;}
var x1=parseInt(selection.css('left'))+scrollLeft;var y1=parseInt(selection.css('top'))+scrollTop;var x2=parseInt(selection.css('width'))+x1;var y2=parseInt(selection.css('height'))+y1;var htmlObjectsArray=[];this.$el.find('.component').each(function(){var actualX1=parseInt($(this).css('left'))+scrollLeft+stageViewPaddingLeft;var actualY1=parseInt($(this).css('top'))+stageViewPaddingTop+scrollTop;var actualX2=parseInt($(this).css('width'))+actualX1;var actualY2=parseInt($(this).css('height'))+actualY1;var allObject=true;var corner1=_that.checkPosition(actualX1,actualY1,x1,y1,x2,y2);var corner2=_that.checkPosition(actualX2,actualY1,x1,y1,x2,y2);var corner3=_that.checkPosition(actualX2,actualY2,x1,y1,x2,y2);var corner4=_that.checkPosition(actualX1,actualY2,x1,y1,x2,y2);if(corner1&&corner2&&corner3&&corner4){htmlObjectsArray.push($(this));}else{if(_that.checkRect(x1,y1,x2,y2,actualX1,actualY1,actualX2,actualY2)){htmlObjectsArray.push($(this));}}});for(var i=0;i<htmlObjectsArray.length;i++){var htmlObject=$(htmlObjectsArray[i]);htmlObject.trigger('multi-select',true);};},checkRect:function(firstX1,firstY1,firstX2,firstY2,secondX1,secondY1,secondX2,secondY2){if(firstX1<secondX2&&firstX2>secondX1&&firstY1<secondY2&&firstY2>secondY1){return true;}
return false;},checkPosition:function(pointX,pointY,x1,y1,x2,y2){if(pointX>=x1&&pointX<=x2&&pointY>=y1&&pointY<=y2){return true;}
return false;},startListenOnSelectComponentsByUser:function(){var _that=this;DataAccess.onSelectComponentsByUser({},function(data){_log('On select Components by user result: ',data,_log.dataaccessOutResult);_that.onSelectComponentsByUser(data);},function(data){_log('On select page by user fault: ',data,_log.dataaccessOutFault);});},onSelectComponentsByUser:function(data){var components=data;this.resetSelectedByUser();if(!_.isObject(components)){return;}
var cc=ProjectModel.instance.getAllComponents();cc.each(function(componentModel){var selectedBy=componentModel.selectedBy||[];if(selectedBy.length>0){var index=selectedBy.indexOf(__meta__.login);selectedBy.splice(index,1);componentModel.selectedBy=selectedBy;}});for(var item in components){var actionkey=item;_log('actionkey',actionkey);if(!_.isString(actionkey)){continue;}
var pageId=parseInt(actionkey.split('-')[2]);var pageModel=ProjectModel.instance.getPageModelByPageId(pageId);_log('onSelectComponentsByUser pageModel',pageModel);if(!pageModel){continue;}
var componentModel=pageModel.getComponentModelByActionkey(actionkey);_log('componentModel',componentModel);if(!componentModel){continue;}
var selectedBy=components[item];var arrSelectedBy=_.pluck(selectedBy,'login');var filterArrSelectedBy=_.filter(arrSelectedBy,function(login){return login!=__meta__.login;});componentModel.selectedBy=filterArrSelectedBy;if(componentModel.view){componentModel.view.renderSelectedBy(filterArrSelectedBy);}};},selectComponentsByUser:function(cc){var actionkeysShort=[];var actionkeys=_.pluck(cc.toJSON(),'actionkey');DataAccess.selectComponentsByUser({pageId:this.model.get('options').get('pageid'),actionkeys:actionkeys});},resetSelectedByUser:function(){this.model.get('lines').each(function(rowModel){rowModel.get('objects').each(function(cModel){cModel.selectedBy=[];cModel.view.renderSelectedBy([]);});});}});;;var EmptyStageView=ItemView.extend({className:'stage-view-wrapper empty-stage-view-wrapper',template:_.template($('#empty-stage-view-template').html()),initialize:function(){},renderStage:function(){var template=this.template(this.serializeData());this.$el.html(template);return this;},render:function(){var template=this.template(this.serializeData());this.$el.html(template);return this;},afterRender:function(){},setModel:function(){},serializeData:function(){return{};},});;;var StageView=ItemView.extend({className:'stage-view-wrapper',template:_.template($('#stage-view-template').html()),canEdit:true,copiedComponentPosition:[],copiedComponentDimensions:[],copiedComponentStyle:{},events:{},bindings:{},initialize:function(){var _that=this;this.selectedComponentsCollection=new ComponentCollection();this.stageSelector=new StageSelector();this.stageSelector.on('change',this.onSelectionChanged,this);this.stageSelector.$el=this.$el;this.stageSelector.scc=this.selectedComponentsCollection;this.stageSelector.model=this.model;this.stageSelector.start();this.timeout=function(){};},selectAllComponents:function(){var _that=this;this.selectedComponentsCollection.reset();this.model.get('lines').each(function(rowModel){rowModel.get('objects').each(function(cModel){_that.stageSelector.selectMultiComponents(cModel);});});},selectOneComponent:function(cModel,e){this.stageSelector.selectOneComponent(cModel,e);},selectMultiComponents:function(cModel){this.stageSelector.selectMultiComponents(cModel);},selectMultiComponentsSilent:function(cModel){this.stageSelector.selectMultiComponentsSilent(cModel);},selectCopmponents:function(cc){this.stageSelector.reset();cc.each(this.stageSelector.selectMultiComponents,this.stageSelector);},unsetActiveComponents:function(){this.stageSelector.reset();},onSelectionChanged:function(scc,params){var _that=this;clearTimeout(this.selectorTimeout);this.selectorTimeout=setTimeout(function(){params=params||{};if(params.s==true){return;}
if(scc.length==0){_that.trigger('on-stage-selected',_that.model);_that.stageSelector.selectComponentsByUser(scc);return;}
if(scc.length==1){_that.trigger('on-component-selected',scc.first());_that.stageSelector.selectComponentsByUser(scc);return;}
if(scc.length>1){_that.trigger('on-components-selected',scc);_that.stageSelector.selectComponentsByUser(scc);return;}},50);},mouseDown:function(e,componentModel){switch(e.button){case 0:this.stageSelector.createSelector(e);break;}},renderZIndex:function(){var zIndex=1;var lines=this.model.get('lines');for(var i=this.model.get('lines').length-1;i>=0;i--){var rowModel=lines.at(i);var objects=rowModel.get('objects');for(var j=objects.length-1;j>=0;j--){var componentModel=objects.at(j);componentModel.setZIndex(zIndex);zIndex++;}};},afterRender:function(){},renderStage:function(){var template=this.template(this.model.toJSON());this.$el.html(template);return this;},render:function(){var _that=this;_log('this.model',this.model);var template=this.template(this.model.toJSON());this.$el.html(template);this.renderBackgroundImage();this.renderDimentions();this.renderScenePosition();this.model.get('lines').each(this.renderSingleLine,this);this.renderStyle();this.updateTimeline();this.selectComponentsOnStart();this.trigger('on-stage-render',this.model);return this;},updateTimeline:function(){this.trigger('update-timeline');},renderBackgroundImage:function(){_log('renderBackgroundImage','',_log.timeline);if(this.model.get('options').get('image')!==''){var appLink=__meta__.APP_LINK;var userId=this.model.ownerId;var projectId=this.model.projectId;var pageId=this.model.get('options').get('pageid');var image=this.model.get('options').get('image');var r='?r='+new Date().getUTCMilliseconds();var path=__meta__.projects_link+userId+'/'+projectId+'/pre/exported_view/'+pageId+'/imgpage/'+image;this.$el.find('.stage-view').css({'background-image':'url(\''+path+'\')','background-repeat':'no-repeat','background-position':'50% 50%','background-size':'100% 100%'});}else{this.$el.find('.stage-view').css('background','');}
this.renderBackgroundColor();},renderDimentions:function(){this.$el.find('.stage-view').css({width:this.model.get('options').get('width')+"px",height:this.model.get('options').get('height')+"px",});},renderScenePosition:function(){var sceneHeight=this.model.get('options').get('height');var top='calc(50% - '+sceneHeight/2+'px)';if(sceneHeight>=_layout.scene_wrapper.height()){top=0;}
this.$el.css({top:top});},renderBackgroundColor:function(color){var bgColor;if(color){bgColor=color;}else{bgColor=this.model.get('options').get('bgcolor')!=''?this.model.get('options').get('bgcolor'):'#FFF';}
_log('bgColor1',bgColor);_log('bgColor2',this.model.get('options').get('bgcolor'));this.$el.find('.stage-view').css('background-color',bgColor);},renderSingleLine:function(lineCollection){lineCollection.get('objects').each(this.renderSingleComponent,this);},renderSingleComponent:function(componentModel){var _that=this;componentModel.ownerId=this.model.ownerId;componentModel.projectId=this.model.projectId;var componentView=ComponentFactory.createComponentByModel(componentModel);this.$el.find('.stage-view').append(componentView.render().$el);componentView.afterRender();componentView.on('select-component',function(cModel,e){_that.selectOneComponent(cModel,e);});componentView.on('save-changes',function(cModel,params){_that.saveComponent(cModel,params);});componentView.on('multi-select',function(cModel){_that.selectMultiComponents(cModel);});componentView.off('data-picker-picked-object');componentView.on('data-picker-picked-object',function(cModel){_that.dataPickerPicked(cModel);});componentView.on('show-popup',function(data,sender){_that.showPupup(data,sender);});componentView.on('show-image-window',function(sender){_that.trigger('show-image-window',sender);});return componentView;},showPupup:function(data,sender){var popup=PopupFactory.createStandardPopup(data,sender);console.log("showPupup",popup);$('body').append(popup.render().$el);},cleanBeforeClose:function(){this.createPageThumb();this.unsetPageSelectionBy();},unsetPageSelectionBy:function(){RightMenuView.instance.pageListView.unsetSelectionBy();},moveActiveComponents:function(e){if(this.selectedComponentsCollection.length){var firstComponentModel=this.selectedComponentsCollection.first();firstComponentModel.view.moveComponent(e);}},hideComponents:function(){this.selectedComponentsCollection.each(function(componentModel){componentModel.set('hidden',true);componentModel.view.forceRender();componentModel.miniatureView.render();componentModel.miniatureView.afterRender();});},showComponents:function(){this.selectedComponentsCollection.each(function(componentModel){componentModel.set('hidden',false);componentModel.view.forceRender();componentModel.miniatureView.render();componentModel.miniatureView.afterRender();});},copyPosition:function(){var firstCopmonentModel=this.selectedComponentsCollection.first();var x=firstCopmonentModel.get('x');var y=firstCopmonentModel.get('y');this.copiedComponentPosition={x:x,y:y}},pastePosition:function(){var _that=this;this.selectedComponentsCollection.each(function(cModel){cModel.pastePosition(_that.copiedComponentPosition,true);});var firstModel=this.selectedComponentsCollection.first();if(firstModel){firstModel.trigger('change',['x','y']);}},copyDimension:function(){var firstCopmonentModel=this.selectedComponentsCollection.first();var width=firstCopmonentModel.get('width');var height=firstCopmonentModel.get('height');this.copiedComponentDimensions={width:width,height:height}},pasteDimension:function(){var _that=this;this.selectedComponentsCollection.each(function(cModel){cModel.pasteDimension(_that.copiedComponentDimensions,true);});var firstModel=this.selectedComponentsCollection.first();if(firstModel){firstModel.trigger('change',['width','height']);}},copyStyle:function(){var firstCopmonentModel=this.selectedComponentsCollection.first();var style=firstCopmonentModel.get('styles');var type=firstCopmonentModel.get('type')
if(style!=undefined){this.copiedComponentStyle[type]=JSON.stringify(style);}},pasteStyle:function(){var _that=this;this.selectedComponentsCollection.each(function(cModel){cModel.pasteStyle(_that.copiedComponentStyle,true);});var firstModel=this.selectedComponentsCollection.first();if(firstModel){firstModel.trigger('change',['styles']);}},pastePositions:function(){var _that=this;this.selectedComponentsCollection.each(function(cModel){cModel.pastePosition(_that.copiedComponentPosition,true);});var firstComponentModel=this.selectedComponentsCollection.first();firstComponentModel.trigger('change');},pasteDimensions:function(){var _that=this;this.selectedComponentsCollection.each(function(cModel){cModel.pasteDimension(_that.copiedComponentDimensions,true);});var firstComponentModel=this.selectedComponentsCollection.first();firstComponentModel.trigger('change');},pasteStyles:function(){var _that=this;this.selectedComponentsCollection.each(function(cModel){cModel.pasteStyle(_that.copiedComponentStyle,true);});var firstComponentModel=this.selectedComponentsCollection.first();firstComponentModel.trigger('change');},deleteActiveComponent:function(){},selectStage:function(componentModel){this.trigger('on-stage-selected',this.model,this);},deleteFromCutCopyComponents:function(componentModel){this.trigger('delete-from-cut-copy-collection',componentModel,this);},addComponent:function(componentModel,onComponentAdded){},setModel:function(model){var _that=this;this.canEdit=true;if(model!=undefined){this.createPageThumb();this.stageSelector.reset();this.model=model;this.stageSelector.model=model;if(model.view){model.view.reloadEvents();}
this.model.get('options').on("change:premade-style",this.renderStyle,this);this.listenTo(this.model.get('options'),'change:width',this.renderDimentions);this.listenTo(this.model.get('options'),'change:height',this.renderDimentions);this.listenTo(this.model.get('options'),'change:bgcolor',this.renderBackgroundColor);this.listenTo(this.model.get('options'),'change:image',this.renderBackgroundImage);}
this.render();this.renderZIndex();clearTimeout(this.TO);this.TO=setTimeout(function(){_that.turnOnMenus();var textModel=new TextModel({x:-999,y:-999,width:0,height:0});var textComponent=new TextComponentView({model:textModel});_that.$el.append(textComponent.render().$el);textComponent.startEditing(false);textComponent.endEditing();},100);},turnOffMenus:function(){BottomMenuView.instance.hideMenu(function(){_layout.menu_bottom.css('display','none');});_layout.menu_bottom.trigger('hideMenu');$('.trigger-window').css('display','none');$('#menu-left').css('disabled','disabled');},turnOnMenus:function(){$('#menu-bottom').css('display','block');$('.trigger-window').css('display','block');$('#menu-left').css('disabled','enabled');},renderStyle:function(className){this.$el.attr('class',this.model.get('options').get('premade-style'));},saveComponent:function(componentModel,params){},getAllComponentsModels:function(){var componentsModels=[];this.model.get('lines').each(function(lineCollection){lineCollection.get('objects').each(function(componentModel){componentsModels.push(componentModel);},this);},this);return componentsModels;},dataPickerPicked:function(model){this.trigger('data-picker-picked',model);},getComponentModelByActionkey:function(actionkey){return this.model.getComponentModelByActionkey(actionkey);},replaceComponentModel:function(oldComponentModel,newComponentModel){return this.model.replaceComponentModel(oldComponentModel,newComponentModel);},getRowModelByLineId:function(lineId){return this.model.getRowModelByLineId(lineId);},cutComponents:function(){},duplicateComponents:function(){},copyComponents:function(){},getSortedComponentsFromTimeLine:function(componentsCollection,reverse){reverse=reverse==undefined?true:reverse;var sortedComponentsCollection=new ComponentCollection();var allComponentsCollection=this.getAllComponentsModels();if(reverse){for(var i=allComponentsCollection.length-1;i>=0;i--){var tModel=allComponentsCollection[i];if(componentsCollection.contains(tModel)){sortedComponentsCollection.add(tModel);}};}else{for(var i=0;i<allComponentsCollection.length;i++){var tModel=allComponentsCollection[i];if(componentsCollection.contains(tModel)){sortedComponentsCollection.add(tModel);}};}
return sortedComponentsCollection;},pasteComponents:function(hash){},deleteAllComponents:function(){this.model.get('lines').each(function(rowModel){rowModel.get('objects').each(function(componentModel){componentModel.view.destroy();});});},createPageThumb:function(onResult){},componentExist:function(actionkey){return this.model.componentExist(actionkey);},showContextMenu:function(e){},onWindowResize:function(){},selectComponentsOnStart:function(){},addMultiComponents:function(){}});StageView.instance={};;;var EditableStageView=StageView.extend({className:'stage-view-wrapper stage-view-wrapper-main',events:{'mousedown':'onMouseDown','mouseup':'onMouseUp',},copiedComponentTrigger:[],clipboardActions:[],addComponent:function(componentModel,onComponentAdded){var _that=this;console.log("addComponents");console.log(componentModel.toJSON());var scrollTop=this.$el.scrollTop();componentModel.set('y',scrollTop+10,{silent:true});var selectedRow=this.getSelectedRow();var notLockedRow=this.findNotLockedRow(selectedRow);var row=notLockedRow||selectedRow;var selectedRowId=row.get('options').get('id');var componentsCollection=new ComponentCollection();componentsCollection.add(componentModel);DataAccess.addComponents({components:componentsCollection,action:"add",selectedRowId:selectedRowId,pageId:this.model.getPageId()},function(data){_log('Add component result: ',data,_log.dataaccessOutResult);var result=_that.addComponentsToStage(data,onComponentAdded);_that.selectCopmponents(result.cc);if(_.isFunction(onComponentAdded)){onComponentAdded(result.v);};_that.model.updateDinamicPageThumb();},function(data){_log('Add component fault: ',data,_log.dataaccessOutFault);});},addComponentsToStage:function(data){var _that=this;var cc=this.model.addComponents(data);var componentModel=cc.first();var componentViews=[];cc.each(function(cModel){var componentView=_that.renderSingleComponent(cModel);componentViews.push(componentView);});this.updateTimeline();this.renderZIndex();return{cc:cc,v:componentViews[0]};},deleteActiveComponent:function(){var _that=this;if(!this.canEdit){return;}
if($(document.activeElement).is("input[type='text'], textarea, [contenteditable]")){return;}
if(_that.selectedComponentsCollection.length<=0){return;}
var sortedCC=this.model.getSortedComponentsCollection(this.selectedComponentsCollection);DataAccess.deleteComponents({components:sortedCC,action:"delete",pageId:this.model.getPageId()},function(data){_log('Delete components result: ',data,_log.dataaccessOutResult);_that.onDeleteComponentsResult(data);_that.model.updateDinamicPageThumb();},function(data){_log('Delete components fault: ',data,_log.dataaccessOutFault);_that.model.updateDinamicPageThumb();});},onDeleteComponentsResultComing:function(data){var _that=this;var cc=this.model.deleteComponents(data);cc.each(function(cModel){_that.selectedComponentsCollection.remove(cModel);});this.updateTimeline();this.selectStage();},onDeleteComponentsResult:function(data){var cc=this.model.deleteComponents(data);this.selectedComponentsCollection.reset();this.updateTimeline();this.selectStage();},cutComponents:function(){var _that=this;if(this.selectedComponentsCollection.length==0){return;}
var sortedCC=this.model.getSortedComponentsCollection(this.selectedComponentsCollection);DataAccess.cutComponents({components:sortedCC,action:"delete",pageId:this.model.getPageId()},function(data){_log('Cut components result: ',data,_log.dataaccessOutResult);_that.onCutComponentsResult(data);_that.model.updateDinamicPageThumb();},function(data){_log('Delete components fault: ',data,_log.dataaccessOutFault);_that.model.updateDinamicPageThumb();});},onCutComponentsResult:function(data){var hash=data.hash;this.hash=hash;var cc=this.model.cutComponents(data);this.selectedComponentsCollection.reset();this.updateTimeline();this.selectStage();},onCutComponentsResultComing:function(data){var _that=this;var cc=this.model.cutComponents(data);cc.each(function(cModel){_that.selectedComponentsCollection.remove(cModel);});this.updateTimeline();this.selectStage();},pasteComponents:function(hash){var _that=this;if(!this.canEdit){return;}
var hash=hash||_that.hash;if(!_.isObject(hash)){return;}
var selectedRow=this.getSelectedRow();var selectedRowId=selectedRow.get('options').get('id');DataAccess.pasteComponents({hash:hash,selectedRowId:selectedRowId,pageId:this.model.getPageId()},function(data){_log('Paste components result: ',data,_log.dataaccessOutResult);var cc=_that.onPasteComponentsResult(data);_that.selectCopmponents(cc);_that.model.updateDinamicPageThumb();},function(data){_log('Paste components fault: ',data,_log.dataaccessOutFault);_that.model.updateDinamicPageThumb();});},onPasteComponentsResult:function(data){var _that=this;var cc=this.model.pasteComponents(data);cc.each(function(cModel){var componentView=_that.renderSingleComponent(cModel);});this.updateTimeline();this.renderZIndex();return cc;},saveComponent:function(componentModel,params){var _that=this;if(!this.canEdit){return;}
_log('saveComponent componentModel',componentModel,_log.error);if(componentModel.onlyRefresh){return;}
var components=[];var cc=this.selectedComponentsCollection;if(!this.selectedComponentsCollection.contains(componentModel)){cc=new ComponentCollection();cc.add(componentModel);}
cc.each(function(cModel){var picked=[];var exist=false;if(_.isArray(params)){picked=_.clone(params);exist=true;}else{for(var item in cModel.changed){picked.push(item);exist=true;}}
if(!exist){components.push(cModel);}else{picked.push('actionkey');_log('picked',picked,_log.error);var c=_.pickFromArray(cModel.toJSON(),picked);var exist=false;for(var item in c){exist=true;break;};_log('c',c,_log.error);if(exist){components.push(c);}else{components.push(cModel);}}});DataAccess.updateComponents({components:components,action:"update",pageId:this.model.getPageId()},function(data){_log('Update component result: ',data,_log.dataaccessOutResult);_that.model.updateDinamicPageThumb();},function(data){_log('Update component fault: ',data,_log.dataaccessOutFault)});},updateComponentsResultComing:function(data){var _that=this;var cscc=this.selectedComponentsCollection.clone();var cc=this.model.updateComponentsCollection(data);cc.each(function(cModel){cModel.view.endEditing();cModel.view.unselectComponent();cModel.view.render();if(_that.selectedComponentsCollection.contains(cModel)){cModel.view.selectComponent();}});this.selectCopmponents(cscc);},duplicateComponents:function(onComponentAdded){if(this.selectedComponentsCollection.length==0){return;}
var _that=this;var selectedRow=this.getSelectedRow();var selectedRowId=selectedRow.get('options').get('id');var sortedCC=this.model.getSortedComponentsCollection(this.selectedComponentsCollection);var components=sortedCC;var sourcePageId=this.model.get('options').get('pageid');var sourceProjectId=this.model.get('options').get('projectId');var sourceUserId=this.model.get('options').get('userId');DataAccess.duplicateComponents({selectedRowId:selectedRowId,components:components,sourceProjectId:sourceProjectId,sourceUserId:sourceUserId,sourcePageId:sourcePageId,pageId:this.model.getPageId()},function(data){_log('Duplicate components result: ',data,_log.dataaccessOutResult);var result=_that.addComponentsToStage(data);_that.selectCopmponents(result.cc);if(_.isFunction(onComponentAdded)){onComponentAdded(data);};_that.model.updateDinamicPageThumb();},function(data){_log('Duplicate components fault: ',data,_log.dataaccessOutFault);});},copyComponents:function(){var _that=this;if(this.selectedComponentsCollection.length==0){return;}
_log('copyComponents this.model',this.model);var sortedCC=this.model.getSortedComponentsCollection(this.selectedComponentsCollection);var components=sortedCC;var sourcePageId=''+this.model.get('options').get('pageid');var sourceProjectId=this.model.projectId;var sourceUserId=this.model.ownerId;DataAccess.copyComponents({components:components,sourceProjectId:sourceProjectId,sourceUserId:sourceUserId,sourcePageId:sourcePageId,pageId:this.model.getPageId()},function(data){_log('Copy components result: ',data,_log.dataaccessOutResult);var hash=data.hash;_that.hash=hash;},function(data){_log('Copy components fault: ',data,_log.dataaccessOutFault);});},createPageThumb:function(onResult){var _that=this;var thumbedModel=this.model;if(_that.model.changesWereMade){var htmlToRender=_that.$el.find('.stage-view').clone();htmlToRender.find('.darkenComponent').remove();DataAccess.createPageThumb({html:htmlToRender.html(),pageOptions:_that.model.get('options').toJSON()},function(data){if(thumbedModel!=undefined){if(thumbedModel.updatePagethumb!=undefined){thumbedModel.updatePagethumb();}}
if(onResult!=undefined){onResult(data);}},function(data){_log('createPageThumb FAILED',data)});}else{if(onResult!=undefined){onResult();}}},copyTriggerFromOtherProject:function(model){this.copiedComponentTrigger=JSON.stringify(model.toJSON().triggers);},copyPositionFromOtherProject:function(model){var x=model.get('x');var y=model.get('y');this.copiedComponentPosition={x:x,y:y}},copyDimensionFromOtherProject:function(model){var width=model.get('width');var height=model.get('height');this.copiedComponentDimensions={width:width,height:height}},copyStyleFromOtherProject:function(model){var style=model.get('styles');var type=model.get('type')
if(style!=undefined){this.copiedComponentStyle[type]=JSON.stringify(style);}},onFileDragOver:function(e){e.stopPropagation();this.$el.find('.stage-loaded-dropzone').show();},onFileDragOut:function(e){e.stopPropagation(e);this.$el.find('.stage-loaded-dropzone').hide();},uploadOnFileDrop:function(e){if(Utils.isDarkanExtension(e)){return;};e.stopPropagation();e.preventDefault();if(!this.canEdit){return;}
this.$el.find('.stage-loaded-dropzone').fadeOut(200);var file=e.originalEvent.dataTransfer.files[0];_log('file',file,_log.trigger);_log('e',e);if(file!=undefined){this.addComponentOnDrop(this.getDropProperties(e));}else{this.addComponentOnLink(e);}},addComponentOnLink:function(e){var _that=this;var fileName=e.originalEvent.dataTransfer.getData('text');var urlpattern=new RegExp('(http|ftp|https)://[a-z0-9\-_]+(\.[a-z0-9\-_]+)+([a-z0-9\-\.,@\?^=%&;:/~\+#]*[a-z0-9\-@\?^=%&;/~\+#])?','i');if(urlpattern.test(fileName)){if(e.shiftKey){this.createComponentAndUpload('infopoint-link',function(componentView){componentView.setLink(fileName);});return;}
if(e.ctrlKey){this.createComponentAndUpload('infopoint-download',function(componentView){componentView.uploadOnDownloadFileDrop(e,false);});return;}
if(Utils.isYoutubeLink(fileName)){this.createComponentAndUpload('video',function(componentView){componentView.setYoutubeVideoLink(fileName);});return;}
if(Utils.isImageLink(fileName)){this.createComponentAndUpload('image',function(componentView){componentView.uploadOnLink(fileName,true);});return;}
this.createComponentAndUpload('text',function(componentView){componentView.setText(fileName);});}else{this.createComponentAndUpload('text',function(componentView){componentView.setText(fileName);});}},addComponentOnDrop:function(e){var _that=this;var file=e.file;var fileName=file.name;var regSound=new RegExp("^.*\."+'mp3'+"$");var regVideo=new RegExp("^.*\."+'mp4'+"$");if(e.ctrlKey){this.createComponentAndUpload('infopoint-download',function(componentView){componentView.uploadOnDownloadFileDrop(e,false);componentView.setLink(fileName);});return;}
if(regSound.test(fileName)){this.createComponentAndUpload('infopoint-sound',function(componentView){componentView.uploadOnSoundFileDrop(e,false);});return;}
if(regVideo.test(fileName)){this.createComponentAndUpload('video',function(componentView){componentView.uploadOnFileDrop2(e,false);});return;}
this.createComponentAndUpload('image',function(componentView){componentView.uploadOnFileDrop2(e,true);});},createComponentAndUpload:function(componentType,onComponentAdded){var componentModel=ComponentFactory.createComponentModelByType(componentType);this.addComponent(componentModel,onComponentAdded);},getDropProperties:function(e){var imageUrl;var file=e.originalEvent.dataTransfer.files[0];var data;if(file!=undefined){var imageName=file.name;var imageData=e.originalEvent.dataTransfer.result;data={name:imageName,data:imageData,size:file.size};}else{imageUrl=e.originalEvent.dataTransfer.getData('text');}
return{file:file,data:data,imageUrl:imageUrl};},showContextMenu:function(e){var contextMenuView=new StageContextMenuView({model:this.getModel(),view:this});ContextMenuContainer.addMenu(contextMenuView,e);},getSelectedRow:function(){var activeRowId=User.getModel().get('activeRowId');var activeRow;this.model.get('lines').each(function(row){if(row.get('options').get('id')==activeRowId){activeRow=row;}});if(activeRow==undefined){var index=this.model.get('lines').length-2;if(index<0){index=0;}
activeRow=this.model.get('lines').at(index);}
return activeRow;},findNotLockedRow:function(activeRow){return this.model.findNotLockedRow(activeRow);},copySelectedComponentsToNewLine:function(){var _that=this;var lastRowModel=this.model.get('lines').last();this.selectRow(lastRowModel);this.duplicateComponents(function(data){var selectedRowId=data.selectedRowId;var rowModel=_that.model.getRowModelByLineId(selectedRowId);_that.sortRows("event",rowModel,0);});},moveSelectedComponentsToNewLine:function(){var _that=this;if(this.selectedComponentsCollection.length==0){return;}
var lastRowModel=this.model.get('lines').last();this.selectRow(lastRowModel);this.moveComponentsToLayer(lastRowModel.get('options').get('id'),0,function(data){var selectedRowId=data.rowId;var rowModel=_that.model.getRowModelByLineId(selectedRowId);_that.sortRows("event",rowModel,0);});},selectRow:function(selectedRowModel){if(selectedRowModel!=undefined){User.getModel().set('activeRowId',selectedRowModel.get('options').get('id'));this.model.get('lines').each(function(row){row.setActive(false);});selectedRowModel.setActive(true);}},sortRows:function(event,model,position){var _that=this;var rowId=model.get('options').get('id');DataAccess.sortRows({rowId:rowId,position:position,pageId:this.model.getPageId()},function(data){_log('Sort rows result: ',data,_log.dataaccessOutResult);_that.onSortRowsResult(data);},function(data){_log('Sort rows fault: ',data,_log.dataaccessOutFault);});},onSortRowsResult:function(data){this.model.sortRows(data);StageView.instance.renderZIndex();this.model.trigger('update-timeline');},moveComponentsToLayer:function(rowId,position,onComponentMoved){var _that=this;if(this.selectedComponentsCollection.length==0){return;}
_log('rowId',rowId);_log('position',position);_log('selectedComponentsCollection',this.selectedComponentsCollection);var sortedCC=this.model.getSortedComponentsCollection(this.selectedComponentsCollection);var actionkeys=_.pluck(sortedCC.toJSON(),'actionkey');_log('actionkeys',actionkeys);DataAccess.moveComponentsToLayer({rowId:rowId,actionkeys:actionkeys,position:position,pageId:this.model.getPageId()},function(data){_log('Move components to layer result: ',data,_log.dataaccessOutResult);_that.onMoveComponentsResult(data);if(_.isFunction(onComponentMoved)){onComponentMoved(data);};},function(data){_log('Move components to layer fault: ',data,_log.dataaccessOutFault);});},onMoveComponentsResult:function(data){var _that=this;this.model.moveComponentsToLayer(data);},updateRowOptionsResult:function(data){var rowModel=this.model.updateRowOptions(data);if(!rowModel){return;}
rowModel.view.render();rowModel.view.afterRender();},selectComponentsOnStart:function(){var selectedComponents=ProjectModel.instance.get('selectedComponents');_log('selectComponentsOnStart',selectedComponents);_log('ProjectModel.instance',ProjectModel.instance);if(_.isUndefined(selectedComponents)){return}
this.stageSelector.onSelectComponentsByUser(selectedComponents);ProjectModel.instance.unset('selectedComponents');},copyTrigger:function(){var firstCopmonentModel=this.selectedComponentsCollection.first();var copiedTriggersAction=JSON.stringify(firstCopmonentModel.get('triggers'));this.clipboardActions=JSON.parse(copiedTriggersAction);},pasteTrigger:function(trigger){trigger=trigger||this.clipboardActions;var _that=this;var scc=this.selectedComponentsCollection;scc.each(function(cModel){cModel.pasteTrigger(trigger,true);});var firstModel=scc.first();if(firstModel){firstModel.trigger('change',['triggers']);scc.each(function(cModel){_that.selectOneComponent(cModel);});}},copyThisActionToClipboard:function(triggerAction){var copiedTriggerAction=JSON.stringify(triggerAction);_log('copyActionsToClipboard',copiedTriggerAction);this.clipboardActions.push(JSON.parse(copiedTriggerAction));_log('clipboardActions',this.clipboardActions);},toPasteActionsFromTheClipboard:function(trigger){var _that=this;trigger=trigger||this.clipboardActions;var scc=this.selectedComponentsCollection;scc.each(function(cModel){cModel.toPasteTrigger(trigger,true);});var firstModel=scc.first();if(firstModel){firstModel.trigger('change',['triggers']);scc.each(function(cModel){_that.selectOneComponent(cModel);});}},cleanActionsClipboard:function(){this.clipboardActions=[];},addMultiComponents:function(data){var _that=this;var cData=data.cData;var values=cData.values||[];var width=cData.width||50;var height=cData.height||150;var componentType=data.type;var onComponentAdded=function(){}
var scrollTop=this.$el.scrollTop();var componentsCollection=new ComponentCollection();var styles={'component-inner':{'border-bottom-width':"1px",'border-color':"#000",'border-left-width':"1px",'border-right-width':"1px",'border-style':"solid",'border-top-width':"1px",}}
for(var i=0;i<values.length;i++){var value=values[i];var componentModel=ComponentFactory.createComponentModelByType(componentType);componentModel.set('width',width);componentModel.set('height',height);componentModel.set('styles',styles);componentModel.set('contents','<div style="text-align: center;"><span style="font-size: 18px; background-color: rgba(0, 0, 0, 0);">'+value+'</span></div>');componentModel.set('y',scrollTop+10,{silent:true});componentsCollection.add(componentModel);console.log("addComponents");console.log(componentModel.toJSON());};if(componentsCollection.length==0){return;}
var selectedRow=this.getSelectedRow();var notLockedRow=this.findNotLockedRow(selectedRow);var row=notLockedRow||selectedRow;var selectedRowId=row.get('options').get('id');DataAccess.addComponents({components:componentsCollection,action:"add",selectedRowId:selectedRowId,pageId:this.model.getPageId()},function(data){_log('Add component result: ',data,_log.dataaccessOutResult);var result=_that.addComponentsToStage(data,onComponentAdded);_that.selectCopmponents(result.cc);if(_.isFunction(onComponentAdded)){onComponentAdded(result.v);};_that.model.updateDinamicPageThumb();},function(data){_log('Add component fault: ',data,_log.dataaccessOutFault);});}});;;var NotEditableStageView=StageView.extend({className:'stage-view-wrapper not-editable-stage-view-wrapper',template:_.template($('#not-editable-stage-empty-template').html()),events:{'mousedown':'onMouseDown','mouseup':'onMouseUp',},initialize:function(){var _that=this;this.selectedComponentsCollection=new ComponentCollection();this.stageSelector=new StageSelector();this.stageSelector.$el=this.$el;this.stageSelector.scc=this.selectedComponentsCollection;this.stageSelector.model=this.model;this.stageSelector.start();this.timeout=function(){};},showContextMenu:function(e){var contextMenuView=new NotEditableStageContextMenuView({model:this.getModel(),view:this});ContextMenuContainer.addMenu(contextMenuView,e);},renderSingleComponent:function(componentModel){var _that=this;componentModel.ownerId=this.model.ownerId;componentModel.projectId=this.model.projectId;var componentView=ComponentFactoryNotEditable.createComponentByModel(componentModel);this.$el.find('.stage-view').append(componentView.render().$el);componentView.afterRender();componentView.on('select-component',function(cModel,e){_that.selectOneComponent(cModel,e);});componentView.on('multi-select',function(cModel){_that.stageSelector.selectMultiComponents(cModel);});componentView.on('copy-components-from-other-project',function(cModel){_that.copyComponentsFromOtherProject(cModel);});return componentView;},copyComponentsFromOtherProject:function(model){var _that=this;_log('copyComponents this.model',model);_log('stage model',this.model);var cc=new ComponentCollection();cc.add(model);var sortedCC=this.model.getSortedComponentsCollection(this.selectedComponentsCollection);var components=sortedCC;var sourcePageId=''+this.model.get('options').get('pageid');var sourceProjectId=this.model.projectId;var sourceUserId=this.model.ownerId;DataAccess.copyComponentsFromOtherProject({components:components,sourceProjectId:sourceProjectId,sourceUserId:sourceUserId,sourcePageId:sourcePageId,pageId:this.model.getPageId()},function(data){_log('Copy components result: ',data,_log.dataaccessOutResult);var hash=data.hash;StageView.instance.hash=hash;},function(data){_log('Copy components fault: ',data,_log.dataaccessOutFault);});},});;;var MenuPanelView=Backbone.View.extend({tagName:'div',template:_.template($('#menu-panel-template').html()),bindings:{},events:{},initialize:function(){this.addListeners();this.onBeforeInitialize();},addListeners:function(){},onBeforeInitialize:function(){},disableIfNotActive:function(){},render:function(){this.beforeRender();var editorTemplate=this.template(this.serializeData());this.$el.html(editorTemplate);this.disableIfNotActive();this.stickit();return this;},serializeData:function(){return this.model==undefined?{}:this.model.toJSON();},beforeRender:function(){},afterRender:function(){},setModel:function(model){this.unstickit();this.model=model;this.onSetModel();},onSetModel:function(){},destroy:function(){this.unstickit();this.unbind();this.remove();}});;;var ReportMenuPanelView=MenuPanelView.extend({tagName:'div',template:_.template($('#report-menu-panel-template').html()),bindings:{'input[name="reportname"]':'reportName'},events:{},});;;function MenuPanelsFactory(){}
MenuPanelsFactory.createPanel=function(){return new MenuPanelView();;}
MenuPanelsFactory.createReportsPanel=function(){return new ReportMenuPanelView();;};;var build_app_layout=function(container){var finder=function(sClassName){return container.find(sClassName);};return{darkanapp:finder('#darkanapp'),scene_wrapper:finder('#scene-wrapper'),text_editor_image:finder('#text-editor-image'),load_project_modal:finder('#load-project-modal'),menu_top:finder('#menu-top'),menu_top_tabs:finder('#menu-top-tabs'),menu_bottom:finder('#menu-bottom'),menu_bottom_tabs:finder('#menu-bottom-tabs'),menu_right:finder('#menu-right'),menu_right_tabs:finder('#menu-right-tabs'),menu_left:finder('#menu-left'),pages_list_wrapper:finder('#pages-list-wrapper, #second-pages-list-wrapper')};};window._layout=build_app_layout($(document));;;var NewPagePlusButton=Backbone.View.extend({tagName:'li',className:'new-page-plus-button',template:_.template($('#new-page-plus-button-template').html()),events:{'click':'addNewPage'},initialize:function(){},render:function(){var template=this.template(this.serializeData());this.$el.html(template);return this;},serializeData:function(){return{};},afterRender:function(){},addNewPage:function(){this.trigger('add-new-page');}});;;var PageItem=ItemView.extend({tagName:'li',className:'page',template:_.template($('#page-item-template').html()),events:{},initialize:function(){},render:function(){var template=this.template(this.serializeData());this.$el.html(template);this.addTitleToButtons();return this;},reloadEvents:function(){this.model.get('options').off();this.model.off();this.$el.off();this.createListeners();this.delegateEvents();},createListeners:function(){},serializeData:function(){var options=this.model.toJSON();options.order=this.model.collection.indexOf(this.model)+1;options.isSelected=this.model.isSelected;return options;},afterRender:function(){},setPageAsActive:function(){var itemsSelectedNumb=0;this.model.collection.each(function(model){if(model.isSelected){itemsSelectedNumb++;}});if(itemsSelectedNumb<=1){this.unselectAllPages();this.model.isSelected=true;this.model.view.setCheckboxSelected(true);}
this.model.collection.each(function(model){model.view.active=false;model.view.$el.attr('active',false);});this.active=true;this.$el.attr('active',true);this.selectPageByUser();this.trigger('on-page-set-as-active',this.model,this);},selectPageByUser:function(){},selectPage:function(e){var selected=$(e.target).is(':checked');this.model.isSelected=selected;},onClick:function(e){if(e.shiftKey){var pagesCollection=this.model.collection;var indexModel=pagesCollection.indexOf(this.model);var chFrom=0;var chTo=0;var check=false
for(var i=indexModel;i>=0;i--){var model=pagesCollection.at(i);if(model.isSelected){chFrom=i;chTo=indexModel;check=true;break;}}
if(!check){for(var i=indexModel;i<this.model.collection.length;i++){var model=pagesCollection.at(i);if(model.isSelected){chFrom=indexModel;chTo=i;check=true;break;}}}
if(check){pagesCollection.each(function(model,iModel){if((iModel<chFrom)||(iModel>chTo)){model.isSelected=false;model.view.setCheckboxSelected(false);}else{model.isSelected=true;model.view.setCheckboxSelected(true);}});}}else if(e.ctrlKey){if(this.model.isSelected){this.model.isSelected=false;this.setCheckboxSelected(false);}else{this.model.isSelected=true;this.setCheckboxSelected(true);}}else{this.unselectAllPages();this.model.isSelected=true;this.setCheckboxSelected(true);this.setPageAsActive();}},setCheckboxSelected:function(value){this.renderSelectedCheckbox(value);},renderSelectedCheckbox:function(value){this.$el.find('.page-checkbox').prop('checked',value);},unselectAllPages:function(){this.model.collection.each(function(model){model.isSelected=false;model.view.setCheckboxSelected(false);model.view.closeSettingsWindows();});this.$el.trigger('unselect-all-pages');},closeSettingsWindows:function(){if(this.pageSoundSettingView!=undefined){this.pageSoundSettingView.remove();this.pageSoundSettingView=undefined;}},addTitleToButtons:function(){this.$el.find('[title]').tooltip({html:true,animated:'fade',placement:'right',width:300,height:200});},beforeDestroy:function(){},destroy:function(){this.beforeDestroy();this.unbind();this.remove();},copyTrigger:function(){this.$el.trigger('copy-page-trigger',this.model,this);},pasteTrigger:function(pageTrigger){this.model.get('options').set('triggers',JSON.parse(pageTrigger));this.$el.trigger('on-paste-page-trigger',this.model,this);},});;;var PagesList=Backbone.View.extend({tagName:'div',className:'pages-list',template:_.template($('#pages-list-template').html()),templateEmpty:_.template($('#pages-empty-list-template').html()),selectedPageModel:undefined,visible:true,events:{},initialize:function(){},render:function(){var pagesLength=this.model.get('collection').length;if(pagesLength>0){var template=this.template(this.serializeData());this.$el.html(template);}else{var template=this.templateEmpty(this.serializeData());this.$el.html(template);}
this.addTitleToButtons();return this;},afterRender:function(){var _that=this;this.model.get('collection').each(this.renderOnePage,this);if(this.selectedPageModel){var pageId=this.selectedPageModel.get('options').get('pageid');this.model.get('collection').each(function(pModel){if(pModel.get('options').get('pageid')==pageId){_that.setPageAsActive(pModel);}});}else{this.setFirstPageAsActive();}
this.addPlusButton();this.makeSortable();this.perfectScrollbar();this.scrollToActivePage();this.selectPageOnStart();},scrollToActivePage:function(){if(this.selectedPageModel){var activePageOffset=this.selectedPageModel.view.$el.offset().top;var activePageHeight=this.selectedPageModel.view.$el.height();var pageListHeight=this.$el.find('.pages').height();this.$el.find('.pages').scrollTop(activePageOffset-pageListHeight/2-activePageHeight/2);}},makeSortable:function(){},perfectScrollbar:function(){this.$el.find('.pages').perfectScrollbar({useKeyboard:false,suppressScrollX:true});},serializeData:function(){return this.model.toJSON();},addPlusButton:function(){},renderOnePage:function(model){var pageItem=new PageItem({model:model});model.view=pageItem;pageItem.on('on-page-set-as-active',this.onSetPageAsActive,this);this.$el.find('.pages').append(pageItem.render().$el);pageItem.afterRender();},onSetPageAsActive:function(model){this.selectedPageModel=model;this.trigger('set-page',model);},setPageAsActive:function(pageModel){if(pageModel.view){pageModel.view.setPageAsActive();}},setFirstPageAsActive:function(){var firstPageModel=this.model.get('collection').first();if(firstPageModel){firstPageModel.view.setPageAsActive();}},selectedAllPages:function(){var pagesCollection=this.model.get('collection');var setActive=true;var _act=true;var _uni=true;pagesCollection.each(function(childModel,index){if(index==0){_act=childModel.isSelected;}
if(_uni&&_act!==childModel.isSelected){_uni=false;}});if(_uni){if(_act==false)
setActive=true;else
setActive=false;}
if(setActive){this.$el.find('.select-all-pages').addClass('selected-all-pages');}else{this.$el.find('.select-all-pages').removeClass('selected-all-pages');}
pagesCollection.each(function(childModel){childModel.isSelected=setActive;childModel.view.setCheckboxSelected(setActive);});},disableButtons:function(){},enableButtons:function(){},getPagesLength:function(){return this.model.get('collection').length;},accept:function(visitor){visitor.visit(this);},toggleRightMenu:function(){var _that=this;this.trigger('toggle-project-list',this.visible);},getPageModelByPageId:function(pageId){var pageModel;this.model.get('collection').each(function(model){if(model.get('options').get('pageid')==pageId){pageModel=model;}});return pageModel;},getIdsFromSelectedPages:function(pageCollection){var pageIdsListToCopy=[];pageCollection.each(function(model){if(model.isSelected){pageIdsListToCopy.push(model.get('options').get('pageid'));}});return pageIdsListToCopy;},getPageIndexByPageModel:function(pageModel){var index=this.model.get('collection').indexOf(pageModel);return index;},show:function(){this.tiggleIcon=this.$el.find('.toggle-icon');this.$el.parent().css('width','250px');this.tiggleIcon.css({transform:'rotate(0deg)',left:'0px',height:'','line-height':''});this.$el.find('.pages-list-section').show();this.visible=true;},hide:function(){this.tiggleIcon=this.$el.find('.toggle-icon');this.$el.parent().css('width','0px');this.tiggleIcon.css({transform:'rotate(180deg)',left:'-19px',height:'100px','line-height':'100px'});this.$el.find('.pages-list-section').hide();this.visible=false;},selectPageOnStart:function(){},getPagesCollection:function(){return this.model.get('collection');},getSelectedPageModel:function(){return this.selectedPageModel;},addTitleToButtons:function(){this.$el.find('[title]').tooltip({html:true,animated:'fade',placement:'bottom',width:300,height:200,});},});;;var LoadedPageItem=PageItem.extend({events:function(){return _.extend({},PageItem.prototype.events,{'dragenter':'onFileDragOver','dragleave .loaded-dropzone':'onFileDragOut','drop .loaded-dropzone':'uploadOnFileDrop'});},onFileDragOver:function(e){e.stopPropagation();this.$el.find('.loaded-dropzone').fadeIn(200);},onFileDragOut:function(e){e.stopPropagation(e);this.$el.find('.loaded-dropzone').fadeOut(200);},getAcceptTypeFormat:function(){return this.model.get('options').getAcceptTypeFormat();},getDropProperties:function(e){var imageUrl;var file=e.originalEvent.dataTransfer.files[0];var data;if(file!=undefined){var imageName=file.name;var imageData=e.originalEvent.dataTransfer.result;data={name:imageName,data:imageData,size:file.size};}else{imageUrl=e.originalEvent.dataTransfer.getData('text');}
return{file:file,data:data,imageUrl:imageUrl};},uploadOnPaste:function(e,blob,resizeImage){var _that=this;if(!StageView.instance.canEdit){return;}
if(this.model.get('locked')){return;}
this.resizeImage=resizeImage;var reader=new FileReader();reader.onload=function(e){var data={name:'copyimage.png',data:event.target.result,size:blob.size};_that.runUploadProcess({file:blob,data:data});};reader.readAsDataURL(blob);},getInputProperties:function(e,input){return FileUploader.getInputProperties(e,input);},uploadOnClick:function(){var _that=this;var acceptTypeFormat=this.getAcceptTypeFormat();var input=$('<input type="file" name="files[]" accept="'+acceptTypeFormat+'">');input.css({display:'none'});this.$el.append(input);input.click();input.change(function(e){_that.uploadOnInputData(e,this,false);$(this).remove();});},uploadOnFileDrop:function(e,resizeImage){if(Utils.isDarkanExtension(e)){return;};if(!StageView.instance.canEdit){return;}
this.resizeImage=resizeImage;this.$el.find('.loaded-dropzone').fadeOut(500);var properties=this.getDropProperties(e);var imageUrl=properties.imageUrl;if(imageUrl!=undefined){this.uploadOnLink(imageUrl,resizeImage);}else{this.runUploadProcess(properties);}},createLoaderImage:function(){var img=$('<img>');img.attr('src','content_template/css/gif-load.gif');img.addClass('page-item-loader-link');return img;},uploadOnLink:function(imageUrl,resizeImage){if(!StageView.instance.canEdit){return;}
if(this.model.get('locked')){return;}
this.resizeImage=resizeImage;var _that=this;var img=this.createLoaderImage();this.$el.append(img);DataAccess.convertLinkToImage({imageUrl:imageUrl,pageId:StageView.instance.model.get('options').get('pageid')},function(data){_that.$el.find('.page-item-loader-link').remove();_that.model.get('options').set('image',data.fileName);},function(data){_that.$el.find('.page-item-loader-link').remove();});},uploadOnInputData:function(e,input,resizeImage){this.resizeImage=resizeImage;var properties=this.getInputProperties(e,input);this.runUploadProcess(properties);},runUploadProcess:function(properties){if(this.model.get('options').uploadingNow){return;}
var specialData=this.getSpecialProperties();var toSend=$.extend({},properties,specialData);this.fileUploader=FileUploader.create(properties.data.name,this.model.get('options'),this);if(this.fileUploader==undefined){this.showPupup({content:_lang('FILETYPE_NOT_ACCEPTED'),title:_lang('MODAL_INFO_ERROR')},this);return;}
this.fileUploader.sendFile(toSend);this.fileUploader.on('on-result',this.onResult,this);this.fileUploader.on('on-fault',this.onFault,this);this.fileUploader.on('on-complete',this.onComplete,this);this.fileUploader.on('on-progress',this.onProgress,this);},onResult:function(data){if(data.key==1){this.showPupup({content:_lang('FILETYPE_NOT_ACCEPTED'),title:_lang('MODAL_INFO_ERROR')},this);return;}},onFault:function(data){this.showPupup({content:_lang('FILETYPE_NOT_ACCEPTED'),title:_lang('MODAL_INFO_ERROR')},this);},showPupup:function(data,sender){var popup=PopupFactory.createErrorPopup(data,sender);$('body').append(popup.render(data).$el);},onComplete:function(data){var _that=this;this.hideProgressPercent(data);this.model.updatePagethumb();this.fileUploader.off();this.fileUploader=undefined;setTimeout(function(){_that.model.updateDinamicPageThumb();},100);},onProgress:function(data){this.showProgressPercent(data);},getSpecialProperties:function(){return{};},showProgressPercent:function(data){FileUploader.showProgressPercent(data,this);},hideProgressPercent:function(data){FileUploader.hideProgressPercent(data,this);},openImageWindow:function(){var _that=this;var sender=this;var activeTab=0;var imageWindow=WindowFactory.createImageWindow(activeTab,_that.model.view);imageWindow.on('on-close',function(fileData){_that.imageWindow=undefined;});imageWindow.on('imageupload-ondrop',function(fileData){_that.model.view.uploadOnFileDrop(fileData,true);});imageWindow.on('imageupload-onclick',function(fileData,input){_that.model.view.uploadOnInputData(fileData,input,true);});imageWindow.on('imageupload-link',function(imageUrl){_that.model.view.uploadOnLink(imageUrl,true);});imageWindow.on('imageupload-on-paste',function(event,blob){_that.model.view.uploadOnPaste(event,blob,true);});$('body').append(imageWindow.render().$el);imageWindow.$el.find('.darkan-tabs').tabs("option","active",activeTab);this.imageWindow=imageWindow;},});;;var EditablePageItem=LoadedPageItem.extend({template:_.template($('#page-item-template').html()),pageSelectedByListTemplate:_.template($('#page-selected-by-list-template').html()),events:{'click .page-thumb':'onClick','click .dinamic-page-thumb-overlay':'onClick','mousedown':'onMouseDown','mousedown .page-notes':'onMouseDown','drop-item':'dropItem','click .page-show':'changePageShow','click .page-sound':'showPageSoundWindow','click .page-label':'activeEditingPageName','click .page-notes':'goToPageNote','blur input[name="pagename"]':'changePageName','keyup input[name="pagename"]':'changePageName','change .page-checkbox':'selectPage','data-picker-picked-page':'dataPickerPicked',},dinamicPageThumbEl:undefined,dinamicPageThumbExists:undefined,changesWereMade:false,active:false,initialize:function(){this.createListeners();},reloadEvents:function(){this.model.get('options').off();this.model.off();this.$el.off();this.createListeners();this.delegateEvents();},addModelEvents:function(){},dropItem:function(event,index){this.$el.trigger('update-sort',[this.model,index]);},showPageSoundWindow:function(e){var _that=this;var windowPosition={top:e.pageY,left:e.pageX};var options=this.model.get('options');if(this.pageSoundSettingView==undefined){this.pageSoundSettingView=new PageSoundSettingWindow({model:options});this.pageSoundSettingView.on('on-close',function(){_that.pageSoundSettingView=undefined;});this.pageSoundSettingView.on('delete-sound',function(model){_that.deleteSound(model);});var dataToRender={pageModel:options.toJSON()};$('body').append(this.pageSoundSettingView.render(dataToRender).$el);this.pageSoundSettingView.setWindowPosition(windowPosition);}},activeEditingPageName:function(e){var options=this.model.get('options');var pageName=options.get('pagename');var pageInput=$('<input name="pagename"  onfocus="this.value = this.value;" type="text" value="'+pageName+'">');$(e.target).html('').append(pageInput);pageInput.focus();},changePageName:function(e){var _that=this;var pageName=undefined;clearTimeout(this.changePageNameTO);this.changePageNameTO=setTimeout(function(){switch(e.type){case'focusout':pageName=$(e.target).val();break;case'keyup':if(e.keyCode===27||e.keyCode===13){pageName=$(e.target).val();}
break;}
if(pageName!=undefined){_that.setPageName(pageName);}},10);},setPageName:function(name){var options=this.model.get('options');options.set('pagename',name);this.$el.find('.page-label').text(name);},changePageShow:function(e){var options=this.model.get('options');var active=parseInt(options.get('active'));if(active===1){options.set('active',0);}else{options.set('active',1);}},onChangePageShow:function(e){var options=this.model.get('options');var active=parseInt(options.get('active'));if(active===0){this.$el.find('.page-show').addClass('page-hide');}else{this.$el.find('.page-show').removeClass('page-hide');}},createListeners:function(){var _that=this;this.model.get('options').view=this;this.model.view=this;this.addModelEvents();this.model.on('update-pagethumb',this.updatePagethumb,this);this.model.off('update-dintamic-page-thumb');this.model.on('update-dintamic-page-thumb',function(){clearTimeout(_that.pageThumbTimeout);_that.pageThumbTimeout=setTimeout(function(){_that.updateDinamicPageThumb();},50);});this.model.get('options').on('update-dintamic-page-thumb',function(){clearTimeout(_that.pageThumbTimeout);_that.pageThumbTimeout=setTimeout(function(){_that.updateDinamicPageThumb();},50);});this.model.off('selected-by-miniature');this.model.on('selected-by-miniature',this.renderSelectByMinaiture,this);this.model.off('selected-by-picker-miniature-1');this.model.on('selected-by-picker-miniature-1',this.renderSelectByMinaiture,this);this.model.off("selected-by-trigger");this.model.on("selected-by-trigger",this.renderSelectByTrigger,this);this.model.get('options').on("change",this.savePageOptions,this);this.listenTo(this.model,'checkbox-selected',this.renderSelectedCheckbox);this.listenTo(this.model.get('options'),'change:pagename',this.renderPageName);this.listenTo(this.model.get('options'),'change:active',this.onChangePageShow);this.listenTo(this.model.get('options'),'change:note',this.changeNoteIcon);this.listenTo(this.model.get('options'),'change:image',this.onImageChanged);this.listenTo(this.model.get('options'),'change:soundfilename',this.onSoundChanged);},dataPickerPicked:function(){this.trigger('data-picker-picked',this.model,this);},updatePagethumb:function(){var _that=this;this.model.changesWereMade=false;var pageOptions=_that.model.get('options').toJSON();_log('updatePagethumb',pageOptions);var thumPath=__meta__.projects_link+__meta__.ownerID+"/"+__meta__.projectID+"/pre/exported_view/"+pageOptions.pageid+"/pagethumb.jpg?r="+new Date().getUTCMilliseconds();var loadQueue=new createjs.LoadQueue();loadQueue.on("complete",function(){_that.$el.find('.page-thumb').css({'background-image':"url('"+thumPath+"')"}).show();_that.destroyDinamicPageThumb();});loadQueue.loadFile(thumPath);},savePageOptions:function(){var _that=this;var pageOptionsModel=_that.model.get('options');_log('updatePageOptions',pageOptionsModel,_log.dataaccessIn);if(pageOptionsModel.onlyRefresh){return;}
var picked=[];for(var item in pageOptionsModel.changed){picked.push(item);}
var shortedPageOptions=pageOptionsModel;_log('picked',picked,_log.dataaccessIn);if(picked.length>0){var shortedPageOptions=_.pickFromArray(pageOptionsModel.toJSON(),picked);}
_log('shortedPageOptions',shortedPageOptions,_log.dataaccessIn);DataAccess.updatePageOptions({pageOptions:shortedPageOptions,pageId:_that.model.getPageId()},function(data){_log('Update page options result: ',data,_log.dataaccessOutResult)},function(data){_log('Update page options fault: ',data,_log.dataaccessOutFault)});},onImageChanged:function(){this.updateDinamicPageThumb();},onSoundChanged:function(){this.render();},updateDinamicPageThumb:function(afterCreate){if(!this.dinamicPageThumbExists){this.createDinamicPageThumb();}
if(this.dinamicPageThumbExists){if(!afterCreate){this.model.changesWereMade=true;}
var thumbHtml=StageView.instance.$el.find('.stage-view').html().replace(/name="[^"]*"/g,"");this.dinamicPageThumbEl.html(thumbHtml);var options=this.model.get('options').toJSON();var backgroundImageDiv=$('<div></div>',{class:'page-thumb-background-image'}).css({width:options.width+"px",height:options.height+"px",'background-color':options.bgcolor});if(options.image){backgroundImageDiv.css({'background-image':'url("'+__meta__.projects_link+__meta__.ownerID+'/'+__meta__.projectID+'/pre/exported_view/'+options.pageid+'/imgpage/'+options.image+'")'});}
this.dinamicPageThumbEl.prepend(backgroundImageDiv);}},createDinamicPageThumb:function(){var _that=this;if(!this.dinamicPageThumbExists){_log('PAGE PAGE',this);this.model.changesWereMade=false;var zoom=150 / StageView.instance.model.get('options').get('width');var options=this.model.get('options').toJSON();this.dinamicPageThumbEl=$('<div>',{class:'dinamic-page-thumb-container'});this.dinamicPageThumbEl.css({width:'100%',height:'100%',top:0,left:0,position:'absolute','transform':'scale('+zoom+')','transform':'scale('+zoom+')','-moz-transform':'scale('+zoom+')','-ms-transform':'scale('+zoom+')','-o-transform':'scale('+zoom+')','-webkit-transform':'scale('+zoom+')','transform-origin':'0px 0px'});var overlay=$('<div>',{class:'dinamic-page-thumb-overlay'});overlay.css({width:'100%',height:'100%',top:0,left:0,position:'absolute','z-index':5});this.$el.find('.page-thumb').hide();this.$el.find('.dinamic-page-thumb-wrapper').html('');this.$el.find('.dinamic-page-thumb-wrapper').html(this.dinamicPageThumbEl);this.$el.find('.dinamic-page-thumb-wrapper').append(overlay);this.$el.find('.dinamic-page-thumb-wrapper').show();this.dinamicPageThumbExists=true;this.updateDinamicPageThumb(true);}},destroyDinamicPageThumb:function(){if(this.dinamicPageThumbExists){this.dinamicPageThumbEl.remove();this.$el.find('.dinamic-page-thumb').remove();this.$el.find('.dinamic-page-thumb-wrapper').hide();this.dinamicPageThumbEl=undefined;this.dinamicPageThumbExists=false;}},showContextMenu:function(e){var itemsSelectedNumb=0;this.model.collection.each(function(model){if(model.isSelected){itemsSelectedNumb++;}});if(itemsSelectedNumb<=1){this.unselectAllPages();this.model.isSelected=true;this.model.view.setCheckboxSelected(true);}
var contextMenuView=new PageContextMenuView({model:this.getModel(),view:this});ContextMenuContainer.addMenu(contextMenuView,e);},goToPageNote:function(){this.trigger('change-tab-editor',{tabName:'note'});this.setPageAsActive();},selectPageByUser:function(){var data={pageId:this.model.get('options').get('pageid')};DataAccess.selectPageByUser(data);DarkanEditorAplicationAPI.getInstance().pageSelected(data);},renderSelectedBy:function(selectedBy){_log('renderSelectedBy',selectedBy);var pageSelectedBy=this.$el.find('.page-selected-by');var pageTemplate=this.pageSelectedByListTemplate({selectedBy:selectedBy});pageSelectedBy.html(pageTemplate);pageSelectedBy.find('.page-selected-by-item').tooltip({html:true,animated:'fade',placement:'left'});},renderSelectByMinaiture:function(value){this.$el.attr('selected-by-miniature',value);},renderSelectByTrigger:function(value){this.$el.attr('selected-by-trigger',value);},});;;var EditablePagesList=PagesList.extend({template:_.template($('#pages-list-template').html()),templateEmpty:_.template($('#pages-empty-list-template').html()),events:{'click .new-page':'createNewPage','click .del-pages':'showDeletePagesWindow','click .copy-page':'duplicatePages','click .visible-pages':'changeVisibleAllPages','click .change-titles-pages':'showChangeTitleWindow','click .select-all-pages':'selectedAllPages','select-all-pages':'selectedAllPages','click .toggle-icon':'toggleRightMenu','unselect-all-pages':'unselectAllPages','update-sort':'updateSort','copy-page-trigger':'copyTrigger','on-paste-page-trigger':'onPasteTrigger',},initialize:function(){this.startListenOnSelectPageByUser();},renderOnePage:function(model){var pageItem=new EditablePageItem({model:model});model.view=pageItem;pageItem.on('on-page-set-as-active',this.onSetPageAsActive,this);pageItem.on('change-tab-editor',this.changeTabEditor,this);pageItem.on('data-picker-picked',this.dataPickerPicked,this);this.$el.find('.pages').append(pageItem.render().$el);pageItem.afterRender();},dataPickerPicked:function(model){this.trigger('data-picker-picked',model,this);},changeTabEditor:function(params){this.trigger('change-tab-editor',params);},addPlusButton:function(){var newPagePlusButton=new NewPagePlusButton();newPagePlusButton.on('add-new-page',this.createNewPageAtLast,this);this.$el.find('.pages').append(newPagePlusButton.render().$el);newPagePlusButton.afterRender();},setFirstPageAsActive:function(){var firstPageModel=this.model.get('collection').first();if(firstPageModel){firstPageModel.view.setPageAsActive();}},disableButtons:function(){this.capabilitiesParmasList=[{value:false,identifier:'.new-page'},{value:false,identifier:'.del-pages'},{value:false,identifier:'.copy-page'},{value:false,identifier:'.visible-pages'},{value:false,identifier:'.change-titles-pages'},{value:false,identifier:'.select-all-pages'},{value:false,identifier:'.unselect-all-pages'},];var deletePageEventsVisitor=DeletePageEventsVisitor.getInstance();this.accept(deletePageEventsVisitor);},enableButtons:function(){this.capabilitiesParmasList=[{value:true,identifier:'.new-page',fun:'createNewPage'},{value:true,identifier:'.del-pages',fun:'showDeletePagesWindow'},{value:true,identifier:'.copy-page',fun:'duplicatePages'},{value:true,identifier:'.visible-pages',fun:'changeVisibleAllPages'},{value:true,identifier:'.change-titles-pages',fun:'showChangeTitleWindow'},{value:true,identifier:'.select-all-pages',fun:'selectedAllPages'},{value:true,identifier:'.unselect-all-pages',fun:'unselectAllPages'},];var addEventsVisitor=AddEventsVisitor.getInstance();this.accept(addEventsVisitor);},createNewPageAtLast:function(){var _that=this;var newPageModel=ProjectModel.instance.createNewPageModel();var oldPageId;var lastPageModel=this.model.get('collection').last();if(lastPageModel){oldPageId=lastPageModel.get('options').get('pageid');}
this.addNewPage(newPageModel,function(){_that.render();_that.afterRender();},function(){},oldPageId);},createNewPage:function(){var _that=this;var newPageModel=ProjectModel.instance.createNewPageModel();this.addNewPage(newPageModel,function(){_that.render();_that.afterRender();},function(){});},addNewPage:function(newPageModel,onResult,onFault,oldPageId){var _that=this;this.disableButtons();var oldPageId=oldPageId==undefined?this.getSelectedPageModelPageId():oldPageId;DataAccess.createBlankPage({oldPageId:oldPageId,page:newPageModel},function(data){_log('Create page successed: ',data,_log.dataaccessOutResult);var pageModel=_that.onCreateBlankPage(data);_that.selectedPageModel=pageModel;onResult(pageModel);_that.setPageAsActive(pageModel);DarkanEditorAplicationAPI.getInstance().pageAdded({page:pageModel.toJSON(),pagesLength:_that.getPagesLength()});DarkanEditorAplicationAPI.getInstance().pagesCollectionChanged({pagesLength:_that.getPagesLength()});_that.enableButtons();},function(data){console.log('Create page failed: ',data,_log.dataaccessOutFault);onFault(data);_that.enableButtons();});},addNewPdfPage:function(newPageModel,onResult,onFault,oldPageId){var _that=this;this.disableButtons();var oldPageId=oldPageId==undefined?this.getSelectedPageModelPageId():oldPageId;DataAccess.createBlankPage({oldPageId:oldPageId,page:newPageModel},function(data){_log('Create page successed: ',data,_log.dataaccessOutResult);var pageModel=_that.onCreateBlankPage(data);onResult(pageModel);DarkanEditorAplicationAPI.getInstance().pageAdded({page:pageModel.toJSON(),pagesLength:_that.getPagesLength()});DarkanEditorAplicationAPI.getInstance().pagesCollectionChanged({pagesLength:_that.getPagesLength()});_that.enableButtons();},function(data){console.log('Create page failed: ',data,_log.dataaccessOutFault);onFault(data);_that.enableButtons();});},getSelectedPageModelPageId:function(){return this.selectedPageModel==undefined?undefined:this.selectedPageModel.get('options').get('pageid');},onCreateBlankPage:function(data){var _that=this;var pageModel=ProjectModel.instance.createPageModel(data.page);var lastPageId=parseInt(data.lastPageId);ProjectModel.instance.get('options').set('last_page_id',lastPageId,{silent:true});var oldPageId=data.oldPageId;if(oldPageId!=undefined){var oldPageIndex=data.oldPageIndex;this.model.get('collection').add(pageModel,{at:oldPageIndex});}else{this.model.get('collection').add(pageModel);}
_log('collection',this.model.get('collection').toJSON());this.trigger('on-page-added',_that);return pageModel;},onCreateBlankPageComing:function(data){var _that=this;var pageModel=ProjectModel.instance.createPageModel(data.page);var lastPageId=parseInt(data.lastPageId);ProjectModel.instance.get('options').set('last_page_id',lastPageId,{silent:true});var oldPageId=data.oldPageId;if(oldPageId!=undefined){var oldPageIndex=data.oldPageIndex;this.model.get('collection').add(pageModel,{at:oldPageIndex});}else{this.model.get('collection').add(pageModel);}
_log('collection',this.model.get('collection').toJSON());if(this.model.get('collection').length==1){this.selectedPageModel=pageModel;this.setPageAsActive(pageModel);}
DarkanEditorAplicationAPI.getInstance().pageAdded({page:pageModel.toJSON(),pagesLength:_that.getPagesLength()});DarkanEditorAplicationAPI.getInstance().pagesCollectionChanged({pagesLength:_that.getPagesLength()});this.trigger('on-page-added',_that);return pageModel;},showDeletePagesWindow:function(e){var _that=this;var windowPosition={top:e.pageY,left:e.pageX};var pagesToDel=0;var pageCollection=this.model.get('collection');pageCollection.each(function(model){if(model.isSelected){pagesToDel++;}});if(this.pageNameEditorView==undefined){this.pageNameEditorView=new DeletePagesWindowView();this.pageNameEditorView.on('on-close',function(){_that.pageNameEditorView=undefined;});this.pageNameEditorView.on('delete-pages',function(pagesIds){_that.deletePages();});var dataToRender={componentModel:this.model,pagesToDel:pagesToDel};$('body').append(this.pageNameEditorView.render(dataToRender).$el);this.pageNameEditorView.setWindowPosition(windowPosition);}},deletePages:function(){var _that=this;var pagesIds=[];var pageCollection=this.model.get('collection');pageCollection.each(function(model){if(model.isSelected){pagesIds.push(model.get('options').get('pageid'));}});if(pagesIds.length==0){return;}
this.disableButtons();DataAccess.deletePages({pagesIds:pagesIds},function(data){_log('Delete page successed: ',data,_log.dataaccessOutResult);_that.enableButtons();_that.onPagesDeletedResult(data);DarkanEditorAplicationAPI.getInstance().pagesRemoved({pagesLength:_that.getPagesLength()});DarkanEditorAplicationAPI.getInstance().pagesCollectionChanged({pagesLength:_that.getPagesLength()});},function(data){_log('Delete page failed: ',data,_log.dataaccessOutFault);_that.enableButtons();});},onPagesDeletedResult:function(data){var _that=this;var deletedPages=data.deletedPages;var pageCollection=this.model.get('collection');var newSelectedPageModel;for(var i=0;i<deletedPages.length;i++){var pageId=deletedPages[i];var pageModel=this.getPageModelByPageId(pageId);if(pageModel){var index=pageCollection.indexOf(pageModel);pageCollection.remove(pageModel);pageModel.view.destroy();newSelectedPageModel=pageCollection.at(index-1);}};if(pageCollection.length==0){this.trigger('show-modal-window',undefined,this);return;}
var firstPageModel=newSelectedPageModel||pageCollection.first();this.setPageAsActive(firstPageModel);},duplicatePages:function(){var _that=this;var pageCollection=this.model.get('collection');var pageIdsListToCopy=this.getIdsFromSelectedPages(pageCollection);if(pageIdsListToCopy.length==0){return;}
var oldPageId=this.getSelectedPageModelPageId();this.disableButtons();_log('pageIdsListToCopy',pageIdsListToCopy);DataAccess.duplicatePages({pagesIds:pageIdsListToCopy,oldPageId:oldPageId},function(data){_log('Duplicate pages result:',data,_log.dataaccessOutResult);_that.onPagesDuplicatedResult(data);_that.enableButtons();},function(data){_log('Duplicate pages fault:',data,_log.dataaccessOutFault);_that.enableButtons();});},onPagesDuplicated:function(data){var newPagesCollction=data.pages;var oldPageIndex=parseInt(data.oldPageIndex);if(!_.isNumber(oldPageIndex)){return;}
if(!_.isArray(newPagesCollction)){return;}
var pageCollection=this.model.get('collection');var duplicatedPagesCollection=new PageCollection();for(var i=newPagesCollction.length-1;i>=0;i--){var page=newPagesCollction[i];var pageModel=ProjectModel.instance.createPageModel(page);if(pageModel){pageCollection.add(pageModel,{at:oldPageIndex});duplicatedPagesCollection.add(pageModel);}};this.render();this.afterRender();return duplicatedPagesCollection.first()||pageCollection.first();},onPagesDuplicatedResult:function(data){var pageModel=this.onPagesDuplicated(data);this.setPageAsActive(pageModel);},onPagesDuplicatedResultComing:function(data){this.onPagesDuplicated(data);},changeVisibleAllPages:function(){var _that=this;var pagesCollection=this.model.get('collection');var setActive=1;var _act=0;var _uni=true;var first=true;pagesCollection.each(function(childModel,index){if(childModel.isSelected){var options=childModel.get('options');if(first){_act=options.get('active');}
if(_uni&&_act!==options.get('active')){_uni=false;}
first=false;}});if(_uni){if(_act==0)
setActive=1;else
setActive=0;}
var selectedPagesOptions=[];pagesCollection.each(function(childModel){if(childModel.isSelected){var options=childModel.get('options');options.onlyRefresh=true;options.set('active',setActive);options.onlyRefresh=false;selectedPagesOptions.push(options.toJSON());}});_log('selectedPagesOptions',selectedPagesOptions);if(selectedPagesOptions.length==0){return;}
var shortedPagesOptions=_.map(selectedPagesOptions,function(o){return _.pick(o,"active","pageid");});this.disableButtons();DataAccess.updatePagesOptions({pagesOptions:shortedPagesOptions},function(data){_log('Update pages options result:',data,_log.dataaccessOutResult);_that.enableButtons();},function(data){_log('Update pages options fault:',data,_log.dataaccessOutFault);_that.enableButtons();});},showChangeTitleWindow:function(e){var _that=this;var windowPosition={top:e.pageY,left:e.pageX};if(this.pageNameEditorView==undefined){this.pageNameEditorView=new PageNameWindowView({pageCollection:this.model.get('collection')});this.pageNameEditorView.on('on-pages-title-changed',this.onPagesTitleChanged,this);this.pageNameEditorView.on('on-close',function(){_that.pageNameEditorView=undefined;});var dataToRender={componentModel:this.model};$('body').append(this.pageNameEditorView.render(dataToRender).$el);this.pageNameEditorView.setWindowPosition(windowPosition);}},onPagesTitleChanged:function(selectedPagesOptions){var _that=this;_log('selectedPagesOptions',selectedPagesOptions);if(selectedPagesOptions.length==0){return;}
var shortedPagesOptions=_.map(selectedPagesOptions,function(o){return _.pick(o,"pagename","pageid");});this.disableButtons();DataAccess.updatePagesOptions({pagesOptions:shortedPagesOptions},function(data){_log('Update pages options result:',data,_log.dataaccessOutResult);_that.render();_that.afterRender();_that.enableButtons();},function(data){_log('Update pages options fault:',data,_log.dataaccessOutFault);_that.enableButtons();});},makeSortable:function(){this.$el.find('.pages').sortable({delay:50,update:function(event,ui){ui.item.trigger('drop-item',ui.item.index());}});},onPasteTrigger:function(event,model){if(this.selectedPageModel.cid==model.cid){this.trigger('onsetpage',model);}},copyTrigger:function(event,model){this.copiedPageTrigger=JSON.stringify(model.toJSON().options.triggers);},updatePageSortComing:function(data){var _that=this;this.onUpdatePageSortResult(data);this.render();},updateSort:function(event,pageModel,position){var _that=this;var pageId=pageModel.get('options').get('pageid');var position=parseInt(position);if(_.isNaN(position)){return;}
DataAccess.updatePageSort({pageId:pageId,position:position},function(data){_log('Update page successed: ',data,_log.dataaccessOutResult);_that.model.get('collection').remove(pageModel);_that.model.get('collection').add(pageModel,{at:position});_that.render();_that.afterRender();},function(data){_log('Update page failed: ',data,_log.dataaccessOutFault);_that.render();_that.afterRender();});},onUpdatePageSortResult:function(data){var pageId=parseInt(data.pageId);var position=parseInt(data.position);if(!_.isNumber(pageId)){return;}
if(!_.isNumber(position)){return;}
var pageModel=this.getPageModelByPageId(pageId);if(!pageModel){return;}
this.model.get('collection').remove(pageModel);this.model.get('collection').add(pageModel,{at:position});this.render();this.afterRender();},copyPagesFromOtherProject:function(pageIds,userId,projectId){var _that=this;if(pageIds.length==0){return;}
this.disableButtons();var oldPageId=this.getSelectedPageModelPageId();DataAccess.duplicatePagesFromOtherProject({pagesIds:pageIds,sourceUserId:userId,sourceProjectId:projectId,oldPageId:oldPageId},function(data){_log('Copy page result:',data,_log.dataaccessOutResult);_that.onCopyPagesFromOtherProjectResult(data);_that.enableButtons();},function(data){_log('Copy page fault:',data,_log.dataaccessOutFault);_that.enableButtons();});},onCopyPagesFromOtherProject:function(data){var _that=this
var pageCollection=this.model.get('collection');var oldPageId=data.oldPageId;var projectOptions=data.projectOptions;var options=data.projectOptions;var projectOptionsModel=ProjectModel.instance.get('options');for(var item in options){projectOptionsModel.set(item,options[item],{silent:true});}
var oldPageIndex=pageCollection.length;if(oldPageId){var oldPageModel=this.getPageModelByPageId(oldPageId);oldPageIndex=this.getPageIndexByPageModel(oldPageModel)+1;}
var duplicatedPagesCollection=new PageCollection();for(var i=data.pages.length-1;i>=0;i--){var copyPageModel=this.model.createPageModel(data.pages[i]);pageCollection.add(copyPageModel,{at:oldPageIndex});duplicatedPagesCollection.add(copyPageModel);};var lastPageId=parseInt(data.lastPageId);ProjectModel.instance.get('options').set('last_page_id',lastPageId,{silent:true});ProjectModel.instance.calculateAllScoreSuccessPoints();this.render();this.afterRender();return duplicatedPagesCollection.first()||pageCollection.first();},onCopyPagesFromOtherProjectResult:function(data){var pageModel=this.onCopyPagesFromOtherProject(data);this.setPageAsActive(pageModel);},onCopyPagesFromOtherProjectResultComing:function(data){var pageModel=this.onCopyPagesFromOtherProject(data);},createPsdPage:function(data){var _that=this;_log('createPsdPage',data);var _that=this;var oldPageIndex=data.oldPageIndex;var pageModel=ProjectModel.instance.createPageModel(data.page);this.model.get('collection').add(pageModel,{at:oldPageIndex});var lastPageId=parseInt(data.lastPageId);this.model.get('options').set('last_page_id',lastPageId,{silent:true});_that.render();_that.afterRender();pageModel.view.setPageAsActive();pageModel.view.updateDinamicPageThumb();},startListenOnSelectPageByUser:function(){var _that=this;DataAccess.onSelectPageByUser({},function(data){_log('On select page by user result: ',data,_log.dataaccessOutResult);_that.onSelectPageByUser(data);},function(data){_log('On select page by user fault: ',data,_log.dataaccessOutFault);});},selectPageOnStart:function(){var selectedPages=this.model.get('selectedPages');_log('selectPageOnStart',selectedPages);_log('this.model',this.model);if(_.isUndefined(selectedPages)){return}
this.onSelectPageByUser(selectedPages);this.model.unset('selectedPages');},onSelectPageByUser:function(data){var pages=data;this.resetSelectedByUser();if(!_.isObject(pages)){return;}
for(var item in pages){var pageId=parseInt(item);if(!_.isNumber(pageId)){continue;}
var pageModel=this.getPageModelByPageId(pageId);if(_.isUndefined(pageModel)){continue;}
var selectedBy=pages[item];pageModel.view.renderSelectedBy(selectedBy);};},resetSelectedByUser:function(){this.model.get('collection').each(function(pModel){pModel.view.renderSelectedBy([]);});}});;;var NotEditablePageItem=PageItem.extend({template:_.template($('#not-editable-page-item-template').html()),events:{'click .page-thumb':'onClick','click .dinamic-page-thumb-overlay':'onClick','mousedown':'onMouseDown',},initialize:function(){},showContextMenu:function(e){var itemsSelectedNumb=0;this.model.collection.each(function(model){if(model.isSelected){itemsSelectedNumb++;}});if(itemsSelectedNumb<=1){this.unselectAllPages();this.model.isSelected=true;this.model.view.setCheckboxSelected(true);}
var contextMenuView=new SecondPageContextMenuView({model:this.getModel(),view:this});ContextMenuContainer.addMenu(contextMenuView,e);},serializeData:function(){var options=this.model.toJSON();options.order=this.model.collection.indexOf(this.model)+1;options.isSelected=this.model.isSelected;options.options.userId=this.model.ownerId;options.options.projectId=this.model.projectId;return options;},});;;var NotEditablePagesList=PagesList.extend({template:_.template($('#not-editable-pages-list-template').html()),templateEmpty:_.template($('#not-editable-pages-empty-list-template').html()),events:{'click .select-all-pages':'selectedAllPages','select-all-pages':'selectedAllPages','click .toggle-icon':'toggleRightMenu','unselect-all-pages':'unselectAllPages','click .second-pages-list-copy-page':'copyPages','click .second-pages-list-open-page':'openInNewTab'},initialize:function(){},renderOnePage:function(model){var pageItem=new NotEditablePageItem({model:model});model.view=pageItem;pageItem.on('on-page-set-as-active',this.onSetPageAsActive,this);this.$el.find('.pages').append(pageItem.render().$el);pageItem.afterRender();},openInNewTab:function(){var projectId=this.model.projectId;var href=window.location.href;var arr=href.split('/');arr[arr.length-1]=projectId;href=arr.join('/');window.open(href,'_blank');},copyPages:function(){var pageCollection=this.model.get('collection');var pageIds=this.getIdsFromSelectedPages(pageCollection);_log('pageIds',pageIds);_log('this.model',this.model);if(pageIds.length==0){return;}
var userId=this.model.userId;var projectId=this.model.projectId;_log('userId',userId);_log('projectId',projectId);ProjectView.instance.copyPagesFromOtherProject(pageIds,userId,projectId);},});;;var NewPageSection=Backbone.View.extend({tagName:'div',className:'new-page-section-view',template:_.template($('#new-page-section-template').html()),events:{},initialize:function(){},render:function(dataModel){var template=this.template(dataModel);this.$el.html(template);return this;},serializeData:function(){return{};},events:function(){return _.extend({},WindowView.prototype.events,{'click .starting-page-add-blank':'addNewBlankPage','click .new-page-item-select':'selectItem','click .new-page-item-back':'back','click .new-page-item-add':'addPage','click .starting-page-import-psd':'addPsdPage','click .starting-page-import-pdf':'addPdfPage'});},initialize:function(data){this.shareTemplateCollection=new NewPageItemCollection();this.templateCollection=new NewPageItemCollection();this.getTemplatesProjectsList();this.afterInitialize();},afterInitialize:function(){this.getCapabilities();},getCapabilities:function(){var capabilities=Capabilities.getInstance();capabilities.on('change',this.onCapabilitiesChanged,this);capabilities.getCapabilities();},onCapabilitiesChanged:function(capabilitiesModel){this.capabilitiesParmasList=capabilitiesModel.createParams([{name:'importpdf',identifier:'.starting-page-import-pdf'},{name:'importpsd',identifier:'.starting-page-import-psd'}]);var deleteEventsVisitor=DeleteEventsVisitor.getInstance();this.accept(deleteEventsVisitor);capabilitiesModel.off();},afterRender:function(){this.$el.find('.starting-page-icon').tooltip({html:true,animated:'fade',placement:'top'});},back:function(){this.showTemplatesList();},addPage:function(e){var sender=$(e.currentTarget);var item=JSON.parse(sender.attr('item'));var userId=item.userId;var projectId=item.projectId;var pageId=item.pageId;this.trigger('copy-page',[pageId],userId,projectId);},selectItem:function(e){var sender=$(e.currentTarget);var item=JSON.parse(sender.attr('item'));var map=item.map;var detailsCollection=new NewPageItemCollection();var dataModel={};dataModel.templateCollection=undefined;dataModel.shareTemplateCollection=undefined;if(map){var pages=map.pages;for(var i=0;i<pages.length;i++){this.createDetailTemplateList(item,i,detailsCollection);};}
dataModel.detailsCollection=detailsCollection.toJSON();this.render(dataModel);},getTemplatesProjectsList:function(){var _that=this;DataAccess.getTemplatesProjectsList({},function(responce){_that.createList(responce);},function(responce){_log('getTemplatesProjectsList fault',responce,_log.dataaccessOutFault);});},createList:function(data){var shareTemplateProjectData=data.shareTemplateProjectData;var templateProjectData=data.templateProjectData;_log('templateProjectData',templateProjectData,_log.timeline);this.createTemplateList(templateProjectData,this.templateCollection);this.createTemplateList(shareTemplateProjectData,this.shareTemplateCollection);this.showTemplatesList();},showTemplatesList:function(){var dataModel={};dataModel.templateCollection=this.templateCollection.toJSON();dataModel.shareTemplateCollection=this.shareTemplateCollection.toJSON();dataModel.detailsCollection=undefined;this.render(dataModel);},showDetailsTemplatesList:function(){},createTemplateList:function(templates,collection){_log("Templates",templates);for(var i=0;i<templates.length;i++){var template=templates[i];var map=template.map;if(!map||map.pages.length<=0){continue;}
var userId=template.user_id;var projectId=template.project_id;var name=template.name;var pageId=map.pages!=undefined?map.pages[0]:0;if(pageId!=0){var r='?r='+new Date().getUTCMilliseconds();var src=__meta__.projects_link+userId+'/'+projectId+'/pre/exported_view/'+pageId+'/pagethumb.jpg'+r;var newPageItemModel=new NewPageItemModel({userId:userId,projectId:projectId,pageId:pageId,name:name,src:src,map:map});collection.add(newPageItemModel);}};},createDetailTemplateList:function(item,page,collection){var userId=item.userId;var projectId=item.projectId;var map=item.map;var name=item.name;var pageId=map.pages[parseInt(page)];var r='?r='+new Date().getUTCMilliseconds();var src=__meta__.projects_link+userId+'/'+projectId+'/pre/exported_view/'+pageId+'/pagethumb.jpg'+r;var newPageItemModel=new NewPageItemModel({userId:userId,projectId:projectId,pageId:pageId,name:name,src:src});collection.add(newPageItemModel);},addNewBlankPage:function(){this.trigger('add-new-blank-page');},addPsdPage:function(){this.trigger('add-new-psd-page');},addPdfPage:function(){this.trigger('add-new-pdf-page');},accept:function(visitor){visitor.visit(this);},destroy:function(){this.remove();}});;;var ProjectsListItemModel=Backbone.Model.extend({defaults:{date:"",date_modification:"",dimentions:"",external:null,last_visit:"",name:"",project_id:null,size:null,skin:"",status:0,template:null,user_id:null,version:"",fromuser:"",pType:""},initialize:function(){}});;;var ProjectsListItem=Backbone.View.extend({tagName:'li',className:'project-item-block',template:_.template($('#projects-list-item-template').html()),events:{'click':'openProject'},initialize:function(){},render:function(){var template=this.template(this.serializeData());this.$el.html(template);return this;},serializeData:function(){return this.model.toJSON();},afterRender:function(){},openProject:function(){this.trigger('open-project',this.model);}});;;var ExistingProjectsCollection=Backbone.Collection.extend({model:ProjectsListItemModel,comparator:function(model){return model.get('name').toLowerCase();},searchStructore:function(value){var searchValue=value.toLowerCase();filtered=this.filter(function(model){var name=model.get("name").toLowerCase();var fromuser=model.get("fromuser");if(name.indexOf(searchValue)!=-1||(fromuser&&fromuser.toLowerCase().indexOf(searchValue)!=-1)){return true;}else{return false;}});return new ExistingProjectsCollection(filtered);}});;;var ProjectsListSection=Backbone.View.extend({tagName:'div',className:'projects-list-section',template:_.template($('#projects-list-section-template').html()),events:{'keyup .projects-list-search-input':'searchProjectList','paste .projects-list-search-input':'searchProjectList','click .remove-search-value':'removeSearchValue',},initialize:function(){this.collection=new ExistingProjectsCollection();},render:function(){var template=this.template(this.serializeData());this.$el.html(template);return this;},serializeData:function(){return{};},afterRender:function(){this.createProjectsList();},removeSearchValue:function(e){var searchInput=this.$el.find('.projects-list-search-input');searchInput.val('');searchInput.focus();this.search("");},searchProjectList:function(e){var value=$(e.target).val();this.search(value);},search:function(value){var collection=this.getProjectsBySearchValue(value);this.renderList(collection,value);},getProjectsBySearchValue:function(value){return this.collection.searchStructore(value);},createProjectsList:function(){var projectListController=new ProjectListController();projectListController.on('open-project',this.openProject,this);this.$el.html(projectListController.render().$el);projectListController.afterRender();},getAllProjects:function(){var _that=this;DataAccess.getAllProjectsList({},function(data){_log('Get All Projects List fault: ',data,_log.dataaccessOutResult);var shareProjectData=data.shareProjectData||[];var shareTemplateProjectData=data.shareTemplateProjectData||[];var templateProjectData=data.templateProjectData||[];var userProjectData=data.userProjectData||[];_that.createList(shareProjectData,'0');_that.createList(shareTemplateProjectData,'1');_that.createList(templateProjectData,'2');_that.createList(userProjectData,'3');},function(data){_log('Get All Projects List fault: ',data,_log.dataaccessOutFault);});},createList:function(list,type){for(var i=0;i<list.length;i++){var item=list[i];var projectsListItemModel=new ProjectsListItemModel(item);projectsListItemModel.set('pType',type);this.collection.add(projectsListItemModel);};this.renderList(this.collection,"");},renderList:function(collection,value){this.$el.find('.news-project-data').html('');this.$el.find('.share-project-data').html('');this.$el.find('.share-template-project-data').html('');this.$el.find('.template-project-data').html('');this.$el.find('.user-project-data').html('');collection.each(this.renderOneProject,this);this.renderNewsList(collection);},renderNewsList:function(collection){_log('collection.toArray()',collection.toArray());var news=new ExistingProjectsCollection(collection.toArray());news.comparator=function(model){return model.get('date');}
news.sort();_log('news',news);for(var i=0;i<10;i++){var model=news.at(i);_log('model',model);if(!model){break;}
this.renderOneNewProject(model);};},renderOneNewProject:function(model){var projectsListItem=new ProjectsListItem({model:model});projectsListItem.on('open-project',this.openProject,this);var container=this.$el.find('.news-project-data');container.append(projectsListItem.render().$el);projectsListItem.afterRender();},renderOneProject:function(model){var _that=this;var projectsListItem=new ProjectsListItem({model:model});projectsListItem.on('open-project',this.openProject,this);var pType=model.get('pType');switch(pType){case'0':var container=_that.$el.find('.share-project-data');container.append(projectsListItem.render().$el);projectsListItem.afterRender();break;case'1':var container=_that.$el.find('.share-template-project-data');container.append(projectsListItem.render().$el);projectsListItem.afterRender();break;case'2':var container=_that.$el.find('.template-project-data');container.append(projectsListItem.render().$el);projectsListItem.afterRender();break;case'3':var container=_that.$el.find('.user-project-data');container.append(projectsListItem.render().$el);projectsListItem.afterRender();break;}},openProject:function(model){this.trigger('open-project',model);},destroy:function(){this.$el.parent().remove();this.remove();}});;;var ProjectOptions=Backbone.Model.extend({defaults:{name:'',move_grid:1,copy_grid:60,image_quality:100,snapping:true,showsnaplines:true,show_titles:false,draggable_snaptolerance:10,scorm_score_required:false,require_score:false,require_score_points:0,max_points_number:0,require_pages:true,require_elements:false,continue_method:'popup',help_title:"",sound_loop:true,sound_vol:100,pagelisttype:'thumbs',singlefile:true,orginal_images:false,convert_sound_to_ogg:true,dimentions:'default',skin:'sk00',lang:'pl',thumb:'',toc_enabled:true,last_page_id:0,projectVariables:[],pagesDraws:[],keep_dimensions:false,load_every_page_at_start:false,soundfilename:'',autoScale:false,},setFileName:function(data){this.set('soundfilename',data.fileName);},initialize:function(){var width=this.get('width');if(!width){var dimentions=__meta__.projectDimentions;var blankWidth=dimentions.split('x')[0];this.set('width',blankWidth,{silent:true});}
var height=this.get('height');if(!height){var dimentions=__meta__.projectDimentions;var blankHeight=dimentions.split('x')[1];this.set('height',blankHeight,{silent:true});}
this.set('staticVariables',this.getStaticVariables());this.listenTo(this,'change:max_points_number',this.changeMaxPointNumber);},changeMaxPointNumber:function(model){var variable=this.getStaticVariableByName('_maxscore');if(variable!==false)
variable.pvarvalue=this.get('max_points_number');},getStaticVariableByName:function(name){var staticVariables=this.get('staticVariables');var ret=false;_.each(staticVariables,function(variable){if(variable.pvarname===name){ret=variable;}});return ret;},getStaticVariables:function(){return[{varhash:'00000000000000000000000000000000',pvarname:'_score',pvarvalue:0},{varhash:'00000000000000000000000000000001',pvarname:'_maxscore',pvarvalue:this.get('max_points_number')},{varhash:'00000000000000000000000000000002',pvarname:'_percentscore',pvarvalue:0},{varhash:'00000000000000000000000000000003',pvarname:'_diamonds',pvarvalue:0}]}});var ProjectMap=Backbone.Model.extend({defaults:{pages:[]}});var ProjectModel=Backbone.Model.extend({defaults:{options:new ProjectOptions(),collection:new PageCollection(),name:'...'},initialize:function(){},getAllComponents:function(){var componentCollection=new ComponentCollection();this.get('collection').each(function(pageModel){pageModel.get('lines').each(function(rowModel){rowModel.get('objects').each(function(componentModel){componentCollection.add(componentModel);});});});return componentCollection;},getAllPages:function(){return this.get('collection');},loadProjectById:function(data,onLoadProject,onNotLoadProject){var _that=this;var projectId=_.clone(data.projectId);var userId=_.clone(data.userId);var collection=new PageCollection();DataAccess.loadProjectById(data,function(responseData){var options=responseData.options;var pages=responseData.pages;if(options!=undefined){var projectOptions=new ProjectOptions(options);_that.set('options',projectOptions,{silent:true});}
if(pages!=undefined){for(var i=0;i<pages.length;i++){var page=pages[i];_log('loadProjectById projectId',projectId);_log('loadProjectById userId',userId);var newPageModel=_that.createPageModel(page);newPageModel.projectId=projectId;newPageModel.userId=userId;newPageModel.ownerId=userId;collection.add(newPageModel);_log('loadProjectById newPageModel',newPageModel);};}
_that.set('collection',collection,{silent:true})
onLoadProject(_that);},function(respnseData){_log("respnseData",respnseData);});},loadProject:function(onLoadProject,onNotLoadProject){var _that=this;DataAccess.loadProject({options:this.get('options')},function(responseData){_log('Load Project Result',responseData,_log.dataaccessOutResult);var collection=_that.onGetProjectData(responseData);onLoadProject(_that);},function(respnseData){if(respnseData.code==1){_log('Error convert project',respnseData,_log.error);}});},onGetProjectData:function(responseData){var _that=this;var collection=new PageCollection();var pages=responseData.pages;var options=responseData.options;var selectedPages=responseData.selectedPages;var selectedComponents=responseData.selectedComponents;var projectOptions;if(options!=undefined){projectOptions=new ProjectOptions(options);_that.set('options',projectOptions);}
if(pages!=undefined){for(var i=0;i<pages.length;i++){var page=pages[i];var newPageModel=_that.createPageModel(page);collection.add(newPageModel);};}
_log('selectedComponents',selectedComponents);this.set('selectedPages',selectedPages);this.set('selectedComponents',selectedComponents);_that.get('options').on('change',function(model){_that.saveProjectOptions(model);});_that.set('collection',collection);ProjectModel.instance=this;return collection;},createNewPageModel:function(){var singleRow=new TimelineRowModel({objects:new TimelineItemCollection([]),options:new TimelineRowOptionsModel()});var timeline=new TimelineRowCollection(singleRow);var newPageModel=new PageModel({lines:timeline,options:new PageOptions()});return newPageModel;},createPageModel:function(page){var timelineRowCollection=new TimelineRowCollection();var lines=page.lines;var options=page.options;if(lines!=undefined){for(var j=0;j<lines.length;j++){var line=lines[j];var singleRow=new TimelineRowModel({objects:new TimelineItemCollection([]),options:new TimelineRowOptionsModel(line.options)});if(line.options.active){options.activeRow=singleRow;}
var objects=line.objects;for(var k=0;k<objects.length;k++){var object=objects[k];var componentModel=ComponentFactory.createComponentModelByType(object.type,object);singleRow.get('objects').add(componentModel);};timelineRowCollection.add(singleRow);};}
var pageOptions=new PageOptions(options);var newPageModel=new PageModel({lines:timelineRowCollection,options:pageOptions});return newPageModel;},createProjectOptionsModel:function(options){var projectOptionsModel=new ProjectOptions(options);return projectOptionsModel;},setProjectOptionsModel:function(projectOptionsModel){this.set('options',projectOptionsModel);},getProjectOptionsModel:function(){return _that.get('options');},updatePage:function(pageModel){DataAccess.updatePage(pageModel,function(data){_log('Update page successed: ',data,_log.dataaccessOutResult)},function(data){_log('Update page failed: ',data,_log.dataaccessOutResult)});},saveProjectOptions:function(model){var projectOptions=this.get('options');DataAccess.saveProjectOptions({projectOptions:projectOptions},function(data){_log('Save project options successed: ',data,_log.dataaccessOutResult)},function(data){_log('Save project options: ',data,_log.dataaccessOutFault)});},getPageModelByPageId:function(pageId){var pageModel=false;this.get('collection').each(function(model){if(model.get('options').get('pageid')==pageId){pageModel=model;}});return pageModel;},calculateAllScoreSuccessPoints:function(){var calcPointsAutomatically=this.get('options').get('calc_points_automatically');if(calcPointsAutomatically){var componentCollection=this.getAllComponents();var pagesCollection=this.getAllPages();var maxPoints=0;maxPoints=this.calculateComponentsPoints(componentCollection,maxPoints,'components');maxPoints=this.calculateComponentsPoints(pagesCollection,maxPoints,'pages');this.get('options').set('max_points_number',maxPoints);}},calculateComponentsPoints:function(collection,maxPoints,collectionType){collection.each(function(cModel){var triggers;if(collectionType==='components')
triggers=cModel.get('triggers');else
triggers=cModel.get('options').get('triggers');_.each(triggers,function(trigger){var subtriggers=trigger.subtriggers;_.each(subtriggers,function(subtrigger){var objs=subtrigger.objs;if(objs.varName==='00000000000000000000000000000000'&&objs.varAction==='add'){var varValue=parseInt(objs.varValue);maxPoints+=varValue;}});});});return maxPoints;},getQuestionsObject:function(){var pagesCollection=this.get('collection');var questionData=[];pagesCollection.each(function(pModel){var lines=pModel.get('lines');lines.each(function(lModel){var components=lModel.get('objects');components.each(function(cModel){var objectID=cModel.get('actionkey');var componentType=cModel.get('type');switch(componentType){case'quiz':case'quiz-dnd':case'quiz-selectone':case'quiz-connectlines':case'quiz-inputtext':case'quiz-select':case'form-inputtext':case'form-textarea':case'form-select':case'form-radio':case'form-checkbox':var questionObject=cModel.toJSON();var strippedQuestionObject=_.pick(questionObject,'actionkey','type','width','height','attempts','answers','scoreSuccess','scoreFail','scoreBadAnswer','styles','formData','reportName','contents','groupName');questionData.push(strippedQuestionObject);break;}});});});return questionData;},updatePagesOptions:function(data){var pagesOptions=data.pagesOptions;if(!_.isArray(pagesOptions)){return;}
var pagesIds=_.pluck(pagesOptions,'pageid');this.get('collection').each(function(pageModel){var pageOptionsModel=pageModel.get('options');var pageId=pageOptionsModel.get('pageid');var index=pagesIds.indexOf(pageId);var options=pagesOptions[index];if(options){pageOptionsModel.onlyRefresh=true;for(var item in options){pageOptionsModel.set(item,options[item]);};pageOptionsModel.onlyRefresh=false;}});}});ProjectModel.instance=new ProjectModel();;;var ProjectView=Backbone.View.extend({tagName:'li',className:'project-view',template:_.template($('#project-view-template').html()),events:{},initialize:function(){},render:function(){var template=this.template(this.serializeData());this.$el.html(template);return this;},afterRender:function(){this.createHistoryView();this.createWatcherView();var pagesLength=this.model.get('collection').length||0;this.createEditorsControllerView();this.createTriggerView();this.createStageView(this.model.get('collection').first());if(pagesLength==0){this.showModalWindow();}
this.createPageListView();ProjectModel.instance=this.model;},createStageView:function(pageModel){var _that=this;var pageModel=pageModel||ProjectModel.instance.createNewPageModel();this.stageView=new EditableStageView({model:pageModel});this.stageView.on(' show-image-window',function(sender){_that.openImageWindow(0,sender);});this.stageView.on('on-stage-render',function(pModel){_that.onStageRender(pModel);});this.stageView.on('on-stage-selected',function(pModel){_that.onStageSelected(pModel);});this.stageView.on('on-component-selected',function(cModel){_that.onComponentSelected(cModel);});this.stageView.on('on-components-selected',function(scc){_that.onComponentsSelected(scc);});this.stageView.on('update-timeline',function(){_that.updateTimeline();});StageView.instance=this.stageView;this.$el.find('.stage-view-container').html(this.stageView.renderStage().$el);this.stageView.afterRender();},createNewPageSection:function(){this.newPageSection=new NewPageSection();this.newPageSection.on('copy-page',this.copyPage,this);this.newPageSection.on('add-new-blank-page',this.addNewPageSection,this);this.newPageSection.on('add-new-psd-page',this.addNewPageSection,this);this.newPageSection.on('add-new-pdf-page',this.addNewPageSection,this);this.$el.find('.new-page-container').html(this.newPageSection.render().$el);this.newPageSection.afterRender();},createPageListView:function(){this.pagesList=new EditablePagesList({model:this.model});this.pagesList.on('toggle-project-list',this.toggleProjectList,this);this.pagesList.on('set-page',this.setPage,this);this.pagesList.on('change-tab-editor',this.changeTabEditor,this);this.pagesList.on('data-picker-picked',this.dataPickerPicked,this);this.pagesList.on('show-modal-window',this.showModalWindow,this);this.pagesList.on('on-page-added',this.onPageAdded,this);this.$el.find('.pages-list-wrapper').html(this.pagesList.render().$el);this.pagesList.afterRender();},dataPickerPicked:function(model){this.stageView.dataPickerPicked(model);},createTriggerView:function(){var _that=this;this.triggerView=new WindowFactory.createTriggerWindow();$('body').append(this.triggerView.render().$el);this.triggerView.$el.css({top:'100px',left:'calc(100% - 450px)'});$(window).resize(function(){if((_that.triggerView.$el.offset().left+200)>$(this).width()){_that.triggerView.$el.css({left:$(this).width()-200+"px"});}});},createEditorsControllerView:function(pageModel){var pageModel=pageModel||ProjectModel.instance.createNewPageModel();this.editorsController=new EditorsController({model:pageModel});this.editorsController.on('on-resize',this.onEditrsResize,this);this.editorsController.on('data-picker-picked',this.dataPickerPicked,this);this.$el.find('.editors-view-container').html(this.editorsController.render().$el);this.editorsController.afterRender();},onEditrsResize:function(editorControllerView){this.pagesMainList=this.$el.find('.pages-list-wrapper-main');var editorsMenuHeight=editorControllerView.$el.height();var pagesListProperHeight=editorsMenuHeight+82;this.pagesMainList.css('height','calc(100% - '+pagesListProperHeight+'px)');this.stageView.$el.css('height','calc(100% - '+editorsMenuHeight+'px)');},createHistoryView:function(){var _that=this;this.historyListView=new HistoryListView();HistoryListView.instance=this.historyListView;this.historyListView.on('load-history-project',function(data){_that.loadHistoryProject(data);});this.historyListView.on('load-history-page',function(data){_that.loadHistoryPage(data);});$('#history-wrapper').append(this.historyListView.render().$el);_log('dsad',$('#history-wrapper'));this.historyListView.start();},createWatcherView:function(){var _that=this;var projectWatcher=new ProjectWatcherView();},setPage:function(model){if(this.stageView){this.stageView.setModel(model);}},toggleProjectList:function(value){if(value){this.pagesList.hide();this.stageView.$el.css('width','100%');}else{this.pagesList.show();this.stageView.$el.css('width','calc(100% - 262px)');}},serializeData:function(){return{};},copyPage:function(){},copyPagesFromOtherProject:function(pageIds,userId,projectId){this.selectProjectView();this.pagesList.copyPagesFromOtherProject(pageIds,userId,projectId);},createNewPage:function(){this.pagesList.createNewPage();},showDeletePagesWindow:function(e){this.pagesList.showDeletePagesWindow(e);},duplicatePages:function(){this.pagesList.duplicatePages();},addNewPageSection:function(){var _that=this;var newPageModel=ProjectModel.instance.createNewPageModel();this.pagesList.addNewPage(newPageModel,function(createdPageModel){_that.newPageSection.destroy();_that.newPageSection=undefined;_that.pagesList.render();_that.pagesList.afterRender();_that.createStageView(createdPageModel);},function(data){});},addNewPsdPage:function(){},addNewPdfPage:function(){},onKeyDown:function(e){console.log('keydown '+e.which);var _that=this;switch(e.which){case 65:if(e.ctrlKey){this.stageView.selectAllComponents();}
break;case 46:this.stageView.deleteActiveComponent();break;case 27:var windows=$('body').find('.window, .context-menu').not('.trigger-window');_log('windows',windows);var oneWindow=windows.last();_log('oneWindow',oneWindow);if(oneWindow.length>0){oneWindow.trigger('close');}else{this.triggerView.escape();}
break;case 67:if(e.ctrlKey){this.stageView.copyComponents();}
break;case 86:if(e.ctrlKey){if(this.imageWindow){return;}
this.stageView.pasteComponents();}
break;case 66:if(e.ctrlKey){this.showPasteWindow();}
break;case 88:if(e.ctrlKey){this.stageView.cutComponents();}
break;case 81:e.stopPropagation();e.preventDefault();if(e.ctrlKey){this.stageView.duplicateComponents();}
break;case 90:if(e.ctrlKey){this.historyBack();}
break;case 89:if(e.ctrlKey){this.historyPrev();}
break;case 37:case 38:case 39:case 40:this.stageView.moveActiveComponents(e);break;case 32:if(e.ctrlKey){this.stageView.moveSelectedComponentsToNewLine();}
break;case 190:if(e.ctrlKey){var addMultiComponentsWindow=WindowFactory.createAddMultiComponentsWindow();addMultiComponentsWindow.on('add-multi-components',function(data){_that.stageView.addMultiComponents({type:'text',cData:data});});$('body').append(addMultiComponentsWindow.render().$el);addMultiComponentsWindow.afterRender();}
break;}},showPasteWindow:function(){_log('Show paste window');var _that=this;this.imageWindow=WindowFactory.createPasteComponentsWindow();this.imageWindow.on('paste-components',function(hash){_that.stageView.pasteComponents(hash);});this.imageWindow.on('on-close',function(){_that.imageWindow=undefined;});$('body').append(this.imageWindow.render().$el);},onLeftMenuClick:function(model){var _that=this;var componentType=model.get('componentName');switch(componentType){case'image':_that.openImageWindow(0);break;case'video':_that.openVideoWindow(0);break;case'library':_that.openLibraryWindow(0);break;case'shapes':_that.openLibraryWindow(4);break;case'remove':this.stageView.deleteActiveComponent();break;default:_that.addComponent(componentType);break;}},addComponent:function(componentType,onComponentAdded){var componentModel=ComponentFactory.createComponentModelByType(componentType);this.stageView.addComponent(componentModel,onComponentAdded);},openImageWindow:function(activeTab,sender){var _that=this;var imageWindow=WindowFactory.createImageWindow(activeTab,sender);imageWindow.on('on-close',function(fileData){_that.imageWindow=undefined;});imageWindow.on('imageupload-ondrop',function(fileData){_that.addComponent('image',function(componentView){_log('fileData',fileData);componentView.uploadOnFileDrop2(fileData,true);});});imageWindow.on('imageupload-onclick',function(fileData,input){_that.addComponent('image',function(componentView){componentView.uploadOnInputData(fileData,input,true);});});imageWindow.on('imageupload-link',function(imageUrl){_that.addComponent('image',function(componentView){componentView.uploadOnLink(imageUrl,true);});});imageWindow.on('imageupload-on-paste',function(event,blob){_that.addComponent('image',function(componentView){componentView.uploadOnPaste(event,blob,true);});});$('body').append(imageWindow.render().$el);imageWindow.$el.find('.darkan-tabs').tabs("option","active",activeTab);this.imageWindow=imageWindow;},openVideoWindow:function(activeTab){var _that=this;var videoWindow=WindowFactory.createVideoWindow();videoWindow.on('imageupload-ondrop',function(fileData){_that.addComponent('video',function(componentView){componentView.uploadOnFileDrop2(fileData,true);});});videoWindow.on('imageupload-onclick',function(fileData,input){_that.addComponent('video',function(componentView){componentView.uploadOnInputData(fileData,input,false);});});videoWindow.on('putvideolink',function(data){_that.addComponent('video',function(componentView){componentView.putVideoLink(data);});});$('body').append(videoWindow.render().$el);videoWindow.$el.find('.darkan-tabs').tabs("option","active",activeTab);},openLibraryWindow:function(activeTab){var _that=this;var libraryWindow=WindowFactory.createLibraryWindow();$('body').append(libraryWindow.render().$el);libraryWindow.on('imagelibrary-onclick',function(fileData,input){_log('fileData',fileData);_that.addComponent('image',function(componentView){componentView.createImageLibrary(fileData,input,true);});});libraryWindow.$el.find('.darkan-tabs').tabs("option","active",activeTab);},createNewPageTopMenu:function(){var newPageWindow=WindowFactory.createNewpageWindow();this.createNewPageWindow(newPageWindow);},createNewStartingPageWindow:function(){var newPageWindow=WindowFactory.createStartingNewpageWindow();this.createNewPageWindow(newPageWindow);},createNewPageWindow:function(newPageWindow){var _that=this;newPageWindow.on('add-new-blank-page',function(){var newPageModel=_that.pagesList.createNewPage();});newPageWindow.on('add-new-psd-page',function(){var importWindow=WindowFactory.createImportWindow();importWindow.on('close-window',function(){newPageWindow.close();newPageWindow=undefined;});$('body').append(importWindow.render().$el);importWindow.importPsdOnClick();});newPageWindow.on('add-new-pdf-page',function(){var importWindow=WindowFactory.createImportWindow();importWindow.on('close-window',function(){newPageWindow.close();newPageWindow=undefined;});$('body').append(importWindow.render().$el);importWindow.importPdf();});_that.newPageWindow=newPageWindow;$('body').append(newPageWindow.render().$el);},loadHistoryPage:function(data){var _that=this;if(!_.isObject(data)){return;}
_log('loadHistoryPage',data);var action=data.action||{};var nowAction=data.nowAction||{};var params=nowAction.params||{};var pageId=parseInt(params.pageId);var pageModel=this.getPageModelByPageId(pageId);if(pageModel){var page=data.page;_log('pageId',pageId,_log.error);_log('page.options.pageid',page.options.pageid,_log.error);if(page.options.pageid==pageId){var newPageModel=ProjectModel.instance.createPageModel(page);pageModel.set('options',newPageModel.get('options'),{silent:true});pageModel.set('lines',newPageModel.get('lines'),{silent:true});if(action.login==__meta__.login){pageModel.changesWereMade=false;pageModel.view.setPageAsActive(pageModel);pageModel.changesWereMade=true;pageModel.updateDinamicPageThumb();}}}},loadHistoryProject:function(data){var _that=this;if(!_.isObject(data)){return;}
var action=data.action||{};var nowAction=data.nowAction||{};var params=nowAction.params||{};var pageId=parseInt(params.pageId);_log('loadHistoryProject',data);this.model=new ProjectModel({options:new ProjectOptions(),collection:new PageCollection()});var collection=this.model.onGetProjectData(data);this.model.set('collection',collection);this.addEventsToCollection();this.pagesList.model=this.model;this.pagesList.render();this.pagesList.afterRender();var pageModel=this.getPageModelByPageId(pageId)||collection.first();if(pageModel){if(action.login==__meta__.login){pageModel.changesWereMade=false;pageModel.view.setPageAsActive(pageModel);pageModel.changesWereMade=true;pageModel.updateDinamicPageThumb();StageView.instance.createPageThumb(function(){pageModel.view.render();pageModel.view.afterRender();});}}},pageIsTheSame:function(pageId){return(pageId==StageView.instance.model.get('options').get('pageid'));},getPageModelByPageId:function(pageId){var pageModel;this.model.get('collection').each(function(model){if(model.get('options').get('pageid')==pageId){pageModel=model;}});return pageModel;},addEventsToCollection:function(){var collection=this.model.get('collection');collection.off();collection.on('reset add remove',function(){DarkanEditorAplicationAPI.getInstance().pagesCollectionChanged({pagesLength:collection.length});});},onStageRender:function(pModel){var _that=this;_that.triggerView.setModel(pModel.get('options'));_that.editorsController.setStageModel(pModel);},onStageSelected:function(pModel){var _that=this;setTimeout(function(){_that.triggerView.setModel(pModel.get('options'));_that.editorsController.setModelToOpenEditors(pModel);_that.disableTopMenuButtons(pModel);},100);},onComponentSelected:function(cModel){var _that=this;setTimeout(function(){_that.triggerView.setModel(cModel);_that.editorsController.setModelToOpenEditors(cModel);_that.disableTopMenuButtons(cModel);},100);},onComponentsSelected:function(scc){var _that=this;setTimeout(function(){_that.triggerView.setCollection(scc);_that.editorsController.setModelToOpenEditors(scc);_that.disableTopMenuButtons(scc);},100);},disableTopMenuButtons:function(model){this.trigger('disable-top-menu-buttons',model);},updateTimeline:function(){},changeTabEditor:function(params){this.editorsController.changeTabEditor(params);},topMenuAction:function(action){switch(action){case'open-existing-project':this.openExistingProject();break;case'move-components-to-new-layer':this.stageView.moveSelectedComponentsToNewLine();break;case'duplicate-components':this.stageView.duplicateComponents();break;case'paste-special-components':this.showPasteWindow();break;case'paste-components':this.stageView.pasteComponents();break;case'copy-components':this.stageView.copyComponents();break;case'cut-components':this.stageView.cutComponents();break;case'history-prev':this.historyPrev();break;case'history-back':this.historyBack();break;case'copy-conponents-from-other-project':this.historyBack();break;}},historyBack:function(){HistoryListView.instance.back();},historyPrev:function(){HistoryListView.instance.prev();},createPsdPage:function(data){this.pagesList.createPsdPage(data);},showModalWindow:function(){this.createNewStartingPageWindow();},onPageAdded:function(){if(this.newPageWindow){this.hideModalWindow();}},hideModalWindow:function(){this.newPageWindow.close();},openExistingProject:function(){this.trigger('open-existing-project');},show:function(){this.triggerView.show();this.$el.show();},hide:function(){this.triggerView.hide();this.$el.hide();},selectProjectView:function(projectModel){this.model.trigger('select-project-view',projectModel||ProjectView.instance.model);},goToNextPage:function(data,sender){var pageModel=this.pagesList.getSelectedPageModel();var pagesCollection=this.pagesList.getPagesCollection();var index=pagesCollection.indexOf(pageModel);var nextPageModel=pagesCollection.at(index+1);if(nextPageModel){this.pagesList.setPageAsActive(nextPageModel);}},goToPrewPage:function(data,sender){var pageModel=this.pagesList.getSelectedPageModel();var pagesCollection=this.pagesList.getPagesCollection();var index=pagesCollection.indexOf(pageModel);var nextPageModel=pagesCollection.at(index-1);if(nextPageModel){this.pagesList.setPageAsActive(nextPageModel);}},goToPage:function(data,sender){var pageIndex=parseInt(data.pageIndex);if(_.isNaN(pageIndex)){return;}
var pagesCollection=this.pagesList.getPagesCollection();var nextPageModel=pagesCollection.at(pageIndex);if(nextPageModel){this.pagesList.setPageAsActive(nextPageModel);}},sortPages:function(data,sender){var pageIndex=parseInt(data.pageIndex);var position=parseInt(data.position);if(_.isNaN(pageIndex)){return;}
if(_.isNaN(position)){return;}
if(position<0){return;}
if(pageIndex==position){return;}
var pagesCollection=this.pagesList.getPagesCollection();var pageModel=pagesCollection.at(pageIndex);if(!pageModel){return;}
var newPageModel=pagesCollection.at(position);if(!newPageModel){return;}
this.pagesList.updateSort('updateSort',pageModel,position);},});;;var NotEditableProjectView=Backbone.View.extend({tagName:'li',className:'project-view',template:_.template($('#not-editable-project-view-template').html()),events:{},initialize:function(){},render:function(){var template=this.template(this.serializeData());this.$el.html(template);this.$el.find('.pages-list-wrapper').hide();this.createPrjectsListSection();return this;},createStageView:function(pageModel){var pageModel=pageModel||ProjectModel.instance.createNewPageModel();this.stageView=new NotEditableStageView({model:pageModel});this.$el.find('.stage-view-container').html(this.stageView.renderStage().$el);this.stageView.afterRender();this.stageView.setModel(pageModel);},createEmptyStageView:function(){this.stageView=new EmptyStageView();this.$el.find('.stage-view-container').html(this.stageView.renderStage().$el);this.stageView.afterRender();},createPrjectsListSection:function(){this.projectsListSection=new ProjectsListSection();this.projectsListSection.on('open-project',this.openProject,this);this.$el.find('.projects-list-container').html(this.projectsListSection.render().$el);this.projectsListSection.afterRender();},createPageListView:function(){this.$el.find('.pages-list-wrapper').show();this.pagesList=new NotEditablePagesList({model:this.model});this.pagesList.on('toggle-project-list',this.toggleProjectList,this);this.pagesList.on('set-page',this.setPage,this);this.$el.find('.pages-list-wrapper').html(this.pagesList.render().$el);this.pagesList.afterRender();},setPage:function(model){if(this.stageView){this.stageView.setModel(model);}},toggleProjectList:function(value){if(value){this.pagesList.hide();this.stageView.$el.css('width','100%');}else{this.pagesList.show();this.stageView.$el.css('width','calc(100% - 262px)');}},serializeData:function(){return{};},afterRender:function(){},copyPage:function(){},addNewPage:function(){},openProject:function(projectItemModel){_log('openProject',projectItemModel)
this.getProjectById(projectItemModel);},getProjectById:function(projectItemModel){var _that=this;var projectId=projectItemModel.get('project_id');var userId=projectItemModel.get('owner')||projectItemModel.get('user_id');if(!userId||!projectId){this.showPupup({content:_lang('OPEN_PROJECT_ERROR'),title:_lang('MODAL_INFO_ERROR')},this);return;}
userId=parseInt(userId);_log('getProjectById',projectItemModel.toJSON());this.showProjectViewLoader();this.model.loadProjectById({projectId:projectId,userId:userId},function(projectModel){_log('getProjectById projectModel',projectModel,_log.error);projectModel.projectId=projectId;projectModel.userId=userId;projectModel.ownerId=userId;_that.projectsListSection.destroy();_log('loadProjectById',_that);_that.createPageListView();if(projectModel.get('collection').length>0){_that.createStageView(projectModel.get('collection').first());}else{_that.createEmptyStageView();}
projectModel.set('name',projectItemModel.get('name'));_that.trigger('on-project-open',projectModel);_that.hideProjectViewLoader();},function(){_log("Not load project by id");_that.hideProjectViewLoader();});},onKeyDown:function(e){console.log('keydown '+e.which);switch(e.which){case 65:if(e.ctrlKey){this.stageView.selectAllComponents();}
break;case 67:if(e.ctrlKey){this.stageView.copyComponentsFromOtherProject();}
break;case 81:e.stopPropagation();e.preventDefault();if(e.ctrlKey){}
break;}},onLeftMenuClick:function(model){this.selectProjectView();ProjectView.instance.onLeftMenuClick(model);},openImageWindow:function(){this.selectProjectView();ProjectView.instance.openImageWindow();},createNewPage:function(){this.selectProjectView();ProjectView.instance.createNewPage();},createNewPageTopMenu:function(){this.selectProjectView();ProjectView.instance.createNewPageTopMenu();},show:function(){this.$el.show();},hide:function(){this.$el.hide();},copyPages:function(){this.selectProjectView();this.pagesList.copyPages();},selectProjectView:function(projectModel){this.model.trigger('select-project-view',projectModel||ProjectView.instance.model);},showPupup:function(data,sender){var popup=PopupFactory.createErrorPopup(data,sender);$('body').append(popup.render(data).$el);},showProjectViewLoader:function(){var projectViewLoader=PreloaderFactory.createNotEditableProjectViewLoader();this.$el.append(projectViewLoader.render().$el);},hideProjectViewLoader:function(){this.$el.find('.loader').trigger('close');},topMenuAction:function(action){switch(action){case'copy-conponents-from-other-project':this.stageView.copyComponentsFromOtherProject();break;}},});;;var ProjectViewPlusButton=Backbone.View.extend({tagName:'li',className:'project-view-plus-button',template:_.template($('#project-view-plus-button-template').html()),events:{'click':'openNewProject'},initialize:function(){},render:function(){var template=this.template(this.serializeData());this.$el.html(template);this.addTitleToButtons();return this;},serializeData:function(){return{};},openNewProject:function(){this.trigger('open-new-project');},afterRender:function(){},addTitleToButtons:function(){this.$el.find('[title]').tooltip({html:true,animated:'fade',placement:'bottom',width:400,height:100});},});;;var ProjectsNavigationCollection=Backbone.Collection.extend({model:ProjectModel,});;;var ProjectNavigationItemView=ItemView.extend({tagName:'li',className:'project-navigation-item-view',template:_.template($('#project-navigation-item-template').html()),events:{'click .project-navigation-selector':'selectProject','click .project-navigation-close-button':'closeProject','mousedown':'onMouseDown','drop-item':'dropItem',},bindings:{'.project-navigation-name':'name'},initialize:function(){},dropItem:function(event,index){this.$el.trigger('update-sort',[this.model,index]);},render:function(){var template=this.template(this.serializeData());this.$el.html(template);this.stickit();return this;},serializeData:function(){return{};},closeProject:function(){},selectProject:function(){this.model.collection.each(function(model){model.view2.$el.attr('active',false);});this.$el.attr('active',true);this.trigger('select-project',this.model);},showContextMenu:function(e){},closeOthersProjects:function(){var _that=this;var toRemove=[];this.model.collection.each(function(model){if(model.type=='not-editable'&&_that.model.cid!=model.cid){toRemove.push(model);}});for(var i=0;i<toRemove.length;i++){var model=toRemove[i];_that.trigger('close-project',model);};},});;;var EditableProjectNavigationItemView=ProjectNavigationItemView.extend({className:'project-navigation-item-view editable-project-navigation-item-view',template:_.template($('#project-navigation-item-template').html()),showContextMenu:function(e){var contextMenuView=new NavigationItemViewContextMenuView({model:this.model,view:this});ContextMenuContainer.addMenu(contextMenuView,e);},});;;var NotEditableProjectNavigationItemView=ProjectNavigationItemView.extend({template:_.template($('#not-editable-project-navigation-item-template').html()),closeProject:function(){this.trigger('close-project',this.model);},showContextMenu:function(e){var contextMenuView=new NotEditableNavigationItemViewContextMenuView({model:this.model,view:this});ContextMenuContainer.addMenu(contextMenuView,e);},closeAllProjects:function(){var _that=this;var toRemove=[];this.model.collection.each(function(model){_log('closeAllProjects',model);if(model.type=='not-editable'){toRemove.push(model);}});for(var i=0;i<toRemove.length;i++){var model=toRemove[i];_that.trigger('close-project',model);};}});;;var ProjectsNavigation=Backbone.View.extend({tagName:'ul',className:'projects-navigation',template:_.template($('#projects-navigation-template').html()),events:{'update-sort':'updateSort',},initialize:function(){this.collection=new ProjectsNavigationCollection();},render:function(){var template=this.template(this.serializeData());this.$el.html(template);this.renderProjectsList();this.makeSortable();return this;},renderProjectsList:function(){if(__meta__.external==0){this.collection.each(this.renderOneItem,this);if(this.collection.length>0){this.addPlusButton();}}},renderOneItem:function(projectModel){switch(projectModel.type){case'not-editable':var projectNavigationItemView=new NotEditableProjectNavigationItemView({model:projectModel});projectModel.view2=projectNavigationItemView;projectNavigationItemView.on('close-project',this.closeProject,this);projectNavigationItemView.on('select-project',this.selectProject,this);this.$el.append(projectNavigationItemView.render().$el);break;default:var projectNavigationItemView=new EditableProjectNavigationItemView({model:projectModel});projectModel.view2=projectNavigationItemView;projectNavigationItemView.on('close-project',this.closeProject,this);projectNavigationItemView.on('select-project',this.selectProject,this);this.$el.append(projectNavigationItemView.render().$el);break;}
_log('projectNavigationItemView',projectNavigationItemView);_log('projectModel',projectModel);},afterRender:function(){this.autoLoadFirstProject();},serializeData:function(){return{};},addPlusButton:function(){var plusButtonView=new ProjectViewPlusButton();plusButtonView.on('open-new-project',this.openNewProject,this);this.$el.append(plusButtonView.render().$el);},makeSortable:function(){this.$el.sortable({delay:100,items:".project-navigation-item-view",update:function(event,ui){ui.item.trigger('drop-item',ui.item.index());}});},openNewProject:function(){var projectModel=new ProjectModel();projectModel.type='not-editable';this.addProject(projectModel);},addProject:function(projectModel){projectModel.on('select-project-view',this.selectProject,this);this.collection.add(projectModel);this.render();this.selectProject(projectModel);},displayProjectAsActive:function(projectModel){_log('displayProjectAsActive',projectModel);this.collection.each(function(model){if(model.view2){model.view2.$el.attr('active',false);}});if(projectModel.view2){projectModel.view2.$el.attr('active',true);}},autoLoadFirstProject:function(){var _that=this;this.showLoader();var projectModel=new ProjectModel();projectModel.loadProject(function(pm){DarkanEditorAplicationAPI.getInstance().projectLoaded({pagesLength:pm.get('collection').length});pm.set('name',__meta__.projectName)
_that.addProject(pm);_that.selectProject(pm);_that.hideLoade();},function(){_that.hideLoade();});},closeProject:function(projectModel){var index=this.collection.indexOf(projectModel);this.collection.remove(projectModel);this.render();var nextProjectModel=this.collection.at(index)||this.collection.at(index-1)||this.collection.first();this.displayProjectAsActive(nextProjectModel);this.trigger('on-project-closed',projectModel,nextProjectModel);},selectProject:function(projectModel){this.displayProjectAsActive(projectModel);this.trigger('on-project-selected',projectModel);},updateSort:function(event,projectModel,position){this.collection.remove(projectModel);this.collection.add(projectModel,{at:position});},openExistingProject:function(){this.$el.parent().show();this.openNewProject();},showLoader:function(){var _that=this;this.loaderTimeout=setTimeout(function(){_that.loadProjectLoader=PreloaderFactory.createLoadProjectLoader();$('body').append(_that.loadProjectLoader.render().$el);},200);},hideLoade:function(){clearTimeout(this.loaderTimeout);if(this.loadProjectLoader){this.loadProjectLoader.remove();}}});;;var OpenProjectsList=Backbone.View.extend({tagName:'ul',className:'open-projects-list',template:_.template($('#open-projects-list-template').html()),events:{},initialize:function(){this.collection=new ProjectsNavigationCollection();},render:function(){var template=this.template(this.serializeData());this.$el.html(template);return this;},serializeData:function(){return{};},afterRender:function(){},selectProject:function(projectModel){var index=this.collection.indexOf(projectModel);if(index===-1){this.collection.add(projectModel);switch(projectModel.type){case'not-editable':var projectView=new NotEditableProjectView({model:projectModel});projectView.on('on-project-open',this.onProjectOpen,this);projectModel.view=projectView;this.$el.append(projectView.render().$el);projectView.afterRender();break;default:var projectView=new ProjectView({model:projectModel});projectView.on('open-existing-project',this.openExistingProject,this);projectView.on('on-project-open',this.onProjectOpen,this);projectView.on('disable-top-menu-buttons',this.disableTopMenuButtons,this);projectModel.view=projectView;this.$el.append(projectView.render().$el);projectView.afterRender();ProjectView.instance=projectView;break;}}
this.collection.each(function(pm){pm.view.hide();});projectModel.view.show();ProjectView.selected=projectModel.view;},disableTopMenuButtons:function(model){this.trigger('disable-top-menu-buttons',model);},closeProject:function(projectModel){var index=this.collection.indexOf(projectModel);this.collection.remove(projectModel);projectModel.view.remove();var nextProjectModel=this.collection.at(index)||this.collection.at(index-1)||this.collection.first();this.selectProject(nextProjectModel);},openExistingProject:function(){this.trigger('open-existing-project');},onProjectOpen:function(projectModel){this.trigger('on-project-open',projectModel);},});;;var ProjectsController=Backbone.View.extend({className:'projects-controller',template:_.template($('#projects-controller-template').html()),initialize:function(){},render:function(){var template=this.template(this.serializeData());this.$el.html(template);return this;},afterRender:function(){this.openProjectsList=new OpenProjectsList();this.openProjectsList.on('open-existing-project',this.openExistingProject,this);this.openProjectsList.on('on-project-open',this.onProjectOpen,this);this.$el.find('.open-projects-list-wrapper').append(this.openProjectsList.render().$el);this.projectsNavigation=new ProjectsNavigation();this.projectsNavigation.on('open-new-project',this.openNewProject,this);this.projectsNavigation.on('on-project-selected',this.onProjectSelected,this);this.projectsNavigation.on('on-project-closed',this.onProjectClosed,this);this.$el.find('.projects-navigation-wrapper').append(this.projectsNavigation.render().$el);this.projectsNavigation.afterRender();},openNewProject:function(){this.openProjectsList.selectProject(projectModel);},serializeData:function(){return{};},onProjectSelected:function(projectModel){_log('onProjectSelected',projectModel);this.openProjectsList.selectProject(projectModel);this.disableTopMenuButtons(projectModel);this.hideOrShowOpenWindows(projectModel);},onProjectOpen:function(projectModel){this.disableTopMenuButtons(projectModel);},disableTopMenuButtons:function(projectModel){this.trigger('disable-top-menu-buttons',projectModel);},onProjectClosed:function(projectModel,nextProjectModel){_log('onProjectClosed',projectModel);this.openProjectsList.closeProject(projectModel);this.disableTopMenuButtons(nextProjectModel);},openExistingProject:function(){this.projectsNavigation.openExistingProject();},hideOrShowOpenWindows:function(projectModel){var allWindows=$('.window, .editor-container-window-view');_log('allWindows',allWindows);if(projectModel.view instanceof NotEditableProjectView){allWindows.hide();}else{allWindows.show();}}});;;var TopMenuView=Backbone.View.extend({template:_.template($('#top-menu-template-default-normal').html()),events:{'click .topmenu-export':'openExportWindow','click .topmenu-import':'openImportWindow','click .topmenu-newpage':'openNewpageWindow','click .topmenu-project-version':'openProjectVersionWindow','click .topmenu-publish':'openPublishWindow','click #view':'openPreviewWindow','click #topmenu-sound-manager':'openSoundManagerWindow','click #share-project':'openShareProjectWindow','click #project-options':'openProjectOptionsWindow','click #topmenu-purge-project':'tryClearProject','click #close-project':'closeProject','click #languages-list':'changeLanguage','click #topmenu-extras-db':'dropboxIntegration','click #topmenu-extras-fbphoto':'facebookIntegration','click #topmenu-extras-videosearch':'openVideoSearchWindow','click #topmenu-extras-imagesearch':'openImageSearchWindow','click .topmenu-variables':'openCreateNewVariableWindow','click .topmenu-back':'historyBack','click .topmenu-prev':'historyPrev','click .topmenu-cut':'cutComponents','click .topmenu-copy':'copyComponents','click .topmenu-paste':'pasteComponents','click .topmenu-paste-special':'pasteSpecialComponents','click .topmenu-duplicate':'duplicateComponents','click .topmenu-move-components-to-new-layer':'moveComponentsToNewLayer','click .topmenu-open-existing-project':'openExistingProject',},initialize:function(data){this.detectState();this.afterInitialize();var capabilities=Capabilities.getInstance();capabilities.on('change',this.onCapabilitiesChanged,this);capabilities.getCapabilities();},historyBack:function(){this.trigger('topmenu-action','history-back');},historyPrev:function(){this.trigger('topmenu-action','history-prev');},cutComponents:function(){this.trigger('topmenu-action','cut-components');},copyComponents:function(){this.trigger('topmenu-action','copy-components');},pasteComponents:function(){this.trigger('topmenu-action','paste-components');},pasteSpecialComponents:function(){this.trigger('topmenu-action','paste-special-components');},duplicateComponents:function(){this.trigger('topmenu-action','duplicate-components');},moveComponentsToNewLayer:function(){this.trigger('topmenu-action','move-components-to-new-layer');},openExistingProject:function(){this.trigger('topmenu-action','open-existing-project');},openSoundManagerWindow:function(){var soundManagerWindow=WindowFactory.createSoundManagerWindow();$('body').append(soundManagerWindow.render().$el);},openCreateNewVariableWindow:function(){var createNewVariableWindow=WindowFactory.createCreateNewVariableWindow();$('body').append(createNewVariableWindow.render().$el);},onCapabilitiesChanged:function(capabilitiesModel){this.capabilitiesParmasList=capabilitiesModel.createParams([{name:'publish',identifier:'.topmenu-publish'},{name:'versioning',identifier:'.topmenu-project-version'},{name:'adminPanel',identifier:'.lms'},]);var deleteEventsVisitor=DeleteEventsVisitor.getInstance();this.accept(deleteEventsVisitor);capabilitiesModel.off();},accept:function(visitor){visitor.visit(this);},afterInitialize:function(){},getUserProfileIcon:function(){},addTitleToButtons:function(){this.$el.find('[title]').tooltip({html:true,animated:'fade',placement:'bottom',width:300,height:200});},openProjectVersionWindow:function(){this.trigger('open-project-version-window')},openImageSearchWindow:function(){var _that=this;this.trigger('open-images-window');},openVideoSearchWindow:function(){var _that=this;this.trigger('open-video-window');},dropboxIntegration:function(){var _that=this;var options={success:function(files){_that.trigger('imageupload-link',files[0].link);},cancel:function(){},linkType:"direct",multiselect:false,extensions:['.jpg','.png','.jpeg']}
Dropbox.choose(options);},facebookIntegration:function(e){var _that=this;var id=null;FB.getLoginStatus(function(response){if(response.authResponse){if($(this).attr('data-id'))id=$(this).attr('data-id');fbphotoSelect(id,_that.uploadFileByLink);}else{FB.login(function(response){if(response.authResponse){if($(this).attr('data-id'))id=$(this).attr('data-id');fbphotoSelect(id,_that.uploadFileByLink);}},{scope:'user_photos, friends_photos'});}});},uploadFileByLink:function(link){alert(link);},changeLanguage:function(e){var _that=this;var language=$(e.target).text();DataAccess.changeLanguage({lang:language},function(data){_that.eraseCookie('darkanlocale');_that.createCookie('darkanlocale',language,365);location.reload();},function(data){_log('data',data)});},closeProject:function(){},openPreviewWindow:function(){var _that=this;var previewWindow=WindowFactory.createPreviewWindow();previewWindow.showPreview();previewWindow.on('open-publish-window',function(){_that.openPublishWindow();});previewWindow.on('open-export-window',function(){_that.openExportWindow();});$('body').append(previewWindow.render().$el);},openShareProjectWindow:function(){var shareWindow=WindowFactory.createShareWindow();DataAccess.getSharedUsers({},function(data){var dataToRender={usersList:data.usersList,winType:'list'};$('body').append(shareWindow.render(dataToRender).$el);},function(data){_log('data',data)});},openProjectOptionsWindow:function(){var projectOptionsWindow=WindowFactory.createProjectOptionsWindow();$('body').append(projectOptionsWindow.render().$el);},openExportWindow:function(){var exportWindow=WindowFactory.createExportWindow();$('body').append(exportWindow.render().$el);},openImportWindow:function(){var importWindow=WindowFactory.createImportWindow();$('body').append(importWindow.render().$el);},openNewpageWindow:function(){var _that=this;_that.trigger('add-new-blank-page');},openPublishWindow:function(){DataAccess.preparePreview({},function(data){var publishWindow=WindowFactory.createPublishWindow();$('body').append(publishWindow.render().$el);},function(data){_log('FAILED preparePreview',data);});},tryClearProject:function(){this.trigger('clear-project-popup',{},this);},clearProject:function(onClearProjectResult,onClearProjectFault){var _that=this;DataAccess.clearProject({},function(data){onClearProjectResult();},function(data){onClearProjectFault();});},createCookie:function(name,value,days){var expires;if(days){var date=new Date();date.setTime(date.getTime()+(days*24*60*60*1000));expires="; expires="+date.toGMTString();}else{expires="";}
document.cookie=escape(name)+"="+escape(value)+expires+"; path=/;domain=."+__meta__.domain;},readCookie:function(name){var nameEQ=escape(name)+"=";var ca=document.cookie.split(';');for(var i=0;i<ca.length;i++){var c=ca[i];while(c.charAt(0)===' ')c=c.substring(1,c.length);if(c.indexOf(nameEQ)===0)return unescape(c.substring(nameEQ.length,c.length));}
return null;},eraseCookie:function(name){this.createCookie(name,"",-1);},render:function(){this.$el.attr('id','menu-top');var template=this.template(this.serializeData());this.$el.html(template);this.$el.find('#menu-top-tabs').tabs({event:"mousedown",select:function(event,ui){},create:function(event,ui){}});this.getUserProfileIcon();this.addTitleToButtons();_layout.text_editor_image=this.$el.find('#text-editor-image');_layout.menu_top_tabs=this.$el.find('#menu-top-tabs');return this;},serializeData:function(){return{};},setNormalState:function(){this.template=_.template($('#top-menu-template-default-normal').html());},setBasicState:function(){this.template=_.template($('#top-menu-template-default-basic').html());},setTestDriveState:function(){this.template=_.template($('#top-menu-template-default-test-drive').html());},detectState:function(){var state=State.getStateType();switch(state){case'normal':this.setNormalState();break;case'basic':this.setBasicState();break;case'test-drive':this.setTestDriveState();break;default:this.setNormalState();break;}},disableTopMenuButtons:function(projectModel){var type=projectModel.type;switch(type){case'not-editable':this.disableButtons();if(projectModel.get('collection').length>0){this.changeCopyFunction();}
break;default:this.enableButtons();break;}},disableButtons:function(){this.capabilitiesParmasList=[{value:false,identifier:'.topmenu-back'},{value:false,identifier:'.topmenu-prev'},{value:false,identifier:'.topmenu-cut'},{value:false,identifier:'.topmenu-copy'},{value:false,identifier:'.topmenu-paste'},{value:false,identifier:'.topmenu-paste-special'},{value:false,identifier:'.topmenu-duplicate'},{value:false,identifier:'.topmenu-move-components-to-new-layer'},];var deletePageEventsVisitor=DeletePageEventsVisitor.getInstance();this.accept(deletePageEventsVisitor);},enableButtons:function(){this.capabilitiesParmasList=[{value:true,identifier:'.topmenu-back',fun:'historyBack'},{value:true,identifier:'.topmenu-prev',fun:'historyPrev'},{value:true,identifier:'.topmenu-cut',fun:'cutComponents'},{value:true,identifier:'.topmenu-copy',fun:'copyComponents'},{value:true,identifier:'.topmenu-paste',fun:'pasteComponents'},{value:true,identifier:'.topmenu-paste-special',fun:'pasteSpecialComponents'},{value:true,identifier:'.topmenu-duplicate',fun:'duplicateComponents'},{value:true,identifier:'.topmenu-move-components-to-new-layer',fun:'moveComponentsToNewLayer'},];var addEventsVisitor=AddEventsVisitor.getInstance();this.accept(addEventsVisitor);},changeCopyFunction:function(){this.capabilitiesParmasList=[{value:true,identifier:'.topmenu-copy',fun:'copyComponentsFromOtherProject'}];var addEventsVisitor=AddEventsVisitor.getInstance();this.accept(addEventsVisitor);},copyComponentsFromOtherProject:function(){this.trigger('topmenu-action','copy-conponents-from-other-project');},accept:function(visitor){visitor.visit(this);},showWorkingAsOffline:function(){this.$el.find('.online-working-status').attr('status','offline');},showWorkingAsOnline:function(){this.$el.find('.online-working-status').attr('status','online');},});TopMenuView.create=function(data){var type=Device.getDeviceType();switch(type){case'browser':return new TopMenuViewBrowser(data);break;case'ipad':return new TopMenuViewIPad(data);break;default:return new TopMenuView(data);break;}};;var TopMenuViewBrowser=TopMenuView.extend({setNormalState:function(){this.template=_.template($('#top-menu-template-browser-normal').html());},setBasicState:function(){this.template=_.template($('#top-menu-template-browser-basic').html());},setTestDriveState:function(){this.template=_.template($('#top-menu-template-browser-test-drive').html());},});;;var TopMenuViewIPad=TopMenuView.extend({setNormalState:function(){this.template=_.template($('#top-menu-template-ipad-normal').html());},setBasicState:function(){this.template=_.template($('#top-menu-template-ipad-basic').html());},setTestDriveState:function(){this.template=_.template($('#top-menu-template-ipad-test-drive').html());},});;;var BottomMenuView=Backbone.View.extend({el:_layout.menu_bottom,events:{'click #bottom-menu-tabs-showhide':'showHideMenuButtonClick','click li[role="tab"]':'showMenuIfHidden','click li[role="tab"] a[href="#botmenu-editors-container"]':'forceRefreshEditorView','resize':'onResize','hideMenu':'hideMenu','showMenu':'showMenu'},initialize:function(){var _that=this;this.$el.find('#menu-bottom-tabs').tabs({event:"mousedown",select:function(event,ui){},create:function(event,ui){}});this.$el.resizable({handles:'n',resize:function(event,ui){_that.onResize();}});if($(document).width()<1380){this.hideMenu();}},forceRefreshEditorView:function(){this.$el.find('#botmenu-editors-container > div').trigger('force-refresh-editor-view');},onResize:function(){var _that=this;_layout.pages_list_wrapper.css({height:'calc(100% - '+_that.$el.height()+'px)'});var topmenuHeight=_layout.menu_top.height()+20;var subtractFromSceneHeight=topmenuHeight+_that.$el.height();_layout.scene_wrapper.css({height:'calc(100% - '+subtractFromSceneHeight+'px)'});_that.$el.css('top','auto');var menuHeight=_that.$el.height();if(menuHeight>34){_that.$el.find('#bottom-menu-tabs-showhide').html('&#9660;');}else{_that.$el.find('#bottom-menu-tabs-showhide').html('&#9650;');}},showHideMenuButtonClick:function(){var menuHeight=this.$el.height();if(menuHeight>=34){this.hideMenu();}else{this.showMenu();}},showMenuIfHidden:function(e){if($(e.target).attr('href')=='#botmenu-timeline-wrapper'){StageView.instance.timeline.render();StageView.instance.timeline.afterRender();}
var menuHeight=this.$el.height();if(menuHeight<=34){this.showMenu();}},hideMenu:function(onComplete){var _that=this;this.$el.animate({height:'30px'},300,function(){if(_.isFunction(onComplete)){onComplete();}
_that.onResize();});},showMenu:function(){var _that=this;this.$el.animate({height:'220px'},300,function(){_that.onResize();});}});BottomMenuView.instance={};;;var LeftMenuItemModel=Backbone.Model.extend({defaults:{componentName:'text',className:'big-btn',subitems:[]}});var LeftMenuItemCollection=Backbone.Collection.extend({model:LeftMenuItemModel});var LeftMenuView=Backbone.View.extend({template:_.template($('#left-menu-template').html()),initialize:function(){this.render();},render:function(){this.$el.attr('id','menu-left');var template=this.template(this.serializeData());this.$el.html(template);this.collection.each(this.addMenuItem,this);return this;},serializeData:function(){return{};},addMenuItem:function(menuItem){var _that=this;var menuItemView=new LeftMenuItemView({model:menuItem});menuItemView.on('item-click',function(model){_that.trigger('menu-item-click',model);});menuItemView.on('menu-item-click',function(model){_that.trigger('menu-item-click',model);});this.$el.find('.menu-left-toolbar-buttons').append(menuItemView.render().el);},turnOnDeleteButton:function(){this.$el.find('#toolbar-remove').removeAttr('disabled');},turnOffDeleteButton:function(){this.$el.find('#toolbar-remove').attr('disabled','disabled');}});var LeftMenuItemView=Backbone.View.extend({tagName:"li",template:_.template($('#leftmenu-template').html()),events:{'click':'addComponent'},addComponent:function(e){e.stopPropagation();switch(this.model.get('componentName')){case'separator':return false;break;case'extend':var active=this.$el.find('> a').hasClass('active');this.hideAllExtendedMenus();if(active){this.hideAllExtendedMenus();}else{this.$el.find('> a').addClass('active');this.showSingleExtendedMenu(this.$el.find('.menu-left-second-lvl'));}
break;default:this.hideAllExtendedMenus();this.trigger('item-click',this.model,this);break;}},render:function(){var _that=this;var menuItemTemplate=this.template(this.model.toJSON());this.$el.html(menuItemTemplate);if(this.model.get('subitems').length>0){this.model.get('subitems').each(this.addSubMenuItem,this);}
this.$el.find('[title]').tooltip({html:true,animated:'fade',placement:'right',width:300,height:200});return this;},addSubMenuItem:function(submenuItem){var _that=this;var menuSubItemView=new LeftMenuSubItemView({model:submenuItem});menuSubItemView.on('item-click',function(model){_that.trigger('menu-item-click',model);_that.hideAllExtendedMenus();});this.$el.find('.menu-left-second-lvl').append(menuSubItemView.render().el);},hideAllExtendedMenus:function(){this.$el.parent().find('.active').removeClass('active');this.$el.parent().find('.menu-left-second-lvl').hide();},showSingleExtendedMenu:function(menu){menu.css({'margin-top':'0px'});menu.show();var offset=$(document).height()-(menu.height()+menu.offset().top);if(offset<20){var marginTop=Math.abs(offset)+20;menu.css({'margin-top':"-"+marginTop+"px"});}else{menu.css({'margin-top':'0px'});}}});var LeftMenuSubItemView=Backbone.View.extend({tagName:"li",template:_.template($('#leftmenusubitem-template').html()),events:{'click':'addComponent'},render:function(){var menuSubItemTemplate=this.template(this.model.toJSON());this.$el.html(menuSubItemTemplate);return this;},addComponent:function(e){e.stopPropagation();this.trigger('item-click',this.model,this);},hideAllExtendedMenus:function(){this.$el.find('.active').removeClass('active');this.$el.find('.menu-left-second-lvl').hide();}});var toolbarItemsCollection=new LeftMenuItemCollection([new LeftMenuItemModel({componentName:'text',icon:'text',className:'big-btn',title:_lang('TOOLTIP_0003')}),new LeftMenuItemModel({componentName:'image',icon:'image',className:'big-btn',title:_lang('TOOLTIP_0004')}),new LeftMenuItemModel({componentName:'video',icon:'video',className:'big-btn',title:_lang('TOOLTIP_0005')}),new LeftMenuItemModel({componentName:'separator',className:'separator'}),new LeftMenuItemModel({componentName:'extend',icon:'infopoints',className:'big-btn extend',title:_lang('TOOLTIP_0006'),subitems:new LeftMenuItemCollection([new LeftMenuItemModel({componentName:'infopoint-popup',prettyName:_lang('COMPONENTNAME_POPUP'),icon:'infopoints-popup',className:'small-btn-ext',title:_lang('TOOLTIP_0009')}),new LeftMenuItemModel({componentName:'infopoint-gallery',prettyName:_lang('COMPONENTNAME_GALLERY'),icon:'infopoints-gallery',className:'small-btn-ext',title:_lang('TOOLTIP_0008')}),new LeftMenuItemModel({componentName:'infopoint-link',prettyName:_lang('COMPONENTNAME_LINK'),icon:'infopoints-link',className:'small-btn-ext',title:_lang('TOOLTIP_0007')}),new LeftMenuItemModel({componentName:'infopoint-download',prettyName:_lang('COMPONENTNAME_DOWNLOAD'),icon:'infopoints-download',className:'small-btn-ext',title:_lang('TOOLTIP_0010')}),new LeftMenuItemModel({componentName:'form-upload',prettyName:'Wgraj plik',icon:'upload',className:'small-btn-ext',title:_lang('')}),new LeftMenuItemModel({componentName:'infopoint-sound',prettyName:_lang('COMPONENTNAME_AUDIO'),icon:'infopoints-soundfile',className:'small-btn-ext',title:_lang('TOOLTIP_0011')}),new LeftMenuItemModel({componentName:'infopoint-sound-control',prettyName:_lang('COMPONENTNAME_AUDIO_CONTROL'),icon:'infopoints-soundfile',className:'small-btn-ext',title:_lang('COMPONENTNAME_AUDIO_CONTROL')}),])}),new LeftMenuItemModel({componentName:'extend',icon:'quiz',className:'big-btn extend',title:_lang('TOOLTIP_0115'),subitems:new LeftMenuItemCollection([new LeftMenuItemModel({componentName:'quiz',prettyName:_lang('COMPONENTNAME_QUIZMULTI'),icon:'quiz-multiselect',className:'small-btn-ext',title:_lang('TOOLTIP_0031')}),new LeftMenuItemModel({componentName:'quiz-radio',prettyName:_lang('COMPONENTNAME_QUIZRADIO'),icon:'quiz-radio',className:'small-btn-ext',title:_lang('TOOLTIP_0032')}),new LeftMenuItemModel({componentName:'quiz-truefalse',prettyName:_lang('COMPONENTNAME_QUIZTRUEFALSE'),icon:'quiz-truefalse',className:'small-btn-ext',title:_lang('TOOLTIP_0033')}),new LeftMenuItemModel({componentName:'quiz-selectone',prettyName:_lang('COMPONENTNAME_QUIZSELECTONE'),icon:'quiz-selectone',className:'small-btn-ext',title:_lang('TOOLTIP_0034')}),new LeftMenuItemModel({componentName:'quiz-inputtext',prettyName:_lang('COMPONENTNAME_QUIZ_INPUT'),icon:'inputtext',className:'small-btn-ext',title:_lang('TOOLTIP_0141')}),new LeftMenuItemModel({componentName:'quiz-select',prettyName:_lang('COMPONENTNAME_QUIZ_SELECT'),icon:'select',className:'small-btn-ext',title:_lang('TOOLTIP_0142')}),new LeftMenuItemModel({componentName:'quiz-fillinblanks',prettyName:_lang('COMPONENTNAME_QUIZ_FILLINBLANKS'),icon:'select',className:'small-btn-ext',title:_lang('TOOLTIP_0142')}),new LeftMenuItemModel({componentName:'quiz-dnd',prettyName:_lang('COMPONENTNAME_QUIZDND'),icon:'quiz-dnd',className:'small-btn-ext',title:_lang('TOOLTIP_0126')}),new LeftMenuItemModel({componentName:'quiz-wordsearch',prettyName:_lang('COMPONENTNAME_QUIZWORDSEARCH'),icon:'quiz-wordsearch',className:'small-btn-ext',title:_lang('TOOLTIP_0127')}),new LeftMenuItemModel({componentName:'crossword',prettyName:_lang('COMPONENTNAME_QUIZCROSSWORD'),icon:'quiz-crossword',className:'small-btn-ext',title:_lang('TOOLTIP_0128')}),new LeftMenuItemModel({componentName:'quiz-connectlines',prettyName:_lang('COMPONENTNAME_QUIZQCL'),icon:'quiz-connectlines',className:'small-btn-ext',title:_lang('TOOLTIP_0129')}),new LeftMenuItemModel({componentName:'quiz-result',prettyName:_lang('COMPONENTNAME_QUIZRESULT'),icon:'quiz-results',className:'small-btn-ext',title:_lang('TOOLTIP_0130')}),])}),new LeftMenuItemModel({componentName:'extend',icon:'forms',className:'big-btn extend',title:_lang('TOOLTIP_0116'),subitems:new LeftMenuItemCollection([new LeftMenuItemModel({componentName:'form-inputtext',prettyName:_lang('COMPONENTNAME_FORMSINPUT'),icon:'inputtext',className:'small-btn-ext',title:_lang('TOOLTIP_0118')}),new LeftMenuItemModel({componentName:'form-textarea',prettyName:_lang('COMPONENTNAME_FORMSTA'),icon:'textarea',className:'small-btn-ext',title:_lang('TOOLTIP_0119')}),new LeftMenuItemModel({componentName:'form-select',prettyName:_lang('COMPONENTNAME_FORMSSELECT'),icon:'select',className:'small-btn-ext',title:_lang('TOOLTIP_0120')}),new LeftMenuItemModel({componentName:'form-checkbox',prettyName:_lang('COMPONENTNAME_FORMSCHECKBOX'),icon:'checkbox',className:'small-btn-ext',title:_lang('TOOLTIP_0121')}),new LeftMenuItemModel({componentName:'form-radio',prettyName:_lang('COMPONENTNAME_FORMSRADIO'),icon:'radio',className:'small-btn-ext',title:_lang('TOOLTIP_0122')}),]),}),new LeftMenuItemModel({componentName:'library',icon:'library',className:'big-btn',title:_lang('TOOLTIP_0017')}),new LeftMenuItemModel({componentName:'separator',className:'separator'}),new LeftMenuItemModel({componentName:'swf',icon:'swf',className:'small-btn',title:_lang('TOOLTIP_0019')}),new LeftMenuItemModel({componentName:'scroller',icon:'scroller',className:'small-btn',title:_lang('TOOLTIP_0020')}),new LeftMenuItemModel({componentName:'iframe',icon:'iframe',className:'small-btn',title:_lang('TOOLTIP_0117')}),new LeftMenuItemModel({componentName:'timer',prettyName:_lang('COMPONENTNAME_TIMER'),icon:'timer',className:'small-btn',title:_lang('TOOLTIP_0134')}),new LeftMenuItemModel({componentName:'remove',icon:'remove',className:'big-btn',title:_lang('TOOLTIP_0022')})]);;;var RightMenuView=Backbone.View.extend({el:$('#menu-right'),sceneWrapper:$('#scene-wrapper'),tiggleIcon:$('.toggle-icon'),canEdit:true,visible:true,events:{'click .new-page':'createNewPage','click .del-pages':'showDeletePagesWindow','click .copy-page':'duplicatePages','click .visible-pages':'changeVisibleAllPages','click .change-titles-pages':'showChangeTitleWindow','click .select-all-pages':'selectedAllPages','select-all-pages':'selectedAllPages','click .menu-right-toggle':'toggleRightMenu','unselect-all-pages':'unselectAllPages'},unselectAllPages:function(){this.$el.find('.select-all-pages').removeClass('selected-all-pages');},toggleRightMenu:function(){var _that=this;if(this.visible){this.$el.css('width','5px');this.sceneWrapper.css({width:'calc(100% - 125px)'});this.tiggleIcon.css({transform:'rotate(180deg)',left:'-20px',height:'100px','line-height':'100px'});this.$el.find('#menu-right-tabs').hide();this.visible=false;}else{this.$el.css('width','');this.sceneWrapper.css({width:''});this.tiggleIcon.css({transform:'rotate(0deg)',left:'0px',height:'','line-height':''});this.$el.find('#menu-right-tabs').show();this.visible=true;}},initialize:function(data){var _that=this;var projectWatcher=new ProjectWatcherView();this.$el.find('#project-watcher').append(projectWatcher.render().$el);this.historyListView=new HistoryListView();this.historyListView.on('back',function(model){});HistoryListView.instance=this.historyListView;this.$el.find('#history-list').append(this.historyListView.render().$el);this.historyListView.start();this.pageListView=new FirstPagesListView({model:this.model,collection:this.model.get('collection')});this.pageListView.on('onsetpage',function(model){_that.canEdit=true;_that.trigger('set-page',model,this);DarkanEditorAplicationAPI.getInstance().pageSelected();});this.pageListView.on('on-page-are-created',function(model){_that.pageListView.setActivePageModel(model);_that.canEdit=true;_that.trigger('set-page',model,this);});this.pageListView.on('update-sort',function(){_that.updateSort();});this.pageListView.on('update-coming',function(model){_that.trigger('update-coming',model,this);});this.pageListView.on('data-picker-picked',function(model){_that.dataPickerPicked(model);});this.pageListView.on('on-copy-page',function(data){_that.onCopyPage(data);});this.watchProject();this.getAllProjects();this.addTitleToButtons();this.runMenuTabs();},runMenuTabs:function(){var _that=this;var menuRightTabs=this.$el.find('#menu-right-tabs')
menuRightTabs.tabs({event:"mousedown",active:0,activate:function(event,ui){_log('select ui',ui);_log('select ui.newTab',ui.newTab);if($(ui.newTab).attr('id')=='rightmenu-tab-0'){_layout.menu_bottom.css('display','block');BottomMenuView.instance.showMenu();_that.trigger('set-page',_that.pageListView.getSelectedPageModel(),this);}},create:function(event,ui){}});},addTitleToButtons:function(){this.$el.find('[title]').tooltip({html:true,animated:'fade',placement:'bottom',width:300,height:200});},getAllProjects:function(){var _that=this;DataAccess.getAllProjectsList({},function(data){_that.secondPageListView=new SecondPagesListView({data:data});_that.secondPageListView.on('get-project-by-id',function(data){_that.getProjectById(data);});_that.secondPageListView.on('onsetpage',function(model){_that.canEdit=false;_that.trigger('set-second-page',model,this);});_that.secondPageListView.on('on-copy-page',function(data){_that.goToTab(0);_that.onCopyPage(data);});},function(data){_log('Get All Projects List fault: ',data,_log.dataaccessOutFault);});},goToTab:function(index){this.$el.find("#menu-right-tabs").tabs("option","active",index);},copyPages:function(data){var _that=this;var collection=data.collection;var userId=data.userId;var projectId=data.projectId;DataAccess.copyPage({page:pageModel,component:componentModel,action:"update"},function(data){_log('Update component result: ',data,_log.dataaccessOutResult);},function(data){_log('Update component fault: ',data,_log.dataaccessOutFault);});},getProjectById:function(data){var _that=this;this.model.loadProjectById(data,function(collection){collection.each(function(pageModel){pageModel.projectId=data.projectId;pageModel.ownerId=data.userId;});_that.secondPageListView.showList(collection);},function(){_log("Not load project");});},onCopyPage:function(data){var _that=this
this.enableButtons();var pageCollection=this.model.get('collection');var oldPageId=data.oldPageId;var projectOptions=data.projectOptions;var options=data.projectOptions;var projectOptionsModel=ProjectModel.instance.get('options');for(var item in options){projectOptionsModel.set(item,options[item],{silent:true});}
projectOptionsModel.trigger('option-changes-coming',projectOptionsModel);var oldPageIndex=pageCollection.length;if(oldPageId){var oldPageModel=this.pageListView.getPageModelByPageId(oldPageId);oldPageIndex=this.pageListView.getPageIndexByPageModel(oldPageModel)+1;}
for(var i=data.pages.length-1;i>=0;i--){var copyPageModel=this.model.createPageModel(data.pages[i]);lastPageModel=copyPageModel;pageCollection.add(copyPageModel,{at:oldPageIndex});};this.pageListView.setActivePageModel(lastPageModel);this.pageListView.render();this.pageListView.selectPageModel(lastPageModel);var lastPageId=parseInt(data.lastPageId);ProjectModel.instance.get('options').set('last_page_id',lastPageId,{silent:true});ProjectModel.instance.calculateAllScoreSuccessPoints();this.trigger('set-page',lastPageModel,this);},clearList:function(){this.pageListView.clearList();},resetList:function(){this.clearList();this.pageListView.resetList();},dataPickerPicked:function(model){this.trigger('data-picker-picked',model,this);},render:function(){return this;},updateSort:function(){},showChangeTitleWindow:function(e){var _that=this;var windowPosition={top:e.pageY,left:e.pageX};if(this.pageNameEditorView==undefined){this.pageNameEditorView=new PageNameWindowView({pageCollection:this.model.get('collection')});this.pageNameEditorView.on('on-close',function(){_that.pageNameEditorView=undefined;});var dataToRender={componentModel:this.model};$('body').append(this.pageNameEditorView.render(dataToRender).$el);this.pageNameEditorView.setWindowPosition(windowPosition);}},selectedAllPages:function(){var pagesCollection=this.model.get('collection');var setActive=true;var _act=true;var _uni=true;pagesCollection.each(function(childModel,index){if(index==0){_act=childModel.isSelected;}
if(_uni&&_act!==childModel.isSelected){_uni=false;}});if(_uni){if(_act==false)
setActive=true;else
setActive=false;}
if(setActive){this.$el.find('.select-all-pages').addClass('selected-all-pages');}else{this.$el.find('.select-all-pages').removeClass('selected-all-pages');}
pagesCollection.each(function(childModel){childModel.isSelected=setActive;childModel.setCheckboxSelected(setActive);});},changeVisibleAllPages:function(){var _that=this;var pagesCollection=this.model.get('collection');var setActive=1;var _act=0;var _uni=true;var first=true;pagesCollection.each(function(childModel,index){if(childModel.isSelected){var options=childModel.get('options');if(first){_act=options.get('active');}
if(_uni&&_act!==options.get('active')){_uni=false;}
first=false;}});if(_uni){if(_act==0)
setActive=1;else
setActive=0;}
var selectedPagesOptions=[];pagesCollection.each(function(childModel){if(childModel.isSelected){var options=childModel.get('options');options.onlyRefresh=true;options.set('active',setActive);options.onlyRefresh=false;selectedPagesOptions.push(options.toJSON());}});_log('selectedPagesOptions',selectedPagesOptions);if(selectedPagesOptions.length==0){return;}
var shortedPagesOptions=_.map(selectedPagesOptions,function(o){return _.pick(o,"active","pageid");});this.disableButtons();DataAccess.updatePagesOptions({pagesOptions:shortedPagesOptions},function(data){_log('Update pages options result:',data,_log.dataaccessOutResult);_that.enableButtons();},function(data){_log('Update pages options fault:',data,_log.dataaccessOutFault);_that.enableButtons();});},duplicatePages:function(){var _that=this;var pageCollection=this.model.get('collection');var pageIdsListToCopy=this.pageListView.getIdsFromSelectedPages(pageCollection);if(pageIdsListToCopy.length>0){this.disableButtons();}
_log('pageIdsListToCopy',pageIdsListToCopy);DataAccess.duplicatePages({pagesIds:pageIdsListToCopy},function(data){_log('Duplicate pages result:',data,_log.dataaccessOutResult);_that.onPagesDuplicatedResult(data);_that.enableButtons();},function(data){_log('Duplicate pages fault:',data,_log.dataaccessOutFault);_that.enableButtons();});},onPagesDuplicatedResult:function(data){var newPagesCollction=data.newPagesCollction;var oldPageIndex=parseInt(data.oldPageIndex);if(!_.isNumber(oldPageIndex)){return;}
if(!_.isArray(newPagesCollction)){return;}
var pageCollection=this.model.get('collection');for(var i=newPagesCollction.length-1;i>=0;i--){var page=newPagesCollction[i];var pageModel=ProjectModel.instance.createPageModel(page);if(pageModel){pageCollection.add(pageModel,{at:oldPageIndex});}};this.pageListView.render();},copyPage:function(){var _that=this;var pageCollection=this.model.get('collection');var pageIdsListToCopy=this.pageListView.getIdsFromSelectedPages(pageCollection);if(pageIdsListToCopy.length>0){this.disableButtons();}
_that.pageListView.addCopyPage(pageIdsListToCopy);},disableButtons:function(){this.capabilitiesParmasList=[{value:false,identifier:'.new-page'},{value:false,identifier:'.del-pages'},{value:false,identifier:'.copy-page'},{value:false,identifier:'.visible-pages'},{value:false,identifier:'.change-titles-pages'},{value:false,identifier:'.select-all-pages'},{value:false,identifier:'.unselect-all-pages'},];var deletePageEventsVisitor=DeletePageEventsVisitor.getInstance();this.accept(deletePageEventsVisitor);},enableButtons:function(){this.capabilitiesParmasList=[{value:true,identifier:'.new-page',fun:'createNewPage'},{value:true,identifier:'.del-pages',fun:'showDeletePagesWindow'},{value:true,identifier:'.copy-page',fun:'duplicatePages'},{value:true,identifier:'.visible-pages',fun:'changeVisibleAllPages'},{value:true,identifier:'.change-titles-pages',fun:'showChangeTitleWindow'},{value:true,identifier:'.select-all-pages',fun:'selectedAllPages'},{value:true,identifier:'.unselect-all-pages',fun:'unselectAllPages'},];var addEventsVisitor=AddEventsVisitor.getInstance();this.accept(addEventsVisitor);},accept:function(visitor){visitor.visit(this);},showDeletePagesWindow:function(e){var _that=this;var windowPosition={top:e.pageY,left:e.pageX};var pagesToDel=0;var pageCollection=this.model.get('collection');pageCollection.each(function(model){if(model.isSelected){pagesToDel++;}});if(this.pageNameEditorView==undefined){this.pageNameEditorView=new DeletePagesWindowView();this.pageNameEditorView.on('on-close',function(){_that.pageNameEditorView=undefined;});this.pageNameEditorView.on('delete-pages',function(pagesIds){_that.deletePages();});var dataToRender={componentModel:this.model,pagesToDel:pagesToDel};$('body').append(this.pageNameEditorView.render(dataToRender).$el);this.pageNameEditorView.setWindowPosition(windowPosition);}},deletePages:function(){var _that=this;var pagesIds=[];var pageCollection=this.model.get('collection');pageCollection.each(function(model){if(model.isSelected){pagesIds.push(model.get('options').get('pageid'));}});if(pagesIds.length==0){return;}
this.disableButtons();DataAccess.deletePages({pagesIds:pagesIds},function(data){_log('Delete page successed: ',data,_log.dataaccessOutResult);_that.enableButtons();_that.onPagesDeletedResult(data);DarkanEditorAplicationAPI.getInstance().pagesRemoved({pagesLength:_that.pageListView.getPagesLength()});},function(data){_log('Delete page failed: ',data,_log.dataaccessOutFault);_that.enableButtons();});},onPagesDeletedResult:function(data){var _that=this;var deletedPages=data.deletedPages;var pageCollection=this.model.get('collection');var newSelectedPageModel;for(var i=0;i<deletedPages.length;i++){var pageId=deletedPages[i];var pageModel=this.getPageModelByPageId(pageId);if(pageModel){var index=pageCollection.indexOf(pageModel);pageCollection.remove(pageModel);pageModel.view.destroy();newSelectedPageModel=pageCollection.at(index-1);}};if(pageCollection.length==0){this.trigger('show-modal-window',undefined,this);return;}
var firstPageModel=newSelectedPageModel||pageCollection.first();this.pageListView.setActivePageModel(firstPageModel);this.trigger('set-page',firstPageModel,this);},onPagesDeletedComingResult:function(data){var _that=this;var deletedPages=data.deletedPages;var pageCollection=this.model.get('collection');for(var i=0;i<deletedPages.length;i++){var pageId=deletedPages[i];var pageModel=this.getPageModelByPageId(pageId);if(pageModel){pageCollection.remove(pageModel);pageModel.view.destroy();}};if(pageCollection.length==0){this.trigger('show-modal-window',undefined,this);return;}
var newSelectedPageModel=this.pageListView.getActivePage(User.getModel().get('activePageId'));this.pageListView.selectedPageModel=newSelectedPageModel;var firstPageModel=newSelectedPageModel||pageCollection.first();this.pageListView.setActivePageModel(firstPageModel);this.trigger('set-page',firstPageModel,this);},createNewPage:function(){var _that=this;this.disableButtons();var newPageModel=ProjectModel.instance.createNewPageModel();this.pageListView.addNewBlankPage(newPageModel,undefined,function(){_that.enableButtons();});},addEventsToCollection:function(){var collection=this.model.get('collection');collection.off();collection.on('reset add remove',function(){DarkanEditorAplicationAPI.getInstance().pagesCollectionChanged({pagesLength:collection.length});});},loadProject:function(){var _that=this;this.model=new ProjectModel({options:new ProjectOptions(),collection:new PageCollection()});ProjectModel.instance=this.model;this.model.loadProject(function(collection){var firstPageModel=collection.first();_that.model.set('collection',collection);_that.addEventsToCollection();_that.pageListView.loadProject(collection,firstPageModel);_log('collection',collection);if(firstPageModel==undefined){_that.trigger('show-modal-window',firstPageModel,this);}else{_that.trigger('set-page',firstPageModel,this);}
DarkanEditorAplicationAPI.getInstance().projectLoaded({pagesLength:collection.length});DarkanEditorAplicationAPI.getInstance().pagesCollectionChanged({pagesLength:collection.length});},function(){console.log("Not load project");});},loadHistoryPage:function(data){var _that=this;if(!_.isObject(data)){return;}
_log('loadHistoryPage',data);var action=data.action||{};var params=action.params||{};var pageId=parseInt(params.pageId);var pageModel=this.getPageModelByPageId(pageId);if(pageModel){var page=data.page;_log('pageId',pageId,_log.error);_log('page.options.pageid',page.options.pageid,_log.error);if(page.options.pageid==pageId){var newPageModel=ProjectModel.instance.createPageModel(page);pageModel.set('options',newPageModel.get('options'),{silent:true});pageModel.set('lines',newPageModel.get('lines'),{silent:true});if(this.pageIsTheSame(pageId)){this.trigger('set-page',pageModel,this);}}}},loadHistoryProject:function(data){var _that=this;if(!_.isObject(data)){return;}
var action=data.action||{};var params=action.params||{};var pageId=parseInt(params.pageId);_log('loadHistoryProject',action);this.model=new ProjectModel({options:new ProjectOptions(),collection:new PageCollection()});ProjectModel.instance=this.model;var collection=this.model.onGetProjectData(data);_that.model.set('collection',collection);var firstPageModel=collection.first();if(_.isNumber(pageId)){var pageModel=this.getPageModelByPageId(pageId);if(pageModel){firstPageModel=pageModel;}}
_that.addEventsToCollection();_that.pageListView.loadProject(collection,firstPageModel);_log('firstPageModel',firstPageModel);_that.trigger('set-page',firstPageModel,this);if(firstPageModel){_that.trigger('hide-modal-window',{pageModel:firstPageModel,collection:collection},this);}},pageIsTheSame:function(pageId){return(pageId==StageView.instance.model.get('options').get('pageid')&&StageView.instance.canEdit);},getPageModelByPageId:function(pageId){var pageModel;this.model.get('collection').each(function(model){if(model.get('options').get('pageid')==pageId){pageModel=model;}});return pageModel;},updateProjectOptions:function(options){var projectOptionsModel=ProjectModel.instance.get('options');for(var item in options){projectOptionsModel.set(item,options[item],{silent:true});}
projectOptionsModel.trigger('option-changes-coming',projectOptionsModel);},watchProject:function(){var _that=this;return;DataAccess.watchProject(this.model,function(data){var fileName=data.name;var event=data.event;switch(event){case'createBlankPage':var page=data.page;var pageModel=_that.model.createPageModel(page);var lastPageId=parseInt(data.lastPageId);ProjectModel.instance.get('options').set('last_page_id',lastPageId,{silent:true});var collection=_that.pageListView.createBlankPageComing(pageModel,data);if(collection.length>0){_that.trigger('hide-modal-window',{pageModel:pageModel,collection:collection},this);}
if(collection.length==1){_that.pageListView.setActivePageModel(pageModel);}
break;case'updatePage':var page=data.page;var pageModel=_that.model.createPageModel(page);_that.pageListView.updatePageModelComing(pageModel);_that.trigger('update-coming',pageModel,this);break;case'deletePages':var selectedPageModel=_that.onPagesDeletedComingResult(data);break;case'copyPage':var pages=data.pages;_that.updateProjectOptions(data.projectOptions);var lastPageId=parseInt(data.lastPageId);ProjectModel.instance.get('options').set('last_page_id',lastPageId,{silent:true});var collection=_that.pageListView.addCopyPageComing(data);if(collection){if(collection.length==1){_that.trigger('hide-modal-window',pageModel,this);_that.pageListView.setActivePageModel(pageModel);}}
break;case'updatePageSort':_that.pageListView.updatePageSortComing(data);break;case'saveProjectOptions':var options=data.options;_that.updateProjectOptions(data.options);break;case'updatePageOptions':_log('updatePageOptions','updatePageOptions');var pageId=data.pageId;if(_that.canEdit){var page=data.page;var imageChnged=false;var bgcolorChnged=false;if(page!=undefined){var pageOptions=data.page.options;var pageModel=RightMenuView.instance.getPageModelByPageId(pageOptions.pageid);if(pageModel!=undefined){var pageOptionsModel=pageModel.get('options');if(pageOptionsModel.get('image')!=pageOptions.image){imageChnged=true;}
if(pageOptionsModel.get('bgcolor')!=pageOptions.image){bgcolorChnged=true;}
pageOptionsModel.onlyRefresh=true;for(var item in pageOptions){pageOptionsModel.set(item,pageOptions[item]);}
pageOptionsModel.onlyRefresh=false;pageModel.view.renderSelectedBy();if(_that.canEdit&&User.getModel().get('activePageId').toString()==pageId.toString()){if(imageChnged){StageView.instance.renderBackgroundImage();pageModel.updateDinamicPageThumb();}
if(bgcolorChnged){StageView.instance.renderBackgroundColor();pageModel.updateDinamicPageThumb();}}}}else{console.log("Critical error - coming page = "+page);}
if(User.getModel().get('activePageId').toString()==pageId.toString()){}}
break;case'updateComponent':var pageId=data.pageId;_that.updateProjectOptions(data.projectOptions);if(!_that.canEdit||User.getModel().get('activePageId').toString()!=pageId.toString()){var page=data.page;if(page!=undefined){var newPageModel=_that.model.createPageModel(page);var actualPageModel=_that.pageListView.updatePageModelComing(newPageModel);}else{console.log("Critical error - coming page = "+page);}}else{_that.trigger('update-component-coming',data,this);}
var options=data.projectOptions;var projectOptionsModel=ProjectModel.instance.get('options');for(var item in options){projectOptionsModel.set(item,options[item],{silent:true});}
projectOptionsModel.trigger('option-changes-coming',projectOptionsModel);break;case'updateTimeline':var pageId=data.pageId;if(!_that.canEdit||User.getModel().get('activePageId').toString()!=pageId.toString()){var page=data.page;if(page!=undefined){var newPageModel=_that.model.createPageModel(page);_that.pageListView.updatePageModelComing(newPageModel);}else{console.log("Critical error - coming page = "+page);}}else{_that.trigger('update-timeline-coming',data,this);}
break;case'updateTimelineOptions':var pageId=data.pageId;var timelineOptions=data.timelineOptions;var lineId=parseInt(timelineOptions.id);var pageModel=_that.model.get('collection').getPageModelByPageId(pageId);var rowModel=pageModel.get('lines').getLineById(lineId);var lineOptions=rowModel.get('options');for(var opt in timelineOptions){lineOptions.set(opt,timelineOptions[opt]);}
rowModel.updateOptionComing(timelineOptions);break;case'updateCopyComponents':var pageId=data.pageId;_that.updateProjectOptions(data.projectOptions);if(!_that.canEdit||User.getModel().get('activePageId').toString()!=pageId.toString()){var page=data.page;if(page!=undefined){var newPageModel=_that.model.createPageModel(page);_that.pageListView.updatePageModelComing(newPageModel);}else{console.log("Critical error - coming page = "+page);}}else{_that.trigger('update-add-components-coming',data,this);}
break;case'clearProject':StageView.instance.clearStage();_that.clearList();_that.trigger('show-modal-window',{},this);case'saveHistory':var pageId=data.pageId;var page=data.page;if(page!=undefined){var newPageModel=_that.model.createPageModel(page);_that.pageListView.updatePageModelComing(newPageModel);if(User.getModel().get('activePageId').toString()==pageId.toString()){_that.trigger('set-page',newPageModel,_that);}}else{console.log("Critical error - coming page = "+page);}
break;case'updatePageThumb':if(_that.canEdit){var pageId=data.pageId;var pageModel=RightMenuView.instance.getPageModelByPageId(pageId);if(User.getModel().get('activePageId').toString()!=pageId.toString()){if(pageModel!=undefined){pageModel.updatePagethumb();}}}
break;case'userDisconnected':_log('userDisconnected');var login=data.login;_that.pageListView.unsetAllPagesComing(login);_log('login',login);break;}},function(data){console.log('On project chenged fault: ',data);var status=data.status;switch(status){case'no-files':console.log("No files");break;}});},updateProjectOptions:function(options){},createPsdPage:function(data){var _that=this;var page=data.page;var pageModel=_that.model.createPageModel(page);if(pageModel){var lastPageId=parseInt(data.lastPageId);ProjectModel.instance.get('options').set('last_page_id',lastPageId,{silent:true});var collection=_that.pageListView.createBlankPageComing(pageModel);_log('createPsdPage collection',collection)
if(collection.length>0){_that.pageListView.setActivePageModel(pageModel);_that.trigger('set-page',pageModel,this);pageModel.view.updateDinamicPageThumb();}}},goToNextPage:function(data){var pageModel=this.pageListView.getSelectedPageModel();var index=this.pageListView.collection.indexOf(pageModel);var nextPageModel=this.pageListView.collection.at(index+1);if(nextPageModel){this.pageListView.setActivePageModel(nextPageModel);this.trigger('set-page',nextPageModel,this);}},goToPrewPage:function(data){var pageModel=this.pageListView.getSelectedPageModel();var index=this.pageListView.collection.indexOf(pageModel);var nextPageModel=this.pageListView.collection.at(index-1);if(nextPageModel){this.pageListView.setActivePageModel(nextPageModel);this.trigger('set-page',nextPageModel,this);}},goToPage:function(data){var pageIndex=parseInt(data.pageIndex);var nextPageModel=this.pageListView.collection.at(pageIndex);if(nextPageModel){this.pageListView.setActivePageModel(nextPageModel);this.trigger('set-page',nextPageModel,this);}}});RightMenuView.instance={};;;var WindowModel=Backbone.Model.extend({defaults:{type:"",draggable:true,left:0,top:0,title:"",content:"",zIndex:5000}});;;var WindowView=Backbone.View.extend({tagName:'div',className:'window window-view',template:_.template($('#window-template').html()),modalExists:false,processingModal:{el:undefined,exists:false},events:{'close':'close','click .window-close-button':'close'},bindings:{'.window-top-bar':'title'},initialize:function(data){this.windowModel=data.windowModel;this.runListeners();this.afterInitialize(data);},afterInitialize:function(data){},render:function(dataModel){this.beforeRender();dataModel=dataModel!=undefined?dataModel:this.getRenderData();var componentTemplate=this.template(dataModel);this.$el.html(componentTemplate);var modal=this.windowModel.get('modal');if(modal){var windowID=new Date().getUTCMilliseconds();this.$el.attr('windowid',windowID);this.addModal(windowID);}
this.makeDraggable(modal);this.afterRender();return this;},getRenderData:function(){return this.windowModel.toJSON();},beforeRender:function(){},afterRender:function(){},close:function(){this.onClose();this.removeModal();this.unbind();this.remove();},setWindowPosition:function(position){var width=this.$el.width();var height=this.$el.height();var left=position.left-width;var top=position.top-height;if(left<0)
left=0;if(top<0)
top=0;this.$el.css('top',top+'px').css('left',left+'px');},makeDraggable:function(modal){if(this.windowModel.get('draggable')){var _that=this;this.$el.draggable({cursor:'move',handle:".window-top-bar",containment:$('body')});}},showModalWindowView:function(){if(!this.processingModal.exists){this.processingModal.el=$('<div>',{class:'processing-modal'});this.processingModal.el.css({width:'100%',height:'100%',top:0,left:0,position:'absolute',opacity:'0.4',background:'#ccc'});this.$el.append(this.processingModal.el);this.processingModal.exists=true;}},hideModalWindowView:function(){if(this.processingModal.exists){this.processingModal.el.remove();this.processingModal.exists=false;}},addModal:function(windowID){if(!this.modalExists){var zIndex=this.windowModel.get('zIndex');var modal=$('<div></div>',{class:'modal-block',});modal.css('z-index',zIndex);this.modalWindowEl=modal;$('body').append(modal);this.modalExists=true;}},removeModal:function(){if(this.windowModel.get('modal')){this.modalWindowEl.remove();}},hide:function(){this.$el.hide();},show:function(){this.$el.show();},runListeners:function(){},onClose:function(){},accept:function(visitor){visitor.visit(this);},getCapabilities:function(){var capabilities=Capabilities.getInstance();capabilities.on('change',this.onCapabilitiesChanged,this);capabilities.getCapabilities();},onCapabilitiesChanged:function(capabilitiesModel){},setTitle:function(title){this.windowModel.set('title',title);},makeResizable:function(){this.$el.resizable({handles:"n, e, s, w, nw, ne, sw, se",});},});;;var LoadedWindowView=WindowView.extend({onFileDragOver:function(e){e.stopPropagation();this.$el.find('.loaded-dropzone').fadeIn(200);},onFileDragOut:function(e){e.stopPropagation(e);this.$el.find('.loaded-dropzone').fadeOut(200);},getAcceptTypeFormat:function(){return this.model.getAcceptTypeFormat();},getDropProperties:function(e){return FileUploader.getDropProperties(e);},getInputProperties:function(e,input){return FileUploader.getInputProperties(e,input);},uploadOnClick:function(){var _that=this;var acceptTypeFormat=this.getAcceptTypeFormat();var input=$('<input type="file" name="files[]" accept="'+acceptTypeFormat+'">');input.css({display:'none'});this.$el.append(input);input.click();input.change(function(e){_that.uploadOnInputData(e,this,false);$(this).remove();});},uploadOnFileDrop:function(e,resizeImage){this.resizeImage=resizeImage;this.$el.find('.loaded-dropzone').fadeOut(500);var properties=this.getDropProperties(e);this.runUploadProcess(properties);},uploadOnInputData:function(e,input,resizeImage){this.resizeImage=resizeImage;var properties=this.getInputProperties(e,input);this.runUploadProcess(properties);},runUploadProcess:function(properties){if(this.model.uploadingNow){return;}
var specialData=this.getSpecialProperties();var toSend=$.extend({},properties,specialData);this.fileUploader=FileUploader.create(properties.data.name,this.model,this);if(this.fileUploader==undefined){this.showPupup({message:_lang('FILETYPE_NOT_ACCEPTED')},this);return;}
this.fileUploader.sendFile(toSend);this.fileUploader.on('on-result',this.onResult,this);this.fileUploader.on('on-fault',this.onFault,this);this.fileUploader.on('on-complete',this.onComplete,this);this.fileUploader.on('on-progress',this.onProgress,this);},onResult:function(data){if(data.key==1){this.showPupup({message:_lang('FILETYPE_NOT_ACCEPTED')},this);return;}},onFault:function(data){this.showPupup(data,this);},showPupup:function(data,sender){var popup=PopupFactory.createErrorPopup(data,sender);$('body').append(popup.render(data).$el);},onComplete:function(data){this.hideProgressPercent(data);this.renderAfterComplete(data);this.fileUploader.off();this.fileUploader=undefined;},renderAfterComplete:function(){},onProgress:function(data){this.showProgressPercent(data);},getSpecialProperties:function(){return{};},showProgressPercent:function(data){FileUploader.showProgressPercent(data,this);},hideProgressPercent:function(data){FileUploader.hideProgressPercent(data,this);}});;;var WindowModalView=WindowView.extend({className:'window window-modal',template:_.template($('#window-modal-template').html()),events:function(){return _.extend({},WindowView.prototype.events,{'click .window-modal-create-new-project':'createNewPage'});},createNewPage:function(){this.trigger('create-new-page');this.close();}});;;var ImagesWindowModel=WindowModel.extend({defaults:{type:"",modal:true,draggable:false}});;;var ImagesWindowView=WindowView.extend({tagName:'div',className:'window window-images-view',template:_.template($('#window-images-template').html()),searchTimeout:null,events:{'close':'close','click .window-close-button':'close','dragenter .drop-image-area':'onFileDragOver','dragleave .loaded-dropzone':'onFileDragOut','drop .loaded-dropzone':'onFileChoose','click .upload':'uploadOnClick','keyup .image-window-search-input':'checkWord','click .images-img-results':'chooseImage','click .upload-from-link':'uploadFromLinkClick','keyup .image-window-link-input':'uploadFromLinkEnter'},initialize:function(data){var _that=this;this.windowModel=data.windowModel;this.activeTab=data.activeTab;this.sender=data.sender;this.runListeners();document.onpaste=function(event){var items=(event.clipboardData||event.originalEvent.clipboardData).items;var blob=null;for(var i=0;i<items.length;i++){if(items[i].type.indexOf("image")===0){blob=items[i].getAsFile();}}
if(blob!==null){if(_that.sender!=undefined){_that.sender.uploadOnPaste(event,blob,false);}else{_that.trigger('imageupload-on-paste',event,blob);}
_that.close();}}},validateText:function(){var imageUrl=StringTools.trim(this.$el.find('.image-window-link-input').val());var urlpattern=new RegExp('(http|ftp|https)://[a-z0-9\-_]+(\.[a-z0-9\-_]+)+([a-z0-9\-\.,@\?^=%&;:/~\+#]*[a-z0-9\-@\?^=%&;/~\+#])?','i');if(urlpattern.test(imageUrl)){}else{imageUrl=undefined;}
return imageUrl;},uploadFromLinkEnter:function(e){if(e.key==13){this.uploadFromLinkClick();}},uploadFromLinkClick:function(){var imageUrl=this.validateText();if(imageUrl){this.convertLinkToImage(imageUrl);}else{var input=this.$el.find('.image-window-link-input');input.addClass('animated float error');input.focus();clearTimeout(this.errorTimeout);this.errorTimeout=setTimeout(function(){input.removeClass('animated float error');},1000);}},convertLinkToImage:function(imageUrl){if(this.sender!=undefined){this.sender.uploadOnLink(imageUrl,false);}else{this.trigger('imageupload-link',imageUrl);}
this.close();},chooseImage:function(e){var imageUrl=$(e.target).parent().attr('imagefile');if(this.sender!=undefined){this.sender.uploadOnLink(imageUrl,false);}else{this.trigger('imageupload-link',imageUrl);}
this.close();},checkWord:function(e){var _that=this;var words=this.$el.find('.image-window-search-input').val();clearTimeout(this.searchTimeout);this.searchTimeout=setTimeout(function(){_that.searchImages(words);},1000);},showLoadGif:function(){this.$el.find('.image-window-search-results').html('<img src="content_template/css/gif-load.gif">');},searchImages:function(words){var _that=this;this.showLoadGif();var request={request:5,searchVal:words};DataAccess.searchImages({request:JSON.stringify(request)},function(data){var dat=JSON.parse(data);_that.showImages(dat,words);},function(data){_log('data',data)});},showImages:function(data,words){var _that=this;var results;var resultDiv='';var rData;this.$el.find('.image-window-search-results').html('');try{rData=JSON.parse(data.google);if(rData.responseData){results=rData.responseData.results;this.$el.find('.image-window-search-results').html('').append('<div class="imagesearch-title">Google</div><hr>');_.each(results,function(imageData,i){resultDiv=$('<div imagefile="'+imageData.url+'" class="all-img-result images-img-results"><img src="'+imageData.tbUrl+'" /></div>');_that.$el.find('.image-window-search-results').append(resultDiv);});}
rData=JSON.parse(data.iconfinder);if(rData.searchresults){results=rData.searchresults.icons;this.$el.find('.image-window-search-results').append('<div class="imagesearch-title">Iconfinder</div><hr>');_.each(results,function(imageData,i){resultDiv=$('<div imagefile="'+imageData.image+'" class="all-img-result images-img-results"><img src="'+imageData.image+'" /></div>');_that.$el.find('.image-window-search-results').append(resultDiv);});}
rData=JSON.parse(data.pixabay);if(rData.hits){this.$el.find('.image-window-search-results').append('<div class="imagesearch-title">Pixabay</div><hr>');results=rData.hits;_.each(results,function(imageData,i){resultDiv=$('<div imagefile="'+imageData.webformatURL+'" class="all-img-result images-img-results"><img src="'+imageData.previewURL+'" /></div>');_that.$el.find('.image-window-search-results').append(resultDiv);});}
var query=words.replace(" ","+");var url="https://api.flickr.com/services/rest/?method=flickr.photos.search&extras=original_format,o_dims,url_o,url_b&api_key=5f3f0b0d935c5a7be67f6af3f2dfbc20&tags="+query+"&safe_search=1";var src,thumb;$.getJSON(url+"&format=json&jsoncallback=?",function(data){if(data.photos.photo.length>0){_that.$el.find('.image-window-search-results').append('<div class="imagesearch-title">Flickr</div><hr>');$.each(data.photos.photo,function(i,item){var format='jpg';var secret=item.secret;var size='b';if(typeof item.originalsecret!=="undefined"){if(parseInt(item.width_o)<1600){size='o';secret=item.originalsecret;format=item.originalformat;}}
src="http://farm"+item.farm+".static.flickr.com/"+item.server+"/"+item.id+"_"+secret+"_"+size+"."+format;thumb="http://farm"+item.farm+".static.flickr.com/"+item.server+"/"+item.id+"_"+item.secret+"_t.jpg";var result_img=$('<div imagefile="'+src+'" class="images-img-results flickr-img-result"><img src="'+thumb+'" /></div>');_that.$el.find('.image-window-search-results').append(result_img);});}});}catch(err){_log('imagesearch error',err,_log.error);}},uploadOnClick:function(){var _that=this;var input=$('<input type="file" name="files[]" accept="image/*">');input.css({});_log('uploadOnClick window',input);this.$el.append(input);input.change(function(e){_log('uploadOnClick window',e);if(_that.sender!=undefined){_that.sender.uploadOnInputData(e,this,false);}else{_that.trigger('imageupload-onclick',e,this);}
$(this).remove();_that.close();});input.click();},onFileDragOver:function(e){e.stopPropagation();this.$el.find('.loaded-dropzone').fadeIn(200);},onFileDragOut:function(e){e.stopPropagation(e);this.$el.find('.loaded-dropzone').fadeOut(200);},onFileChoose:function(e){if(this.sender!=undefined){this.sender.uploadOnFileDrop(e,false);}else{this.trigger('imageupload-ondrop',this.getDropProperties(e));}
this.close();},getDropProperties:function(e){var imageUrl;var file=e.originalEvent.dataTransfer.files[0];var data;if(file!=undefined){var imageName=file.name;var imageData=e.originalEvent.dataTransfer.result;data={name:imageName,data:imageData,size:file.size};}else{imageUrl=e.originalEvent.dataTransfer.getData('text');}
return{file:file,data:data,imageUrl:imageUrl};},afterRender:function(){this.$el.find('.darkan-tabs').tabs();},onClose:function(){delete document.onpaste;this.trigger('on-close');}});;;var TestDriveWindowModel=WindowModel.extend({defaults:{type:"",modal:true,draggable:true,zIndex:8000}});;;var TestDriveWindowView=WindowView.extend({tagName:'div',className:'window window-test-drive-view',template:_.template($('#window-test-drive-template').html()),events:{'submit .test-drive-form':'submitTestDriveEmail',},initialize:function(data){var _that=this;this.windowModel=data.windowModel;this.runListeners();if(this.getTestDriveAsVisited()){}},submitTestDriveEmail:function(e){var _that=this;e.preventDefault();var email=$(e.target).find('.test-drive-email-input').val();if(!this.isEmail(email)){this.$el.find('.error-feedback').text(_lang('emailIsInvalid'));return;}
DataAccess.submitTestDriveEmail({email:email},function(data){_log('submitTestDriveEmail result: ',data,_log.dataaccessOutResult);_that.setTestDriveAsVisited();_that.close();},function(data){_log('submitTestDriveEmail fault: ',data,_log.dataaccessOutFault);});},isEmail:function(email){var regex=/^([a-zA-Z0-9_.+-])+\@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/;return regex.test(email);},setTestDriveAsVisited:function(){Utils.setCookie('testdrive',true,30);},getTestDriveAsVisited:function(){return Utils.getCookie('testdrive');},});;;var TimerClockModel=Backbone.Model.extend({defaults:{hours:0,minutes:0,seconds:0,hoursEnabled:true,minutesEnabled:true,secondsEnabled:true}});;;var TimerWindowModel=WindowModel.extend({defaults:{type:"",modal:false,draggable:true,hours:0,minutes:0,seconds:0,hoursEnabled:false,minutesEnabled:true,secondsEnabled:true}});;;var TimerWindowView=WindowView.extend({tagName:'div',className:'window window-timer-view',template:_.template($('#window-timer-template').html()),isRuning:false,timerTime:0,events:{},initialize:function(data){var _that=this;this.windowModel=data.windowModel;this.model=this.windowModel;this.runListeners();this.getServerDate();},getServerDate:function(){var _that=this;DataAccess.getServerDate({},function(data){_log('getServerDate result: ',data,_log.dataaccessOutResult);_that.runTimer(data);},function(data){_log('getServerDate fault: ',data,_log.dataaccessOutFault);});},runTimer:function(data){var seconds=parseInt(data.secondsToFullHour);this.timerTime=seconds;this.startTimer();},startTimer:function(){if(!this.isRuning){this.loop();}
this.isRuning=true;},loop:function(){var _that=this;this.renderTime();if(this.timerTime>0){this.timerId=window.setTimeout(function(){_that.onTick()},1000);}else{this.onComplete();}
this.timerTime--;},stopTimer:function(){window.clearTimeout(this.timerId);this.isRuning=false;},pause:function(){window.clearTimeout(this.timerId);},onTick:function(){if(this.timerTime>=0){this.trigger('onTimerTick');this.loop();}},onComplete:function(){this.stopTimer();this.trigger('onTimerComplete');},convertToTime:function(timeInSeconds){var date=new Date(null);date.setSeconds(timeInSeconds);var time=this.retValue(date.getUTCMinutes())+':'+this.retValue(date.getUTCSeconds());return time;},renderTime:function(){var time=this.convertToTime(this.timerTime);this.$el.find('span[name="time"]').text(time);},retValue:function(value){var ret=value<10?'0'+value:value;return ret;},beforeDestroy:function(){_log('beforeDestroy','beforeDestroy');this.stopTimer();},afterRender:function(){this.addTitleToButtons();},addTitleToButtons:function(){this.$el.find('[title]').tooltip({html:true,animated:'fade',placement:'right',width:300,height:200});},});;;var ProjectVersionWindowModel=WindowModel.extend({defaults:{type:"",modal:true,draggable:false}});;;var ProjectVersionWindowView=WindowView.extend({tagName:'div',className:'window window-project-version-view',template:_.template($('#window-project-version-template').html()),events:{'close':'close','click .window-close-button':'close','click .project-version-button-new':'saveNewProjectVersioin','click .PVersionDeleteButton':'deleteProjectVersion','click .PVersionRestoreButton':'restoreProjectVersion'},afterRender:function(){this.getProjectVersionList();},deleteProjectVersion:function(e){var _that=this;this.showModalWindowView();var target=$(e.currentTarget);var projectVersionID=target.attr('pid');var request={request:13,version_id:projectVersionID,project_id:__meta__.projectID};DataAccess.projectVersioinRequest({request:request},function(data){var dataJ=JSON.parse(data);var projectVersionList=dataJ.list;_that.showProjectVersionList(projectVersionList);_that.hideModalWindowView();},function(data){_log('data',data)});},restoreProjectVersion:function(e){var _that=this;this.showModalWindowView();var target=$(e.currentTarget);var projectVersionID=target.attr('pid');var request={request:12,project_id:__meta__.projectID,version_id:projectVersionID,save:0};DataAccess.projectVersioinRequest({request:request},function(data){window.location.reload();},function(data){_log('data',data)});},getProjectVersionList:function(){var _that=this;var request={request:10,project_id:__meta__.projectID};DataAccess.projectVersioinRequest({request:request},function(data){var dataJ=JSON.parse(data);var projectVersionList=dataJ.list;_that.showProjectVersionList(projectVersionList);},function(data){_log('data',data)});},showProjectVersionList:function(data){var _that=this;var appendHTML='<ul>';_.each(data,function(pVersion){appendHTML+='<li pid="'+pVersion.id+'" title="Wielko: '+(pVersion.size / 1024 / 1024).toFixed(2)+'MB<br>Opis: '+pVersion.description+'">';appendHTML+='<div class="PVersionDate">'+pVersion.date+'</div>';appendHTML+='<div class="PVersionUser">'+pVersion.login+'</div>';appendHTML+='<div class="PVersionButtons">';appendHTML+='<div title="'+_lang('PVERSION_PDELETE')+'" class="PVersionDeleteButton" pid="'+pVersion.id+'"></div>';appendHTML+='<div title="'+_lang('PVERSION_PRESTORE')+'" class="PVersionRestoreButton" project_id="'+__meta__.projectID+'" pid="'+pVersion.id+'"></div>';appendHTML+='</div>';appendHTML+='</li>';});appendHTML+='</ul>';this.$el.find('.project-version-list-container').html(appendHTML);},saveNewProjectVersioin:function(){var _that=this;this.showModalWindowView();var czas=new Date();var hour=this.zeroWiodace(czas.getHours())+':'+this.zeroWiodace(czas.getMinutes())+':'+this.zeroWiodace(czas.getSeconds());var date=czas.getFullYear()+'-'+this.zeroWiodace(czas.getMonth()+1)+'-'+this.zeroWiodace(czas.getDate());var description=this.$el.find('.project-version-description-input').val();var request={request:11,description:description,project_id:__meta__.projectID,date:date+' '+hour}
DataAccess.projectVersioinRequest({request:request},function(data){var dataJ=JSON.parse(data);var projectVersionList=dataJ.list;_that.showProjectVersionList(projectVersionList);_that.hideModalWindowView();},function(data){_log('data',data)});},zeroWiodace:function(i){return(i<10)?'0'+i:i;}});;;var BorderWindowModel=WindowModel.extend({defaults:{type:"",modal:true,draggable:true}});;;var BorderWindowView=WindowView.extend({tagName:'div',className:'window border-window-view',template:_.template($('#border-window-template').html()),events:function(){return _.extend({},WindowView.prototype.events,{'change input[name="border"]':'changeBorder','change input[name="border-radius"]':'changeBorderRadius','change input[name="shadow"]':'changeShadow','change .border-style-type':'changeBorderType','click .show-border-option-extend':'showExtendOptionsBorder','click .show-border-radius-option-extend':'showExtendOptionsBorderRadius'});},showExtendOptionsBorder:function(){var visible=this.$el.find('.option-extend-border').css('display');if(visible==='none'){this.$el.find('.option-extend-border').show();this.$el.find('.show-border-option-extend').text('-');}else{this.$el.find('.option-extend-border').hide();this.$el.find('.show-border-option-extend').text('+');}},showExtendOptionsBorderRadius:function(){var visible=this.$el.find('.option-extend-border-radius').css('display');if(visible==='none'){this.$el.find('.option-extend-border-radius').show();this.$el.find('.show-border-radius-option-extend').text('-');}else{this.$el.find('.option-extend-border-radius').hide();this.$el.find('.show-border-radius-option-extend').text('+');}},changeBorder:function(e){var _that=this;var target=$(e.currentTarget);var targetValue=target.val();var action=target.attr('action');var componentCollection=StageView.instance.selectedComponentsCollection;componentCollection.each(function(model){var styles=model.get('styles');if(typeof styles['component-inner']==='undefined'){styles['component-inner']={};}
if(typeof styles['component-inner']['border-color']==='undefined'){styles['component-inner']['border-color']='#000';}
if(typeof styles['component-inner']['border-style']==='undefined'){styles['component-inner']['border-style']='solid';}
var border={'border-top-width':typeof styles['component-inner']['border-top-width']!=='undefined'?styles['component-inner']['border-top-width']:'0px','border-left-width':typeof styles['component-inner']['border-left-width']!=='undefined'?styles['component-inner']['border-left-width']:'0px','border-right-width':typeof styles['component-inner']['border-right-width']!=='undefined'?styles['component-inner']['border-right-width']:'0px','border-bottom-width':typeof styles['component-inner']['border-bottom-width']!=='undefined'?styles['component-inner']['border-bottom-width']:'0px'}
switch(action){case'top':border['border-top-width']=targetValue+'px';break;case'left':border['border-left-width']=targetValue+'px';break;case'right':border['border-right-width']=targetValue+'px';break;case'bottom':border['border-bottom-width']=targetValue+'px';break;case'all':border['border-top-width']=targetValue+'px';border['border-left-width']=targetValue+'px';border['border-right-width']=targetValue+'px';border['border-bottom-width']=targetValue+'px';break;}
_.extend(styles['component-inner'],border);model.trigger('change:border');model.set('styles',styles);model.trigger('change');});this.renderValues();},changeBorderType:function(e){var _that=this;var target=$(e.currentTarget);var targetValue=target.val();var componentCollection=StageView.instance.selectedComponentsCollection;componentCollection.each(function(model){var styles=model.get('styles');if(typeof styles['component-inner']==='undefined'){styles['component-inner']={};}
styles['component-inner']['border-style']=targetValue;model.set('styles',styles);model.trigger('change:border');model.trigger('change');});},changeBorderRadius:function(e){var _that=this;var target=$(e.currentTarget);var targetValue=target.val();var action=target.attr('action');var componentCollection=StageView.instance.selectedComponentsCollection;componentCollection.each(function(model){var styles=model.get('styles');if(typeof styles['component-inner']==='undefined'){styles['component-inner']={};}
var borderRadius={'border-top-right-radius':typeof styles['component-inner']['border-top-right-radius']!=='undefined'?styles['component-inner']['border-top-right-radius']:'0px','border-top-left-radius':typeof styles['component-inner']['border-top-left-radius']!=='undefined'?styles['component-inner']['border-top-left-radius']:'0px','border-bottom-right-radius':typeof styles['component-inner']['border-bottom-right-radius']!=='undefined'?styles['component-inner']['border-bottom-right-radius']:'0px','border-bottom-left-radius':typeof styles['component-inner']['border-bottom-left-radius']!=='undefined'?styles['component-inner']['border-bottom-left-radius']:'0px'}
switch(action){case'topLeft':borderRadius['border-top-left-radius']=targetValue+'px';break;case'topRight':borderRadius['border-top-right-radius']=targetValue+'px';break;case'bottomLeft':borderRadius['border-bottom-left-radius']=targetValue+'px';break;case'bottomRight':borderRadius['border-bottom-right-radius']=targetValue+'px';break;case'all':borderRadius['border-top-right-radius']=targetValue+'px';borderRadius['border-top-left-radius']=targetValue+'px';borderRadius['border-bottom-right-radius']=targetValue+'px';borderRadius['border-bottom-left-radius']=targetValue+'px';break;}
_.extend(styles['component-inner'],borderRadius);model.set('styles',styles);model.trigger('change:borderRadius');model.trigger('change');});this.renderValues();},changeShadow:function(e){var _that=this;var target=$(e.currentTarget);var targetValue=target.val();var action=target.attr('action');var componentCollection=StageView.instance.selectedComponentsCollection;componentCollection.each(function(model){var styles=model.get('styles');if(typeof styles['component-inner']==='undefined'){styles['component-inner']={};}
var shadow={color:'#CCC',size:0,blur:0,x:0,y:0};if(typeof styles['component-inner']['box-shadow']!=='undefined'){var _shadow=styles['component-inner']['box-shadow'].split(' ');shadow.x=parseInt(_shadow[1]);shadow.y=parseInt(_shadow[2]);shadow.blur=parseInt(_shadow[3]);shadow.size=parseInt(_shadow[4]);shadow.color=_shadow[0];}
switch(action){case'size':shadow.size=targetValue;break;case'blur':shadow.blur=targetValue;break;case'x':shadow.x=targetValue;break;case'y':shadow.y=targetValue;break;}
styles['component-inner']['box-shadow']=shadow.color+' '+shadow.x+'px '+shadow.y+'px '+shadow.blur+'px '+shadow.size+'px';styles['component-inner']['-webkit-box-shadow']=shadow.color+' '+shadow.x+'px '+shadow.y+'px '+shadow.blur+'px '+shadow.size+'px';styles['component-inner']['-moz-box-shadow']=shadow.color+' '+shadow.x+'px '+shadow.y+'px '+shadow.blur+'px '+shadow.size+'px';model.set('styles',styles);model.trigger('change:shadow');model.trigger('change');});this.renderValues();},runListeners:function(){},renderValues:function(){this.$el.find('.border-window-overlay').hide();var border={top:true,left:true,right:true,bottom:true,all:true};var borderRadius={topLeft:true,topRight:true,bottomLeft:true,bottomRight:true,all:true};var shadow={size:true,blur:true,x:true,y:true};var _border={top:0,left:0,right:0,bottom:0}
var _borderRadius={topLeft:0,topRight:0,bottomLeft:0,bottomRight:0};var _shadow={size:0,blur:0,x:0,y:0};var ___shadow={};var b={};var br={};StageView.instance.selectedComponentsCollection.each(function(model,index){var styles=model.get('styles');___shadow={color:'#FFF',size:0,blur:0,x:0,y:0};if(typeof styles['component-inner']==='undefined'){styles['component-inner']={};}
if(typeof styles['component-inner']['box-shadow']!=='undefined'){var _shadowA=styles['component-inner']['box-shadow'].split(' ');___shadow.x=parseInt(_shadowA[1]);___shadow.y=parseInt(_shadowA[2]);___shadow.blur=parseInt(_shadowA[3]);___shadow.size=parseInt(_shadowA[4]);}
b={top:typeof styles['component-inner']['border-top-width']!=='undefined'?parseInt(styles['component-inner']['border-top-width']):0,left:typeof styles['component-inner']['border-left-width']!=='undefined'?parseInt(styles['component-inner']['border-left-width']):0,right:typeof styles['component-inner']['border-right-width']!=='undefined'?parseInt(styles['component-inner']['border-right-width']):0,bottom:typeof styles['component-inner']['border-bottom-width']!=='undefined'?parseInt(styles['component-inner']['border-bottom-width']):0,style:typeof styles['component-inner']['border-style']!=='undefined'?styles['component-inner']['border-style']:'solid',color:typeof styles['component-inner']['border-color']!=='undefined'?styles['component-inner']['border-color']:'#000'};br={topLeft:typeof styles['component-inner']['border-top-left-radius']!=='undefined'?parseInt(styles['component-inner']['border-top-left-radius']):0,topRight:typeof styles['component-inner']['border-top-right-radius']!=='undefined'?parseInt(styles['component-inner']['border-top-right-radius']):0,bottomLeft:typeof styles['component-inner']['border-bottom-left-radius']!=='undefined'?parseInt(styles['component-inner']['border-bottom-left-radius']):0,bottomRight:typeof styles['component-inner']['border-bottom-right-radius']!=='undefined'?parseInt(styles['component-inner']['border-bottom-right-radius']):0}
if(index===0){_border.top=b.top;_border.left=b.left;_border.right=b.right;_border.bottom=b.bottom;_borderRadius.topLeft=br.topLeft;_borderRadius.topRight=br.topRight;_borderRadius.bottomLeft=br.bottomLeft;_borderRadius.bottomRight=br.bottomRight;_shadow.size=___shadow[4];_shadow.blur=___shadow[3];_shadow.x=___shadow[1];_shadow.y=___shadow[2];}else{b.top!==_border.top?border.top=false:'';b.left!==_border.left?border.left=false:'';b.right!==_border.right?border.right=false:'';b.bottom!==_border.bottom?border.bottom=false:'';br.topLeft!==_borderRadius.topLeft?borderRadius.topLeft=false:'';br.topRight!==_borderRadius.topRight?borderRadius.topRight=false:'';br.bottomLeft!==_borderRadius.bottomLeft?borderRadius.bottomLeft=false:'';br.bottomRight!==_borderRadius.bottomRight?borderRadius.bottomRight=false:'';___shadow[4]!==_shadow.size?shadow.size=false:'';___shadow[3]!==_shadow.blur?shadow.blur=false:'';___shadow[1]!==_shadow.x?shadow.x=false:'';___shadow[2]!==_shadow.y?shadow.y=false:'';}
if((b.top!==b.left||b.left!==b.right||b.right!==b.bottom)||(border.top===false||border.left===false||border.right===false||border.bottom===false)){border.all=false;}
if((br.topLeft!==br.topRight||br.topRight!==br.bottomLeft||br.bottomLeft!==br.bottomRight)||(borderRadius.topLeft===false||borderRadius.topRight===false||borderRadius.bottomLeft===false||borderRadius.bottomRight===false)){borderRadius.all=false;}});if(!border.all){this.$el.find('.different-border-all').addClass('warning-icon');}else{this.$el.find('.different-border-all').removeClass('warning-icon');}
if(!border.top){this.$el.find('.different-border-top').addClass('warning-icon');}else{this.$el.find('.different-border-top').removeClass('warning-icon');}
if(!border.left){this.$el.find('.different-border-left').addClass('warning-icon');}else{this.$el.find('.different-border-left').removeClass('warning-icon');}
if(!border.right){this.$el.find('.different-border-right').addClass('warning-icon');}else{this.$el.find('.different-border-right').removeClass('warning-icon');}
if(!border.bottom){this.$el.find('.different-border-bottom').addClass('warning-icon');}else{this.$el.find('.different-border-bottom').removeClass('warning-icon');}
if(!borderRadius.all){this.$el.find('.different-border-radius-all').addClass('warning-icon');}else{this.$el.find('.different-border-radius-all').removeClass('warning-icon');}
if(!borderRadius.topLeft){this.$el.find('.different-border-radius-topleft').addClass('warning-icon');}else{this.$el.find('.different-border-radius-topleft').removeClass('warning-icon');}
if(!borderRadius.topRight){this.$el.find('.different-border-radius-topright').addClass('warning-icon');}else{this.$el.find('.different-border-radius-topright').removeClass('warning-icon');}
if(!borderRadius.bottomLeft){this.$el.find('.different-border-radius-bottomleft').addClass('warning-icon');}else{this.$el.find('.different-border-radius-bottomleft').removeClass('warning-icon');}
if(!borderRadius.bottomRight){this.$el.find('.different-border-radius-bottomright').addClass('warning-icon');}else{this.$el.find('.different-border-radius-bottomright').removeClass('warning-icon');}
if(!shadow.size){this.$el.find('.different-shadow-size').addClass('warning-icon');}else{this.$el.find('.different-shadow-size').removeClass('warning-icon');}
if(!shadow.blur){this.$el.find('.different-shadow-blur').addClass('warning-icon');}else{this.$el.find('.different-shadow-blur').removeClass('warning-icon');}
if(!shadow.x){this.$el.find('.different-shadow-x').addClass('warning-icon');}else{this.$el.find('.different-shadow-x').removeClass('warning-icon');}
if(!shadow.y){this.$el.find('.different-shadow-y').addClass('warning-icon');}else{this.$el.find('.different-shadow-y').removeClass('warning-icon');}
this.$el.find('.border-style-type').val(b.style);this.$el.find('input[name="border"][action="all"]').val(b.top);this.$el.find('input[name="border"][action="top"]').val(b.top);this.$el.find('input[name="border"][action="left"]').val(b.left);this.$el.find('input[name="border"][action="right"]').val(b.right);this.$el.find('input[name="border"][action="bottom"]').val(b.bottom);this.$el.find('input[name="border-radius"][action="all"]').val(br.topLeft);this.$el.find('input[name="border-radius"][action="topLeft"]').val(br.topLeft);this.$el.find('input[name="border-radius"][action="topRight"]').val(br.topRight);this.$el.find('input[name="border-radius"][action="bottomLeft"]').val(br.bottomLeft);this.$el.find('input[name="border-radius"][action="bottomRight"]').val(br.bottomRight);this.$el.find('input[name="shadow"][action="size"]').val(___shadow.size);this.$el.find('input[name="shadow"][action="blur"]').val(___shadow.blur);this.$el.find('input[name="shadow"][action="x"]').val(___shadow.x);this.$el.find('input[name="shadow"][action="y"]').val(___shadow.y);var colorBorder=b.color;var colorShadow=___shadow[0];this.colorPickerBorder.updateColorPicker({color:colorBorder});this.colorPickerShadow.updateColorPicker({color:colorShadow});},afterRender:function(){this.$el.find('.darkan-tabs').tabs();this.colorPickerBorder=new ColorPickerView({color:'#CCC'});this.$el.find('.border-color-picker').html(this.colorPickerBorder.render().$el);this.colorPickerBorder.on('move',function(data){StageView.instance.selectedComponentsCollection.each(function(model){var styles=model.get('styles');if(typeof styles['component-inner']==='undefined'){styles['component-inner']={};}
styles['component-inner']['border-color']=data.color;model.set('styles',styles);model.view.renderBorder();});});this.colorPickerBorder.on('change',function(data){});this.colorPickerBorder.on('hide',function(data){StageView.instance.selectedComponentsCollection.each(function(model){model.trigger('change:border');model.trigger('change');});});this.colorPickerShadow=new ColorPickerView({color:'#CCC'});this.$el.find('.shadow-color-picker').html(this.colorPickerShadow.render().$el);this.colorPickerShadow.on('move',function(data){StageView.instance.selectedComponentsCollection.each(function(model){var styles=model.get('styles');if(typeof styles['component-inner']==='undefined'){styles['component-inner']={};}
var ___shadow={color:'#CCC',size:0,blur:0,x:0,y:0};if(typeof styles['component-inner']['box-shadow']!=='undefined'){var _shadowA=styles['component-inner']['box-shadow'].split(' ');function rgb2hex(rgb){var hexDigits=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];rgb=rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);function hex(x){return isNaN(x)?"00":hexDigits[(x-x%16)/ 16]+hexDigits[x%16];}
return"#"+hex(rgb[1])+hex(rgb[2])+hex(rgb[3]);}
___shadow.x=parseInt(_shadowA[1]);___shadow.y=parseInt(_shadowA[2]);___shadow.blur=parseInt(_shadowA[3]);___shadow.size=parseInt(_shadowA[4]);___shadow.color=rgb2hex(data.color);}
styles['component-inner']['box-shadow']=___shadow.color+' '+___shadow.x+'px '+___shadow.y+'px '+___shadow.blur+'px '+___shadow.size+'px';styles['component-inner']['-webkit-box-shadow']=___shadow.color+' '+___shadow.x+'px '+___shadow.y+'px '+___shadow.blur+'px '+___shadow.size+'px';styles['component-inner']['-moz-box-shadow']=___shadow.color+' '+___shadow.x+'px '+___shadow.y+'px '+___shadow.blur+'px '+___shadow.size+'px';model.view.renderShadow();});});this.colorPickerShadow.on('change',function(data){});this.colorPickerShadow.on('hide',function(data){StageView.instance.selectedComponentsCollection.each(function(model){model.trigger('change:shadow');model.trigger('change');});});this.renderValues();this.listenTo(StageView.instance.selectedComponentsCollection,'add',this.renderValues);this.listenTo(StageView.instance.selectedComponentsCollection,'reset',this.resetCollection);},resetCollection:function(){this.$el.find('.border-window-overlay').show();},setWindowPosition:function(){var firstModel=StageView.instance.selectedComponentsCollection.first();var firstModelPosition=$(firstModel.view.$el).offset();var top=firstModelPosition.top;var left=firstModelPosition.left+firstModel.get('width');this.$el.css('top',top+'px').css('left',left+'px');}});;;var VideoWindowModel=WindowModel.extend({defaults:{type:"",modal:true,draggable:false}});;;var VideoWindowView=WindowView.extend({tagName:'div',className:'window window-video-view',template:_.template($('#window-video-template').html()),searchTimeout:null,events:{'close':'close','click .window-close-button':'close','dragenter .drop-video-area':'onFileDragOver','dragleave .loaded-dropzone':'onFileDragOut','drop .loaded-dropzone':'onFileChoose','click .upload':'uploadOnClick','keyup .video-window-youtube-search-input':'checkWordYoutube','keyup .video-window-vimeo-search-input':'checkWordVimeo','paste .video-window-youtube-search-input, .video-window-vimeo-search-input':'pasteLink','click .v':'chooseVideo'},pasteLink:function(e){var videoLink=e.originalEvent.clipboardData.getData('Text');var videoType=2;var prefixLink=videoLink.substring(0,16);if(prefixLink=='http://www.youtu'||prefixLink=='https://www.yout'){videoType=2;this.trigger('putvideolink',{videoLink:videoLink,videoType:videoType},this);this.close();}
if(prefixLink=='http://vimeo.com'||prefixLink=='https://vimeo.co'){videoType=3;this.trigger('putvideolink',{videoLink:videoLink,videoType:videoType},this);this.close();}},chooseVideo:function(e){var videoDiv=$(e.currentTarget).find('.video-link-container');var videoLink=videoDiv.attr('href');var videoType=2;if(videoDiv.hasClass('video-youtube')){videoType=2;}else if(videoDiv.hasClass('video-vimeo')){videoType=3;}
this.trigger('putvideolink',{videoLink:videoLink,videoType:videoType},this);this.close();},checkWordYoutube:function(e){var _that=this;var words=this.$el.find('.video-window-youtube-search-input').val();clearTimeout(this.searchTimeout);this.searchTimeout=setTimeout(function(){_that.searchYoutubeVideo(words);},1000);},showYTLoadGif:function(){this.$el.find('.video-window-youtube-search-results').html('<img src="content_template/css/gif-load.gif">');},showVimeoLoadGif:function(){this.$el.find('.video-window-vimeo-search-results').html('<img src="content_template/css/gif-load.gif">');},searchYoutubeVideo:function(words){var _that=this;this.showYTLoadGif();var request={searchVal:words};DataAccess.searchYoutube({request:JSON.stringify(request)},function(data){var dat=JSON.parse(data);_that.showYoutube(dat);},function(data){_log('data',data)});},showYoutube:function(data){var _that=this;var dataJ=data;_that.$el.find('.video-window-youtube-search-results').html('');$.each(dataJ,function(i,item){var code='<div class="v"> <span class="details"> <h3>'+dataJ[i].title+'</h3> <div class="video-link-container video-youtube" href="https://www.youtube.com/watch?v='+dataJ[i].url+'" target="_blank" class="wrapping"><img src="'+dataJ[i].thumbnail+'" alt="'+dataJ[i].title+' video thumbnail" class="thumbnail"></div> </div>';$("#loader").remove();_that.$el.find('.video-window-youtube-search-results').append(code);});},checkWordVimeo:function(e){var _that=this;var words=this.$el.find('.video-window-vimeo-search-input').val();clearTimeout(this.searchTimeout);this.searchTimeout=setTimeout(function(){_that.searchVimeoVideo(words);},1000);},searchVimeoVideo:function(words){var _that=this;this.showVimeoLoadGif();var request={searchVal:words};DataAccess.searchVimeo({request:JSON.stringify(request)},function(data){var dat=JSON.parse(data);_that.showVimeo(dat,words);},function(data){_log('data',data)});},showVimeo:function(data){var _that=this;_that.$el.find('.video-window-vimeo-search-results').html('');$.each(data,function(i,item){var code='<div class="v"> <span class="details"><img src="'+data[i].userpic+'" class="userpic"> <h3>'+data[i].title+'</h3> <span class="user">uploaded by <div href="'+data[i].userurl+'" target="_blank">'+data[i].username+'</div></span></span> <div class="video-link-container video-vimeo" href="'+data[i].url+'" target="_blank" class="wrapping"><img src="'+data[i].thumbnail+'" alt="'+data[i].title+' video thumbnail" class="thumbnail"></div> </div>';$("#loader").remove();_that.$el.find('.video-window-vimeo-search-results').append(code);});},uploadOnClick:function(){var _that=this;var input=$('<input type="file" name="files[]" accept="video/*">');input.css({display:'none'});this.$el.append(input);input.click();input.change(function(e){_that.trigger('imageupload-onclick',e,this);$(this).remove();_that.close();});},onFileDragOver:function(e){e.stopPropagation();this.$el.find('.loaded-dropzone').fadeIn(200);},onFileDragOut:function(e){e.stopPropagation(e);this.$el.find('.loaded-dropzone').fadeOut(200);},onFileChoose:function(e){this.trigger('imageupload-ondrop',this.getDropProperties(e));this.close();},afterRender:function(){this.$el.find('.darkan-tabs').tabs();},getDropProperties:function(e){var imageUrl;var file=e.originalEvent.dataTransfer.files[0];var data;if(file!=undefined){var imageName=file.name;var imageData=e.originalEvent.dataTransfer.result;data={name:imageName,data:imageData,size:file.size};}else{imageUrl=e.originalEvent.dataTransfer.getData('text');}
return{file:file,data:data,imageUrl:imageUrl};},});;;var ExportWindowModel=WindowModel.extend({defaults:{type:"",modal:true,draggable:false}});;;var ExportWindowView=WindowView.extend({tagName:'div',className:'window window-export-view',template:_.template($('#window-export-template').html()),events:function(){return _.extend({},WindowView.prototype.events,{'click .window-close-button':'close','click .export-scorm':'exportToScorm','click .export-zip':'exportToHtml','click .export-pdf':'exportToPdf'});},afterInitialize:function(dataModel){var _that=this;this.getCapabilities();var exportWindowList=this.$el.find('.export-window-list');exportWindowList.hide();var skin=ProjectModel.instance.get('options').get('skin');DataAccess.preparePreview({skin:skin},function(data){_log('DONE')
exportWindowList.show();},function(data){_log('FAILED preparePreview',data);exportWindowList.show();});},onCapabilitiesChanged:function(capabilitiesModel){this.capabilitiesParmasList=capabilitiesModel.createParams([{name:'exporthtml5',identifier:'.export-zip'},{name:'exportpdf',identifier:'.export-pdf'},{name:'exportscorm',identifier:'.export-scorm'}]);var deleteEventsVisitor=DeleteEventsVisitor.getInstance();this.accept(deleteEventsVisitor);capabilitiesModel.off();},exportToScorm:function(){var scormExportWindow=WindowFactory.createExportScormWindow();$('body').append(scormExportWindow.render().$el);},exportToHtml:function(){var htmlExportWindow=WindowFactory.createExportHtml5Window();$('body').append(htmlExportWindow.render().$el);},exportToPdf:function(){var _that=this;var pdfExportWindow=WindowFactory.createExportPdfWindow();pdfExportWindow.on('on-close',function(){_that.close();});$('body').append(pdfExportWindow.render().$el);},});;;var ExportHtmlWindowView=WindowView.extend({tagName:'div',className:'window window-export-html5-view',template:_.template($('#window-export-html5-template').html()),events:function(){return _.extend({},WindowView.prototype.events,{'click .generate-package-button':'generateHtmlPackage','click .download-package-button':'startDownloading'});},generatingInProgress:false,downloadLink:undefined,generateHtmlPackage:function(){var _that=this;if(!this.generatingInProgress){this.generatingInProgress=true;this.$el.find('.generate-package-button').addClass('redbutton').attr({disabled:'disabled'}).text(_lang('EXPORT_GENERATE_PACKAGE_PROGRESS'));var request={type:'exportToHTML',projectID:__meta__.projectID,name:__meta__.projectName,skin:ProjectModel.instance.get('options').get('skin')};DataAccess.publicationRequest({request:JSON.stringify(request)},function(data){var dataJ=JSON.parse(data);_that.generatingCompleted(dataJ);},function(data){_log('data',data)});}},generatingCompleted:function(data){this.downloadLink=data.downloadLink;this.$el.find('.generate-package-button').removeAttr('disabled').removeClass('redbutton').addClass('download-package-button').text(_lang('BUTTON_DOWNLOAD'));},startDownloading:function(){window.open(this.downloadLink);}});;;var ExportScormWindowView=WindowView.extend({tagName:'div',className:'window window-export-scorm-view',template:_.template($('#window-export-scorm-template').html()),events:function(){return _.extend({},WindowView.prototype.events,{'click .generate-package-button':'generateScormPackage','click .download-package-button':'startDownloading'});},generatingInProgress:false,downloadLink:undefined,renderScoreEditor:function(){var publishScoreEditorView=EditorsFactory.createPublishScoreEditor();var optionsScoreSection=this.$el.find('.options-score-section');optionsScoreSection.html(publishScoreEditorView.render().$el);publishScoreEditorView.afterRender();},afterRender:function(){var projectName=ProjectModel.instance.get('options').get('name');this.$el.find('.package-name').val(projectName);this.renderScoreEditor();},generateScormPackage:function(){var _that=this;if(!this.generatingInProgress){this.generatingInProgress=true;this.$el.find('.package-name').attr({disabled:'disabled'});this.$el.find('.generate-package-button').addClass('redbutton').attr({disabled:'disabled'}).text(_lang('EXPORT_GENERATE_PACKAGE_PROGRESS'));var scormVersion=this.$el.find('.export-scorm-version').val();var request={type:'exportToScorm',projectID:__meta__.projectID,name:this.$el.find('.package-name').val(),title:this.$el.find('.package-name').val(),scormVersion:scormVersion,skin:ProjectModel.instance.get('options').get('skin')};DataAccess.publicationRequest({request:JSON.stringify(request)},function(data){var dataJ=JSON.parse(data);_that.generatingCompleted(dataJ);},function(data){_log('data',data)});}},generatingCompleted:function(data){this.downloadLink=data.downloadLink;this.$el.find('.generate-package-button').removeAttr('disabled').removeClass('redbutton').addClass('download-package-button').text(_lang('BUTTON_DOWNLOAD'));},startDownloading:function(){window.open(this.downloadLink);}});;;var ExportPdfItemWindowView=Backbone.View.extend({tagName:'li',className:'export-pdf-item-view',template:_.template($('#window-export-pdf-item-template').html()),bindings:{'.page-note':'note'},events:{'click .select-page':'clickSelectPage','click .page-note-checkbox':'clickCheckNote'},initialize:function(){this.model.viewPDF=this;this.model.viewPDF.selectPage(true);},clickCheckNote:function(e){var target=$(e.currentTarget);this.checkNotePage(target.is(':checked'));},clickSelectPage:function(e){var target=$(e.currentTarget);this.selectPage(target.is(':checked'));},selectPage:function(check){this.model.pdfSelected=check;this.$el.find('.select-page').prop('checked',check);},checkNotePage:function(check){this.model.pdfNoteSelected=check;this.$el.find('.page-note-checkbox').prop('checked',check);},render:function(){var pageTemplate=this.template(this.model.toJSON());this.$el.html(pageTemplate);this.stickit();return this;}});;;var ExportPdfListWindowView=Backbone.View.extend({tagName:'div',className:'export-pdf-list-wrapper-view',template:_.template($('#window-export-pdf-list-template').html()),render:function(){var projectList=this.template();this.$el.html(projectList);this.collection.each(this.renderSinglePage,this);return this;},renderSinglePage:function(pageModel){_log('renderPagesList pageModel',pageModel);var pageView=new ExportPdfItemWindowView({model:pageModel.get('options')});this.$el.find('.export-pdf-list').append(pageView.render().$el);var thumbPath=__meta__.projects_link+__meta__.ownerID+'/'+__meta__.projectID+'/pre/exported_view/'+pageModel.get('options').get('pageid')+'/pagethumb.jpg?r='+new Date().getUTCMilliseconds();pageView.$el.find('.pagethumb').css('background-image','url('+thumbPath+')');}});;;var ExportPdfWindowView=WindowView.extend({tagName:'div',className:'window window-export-pdf-view',template:_.template($('#window-export-pdf-template').html()),events:function(){return _.extend({},WindowView.prototype.events,{'click .clearmessages':'clearMessages','click .checkallinfo':'checkAllInfo','click .checkall':'checkAll','click .generate':'generatePDF'});},afterInitialize:function(dataModel){},generatePDF:function(){var landscape=this.$el.find('.checklandscape').prop('checked');var generatePdfProgressView=WindowFactory.createGeneratePdfProgressWindow({landscape:landscape});$('body').append(generatePdfProgressView.render().$el);this.close();},checkAll:function(e){var _that=this;var target=$(e.currentTarget);var checked=target.is(':checked');var pagesCollection=ProjectModel.instance.get('collection');pagesCollection.each(function(model){model.get('options').viewPDF.selectPage(checked);});},checkAllInfo:function(e){var _that=this;var target=$(e.currentTarget);var checked=target.is(':checked');var pagesCollection=ProjectModel.instance.get('collection');pagesCollection.each(function(model){model.get('options').viewPDF.checkNotePage(checked);});},clearMessages:function(){var pagesCollection=ProjectModel.instance.get('collection');pagesCollection.each(function(model){var options=model.get('options');options.set('note','');});this.renderPagesList();},afterRender:function(){var _that=this;var loader=this.createLoader();this.$el.find('.pdf-pages-list-wrapper').append(loader);_log('loader',loader);StageView.instance.createPageThumb(function(data){_log('_that',_that);_that.closeLoaderResult();_that.renderPagesList();});},renderPagesList:function(){var _that=this;var pagesCollection=ProjectModel.instance.get('collection');this.pagesList=new ExportPdfListWindowView({collection:pagesCollection});this.$el.find('.pdf-pages-list-wrapper').html(this.pagesList.render().$el);},onClose:function(){this.trigger('on-close');},createLoader:function(){var loader=$('<div>');loader.addClass('publication-loader-link');loader.append($('<img src="content_template/css/gif-load.gif">'));return loader;},closeLoaderResult:function(){var loader=this.$el.find('.publication-loader-link');loader.remove();},});;;var GeneratePdfProgressView=WindowView.extend({tagName:'div',className:'window generate-pdf-progress-window animated pulse',template:_.template($('#window-generate-pdf-progress-template').html()),events:function(){return _.extend({},WindowView.prototype.events,{'click .generate-pdf-progress-cancel':'generatePdfCancel','click .download-package-button':'downloadPDF'});},initialize:function(data){var _that=this;this.windowModel=data.windowModel;this.landscape=data.data.landscape;this.generatePdf();},downloadPDF:function(){window.open(this.downloadLink);},generatePdf:function(){var _that=this;var pagesCollection=ProjectModel.instance.get('collection');var dataPDF=[];pagesCollection.each(function(model){dataPDF.push({activePage:model.get('options').pdfSelected,pageID:model.get('options').get('pageid'),activeNote:model.get('options').pdfNoteSelected,note:model.get('options').get('note')});});var request={type:'exportToPDF',projectID:__meta__.projectID,dataPDF:dataPDF,landscape:this.landscape?'L':'P'};DataAccess.generatePdf({request:JSON.stringify(request)},function(data){_log('publicationRequest',data);_that.$el.removeClass('animated pulse');var dataJ=JSON.parse(data);_that.downloadLink=dataJ.downloadLink;var downloadButton=_that.createDownloadButton();_that.$el.find('.generate-pdf-progress-window-content').html(downloadButton);_that.$el.find('.generate-pdf-progress-cancel').val(_lang('EXPORTTOPDF_BUTTON_CLOSE'));},function(data){_that.$el.find('.generate-pdf-progress-cancel').val(_lang('EXPORTTOPDF_BUTTON_CLOSE'));});},createDownloadButton:function(){var downloadButton=$('<button class="generate-package-button editor-settings-button"></button>');downloadButton.removeAttr('disabled').removeClass('redbutton').addClass('download-package-button').text(_lang('BUTTON_DOWNLOAD'));return downloadButton;},onAddPageResult:function(pageModel,fileName,pdfPageId){},showProcessContent:function(index){},showFinishContent:function(){},onAddPageFault:function(responce){},generatePdfCancel:function(){this.close();},startUploading:function(){},onClose:function(){this.trigger('on-close');},showProgressPercent:function(data){},hideProgressPercent:function(data){}});;;var ImportWindowModel=WindowModel.extend({defaults:{type:"",modal:true,draggable:false}});;;var ImportWindowView=LoadedWindowView.extend({tagName:'div',className:'window window-import-view',template:_.template($('#window-import-template').html()),acceptTypeFormat:[],events:function(){return _.extend({},LoadedWindowView.prototype.events,{'close':'close','click .window-close-button':'close','click .import-images':'importImages','click .import-pdf':'importPdf','click .import-psd':'importPsdOnClick','click .import-psd a':'downloadPlugin','dragenter':'onFileDragOver','dragleave .loaded-dropzone':'onFileDragOut','drop .loaded-dropzone':'importPsdOnDrop',});},afterInitialize:function(){this.getCapabilities();},onCapabilitiesChanged:function(capabilitiesModel){this.capabilitiesParmasList=capabilitiesModel.createParams([{name:'importpdf',identifier:'.import-pdf'},{name:'importpsd',identifier:'.import-psd'}]);var deleteEventsVisitor=DeleteEventsVisitor.getInstance();this.accept(deleteEventsVisitor);capabilitiesModel.off();},importImages:function(){this.acceptTypeFormat=this.getExtensionImagesArray();this.uploadOnClick();},downloadPlugin:function(e){e.stopPropagation();},importPdf:function(){this.acceptTypeFormat=this.getExtensionPdfArray();this.uploadOnClick();},listenPsdConverter:function(){var _that=this;DataAccess.createPsdPage({},function(data){FileUploader.hideProgressPercent({},_that);ProjectView.instance.createPsdPage(data);_that.trigger('close-window');_that.close();},function(data){FileUploader.hideProgressPercent({},_that);_that.showPupup({content:_lang('PSD_FAILED'),title:_lang('MODAL_INFO_ERROR')},this);},function(data){FileUploader.hideProgressPercent({},_that);},function(data){var percent=Math.round((data.fileIndex / data.fileCount)*100);FileUploader.showProgressPercent({percent:percent},_that);});},importPsdOnClick:function(){var _that=this;this.listenPsdConverter();this.acceptTypeFormat=this.getExtensionPsdArray();this.uploadOnClick();},importPsdOnDrop:function(e){var _that=this;this.listenPsdConverter();this.acceptTypeFormat=this.getExtensionPsdArray();this.uploadOnFileDrop(e);},runUploadProcess:function(properties){var _that=this;if(this.windowModel.uploadingNow){return;}
var specialData=this.getSpecialProperties();var toSend=$.extend({},properties,specialData);this.fileUploader=ImportFileUploader.create(properties.data.name,this.windowModel,this);if(this.fileUploader==undefined){this.showPupup({content:_lang('FILETYPE_NOT_ACCEPTED'),title:_lang('MODAL_INFO_ERROR')},this);return;}
_log('this.fileUploader',this.fileUploader);this.fileUploader.sendFile(toSend);this.fileUploader.on('on-result',this.onResult,this);this.fileUploader.on('on-fault',this.onFault,this);this.fileUploader.on('on-complete',this.onComplete,this);this.fileUploader.on('on-complete-upload-image',this.onCompleteUploadImage,this);this.fileUploader.on('on-complete-upload-pdf',this.onCompleteUploadPdf,this);this.fileUploader.on('on-progress',this.onProgress,this);},onClosePopup:function(){},getAcceptTypeFormat:function(){var _mainTypes=this.acceptTypeFormat;var acceptTypeString='';_.each(_mainTypes,function(option){acceptTypeString+='.'+option+',';});return acceptTypeString;},getExtensionPdfArray:function(){return['pdf'];},getExtensionImagesArray:function(){return['jpg','png','gif'];},getExtensionPsdArray:function(){return['darkan'];},renderAfterComplete:function(data){},onCompleteUploadImage:function(){this.close();},onCompleteUploadPdf:function(data){var _that=this;var popup=PopupFactory.createCreatePdfDialogPopup({},{});popup.on('close-popup',function(){_that.close();});popup.on('ok-button-click',function(){var pdfListWindow=WindowFactory.createPdfListWindow({fileName:data.fileName});pdfListWindow.on('on-start-converting',function(){_that.trigger('close-window');_that.close();});pdfListWindow.on('window-close',function(){_that.trigger('close-window');_that.close();});pdfListWindow.on('close-parent-window',function(){_that.trigger('close-window');_that.close();});$('body').append(pdfListWindow.render().$el);});popup.on('cancel-button-click',function(){var addNewPageProgressWindow=WindowFactory.createAddNewPageProgressWindow({fileName:data.fileName});$('body').append(addNewPageProgressWindow.render().$el);_that.trigger('close-window');_that.close();});$('body').append(popup.render({title:_lang('PDF_POPUP_TITLE'),content:_lang('PDF_POPUP_CONTENT')}).$el);},onClose:function(){}});;;var NewPageItemModel=Backbone.Model.extend({defaults:{userId:'',projectId:'',pageId:'',name:'',map:''}});;;var NewPageItemCollection=Backbone.Collection.extend({model:NewPageItemModel});;;var NewpageWindowModel=WindowModel.extend({defaults:{type:"",modal:true,draggable:false}});;;var NewpageWindowView=WindowView.extend({tagName:'div',className:'window window-newpage-view',template:_.template($('#window-newpage-template').html()),events:function(){return _.extend({},WindowView.prototype.events,{'click .starting-page-add-blank':'addNewBlankPage','click .new-page-item-select':'selectItem','click .new-page-item-back':'back','click .new-page-item-add':'addPage','click .starting-page-import-psd':'addPsdPage','click .starting-page-import-pdf':'addPdfPage'});},initialize:function(data){this.windowModel=data.windowModel;this.runListeners();this.shareTemplateCollection=new NewPageItemCollection();this.templateCollection=new NewPageItemCollection();this.getTemplatesProjectsList();this.afterInitialize();},afterInitialize:function(){this.getCapabilities();},onCapabilitiesChanged:function(capabilitiesModel){this.capabilitiesParmasList=capabilitiesModel.createParams([{name:'importpdf',identifier:'.starting-page-import-pdf'},{name:'importpsd',identifier:'.starting-page-import-psd'}]);var deleteEventsVisitor=DeleteEventsVisitor.getInstance();this.accept(deleteEventsVisitor);capabilitiesModel.off();},afterRender:function(){this.$el.find('.starting-page-icon').tooltip({html:true,animated:'fade',placement:'top'});},back:function(){this.showTemplatesList();},addPage:function(e){var sender=$(e.currentTarget);var item=JSON.parse(sender.attr('item'));var userId=item.userId;var projectId=item.projectId;var pageId=item.pageId;ProjectView.instance.copyPagesFromOtherProject([pageId],userId,projectId);this.close();},selectItem:function(e){var sender=$(e.currentTarget);var item=JSON.parse(sender.attr('item'));var map=item.map;var detailsCollection=new NewPageItemCollection();var dataModel=this.windowModel.toJSON();dataModel.templateCollection=undefined;dataModel.shareTemplateCollection=undefined;if(map){var pages=map.pages;for(var i=0;i<pages.length;i++){this.createDetailTemplateList(item,i,detailsCollection);};}
dataModel.detailsCollection=detailsCollection.toJSON();this.render(dataModel);},getTemplatesProjectsList:function(){var _that=this;DataAccess.getTemplatesProjectsList({},function(responce){_that.createList(responce);},function(responce){_log('getTemplatesProjectsList fault',responce,_log.dataaccessOutFault);});},createList:function(data){var shareTemplateProjectData=data.shareTemplateProjectData;var templateProjectData=data.templateProjectData;_log('templateProjectData',templateProjectData,_log.timeline);this.createTemplateList(templateProjectData,this.templateCollection);this.createTemplateList(shareTemplateProjectData,this.shareTemplateCollection);this.showTemplatesList();},showTemplatesList:function(){var dataModel=this.windowModel.toJSON();dataModel.templateCollection=this.templateCollection.toJSON();dataModel.shareTemplateCollection=this.shareTemplateCollection.toJSON();dataModel.detailsCollection=undefined;this.render(dataModel);},showDetailsTemplatesList:function(){},createTemplateList:function(templates,collection){_log("Templates",templates);for(var i=0;i<templates.length;i++){var template=templates[i];var map=template.map;if(!map||map.pages.length<=0){continue;}
var userId=template.user_id;var projectId=template.project_id;var name=template.name;var pageId=map.pages!=undefined?map.pages[0]:0;if(pageId!=0){var r='?r='+new Date().getUTCMilliseconds();var src=__meta__.projects_link+userId+'/'+projectId+'/pre/exported_view/'+pageId+'/pagethumb.jpg'+r;var newPageItemModel=new NewPageItemModel({userId:userId,projectId:projectId,pageId:pageId,name:name,src:src,map:map});collection.add(newPageItemModel);}};},createDetailTemplateList:function(item,page,collection){var userId=item.userId;var projectId=item.projectId;var map=item.map;var name=item.name;var pageId=map.pages[parseInt(page)];var r='?r='+new Date().getUTCMilliseconds();var src=__meta__.projects_link+userId+'/'+projectId+'/pre/exported_view/'+pageId+'/pagethumb.jpg'+r;var newPageItemModel=new NewPageItemModel({userId:userId,projectId:projectId,pageId:pageId,name:name,src:src});collection.add(newPageItemModel);},addNewBlankPage:function(){this.trigger('add-new-blank-page');this.close();},addPsdPage:function(){this.trigger('add-new-psd-page');},addPdfPage:function(){this.trigger('add-new-pdf-page');},});;;var StartingNewpageWindowModel=WindowModel.extend({defaults:{type:"",modal:true,draggable:false}});;;var StartingNewpageWindowView=NewpageWindowView.extend({tagName:'div',className:'window window-starting-newpage-view',template:_.template($('#window-starting-newpage-template').html()),events:{'click .starting-page-add-blank':'addNewBlankPage','click .new-page-item-select':'selectItem','click .new-page-item-back':'back','click .new-page-item-add':'addPage','click .starting-page-import-psd':'addPsdPage','click .starting-page-import-pdf':'addPdfPage'},});;;var MailingWindowModel=WindowModel.extend({defaults:{type:"",modal:true,draggable:false}});;;var MailingWindowView=WindowView.extend({tagName:'div',className:'window window-mailing-view',template:_.template($('#window-mailing-template').html()),events:function(){return _.extend({},WindowView.prototype.events,{'click .banner-send':'startSendingMails','click .open-dstats':'openStatsPanel'});},openStatsPanel:function(){window.open('http://'+__meta__.serverLink+"/lms");},afterRender:function(){this.$el.find('.darkan-tabs').tabs();},initEditors:function(){this.usersToSendInput=this.$el.find('.banner-mailing-userstosend');this.usersToSendInput.val('');this.usersToSendInput.tagsInput({defaultText:_lang('BANNER_TAGSTEXT'),height:'auto',width:'auto'});var defaultEditorValue='<h2 style="font-style:italic">Witaj</h2><hr /><p>Poniej link do kursu.</p><p>&nbsp;</p><p><a href="http://{LINK}" style="float:right;-moz-border-radius:4px;-moz-box-shadow:0px 0px 2px #bababa, inset 0px 0px 1px #ffffff;-webkit-border-radius:4px;-webkit-box-shadow:0px 0px 2px #bababa, inset 0px 0px 1px #ffffff;background-image:linear-gradient(top, #3BA4C7 0% ,#1982A5 100%);background:#3BA4C7;border-radius:4px;border:solid 1px #004F72;box-shadow:0px 0px 2px #bababa, inset 0px 0px 1px #ffffff;color:#E5FFFF !important;filter:progid:DXImageTransform.Microsoft.gradient( startColorstr=&quot;#1982A5&quot;, endColorstr=&quot;#1982A5&quot;,GradientType=0 );font-weight:bold;font:18px Arial, Helvetica, sans-serif;padding:11px 32px;text-align:center;text-decoration:none;">Otw&oacute;rz</a></p>';this.$el.find('.banner-mailing-message').val(defaultEditorValue);this.mailingsEditor=CKEDITOR.replace(this.$el.find('.banner-mailing-message')[0]);},startSendingMails:function(){var _that=this;var dataForServer={request:1,mails:this.usersToSendInput.val().split(';|'),message:this.mailingsEditor.getData(),title:this.$el.find('.banner-mailing-title').val(),bannerID:this.model.get('id_banner')};this.showModal();DataAccess.sendMails({request:JSON.stringify(dataForServer)},function(data){_that.hideModal();},function(data){_log('data',data);});},showModal:function(){this.$el.find('.window-inner-modal').fadeIn(400);},hideModal:function(){this.$el.find('.window-inner-modal').fadeOut(400);},});;;var PublishedItemModel=Backbone.Model.extend({defaults:{},renderHide:function(){this.trigger('render-hide');},renderShow:function(){this.trigger('render-show');}});var PublishedItemsCollection=Backbone.Collection.extend({model:PublishedItemModel});;;var PublicationOptionsWindow=WindowView.extend({tagName:'div',className:'window window-view window-publication-options-template',template:_.template($('#window-publication-options-template').html()),initialize:function(data){this.model=data.projectModel;this.windowModel=new WindowModel();this.runListeners();this.listenTo(this.model,'change:fullscreen',this.saveToServer);this.listenTo(this.model,'change:reset_progress',this.saveToServer);this.listenTo(this.model,'change:share',this.saveToServer);this.listenTo(this.model,'change:zoom',this.saveToServer);},afterRender:function(){this.stickit();},events:function(){return _.extend({},WindowView.prototype.events,{});},bindings:{'.edit-fullscreen-checkbox':{observe:'fullscreen',onGet:function(checked){return checked?true:false;}},'.edit-reset-checkbox':{observe:'reset_progress',onGet:function(checked){return checked?true:false;}},'.edit-share-checkbox':{observe:'share',onGet:function(checked){return checked?true:false;}},'.edit-zoom-checkbox':{observe:'zoom',onGet:function(checked){return checked?true:false;}},},saveToServer:function(){DataAccess.setPublicationOptions(this.model.toJSON(),function(data){},function(data){_log('Publication data NOT updated!',data);});},onClose:function(){this.trigger('on-close');}});;;var PublicationSharingWindow=WindowView.extend({tagName:'div',className:'window window-view window-publication-sharing-template',template:_.template($('#window-publication-sharing-template').html()),fbButtonEnabled:true,initialize:function(data){this.model=data.projectModel;this.windowModel=new WindowModel();this.runListeners();},afterRender:function(){this.populateLinks();},events:function(){return _.extend({},WindowView.prototype.events,{'click .share-link-direct':'selectWholeText','click .share-link-portal':'selectWholeText','click .share-link-iframe':'selectWholeText','keydown .share-link-direct':'preventDefault','keydown .share-link-portal':'preventDefault','keydown .share-link-iframe':'preventDefault','click .fb-share':'openSharingWindowFB','click .gp-share':'openSharingWindowGP','click .twitter-share':'openSharingWindowTwitter','click .external-link-direct':'openPublicationDirect','click .external-link-portal':'openPublicationPortal'});},openPublicationDirect:function(){window.open(this.getDirectLink());},openPublicationPortal:function(){window.open(this.getPortalLink());},enableFbButton:function(){this.fbButtonEnabled=true;this.$el.find('.fb-share').removeAttr('disabled');this.$el.find('.fb-share').css({opacity:'1'});},disableFbButton:function(){this.fbButtonEnabled=false;this.$el.find('.fb-share').attr('disabled','disabled');this.$el.find('.fb-share').css({opacity:'.4'});},openSharingWindowFB:function(){var _that=this;if(this.fbButtonEnabled){this.disableFbButton();var picture=_that.model.get('thumb')!="none"?_that.model.get('thumb'):window.location.protocol+"//"+__meta__.serverLink+"/assets/img/logo_normal.png";$.post('https://graph.facebook.com',{id:_that.getFbDirectLink(),scrape:true},function(response){window.open("https://www.facebook.com/sharer/sharer.php?u="+
_that.getFbDirectLink(),"share_window",'toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=500,height=500');_that.enableFbButton();});}},openSharingWindowGP:function(){window.open('https://plus.google.com/share?url='+this.getPortalLink(),'menubar=no','toolbar=no','resizable=yes','scrollbars=yes','height=450',' width=550',' top='+($(window).height()/2-225)+'',' left='+$(window).width()/2);},openSharingWindowTwitter:function(){window.open('http://twitter.com/share?url='+this.getPortalLink()+'&text='+this.model.get('name')+'&','twitterwindow','height=450, width=550, top='+($(window).height()/2-225)+', left='+$(window).width()/2+', toolbar=0, location=0, menubar=0, directories=0, scrollbars=0');},preventDefault:function(e){if(e.ctrlKey&&e.keyCode==67){}else{e.preventDefault();return false;}},selectWholeText:function(e){var input=e.currentTarget;input.select();},populateLinks:function(){var _that=this;this.$el.find('.share-link-direct').val(_that.getDirectLink());this.$el.find('.share-link-portal').val(_that.getPortalLink());this.$el.find('.share-link-iframe').val(_that.getIframeCode());},getDirectLink:function(){return __meta__.content_link+this.model.get('path');},getFbDirectLink:function(){return __meta__.facebook_link+this.model.get('path');},getPortalLink:function(){return __meta__.content_subdomain_link+this.model.get('path');},getIframeCode:function(){return'<iframe webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen="" width="1000" height="800" src='+this.getDirectLink()+'></iframe>';},onClose:function(){this.trigger('on-close');}});;;var PublishWindowModel=WindowModel.extend({defaults:{type:"",modal:true,draggable:false}});;;var PublishProjectListView=Backbone.View.extend({template:_.template($('#publish-project-list-template').html()),initialize:function(){},events:{'sort-rows-back':'sortPublications','keyup .published-projects-search':'searchPublications'},searchPublications:function(e){var searchValue=$(e.currentTarget).val();this.collection.each(function(pModel){var name=pModel.get('name')||"";var summary=pModel.get('summary')||"";if(name.toLowerCase().indexOf(searchValue)!==-1||summary.toLowerCase().indexOf(searchValue)!==-1){pModel.renderShow();}else{pModel.renderHide();}});},render:function(){var _that=this;var projectList=this.template();this.$el.html(projectList);this.collection.each(this.addProjectItem,this);this.$el.find('.publish-project-list').sortable({handle:'.sortable-handle',stop:function(event,ui){ui.item.trigger('sort-rows',ui.item.index());}});return this;},sortPublications:function(event,model,position){this.collection.remove(model);this.collection.add(model,{at:position});this.collection.each(function(pModel,i){pModel.set('ord',i+1);});this.render();},addProjectItem:function(projectModel){var _that=this;var projectView=new PublishProjectItemView({model:projectModel});projectView.on('delete-publication',function(pModel){_that.deletePublication(pModel);});projectView.on('get-published-data',function(pModel){_that.trigger('get-published-data')});this.$el.find('.publish-project-list').append(projectView.render().$el);projectView.afterRender();}});;;var PublishProjectItemView=Backbone.View.extend({tagName:'li',className:'publish-project-item',template:_.template($('#publish-project-item-template').html()),fbButtonEnabled:true,events:{'sort-rows':'sortRows','click .project-visible':'changeVisibility','click .project-options':'showOptionsWindow','click .project-links':'showShareWindow','click .project-delete':'showDeleteConfirm','click .published-project-name':'editProjectName','click .published-project-description':'editProjectDescription','keyup .name-edit':'keyupCheck','keyup .description-edit':'keyupCheck','focusout .name-edit':'finishEditProjectName','focusout .description-edit':'finishEditProjectName','click .published-project-thumb-wrapper':'uploadOnFileClick','drop .loaded-dropzone':'uploadOnFileDrop','click .project-mailing':'openMailingWindow','click .open-in-new-tab':'openPublicationInNewTab','click .facebook-share':'openSharingWindowFB'},initialize:function(){this.model.on('render-hide',this.hide,this);this.model.on('render-show',this.show,this);this.listenTo(this.model,'change:ord',this.saveToServer);},onCapabilitiesChanged:function(){var capabilitiesModel=Capabilities.getInstance();this.capabilitiesParmasList=capabilitiesModel.createParams([{name:'publishfacebook',identifier:'.facebook-share'},{name:'mailing',identifier:'.project-mailing'},]);var deleteEventsVisitor=DeleteEventsVisitor.getInstance();this.accept(deleteEventsVisitor);capabilitiesModel.off();},accept:function(visitor){visitor.visit(this);},bindings:{'.name-value':'name','.name-edit':'name','.description-value':'summary','.description-edit':'summary'},openMailingWindow:function(){var bannerId=this.model.get('id_banner');var mailingLink=window.location.protocol+"//"+__meta__.serverLink+"darkanpanel#mailing/"+bannerId;window.open(mailingLink);},openSharingWindowFB:function(){var _that=this;if(this.fbButtonEnabled){this.disableFbButton();var picture=_that.model.get('thumb')!="none"?_that.model.get('thumb'):window.location.protocol+"//"+__meta__.serverLink+"/assets/img/logo_normal.png";window.open("https://www.facebook.com/sharer/sharer.php?u="+
_that.getFbDirectLink(),"share_window",'toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=500,height=500');_that.enableFbButton();}},enableFbButton:function(){this.fbButtonEnabled=true;this.$el.find('.facebook-share').removeAttr('disabled');this.$el.find('.facebook-share').css({opacity:'1'});},disableFbButton:function(){this.fbButtonEnabled=false;this.$el.find('.facebook-share').attr('disabled','disabled');this.$el.find('.facebook-share').css({opacity:'.4'});},getFbDirectLink:function(){return __meta__.facebook_link+this.model.get('path');},openPublicationInNewTab:function(){var link=__meta__.content_link+this.model.get('path');window.open(link);},renderImage:function(){this.renderPath();},renderPath:function(){var hash=this.model.get('path');_log('Publication Model',this.model);if(hash!=undefined&&hash!=""){var thumb=__meta__.publications_link+hash+'/thumb/thumb.png';this.$el.find('.published-project-thumb').css('background-image','url( '+thumb+' )');}},uploadOnFileDrop:function(e){this.$el.find('.loaded-dropzone').fadeOut(500);var properties=this.getDropProperties(e);this.runUploadProcess(properties);},uploadOnFileClick:function(e){var _that=this;var acceptTypeFormat=this.getAcceptTypeFormat();var input=$('<input type="file" name="files[]" accept="'+acceptTypeFormat+'">');input.css({display:'none'});this.$el.append(input);input.click();input.change(function(e){_that.uploadOnInputData(e,this,false);$(this).remove();});},getAcceptTypeFormat:function(){var _imageTypes=this.getExtensionArray();var acceptTypeString='';_.each(_imageTypes,function(option){acceptTypeString+='.'+option+',';});return acceptTypeString;},runUploadProcess:function(properties){if(this.model.uploadingNow){return;}
var specialData=this.getSpecialProperties();var toSend=$.extend({},properties,specialData);this.fileUploader=FileUploader.createPublishBannerIconLoader(properties.data.name,this.model,this);if(this.fileUploader==undefined){this.showPupup({message:"Extension file is no allowed"},this);return;}
this.fileUploader.sendFile(toSend);this.fileUploader.on('on-result',this.onResult,this);this.fileUploader.on('on-fault',this.onFault,this);this.fileUploader.on('on-complete',this.onComplete,this);this.fileUploader.on('on-progress',this.onProgress,this);},onResult:function(data){if(data.key==1){this.showPupup({message:'Extension file is no allowed'},this);return;}},onFault:function(data){this.showPupup(data,this);},onComplete:function(data){this.hideProgressPercent(data);this.fileUploader.off();this.fileUploader=undefined;},onProgress:function(data){this.showProgressPercent(data);},getSpecialProperties:function(){return{};},showProgressPercent:function(data){FileUploader.showProgressPercent(data,this);},hideProgressPercent:function(data){FileUploader.hideProgressPercent(data,this);},showPupup:function(data,sender){var popup=PopupFactory.createStandardPopup(data,sender);$('body').append(popup.render().$el);},getExtensionArray:function(){return['*'];},uploadOnInputData:function(e,input,resizeImage){var properties=this.getInputProperties(e,input);this.runUploadProcess(properties);},getDropProperties:function(e){return FileUploader.getDropProperties(e);},getInputProperties:function(e,input){return FileUploader.getInputProperties(e,input);},sortRows:function(event,position){this.$el.trigger('sort-rows-back',[this.model,position]);},keyupCheck:function(e){if(e.keyCode===27){this.finishEditProjectName();}},editProjectName:function(){this.$el.find('.name-value').hide();this.$el.find('.name-edit').show().focus();},finishEditProjectName:function(){this.$el.find('.name-value').show();this.$el.find('.name-edit').hide();this.$el.find('.description-value').show();this.$el.find('.description-edit').hide();this.saveToServer();},editProjectDescription:function(){this.$el.find('.description-value').hide();this.$el.find('.description-edit').show().focus();},changeVisibility:function(){var active=this.model.get('active');this.model.set('active',!active);this.renderVisibility();this.saveToServer();},saveToServer:function(){DataAccess.setPublicationOptions(this.model.toJSON(),function(data){},function(data){_log('Publication data NOT updated!',data,_log.dataaccessOutFault);});},hide:function(){this.$el.css({display:"none"});},show:function(){this.$el.css({display:"block"});},showOptionsWindow:function(e){var _that=this;if(this.optionsWindow==undefined){this.optionsWindow=new PublicationOptionsWindow({projectModel:this.model});this.optionsWindow.on('on-close',function(){_that.optionsWindow=undefined;});var dataToRender=this.model.toJSON();var windowPosition={left:e.pageX,top:e.pageY};$('body').append(this.optionsWindow.render(dataToRender).$el);this.optionsWindow.setWindowPosition(windowPosition);}},showShareWindow:function(e){var _that=this;if(this.sharingWindow==undefined){this.sharingWindow=new PublicationSharingWindow({projectModel:this.model});this.sharingWindow.on('on-close',function(){_that.sharingWindow=undefined;});var dataToRender=this.model.toJSON();var windowPosition={left:e.pageX,top:e.pageY};$('body').append(this.sharingWindow.render(dataToRender).$el);this.sharingWindow.setWindowPosition(windowPosition);}},showDeleteConfirm:function(){var _that=this;var popup=PopupFactory.createStandardPopup({});popup.on('ok-button-click',function(){_that.deletePublication(_that.model);});$('body').append(popup.render({title:_lang('BANNER_DELETE_MSG'),content:_lang('BANNER_DELETE_CONTENT')}).$el);},renderVisibility:function(){var active=this.model.get('active');if(active){this.$el.css({opacity:'1'});this.$el.find('.published-project-thumb').removeClass('notactive');this.$el.find('.published-project-options > .project-visible').attr({class:'project-visible publish-option visible'});}else{this.$el.css({opacity:'.2'});this.$el.find('.published-project-thumb').addClass('notactive');this.$el.find('.published-project-options > .project-visible').attr({class:'project-visible publish-option notvisible'})}},render:function(){var projectBlock=this.template(this.model.toJSON());this.$el.html(projectBlock);this.renderVisibility();this.renderPath();this.stickit();this.$el.find('.tooltip-ready').tooltip({html:true,animated:'fade',placement:'left'});return this;},afterRender:function(){this.onCapabilitiesChanged();},closeLoaderResult:function(){var loader=this.$el.find('.publication-loader-link');loader.html(_lang('DELETE_PUBLICATION_MASAGE_RESULT'));setTimeout(function(){loader.remove();},2500);},closeLoaderFault:function(){var loader=this.$el.find('.publication-loader-link');loader.html(_lang('DELETE_PUBLICATION_MASAGE_FAULT'));},createLoader:function(){var loader=$('<div>');loader.addClass('publication-loader-link');loader.html(_lang('DELETE_PUBLICATION_MASAGE'));return loader;},deletePublication:function(pModel){var _that=this;var img=this.createLoader();this.$el.append(img);var request={type:'deletePublication',bannerID:pModel.get('id_banner'),hash:pModel.get('path'),projectID:__meta__.projectID};DataAccess.publicationRequest({request:JSON.stringify(request)},function(data){_that.$el.hide(500,function(){});_that.closeLoaderResult();},function(data){_log('data',data);_that.closeLoaderFault();});},removeModelAndUpdateOrders:function(collection){collection.remove(this.model);collection.each(function(pModel,i){pModel.set('ord',i+1);});}});;;var PublishProjectItemToOverrideView=Backbone.View.extend({tagName:'li',className:'publish-project-item',template:_.template($('#publish-project-item-tooverride-template').html()),events:{'click .override-publication-button':'overridePublication'},initialize:function(data){this.model=data.model;this.publicationOptions=data.publicationOptions;},overridePublication:function(e){var _that=this;var loader=this.createLoader();this.$el.append(loader);var pModel=this.model;var request={type:'overwritePublication',bannerID:pModel.get('id_banner'),hash:pModel.get('path'),projectID:__meta__.projectID,skin:ProjectModel.instance.get('options').get('skin'),requirements:_that.getCourseCompletionRequirements(),title:this.publicationOptions.title,description:this.publicationOptions.description,zoom:this.publicationOptions.zoom,fullscreen:this.publicationOptions.fullscreen,share:this.publicationOptions.share,resetProgress:this.publicationOptions.resetProgress,joinSource:this.publicationOptions.joinSource,thumb:this.publicationOptions.thumb,questiondata:this.getQuestionsObject()};DataAccess.publicationRequest({request:JSON.stringify(request)},function(data){_that.closeLoaderResult();_that.trigger('override-publication-complete',_that.model);},function(data){_log('data',data);_that.closeLoaderFault();});},getQuestionsObject:function(){return ProjectModel.instance.getQuestionsObject();},getCourseCompletionRequirements:function(){var courseOptions=ProjectModel.instance.get('options');var requirements={pages:courseOptions.get('require_pages'),score:courseOptions.get('require_score'),scoreRequired:courseOptions.get('require_score_points'),scoreMax:courseOptions.get('max_points_number')}
return requirements;},render:function(){var projectBlock=this.template(this.model.toJSON());this.$el.html(projectBlock);return this;},closeLoaderResult:function(){var loader=this.$el.find('.publication-loader-link');loader.html(_lang('OVERRIDE_PUBLICATION_MASAGE_RESULT'));setTimeout(function(){loader.remove();},2500);},closeLoaderFault:function(){var loader=this.$el.find('.publication-loader-link');loader.html(_lang('OVERRIDE_PUBLICATION_MASAGE_FAULT'));},createLoader:function(){var loader=$('<div>');loader.addClass('publication-loader-link');loader.html(_lang('OVERRIDE_PUBLICATION_MASAGE'));return loader;},});;;var PublishWindowView=LoadedWindowView.extend({tagName:'div',className:'window window-publish-view',template:_.template($('#window-publish-template').html()),events:function(){return _.extend({},WindowView.prototype.events,{'close':'close','click .window-close-button':'close','click .publish-as-new':'newPublication','click .override.active':'overridePublication','change .banner-page-thumb-select':'changeThumbnailPreviewOnChange','dragenter':'onFileDragOver','dragleave .loaded-dropzone':'onFileDragOut','click .upload':'uploadOnClick','click .edit-project-icon-preview':'uploadOnClick','drop .loaded-dropzone':'uploadOnFileDrop',});},afterInitialize:function(dataModel){var _that=this;this.getCapabilities();StageView.instance.createPageThumb(function(data){if(data!=undefined){var pageID=parseInt(data.pageID);var selectedPageID=parseInt(_that.$el.find('.banner-page-thumb-select').val());if(pageID==selectedPageID){_that.renderImage();}}});},onCapabilitiesChanged:function(capabilitiesModel){this.capabilitiesParmasList=capabilitiesModel.createParams([{name:'adminPanel',identifier:'.open-lms-btn'},]);var deleteEventsVisitor=DeleteEventsVisitor.getInstance();this.accept(deleteEventsVisitor);capabilitiesModel.off();},getAcceptTypeFormat:function(){var _imageTypes=this.getExtensionArray();var acceptTypeString='';_.each(_imageTypes,function(option){acceptTypeString+='.'+option+',';});return acceptTypeString;},getExtensionArray:function(){return['*'];},runUploadProcess:function(properties){if(this.windowModel.uploadingNow){return;}
var specialData=this.getSpecialProperties();var toSend=$.extend({},properties,specialData);this.fileUploader=FileUploader.createPublishIconLoader(properties.data.name,this.windowModel,this);if(this.fileUploader==undefined){this.showPupup({message:"Extension file is no allowed"},this);return;}
this.fileUploader.sendFile(toSend);this.fileUploader.on('on-result',this.onResult,this);this.fileUploader.on('on-fault',this.onFault,this);this.fileUploader.on('on-complete',this.onComplete,this);this.fileUploader.on('on-progress',this.onProgress,this);},renderAfterComplete:function(){var thumb=this.windowModel.get('thumb');var projectModelOptions=ProjectModel.instance.get('options');projectModelOptions.set('thumb',thumb);this.renderImage();},renderImage:function(){this.renderPath();},renderPath:function(){var thumb=ProjectModel.instance.get('options').get('thumb').replace('projects','');thumb=__meta__.projects_link+thumb;var r=this.makeR();if(thumb!=undefined&&thumb!=""){this.$el.find('.edit-project-icon-preview').css('background-image','url('+thumb+'?r='+r+')');}},makeR:function(){return Math.floor((Math.random()*10000)+1);},renderScoreEditor:function(){var publishScoreEditorView=EditorsFactory.createPublishScoreEditor();var optionsScoreSection=this.$el.find('.options-score-section');optionsScoreSection.html(publishScoreEditorView.render().$el);publishScoreEditorView.afterRender();},afterRender:function(){var _that=this;this.checkIfThumbIsSelected();this.$el.find('.darkan-tabs').tabs();this.getPublishedData();this.renderPagesThumbsList();this.renderPath();this.renderScoreEditor();this.showThumbnail();setTimeout(function(){_that.$el.find('.edit-project-title-input').focus();},10);_log('getQuestionObject',this.getQuestionsObject());},checkIfThumbIsSelected:function(e){var projectModelOptions=ProjectModel.instance.get('options');if(projectModelOptions.get('thumb')==""){var pModel=ProjectModel.instance.get('collection').first();var pageId=pModel.get('options').get('pageid');this.changeThumbnailPreview(pageId);}},changeThumbnailPreviewOnChange:function(e){var selectedPageID=$(e.currentTarget).val();this.changeThumbnailPreview(selectedPageID);},changeThumbnailPreview:function(selectedPageID){var thumbLink=__meta__.projects_link+__meta__.ownerID+'/'+__meta__.projectID+'/pre/exported_view/'+selectedPageID+'/pagethumb.jpg';var thumbToModel='/projects/'+__meta__.ownerID+'/'+__meta__.projectID+'/pre/exported_view/'+selectedPageID+'/pagethumb.jpg';var projectModelOptions=ProjectModel.instance.get('options');projectModelOptions.set('thumb',thumbToModel);this.renderPath();},showThumbnail:function(){var projectModelOptions=ProjectModel.instance.get('options');if(projectModelOptions.get('thumb')===''){this.thumbnailSelect.trigger('change');}},renderPagesThumbsList:function(){var _that=this;this.thumbnailSelect=this.$el.find('.banner-page-thumb-select');this.thumbnailSelect.html("");var pageThumb=ProjectModel.instance.get('options').get('thumb');var peID='';if(pageThumb.indexOf('pagethumb.jpg')!==-1){var base=pageThumb.substring(pageThumb.lastIndexOf('/')+1);var root=pageThumb.substring(0,pageThumb.lastIndexOf('/'));peID=root.substring(root.lastIndexOf('/')+1);}else{var option=$('<option>',{value:0});option.text('---');_that.thumbnailSelect.append(option);}
ProjectModel.instance.get('collection').each(function(pModel,i){var option;if(peID!==''&&peID==pModel.get('options').get('pageid')){var option=$('<option>',{value:pModel.get('options').get('pageid'),selected:'selected'});}else{var option=$('<option>',{value:pModel.get('options').get('pageid')});}
option.text((i+1)+". "+pModel.get('options').get('pagename'));_that.thumbnailSelect.append(option);});},getPublicationOptions:function(){return{title:this.$el.find('.edit-project-title-input').val(),description:this.$el.find('.edit-project-desc-input').val(),zoom:this.$el.find('.edit-zoom-checkbox').is(':checked')?1:0,fullscreen:this.$el.find('.edit-fullscreen-checkbox').is(':checked')?1:0,share:this.$el.find('.edit-share-checkbox').is(':checked')?1:0,resetProgress:this.$el.find('.edit-reset-checkbox').is(':checked')?1:0,joinSource:this.$el.find('.edit-join-source').is(':checked')?1:0,thumb:ProjectModel.instance.get('options').get('thumb')}},overridePublication:function(){var _that=this;var projectID=__meta__.projectID;var publicationOptions=this.getPublicationOptions();var popup=PopupFactory.createOverrideExistingPublicationPopup({publication:_that.responseData.publication,publicationOptions:publicationOptions});popup.on('override-publication-complete',function(){_that.getPublishedData();});$('body').append(popup.render({title:_lang('POPUP_OVERRIDE_PUBLICATION_TITLE'),content:_lang('POPUP_OVERRIDE_PUBLICATION_MESSAGE')}).$el);},getCourseCompletionRequirements:function(){var courseOptions=ProjectModel.instance.get('options');var requirements={pages:courseOptions.get('require_pages'),score:courseOptions.get('require_score'),scoreRequired:courseOptions.get('require_score_points'),scoreMax:courseOptions.get('max_points_number')}
return requirements;},getQuestionsObject:function(){return ProjectModel.instance.getQuestionsObject();},newPublication:function(){var _that=this;var projectID=__meta__.projectID;var publicationOptions=this.getPublicationOptions();var request={type:'newPublication',projectID:projectID,title:publicationOptions.title,description:publicationOptions.description,zoom:publicationOptions.zoom,fullscreen:publicationOptions.fullscreen,share:publicationOptions.share,resetProgress:publicationOptions.resetProgress,joinSource:publicationOptions.joinSource,thumb:publicationOptions.thumb,skin:ProjectModel.instance.get('options').get('skin'),requirements:this.getCourseCompletionRequirements(),questiondata:this.getQuestionsObject()};if(publicationOptions.title.length>0){this.showModal();DataAccess.publicationRequest({request:JSON.stringify(request)},function(data){_that.hideModal();_log('ERROR',data);var returnData=JSON.parse(data);if(returnData.error){var errorPopup=PopupFactory.createErrorPopup();$('body').append(errorPopup.render({title:_lang('MODAL_INFO_ERROR'),content:_lang('PUBLICATION_LIMIT')}).$el);return;}
_that.getPublishedData();_that.$el.find('.darkan-tabs').tabs("option","active",1);_that.$el.find('#publish-window-list').animate({scrollTop:99999},{duration:1000,easing:'easeInOutQuart'});},function(data){_log('data',data);_that.hideModal();});}else{this.$el.find('.publish-window-new').scrollTop(0);this.$el.find('.edit-project-title-input').addClass('animated float error');this.$el.find('.edit-project-title-input').focus();clearTimeout(this.errorTimeout);this.errorTimeout=setTimeout(function(){_that.$el.find('.edit-project-title-input').removeClass('animated float error');},1000);}},showModal:function(){this.$el.find('.window-inner-modal').fadeIn(400);},hideModal:function(){this.$el.find('.window-inner-modal').fadeOut(400);},getPublishedData:function(){var _that=this;var projectID=__meta__.projectID;DataAccess.getPublishedData({projectID:projectID},function(data){if(data.publication.length){var lastPublication=data.publication[data.publication.length-1];_that.$el.find('.edit-project-title-input').val(lastPublication.name);_that.$el.find('.edit-project-desc-input').val(lastPublication.summary);_that.$el.find('.publish-button.override').addClass('active');}
_that.renderPublicationList(data.publicationsList);_that.responseData=data;},function(data){_log('data',data)});},renderPublicationList:function(list){var _that=this;var projectsCollection=new PublishedItemsCollection();_.each(list,function(project,index){project.id=index;var projectModel=new PublishedItemModel(project);projectsCollection.add(projectModel);});this.publishedProjectList=new PublishProjectListView({collection:projectsCollection});this.publishedProjectList.on('delete-publication',function(pModel){_that.deletePublication(pModel);});this.publishedProjectList.on('get-published-data',function(){_that.getPublishedData();});this.$el.find('#publish-window-list').html(this.publishedProjectList.render().$el);}});;;var LibraryWindowModel=WindowModel.extend({defaults:{type:"",modal:true,draggable:false}});;;var LibraryWindowView=WindowView.extend({tagName:'div',className:'window window-library-view',template:_.template($('#window-library-template').html()),activeTab:'#library-search',events:function(){return _.extend({},WindowView.prototype.events,{'click .window-close-button':'close','click .avatar-folder':'chooseFolder','click .avatar-item':'chooseImage','change .library-search-select':'chooseTag','mouseenter .avatar-folder':'avatarFolderMouseEnter','mouseenter .avatar-item':'avatarItemMouseEnter'});},avatarFolderMouseEnter:function(e){var target=$(e.currentTarget);var f1=target.attr('folder-lib');var f2=target.attr('folder-name');if(typeof libraryTags[f1]!=='undefined'&&typeof libraryTags[f1][f2]!=='undefined'){target.attr('data-original-title','Tags: '+libraryTags[f1][f2].tags);}},avatarItemMouseEnter:function(e){var target=$(e.currentTarget);var itemDir=target.attr('item-dir');var _itemDir=itemDir.split('/');if(typeof libraryInfo[_itemDir[0]]!=='undefined'&&typeof libraryInfo[_itemDir[0]][_itemDir[1]]!=='undefined'&&libraryInfo[_itemDir[0]][_itemDir[1]][_itemDir[2]]!=='undefined'){target.attr('data-original-title',libraryInfo[_itemDir[0]][_itemDir[1]][_itemDir[2]].pl);}},chooseTag:function(e){var _that=this;var searchString=$(e.currentTarget).val();var request={request:4,search:searchString};DataAccess.libraryRequest({request:JSON.stringify(request)},function(data){var dataJ=JSON.parse(data);var contener=_that.activeTab;if(contener==='#library-search'){contener='.library-search-content';}
_that.$el.find(contener).html(dataJ.html);},function(data){_log('data',data)});},chooseImage:function(e){var _that=this;var target=$(e.currentTarget);var itemDir=target.attr('item-dir');this.trigger('imagelibrary-onclick',{itemDir:itemDir},this);this.close();},chooseFolder:function(e){var _that=this;var target=$(e.currentTarget);var id=target.attr('folder-name');var fo=target.attr('folder-lib');var request={request:2,path1:fo,path2:id};DataAccess.libraryRequest({request:JSON.stringify(request)},function(data){var dataJ=JSON.parse(data);var contener=_that.activeTab;if(contener==='#library-search'){contener='.library-search-content';}
_that.$el.find(contener).html(dataJ.html);_that.$el.find('.avatar-item').tooltip({html:true,delay:100});},function(data){_log('data',data)});},afterRender:function(){var _that=this;this.$el.find('.library-search-select').chosen({width:'80%','margin-left':'10%'});this.$el.find('.darkan-tabs').tabs({event:'mousedown',active:0,activate:function(event,ui){library=ui.newPanel.selector;_that.activeTab=library;selector=library.replace('#','');if(path_id[selector]!=undefined){var request={request:1,path:path_id[selector]};DataAccess.libraryRequest({request:JSON.stringify(request)},function(data){var dataJ=JSON.parse(data);_that.$el.find(library).html(dataJ.html);_that.$el.find('.avatar-folder').tooltip({html:true,delay:100});},function(data){_log('data',data)});}}}).addClass('ui-tabs-vertical ui-helper-clearfix');}});;;var ProjectOptionsWindowModel=WindowModel.extend({defaults:{type:"",modal:true,draggable:false}});;;var ProjectOptionsWindowView=WindowView.extend({tagName:'div',className:'window window-projectoptions-view',template:_.template($('#window-projectoptions-template').html()),events:function(){return _.extend({},WindowView.prototype.events,{'click .window-close-button':'close'});},bindings:{'#move-grid':'move_grid','#copy-grid':'copy_grid','.image-quality':'image_quality','#show-titles':'show_titles','#draggable-snaptolerance':'draggable_snaptolerance','#show-help-title':'help_title','#sound-loop-val':'sound_loop','#sound-vol-val':'sound_vol','#orginal-images':'orginal_images','#convert-sound-to-ogg':'convert_sound_to_ogg','#enabletocbtn':'toc_enabled','#settings-project-width':'width','#settings-project-height':'height','#keep-rigid-dimensions-of-the-project':'keep_dimensions','#load-every-page-at-start':'load_every_page_at_start','#load-every-page-in-the-background':'load_every_page_in_the_background','#enable-auto-scale-project':'autoScale'},initialize:function(data){this.projectModel=ProjectModel.instance;var optionsModel=this.projectModel.get('options');this.model=optionsModel;this.windowModel=data.windowModel;this.runListeners();},runListeners:function(){this.model.off('option-changes-coming',this.onProjectOptionChangesComing,this);this.model.on('option-changes-coming',this.onProjectOptionChangesComing,this);},onProjectOptionChangesComing:function(projectOptions){this.unstickit();this.stickit();},beforeRender:function(){this.unstickit();},afterRender:function(){this.$el.find('.darkan-tabs').tabs();this.drawPagesWindow=new DrawPagesWindowView({el:this.$el.find('#projectoptions-drawpages')});this.stickit();}});;;var PageDrawModel=Backbone.Model.extend({defaults:{opts:{amountToDraw:0},pagesToDraw:[]}});var PageDrawCollection=Backbone.Collection.extend({model:PageDrawModel});;;var DrawPagesSinglePageView=Backbone.View.extend({tagName:'li',className:'drawpages-singlepage-wrapper',template:_.template($('#projectoptions-drawpages-singlepage-template').html()),initialize:function(data){var _that=this;this.active=false;this.model.on('drawpages-select',function(){_that.forceActive();});this.model.on('drawpages-deselect',function(){_that.forceDeactive();});},events:{'click':'renderActive'},forceActive:function(){this.active=true;this.$el.addClass('drawpages-selectedpage');this.trigger('select-page',this.model);},forceDeactive:function(){this.active=false;this.$el.removeClass('drawpages-selectedpage');this.trigger('deselect-page',this.model);},renderActive:function(){this.active=!this.active;if(this.active){this.$el.addClass('drawpages-selectedpage');this.trigger('select-page',this.model);}else{this.$el.removeClass('drawpages-selectedpage');this.trigger('deselect-page',this.model);}},render:function(){var pageBlock=this.template({options:this.model.get('options').toJSON(),order:this.model.collection.indexOf(this.model)});this.$el.html(pageBlock);return this;},});;;var DrawPagesSingleDrawView=Backbone.View.extend({tagName:'div',className:'singledraw',template:_.template($('#projectoptions-drawpages-singledraw-template').html()),selectedPages:[],initialize:function(data){},events:{'click .drawpages-singledraw-delete':'deleteDraw','change .drawpages-amounttodrawinput':'changeAmountToDraw','click .drawpages-deleteselectedfromdraw':'deleteSelectedPages'},deleteSelectedPages:function(){var pagesToDrawToSave=this.model.get('pagesToDraw');_.each(this.selectedPages,function(pageId){pagesToDrawToSave=_.without(pagesToDrawToSave,pageId);});this.model.set('pagesToDraw',pagesToDrawToSave);ProjectModel.instance.get('options').set('pagesDraws',this.model.collection.toJSON());this.saveToServer();this.selectedPages=[];this.$el.trigger('force-render');},changeAmountToDraw:function(e){var value=$(e.currentTarget).val();var maxValue=this.model.get('pagesToDraw').length;if(value>maxValue){value=maxValue;$(e.currentTarget).val(maxValue);}
var options=this.model.get('opts');options.amountToDraw=value;this.model.set('opts',options);this.saveToServer();},saveToServer:function(){ProjectModel.instance.get('options').trigger('change',ProjectModel.instance.get('options'));},deleteDraw:function(){var _that=this;var pagesDraws=this.model.collection;this.model.collection.remove(this.model);ProjectModel.instance.get('options').set('pagesDraws',pagesDraws.toJSON());this.saveToServer();this.$el.trigger('force-render');},render:function(){var _that=this;this.selectedPages=[];this.sortPagesByOrder();var pageDrawTemplate=this.template(this.model.toJSON());this.$el.html(pageDrawTemplate);_.each(this.model.get('pagesToDraw'),function(pageID){var pageModel=ProjectModel.instance.getPageModelByPageId(pageID);if(pageModel){_that.renderSinglePage(pageModel);}});this.makeDroppable();return this;},renderSinglePage:function(pageModel){var _that=this;var singlePageView=new DrawPagesSinglePageView({model:pageModel});this.$el.find('.drawpages-singledraw-list-ul').append(singlePageView.render().$el);singlePageView.on('select-page',function(dModel){var pageId=dModel.get('options').get('pageid');_that.selectedPages.push(pageId);});singlePageView.on('deselect-page',function(dModel){var pageId=dModel.get('options').get('pageid');_that.selectedPages.splice(_that.selectedPages.indexOf(pageId),1);});},makeDroppable:function(){var _that=this;this.$el.find('.drawpages-singledraw-list').droppable({tolerance:"pointer",drop:function(evt,droppableObject){_that.trigger('add-pages',_that.model);}});},sortPagesByOrder:function(){var pagesArray=this.model.get('pagesToDraw');var sortedIDByOrder=[];var idAndOrderPairs={};_.each(pagesArray,function(pageID){var pageModel=ProjectModel.instance.getPageModelByPageId(pageID);var pageOrder=ProjectModel.instance.get('collection').indexOf(pageModel);idAndOrderPairs[pageOrder]=pageID;});for(var pOrder in idAndOrderPairs){sortedIDByOrder.push(idAndOrderPairs[pOrder]);}
this.model.set('pagesToDraw',sortedIDByOrder);}});;;var DrawPagesWindowView=Backbone.View.extend({template:_.template($('#projectoptions-drawpages-template').html()),selectedPages:[],pagesViewsToSelect:[],initialize:function(data){var _that=this;var pageDraws=ProjectModel.instance.get('options').get('pagesDraws');this.drawsCollection=new PageDrawCollection();_.each(pageDraws,function(draw,i){_that.drawsCollection.add(new PageDrawModel(draw));});this.render();},events:{'click .drawpages-pages-list-selectall':'selectAllPages','click .drawpages-pages-list-deselectall':'deselectAllPages','click .drawpages-add-new-draw':'addNewDraw','force-render':'render'},saveToServer:function(){ProjectModel.instance.get('options').trigger('change',ProjectModel.instance.get('options'));},addNewDraw:function(){this.drawsCollection.add(new PageDrawModel());this.saveToServer();this.render();},selectAllPages:function(){_.each(this.pagesViewsToSelect,function(pageView){pageView.forceActive();})},deselectAllPages:function(){_.each(this.pagesViewsToSelect,function(pageView){pageView.forceDeactive();})},render:function(){var _that=this;this.selectedPages=[];this.pagesViewsToSelect=[];var pageDrawTemplate=this.template({draws:ProjectModel.instance.get('options').get('pagesDraws')});this.$el.html(pageDrawTemplate);this.drawsCollection.each(this.renderSingleDraw,this);ProjectModel.instance.get('collection').each(this.renderSinglePage,this);},renderSingleDraw:function(dModel){var _that=this;var singleDraw=new DrawPagesSingleDrawView({model:dModel});this.$el.find('.drawpages-draws-wrapper').append(singleDraw.render().$el);singleDraw.on('add-pages',function(dModel){var pagesToDraw=dModel.get('pagesToDraw');var concatArrays=pagesToDraw.concat(_that.selectedPages);var arrayToSave=_.uniq(concatArrays);dModel.set('pagesToDraw',arrayToSave);ProjectModel.instance.get('options').set('pagesDraws',_that.drawsCollection.toJSON());_that.saveToServer();_that.render();});},renderSinglePage:function(pModel){var _that=this;if(this.isPageAvailable(pModel)){var singlePageView=new DrawPagesSinglePageView({model:pModel});this.pagesViewsToSelect.push(singlePageView);var singlePageEl=singlePageView.render().$el;this.$el.find('.drawpages-pages-list').append(singlePageEl);singlePageView.on('select-page',function(dModel){var pageId=dModel.get('options').get('pageid');if(_that.selectedPages.indexOf(pageId)===-1){_that.selectedPages.push(pageId);}});singlePageView.on('deselect-page',function(dModel){var pageId=dModel.get('options').get('pageid');_that.selectedPages.splice(_that.selectedPages.indexOf(pageId),1);});this.makeDraggable(singlePageEl);}},isPageAvailable:function(pModel){var _that=this;var available=true;var pageID=pModel.get('options').get('pageid');this.drawsCollection.each(function(draw){if(draw.get('pagesToDraw').indexOf(pageID)!==-1){available=false;}});return available;},makeDraggable:function(singlePageEl){var _that=this;singlePageEl.draggable({zIndex:6000,delay:100,start:function(){if(_that.selectedPages.length===0){return false;}},helper:function(){var helperWrapper=$('<div>',{'class':'drawpages-draggablehelper'});helperWrapper.text(_lang('NUMBER_OF_PAGES')+': '+_that.selectedPages.length);return helperWrapper;}});}});;;var ShareWindowModel=WindowModel.extend({defaults:{type:"",modal:true,draggable:false}});;;var ShareWindowView=WindowView.extend({tagName:'div',className:'window window-share-view',template:_.template($('#window-share-template').html()),templateNoExistUser:_.template($('#window-share-noexsistuser-template').html()),events:function(){return _.extend({},WindowView.prototype.events,{'click .window-close-button':'close','click .submit-share-project':'shareProjectToUser','click .delete-sharing':'deleteSharedUser','click .submit-share-project-cancel':'close','keyup .user-email-share-project':'keyupCheck'});},keyupCheck:function(e){if(e.keyCode===13){this.shareProjectToUser();}},runListeners:function(){var _that=this;this.getSharedUsers(function(data){_that.render(data);});},getSharedUsers:function(callback){DataAccess.getSharedUsers({},function(data){var dataToRender={usersList:data.usersList,winType:'list'};callback(dataToRender);},function(data){_log('data',data)});},afterRender:function(){},validateEmail:function(email){var re=/^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;return re.test(email);},deleteSharedUser:function(e){var _that=this;var obj=$(e.target).parent();var exists=obj.attr('exists')==='1'?true:false;var id=obj.attr('id');DataAccess.deleteSharedUser({id:id,exists:exists},function(data){_that.getSharedUsers(function(dataToRender){_that.render(dataToRender)});},function(data){_log('data',data)});},shareProjectToNoExistsUser:function(userEmail,message){var _that=this;DataAccess.shareProjectToNoExistsUser({userEmail:userEmail,message:message},function(data){DataAccess.getSharedUsers({},function(data){_that.getSharedUsers(function(dataToRender){_that.render(dataToRender)});},function(data){_log('data',data)});},function(data){_log('data',data)});},shareProjectToUser:function(e){var _that=this;var userEmail=this.$el.find('.user-email-share-project').val();if(!this.validateEmail(userEmail)){var input=this.$el.find('.user-email-share-project');input.addClass('animated float error');input.focus();clearTimeout(this.errorTimeout);this.errorTimeout=setTimeout(function(){input.removeClass('animated float error');},1000);return;}
DataAccess.shareProjectToUser({email:userEmail,project:__meta__.projectID},function(data){_that.getSharedUsers(function(dataToRender){_that.render(dataToRender)});},function(data){_log('data',data)});}});;;var PreviewWindowModel=WindowModel.extend({defaults:{type:"",modal:true,draggable:false}});;;var PreviewWindowView=WindowView.extend({tagName:'div',className:'window window-preview-view',template:_.template($('#window-preview-template').html()),afterInitialize:function(){var capabilities=Capabilities.getInstance();capabilities.on('change',this.onCapabilitiesChanged,this);capabilities.getCapabilities();},onCapabilitiesChanged:function(capabilitiesModel){this.capabilitiesParmasList=capabilitiesModel.createParams([{name:'publish',identifier:'.banners'}]);var deleteEventsVisitor=DeleteEventsVisitor.getInstance();this.accept(deleteEventsVisitor);capabilitiesModel.off();},setModel:function(model){},events:function(){return _.extend({},WindowView.prototype.events,{'click .window-close-button':'close','click .banners':'openPublishWindow','click .openexportwindow':'openExportWindow','click .skin':'changeSkin'});},changeSkin:function(e){var dimentionsFolder=$(e.currentTarget).attr('dimensionsfolder');var skinName=$(e.currentTarget).attr('skinname');ProjectModel.instance.get('options').set('dimentions',dimentionsFolder);ProjectModel.instance.get('options').set('skin',skinName);ProjectModel.instance.saveProjectOptions(ProjectModel.instance.get('options'));this.showPreview();},showPreview:function(failedIterator){var _that=this;failedIterator=failedIterator||0;failedIterator++;var dimentions=ProjectModel.instance.get('options').get('dimentions');var skin=ProjectModel.instance.get('options').get('skin');var activePage=ProjectModel.instance.get('collection').indexOf(StageView.instance.model)+1;this.showPreviewProjectLoader();DataAccess.preparePreview({skin:skin},function(data){var viewContent=_that.$el.find('.view-content');viewContent.on('load',function(){_that.hidePreviewProjectLoader();});viewContent.css({'background-color':'black'}).attr({src:__meta__.projects_link+__meta__.ownerID+'/'+__meta__.projectID+'/pre/index.html?skin='+skin+'&p='+activePage});_that.$el.find('.linktoblankpreview a').attr({href:__meta__.projects_link+__meta__.ownerID+'/'+__meta__.projectID+'/pre/index.html?skin='+skin+'&p='+activePage});},function(data){_that.hidePreviewProjectLoader();_log('FAILED preparePreview',data);_log('failedIterator',failedIterator);if(failedIterator<=3){_that.showPreview(failedIterator);}},function(data){_log('preparePreviewProgress',data);});},afterRender:function(){if(State.isTestDrive()){this.$el.find('.banners').hide();}},openPublishWindow:function(){if(State.isTestDrive()){return;}
this.trigger('open-publish-window');},openExportWindow:function(){this.trigger('open-export-window');},showPreviewProjectLoader:function(){this.previewProjectLoader=PreloaderFactory.createPreviewProjectLoader();$('body').append(this.previewProjectLoader.render().$el);},hidePreviewProjectLoader:function(){if(this.previewProjectLoader){this.previewProjectLoader.remove();}}});;;var PhotopeaWindowModel=WindowModel.extend({defaults:{type:"",modal:false,draggable:false}});;;var PhotopeaWindowView=WindowView.extend({className:'window window-photopea-view',template:_.template($('#window-photopea-template').html()),events:function(){return _.extend({},WindowView.prototype.events,{'click .photopea-close':'close','click .photopea-save-image':'saveImage'});},afterInitialize:function(data){this.componentModel=data.data.componentModel;},saveToServer:function(){var _that=this;var photopeaIFrame=this.getPhotopeaIfarame();photopeaIFrame[0].contentWindow.postMessage('savetoserver','*');var request=this.getPhotopeaSaveRequest();_log('SavePhotopeaImage',request,_log.dataaccessIn);var loop=0;var interval=setInterval(function(){loop++;DataAccess.editPhotopeaImage({request:JSON.stringify(request)},function(data){_log('SavePhotopeaImage result',data,_log.dataaccessOutResult);if(_that.fileMD5!=data.md5){clearInterval(interval);_that.componentModel.view.onPhotopeaSaved();_that.close();}},function(data){_log('SavePhotopeaImage fault',data,_log.dataaccessOutFault);});if(loop==10){clearInterval(interval);}},1000);},openEditor:function(){var _that=this;var request=this.getPhotopeaOpenRequest();DataAccess.editPhotopeaImage({request:JSON.stringify(request)},function(data){_that.openPhotopeaInIframe(data);_log('EditPhotopeaImage result',data,_log.dataaccessOutResult);},function(data){_log('EditPhotopeaImage fault',data,_log.dataaccessOutFault);});},getPhotopeaIfarame:function(){return this.$el.find('iframe');},openPhotopeaInIframe:function(data){this.fileMD5=data.md5;var photopeaJson=this.getPhotopeaJson(data);var photopeaIFrame=this.getPhotopeaIfarame();var src='http://www.photopea.com?p='+JSON.stringify(photopeaJson);photopeaIFrame.attr('src',src);},afterRender:function(){this.openEditor();},getPhotopeaJson:function(data){var componentModel=this.componentModel;var stageView=StageView.instance;var imageFileName=componentModel.get('imageFileName');var actionkey=componentModel.get('actionkey');var pageId=stageView.model.get('options').get('pageid');var extt=imageFileName.split('.').pop().toLowerCase();var token=__meta__.APP_LINK+"projects/"+__meta__.ownerID+'/'+__meta__.projectID+'/pre/exported_view/'+pageId+'/images/'+actionkey+'/'+imageFileName;var photopeaJson={files:[token],server:{url:__meta__.APP_LINK+"server/php/photopea.php?t="+data.token,formats:[extt]}}
return photopeaJson;},getPhotopeaOpenRequest:function(){var componentModel=this.componentModel;var stageView=StageView.instance;var projectModel=ProjectModel.instance;var imageFileName=componentModel.get('imageFileName');var actionkey=componentModel.get('actionkey');var pageId=stageView.model.get('options').get('pageid');var request={request:1,project:__meta__.projectID,userID:__meta__.ownerID,page:pageId,actionkey:actionkey,filename:imageFileName}
return request;},getPhotopeaSaveRequest:function(){var componentModel=this.componentModel;var stageView=StageView.instance;var projectModel=ProjectModel.instance;var imageFileName=componentModel.get('imageFileName');var actionkey=componentModel.get('actionkey');var pageId=stageView.model.get('options').get('pageid');var request={request:2,project:__meta__.projectID,userID:__meta__.ownerID,page:pageId,actionkey:actionkey,filename:imageFileName}
return request;},saveImage:function(){this.saveToServer();},});;;var FunctionNotAvailableWindowModel=WindowModel.extend({defaults:{type:"",modal:true,draggable:false}});;;var FunctionNotAvailableWindowView=WindowView.extend({tagName:'div',className:'window function-not-avaiable-window',events:function(){return _.extend({},WindowView.prototype.events,{});},afterInitialize:function(){this.detectState();},detectState:function(){var state=State.getStateType();switch(state){case'normal':this.setNormalState();break;case'test-drive':this.setTestDriveState();break;default:this.setNormalState();break;}},setNormalState:function(){this.template=_.template($('#window-function-not-available-template').html());},setTestDriveState:function(){this.template=_.template($('#window-function-not-available-testdrive-template').html());},});;;var TriggerAnimationTypeModel=Backbone.Model.extend({defaults:{animationName:'none',animationPrettyName:'none',animationTime:1.3}});;;var TriggerOptsModel=Backbone.Model.extend({defaults:function(){return{animationType:new TriggerAnimationTypeModel(),delay:0,link:'',transition:{},notadded:true,keybord:{},video:{},style:{}}}});;;var TriggerInteractionOptsModel=Backbone.Model.extend({defaults:function(){return{keyboard:{}}}});;;var AnimationItemModel=Backbone.Model.extend({defaults:{name:'',value:''}});;;var AnimationItemCollection=Backbone.Collection.extend({model:AnimationItemModel});window._layout.animations={animIn:{flip:[{name:_lang('ANIMATION_flipInX'),value:'flipInX'},{name:_lang('ANIMATION_flipInY'),value:'flipInY'},{name:_lang('ANIMATION_pullUp'),value:'pullUp'},{name:_lang('ANIMATION_pullDown'),value:'pullDown'},],fade:[{name:_lang('ANIMATION_fadeInOpacityOnly'),value:'fadeInOpacityOnly'},{name:_lang('ANIMATION_fadeIn'),value:'fadeIn'},{name:_lang('ANIMATION_fadeInUp'),value:'fadeInUp'},{name:_lang('ANIMATION_fadeInDown'),value:'fadeInDown'},{name:_lang('ANIMATION_fadeInLeft'),value:'fadeInLeft'},{name:_lang('ANIMATION_fadeInRight'),value:'fadeInRight'},{name:_lang('ANIMATION_fadeInUpBig'),value:'fadeInUpBig'},{name:_lang('ANIMATION_fadeInDownBig'),value:'fadeInDownBig'},{name:_lang('ANIMATION_fadeInLeftBig'),value:'fadeInLeftBig'},{name:_lang('ANIMATION_fadeInRightBig'),value:'fadeInRightBig'},],bounce:[{name:_lang('ANIMATION_bounce'),value:'bounce'},{name:_lang('ANIMATION_bounceInDown'),value:'bounceInDown'},{name:_lang('ANIMATION_bounceInUp'),value:'bounceInUp'},{name:_lang('ANIMATION_bounceInLeft'),value:'bounceInLeft'},{name:_lang('ANIMATION_bounceInRight'),value:'bounceInRight'},],rotate:[{name:_lang('ANIMATION_rotateIn'),value:'rotateIn'},{name:_lang('ANIMATION_rotateInDownLeft'),value:'rotateInDownLeft'},{name:_lang('ANIMATION_rotateInDownRight'),value:'rotateInDownRight'},{name:_lang('ANIMATION_rotateInUpLeft'),value:'rotateInUpLeft'},{name:_lang('ANIMATION_rotateInUpRight'),value:'rotateInUpRight'},{name:_lang('ANIMATION_lightSpeedIn'),value:'lightSpeedIn'},{name:_lang('ANIMATION_rollIn'),value:'rollIn'}],door:[{name:_lang('ANIMATION_doorLeftPushIn'),value:'doorLeftPushIn'},{name:_lang('ANIMATION_doorLeftPullIn'),value:'doorLeftPullIn'},{name:_lang('ANIMATION_doorRightPushIn'),value:'doorRightPushIn'},{name:_lang('ANIMATION_doorRightPullIn'),value:'doorRightPullIn'},{name:_lang('ANIMATION_doorUpPushIn'),value:'doorUpPushIn'},{name:_lang('ANIMATION_doorUpPullIn'),value:'doorUpPullIn'},{name:_lang('ANIMATION_doorDownPushIn'),value:'doorDownPushIn'},{name:_lang('ANIMATION_doorDownPullIn'),value:'doorDownPullIn'},{name:_lang('ANIMATION_doorLeftPushBounceIn'),value:'doorLeftPushBounceIn'},{name:_lang('ANIMATION_doorLeftPullBounceIn'),value:'doorLeftPullBounceIn'},{name:_lang('ANIMATION_doorRightPushBounceIn'),value:'doorRightPushBounceIn'},{name:_lang('ANIMATION_doorRightPullBounceIn'),value:'doorRightPullBounceIn'},{name:_lang('ANIMATION_doorUpPushBounceIn'),value:'doorUpPushBounceIn'},{name:_lang('ANIMATION_doorUpPullBounceIn'),value:'doorUpPullBounceIn'},{name:_lang('ANIMATION_doorDownPushBounceIn'),value:'doorDownPushBounceIn'},{name:_lang('ANIMATION_doorDownPullBounceIn'),value:'doorDownPullBounceIn'}],etc:[{name:_lang('ANIMATION_stretchLeft'),value:'stretchLeft'},{name:_lang('ANIMATION_stretchRight'),value:'stretchRight'},{name:_lang('ANIMATION_slideExpandUp'),value:'slideExpandUp'},{name:_lang('ANIMATION_expandUp'),value:'expandUp'},{name:_lang('ANIMATION_expandOpen'),value:'expandOpen'},{name:_lang('ANIMATION_bigEntrance'),value:'bigEntrance'},{name:_lang('ANIMATION_hatch'),value:'hatch'}]},animOut:{fade:[{name:_lang('ANIMATION_fadeOut'),value:'fadeOut'},{name:_lang('ANIMATION_fadeOutUp'),value:'fadeOutUp'},{name:_lang('ANIMATION_fadeOutDown'),value:'fadeOutDown'},{name:_lang('ANIMATION_fadeOutLeft'),value:'fadeOutLeft'},{name:_lang('ANIMATION_fadeOutRight'),value:'fadeOutRight'},{name:_lang('ANIMATION_fadeOutUpBig'),value:'fadeOutUpBig'},{name:_lang('ANIMATION_fadeOutDownBig'),value:'fadeOutDownBig'},{name:_lang('ANIMATION_fadeOutLeftBig'),value:'fadeOutLeftBig'},{name:_lang('ANIMATION_fadeOutRightBig'),value:'fadeOutRightBig'}],bounce:[{name:_lang('ANIMATION_bounceOut'),value:'bounceOut'},{name:_lang('ANIMATION_bounceOutDown'),value:'bounceOutDown'},{name:_lang('ANIMATION_bounceOutUp'),value:'bounceOutUp'},{name:_lang('ANIMATION_bounceOutLeft'),value:'bounceOutLeft'},{name:_lang('ANIMATION_bounceOutRight'),value:'bounceOutRight'}],rotate:[{name:_lang('ANIMATION_rotateOut'),value:'rotateOut'},{name:_lang('ANIMATION_rotateOutDownLeft'),value:'rotateOutDownLeft'},{name:_lang('ANIMATION_rotateOutDownRight'),value:'rotateOutDownRight'},{name:_lang('ANIMATION_rotateOutUpLeft'),value:'rotateOutUpLeft'},{name:_lang('ANIMATION_rotateOutUpRight'),value:'rotateOutUpRight'}],door:[{name:_lang('ANIMATION_doorLeftPushOut'),value:'doorLeftPushOut'},{name:_lang('ANIMATION_doorLeftPullOut'),value:'doorLeftPullOut'},{name:_lang('ANIMATION_doorRightPushOut'),value:'doorRightPushOut'},{name:_lang('ANIMATION_doorRightPullOut'),value:'doorRightPullOut'},{name:_lang('ANIMATION_doorUpPushOut'),value:'doorUpPushOut'},{name:_lang('ANIMATION_doorUpPullOut'),value:'doorUpPullOut'},{name:_lang('ANIMATION_doorDownPushOut'),value:'doorDownPushOut'},{name:_lang('ANIMATION_doorDownPullOut'),value:'doorDownPullOut'},{name:_lang('ANIMATION_doorLeftPushBounceOut'),value:'doorLeftPushBounceOut'},{name:_lang('ANIMATION_doorLeftPullBounceOut'),value:'doorLeftPullBounceOut'},{name:_lang('ANIMATION_doorRightPushBounceOut'),value:'doorRightPushBounceOut'},{name:_lang('ANIMATION_doorRightPullBounceOut'),value:'doorRightPullBounceOut'},{name:_lang('ANIMATION_doorUpPushBounceOut'),value:'doorUpPushBounceOut'},{name:_lang('ANIMATION_doorUpPullBounceOut'),value:'doorUpPullBounceOut'},{name:_lang('ANIMATION_doorDownPushBounceOut'),value:'doorDownPushBounceOut'},{name:_lang('ANIMATION_doorDownPullBounceOut'),value:'doorDownPullBounceOut'}],etc:[{name:_lang('ANIMATION_lightSpeedOut'),value:'lightSpeedOut'},{name:_lang('ANIMATION_rollOut'),value:'rollOut'},{name:_lang('ANIMATION_hinge'),value:'hinge'}]},animOver:{etc:[{name:_lang('ANIMATION_pulse-grow'),value:'pulse-grow'},{name:_lang('ANIMATION_pulse-shrink'),value:'pulse-shrink'},{name:_lang('ANIMATION_push'),value:'push'},{name:_lang('ANIMATION_pop'),value:'pop'},{name:_lang('ANIMATION_rotate'),value:'rotate'},{name:_lang('ANIMATION_float'),value:'float'},{name:_lang('ANIMATION_sink'),value:'sink'},{name:_lang('ANIMATION_hover'),value:'hover'},{name:_lang('ANIMATION_hang'),value:'hang'},{name:_lang('ANIMATION_wobble-vertical'),value:'wobble-vertical'},{name:_lang('ANIMATION_wobble-horizontal'),value:'wobble-horizontal'},{name:_lang('ANIMATION_wobble-top'),value:'wobble-top'},{name:_lang('ANIMATION_wobble-bottom'),value:'wobble-bottom'}],shadow:[{name:_lang('ANIMATION_glow'),value:'glow'},{name:_lang('ANIMATION_box-shadow-outset'),value:'box-shadow-outset'},{name:_lang('ANIMATION_float-shadow'),value:'float-shadow'},{name:_lang('ANIMATION_hover-shadow'),value:'hover-shadow'},{name:_lang('ANIMATION_shadow-radial'),value:'shadow-radial'}],curl:[{name:_lang('ANIMATION_curl-top-left'),value:'curl-top-left'},{name:_lang('ANIMATION_curl-top-right'),value:'curl-top-right'},{name:_lang('ANIMATION_curl-bottom-right'),value:'curl-bottom-right'},{name:_lang('ANIMATION_curl-bottom-left'),value:'curl-bottom-left'}],bubble:[{name:_lang('ANIMATION_bubble-left'),value:'bubble-left'},{name:_lang('ANIMATION_bubble-top'),value:'bubble-top'},{name:_lang('ANIMATION_bubble-right'),value:'bubble-right'},{name:_lang('ANIMATION_bubble-bottom'),value:'bubble-bottom'},{name:_lang('ANIMATION_bubble-float-top'),value:'bubble-float-top'},{name:_lang('ANIMATION_bubble-float-right'),value:'bubble-float-right'},{name:_lang('ANIMATION_bubble-float-bottom'),value:'bubble-float-bottom'},{name:_lang('ANIMATION_bubble-float-left'),value:'bubble-float-left'}]},animEndless:{endless:[{name:_lang('ANIMATION_pulse'),value:'pulse'},{name:_lang('ANIMATION_floating'),value:'floating'},{name:_lang('ANIMATION_tossing'),value:'tossing'},{name:_lang('ANIMATION_bounce-endless'),value:'bounce-endless'},{name:_lang('ANIMATION_flash-endless'),value:'flash-endless'},{name:_lang('ANIMATION_shake-endless'),value:'shake-endless'},{name:_lang('ANIMATION_swing-endless'),value:'swing-endless'},{name:_lang('ANIMATION_tada-endless'),value:'tada-endless'},{name:_lang('ANIMATION_wobble-endless'),value:'wobble-endless'}]}};;var AnimationWindowModel=WindowModel.extend({defaults:{type:"",modal:false,draggable:true,animations:window._layout.animations}});;;var AnimationView=WindowView.extend({tagName:'div',className:'window animation-window',template:_.template($('#window-animation-template').html()),events:function(){return _.extend({},WindowView.prototype.events,{'click .animation-block':'addAnimation','mouseover .animation-block':'previewAnimation','mouseout .animation-block':'stopAnimation','change .animation-time':'changeAnimationTime','dblclick .animation-block':'close'});},initialize:function(data){this.windowModel=new AnimationWindowModel();this.runListeners();this.animtionData=data.animtionData;},stopAnimation:function(e){var componentsCollection=StageView.instance.selectedComponentsCollection;var clickedAnimation=$(e.target);var animationName=clickedAnimation.attr('value');var animationPrettyName=clickedAnimation.text();var animationTime=this.$el.find('.animation-time').val();componentsCollection.each(function(cModel){var oldStyle=cModel.view.$el.attr('style');cModel.view.$el.removeClass(animationName);cModel.view.$el.attr(oldStyle);});},previewAnimation:function(e){var componentsCollection=StageView.instance.selectedComponentsCollection;var clickedAnimation=$(e.target);var animationName=clickedAnimation.attr('value');var animationPrettyName=clickedAnimation.text();var animationTime=this.$el.find('.animation-time').val();componentsCollection.each(function(cModel){cModel.oldStyle=cModel.view.$el.attr('style');cModel.view.$el.addClass(animationName);cModel.view.$el.css("animation-duration",animationTime+"s");cModel.view.$el.css("-webkit-animation-duration",animationTime+"s");});},onClose:function(){this.trigger('on-close');},changeAnimationTime:function(){var animationData={animationName:this.animtionData.animationName,animationPrettyName:this.animtionData.animationPrettyName,animationTime:this.$el.find('.animation-time').val()};this.trigger('on-animation-selected',animationData);},addAnimation:function(e){this.stopAnimation(e);var clickedAnimation=$(e.target);var animationData={animationName:clickedAnimation.attr('value'),animationPrettyName:clickedAnimation.text(),animationTime:this.$el.find('.animation-time').val()};this.trigger('on-animation-selected',animationData);this.close();},afterRender:function(){var activeAnimation=this.$el.find('.animation-block[value="'+this.animtionData.animationName+'"]');activeAnimation.addClass('activeAnimation');this.$el.find('.animation-time').val(this.animtionData.animationTime);this.$el.find('.animation-block').tooltip({html:true,animated:'fade'});}});;;var BaizerWindowModel=WindowModel.extend({defaults:{type:"",modal:false,draggable:true,animations:window._layout.animations}});;;var BaizerWindowView=WindowView.extend({tagName:'div',className:'window baizer-window',template:_.template($('#window-baizer-template').html()),events:function(){return _.extend({},WindowView.prototype.events,{'click .animation-block':'addAnimation',});},initialize:function(data){this.windowModel=new BaizerWindowModel();this.runListeners();this.triggerItem=data.data.triggerItem;},setBaizer:function(triggerItem){var triggerItem=triggerItem;var ease=triggerItem.getSelectedEase();var value=ease;var handles=this.handles;var graph=this.graph;var canvas=this.canvas;var ctx=this.ctx;this.supportsTouch=('createTouch'in document);var time=this.time;var timeVal=this.timeVal;this.presetChange(value,handles,graph,canvas,ctx,time,timeVal);},presetChange:function(value,handles,graph,canvas,ctx,time,timeVal){var coordinates=value.split(','),cp1=handles[0],cp2=handles[1];cp1.x=coordinates[0]*graph.width;cp1.y=graph.y+graph.height-(coordinates[1]*graph.height);cp2.x=coordinates[2]*graph.width;cp2.y=graph.y+graph.height-(coordinates[3]*graph.height);this.updateDrawing(handles,graph,canvas,ctx,time,timeVal);},updateDrawing:function(handles,graph,canvas,ctx,time,timeVal){ctx.clearRect(0,0,canvas[0].width,canvas[0].height);graph.draw();var cp1=handles[0],cp2=handles[1];ctx.save();ctx.strokeStyle='#4C84D3';ctx.lineWidth=3;ctx.beginPath();ctx.moveTo(graph.x,graph.y+graph.height);ctx.bezierCurveTo(cp1.x,cp1.y,cp2.x,cp2.y,graph.width,graph.y);ctx.stroke();ctx.restore();ctx.strokeStyle='#f00';ctx.beginPath();ctx.moveTo(graph.x,graph.y+graph.height);ctx.lineTo(cp1.x,cp1.y);ctx.moveTo(graph.width,graph.y);ctx.lineTo(cp2.x,cp2.y);ctx.stroke();for(var i=0;i<handles.length;i++){handles[i].draw();}
var x1=(cp1.x / graph.width).toFixed(3),y1=((graph.height+graph.y-cp1.y)/ graph.height).toFixed(3),x2=(cp2.x / canvas[0].width).toFixed(3),y2=((graph.height+graph.y-cp2.y)/ graph.height).toFixed(3);this.points=''+x1+', '+y1+', '+x2+', '+y2+'';},addAnimation:function(e){this.close();},getOffSet:function(obj){var curleft=curtop=0;if(obj.offsetParent){do{curleft+=obj.offsetLeft;curtop+=obj.offsetTop;}
while(obj=obj.offsetParent);}
return{left:0,top:0};},getPos:function(event){var mouseX=event.offsetX-this.getOffSet(event.target).left,mouseY=event.offsetY-this.getOffSet(event.target).top;return{x:mouseX,y:mouseY};},onPress:function(event){var _that=this;var handles=this.handles;event.preventDefault();event.stopPropagation();var cursorEvent=this.supportsTouch?event.touches[0]:event;var mouseCoordinates=this.getPos(cursorEvent),x=mouseCoordinates.x,y=mouseCoordinates.y;for(var i=0;i<handles.length;i++){var current=handles[i],curLeft=current.left,curRight=current.right,curTop=current.top,curBottom=current.bottom;if(this.supportsTouch){curLeft-=20;curRight+=20;curTop-=20;curBottom+=20;}
if(x>=curLeft&&x<=curRight&&y>=curTop&&y<=curBottom){draggingObj=current;oldX=event.pageX;oldY=event.pageY;var baizerWrapper=this.$el.find('.baizer-wrapper');baizerWrapper.on('mouseup',function(e){_that.onRelease(e);});baizerWrapper.on('touchend',function(e){_that.touchEnd(e);});baizerWrapper.on('mousemove',function(e){_that.onMove(e);});baizerWrapper.on('touchmove',function(e){_that.touchMove(e);});document.body.style.cursor=this.canvas[0].style.cursor='move';}}},onMove:function(event){var cursorEvent=this.supportsTouch?event.touches[0]:event;var canvas=this.canvas[0];var graph=this.graph;var x=cursorEvent.offsetX-this.getOffSet(canvas).left,y=cursorEvent.offsetY-this.getOffSet(canvas).top;if(x>graph.width){x=graph.width;}
if(x<0){x=0;}
if(y>canvas.height){y=canvas.height;}
if(y<0){y=0;}
draggingObj.x=x;draggingObj.y=y;var handles=this.handles;var graph=this.graph;var canvas=this.canvas;var ctx=this.ctx;var time=this.time;var timeVal=this.timeVal;this.updateDrawing(handles,graph,canvas,ctx,time,timeVal);},touchMove:function(event){this.onMove(event);event.preventDefault();},onRelease:function(event){var _that=this;drag=false;this.canvas[0].style.cursor='pointer';document.body.style.cursor='default';var baizerWrapper=this.$el.find('.baizer-wrapper');baizerWrapper.off('mousemove');baizerWrapper.off('touchmove');baizerWrapper.off('mouseup');baizerWrapper.off('touchend');this.canvas[0].removeEventListener('mousedown');this.canvas[0].removeEventListener('touchstart');var triggerCustomGroup=this.triggerItem.$el.find('.trigger-easeing-type-select .trigger-custom-group');triggerCustomGroup.remove();var optgroup=$('<optgroup class="trigger-custom-group" label="custom">            <option value="'+this.points+'">custom</option>        </optgroup> ');var triggerEaseingInput=this.triggerItem.$el.find('.trigger-easeing-type-select');triggerEaseingInput.append(optgroup);triggerEaseingInput.val(this.points);var opts=this.triggerItem.model.get('opts');var transition=opts.get('transition')==undefined?{}:opts.get('transition');transition.ease=this.points;opts.set('transition',transition);this.triggerItem.model.set('opts',opts);this.triggerItem.saveChanges();},touchEnd:function(event){this.onRelease(event);event.preventDefault();},afterRender:function(){var _that=this;var time=15;var timeVal=500;this.time=time;this.timeVal=timeVal;var canvas=this.$el.find('canvas');var ctx=canvas[0].getContext('2d');canvas[0].addEventListener('mousedown',function(e){_that.onPress(e);},false);canvas[0].addEventListener('touchstart',function(e){_that.onPress(e);},false);this.canvas=canvas;this.ctx=ctx;function BezierHandle(x,y){this.x=x;this.y=y;this.width=12;this.height=12;}
BezierHandle.prototype={getSides:function(){this.left=this.x-(this.width / 2);this.right=this.left+this.width;this.top=this.y-(this.height / 2);this.bottom=this.top+this.height;},draw:function(){this.getSides();ctx.fillStyle="#222";ctx.fillRect(this.left,this.top,this.width,this.height);}};var handles=[new BezierHandle(50,280),new BezierHandle(150,180)];this.handles=handles;function Graph(){this.x=0;this.y=130;this.height=200;this.width=200;}
Graph.prototype={draw:function(){ctx.save();ctx.fillStyle="#fff";ctx.fillRect(this.x,this.y,this.width,this.height);ctx.strokeStyle='#666';ctx.lineWidth=1;ctx.strokeRect(this.x+0.5,this.y-0.5,this.width-1,this.height);ctx.restore();}};var graph=new Graph();this.graph=graph;this.setBaizer(this.triggerItem);},onClose:function(){this.trigger('on-close');}});;;var MainPageView=WindowView.extend({template:_.template($('#main-page-window-template').html()),className:'window main-page-window',afterRender:function(){}});;;var DataPickerModel=Backbone.Model.extend({defaults:{}});;;var DataPickerView=WindowView.extend({tagName:'div',className:'window data-picker animated',template:_.template($('#data-picker-template').html()),selectorTemplate:_.template($('#data-picker-selector-template').html()),selectorPositionTemplate:_.template($('#data-picker-selector-position-template').html()),events:{'click':'closeDataPicker','close':'closeDataPicker'},afterRender:function(){},initialize:function(data){var _that=this;this.windowModel=new DataPickerModel();this.setOptions(data);this.hoveredObject=null;this.onPicked=data.onPicked;this.setObserver(data);this.runObServer();this.addEvents();},setObserver:function(data){this.observer=StageView.instance;},setOptions:function(data){this.classSelector=this.getSelectorClass(data.picker);this.action=this.getPickedAction(data.picker);this.selectObjects(data.collection);},addEvents:function(){var _that=this;this.selector=$(this.selectorTemplate());this.selectorPosition=$(this.selectorPositionTemplate());this.selector.on('click',function(e){_that.onSelectorClick(e)});this.selectorPosition.on('click',function(e){_that.onSelectorPositionClick(e)});this.selector.on('mouseover',function(e){_that.onSelectorMouseOver(e)})
this.selector.on('mouseout',function(e){_that.onSelectorMouseOut(e)})
$('body').append(this.selector);$('body').append(this.selectorPosition);$('body').on('mouseover',function(e){_that.onMouseOver(e)});$('body').on('mousemove',function(e){_that.onMouseMove(e)});},onSelectorPositionClick:function(e){_log("onSelectorPositionClick",e);var stageView=StageView.instance;var offset=stageView.$el.offset()
var sx=parseInt(offset.left);var sy=parseInt(offset.top);var x=e.clientX-sx-12;var y=e.clientY-sy-11;var data={position:{x:x,y:y},e:e};this.trigger('data-picker-picked',data,this);if(this.onPicked!=undefined){this.onPicked(data);}
this.closeDataPicker();},onMouseMove:function(e){if(this.action=='point'){var stageView=StageView.instance;var offset=stageView.$el.offset()
var sx=parseInt(offset.left);var sy=parseInt(offset.top);var x=e.clientX-sx-12;var y=e.clientY-sy-11;this.selectorPosition.css({display:'block',left:(e.clientX-30)+"px",top:(e.clientY-30)+"px"});var position=('X: '+x+'px, Y: '+y+'px');this.selectorPosition.attr('position',position);}},runObServer:function(){var _that=this;this.observer.off('data-picker-picked');this.observer.on('data-picker-picked',function(componentModel){if(_that.objectsCollection!=undefined){componentModel.selectedByTrigger(true);}
_that.onDataPickerPicked(componentModel);});},selectObjects:function(objectsCollection){var _that=this;this.objectsCollection=objectsCollection;if(objectsCollection!=undefined){_.each(objectsCollection,function(key,value){var model=DataPickerView.findModel(key,_that.action);if(model!=undefined){if(model.selectedByTrigger!=undefined){model.selectedByTrigger(true);}}});}},unselectObjects:function(objectsCollection){var _that=this;var objectsCollection=this.objectsCollection;if(objectsCollection!=undefined){_.each(objectsCollection,function(key,value){var model=DataPickerView.findModel(key,_that.action);if(model!=undefined){if(model.selectedByTrigger!=undefined){model.selectedByTrigger(false);}}});}},getPickedAction:function(picker){if(picker==undefined){return'object';}else{return picker;}},getSelectorClass:function(picker){switch(picker){case'object':return'.component, .component-miniature, .timeline-item';break;case'line':return'.timelinerow, .timelinerow-classic';break;case'page':return'.page';break;case'exercise':return'.quiz-component-miniature, .quiz';break;case'timer':return'.timer-component-miniature, .timer-component';break;case'text':return'.text-component-miniature, .text-component';break;case'video':return'.video-component-miniature, .video-component';break;case'point':return'';break;default:return'.component, .component-miniature, .timeline-item';break;}},onDataPickerPicked:function(componentModel){this.trigger('data-picker-picked',componentModel);if(this.onPicked!=undefined){this.onPicked(componentModel);}},onMouseOver:function(e){var elementSearch=document.elementFromPoint(e.clientX,e.clientY);var selector=this.classSelector;var findedElement=null;if($(elementSearch).is(selector)){findedElement=$(elementSearch);}else{if($(elementSearch).parents(selector).is(selector)){findedElement=$(elementSearch).parents(selector);}}
if(findedElement!=null){_log('ZINDEX',findedElement.css('z-index'));var zIndex=!isNaN(findedElement.css('z-index'))?findedElement.css('z-index'):6001;zIndex=zIndex==0?6001:zIndex;this.selector.css({display:'block',left:findedElement.offset().left+"px",top:findedElement.offset().top+"px",width:findedElement.width()+"px",height:findedElement.height()+"px",'z-index':zIndex});this.hoveredObject=findedElement;}},onSelectorClick:function(e){var _that=this;if(this.hoveredObject!=null){_log('this.action',this.action);_log('this.hoveredObject',this.hoveredObject.trigger);this.hoveredObject.trigger('data-picker-unselected-by-miniature',{},this);this.hoveredObject.trigger('data-picker-picked-'+this.action,{},this);if(!e.shiftKey){this.closeDataPicker();}}},onSelectorMouseOver:function(e){if(this.hoveredObject!=null){this.hoveredObject.trigger('data-picker-selected-by-miniature',{},this);}},onSelectorMouseOut:function(e){if(this.hoveredObject!=null){this.hoveredObject.trigger('data-picker-unselected-by-miniature',{},this);}},closeDataPicker:function(){$('body').off('mouseover');$('body').off('mouseout');$('body').off('mousemove');this.selector.off('click');this.selector.off('mouseover');this.selector.off('mouseout');this.selector.remove();this.selectorPosition.off('click');this.selectorPosition.remove();this.unselectObjects();this.hoveredObject=null;this.trigger('data-picker-close');this.close();},makeDraggable:function(modal){}});DataPickerView.findComponentModel=function(actionkey){var stageView=StageView.instance;var componentModel=stageView.getComponentModelByActionkey(actionkey);return componentModel;}
DataPickerView.findRowModel=function(lineId){var stageView=StageView.instance;var rowModel=stageView.getRowModelByLineId(lineId);return rowModel;}
DataPickerView.findPageModel=function(pageId){var pageModel=ProjectModel.instance.getPageModelByPageId(pageId);return pageModel;}
DataPickerView.findModel=function(key,type){var model;if(type!=undefined){switch(type){case'object':return DataPickerView.findComponentModel(key);break;case'line':return DataPickerView.findRowModel(key);break;case'page':return DataPickerView.findPageModel(key);break;}}
model=DataPickerView.findComponentModel(key);if(model!=undefined){return model;}
model=DataPickerView.findRowModel(key);if(model!=undefined){return model;}
model=DataPickerView.findPageModel(key);if(model!=undefined){return model;}
return undefined};;var SimpleDataPickerView=DataPickerView.extend({getSelectorClass:function(picker){return'.wordsearch-cell';},getPickedAction:function(picker){return'cell';},setObserver:function(data){this.observer=data.componentView;},runObServer:function(){var _that=this;},onSelectorClick:function(e){var _that=this;if(this.hoveredObject!=null){_that.onDataPickerPicked(this.hoveredObject);if(!e.shiftKey){this.closeDataPicker();}}},selectObjects:function(objectsCollection){var _that=this;},unselectObjects:function(objectsCollection){var _that=this;}});;;var PasteComponentsItemModel=Backbone.Model.extend({defaults:{}});;;var PasteComponentsWindowModel=Backbone.Model.extend({defaults:{type:"",draggable:true,modal:true}});;;var PasteComponentsCollection=Backbone.Collection.extend({model:PasteComponentsItemModel});;;var PasteComponentsWindowView=WindowView.extend({tagName:'div',className:'window window-paste-components-view',template:_.template($('#window-paste-components-template').html()),events:function(){return _.extend({},WindowView.prototype.events,{});},onClose:function(){this.trigger('on-close',this,this);},afterRender:function(){var _that=this;this.$el.find('.darkan-tabs').tabs();DataAccess.getComponentsListToPaste({},function(data){_log('getComponentsListToPaste result: ',data,_log.dataaccessOutResult);var copyHash=data.copyHash;var cutHash=data.cutHash;var deleteHash=data.deleteHash;_that.addCopyItems(copyHash.list);_that.addCutItems(cutHash.list);_that.addDeleteItems(deleteHash.list);},function(data){_log('getComponentsListToPaste fault: ',data,_log.dataaccessOutFault);});},addCopyItems:function(list){if(_.isArray(list)){for(var i=list.length-1;i>=0;i--){var components=list[i];var pasteComponentsItemModel=new PasteComponentsItemModel({components:components,hashId:i,hashName:"copy"});var pasteComponentsItemView=new PasteComponentsItemView({model:pasteComponentsItemModel});pasteComponentsItemView.on('paste-components',this.pasteComponents,this);this.$el.find('.paste-components-copy-list').append(pasteComponentsItemView.render().$el);};}},addCutItems:function(list){if(_.isArray(list)){for(var i=list.length-1;i>=0;i--){var components=list[i];var pasteComponentsItemModel=new PasteComponentsItemModel({components:components,hashId:i,hashName:"cut"});var pasteComponentsItemView=new PasteComponentsItemView({model:pasteComponentsItemModel});pasteComponentsItemView.on('paste-components',this.pasteComponents,this);this.$el.find('.paste-components-cut-list').append(pasteComponentsItemView.render().$el);};}},addDeleteItems:function(list){if(_.isArray(list)){for(var i=list.length-1;i>=0;i--){var components=list[i];var pasteComponentsItemModel=new PasteComponentsItemModel({components:components,hashId:i,hashName:"delete"});var pasteComponentsItemView=new PasteComponentsItemView({model:pasteComponentsItemModel});pasteComponentsItemView.on('paste-components',this.pasteComponents,this);this.$el.find('.paste-components-delete-list').append(pasteComponentsItemView.render().$el);};}},pasteComponents:function(model){var hash={hashName:model.get('hashName'),hashId:model.get('hashId')}
this.trigger('paste-components',hash);this.close();}});;;var PasteComponentsItemView=Backbone.View.extend({tagName:"li",className:'paste-components-item',template:_.template($('#paste-components-item-template').html()),events:function(){return{'click':'pasteComponents',}},render:function(){var template=this.template(this.model.toJSON());this.$el.html(template);this.addItems();return this;},addItems:function(){var components=this.model.get('components');var hashName=this.model.get('hashName');var hashId=this.model.get('hashId');for(var i=0;i<components.length;i++){var component=components[i];var imageFileName=component.imageFileName;if(imageFileName&&imageFileName!=''){var imageFileName=component.imageFileName;var actionkey=component.actionkey;var userId=StageView.instance.model.ownerId
var projectId=StageView.instance.model.projectId;var pageId=StageView.instance.model.get('options').get('pageid');var r='?r='+new Date().getUTCMilliseconds();var path=__meta__.projects_link+userId+'/'+projectId+'/history/'+hashName+'/'+hashId+'/images/'+actionkey+'/'+imageFileName+r;var div=$('<div class="ex-object" componenttype="'+component.type+'"></div>');div.css({'background-image':'url(\''+path+'\')','background-repeat':'no-repeat','background-position':'50% 50%','background-size':'100% 100%'});this.$el.append(div);}else{var div=$('<div class="ex-object" componenttype="'+component.type+'"></div>');this.$el.append(div);}};},pasteComponents:function(){this.trigger('paste-components',this.model);}});;;var EditorConatinerWindowModel=Backbone.Model.extend({defaults:{type:"",draggable:true,modal:false,title:''}});;;var EditorConatinerWindowView=WindowView.extend({tagName:'div',className:'editor-container-window-view',template:_.template($('#window-editor-container-template').html()),events:function(){return _.extend({},WindowView.prototype.events,{});},afterInitialize:function(data){this.editorModel=data.data.editorModel;},appendEditor:function(model){var editorItemView=model.view;var tempModel=editorItemView.model;editorItemView.remove();editorItemView.model=tempModel;this.$el.find('.window-content').append(editorItemView.render().$el);editorItemView.afterRender();editorItemView.show();editorItemView.setStageModelToEditor(StageView.instance.model);setTimeout(function(){editorItemView.onWindowResize();},10);this.editorItemView=editorItemView;},onClose:function(){this.trigger('on-close',this,this.editorModel);},afterRender:function(){this.makeResizable();},makeResizable:function(){var _that=this;this.$el.resizable({handles:"n, e, s, w, nw, ne, sw, se",resize:function(e){if(_that.editorItemView){_that.editorItemView.onWindowResize(e);}}});},});;;var AddMultiComponentsWindowModel=Backbone.Model.extend({defaults:{type:"",draggable:true,modal:false,title:''}});;;var AddMultiComponentsWindowView=WindowView.extend({tagName:'div',className:'add-multi-components-window-view',template:_.template($('#window-add-multi-components-template').html()),events:function(){return _.extend({},WindowView.prototype.events,{'click .add-multi-components-ok-button':'addComponents'});},afterInitialize:function(data){},addComponents:function(e){var values=this.$el.find('.add-multi-components-input-values').val().split(', ');var width=parseFloat(this.$el.find('.component-width').val());var height=parseFloat(this.$el.find('.component-height').val());_log('values',values);_log('width',width);_log('height',height);if(!_.isArray(values)){return;}
if(!_.isNumber(width)){return;}
if(!_.isNumber(height)){return;}
this.trigger('add-multi-components',{values:values,width:width,height:height});this.close();},onClose:function(){},afterRender:function(){this.$el.find('.add-multi-components-input-values').focus();},makeResizable:function(){var _that=this;this.$el.resizable({handles:"n, e, s, w, nw, ne, sw, se",resize:function(e){}});},});;;var ContextMenuItemModel=Backbone.Model.extend({defaults:{componentName:'componentName',prettyName:'',action:'',className:'big-btn',subitems:[],title:'',disabled:false}});;;var ContextMenuItemCollection=Backbone.Collection.extend({model:ContextMenuItemModel});;;var ContextMenuItemView=Backbone.View.extend({tagName:"li",template:_.template($('#contextmenu-item-template').html()),events:{'click':'executeAction','mouseenter':'showSubitemMenu','mouseleave':'hideSubitemMenu'},executeAction:function(e){e.stopPropagation();if(this.model.get('disabled')){return;}
switch(this.model.get('componentName')){case'separator':return false;break;default:this.trigger('item-click',this.model,this);break;}},showSubitemMenu:function(e){this.$el.find('.context-menu-second-lvl').show();},hideSubitemMenu:function(e){var submenu=$(e.currentTarget).find('.context-menu-second-lvl');submenu.css({'top':'0px','left':'100%'});submenu.hide();},render:function(){var _that=this;var menuItemTemplate=this.template(this.model.toJSON());this.$el.html(menuItemTemplate);if(this.model.get('subitems').length>0){this.model.get('subitems').each(function(model){_that.addSubMenuItem(model,_that);});}
this.$el.find('[title]').tooltip({html:true,animated:'fade',placement:'right',width:300,height:200});if(this.model.get('disabled')){this.$el.attr('disabled','disabled');}
if(this.model.get('componentName')=='extend'){this.$el.addClass('extend');}
this.$el.addClass(this.model.get('className'));return this;},addSubMenuItem:function(submenuItem,view){var _that=this;var menuSubItemView=new ContextMenuSubItemView({model:submenuItem});menuSubItemView.on('item-click',function(model){_that.trigger('menu-item-click',model);});view.$el.find('.context-menu-second-lvl').append(menuSubItemView.render().el);menuSubItemView.$el.find('[title]').tooltip({html:true,animated:'fade',placement:'right',width:300,height:200});if(submenuItem.get('disabled')){menuSubItemView.$el.attr('disabled','disabled');}
if(submenuItem.get('componentName')=='extend'){menuSubItemView.$el.addClass('extend');}
menuSubItemView.$el.addClass(submenuItem.get('className'));if(submenuItem.get('subitems').length>0){submenuItem.get('subitems').each(function(model){_that.addSubMenuItem(model,menuSubItemView);});}},showSingleExtendedMenu:function(menu){if(!menu.length)return;menu.css({top:'0px',left:'100%'});menu.show();var offsetTop=$(window).height()-(menu.height()+menu.offset().top);if(offsetTop<20){var marginTop=Math.abs(offsetTop)+20;menu.css({'top':"-"+marginTop+"px"});}else{menu.css({'top':'-10px'});}
var offsetLeft=$(window).width()-(menu.width()+menu.offset().left);var leftOffset=menu.width();if(offsetLeft<5){var marginLeft=Math.abs(offsetLeft)+20;menu.css({'left':"-"+leftOffset+"px"});}else{menu.css({'left':'100%'});}}});;;var ContextMenuSubItemView=Backbone.View.extend({tagName:"li",template:_.template($('#contextmenu-item-template').html()),events:{'click':'executeAction','mouseenter':'showSubitemMenu','mouseleave':'hideSubitemMenu'},render:function(){var menuSubItemTemplate=this.template(this.model.toJSON());this.$el.html(menuSubItemTemplate);if(this.model.get('disabled')){this.$el.attr('disabled','disabled');}
this.$el.find('.context-menu-second-lvl').hide();return this;},executeAction:function(e){e.stopPropagation();if(this.model.get('disabled')){return;}
this.trigger('item-click',this.model,this);},hideAllExtendedMenus:function(){this.$el.find('.active').removeClass('active');this.$el.find('.menu-left-second-lvl').hide();},showSubitemMenu:function(e){this.$el.find('.context-menu-second-lvl').show();},hideSubitemMenu:function(e){var submenu=$(e.currentTarget).find('.context-menu-second-lvl');submenu.css({'top':'0px','left':'100%'});submenu.hide();},});;;var ContextMenuView=WindowView.extend({className:'context-menu',template:_.template($('#context-menu-template').html()),events:{'close':'close'},initialize:function(data){this.windowModel=new WindowModel;this.view=data.view;this.model=data.model;this.e=data.e;this.runListeners();this.collection=this.createMenuCollection();},addMenuItem:function(menuItem){var _that=this;var menuItemView=new ContextMenuItemView({model:menuItem});menuItemView.on('item-click',function(model){_that.onItemClick(model);});menuItemView.on('menu-item-click',function(model){_that.onItemClick(model);});this.$el.append(menuItemView.render().el);},afterRender:function(){this.collection.each(this.addMenuItem,this);},onItemClick:function(model){},makeContextAction:function(e){},setWindowPosition:function(position){var documentWidth=$(window).width()
var documentHeight=$(window).height();var width=this.$el.width();var height=this.$el.height();var left=position.left;var top=position.top;if(left+width>documentWidth)
left=left-width;if(top+height>documentHeight)
top=top-height;if(left<0)
left=0;if(top<0)
top=0;this.$el.css({top:top+'px',left:left+'px'});},createMenuCollection:function(){var contextMenuItemCollection=new ContextMenuItemCollection([new ContextMenuItemModel()]);return contextMenuItemCollection;}});;;var ComponentContextMenuView=ContextMenuView.extend({template:_.template($('#component-context-menu-template').html()),onItemClick:function(model){_log('model',model);var action=model.get('action');switch(action){case'copy':StageView.instance.copyComponents();break;case'cut':StageView.instance.cutComponents();break;case'remove':StageView.instance.deleteActiveComponent();break;case'hide':StageView.instance.hideComponents();break;case'show':StageView.instance.showComponents();break;case'copy-trigger':StageView.instance.copyTrigger();break;case'paste-trigger':StageView.instance.pasteTrigger();break;case'copy-position':StageView.instance.copyPosition();break;case'paste-position':StageView.instance.pastePosition();break;case'copy-dimension':StageView.instance.copyDimension();break;case'paste-dimension':StageView.instance.pasteDimension();break;case'copy-style':StageView.instance.copyStyle();break;case'paste-style':StageView.instance.pasteStyle();break;case'move-components-to-new-line':StageView.instance.moveSelectedComponentsToNewLine();break;case'copy-components-to-new-line':StageView.instance.copySelectedComponentsToNewLine();break;case'flip-x':this.flipX();break;case'flip-y':this.flipY();break;case'convert':var type=model.get('componentName');var cModel=StageView.instance.selectedComponentsCollection.first();cModel.set('type',type,{silent:true});var dModel=StageView.instance.getComponentModelByActionkey(cModel.get('actionkey'));var newComponentModel=ComponentFactory.createComponentModelByType(type,dModel.toJSON());var selectedRow=StageView.instance.replaceComponentModel(dModel,newComponentModel);cModel.view.remove();var componentView=StageView.instance.renderSingleComponent(newComponentModel);selectedRow.view.render();selectedRow.view.afterRender();var eModel=StageView.instance.getComponentModelByActionkey(cModel.get('actionkey'));StageView.instance.renderZIndex();StageView.instance.selectOneComponent(eModel);newComponentModel.trigger('change');break;case'border':this.view.addBorder();break;case'clean-actions-clipboard':StageView.instance.cleanActionsClipboard();break;case'paste-one-trigger':var componentName=model.get('componentName');var trigger=StageView.instance.clipboardActions[componentName];if(trigger){StageView.instance.pasteTrigger([trigger]);}
break;}
this.specificAction(action);this.close();},checkIfModelIsHidden:function(){return this.model.get('hidden');},getPasteActionsTriggerName:function(trigger){var s='';s+=_lang('TRIGGER_LIST_'+trigger.whendoit)+': ';var subtriggers=trigger.subtriggers;for(var j=0;j<subtriggers.length;j++){var whattodo=subtriggers[j].whattodo;s+=_lang('TRIGGER_LIST_'+whattodo);if(j<subtriggers.length-1){s+=', '}};return s;},createPasteActionsSubitems:function(){var _that=this;var subitems=new ContextMenuItemCollection();var clipboardActions=StageView.instance.clipboardActions;for(var i=0;i<clipboardActions.length;i++){var trigger=clipboardActions[i];var contextMenuItemModel=new ContextMenuItemModel({componentName:i,action:'paste-one-trigger',prettyName:_that.getPasteActionsTriggerName(trigger),icon:'text',className:'big-btn'});subitems.add(contextMenuItemModel);};return subitems;},createMenuCollection:function(){var _that=this;var contextMenuItemCollection=new ContextMenuItemCollection([new ContextMenuItemModel({componentName:'copy',action:'copy',prettyName:_lang('CONTEXT_MENU_COPY'),icon:'text',className:'big-btn'}),new ContextMenuItemModel({componentName:'cut',action:'cut',prettyName:_lang('CONTEXT_MENU_CUT'),icon:'text',className:'big-btn'}),new ContextMenuItemModel({componentName:'hide-or-show',action:this.checkIfModelIsHidden()?'show':'hide',prettyName:this.checkIfModelIsHidden()?_lang('CONTEXT_MENU_SHOW'):_lang('CONTEXT_MENU_HIDE'),icon:'text',className:'big-btn'}),new ContextMenuItemModel({componentName:'remove',action:'remove',prettyName:_lang('CONTEXT_MENU_REMOVE'),icon:'text',className:'big-btn'}),new ContextMenuItemModel({componentName:'border',action:'border',prettyName:_lang('CONTEXT_MENU_BORDER'),icon:'text',className:'big-btn'}),new LeftMenuItemModel({componentName:'separator',className:'separator'}),new ContextMenuItemModel({componentName:'extend',prettyName:_lang('TRIGGER'),icon:'text',className:'big-btn extend',subitems:new ContextMenuItemCollection([new ContextMenuItemModel({componentName:'copy-trigger',action:'copy-trigger',prettyName:_lang('CONTEXT_MENU_COPY_COMPONENT_ACTIONS'),icon:'text',className:'big-btn'}),new ContextMenuItemModel({componentName:'clean-actions-clipboard',action:'clean-actions-clipboard',prettyName:_lang('CONTEXT_MENU_CLEAN_ACTIONS_CLIPBOARD'),icon:'text',className:'big-btn',disabled:StageView.instance.clipboardActions.length==0?true:false}),new ContextMenuItemModel({componentName:'extend',action:'paste-trigger',prettyName:_lang('CONTEXT_MENU_PASTE_COMPONENT_ACTIONS'),icon:'text',className:'big-btn extend',disabled:StageView.instance.clipboardActions.length==0?true:false,subitems:_that.createPasteActionsSubitems()}),]),}),new ContextMenuItemModel({componentName:'extend',prettyName:_lang('POSITION'),icon:'text',className:'big-btn extend',subitems:new ContextMenuItemCollection([new ContextMenuItemModel({componentName:'copy-position',action:'copy-position',prettyName:_lang('CONTEXT_MENU_COPY_POSITION'),icon:'text',className:'big-btn'}),new ContextMenuItemModel({componentName:'paste-position',action:'paste-position',prettyName:_lang('CONTEXT_MENU_PASTE_POSITION'),icon:'text',className:'big-btn',disabled:StageView.instance.copiedComponentPosition.length==0?true:false}),]),}),new ContextMenuItemModel({componentName:'extend',prettyName:_lang('AUTH_PROJECT_DIMENTIONS'),icon:'text',className:'big-btn extend',subitems:new ContextMenuItemCollection([new ContextMenuItemModel({componentName:'copy-dimension',action:'copy-dimension',prettyName:_lang('CONTEXT_MENU_COPY_DIMENSION'),icon:'text',className:'big-btn'}),new ContextMenuItemModel({componentName:'paste-dimension',action:'paste-dimension',prettyName:_lang('CONTEXT_MENU_PASTE_DIMENSION'),icon:'text',className:'big-btn',disabled:StageView.instance.copiedComponentDimensions.length==0?true:false})]),}),new ContextMenuItemModel({componentName:'extend',prettyName:_lang('MENU_TOPSTYLES'),icon:'text',className:'big-btn extend',subitems:new ContextMenuItemCollection([new ContextMenuItemModel({componentName:'copy-style',action:'copy-style',prettyName:_lang('CONTEXT_MENU_COPY_STYLE'),icon:'text',className:'big-btn'}),new ContextMenuItemModel({componentName:'paste-style',action:'paste-style',prettyName:_lang('CONTEXT_MENU_PASTE_STYLE'),icon:'text',className:'big-btn'}),]),}),new ContextMenuItemModel({componentName:'extend',prettyName:_lang('MENU_FLIP'),icon:'text',className:'big-btn extend',subitems:new ContextMenuItemCollection([new ContextMenuItemModel({componentName:'flip-x',action:'flip-x',prettyName:_lang('CONTEXT_MENU_FLIP_X'),icon:'text',className:'big-btn'}),new ContextMenuItemModel({componentName:'flip-y',action:'flip-y',prettyName:_lang('CONTEXT_MENU_FLIP_Y'),icon:'text',className:'big-btn'}),]),}),]);var infopointItemModel=new ContextMenuItemModel({componentName:'infopoint-popup',action:'convert',prettyName:_lang('CONTEXT_MENU_CONVERT_TO_POPUP'),icon:'text',className:'big-btn'});var galleryItemModel=new ContextMenuItemModel({componentName:'infopoint-gallery',action:'convert',prettyName:_lang('CONTEXT_MENU_CONVERT_TO_GALLERY'),icon:'text',className:'big-btn'});var linkItemModel=new ContextMenuItemModel({componentName:'infopoint-link',action:'convert',prettyName:_lang('CONTEXT_MENU_CONVERT_TO_LINK'),icon:'text',className:'big-btn'});var downloadItemModel=new ContextMenuItemModel({componentName:'infopoint-download',action:'convert',prettyName:_lang('CONTEXT_MENU_CONVERT_TO_DOWNLOAD'),icon:'text',className:'big-btn'});var soundItemModel=new ContextMenuItemModel({componentName:'infopoint-sound',action:'convert',prettyName:_lang('CONTEXT_MENU_CONVERT_TO_SOUND'),icon:'text',className:'big-btn'});var textItemModel=new ContextMenuItemModel({componentName:'text',action:'convert',prettyName:_lang('CONTEXT_MENU_CONVERT_TO_TEXT'),icon:'text',className:'big-btn'});var imageItemModel=new ContextMenuItemModel({componentName:'image',action:'convert',prettyName:_lang('CONTEXT_MENU_CONVERT_TO_IMAGE'),icon:'text',className:'big-btn'});var contextMenuItemModel=new ContextMenuItemModel({componentName:'extend',prettyName:_lang('CHANGE_TO'),icon:'text',className:'big-btn extend',subitems:new ContextMenuItemCollection()});var type=this.model.get('type');if(infopointItemModel.get('componentName')==type)infopointItemModel.set('disabled',true);if(galleryItemModel.get('componentName')==type)galleryItemModel.set('disabled',true);if(linkItemModel.get('componentName')==type)linkItemModel.set('disabled',true);if(downloadItemModel.get('componentName')==type)downloadItemModel.set('disabled',true);if(soundItemModel.get('componentName')==type)soundItemModel.set('disabled',true);if(imageItemModel.get('componentName')==type)imageItemModel.set('disabled',true);if(textItemModel.get('componentName')==type)textItemModel.set('disabled',true);switch(type){case'infopoint-download':case'infopoint-gallery':case'infopoint-link':case'infopoint-popup':case'infopoint-sound':contextMenuItemModel.get('subitems').add(infopointItemModel);contextMenuItemModel.get('subitems').add(galleryItemModel);contextMenuItemModel.get('subitems').add(linkItemModel);contextMenuItemModel.get('subitems').add(downloadItemModel);contextMenuItemModel.get('subitems').add(soundItemModel);contextMenuItemModel.get('subitems').add(imageItemModel);var contents=this.model.get('contents');if(contents){contextMenuItemModel.get('subitems').add(textItemModel);}
contextMenuItemCollection.add(contextMenuItemModel);break;case'image':contextMenuItemModel.get('subitems').add(infopointItemModel);contextMenuItemModel.get('subitems').add(galleryItemModel);contextMenuItemModel.get('subitems').add(linkItemModel);contextMenuItemModel.get('subitems').add(downloadItemModel);contextMenuItemModel.get('subitems').add(soundItemModel);contextMenuItemModel.get('subitems').add(imageItemModel);var contents=this.model.get('contents');_log('contents',contents);if(contents!=undefined){contextMenuItemModel.get('subitems').add(textItemModel);}
contextMenuItemCollection.add(contextMenuItemModel);break;case'text':var imageFileName=this.model.get('imageFileName');if(imageFileName!=undefined){contextMenuItemModel.get('subitems').add(infopointItemModel);contextMenuItemModel.get('subitems').add(galleryItemModel);contextMenuItemModel.get('subitems').add(linkItemModel);contextMenuItemModel.get('subitems').add(downloadItemModel);contextMenuItemModel.get('subitems').add(soundItemModel);contextMenuItemModel.get('subitems').add(textItemModel);contextMenuItemModel.get('subitems').add(imageItemModel);contextMenuItemCollection.add(contextMenuItemModel);}
break;}
var contextMenuItemModel=new ContextMenuItemModel({componentName:'extend',prettyName:_lang('TIMELINE_ROW'),icon:'text',className:'big-btn extend',subitems:new ContextMenuItemCollection([new ContextMenuItemModel({componentName:'move-components-to-new-line',action:'move-components-to-new-line',prettyName:_lang('CONTEX_TMENU_MOVE_COMPONENTS_TO_NEW_LINE'),icon:'text',className:'big-btn'}),new ContextMenuItemModel({componentName:'copy-components-to-new-line',action:'copy-components-to-new-line',prettyName:_lang('CONTEX_TMENU_COPY_COMPONENTS_TO_NEW_LINE'),icon:'text',className:'big-btn'}),])});contextMenuItemCollection.add(contextMenuItemModel);this.addComponentSpecificMenu(contextMenuItemCollection);return contextMenuItemCollection;},flipX:function(){this.model.flipX();},flipY:function(){this.model.flipY();},addComponentSpecificMenu:function(contextMenuItemCollection){var contextMenuItemModel=this.getSpecificMenu();if(_.isUndefined(contextMenuItemModel)){return;}
contextMenuItemCollection.add(this.getSepearator(),{at:0});contextMenuItemCollection.add(contextMenuItemModel.models,{at:0});},getSepearator:function(){return new LeftMenuItemModel({componentName:'separator',className:'separator'});},getSpecificMenu:function(){return undefined;},specificAction:function(){},});;;var MultiComponentContextMenuView=ComponentContextMenuView.extend({template:_.template($('#multi-component-context-menu-template').html()),checkIfModelIsHidden:function(){var allHidden=true;_log('checkIfModelIsHidden this.model',this.model);StageView.instance.selectedComponentsCollection.each(function(cModel){if(!cModel.get('hidden')){allHidden=false;}});return allHidden;},createMenuCollection:function(){var contextMenuItemCollection=new ContextMenuItemCollection([new ContextMenuItemModel({componentName:'copy',action:'copy',prettyName:_lang('CONTEXT_MENU_COPY'),icon:'text',className:'big-btn'}),new ContextMenuItemModel({componentName:'cut',action:'cut',prettyName:_lang('CONTEXT_MENU_CUT'),icon:'text',className:'big-btn'}),new ContextMenuItemModel({componentName:'hide-or-show',action:this.checkIfModelIsHidden()?'show':'hide',prettyName:this.checkIfModelIsHidden()?_lang('CONTEXT_MENU_SHOW'):_lang('CONTEXT_MENU_HIDE'),icon:'text',className:'big-btn'}),new ContextMenuItemModel({componentName:'remove',action:'remove',prettyName:_lang('CONTEXT_MENU_REMOVE'),icon:'text',className:'big-btn'}),new ContextMenuItemModel({componentName:'border',action:'border',prettyName:_lang('CONTEXT_MENU_BORDER'),icon:'text',className:'big-btn'}),new LeftMenuItemModel({componentName:'separator',className:'separator'}),new ContextMenuItemModel({componentName:'paste-trigger',action:'paste-trigger',prettyName:_lang('CONTEXT_MENU_PASTE_COMPONENT_ACTIONS'),icon:'text',className:'big-btn',disabled:StageView.instance.clipboardActions.length==0?true:false}),new ContextMenuItemModel({componentName:'paste-position',action:'paste-position',prettyName:_lang('CONTEXT_MENU_PASTE_POSITION'),icon:'text',className:'big-btn',disabled:StageView.instance.copiedComponentPosition.length==0?true:false}),new ContextMenuItemModel({componentName:'paste-dimension',action:'paste-dimension',prettyName:_lang('CONTEXT_MENU_PASTE_DIMENSION'),icon:'text',className:'big-btn',disabled:StageView.instance.copiedComponentDimensions.length==0?true:false}),new ContextMenuItemModel({componentName:'paste-style',action:'paste-style',prettyName:_lang('CONTEXT_MENU_PASTE_STYLE'),icon:'text',className:'big-btn'}),new LeftMenuItemModel({componentName:'separator',className:'separator'}),new ContextMenuItemModel({componentName:'extend',prettyName:_lang('TIMELINE_ROW'),icon:'text',className:'big-btn extend',subitems:new ContextMenuItemCollection([new ContextMenuItemModel({componentName:'move-components-to-new-line',action:'move-components-to-new-line',prettyName:_lang('CONTEX_TMENU_MOVE_COMPONENTS_TO_NEW_LINE'),icon:'text',className:'big-btn'}),new ContextMenuItemModel({componentName:'copy-components-to-new-line',action:'copy-components-to-new-line',prettyName:_lang('CONTEX_TMENU_COPY_COMPONENTS_TO_NEW_LINE'),icon:'text',className:'big-btn'}),])})]);return contextMenuItemCollection;}});;;var ImageComponentContextMenuView=ComponentContextMenuView.extend({getSpecificMenu:function(){var contextMenuItemCollection=new ContextMenuItemCollection([new ContextMenuItemModel({componentName:'change-image',prettyName:_lang('CONTEXT_MENU_CHANGE_IMAGE'),icon:'text',action:'change-image',className:'big-btn',}),new ContextMenuItemModel({componentName:'crop-image',prettyName:_lang('CONTEXT_MENU_CROP_IMAGE'),icon:'text',action:'crop-image',className:'big-btn',})]);return contextMenuItemCollection;},specificAction:function(action){switch(action){case'change-image':this.model.setComponentAsImage();this.view.showImageWindow();break;case'crop-image':this.view.showCropWindow();break;}}});var AudioComponentContextMenuView=ComponentContextMenuView.extend({getSpecificMenu:function(){var contextMenuItemCollection=new ContextMenuItemCollection([new ContextMenuItemModel({componentName:'change-audio',prettyName:_lang('CONTEXT_MENU_CHANGE_AUDIO'),icon:'text',action:'change-audio',className:'big-btn',}),new ContextMenuItemModel({componentName:'change-image',prettyName:_lang('CONTEXT_MENU_CHANGE_IMAGE'),icon:'text',action:'change-image',className:'big-btn',})]);return contextMenuItemCollection;},specificAction:function(action){switch(action){case'change-image':this.model.setComponentAsImage();this.view.showImageWindow();break;case'change-audio':this.view.uploadOnClick();break;}}});;;var ComponentContextMenuViewNotEditable=ContextMenuView.extend({template:_.template($('#component-context-menu-template').html()),onItemClick:function(model){_log('model',model);var action=model.get('action');switch(action){case'copy':this.view.copyComponentsFromOtherProject();break;case'copy-trigger':StageView.instance.copyTriggerFromOtherProject(this.model);break;case'copy-position':StageView.instance.copyPositionFromOtherProject(this.model);break;case'copy-dimension':StageView.instance.copyDimensionFromOtherProject(this.model);break;case'copy-style':StageView.instance.copyStyleFromOtherProject(this.model);break;}
this.close();},createMenuCollection:function(){var contextMenuItemCollection=new ContextMenuItemCollection([new ContextMenuItemModel({componentName:'copy',action:'copy',prettyName:_lang('CONTEXT_MENU_COPY'),icon:'text',className:'big-btn'}),new LeftMenuItemModel({componentName:'separator',className:'separator'}),new ContextMenuItemModel({componentName:'extend',prettyName:_lang('TRIGGER'),icon:'text',className:'big-btn extend',subitems:new ContextMenuItemCollection([new ContextMenuItemModel({componentName:'copy-trigger',action:'copy-trigger',prettyName:_lang('CONTEXT_MENU_COPY_COMPONENT_ACTIONS'),icon:'text',className:'big-btn'}),]),}),new ContextMenuItemModel({componentName:'extend',prettyName:_lang('POSITION'),icon:'text',className:'big-btn extend',subitems:new ContextMenuItemCollection([new ContextMenuItemModel({componentName:'copy-position',action:'copy-position',prettyName:_lang('CONTEXT_MENU_COPY_POSITION'),icon:'text',className:'big-btn'}),]),}),new ContextMenuItemModel({componentName:'extend',prettyName:_lang('AUTH_PROJECT_DIMENTIONS'),icon:'text',className:'big-btn extend',subitems:new ContextMenuItemCollection([new ContextMenuItemModel({componentName:'copy-dimension',action:'copy-dimension',prettyName:_lang('CONTEXT_MENU_COPY_DIMENSION'),icon:'text',className:'big-btn'}),]),}),new ContextMenuItemModel({componentName:'extend',prettyName:_lang('MENU_TOPSTYLES'),icon:'text',className:'big-btn extend',subitems:new ContextMenuItemCollection([new ContextMenuItemModel({componentName:'copy-style',action:'copy-style',prettyName:_lang('CONTEXT_MENU_COPY_STYLE'),icon:'text',className:'big-btn'}),]),}),]);return contextMenuItemCollection;}});;;var MultiComponentContextMenuViewNotEditable=ComponentContextMenuViewNotEditable.extend({template:_.template($('#multi-component-context-menu-template').html()),createMenuCollection:function(){var contextMenuItemCollection=new ContextMenuItemCollection([new ContextMenuItemModel({componentName:'copy',action:'copy',prettyName:_lang('CONTEXT_MENU_COPY'),icon:'text',className:'big-btn'}),]);return contextMenuItemCollection;}});;;var StageContextMenuView=ContextMenuView.extend({template:_.template($('#stage-context-menu-template').html()),onItemClick:function(model){var action=model.get('action');switch(action){case'paste-in-place':StageView.instance.pasteComponents();break;case'change-background':StageView.instance.model.view.openImageWindow();break;}
this.close();},createMenuCollection:function(){var contextMenuItemCollection=new ContextMenuItemCollection([new ContextMenuItemModel({componentName:'paste-in-place',action:'paste-in-place',prettyName:_lang('CONTEXT_MENU_PASTE_IN_PLACE'),icon:'text',className:'big-btn',disabled:StageView.instance.hash==undefined?true:false}),new ContextMenuItemModel({componentName:'change-background',action:'change-background',prettyName:_lang('CONTEXT_MENU_CHANGE_PAGE_BACKGROUND'),icon:'text',className:'big-btn'})]);return contextMenuItemCollection;}});;;var NotEditableStageContextMenuView=ContextMenuView.extend({template:_.template($('#stage-context-menu-template').html()),onItemClick:function(model){var action=model.get('action');switch(action){case'copy-page':var pageIds=[this.view.model.get('options').get('pageid')];if(pageIds.length==0){return;}
var userId=this.view.model.userid;var projectId=this.view.model.projectId;ProjectView.instance.copyPagesFromOtherProject(pageIds,userId,projectId);break;}
this.close();},createMenuCollection:function(){var contextMenuItemCollection=new ContextMenuItemCollection([new ContextMenuItemModel({componentName:'copy-page',action:'copy-page',prettyName:_lang('CONTEXT_MENU_COPY_PAGE'),icon:'text',className:'big-btn'})]);return contextMenuItemCollection;}});;;var PageContextMenuView=ContextMenuView.extend({template:_.template($('#page-context-menu-template').html()),checkIfModelIsActive:function(){return this.model.get('options').get('active');},onItemClick:function(model){var action=model.get('action');switch(action){case'new-page':ProjectView.instance.createNewPage();break;case'duplicate-page':ProjectView.instance.duplicatePages();break;case'hide-page':this.view.changePageShow();break;case'change-background-page':this.view.uploadOnClick();break;case'delete-page':var left=parseInt(this.$el.css('left'))+parseInt(this.$el.css('width'));var top=parseInt(this.$el.css('top'))+parseInt(this.$el.css('width'));ProjectView.instance.showDeletePagesWindow({pageX:left,pageY:top});break;case'copy-trigger':this.view.copyTrigger();break;case'paste-trigger':var triggers=ProjectView.instance.pagesList.copiedPageTrigger;this.view.pasteTrigger(triggers);break;}
this.close();},createMenuCollection:function(){var contextMenuItemCollection=new ContextMenuItemCollection([new ContextMenuItemModel({componentName:'new-page',action:'new-page',prettyName:_lang('CONTEXT_MENU_NEW_PAGE'),icon:'text',className:'big-btn'}),new ContextMenuItemModel({componentName:'duplicate-page',action:'duplicate-page',prettyName:_lang('CONTEXT_MENU_NEW_DUPLICATE_PAGE'),icon:'text',className:'big-btn'}),new ContextMenuItemModel({componentName:'hide-page',action:'hide-page',prettyName:this.checkIfModelIsActive()?_lang('CONTEXT_MENU_HIDE_PAGE'):_lang('CONTEXT_MENU_SHOW_PAGE'),icon:'text',className:'big-btn'}),new ContextMenuItemModel({componentName:'change-background-page',action:'change-background-page',prettyName:_lang('CONTEXT_MENU_CHANGE_PAGE_BACKGROUND'),icon:'text',className:'big-btn'}),new ContextMenuItemModel({componentName:'delete-page',action:'delete-page',prettyName:_lang('CONTEXT_MENU_PAGE_REMOVE'),icon:'text',className:'big-btn'}),new LeftMenuItemModel({componentName:'separator',className:'separator'}),new ContextMenuItemModel({componentName:'extend',prettyName:_lang('TRIGGER'),icon:'text',className:'big-btn extend',subitems:new ContextMenuItemCollection([new ContextMenuItemModel({componentName:'copy-trigger',action:'copy-trigger',prettyName:_lang('CONTEXT_MENU_COPY_PAGE_ACTIONS'),icon:'text',className:'big-btn'}),new ContextMenuItemModel({componentName:'paste-trigger',action:'paste-trigger',prettyName:_lang('CONTEXT_MENU_PASTE_PAGE_ACTIONS'),icon:'text',className:'big-btn',})])})]);return contextMenuItemCollection;}});;;var SecondPageContextMenuView=ContextMenuView.extend({template:_.template($('#second_page-context-menu-template').html()),onItemClick:function(model){var action=model.get('action');switch(action){case'copy-page':ProjectView.selected.copyPages();break;}
this.close();},createMenuCollection:function(){var contextMenuItemCollection=new ContextMenuItemCollection([new ContextMenuItemModel({componentName:'copy-page',action:'copy-page',prettyName:_lang('CONTEXT_MENU_COPY_PAGE'),icon:'text',className:'big-btn'})]);return contextMenuItemCollection;}});;;var TimelineRowContextMenuView=ContextMenuView.extend({template:_.template($('#timeline-row-context-menu-template').html()),onItemClick:function(model){var action=model.get('action');switch(action){case'copy':StageView.instance.copyComponents();break;case'remove':StageView.instance.deleteActiveComponent();break;case'hide':StageView.instance.hideComponents();break;case'paste':StageView.instance.pasteComponents();break;}
this.close();},createMenuCollection:function(){var contextMenuItemCollection=new ContextMenuItemCollection([new ContextMenuItemModel({componentName:'copy',action:'copy',prettyName:_lang('CONTEXT_MENU_COPY'),icon:'text',className:'big-btn'}),new ContextMenuItemModel({componentName:'paste',action:'paste',prettyName:_lang('CONTEXT_MENU_PASTE'),icon:'text',className:'big-btn',disabled:StageView.instance.hash==undefined?true:false}),new ContextMenuItemModel({componentName:'remove',action:'remove',prettyName:_lang('CONTEXT_MENU_REMOVE'),icon:'text',className:'big-btn'}),new ContextMenuItemModel({componentName:'hide',action:'hide',prettyName:_lang('CONTEXT_MENU_SHOW_HIDE'),icon:'text',className:'big-btn'})]);return contextMenuItemCollection;}});;;var TimelineEmptyRowContextMenuView=ContextMenuView.extend({template:_.template($('#timeline-empty-row-context-menu-template').html()),onItemClick:function(model){var action=model.get('action');switch(action){case'paste':StageView.instance.pasteComponents();break;}
this.close();},createMenuCollection:function(){var contextMenuItemCollection=new ContextMenuItemCollection([new ContextMenuItemModel({componentName:'paste',action:'paste',prettyName:_lang('CONTEXT_MENU_PASTE'),icon:'text',className:'big-btn',disabled:StageView.instance.hash==undefined?true:false})]);return contextMenuItemCollection;}});;;ContextMenuContainer=function(){this.contextMenu=new ContextMenuView({windowModel:new WindowModel()});}
ContextMenuContainer.addMenu=function(contextMenu,e){ContextMenuContainer.closeMenu();$('body').append(contextMenu.render({model:contextMenu.model.toJSON()}).$el);var left=e.pageX;var top=e.pageY;contextMenu.setWindowPosition({left:left,top:top});this.contextMenu=contextMenu;}
ContextMenuContainer.closeMenu=function(){if(this.contextMenu!=undefined){this.contextMenu.close();}}
ContextMenuContainer.instance=new ContextMenuContainer();;;var QclContextMenuView=ContextMenuView.extend({template:_.template($('#qcl-context-menu-template').html()),onItemClick:function(model){var action=model.get('action');switch(action){case'edit':this.view.showEditWindowForOneObject(this.e);break;case'delete':this.view.deleteObject(this.e);break;}
this.close();},createMenuCollection:function(){var contextMenuItemCollection=new ContextMenuItemCollection([new ContextMenuItemModel({componentName:'edit',action:'edit',prettyName:_lang('CONTEXT_MENU_EDIT'),icon:'text',className:'big-btn'}),new ContextMenuItemModel({componentName:'delete',action:'delete',prettyName:_lang('CONTEXT_MENU_DELETE'),icon:'text',className:'big-btn'})]);return contextMenuItemCollection;}});;;var QclGoodAnswerContextMenuView=QclContextMenuView.extend({template:_.template($('#qcl-context-menu-template').html()),onItemClick:function(model){var action=model.get('action');switch(action){case'edit':this.view.showEditWindowForOneObject(this.e);break;case'delete':this.view.deleteGoodObject(this.e);break;}
this.close();}});;;var QclContainerContextMenuView=ContextMenuView.extend({template:_.template($('#qcl-context-menu-template').html()),onItemClick:function(model){var action=model.get('action');switch(action){case'edit':this.view.showEditWindowForOneObject(this.e);break;}
this.close();},createMenuCollection:function(){var contextMenuItemCollection=new ContextMenuItemCollection([new ContextMenuItemModel({componentName:'edit',action:'edit',prettyName:_lang('CONTEXT_MENU_EDIT'),icon:'text',className:'big-btn'})]);return contextMenuItemCollection;}});;;var NavigationItemViewContextMenuView=ContextMenuView.extend({template:_.template($('#navigation-item-context-menu-template').html()),onItemClick:function(model){var action=model.get('action');switch(action){case'close-others':this.view.closeOthersProjects();break;}
this.close();},createMenuCollection:function(){var contextMenuItemCollection=new ContextMenuItemCollection([new ContextMenuItemModel({componentName:'close-others',action:'close-others',prettyName:'Close others',icon:'text',className:'big-btn'})]);return contextMenuItemCollection;}});;;var NotEditableNavigationItemViewContextMenuView=ContextMenuView.extend({template:_.template($('#navigation-item-context-menu-template').html()),onItemClick:function(model){var action=model.get('action');switch(action){case'close':this.view.closeProject();break;case'close-all':this.view.closeAllProjects();break;case'close-others':this.view.closeOthersProjects();break;}
this.close();},createMenuCollection:function(){var contextMenuItemCollection=new ContextMenuItemCollection([new ContextMenuItemModel({componentName:'close',action:'close',prettyName:'Close',icon:'text',className:'big-btn'}),new ContextMenuItemModel({componentName:'close-all',action:'close-all',prettyName:'Close all',icon:'text',className:'big-btn'}),new ContextMenuItemModel({componentName:'close-others',action:'close-others',prettyName:'Close others',icon:'text',className:'big-btn'})]);return contextMenuItemCollection;}});;;var EditorContextMenuView=ContextMenuView.extend({template:_.template($('#context-menu-template').html()),onItemClick:function(model){var action=model.get('action');switch(action){case'unbind-editor':this.view.unbindEditor();break;}
this.close();},createMenuCollection:function(){var contextMenuItemCollection=new ContextMenuItemCollection([new ContextMenuItemModel({componentName:'unbind-editor',action:'unbind-editor',prettyName:_lang('CONTEXT_MENU_UNBIND'),prettyName:'Odepnij',icon:'text',className:'big-btn'}),]);return contextMenuItemCollection;}});;;var TriggerItemListContextMenuView=ContextMenuView.extend({template:_.template($('#context-menu-template').html()),onItemClick:function(model){var action=model.get('action');switch(action){case'copy-this-action-to-clipboard':StageView.instance.copyThisActionToClipboard(this.model.toJSON());break;case'to-paste-actions-from-the-clipboard':StageView.instance.toPasteActionsFromTheClipboard();break;case'clean-actions-clipboard':StageView.instance.cleanActionsClipboard();break;case'paste-one-trigger':var componentName=model.get('componentName');var trigger=StageView.instance.clipboardActions[componentName];if(trigger){StageView.instance.toPasteActionsFromTheClipboard([trigger]);}
break;case'paste-trigger':StageView.instance.pasteTrigger();break;}
this.close();},getPasteActionsTriggerName:function(trigger){var s='';s+=_lang('TRIGGER_LIST_'+trigger.whendoit)+': ';var subtriggers=trigger.subtriggers;for(var j=0;j<subtriggers.length;j++){var whattodo=subtriggers[j].whattodo;s+=_lang('TRIGGER_LIST_'+whattodo);if(j<subtriggers.length-1){s+=', '}};return s;},createPasteActionsSubitems:function(){var _that=this;var subitems=new ContextMenuItemCollection();var clipboardActions=StageView.instance.clipboardActions;for(var i=0;i<clipboardActions.length;i++){var trigger=clipboardActions[i];var contextMenuItemModel=new ContextMenuItemModel({componentName:i,action:'paste-one-trigger',prettyName:_that.getPasteActionsTriggerName(trigger),icon:'text',className:'big-btn'});subitems.add(contextMenuItemModel);};return subitems;},createMenuCollection:function(){var _that=this;var contextMenuItemCollection=new ContextMenuItemCollection([new ContextMenuItemModel({componentName:'copy-this-action-to-clipboard',action:'copy-this-action-to-clipboard',prettyName:_lang('CONTEXT_MENU_COPY_THIS_ACTION_TO_CLIPBOARD'),icon:'text',className:'big-btn'}),new ContextMenuItemModel({componentName:'extend',action:'to-paste-actions-from-the-clipboard',prettyName:_lang('CONTEXT_MENU_TO_PASTE_ACTIONS_FROM_THE_CLIPBOARD'),icon:'text',className:'big-btn extend',disabled:StageView.instance.clipboardActions.length==0?true:false,subitems:_that.createPasteActionsSubitems()}),new ContextMenuItemModel({componentName:'extend',action:'paste-trigger',prettyName:_lang('CONTEXT_MENU_PASTE_COMPONENT_ACTIONS'),icon:'text',className:'big-btn extend',disabled:StageView.instance.clipboardActions.length==0?true:false,subitems:_that.createPasteActionsSubitems()}),new ContextMenuItemModel({componentName:'clean-actions-clipboard',action:'clean-actions-clipboard',prettyName:_lang('CONTEXT_MENU_CLEAN_ACTIONS_CLIPBOARD'),icon:'text',className:'big-btn',disabled:StageView.instance.clipboardActions.length==0?true:false}),]);return contextMenuItemCollection;}});;;var PopupModel=Backbone.Model.extend({defaults:{type:"",message:"",modal:true,draggable:false}});;;var PopupView=WindowView.extend({tagName:'div',className:'window popup',template:_.template($('#popup-template').html()),events:function(){return _.extend({},WindowView.prototype.events,{'click .popup-ok-button':'okButtonClick','click .popup-cancel-button':'cancelButtonClick'});},makeDraggable:function(modal){var _that=this;if(modal){var content=this.$el.find('.popup-wrapper');content.draggable({cursor:'move',handle:".window-top-bar"});content.css({position:'absolute',top:'0px',left:'0px',right:'0px',bottom:'0px'});}else{this.$el.draggable({cursor:'move',handle:".window-top-bar"});}},runListeners:function(){},okButtonClick:function(){},cancelButtonClick:function(){},triggerOk:function(data){this.trigger('ok-button-click',data,this);},triggerCancel:function(data){this.trigger('cancel-button-click',data,this);}});;;var StandardPopupView=PopupView.extend({className:'window popup standard-popup',template:_.template($('#standard-popup-template').html()),okButtonClick:function(){this.triggerOk();this.close();},cancelButtonClick:function(){this.close();},onClose:function(){}});;;var ErrorPopupView=PopupView.extend({className:'window popup error-popup',template:_.template($('#error-popup-template').html()),okButtonClick:function(){this.triggerOk();this.close();},cancelButtonClick:function(){this.close();},onClose:function(){}});;;var CreatePdfDialogPopupView=PopupView.extend({className:'window popup create-pdf-popup',template:_.template($('#create-pdf-popup-template').html()),okButtonClick:function(){this.triggerOk();this.close();},cancelButtonClick:function(){this.triggerCancel();this.close();},onClose:function(){this.trigger('close-popup');}});;;var OverrideExistingPublicationPopupView=PopupView.extend({className:'window popup override-existing-publicatoin-popup',template:_.template($('#override-existing-publicatoin-popup-template').html()),initialize:function(data){this.publicationsToOverride=data.data.publication;this.publicationOptions=data.data.publicationOptions;this.windowModel=data.windowModel;this.runListeners();},afterRender:function(){var _that=this;_.each(this.publicationsToOverride,function(projectData){var projectModel=new PublishedItemModel(projectData);var projectView=new PublishProjectItemToOverrideView({model:projectModel,publicationOptions:_that.publicationOptions});projectView.on('override-publication-complete',function(pModel){_that.overridePublicationComplete(pModel);});_that.$el.find('.publication-list').append(projectView.render().$el);});},overridePublicationComplete:function(pModel){var _that=this;var projectID=__meta__.projectID;DataAccess.getPublishedData({projectID:projectID},function(data){_that.publicationsToOverride=data.publication;_that.render();_that.trigger('override-publication-complete');},function(data){_log('data',data)});},onClose:function(){}});;;function PopupFactory(){}
PopupFactory.createStandardPopup=function(data,sender){var windowModel=new WindowModel({type:"standard",modal:true,data:data,sender:sender});var popupView=new StandardPopupView({windowModel:windowModel});return popupView;}
PopupFactory.createCreatePdfDialogPopup=function(data,sender){var windowModel=new WindowModel({type:"standard",modal:true,data:data,sender:sender});var popupView=new CreatePdfDialogPopupView({windowModel:windowModel});return popupView;}
PopupFactory.createOverrideExistingPublicationPopup=function(data,sender){var windowModel=new WindowModel({type:"standard",modal:true,sender:sender});var popupView=new OverrideExistingPublicationPopupView({windowModel:windowModel,data:data});return popupView;}
PopupFactory.createErrorPopup=function(data,sender){var windowModel=new WindowModel({type:"standard",modal:true,sender:sender});var popupView=new ErrorPopupView({windowModel:windowModel,data:data});return popupView;};;var UserInfoModel=Backbone.Model.extend({defaults:{activeLine:null,activeComponent:new ComponentModel(),activePage:new PageModel(new PageOptions({pageid:1})),activePageId:1,activeRowId:1}});;;function User(){this.selectedActionkey=null;}
User.getModel=function(){if(this.userInfoModel==undefined){this.userInfoModel=new UserInfoModel();}
return this.userInfoModel;}
User.setSelectedComponentModel=function(model){this.userInfoModel=model;}
User.getSelectedComponentModel=function(lines){var activeComponent=this.userInfoModel.get('activeComponent');var actionkey=activeComponent.get('actionkey');lines.timeline.collection.each(function(item){var objects=item.get('objects');objects.each(function(model){if(activeComponent.get('actionkey')==actionkey){activeComponent}});});}
User.getSelectedActionkey=function(){return this.selectedActionkey;}
User.setSelectedActionkey=function(actionkey){this.selectedActionkey=actionkey;};;var DataPickerModel=Backbone.Model.extend({defaults:{}});;;var DataPickerView=WindowView.extend({tagName:'div',className:'window data-picker animated',template:_.template($('#data-picker-template').html()),selectorTemplate:_.template($('#data-picker-selector-template').html()),selectorPositionTemplate:_.template($('#data-picker-selector-position-template').html()),events:{'click':'closeDataPicker','close':'closeDataPicker'},afterRender:function(){},initialize:function(data){var _that=this;this.windowModel=new DataPickerModel();this.setOptions(data);this.hoveredObject=null;this.onPicked=data.onPicked;this.setObserver(data);this.runObServer();this.addEvents();},setObserver:function(data){this.observer=StageView.instance;},setOptions:function(data){this.classSelector=this.getSelectorClass(data.picker);this.action=this.getPickedAction(data.picker);this.selectObjects(data.collection);},addEvents:function(){var _that=this;this.selector=$(this.selectorTemplate());this.selectorPosition=$(this.selectorPositionTemplate());this.selector.on('click',function(e){_that.onSelectorClick(e)});this.selectorPosition.on('click',function(e){_that.onSelectorPositionClick(e)});this.selector.on('mouseover',function(e){_that.onSelectorMouseOver(e)})
this.selector.on('mouseout',function(e){_that.onSelectorMouseOut(e)})
$('body').append(this.selector);$('body').append(this.selectorPosition);$('body').on('mouseover',function(e){_that.onMouseOver(e)});$('body').on('mousemove',function(e){_that.onMouseMove(e)});},onSelectorPositionClick:function(e){_log("onSelectorPositionClick",e);var stageView=StageView.instance;var offset=stageView.$el.offset()
var sx=parseInt(offset.left);var sy=parseInt(offset.top);var x=e.clientX-sx-12;var y=e.clientY-sy-11;var data={position:{x:x,y:y},e:e};this.trigger('data-picker-picked',data,this);if(this.onPicked!=undefined){this.onPicked(data);}
this.closeDataPicker();},onMouseMove:function(e){if(this.action=='point'){var stageView=StageView.instance;var offset=stageView.$el.offset()
var sx=parseInt(offset.left);var sy=parseInt(offset.top);var x=e.clientX-sx-12;var y=e.clientY-sy-11;this.selectorPosition.css({display:'block',left:(e.clientX-30)+"px",top:(e.clientY-30)+"px"});var position=('X: '+x+'px, Y: '+y+'px');this.selectorPosition.attr('position',position);}},runObServer:function(){var _that=this;this.observer.off('data-picker-picked');this.observer.on('data-picker-picked',function(componentModel){if(_that.objectsCollection!=undefined){componentModel.selectedByTrigger(true);}
_that.onDataPickerPicked(componentModel);});},selectObjects:function(objectsCollection){var _that=this;this.objectsCollection=objectsCollection;if(objectsCollection!=undefined){_.each(objectsCollection,function(key,value){var model=DataPickerView.findModel(key,_that.action);if(model!=undefined){if(model.selectedByTrigger!=undefined){model.selectedByTrigger(true);}}});}},unselectObjects:function(objectsCollection){var _that=this;var objectsCollection=this.objectsCollection;if(objectsCollection!=undefined){_.each(objectsCollection,function(key,value){var model=DataPickerView.findModel(key,_that.action);if(model!=undefined){if(model.selectedByTrigger!=undefined){model.selectedByTrigger(false);}}});}},getPickedAction:function(picker){if(picker==undefined){return'object';}else{return picker;}},getSelectorClass:function(picker){switch(picker){case'object':return'.component, .component-miniature, .timeline-item';break;case'line':return'.timelinerow, .timelinerow-classic';break;case'page':return'.page';break;case'exercise':return'.quiz-component-miniature, .quiz';break;case'timer':return'.timer-component-miniature, .timer-component';break;case'text':return'.text-component-miniature, .text-component';break;case'video':return'.video-component-miniature, .video-component';break;case'point':return'';break;default:return'.component, .component-miniature, .timeline-item';break;}},onDataPickerPicked:function(componentModel){this.trigger('data-picker-picked',componentModel);if(this.onPicked!=undefined){this.onPicked(componentModel);}},onMouseOver:function(e){var elementSearch=document.elementFromPoint(e.clientX,e.clientY);var selector=this.classSelector;var findedElement=null;if($(elementSearch).is(selector)){findedElement=$(elementSearch);}else{if($(elementSearch).parents(selector).is(selector)){findedElement=$(elementSearch).parents(selector);}}
if(findedElement!=null){_log('ZINDEX',findedElement.css('z-index'));var zIndex=!isNaN(findedElement.css('z-index'))?findedElement.css('z-index'):6001;zIndex=zIndex==0?6001:zIndex;this.selector.css({display:'block',left:findedElement.offset().left+"px",top:findedElement.offset().top+"px",width:findedElement.width()+"px",height:findedElement.height()+"px",'z-index':zIndex});this.hoveredObject=findedElement;}},onSelectorClick:function(e){var _that=this;if(this.hoveredObject!=null){_log('this.action',this.action);_log('this.hoveredObject',this.hoveredObject.trigger);this.hoveredObject.trigger('data-picker-unselected-by-miniature',{},this);this.hoveredObject.trigger('data-picker-picked-'+this.action,{},this);if(!e.shiftKey){this.closeDataPicker();}}},onSelectorMouseOver:function(e){if(this.hoveredObject!=null){this.hoveredObject.trigger('data-picker-selected-by-miniature',{},this);}},onSelectorMouseOut:function(e){if(this.hoveredObject!=null){this.hoveredObject.trigger('data-picker-unselected-by-miniature',{},this);}},closeDataPicker:function(){$('body').off('mouseover');$('body').off('mouseout');$('body').off('mousemove');this.selector.off('click');this.selector.off('mouseover');this.selector.off('mouseout');this.selector.remove();this.selectorPosition.off('click');this.selectorPosition.remove();this.unselectObjects();this.hoveredObject=null;this.trigger('data-picker-close');this.close();},makeDraggable:function(modal){}});DataPickerView.findComponentModel=function(actionkey){var stageView=StageView.instance;var componentModel=stageView.getComponentModelByActionkey(actionkey);return componentModel;}
DataPickerView.findRowModel=function(lineId){var stageView=StageView.instance;var rowModel=stageView.getRowModelByLineId(lineId);return rowModel;}
DataPickerView.findPageModel=function(pageId){var pageModel=ProjectModel.instance.getPageModelByPageId(pageId);return pageModel;}
DataPickerView.findModel=function(key,type){var model;if(type!=undefined){switch(type){case'object':return DataPickerView.findComponentModel(key);break;case'line':return DataPickerView.findRowModel(key);break;case'page':return DataPickerView.findPageModel(key);break;}}
model=DataPickerView.findComponentModel(key);if(model!=undefined){return model;}
model=DataPickerView.findRowModel(key);if(model!=undefined){return model;}
model=DataPickerView.findPageModel(key);if(model!=undefined){return model;}
return undefined};;var CreateNewVariableItemModel=Backbone.Model.extend({defaults:{pvarname:'',pvarvalue:'',varhash:''}});;;var CreateNewVariableItemView=Backbone.View.extend({tagName:"li",className:'create-new-variable-item',template:_.template($('#create-new-variable-project-variable-item-template').html()),events:function(){return _.extend({},TriggerSubtriggerItemView.prototype.events,{'keyup .create-new-variable-item-name':'changeValueName','keyup .create-new-variable-item-value':'changeValueValue','click .create-new-variable-delete-button':'deleteVariable','drop-item':'dropItem'});},dropItem:function(event,index){this.$el.trigger('update-sort',[this.model,index]);},render:function(){var template=this.template(this.model.toJSON());this.$el.html(template);this.setValues();this.delegateEvents();return this;},setValues:function(){},changeValueName:function(e){var value=$(e.target).val();this.model.set('pvarname',value);this.$el.trigger('update-changes',this.model,this);},changeValueValue:function(e){var value=$(e.target).val();this.model.set('pvarvalue',value);this.$el.trigger('update-changes',this.model,this);},deleteVariable:function(){this.$el.trigger('delete-variable',this.model,this);}});;;var CreateNewVariableStaticVariableItemView=Backbone.View.extend({tagName:"li",className:'create-new-variable-item',template:_.template($('#create-new-variable-static-variable-item-template').html()),events:function(){return _.extend({},TriggerSubtriggerItemView.prototype.events,{'click .variable-name':'selectText','keydown .variable-name':'readOnlyInput'});},readOnlyInput:function(e){if(e.ctrlKey&&e.keyCode==67){}else{e.preventDefault();return false;}},selectText:function(e){$(e.target).select();},render:function(){var template=this.template(this.model.toJSON());this.$el.html(template);this.delegateEvents();return this;},});;;var CreateNewVariableCollection=Backbone.Collection.extend({model:CreateNewVariableItemModel});;;var CreateNewVariableWindowModel=Backbone.Model.extend({defaults:{type:"",draggable:false,modal:true}});;;var CreateNewVariableWindowView=WindowView.extend({tagName:'div',className:'window window-create-new-variable-view',template:_.template($('#window-create-new-variable-template').html()),events:function(){return _.extend({},WindowView.prototype.events,{'click .create-new-variable-add-button':'createNewVariable','delete-variable':'deleteVariable','update-changes':'saveChanges','update-sort':'updateSort'});},updateSort:function(event,model,position){var collection=this.collection;collection.remove(model);collection.add(model,{at:position});this.saveChanges();},deleteVariable:function(event,model){this.collection.remove(model);this.afterRender();this.saveChanges();},afterRender:function(){this.$el.find('.darkan-tabs').tabs();this.$el.find('.user-variables-list').html('');if(this.collection!=undefined&&this.collection.length>0){this.collection.each(this.addVariableItem,this);}
this.$el.find('.user-variables-list').sortable({delay:50,update:function(event,ui){ui.item.trigger('drop-item',ui.item.index());}});this.$el.find('.project-variables-list').html('');if(this.collection2!=undefined&&this.collection2.length>0){this.collection2.each(this.addVariableItemStatic,this);}},addVariableItem:function(variableItem){var createNewVariableItemView=new CreateNewVariableItemView({model:variableItem});this.$el.find('.user-variables-list').append(createNewVariableItemView.render().$el);},addVariableItemStatic:function(variableItem){var createNewVariableStaticVariableItemView=new CreateNewVariableStaticVariableItemView({model:variableItem});this.$el.find('.project-variables-list').append(createNewVariableStaticVariableItemView.render().$el);},createNewVariable:function(e){var varhash=Utils.generateUniqueHash();var newVariable=new CreateNewVariableItemModel({varhash:varhash});this.collection.add(newVariable);this.afterRender();this.saveChanges();},runListeners:function(){this.collection=new CreateNewVariableCollection();var projectVariables=ProjectModel.instance.get('options').get('projectVariables');for(var i=0;i<projectVariables.length;i++){var projectVariable=projectVariables[i];var variableModel=new CreateNewVariableItemModel(projectVariable);this.collection.add(variableModel);};this.collection2=new CreateNewVariableCollection();var staticVariables=ProjectModel.instance.get('options').get('staticVariables');for(var i=0;i<staticVariables.length;i++){var projectVariable=staticVariables[i];var variableModel=new CreateNewVariableItemModel(projectVariable);this.collection2.add(variableModel);};},saveChanges:function(){var options=ProjectModel.instance.get('options');options.set('projectVariables',this.collection.toJSON());},onClose:function(){this.trigger('on-close',this,this);}});;;var TriggerElseActionModel=Backbone.Model.extend({defaults:{whattodo:'',objs:[],opts:new TriggerOptsModel()}});;;var TriggerElseOptionCollection=Backbone.Collection.extend({model:TriggerElseActionModel});;;var TriggerIfOptionModel=Backbone.Model.extend({defaults:{variable:'',action:'',conditionID:'',compareValue:'',actionType:'',andor:'and'}});;;var TriggerIfOptionCollection=Backbone.Collection.extend({model:TriggerIfOptionModel});;;var TriggerSubtriggerModel=Backbone.Model.extend({defaults:{whattodo:'',objs:[],opts:new TriggerOptsModel()}});;;var TriggerSubtriggerCollection=Backbone.Collection.extend({model:TriggerSubtriggerModel});;;var TriggerInteractionModel=Backbone.Model.extend({defaults:{whendoit:'',conditions:new TriggerIfOptionCollection(),elseactions:new TriggerElseOptionCollection(),subtriggers:new TriggerSubtriggerCollection()},selectItem:function(value){this.trigger('select-item',value,this);}});;;var TriggerInteractionCollection=Backbone.Collection.extend({model:TriggerInteractionModel});;;var TriggerModel=Backbone.Model.extend({defaults:{triggers:new TriggerInteractionCollection(),complete:false,draggable:true},loadOnTriggerOption:function(trigger){var triggerIfOptionCollection=new TriggerIfOptionCollection();for(var i=0;i<trigger.conditions.length;i++){var condition=trigger.conditions[i];var triggerIfOptionModel=new TriggerIfOptionModel(condition)
triggerIfOptionCollection.add(triggerIfOptionModel);}
var triggerElseOptionCollection=new TriggerElseOptionCollection();for(var i=0;i<trigger.elseactions.length;i++){var elseaction=trigger.elseactions[i];var triggerOptsModel=new TriggerOptsModel({animationType:new TriggerAnimationTypeModel(elseaction.opts.animationType),delay:elseaction.opts.delay,link:elseaction.opts.link,transition:elseaction.opts.transition,notadded:elseaction.opts.notadded,video:elseaction.opts.video,style:elseaction.opts.style,});var componentCollection=elseaction.objs;var triggerElseActionModel=new TriggerElseActionModel({whendoit:elseaction.whendoit,whattodo:elseaction.whattodo,objs:componentCollection,opts:triggerOptsModel});triggerElseOptionCollection.add(triggerElseActionModel);}
var triggerSubtriggerCollection=new TriggerSubtriggerCollection();for(var i=0;i<trigger.subtriggers.length;i++){var subtrigger=trigger.subtriggers[i];var triggerOptsModel=new TriggerOptsModel({animationType:new TriggerAnimationTypeModel(subtrigger.opts.animationType),delay:subtrigger.opts.delay,link:subtrigger.opts.link,transition:subtrigger.opts.transition,notadded:subtrigger.opts.notadded,video:subtrigger.opts.video,style:subtrigger.opts.style,});var componentCollection=subtrigger.objs;var triggerSubtriggerModel=new TriggerSubtriggerModel({whendoit:subtrigger.whendoit,whattodo:subtrigger.whattodo,objs:componentCollection,opts:triggerOptsModel});triggerSubtriggerCollection.add(triggerSubtriggerModel);}
var triggerInteractionOptsModel=new TriggerInteractionOptsModel(trigger.opts);var triggerInteractionModel=new TriggerInteractionModel({whendoit:trigger.whendoit,opts:triggerInteractionOptsModel,conditions:triggerIfOptionCollection,elseactions:triggerElseOptionCollection,subtriggers:triggerSubtriggerCollection});return triggerInteractionModel;},loadTrigger:function(componentTriggers){var stageView=StageView.instance;var triggerInteractionCollection=new TriggerInteractionCollection();if(componentTriggers!=undefined){for(var n=0;n<componentTriggers.length;n++){var trigger=componentTriggers[n];var triggerInteractionModel=this.loadOnTriggerOption(trigger);triggerInteractionCollection.add(triggerInteractionModel);};}
return triggerInteractionCollection;},createNewInteractionModel:function(){return new TriggerInteractionModel({whendoit:'',opts:new TriggerInteractionOptsModel(),conditions:new TriggerIfOptionCollection(),elseactions:new TriggerElseOptionCollection(),subtriggers:new TriggerSubtriggerCollection()});}});;;var TriggerInteractionModel=Backbone.Model.extend({defaults:{whendoit:'',conditions:new TriggerIfOptionCollection(),elseactions:new TriggerElseOptionCollection(),subtriggers:new TriggerSubtriggerCollection()},selectItem:function(value){this.trigger('select-item',value,this);}});;;var TriggerInteractionCollection=Backbone.Collection.extend({model:TriggerInteractionModel});;;var TriggerModel=Backbone.Model.extend({defaults:{triggers:new TriggerInteractionCollection(),complete:false,draggable:true},loadOnTriggerOption:function(trigger){var triggerIfOptionCollection=new TriggerIfOptionCollection();for(var i=0;i<trigger.conditions.length;i++){var condition=trigger.conditions[i];var triggerIfOptionModel=new TriggerIfOptionModel(condition)
triggerIfOptionCollection.add(triggerIfOptionModel);}
var triggerElseOptionCollection=new TriggerElseOptionCollection();for(var i=0;i<trigger.elseactions.length;i++){var elseaction=trigger.elseactions[i];var triggerOptsModel=new TriggerOptsModel({animationType:new TriggerAnimationTypeModel(elseaction.opts.animationType),delay:elseaction.opts.delay,link:elseaction.opts.link,transition:elseaction.opts.transition,notadded:elseaction.opts.notadded,video:elseaction.opts.video,style:elseaction.opts.style,});var componentCollection=elseaction.objs;var triggerElseActionModel=new TriggerElseActionModel({whendoit:elseaction.whendoit,whattodo:elseaction.whattodo,objs:componentCollection,opts:triggerOptsModel});triggerElseOptionCollection.add(triggerElseActionModel);}
var triggerSubtriggerCollection=new TriggerSubtriggerCollection();for(var i=0;i<trigger.subtriggers.length;i++){var subtrigger=trigger.subtriggers[i];var triggerOptsModel=new TriggerOptsModel({animationType:new TriggerAnimationTypeModel(subtrigger.opts.animationType),delay:subtrigger.opts.delay,link:subtrigger.opts.link,transition:subtrigger.opts.transition,notadded:subtrigger.opts.notadded,video:subtrigger.opts.video,style:subtrigger.opts.style,});var componentCollection=subtrigger.objs;var triggerSubtriggerModel=new TriggerSubtriggerModel({whendoit:subtrigger.whendoit,whattodo:subtrigger.whattodo,objs:componentCollection,opts:triggerOptsModel});triggerSubtriggerCollection.add(triggerSubtriggerModel);}
var triggerInteractionOptsModel=new TriggerInteractionOptsModel(trigger.opts);var triggerInteractionModel=new TriggerInteractionModel({whendoit:trigger.whendoit,opts:triggerInteractionOptsModel,conditions:triggerIfOptionCollection,elseactions:triggerElseOptionCollection,subtriggers:triggerSubtriggerCollection});return triggerInteractionModel;},loadTrigger:function(componentTriggers){var stageView=StageView.instance;var triggerInteractionCollection=new TriggerInteractionCollection();if(componentTriggers!=undefined){for(var n=0;n<componentTriggers.length;n++){var trigger=componentTriggers[n];var triggerInteractionModel=this.loadOnTriggerOption(trigger);triggerInteractionCollection.add(triggerInteractionModel);};}
return triggerInteractionCollection;},createNewInteractionModel:function(){return new TriggerInteractionModel({whendoit:'',opts:new TriggerInteractionOptsModel(),conditions:new TriggerIfOptionCollection(),elseactions:new TriggerElseOptionCollection(),subtriggers:new TriggerSubtriggerCollection()});}});;;var TriggerListItemView=ItemView.extend({tagName:"li",className:'trigger-list-item',template:_.template($('#trigger-list-item-template').html()),events:{'drop-item':'dropItem','click':'onMouseClick','click .trigger-delete-trigger-button':'deleteTrigger','click .trigger-copy-button':'copyTrigger','mousedown':'onMouseDown',},copyTrigger:function(e){e.stopPropagation();this.$el.trigger('copy-trigger',this.model);},deleteTrigger:function(e){e.stopPropagation();this.$el.trigger('delete-trigger',this.model);},initialize:function(){var _that=this;this.model.on('select-item',this.selectItem,this)
_that.addEventsToModel();},addEventsToModel:function(){var _that=this;},onMouseClick:function(e){this.$el.trigger('select-list-item',this.model,this);},selectItem:function(value){this.$el.attr('selected-item',value);},dropItem:function(event,index){this.$el.trigger('update-sort',[this.model,index]);},render:function(){var _that=this;var template=this.template(this.model.toJSON());this.$el.html(template);this.addTitleToButtons();this.delegateEvents();return this;},addTitleToButtons:function(){this.$el.find('[title]').tooltip({html:true,animated:'fade',placement:'left',width:300,height:200});},mouseDown:function(e){},scroll:function(e){},showContextMenu:function(e){var contextMenuView=new TriggerItemListContextMenuView({model:this.getModel(),view:this});ContextMenuContainer.addMenu(contextMenuView,e);},getModel:function(){return this.model;},});;;var TriggerListView=Backbone.View.extend({tagName:'div',className:'trigger-list',template:_.template($('#trigger-list-template').html()),selectedItemModel:null,events:{'update-sort':'updateSort','select-list-item':'selectItem'},selectItem:function(event,model){this.collection.each(this.unselectItem,this);this.selectedItemModel=model;model.selectItem(true);},unselectItem:function(model){model.selectItem(false);},deleteTrigger:function(event,model){this.collection.remove(model);this.render();this.update();},resetList:function(){this.$el.removeAttr('style');},update:function(){this.$el.trigger('update');},saveTriggers:function(){},initialize:function(data){this.collection=data.collection;},addNewInteraction:function(triggerInteractionModel){this.collection.add(triggerInteractionModel);this.selectedItemModel=triggerInteractionModel;},updateSort:function(event,model,position){var collection=this.collection;collection.remove(model);collection.add(model,{at:position});this.update();},render:function(){var _that=this;var template=this.template({collection:this.collection.toJSON()});this.$el.html(template);this.collection.each(this.addListItem,this);this.$el.find('.trigger-list-holder').sortable({delay:50,update:function(event,ui){ui.item.trigger('drop-item',ui.item.index());}});if(this.selectedItemModel!=undefined){this.selectedItemModel.selectItem(true);}
this.delegateEvents();return this;},addListItem:function(listItem){var triggerListItemView=new TriggerListItemView({model:listItem});triggerListItemView.on('render-list',this.render,this);this.$el.find('.trigger-list-holder').append(triggerListItemView.render().el);triggerListItemView.selectItem(false);}});;;var TriggerSectionView=Backbone.View.extend({tagName:"div",className:'trigger-section',template:_.template($('#trigger-section-template').html()),render:function(){var template=this.template(this.model.toJSON());this.$el.html(template);return this;},setCollection:function(collection){}});;;var TriggerSubtriggerItemView=TriggerSectionView.extend({tagName:"li",className:'trigger-subtrigger-item',template:_.template($('#trigger-subtrigger-item-template').html()),templateVariables:_.template($('#trigger-subtrigger-item-variables-template').html()),templateLink:_.template($('#trigger-subtrigger-item-link-template').html()),templateStandard:_.template($('#trigger-item-standard-template').html()),templateObjects:_.template($('#trigger-item-objects-template').html()),templateLayers:_.template($('#trigger-item-layers-template').html()),templatePages:_.template($('#trigger-item-pages-template').html()),templateChangeVariables:_.template($('#trigger-item-variables-template').html()),templatePlaySound:_.template($('#trigger-item-play-sound-template').html()),templateGoToLink:_.template($('#trigger-item-go-to-link-template').html()),templateCheckExercise:_.template($('#trigger-item-check-exercise-template').html()),templateCheckAllExercises:_.template($('#trigger-item-standard-template').html()),templateResetExercise:_.template($('#trigger-item-reset-exercise-template').html()),templateShowNextLayer:_.template($('#trigger-item-show-next-line-template').html()),templateTimer:_.template($('#trigger-item-timer-template').html()),templateVideo:_.template($('#trigger-item-video-template').html()),templateVideoPosition:_.template($('#trigger-item-video-position-template').html()),templateTransition:_.template($('#trigger-item-transition-template').html()),templateChangeStyle:_.template($('#trigger-item-change-style-template').html()),events:{'drop-item':'dropItem','change .trigger-action-select':'onTriggerActionChanged','keyup .trigger-link-input':'onTriggerLinkChanged','paste .trigger-link-input':'onTriggerLinkChanged','change .trigger-delay-input':'onTriggerDelayChanged','keyup .trigger-delay-input':'onTriggerDelayChanged','paste .trigger-delay-input':'onTriggerDelayChanged','click .trigger-delete-trigger-button':'deleteTrigger','click .trigger-add-animation-to-trigger':'addAnimationToTrigger','click .trigger-data-picker-icon':'showDataPicker','click .trigger-data-picker-text':'showDataPicker','mouseover .ex-object':'selectObject','mouseout .ex-object':'unselectObject','click .ex-object':'deleteObject','change .trigger-varpicker':'onVarpickerChanged','change .trigger-varactionpicker':'onVaractionpickerChanged','keyup .trigger-varchange-input':'onVarchangeChanged','change .trigger-x-input':'onXPositionChanged','change .trigger-y-input':'onYPositionChanged','change .trigger-width-input':'onWidthChanged','change .trigger-height-input':'onHeightChanged','change .trigger-rotate-angle-input':'onRotateAngleChanged','change .trigger-time-input':'onTimeChanged','change .trigger-easeing-type-select':'onAnimationTypeChanged','change .trigger-scale-input':'onScaleChanged','change .trigger-opacity-input':'onOpacityChanged','keyup .trigger-x-input':'onXPositionChanged','keyup .trigger-y-input':'onYPositionChanged','keyup .trigger-width-input':'onWidthChanged','keyup .trigger-height-input':'onHeightChanged','keyup .trigger-rotate-angle-input':'onRotateAngleChanged','keyup .trigger-time-input':'onTimeChanged','keyup .trigger-easeing-type-select':'onAnimationTypeChanged','keyup .trigger-scale-input':'onScaleChanged','keyup .trigger-opacity-input':'onOpacityChanged','paste .trigger-x-input':'onXPositionChanged','paste .trigger-y-input':'onYPositionChanged','paste .trigger-width-input':'onWidthChanged','paste .trigger-height-input':'onHeightChanged','paste .trigger-rotate-angle-input':'onRotateAngleChanged','paste .trigger-time-input':'onTimeChanged','paste .trigger-easeing-type-select':'onAnimationTypeChanged','paste .trigger-scale-input':'onScaleChanged','paste .trigger-opacity-input':'onOpacityChanged','mousewheel .trigger-x-input':'onXPositionChanged','mousewheel .trigger-y-input':'onYPositionChanged','mousewheel .trigger-width-input':'onWidthChanged','mousewheel .trigger-height-input':'onHeightChanged','mousewheel .trigger-rotate-angle-input':'onRotateAngleChanged','mousewheel .trigger-time-input':'onTimeChanged','mousewheel .trigger-easeing-type-select':'onAnimationTypeChanged','mousewheel .trigger-scale-input':'onScaleChanged','mousewheel .trigger-opacity-input':'onOpacityChanged','click .triggeraxis':'onAxisChanged','mouseover .trigger-animation-button-play':'animationPreviewPlay','mouseout .trigger-animation-button-play':'animationPreviewStop','change .trigger-aspect-ratio':'onTriggerAspectRatioChange','click .trigger-data-picker-icon-select-one-object':'setObjectParameters','mouseover .trigger-data-picker-icon-select-one-object':'onPickerMouseover','mouseout .trigger-data-picker-icon-select-one-object':'onPickerMouseout','click .trigger-data-picker-icon-select-xy-position':'setPoint','click .trigger-graph-baizer-previev':'showGraphBaizerPreviev','change .trigger-video-position-input':'onVideoPositionChanged','keyup .trigger-video-position-input':'onVideoPositionChanged','paste .trigger-video-position-input':'onVideoPositionChanged','mousewheel .trigger-video-position-input':'onVideoPositionChanged','change .trigger-video-position-playing-input':'onVideoPositionPlayingChanged','change .trigger-border-weight-input':'onBorderWeightChanged','keyup .trigger-border-weight-input':'onBorderWeightChanged','paste .trigger-border-weight-input':'onBorderWeightChanged','mousewheel .trigger-border-weight-input':'onBorderWeightChanged','change .trigger-border-type-select':'onBorderTypeChanged',},proportions:null,sectionName:'subtrigger',onBorderTypeChanged:function(e){var value=$(e.target).val();var opts=this.model.get('opts');_log('opts',opts);var style=opts.get('style')||{};style.borderType=value;opts.set('style',style);this.model.set('opts',opts);this.saveChanges();},onBorderWeightChanged:function(e){var value=parseFloat($(e.target).val());var opts=this.model.get('opts');_log('opts',opts);var style=opts.get('style')||{};style.borderWeight=value;opts.set('style',style);this.model.set('opts',opts);this.saveChanges();},onVideoPositionPlayingChanged:function(e){var value=$(e.target).prop('checked');var opts=this.model.get('opts');var video=opts.get('video')==undefined?{}:opts.get('video');video.play=value;opts.set('video',video);this.model.set('opts',opts);this.saveChanges();},onVideoPositionChanged:function(e){var value=parseInt($(e.target).val());var opts=this.model.get('opts');var video=opts.get('video')==undefined?{}:opts.get('video');video.position=value;opts.set('video',video);this.model.set('opts',opts);this.saveChanges();},getSelectedEase:function(){var triggerEaseingInput=this.$el.find('.trigger-easeing-type-select');return triggerEaseingInput.val();},showGraphBaizerPreviev:function(e){var _that=this;if(this.baizerWindowView==undefined){this.baizerWindowView=WindowFactory.createGraphBaizerPrevievWindow({triggerItem:this});this.baizerWindowView.on('on-close',function(){_that.baizerWindowView=undefined;});this.baizerWindowView.on('on-animation-selected',function(){});$('body').append(this.baizerWindowView.render({title:"Baizer"}).$el);var windowPosition={top:e.pageY,left:e.pageX};this.baizerWindowView.setWindowPosition(windowPosition);}},setPoint:function(e){var _that=this;if(this.dataPicker==undefined){this.dataPicker=new DataPickerView({picker:'point'});this.dataPicker.on('data-picker-close',function(){_that.dataPicker=undefined;_that.$el.trigger('show-trigger',{},this);});this.dataPicker.on('data-picker-picked',function(data){var position=data.position;var x=position.x;var y=position.y;var opts=_that.model.get('opts');var transition=opts.get('transition')==undefined?{}:opts.get('transition');transition.x=x;transition.y=y;opts.set('transition',transition);_that.model.set('opts',opts);_that.saveChanges();_that.renderTransitionTemplate();});$('body').append(this.dataPicker.render().$el);}},onPickerMouseover:function(e){var _that=this;var selectedParams=$(e.currentTarget).attr('selectedparams');var triggerXInput=this.$el.find('.trigger-x-input');var triggerYInput=this.$el.find('.trigger-y-input');var triggerWidthInput=this.$el.find('.trigger-width-input');var triggerHeightInput=this.$el.find('.trigger-height-input');switch(selectedParams){case'positions':triggerXInput.addClass('trigger-highligh-input');triggerYInput.addClass('trigger-highligh-input');break;case'dimensions':triggerWidthInput.addClass('trigger-highligh-input');triggerHeightInput.addClass('trigger-highligh-input');break;case'all':triggerXInput.addClass('trigger-highligh-input');triggerYInput.addClass('trigger-highligh-input');triggerWidthInput.addClass('trigger-highligh-input');triggerHeightInput.addClass('trigger-highligh-input');break;}},onPickerMouseout:function(e){var _that=this;var triggerXInput=this.$el.find('.trigger-x-input');var triggerYInput=this.$el.find('.trigger-y-input');var triggerWidthInput=this.$el.find('.trigger-width-input');var triggerHeightInput=this.$el.find('.trigger-height-input');triggerXInput.removeClass('trigger-highligh-input');triggerYInput.removeClass('trigger-highligh-input');triggerWidthInput.removeClass('trigger-highligh-input');triggerHeightInput.removeClass('trigger-highligh-input');},setObjectParameters:function(e){var _that=this;var selectedParams=$(e.currentTarget).attr('selectedparams');if(selectedParams=='none'){return;}
if(this.dataPicker==undefined){this.dataPicker=new DataPickerView({stageView:this.stageView,picker:'object'});this.dataPicker.on('data-picker-close',function(){_that.dataPicker=undefined;_that.$el.trigger('show-trigger',{},this);});this.dataPicker.on('data-picker-picked',function(model){var x=model.get('x');var y=model.get('y');var width=model.get('width');var height=model.get('height');var radians=model.get('rotate');var opts=_that.model.get('opts');var transition=opts.get('transition')==undefined?{}:opts.get('transition');switch(selectedParams){case'positions':transition.x=x;transition.y=y;break;case'dimensions':transition.width=width;transition.height=height;_that.calculateProportion(width,height);break;case'all':transition.x=x;transition.y=y;transition.width=width;transition.height=height;_that.calculateProportion(width,height);break;}
_that.renderTransitionTemplate();});$('body').append(this.dataPicker.render().$el);}},animationPreviewPlay:function(){var opts=this.model.get('opts');var transition=opts.get('transition')==undefined?{}:opts.get('transition');var model=this.componentModel;var x=transition.x==undefined?model.get('x'):parseInt(transition.x);var y=transition.y==undefined?model.get('y'):parseInt(transition.y);var width=transition.width==undefined?model.get('width'):parseInt(transition.width);var height=transition.height==undefined?model.get('height'):parseInt(transition.height);var rotate=(!$.isNumeric(transition.rotate))?0:parseInt(transition.rotate);var time=transition.time==undefined?1.3:parseFloat(transition.time);var ease=transition.ease==undefined?'0.250, 0.250, 0.750, 0.750':transition.ease;var axis=transition.axis==undefined?'center-center':transition.axis;var scale=(!$.isNumeric(transition.scale))?1:transition.scale;var opacity=(!$.isNumeric(transition.scale))?1:transition.opacity;ease='cubic-bezier('+ease+')';var animation='opacity time ease, top time ease, left time ease, width time ease, height time ease, transform time ease';animation=animation.replace(/time/g,(time+'s'));animation=animation.replace(/ease/g,ease);var objs=this.model.get('objs');for(var i=0;i<objs.length;i++){var actionkey=objs[i];var componentModel=DataPickerView.findModel(actionkey,'object');var view=componentModel.view;var copiedStyle=view.$el.attr('style');view.$el.attr('copiedstyle',copiedStyle);view.$el.css('-webkit-transition',animation);view.$el.css('-moz-transition',animation);view.$el.css('-o-transition',animation);view.$el.css('transition',animation);view.$el.css('left',x+'px');view.$el.css('top',y+'px');view.$el.css('width',width+'px');view.$el.css('height',height+'px');view.$el.css('opacity',opacity);view.$el.css('-webkit-transform','rotate('+rotate+'deg) '+'scale('+scale+')');view.$el.css('-moz-transform','rotate('+rotate+'deg) '+'scale('+scale+')');view.$el.css('-o-transform','rotate('+rotate+'deg) '+'scale('+scale+')');view.$el.css('-ms-transform','rotate('+rotate+'deg) '+'scale('+scale+')');view.$el.css('transform','rotate('+rotate+'deg) '+'scale('+scale+')');view.$el.css('transform-style:','preserve-3D');var axisX=axis.split('-')[0];var axisY=axis.split('-')[1];view.$el.css('-webkit-transform-origin',axisY+' '+axisX);view.$el.css('-ms-transform-origin',axisY+' '+axisX);};},onScaleChanged:function(e){var value=parseFloat($(e.target).val());var opts=this.model.get('opts');var transition=opts.get('transition')==undefined?{}:opts.get('transition');transition.scale=value;opts.set('transition',transition);this.model.set('opts',opts);this.saveChanges();},onOpacityChanged:function(e){var value=parseFloat($(e.target).val());var opts=this.model.get('opts');var transition=opts.get('transition')==undefined?{}:opts.get('transition');transition.opacity=value;opts.set('transition',transition);this.model.set('opts',opts);this.saveChanges();},animationPreviewStop:function(){var objs=this.model.get('objs');for(var i=0;i<objs.length;i++){var actionkey=objs[i];var componentModel=DataPickerView.findModel(actionkey,'object');var view=componentModel.view;var copiedStyle=view.$el.attr('copiedstyle');view.$el.attr('style',copiedStyle);}},onTriggerAspectRatioChange:function(e){var value=$(e.target).prop('checked');var opts=this.model.get('opts');var transition=opts.get('transition')==undefined?{}:opts.get('transition');transition.aspectRatio=value;opts.set('transition',transition);this.model.set('opts',opts);this.saveChanges();},onAxisChanged:function(e){var axis=$(e.target).val();var value=parseInt($(e.target).val());var opts=this.model.get('opts');var transition=opts.get('transition')==undefined?{}:opts.get('transition');transition.axis=axis;var width=transition.width==undefined?this.componentModel.get('width'):transition.width;var height=transition.height==undefined?this.componentModel.get('height'):transition.height;this.calculateProportion(width,height);opts.set('transition',transition);this.model.set('opts',opts);this.saveChanges();},onXPositionChanged:function(e){var value=parseFloat($(e.target).val());var opts=this.model.get('opts');var transition=opts.get('transition')==undefined?{}:opts.get('transition');transition.x=value;opts.set('transition',transition);this.model.set('opts',opts);this.saveChanges();},onYPositionChanged:function(e){var value=parseFloat($(e.target).val());var opts=this.model.get('opts');var transition=opts.get('transition')==undefined?{}:opts.get('transition');transition.y=value;opts.transition=transition;opts.set('transition',transition);this.model.set('opts',opts);this.saveChanges();},onWidthChanged:function(e){var value=parseFloat($(e.target).val());var opts=this.model.get('opts');var transition=opts.get('transition')==undefined?{}:opts.get('transition');var aspectRatio=transition.aspectRatio==undefined?true:transition.aspectRatio;var triggerWidthInput=this.$el.find('.trigger-width-input');var triggerHeightInput=this.$el.find('.trigger-height-input');var width=transition.width==undefined?this.componentModel.get('width'):transition.width;var height=transition.height==undefined?this.componentModel.get('height'):transition.height;if(aspectRatio){var proportions=this.proportions;if(value>0){transition.height=parseInt((parseFloat($(e.target).val())*proportions)/100);triggerHeightInput.val(transition.height);}}else{this.calculateProportion(width,height);}
transition.width=value;opts.transition=transition;opts.set('transition',transition);this.model.set('opts',opts);this.saveChanges();},calculateProportion:function(width,height){return this.proportions=(parseInt(height)*100)/ parseInt(width);},onHeightChanged:function(e){var value=parseFloat($(e.target).val());var opts=this.model.get('opts');var transition=opts.get('transition')==undefined?{}:opts.get('transition');var aspectRatio=transition.aspectRatio==undefined?true:transition.aspectRatio;var triggerWidthInput=this.$el.find('.trigger-width-input');var triggerHeightInput=this.$el.find('.trigger-height-input');var width=transition.width==undefined?this.componentModel.get('width'):transition.width;var height=transition.height==undefined?this.componentModel.get('height'):transition.height;if(aspectRatio){var proportions=this.proportions;if(value>0){transition.width=parseInt((value*100)/proportions);triggerWidthInput.val(transition.width);}}else{this.calculateProportion(width,height);}
transition.height=value;opts.transition=transition;opts.set('transition',transition);this.model.set('opts',opts);this.saveChanges();},onRotateAngleChanged:function(e){var value=parseInt($(e.target).val());var opts=this.model.get('opts');var transition=opts.get('transition')==undefined?{}:opts.get('transition');transition.rotate=value;opts.transition=transition;opts.set('transition',transition);this.model.set('opts',opts);this.saveChanges();},onTimeChanged:function(e){var value=parseFloat($(e.target).val());var opts=this.model.get('opts');var transition=opts.get('transition')==undefined?{}:opts.get('transition');transition.time=value;opts.transition=transition;opts.set('transition',transition);this.model.set('opts',opts);this.saveChanges();},onAnimationTypeChanged:function(e){var value=$(e.target).val();var opts=this.model.get('opts');var transition=opts.get('transition')==undefined?{}:opts.get('transition');transition.ease=value;opts.transition=transition;opts.set('transition',transition);this.model.set('opts',opts);this.saveChanges();if(this.baizerWindowView){this.baizerWindowView.setBaizer(this);}},initialize:function(data){this.componentModel=data.componentModel;this.initializeTriggerOption();this.model.on('mark-for-a-while',this.markForAWhile,this)},markForAWhile:function(){var _that=this;this.$el.attr('mark',true);setTimeout(function(){_that.$el.attr('mark',false);},1000);},onTriggerDelayChanged:function(e){var value=parseFloat($(e.target).val());this.model.get('opts').set('delay',value);this.saveChanges();},onVarpickerChanged:function(e){var variable=$(e.target).val();var action=this.$el.find('.trigger-varactionpicker').val();var varValue=this.$el.find('.trigger-varchange-input').val();var options={};options.varName=variable;options.varAction=action;options.varValue=varValue;this.model.set('objs',options);},onVaractionpickerChanged:function(e){var value=$(e.target).val();var options=this.model.get('objs');options.varAction=value;this.model.trigger('change');},onVarchangeChanged:function(e){var value=$(e.target).val();var whenDoIt=$('.trigger-on-select').val();var calculatePoints=false;if(whenDoIt=='custom_questionpassed'){var disabled=$('.scoring-reqire-exercise-points-aaccess').attr('disabled');if(disabled!='disabled'){this.componentModel.set('scoreSuccess',value,{silent:true});$('.scoring-reqire-exercise-points-aaccess').val(value);calculatePoints=true;}}
if(whenDoIt=='custom_questionfailed'){var disabled=$('.scoring-reqire-exercise-points-fail').attr('disabled');if(disabled!='disabled'){this.componentModel.set('scoreFail',value,{silent:true});$('.scoring-reqire-exercise-points-fail').val(value);}}
if(whenDoIt=='custom_questionbadanswer'){var disabled=$('.scoring-reqire-exercise-points-bad-answer').attr('disabled');if(disabled!='disabled'){this.componentModel.set('scoreBadAnswer',value,{silent:true});$('.scoring-reqire-exercise-points-bad-answer').val(value);}}
var options=this.model.get('objs');options.varValue=value;this.model.trigger('change');if(calculatePoints){ProjectModel.instance.calculateAllScoreSuccessPoints();}},onDisableComponentsOnTheStageChanged:function(e){var value=$(e.target).prop('checked');var options={};options.disableComponents=value;this.model.set('objs',options,{silent:true});this.model.trigger('change');},deleteObject:function(e){var sender=$(e.target);var actionkey=sender.attr('actionkey');var actionType=sender.attr('action');var componentsCollection=this.model.get('objs');var index=componentsCollection.indexOf(actionkey);if(index!=-1){componentsCollection.splice(index,1);var componentModel=DataPickerView.findModel(actionkey,actionType);componentModel.selectedByPickerMiniature(false);this.renderItem();this.saveChanges();}},selectObject:function(e){var sender=$(e.target);var actionkey=sender.attr('actionkey');var actionType=sender.attr('action');sender.addClass('delete-on-hover');var componentModel=DataPickerView.findModel(actionkey,actionType);componentModel.selectedByPickerMiniature(true);},unselectObject:function(e){var sender=$(e.target);var actionkey=sender.attr('actionkey');var actionType=sender.attr('action');sender.removeClass('delete-on-hover');var componentModel=DataPickerView.findModel(actionkey,actionType);componentModel.selectedByPickerMiniature(false);},dropItem:function(event,index){this.$el.trigger('update-sort',[this.model,index]);},showDataPicker:function(e){var _that=this;var sender=$(e.target);var picker=sender.attr('picker');this.$el.trigger('hide-trigger',{},this);var componentsCollection=_that.model.get('objs');if(this.dataPicker==undefined){this.dataPicker=new DataPickerView({stageView:this.stageView,collection:componentsCollection,picker:picker});this.dataPicker.on('data-picker-close',function(){_that.dataPicker=undefined;_that.$el.trigger('show-trigger',{},this);});this.dataPicker.on('data-picker-picked',function(model){var type=model.get('type');var key;var whatToDo=_that.model.get('whattodo');if(whatToDo=='checkExercise'){if(model.cid==_that.componentModel.cid){model.selectedByTrigger(false);return;}}
if(whatToDo=='startTimer'||whatToDo=='stopTimer'||whatToDo=='resetTimer'){if(model.cid==_that.componentModel.cid){model.selectedByTrigger(false);return;}}
switch(type){case'line':key=model.get('options').get('id');break;case'page':key=''+model.get('options').get('pageid');break;default:key=model.get('actionkey');break;}
if(type=='page'){_that.dataPicker.unselectObjects();componentsCollection=[];componentsCollection.push(key);_that.model.set('objs',componentsCollection);_that.dataPicker.selectObjects(componentsCollection);_that.renderItem();_that.saveChanges();}else{var exist=componentsCollection.indexOf(''+key);if(exist==-1){componentsCollection.push(''+key);}else{_that.dataPicker.unselectObjects();var index=componentsCollection.indexOf(key);componentsCollection.splice(index,1);_that.model.set('objs',componentsCollection);_that.dataPicker.selectObjects(componentsCollection);}
_that.renderItem();_that.saveChanges();}});$('body').append(this.dataPicker.render().$el);}},saveChanges:function(){this.$el.trigger('save-changes',this.model,this);},clearComponentContainer:function(){var triggerComponentsContainer=this.$el.find('.trigger-components-container');triggerComponentsContainer.html('');},addAnimationToTrigger:function(e){var _that=this;var sender=$(e.target);if(this.animationView==undefined){var actionValue=this.$el.find('.trigger-action-select').val();var windowType="";if(actionValue=='showObject'||actionValue=='showLine'){windowType="animIn";}
if(actionValue=='hideObject'||actionValue=='hideLine'){windowType="animOut";}
if(windowType==""){return;}
var triggerOptsModel=this.model.get('opts');var triggerOptsObject=triggerOptsModel.get('animationType').toJSON();this.animationView=WindowFactory.createAnimateWindow(triggerOptsObject);this.animationView.on('on-close',function(){_that.animationView=undefined;});this.animationView.on('on-animation-selected',function(animationType){triggerOptsModel.set('animationType',new TriggerAnimationTypeModel(animationType));sender.val(_lang('ANIMATION_'+animationType.animationName));_that.saveChanges();});$('body').append(this.animationView.render({title:_lang('ANIMATIONWINDOW_TITLE_'+windowType),animations:window._layout.animations[windowType],animationMainType:windowType}).$el);var windowPosition={top:e.pageY,left:e.pageX}
this.animationView.setWindowPosition(windowPosition);}},deleteTrigger:function(){if(this.baizerWindowView){this.baizerWindowView.close();}
this.model.unset('opts');this.$el.trigger('delete-one-trigger',this.model,this);},update:function(){},initializeTriggerOption:function(){this.triggerWhatToDo=new TriggerActionsCollection();var triggerActionModel=new TriggerActionModel({group:_lang('TRIGGER_WTD_TRANSITION'),options:[{name:_lang('TRIGGER_WTD_MAKE_TRANSITION'),value:'makeTransition',picker:'object'}]});this.triggerWhatToDo.add(triggerActionModel);var triggerActionModel=new TriggerActionModel({group:_lang('TRIGGER_WTD_OBJS'),options:[{name:_lang('TRIGGER_WTD_SHOWOBJ'),value:'showObject',picker:'object'},{name:_lang('TRIGGER_WTD_HIDEOBJ'),value:'hideObject',picker:'object'}]});this.triggerWhatToDo.add(triggerActionModel);var triggerActionModel=new TriggerActionModel({group:_lang('TRIGGER_WTD_LINES'),options:[{name:_lang('TRIGGER_WTD_SHOWLINE'),value:'showLine',picker:'line'},{name:_lang('TRIGGER_WTD_HIDELINE'),value:'hideLine',picker:'line'}]});this.triggerWhatToDo.add(triggerActionModel);var triggerActionModel=new TriggerActionModel({group:_lang('TRIGGER_WTD_PAGES'),options:[{name:_lang('TRIGGER_WTD_GOTOPAGE'),value:'gotopage',picker:'page'},{name:_lang('TRIGGER_WTD_NEXTPAGE'),value:'gotonextpage',picker:'none'},{name:_lang('TRIGGER_WTD_PREVPAGE'),value:'gotoprevpage',picker:'none'}]});this.triggerWhatToDo.add(triggerActionModel);var triggerActionModel=new TriggerActionModel({group:_lang('TRIGGER_WTD_VARS'),options:[{name:_lang('TRIGGER_WTD_CHANGEVARVALUE'),value:'changevarvalue',picker:'none'}]});this.triggerWhatToDo.add(triggerActionModel);var triggerActionModel=new TriggerActionModel({group:_lang('TRIGGER_WTD_STYLE'),options:[{name:_lang('TRIGGER_WTD_CHANGE_STYLE'),value:'changeStyle',picker:'object'}]});this.triggerWhatToDo.add(triggerActionModel);var triggerActionModel=new TriggerActionModel({group:_lang('TRIGGER_SOUND'),options:[{name:_lang('TRIGGER_WTD_ETC_PLAYAUDIO'),value:'playobjectsound',picker:'object'},{name:_lang('TRIGGER_WTD_ETC_PAUSEAUDIO'),value:'pauseobjectsound',picker:'object'},{name:_lang('TRIGGER_WTD_ETC_STOPAUDIO'),value:'stopobjectsound',picker:'object'},]});this.triggerWhatToDo.add(triggerActionModel);var triggerActionModel=new TriggerActionModel({group:_lang('TRIGGER_WTD_ETC'),options:[{name:_lang('TRIGGER_WTD_ETC_UNLOCKNAVI'),value:'unlockpagenavigation',picker:'none'},{name:_lang('TRIGGER_WTD_ETC_RESETQUESTIONS'),value:'resetExerciseApproach',picker:'none'},{name:_lang('TRIGGER_WTD_ETC_GO_TO_LINK'),value:'goToLink',picker:'none'},]});this.triggerWhatToDo.add(triggerActionModel);var triggerActionModel=new TriggerActionModel({group:_lang('TRIGGER_EXERCISE'),options:[{name:_lang('TRIGGER_EXERCISE_CHECK_EXERCISE'),value:'checkExercise',picker:'object'},{name:_lang('TRIGGER_EXERCISE_CHECK_All_EXERCISES'),value:'checkAllExercises',picker:'none'},{name:_lang('TRIGGER_EXERCISE_RESET_All_EXERCISES'),value:'resetAllExercises',picker:'none'}]});this.triggerWhatToDo.add(triggerActionModel);var triggerActionModel=new TriggerActionModel({group:_lang('TRIGGER_TIMER'),options:[{name:_lang('TIMER_START_TIMER'),value:'startTimer'},{name:_lang('TIMER_STOP_TIMER'),value:'stopTimer'},{name:_lang('TIMER_RESET_TIMER'),value:'resetTimer'},{name:_lang('TIMER_RESET_ALL_TIMERS'),value:'resetAllTimers'}]});this.triggerWhatToDo.add(triggerActionModel);var triggerActionModel=new TriggerActionModel({group:_lang('TRIGGER_VIDEO'),options:[{name:_lang('VIDEO_PLAY'),value:'playVideo'},{name:_lang('VIDEO_PAUSE'),value:'pauseVideo'},{name:_lang('VIDEO_STOP'),value:'stopVideo'},{name:_lang('VIDEO_GO_TO_POSITION'),value:'goToPositionVideo'}]});this.triggerWhatToDo.add(triggerActionModel);},onTriggerLinkChanged:function(e){var value=$(e.target).val();this.model.get('opts').set('link',value,{silent:true});this.saveChanges();},onTriggerActionChanged:function(e){var value=$(e.target).val();this.model.get('opts').set('notadded',true);this.model.get('opts').set('animationType',new TriggerAnimationTypeModel());var animationName=this.model.get('opts').get('animationType').get('animationName');this.$el.find('.trigger-add-animation-to-trigger').val(_lang('ANIMATION_'+animationName));this.model.set('whattodo',value,{silent:true});if(((this.lastActionValue=='showObject'&&value=='hideObject')||(this.lastActionValue=='hideObject'&&value=='showObject'))||((this.lastActionValue=='showLine'&&value=='hideLine')||(this.lastActionValue=='hideLine'&&value=='showLine'))){}else{this.model.set('objs',[],{silent:true});this.renderItem();this.showConditionSection();}
this.lastActionValue=value;this.saveChanges();},getSubtriggerObjectsTemplateOptions:function(addFirstComponent){var options={};options.whattodo=this.getTriggerWhatToDo();options.objects=[];var actionkeys=this.model.get('objs');this.addAndSaveFirstComponent(options,addFirstComponent);options.model=this.model.toJSON();var index=this.model.collection.indexOf(this.model);options.index=index
options.prefix=this.sectionName+index;return options;},addAndSaveFirstComponent:function(options,addFirstComponent){var actionkeys=this.model.get('objs');addFirstComponent=addFirstComponent==undefined?false:addFirstComponent;if(addFirstComponent){var opts=this.model.get('opts');var notadded=opts.get('notadded')==undefined?true:opts.get('notadded');if(notadded&&actionkeys.length==0){var actionkey=this.componentModel.get('actionkey');actionkeys.push(actionkey);opts.set('notadded',false);this.model.set('opts',opts);this.saveChanges();}}
for(var i=0;i<actionkeys.length;i++){var actionkey=actionkeys[i];var componentModel=StageView.instance.getComponentModelByActionkey(actionkey);if(componentModel){options.objects.push(componentModel.toJSON());}else{var index=actionkeys.indexOf(actionkey);actionkeys.splice(index,1);}};},getSubtriggerLayersTemplateOptions:function(){var options={};options.whattodo=this.getTriggerWhatToDo();var lineIds=this.model.get('objs');options.objects=[];for(var i=0;i<lineIds.length;i++){var lineId=lineIds[i];var rowModel=StageView.instance.getRowModelByLineId(lineId);if(rowModel){var rowId=rowModel.get('options').get('id');options.objects.push({lineId:rowId});}};options.model=this.model.toJSON();return options;},getSubtriggerPagesTemplateOptions:function(){var options={};options.whattodo=this.getTriggerWhatToDo();var pageIds=this.model.get('objs');options.objects=[];for(var i=0;i<pageIds.length;i++){var pageId=parseInt(pageIds[i]);var pageModel=ProjectModel.instance.getPageModelByPageId(pageId);if(pageModel){options.objects.push({pageId:pageModel.get('options').get('pageid')});}else{this.model.set('objs',[],{silent:true});}};options.model=this.model.toJSON();return options;},getSubtriggerVariablesTemplateOptions:function(){var options={};options.whattodo=this.getTriggerWhatToDo();var lineIds=this.model.get('objs');options.projectVariables=ProjectModel.instance.get('options').get('projectVariables');options.staticVariables=ProjectModel.instance.get('options').get('staticVariables');options.model=this.model.toJSON();return options;},getSubtriggerTemplateOptions:function(){var options={};options.whattodo=this.getTriggerWhatToDo();options.components=[];options.model=this.model.toJSON();return options;},render:function(){this.renderItem();this.showConditionSection();this.delegateEvents();return this;},showConditionSection:function(){this.$el.trigger('show-condition-section',{},this);},renderVariablesContainer:function(){var objs=this.model.get('objs');var variable=this.$el.find('.trigger-varpicker');var action=this.$el.find('.trigger-varactionpicker');var varValue=this.$el.find('.trigger-varchange-input');variable.val(objs.varName);action.val(objs.varAction);varValue.val(objs.varValue);},renderTransitionContainer:function(){var opts=this.model.get('opts');var transition=opts.get('transition')==undefined?{}:opts.get('transition');var triggerXInput=this.$el.find('.trigger-x-input');var triggerYInput=this.$el.find('.trigger-y-input');var triggerWidthInput=this.$el.find('.trigger-width-input');var triggerHeightInput=this.$el.find('.trigger-height-input');var triggerRotateAngleInput=this.$el.find('.trigger-rotate-angle-input');var triggerTimeInput=this.$el.find('.trigger-time-input');var triggerEaseingInput=this.$el.find('.trigger-easeing-type-select');var triggerAspectRatioCheckbox=this.$el.find('.trigger-aspect-ratio');var triggerScaleInput=this.$el.find('.trigger-scale-input');var triggerOpacityInput=this.$el.find('.trigger-opacity-input');var radians=this.componentModel.get('rotate');var degrees=parseInt((radians>0?radians:(2*Math.PI+radians))*360 /(2*Math.PI))
var x=transition.x==undefined?this.componentModel.get('x'):transition.x;var y=transition.y==undefined?this.componentModel.get('y'):transition.y;var width=transition.width==undefined?this.componentModel.get('width'):transition.width;var height=transition.height==undefined?this.componentModel.get('height'):transition.height;var rotate=transition.rotate==undefined?degrees:transition.rotate;var time=transition.time==undefined?1.3:transition.time;var ease=transition.ease==undefined?'0.250, 0.250, 0.750, 0.750':transition.ease;var axis=transition.axis==undefined?'center-center':transition.axis;var aspectRatio=transition.aspectRatio==undefined?true:transition.aspectRatio;var scale=transition.scale==undefined?1:transition.scale;var opacity=transition.opacity==undefined?1:transition.opacity;var triggerAxis=this.$el.find('.triggeraxis[value="'+axis+'"]');triggerXInput.val(x);triggerYInput.val(y);triggerWidthInput.val(width);triggerHeightInput.val(height);triggerRotateAngleInput.val(rotate);triggerTimeInput.val(time);triggerEaseingInput.val(ease);triggerAxis.prop('checked',true);triggerAspectRatioCheckbox.prop('checked',aspectRatio);triggerScaleInput.val(scale);triggerOpacityInput.val(opacity);transition.x=x;transition.y=y;transition.width=width;transition.height=height;transition.rotate=rotate;transition.time=time;transition.ease=ease;transition.axis=axis;transition.scale=scale;transition.opacity=opacity;var width=transition.width;var height=transition.height;this.calculateProportion(width,height);if(triggerEaseingInput.val()==null){var optgroup=$('<optgroup class="trigger-custom-group" label="custom">                <option value="'+transition.ease+'">custom</option>            </optgroup> ');triggerEaseingInput.append(optgroup);triggerEaseingInput.val(transition.ease);}
opts.set('transition',transition);this.saveChanges();},renderVideoContainer:function(){var opts=this.model.get('opts');_log('renderVideoContainer',opts);var video=opts.get('video')==undefined?{}:opts.get('video');var videoPositionInput=this.$el.find('.trigger-video-position-input');var videoPlayInput=this.$el.find('.trigger-video-position-playing-input');var videoPosition=video.position==undefined?0:video.position;var videoPlay=video.play==undefined?0:video.play;videoPositionInput.val(videoPosition);videoPlayInput.prop('checked',videoPlay)},renderStyleContainer:function(){var opts=this.model.get('opts');var style=opts.get('style')||{}
var borderTypeSelect=this.$el.find('.trigger-border-type-select');var borderType=style.borderType||'';borderTypeSelect.val(borderType);},getTriggerWhatToDo:function(){var triggerWhatToDo=this.componentModel.getTriggerWhatToDo();var tempArr=this.triggerWhatToDo.toJSON().concat(triggerWhatToDo);return tempArr;},renderItem:function(){var whatToDo=this.model.get('whattodo');switch(whatToDo){case'showObjects':this.renderObjectsTemplate();break;case'showObject':case'hideObject':this.renderObjectsTemplate();break;case'showLine':case'hideLine':this.renderLayersTemplate();break;case'gotopage':this.renderPagesTemplate();break;case'gotonextpage':this.renderStandardTemplate();break;case'gotoprevpage':this.renderStandardTemplate();break;case'changevarvalue':this.renderChangeVariableTemplate();break;case'playobjectsound':case'pauseobjectsound':case'stopobjectsound':this.renderPlaySoundTemplate();break;case'unlockpagenavigation':this.renderStandardTemplate();break;case'resetExerciseApproach':this.renderResetExerciseTemplate();break;case'goToLink':this.renderGoToLinkTemplate();break;case'checkExercise':this.renderCheckExerciseTemplate();break;case'checkAllExercises':case'resetAllExercises':this.renderCheckAllExercisesTemplate();break;case'showNextLine':this.renderShowNextLayerTemplate();break;case'startTimer':case'stopTimer':case'resetTimer':this.renderTimerTemplate();break;case'playVideo':case'stopVideo':case'pauseVideo':this.renderVideoTemplate();break;case'goToPositionVideo':this.renderVideoPositionTemplate();break;case'makeTransition':this.renderTransitionTemplate();break;case'changeStyle':this.renderStyleTemplate();break;default:this.renderStandardTemplate();break;}
this.addTitleToButtons();},renderStandardTemplate:function(){var options=this.getSubtriggerTemplateOptions();var template=this.templateStandard(options);this.$el.html(template);},renderObjectsTemplate:function(){var options=this.getSubtriggerObjectsTemplateOptions(true);var template=this.templateObjects(options);this.$el.html(template);},renderLayersTemplate:function(){var options=this.getSubtriggerLayersTemplateOptions();var template=this.templateLayers(options);this.$el.html(template);},renderPagesTemplate:function(){var options=this.getSubtriggerPagesTemplateOptions();var template=this.templatePages(options);this.$el.html(template);},renderChangeVariableTemplate:function(){var options=this.getSubtriggerVariablesTemplateOptions();var template=this.templateChangeVariables(options);this.$el.html(template);this.renderVariablesContainer();},renderPlaySoundTemplate:function(){var options=this.getSubtriggerObjectsTemplateOptions();var template=this.templatePlaySound(options);this.$el.html(template);},renderGoToLinkTemplate:function(){var options=this.getSubtriggerTemplateOptions();var template=this.templateGoToLink(options);this.$el.html(template);},renderCheckExerciseTemplate:function(){var options=this.getSubtriggerObjectsTemplateOptions();var template=this.templateCheckExercise(options);this.$el.html(template);},renderCheckAllExercisesTemplate:function(){var options=this.getSubtriggerTemplateOptions();var template=this.templateCheckAllExercises(options);this.$el.html(template);},renderResetExerciseTemplate:function(){var options=this.getSubtriggerObjectsTemplateOptions();var template=this.templateResetExercise(options);this.$el.html(template);},renderTimerTemplate:function(){var options=this.getSubtriggerObjectsTemplateOptions();var template=this.templateTimer(options);this.$el.html(template);},renderVideoTemplate:function(){var options=this.getSubtriggerObjectsTemplateOptions();var template=this.templateVideo(options);this.$el.html(template);},renderVideoPositionTemplate:function(){var options=this.getSubtriggerObjectsTemplateOptions();var template=this.templateVideoPosition(options);this.$el.html(template);this.renderVideoContainer();},renderShowNextLayerTemplate:function(){var options=this.getSubtriggerTemplateOptions();var template=this.templateShowNextLayer(options);this.$el.html(template);},renderTransitionTemplate:function(){var options=this.getSubtriggerObjectsTemplateOptions(true);var template=this.templateTransition(options);this.$el.html(template);this.renderTransitionContainer();},renderStyleTemplate:function(){var _that=this;var options=this.getSubtriggerObjectsTemplateOptions();var template=this.templateChangeStyle(options);this.$el.html(template);setTimeout(function(){_that.createColorPicker('background','.text-color-picker-container');_that.createGradientColorPicker('borderColor','.border-color-picker-container');});this.renderStyleContainer();},addTitleToButtons:function(){this.$el.find('[title]').tooltip({html:true,animated:'fade',placement:'right',width:300,height:200});},createColorPicker:function(colorType,containerClass){var _that=this;var opts=this.model.get('opts');_log('opts',opts);var style=opts.get('style')||{};_log('createColorPicker style',style);var gradientSaveTimeout=null;var background='#FFF';if(!_.isUndefined(style[colorType])){background=style[colorType];}
this.textBgColorPicker=new GradientPickerView({color:background});this.$el.find(containerClass).html(this.textBgColorPicker.render().$el);this.textBgColorPicker.afterRender();this.textBgColorPicker.on('move',function(data){background=data.color;_that.$el.find('.picker-container').css('background',data.color);_log('background',background);style[colorType]=background;opts.set('style',style);_that.model.set('opts',opts);});this.textBgColorPicker.on('gradient-change',function(data){clearTimeout(gradientSaveTimeout);background=data.color;gradientSaveTimeout=setTimeout(function(){_log('background',background);style[colorType]=background;opts.set('style',style);_that.model.set('opts',opts);_that.saveChanges();},500);});this.textBgColorPicker.on('hide',function(data){_log('textBgColorPicker hide',data);_that.saveChanges();});},createGradientColorPicker:function(colorType,containerClass){var _that=this;var opts=this.model.get('opts');var style=opts.get('style')||{};var background='#FFF';if(!_.isUndefined(style[colorType])){background=style[colorType];}
this.borderBgColorPicker=new ColorPickerView({color:background});this.$el.find(containerClass).html(this.borderBgColorPicker.render().$el);this.borderBgColorPicker.on('move',function(data){background=data.color;style[colorType]=background;opts.set('style',style);_that.model.set('opts',opts);});this.borderBgColorPicker.on('change',function(data){});this.borderBgColorPicker.on('hide',function(data){_that.saveChanges();});},});;;var TriggerSubtriggerSectionView=Backbone.View.extend({tagName:"div",className:'trigger-subtrigger-section',template:_.template($('#trigger-subtrigger-section-template').html()),events:{'save-changes':'update','update-sort':'updateSort','change .trigger-action-select':'onTriggerActionChanged','delete-one-trigger':'deleteTrigger','click .trigger-add-new-trigger-button':'addNewTrigger'},initialize:function(data){this.collection=data.collection;},updateSort:function(event,model,position){var collection=this.collection;collection.remove(model);collection.add(model,{at:position});this.render();this.update();},addNewTrigger:function(e){var triggerSubtriggerModel=new TriggerSubtriggerModel({whattodo:'',objs:[],opts:new TriggerOptsModel({animationType:new TriggerAnimationTypeModel(),delay:0})});this.collection.add(triggerSubtriggerModel);this.render();this.update();},deleteTrigger:function(event,model){this.collection.remove(model);this.render();this.update();},update:function(event,model){this.$el.trigger('update',model,this);},render:function(){var template=this.template();this.$el.html(template);if(this.collection!=undefined&&this.collection.length>0){this.collection.each(this.addTriggerItem,this);}
this.$el.find('.trigger-item-holder').sortable({delay:50,update:function(event,ui){ui.item.trigger('drop-item',ui.item.index());}});this.delegateEvents();return this;},setCollection:function(collection,componentModel){this.collection=collection;this.componentModel=componentModel;this.collection.off('change');this.collection.on('change',this.update,this);},addTriggerItem:function(subreiggerItem){var _that=this;var triggerSubtriggerItemView=new TriggerSubtriggerItemView({model:subreiggerItem,componentModel:this.componentModel});this.$el.find('.trigger-item-holder').append(triggerSubtriggerItemView.render().el);},showItem:function(){this.$el.show();_log('onTriggerOnChanged',this.collection);if(this.collection.length==0){this.addNewTrigger();}}});;;var TriggerElseActionItemView=TriggerSubtriggerItemView.extend({tagName:"li",className:'trigger-elseaction-item',template:_.template($('#trigger-elseaction-item-template').html()),sectionName:'elseaction'});;;var TriggerElseActionSectionView=TriggerSubtriggerSectionView.extend({tagName:"div",className:'trigger-elseaction-section',template:_.template($('#trigger-elseaction-section-template').html()),addNewTrigger:function(e){var triggerSubtriggerModel=new TriggerSubtriggerModel({whendoit:'',whattodo:'',objs:[],opts:new TriggerOptsModel({animationType:new TriggerAnimationTypeModel(),delay:0,transition:{}})});this.collection.add(triggerSubtriggerModel);this.render();this.update();},addTriggerItem:function(subreiggerItem){var triggerElseActionItemView=new TriggerElseActionItemView({model:subreiggerItem,componentModel:this.componentModel});this.$el.find('.trigger-item-holder').append(triggerElseActionItemView.render().el);}});;;var TriggerConditionItemView=TriggerSubtriggerItemView.extend({tagName:"li",className:'trigger-condition-item',template:_.template($('#trigger-condition-item-template').html()),events:function(){return _.extend({},TriggerSubtriggerItemView.prototype.events,{'change .trigger-condition-varpicker':'choiceConditionVariable','change .trigger-condition-action-picker':'choiceConditionActionPicker','keyup .trigger-compare-value':'setCompareValue','change .condition-andor-action':'choiceConditionAndorAction','change .trigger-compare-value':'setCompareValueSelect'});},render:function(variable){var variable=this.model.get('actionType');var options=ProjectModel.instance.get('options');var projectVariables=options.get('projectVariables');var staticVariables=options.get('staticVariables');var template=this.template({projectVariables:projectVariables,staticVariables:staticVariables,variable:variable});this.$el.html(template);this.setValues();this.delegateEvents();return this;},setValues:function(){var action=this.model.get('action');this.$el.find('.trigger-condition-action-picker').val(action);var variable=this.model.get('variable');this.$el.find('.trigger-condition-varpicker').val(variable);var compareValue=this.model.get('compareValue');this.$el.find('.trigger-compare-value').val(compareValue);var andor=this.model.get('andor');this.$el.find('.condition-andor-action').val(andor);},choiceConditionActionPicker:function(e){var _that=this;var sender=$(e.target);var value=sender.val();var conditionType=sender.find(':selected').attr('conditiontype');this.model.set('action',value,{silent:true});this.model.set('actionType',conditionType,{silent:true});this.model.set('compareValue','',{silent:true});this.model.trigger('change');this.render(conditionType);var index=0;this.model.collection.each(function(m,i){if(m.cid==_that.model.cid){index=i;}});if(index==this.model.collection.length-1){this.$el.find('.condition-andor-action').css('display','none');}},choiceConditionVariable:function(e){var value=$(e.target).val();this.model.set('variable',value);},setCompareValueSelect:function(e){var value=$(e.target).val();this.model.set('compareValue',value);},setCompareValue:function(e){var value=$(e.target).val();this.model.set('compareValue',value);},choiceConditionAndorAction:function(e){var value=$(e.target).val();this.model.set('andor',value);}});;;var TriggerConditionSectionView=TriggerSubtriggerSectionView.extend({tagName:"div",className:'trigger-condition-section',template:_.template($('#trigger-condition-section-template').html()),events:function(){return _.extend({},TriggerSubtriggerSectionView.prototype.events,{'click .trigger-create-new-variable':'openCreateNewVariableWindow'});},openCreateNewVariableWindow:function(){_that=this;var createNewVariableWindow=WindowFactory.createCreateNewVariableWindow();createNewVariableWindow.on('on-close',function(){_that.$el.trigger('render-stage',_that,_that);});$('body').append(createNewVariableWindow.render().$el);},addNewTrigger:function(e){var triggerIfOptionModel=new TriggerIfOptionModel();this.collection.add(triggerIfOptionModel);this.render();this.update();this.$el.trigger('show-elseaction-section',{},this);},addTriggerItem:function(subreiggerItem,i){var triggerConditionItemView=new TriggerConditionItemView({model:subreiggerItem,componentModel:this.componentModel});this.$el.find('.trigger-item-holder').append(triggerConditionItemView.render().el);if(this.collection.length==1){triggerConditionItemView.$el.find('.condition-andor-action').css('display','none');}else{if(i==this.collection.length-1){triggerConditionItemView.$el.find('.condition-andor-action').css('display','none');}}}});;;var TriggerStageView=Backbone.View.extend({tagName:"div",className:'trigger-stage',template:_.template($('#trigger-stage-template').html()),normalTemplate:_.template($('#trigger-normal-stage-template').html()),keyboardTemplate:_.template($('#trigger-keyboard-stage-template').html()),videoTimeTemplate:_.template($('#trigger-video-time-stage-template').html()),events:{'change .trigger-on-select':'onTriggerOnChanged','render-stage':'render','show-condition-section':'showConditionSection','show-elseaction-section':'showElseActionSection','keydown .trigger-keyboard-input':'onTriggerKeyboardChanged','change .trigger-video-time-1-input':'onTriggerTime1Changed','change .trigger-video-time-2-input':'onTriggerTime2Changed'},showElseActionSection:function(){this.elseactionSection.$el.show();},showConditionSection:function(){this.conditionSection.$el.show();},update:function(){this.$el.trigger('save-asda',{},this);},initialize:function(data){this.triggerWhenDoIt=new TriggerActionsCollection();var triggerActionModel=new TriggerActionModel({group:_lang('TRIGGER_EVENT_MOUSE'),options:[{name:_lang('TRIGGER_EVENT_CLICK'),value:'click'},{name:_lang('TRIGGER_EVENT_MOUSEOVER'),value:'mouseenter'},{name:_lang('TRIGGER_EVENT_MOUSEOUT'),value:'mouseleave'}]});this.triggerWhenDoIt.add(triggerActionModel);this.componentModel=data.componentModel;this.model=new TriggerSubtriggerModel({defaults:{whendoit:'',whattodo:'',objs:new ComponentCollection(),opts:new TriggerOptsModel({animationType:new TriggerAnimationTypeModel(),delay:0})}});this.subtriggerSection=new TriggerSubtriggerSectionView({collection:this.model.get('subtriggers')});this.conditionSection=new TriggerConditionSectionView({collection:this.model.get('conditions')});this.elseactionSection=new TriggerElseActionSectionView({collection:this.model.get('elseactions')});},onTriggerTime1Changed:function(e){_log('onTriggerTime1Changed',e);var value=parseFloat($(e.target).val());var opts=this.model.get('opts');var video=opts.get('video')==undefined?{}:opts.get('video');video.time1=value;opts.set('video',video);this.model.set('opts',opts);this.$el.trigger('update',this.model,this);},onTriggerTime2Changed:function(e){_log('onTriggerTime2Changed',e);var value=parseFloat($(e.target).val());var opts=this.model.get('opts');var video=opts.get('video')==undefined?{}:opts.get('video');video.time2=value;opts.set('video',video);this.model.set('opts',opts);this.$el.trigger('update',this.model,this);},onTriggerKeyboardChanged:function(e){e.preventDefault();_log('onTriggerKeyboardChanged',e);var keyCode=e.keyCode;var mappedKeyCode=Utils.mapKeyCode(keyCode);$(e.target).val(mappedKeyCode);var opts=this.model.get('opts');var keyboard=opts.get('keyboard')==undefined?{}:opts.get('keyboard');keyboard.key=keyCode;opts.set('keyboard',keyboard);this.model.set('opts',opts);this.$el.trigger('update',this.model,this);},getTemplate:function(){var whenDoIts=this.getTriggerWhenDoIt();var whenDoIt=this.model.get('whendoit');switch(whenDoIt){case'keydown':_log('getTemplate this.model',this.model)
var opts=this.model.get('opts');var keyboard=opts.get('keyboard')==undefined?{}:opts.get('keyboard');var key=keyboard.key;return this.keyboardTemplate({whendoit:whenDoIts,key:Utils.mapKeyCode(key)});break;case'onVideoTimeUpdate':_log('getTemplate this.model',this.model)
var opts=this.model.get('opts');var video=opts.get('video')==undefined?{}:opts.get('video');return this.videoTimeTemplate({whendoit:whenDoIts,video:video});break;default:return this.normalTemplate({whendoit:whenDoIts});break;}},renderOnAction:function(){var template=this.getTemplate();this.$el.find('.trigger-on-action-container').html(template);},render:function(){this.$el.show();var whenDoIt=this.model.get('whendoit');var template=this.template();this.$el.html(template);this.renderOnAction();this.$el.find('.trigger-on-select').val(whenDoIt);this.$el.append(this.subtriggerSection.render().$el);this.$el.append(this.conditionSection.render().$el);this.$el.append(this.elseactionSection.render().$el);this.delegateEvents();if(this.model.get('elseactions').length>0){this.subtriggerSection.$el.show();this.showConditionSection();this.showElseActionSection();}
if(this.model.get('conditions').length>0){this.subtriggerSection.$el.show();this.showConditionSection();this.showElseActionSection();}
if(this.model.get('subtriggers').length>0){this.subtriggerSection.$el.show();this.showConditionSection();}
if(whenDoIt!=''){this.subtriggerSection.$el.show();}
this.addTitleToButtons();return this;},resetStage:function(){this.$el.html('');this.$el.hide();},getTriggerWhenDoIt:function(){var triggerWhenDoIt=this.componentModel.getTriggerWhenDoIt();var tempArr=this.triggerWhenDoIt.toJSON().concat(triggerWhenDoIt);return tempArr;},onTriggerOnChanged:function(e){var value=$(e.target).val();this.model.set('whendoit',value);this.$el.trigger('update',this.model,this);this.renderOnAction();if(value!=''){this.subtriggerSection.showItem();}
this.$el.find('.trigger-on-select').val(value);this.addTitleToButtons();if(value=='keydown'){var keyboardInput=this.$el.find('.trigger-keyboard-input');keyboardInput.focus();keyboardInput.trigger('mouseover');this.markForAWhile(keyboardInput);}},markForAWhile:function(element){var _that=this;element.attr('mark',true);setTimeout(function(){element.attr('mark',false);},3000);},setModel:function(model){this.model=model;this.subtriggerSection.setCollection(this.model.get('subtriggers'),this.componentModel);this.conditionSection.setCollection(this.model.get('conditions'),this.componentModel);this.elseactionSection.setCollection(this.model.get('elseactions'),this.componentModel);this.subtriggerSection.$el.hide();this.conditionSection.$el.hide();this.elseactionSection.$el.hide();this.render();},addTitleToButtons:function(){this.$el.find('[title]').tooltip({html:true,animated:'fade',placement:'right',width:300,height:200});},});;;var TriggerWindowModel=WindowModel.extend({defaults:_.extend({},WindowModel.prototype.defaults,{draggable:true,modal:false})});;;var TriggerWindowView=WindowView.extend({tagName:'div',className:'window trigger-window',wrapperTemplate:_.template($('#trigger-wrapper-template').html()),triggerWhenDoIt:[],triggerWhatToDo:[],minimizeed:false,state:1,isVisible:true,events:{'select-list-item':'selectListItem','update':'update','save-asda':'update','delete-trigger':'deleteTrigger','copy-trigger':'copyTrigger','click .trigger-create-new-interaction':'creteNewInteraction','click .window-close-button':'minimize','click .trigger-maximize-button':'maximize','hide-trigger':'hideTrigger','show-trigger':'showTrigger','resize':'onResize'},afterInitialize:function(){},onResize:function(){},showTrigger:function(){this.isVisible=true;this.show();},hideTrigger:function(){this.isVisible=false;this.hide();},minimize:function(){var triggersCollection=this.model.get('triggers');if(this.minimizeed==false){if(triggersCollection.length>0){this.stage.resetStage();this.list.resetList();if(this.state==1){this.minimizeWindow();}
this.state=1;}else{this.minimizeWindow();}}},minimizeWindow:function(){this.minimizeed=true;this.state=0;this.$el.html('<div class="window-top-bar window-minimized-top-bar">            ...            </div>            <div type="button" class="trigger-maximize-button">                <div class="trigger-items-minimize-count"></div>            </div>');this.displayTriggerItemsCount();},maximize:function(){this.minimizeed=false;this.state=1;this.run();},escape:function(){if(this.isVisible){this.minimize();}},creteNewInteraction:function(){var triggerInteractionModel=this.model.createNewInteractionModel();var triggersCollection=this.model.get('triggers');this.list.addNewInteraction(triggerInteractionModel);this.render();this.selectListItem('',triggerInteractionModel);this.saveInteraction();},copyTrigger:function(event,model){var triggerString=JSON.stringify(model.toJSON());var triggerJson=JSON.parse(triggerString);var copyModel=this.model.loadOnTriggerOption(triggerJson);var triggersCollection=this.model.get('triggers');triggersCollection.add(copyModel);this.list.render();this.saveInteraction();},deleteTrigger:function(event,model){var triggersCollection=this.model.get('triggers');var index=triggersCollection.indexOf(model);triggersCollection.remove(model);var triggerInteractionModel=triggersCollection.at(index);if(triggerInteractionModel!=undefined){this.list.selectedItemModel=triggerInteractionModel;this.list.render();this.stage.setModel(triggerInteractionModel);}else{triggerInteractionModel=triggersCollection.last();if(triggerInteractionModel!=undefined){this.list.selectedItemModel=triggerInteractionModel;this.list.render();this.stage.setModel(triggerInteractionModel);}else{this.list.resetList();this.stage.resetStage();}}
this.update();},update:function(event,model){this.list.render();this.saveInteraction();},selectListItem:function(event,model){this.state=2;this.animateList();this.stage.setModel(model);this.$el.append(this.stage.render().$el);},animateList:function(data){var triggersList=this.$el.find('.trigger-list');triggersList.css({position:'absolute','border-width':'3px'});triggersList.animate({top:'-3px',left:"-"+(triggersList.width()+7)+"px"},500);},initialize:function(data){this.windowModel=data.windowModel;this.stageView=data.stageView;this.model=new TriggerModel();this.makeDraggable();this.list=new TriggerListView({collection:new TriggerInteractionCollection});this.stage=new TriggerStageView({model:new TriggerInteractionModel});},render:function(){var wrapperTemplate=this.wrapperTemplate(this.model.toJSON());this.$el.html(wrapperTemplate);this.$el.append(this.list.render().$el);this.delegateEvents();return this;},changeJsonModelToActionkeyArray:function(array){for(var j=0;j<array.length;j++){var item=array[j];var objs=item.objs;var actionkeys=_(objs).pluck('actionkey');if(actionkeys.length>0){item.objs=actionkeys;}else{var lineIds=_(item.options).pluck('id');item.objs=lineIds;}}},saveInteraction:function(callChaneges){var _that=this;callChaneges==undefined?false:callChaneges;var triggersCollection=this.model.get('triggers');var contain=triggersCollection.contains(this.triggerInteractionModel);if(!contain){triggersCollection.add(this.triggerInteractionModel);}
var triggers=triggersCollection.toJSON();this.componentModel.set('triggers',triggers,{silent:true});if(this.componentModel.miniatureView!=undefined){this.componentModel.miniatureView.renderTriggers();}
this.componentModel.trigger('change',['triggers']);this.componentModel.triggerChanged();},getModelType:function(model){var instance=model instanceof ComponentModel;if(instance==true){return _lang('TRIGGER_OBJECT');}else{return _lang('NEW_PAGE_TITLE');}},setTextToTopBar:function(model){var modelType=this.getModelType(model);this.$el.find('.window-top-bar').html(modelType);},setModel:function(componentModel){if(!StageView.instance.canEdit){this.$el.hide();}else{this.setComponentTriggerArrayToTrigger(componentModel);this.displayTriggerItemsCount();if(this.isVisible){this.state=1;if(!this.minimizeed){this.run();}
this.$el.show();}}},displayTriggerItemsCount:function(componentModel){var triggers=this.model.get('triggers');if(triggers){var minimizeCount=this.$el.find('.trigger-items-minimize-count');var count=triggers.length;minimizeCount.html(count);}},setComponentTriggerArrayToTrigger:function(componentModel){this.componentModel=componentModel;var componentTriggers=this.componentModel.get('triggers');this.triggerInteractionCollection=this.model.loadTrigger(componentTriggers,this.stageView);this.model.set('triggers',this.triggerInteractionCollection);this.componentModel.off('change:scoreSuccess');this.componentModel.off('change:scoreFail');this.componentModel.off('change:scoreBadAnswer');this.listenTo(this.componentModel,'change:scoreSuccess',this.onScoreSuccessChanged);this.listenTo(this.componentModel,'change:scoreFail',this.onScoreFailChanged);this.listenTo(this.componentModel,'change:scoreBadAnswer',this.onScoreBadAnswerChanged);},setCollection:function(collection){if(this.isVisible){this.state=1;this.componentsCollection=collection;if(!this.minimizeed){this.list.$el.hide();}
this.$el.hide();}},run:function(){this.list=new TriggerListView({collection:this.triggerInteractionCollection});this.stage=new TriggerStageView({model:this.triggerInteractionCollection.first(),componentModel:this.componentModel});this.list.$el.show();this.render();this.setTextToTopBar(this.componentModel);},openTrigger:function(){this.maximize();},onScoreSuccessChanged:function(model){var subtriggerOpts=this.findSubtriggerOpts('custom_questionpassed');var scoreSuccess=model.get('scoreSuccess');this.setScoreTrigger(subtriggerOpts,scoreSuccess,'custom_questionpassed');ProjectModel.instance.calculateAllScoreSuccessPoints();},onScoreFailChanged:function(model){var subtriggerOpts=this.findSubtriggerOpts('custom_questionfailed');var scoreFail=model.get('scoreFail');this.setScoreTrigger(subtriggerOpts,scoreFail,'custom_questionfailed');},onScoreBadAnswerChanged:function(model){var subtriggerOpts=this.findSubtriggerOpts('custom_questionbadanswer');var scoreBadAnswer=model.get('scoreBadAnswer');this.setScoreTrigger(subtriggerOpts,scoreBadAnswer,'custom_questionbadanswer');},setScoreTrigger:function(subtriggerOpts,varValue,whendoit){var triggersCollection=this.model.get('triggers');if(subtriggerOpts!=undefined&&subtriggerOpts.objs!=undefined){var objs=subtriggerOpts.objs;var triggerId=subtriggerOpts.triggerId;var subtriggerId=subtriggerOpts.subtriggerId;objs.varValue=varValue;var triggerModel=triggersCollection.at(triggerId);var subtriggerModel=triggerModel.get('subtriggers').at(subtriggerId);if(this.minimizeed==false){this.list.selectItem('change-list',triggerModel);this.selectListItem('change-list',triggerModel);}
subtriggerModel.trigger('mark-for-a-while');this.saveInteraction(false);}else{objs={};objs.varName='00000000000000000000000000000000';objs.varAction='add';objs.varValue=varValue;var interactionModel=this.model.createNewInteractionModel();interactionModel.set('whendoit',whendoit);var subtriggers=interactionModel.get('subtriggers');var triggerSubtriggerModel=this.createNewSubtrigger();triggerSubtriggerModel.set('whattodo','changevarvalue');triggerSubtriggerModel.set('objs',objs);subtriggers.add(triggerSubtriggerModel);triggersCollection.add(interactionModel);this.list.collection=triggersCollection;this.list.render();if(this.minimizeed==false){this.list.selectItem('change-list',interactionModel);this.selectListItem('change-list',interactionModel);}
this.model.set('triggers',triggersCollection);triggerSubtriggerModel.trigger('mark-for-a-while');this.saveInteraction(false);}
this.displayTriggerItemsCount();},findSubtriggerOpts:function(whenDoItSearcher){var triggers=this.componentModel.get('triggers');if(triggers==undefined){return undefined;}
for(var i=0;i<triggers.length;i++){var trigger=triggers[i];var subtriggers=trigger.subtriggers;var whenDoIt=trigger.whendoit;if(whenDoIt==whenDoItSearcher){for(var j=0;j<subtriggers.length;j++){var subtrigger=subtriggers[j];var whattodo=subtrigger.whattodo;var objs=subtrigger.objs;if(whattodo=='changevarvalue'&&objs.varName=='00000000000000000000000000000000'&&objs.varAction=='add'){return{objs:objs,triggerId:i,subtriggerId:j};}}}}
return undefined;},createNewSubtrigger:function(e){var triggerSubtriggerModel=new TriggerSubtriggerModel({whattodo:'',objs:[],opts:new TriggerOptsModel({animationType:new TriggerAnimationTypeModel(),delay:0,transition:{},notadded:true})});return triggerSubtriggerModel;},});;;var PdfListItemModel=Backbone.Model.extend({defaults:{id:'',src:'content_template/css/gif-load.gif',selected:true},updateComing:function(data){this.trigger('update-coming',data,this)}});;;var PdfListWindowModel=WindowModel.extend({defaults:{type:"",modal:true,draggable:false}});;;var PdfListItemCollection=Backbone.Collection.extend({model:PdfListItemModel});;;var PdfListItemView=Backbone.View.extend({tagName:'li',className:'pdf-list-item',template:_.template($('#pdf-list-item-template').html()),events:{'click':'selectItem','click .pdf-list-item-select-item-checkbox':'selectItem'},bindings:{'.pdf-list-item-select-item-checkbox':'selected'},initialize:function(){this.model.on(' update-coming',this.onUpdateComing,this);},selectItem:function(){var selected=this.model.get('selected');this.model.set('selected',!selected);this.render();this.$el.trigger('on-item-click');},onUpdateComing:function(data){var src=data.filePath;src=data.projectPath+data.index+data.extension;this.model.set('src',src);this.render();},render:function(){var pdfListItemTemplate=this.template(this.model.toJSON());this.$el.html(pdfListItemTemplate);this.$el.attr({selected:this.model.get('selected')});this.stickit();return this;}});;;var PdfListView=Backbone.View.extend({tagName:'div',className:'pdf-list',template:_.template($('#pdf-list-template').html()),events:{'click .pdf-list-item-select-all-checkbox':'selectAllItems','click .pdf-list-convert-to-pages':'convertToPages','on-item-click':'onItemClick'},onItemClick:function(){var ids=this.getSelectedItemsIds();var canConvert=ids.length<=0?false:true;this.disableEnableConvertButton(canConvert);},render:function(){var pdfListTemplate=this.template({});this.$el.html(pdfListTemplate);this.collection.each(this.addPdfItem,this);return this;},selectAllItems:function(e){var selected=$(e.target).prop('checked');if(selected){this.collection.each(this.selectItem,this);this.setSelectedAttributeForAllItems(true);}else{this.collection.each(this.unselectItem,this);this.setSelectedAttributeForAllItems(false);}
this.disableEnableConvertButton(selected);},disableEnableConvertButton:function(canConvert){if(!canConvert){this.$el.find('.pdf-list-convert-to-pages').attr('disabled','disabled');}else{this.$el.find('.pdf-list-convert-to-pages').removeAttr('disabled');}},setSelectedAttributeForAllItems:function(selected){this.$el.find('.pdf-list-item').attr({selected:selected});},selectItem:function(model){model.set('selected',true);},unselectItem:function(model){model.set('selected',false);},addPdfItem:function(pdfItemModel,index){var _that=this;var pdfListItemView=new PdfListItemView({model:pdfItemModel});var itemEl=pdfListItemView.render().$el;itemEl.addClass('pdf-list-item-'+index);this.$el.find('.pdf-list-wrapper').append(itemEl);},updateComing:function(data){var index=data.index;var model=this.collection.at(parseInt(index));if(model){model.updateComing(data);}},convertToPages:function(){this.$el.trigger('close-window',{},this);},getSelectedItemsIds:function(){var results=_.pluck(_.where(this.collection.toJSON(),{selected:true}),'id');return results;}});;;var PdfListWindowView=WindowView.extend({tagName:'div',className:'window pdf-list-window',template:_.template($('#window-pdf-list-template').html()),events:function(){return _.extend({},WindowView.prototype.events,{'close':'closeWindow','close-window':'closeWindow'});},initialize:function(data){var _that=this;this.windowModel=data.windowModel;this.pdfListData=data.pdfListData;this.runListeners();this.collection=new PdfListItemCollection();this.pdfListView=new PdfListView({collection:this.collection});_that.createPagesList();},createPagesList:function(){var _that=this;DataAccess.createPdfImageList(this.pdfListData,function(responce){var max=responce.max;var projectPath=responce.projectPath;var extension=responce.extension;var thumbs=responce.thumbs;var pdfFileName=responce.fileName;_that.pdfFileName=pdfFileName;_that.projectPath=projectPath;_that.extension=extension;for(var i=0;i<max;i++){var src='';if(i<thumbs){src=projectPath+i+extension;}
var pdfListItemModel=new PdfListItemModel({id:i});pdfListItemModel.set('id',i);if(src!=''){pdfListItemModel.set('src',src);}
_that.collection.add(pdfListItemModel);};_that.pdfListView.render();},function(responce){_log('convertPdfToImage',responce,_log.dataaccessOutFault);},function(responce){},function(responce){responce.projectPath=_that.projectPath;responce.extension=_that.extension;_that.pdfListView.updateComing(responce);});},onClose:function(){DataAccess.stopCreatePdfImageList({},function(responce){_log('stopCreatePdfImageList result',responce,_log.dataaccessOutResult);},function(responce){_log('stopCreatePdfImageList fault',responce,_log.dataaccessOutFault);});this.trigger('on-close');},onResult:function(){},afterRender:function(){this.$el.find('.pdf-list-wrapper').html(this.pdfListView.render().$el);},closeWindow:function(){var ids=this.pdfListView.getSelectedItemsIds();if(ids.length<=0){return;}
var toSend={fileName:this.pdfFileName,ids:ids};var addNewPageProgressWindow=WindowFactory.createAddNewPageProgressWindow(toSend);$('body').append(addNewPageProgressWindow.render().$el);this.trigger('on-start-converting');this.close();},onClose:function(){this.trigger('close-parent-window');}});;;var AddNewPageProgressView=WindowView.extend({tagName:'div',className:'window add-new-page-progress-window animated pulse',template:_.template($('#window-add-new-page-progress-template').html()),events:function(){return _.extend({},WindowView.prototype.events,{'click .add-new-page-progress-cancel':'addNewPageCancel'});},initialize:function(data){var _that=this;this.windowModel=data.windowModel;this.addNewPageData=data.addNewPageData;this.runListeners();var fileName=data.addNewPageData.fileName;var ids=data.addNewPageData.ids;this.ids=ids;DataAccess.createPdfImageList({fileName:fileName,createThumbs:false},function(responce){if(_that.ids==undefined){_that.ids=[];for(var i=0;i<responce.max;i++){_that.ids[i]=i;};}
_that.max=_that.ids.length;var index=0;percent=Math.round(((index+1)/ _that.max)*100);_that.showProcessContent(index);_that.showProgressPercent({percent:percent});_that.convertPdfPageToImage(fileName,_that.ids.shift());},function(){},function(){},function(){});},convertPdfPageToImage:function(fileName,pdfPageId){var _that=this;var pagesList=ProjectView.instance.pagesList;var newPageModel=ProjectModel.instance.createNewPageModel();pagesList.addNewPdfPage(newPageModel,function(createdPageModel){pagesList.render();pagesList.afterRender();_that.onAddPageResult(createdPageModel,fileName,pdfPageId);},function(data){_that.onAddPageFault(data);});},onAddPageResult:function(pageModel,fileName,pdfPageId){var _that=this;_log('onAddPageResult pageModel',pageModel);var pageId=pageModel.get('options').get('pageid');var pageWidth=StageView.instance.model.get('options').get('width');var pageHeight=StageView.instance.model.get('options').get('height');_log('parems',{pageId:pageId,fileName:fileName,pdfPageId:pdfPageId,pageWidth:pageWidth,pageHeight:pageHeight});DataAccess.convertPdfPageToImage({pageId:pageId,fileName:fileName,pdfPageId:pdfPageId,pageWidth:pageWidth,pageHeight:pageHeight},function(responce){var pageHeight=responce.height;pageModel.get('options').set('image',responce.fileName,{silent:true});pageModel.view.render();pageModel.view.afterRender();pageModel.get('options').set('height',pageHeight,{silent:true});pageModel.get('options').set('width',pageWidth,{silent:true});pageModel.get('options').trigger('change');var max=parseInt(_that.max);var index=_that.max-_that.ids.length;percent=Math.round(((index+1)/ max)*100);if(_that.ids.length>0){_that.showProcessContent(index+1);_that.showProgressPercent({percent:percent});_that.convertPdfPageToImage(fileName,_that.ids.shift());}else{_that.hideProgressPercent();_that.showFinishContent();setTimeout(function(){_that.close();},2000);}},function(responce){_log('convertPdfPageToImage',responce,_log.dataaccessOutFault);});},showProcessContent:function(index){this.$el.find('.add-new-page-progress-text').html(_lang('PDF_PROGRESS_TITLE'));},showFinishContent:function(){this.$el.find('.add-new-page-progress-text').html(_lang('PDF_PROGRESS_FINISHED'));this.$el.removeClass('animated pulse');},onAddPageFault:function(responce){},addNewPageCancel:function(){this.ids=[];this.close();},startUploading:function(){},onClose:function(){this.ids=[];this.trigger('on-close');},showProgressPercent:function(data){this.$el.find('.progress-bar').fadeIn(500);var percentage=parseInt(data.percent);this.$el.find('.progress-bar-text').text(percentage+'%');this.$el.find('.progress-bar-inner').css('width',percentage+'%');},hideProgressPercent:function(data){var _that=this;this.$el.find('.progress-bar-text').text('100%');this.$el.find('.progress-bar-inner').css('width','100%');_that.$el.find('.progress-bar').fadeOut(500,function(){});}});;;var AddNewPageProgressModel=WindowModel.extend({defaults:{type:"",modal:false,draggable:true,title:"Progress",content:""}});;;var CropWindowView=WindowView.extend({tagName:'div',className:'window window-view crop-window-view editor-window',template:_.template($('#crop-window-template').html()),imageSrc:'',cropCoords:{x:0,y:0,w:100,h:100},events:function(){return _.extend({},WindowView.prototype.events,{'click .image-crop-button-ok':'cropImage','click .image-crop-button-cancel':'close'});},cropImage:function(){var _that=this;this.showLoader();DataAccess.cropImage({cropCoords:_that.cropCoords,link:_that.link},function(data){_that.hideLoader();_that.trigger('on-crop-image',data);_that.close();},function(data){_log('data',data);_that.hideLoader();});},initialize:function(data){var path=__meta__.projects_link+__meta__.ownerID+'/'+__meta__.projectID+'/pre/exported_view/';this.link=data.imgSrc;this.imageSrc=path+data.imgSrc;this.componentModel=data.componentModel;this.windowModel=new WindowModel();this.runListeners();},afterRender:function(){var _that=this;this.$el.find('.image-crop').attr('src',this.imageSrc+'?r='+new Date().getTime()).hide();this.$el.find('.image-crop').Jcrop({boxWidth:($(document).width()),boxHeight:($(document).height()-130),bgColor:'white',onSelect:function(c){_that.cropCoords={x:parseInt(c.x),y:parseInt(c.y),w:parseInt(c.w),h:parseInt(c.h)}}},function(){this.setSelect([0,0,200,200]);});},runListeners:function(){},onClose:function(){this.trigger('on-close');},showLoader:function(){this.windowLoader=PreloaderFactory.createCropWindowLoader();this.$el.append(this.windowLoader.render().$el);},hideLoader:function(){if(this.windowLoader){this.windowLoader.remove();}},});;;var QuizfillInBlanksOptionsWindowModel=Backbone.Model.extend({defaults:{type:"",draggable:true,modal:false}});;;var QuizfillInBlanksOptionsWindowView=WindowView.extend({tagName:'div',className:'window window-quiz-fillinblanks-options-view',template:_.template($('#window-quiz-fillinblanks-options-view-template').html()),events:function(){return _.extend({},WindowView.prototype.events,{'click span.tag span':'changeAnswerStatus'});},afterInitialize:function(data){_log('data',data);this.answerData=data.data.answerData;this.componentModel=data.data.componentModel;this.componentView=data.data.componentView;this.answerId=data.data.answerId;},initTags:function(){var _that=this;this.goodAnswersInput=this.$el.find('.quizfillinblanks-goodanswers');this.goodAnswersInput.val('');this.goodAnswersInput.tagsInput({defaultText:_lang('FORM_INPUT_ADDTAG'),height:'auto',width:'auto',onAddTag:function(){_that.updateGoodAnswers();},onRemoveTag:function(){_that.updateGoodAnswers();}});var answersAsTags='';_log('this.answerData',this.answerData);var possibleAnswers=this.answerData.goodanswers;for(var i=0;i<=possibleAnswers.length-1;i++){var possibleAnswerObject=possibleAnswers[i];answersAsTags+=possibleAnswerObject.text+';|';};_log('answersAsTags',answersAsTags);this.goodAnswersInput.importTags(answersAsTags);this.$el.find('.tagsinput').sortable({update:function(){_that.updateGoodAnswers();},items:"> span.tag"});this.renderAnswersStatus();this.$el.find('.addtaginput input').focus();},changeAnswerObjectStatus:function(answerText){var possibleAnswers=this.answerData.goodanswers;for(var i=0;i<=possibleAnswers.length-1;i++){var possibleAnswerObject=possibleAnswers[i];if(possibleAnswerObject.text.trim()==answerText){possibleAnswerObject.iscorrect=!possibleAnswerObject.iscorrect;this.trigger('answerChange',this.answerData);return possibleAnswerObject.iscorrect;}};},renderAnswersStatus:function(){var possibleAnswers=this.answerData.goodanswers;for(var i=0;i<=possibleAnswers.length-1;i++){var possibleAnswerObject=possibleAnswers[i];var answerText=possibleAnswerObject.text.trim();var answerStatus=possibleAnswerObject.iscorrect;var color=answerStatus?'#cde69c':'#f00';var ob=this.$el.find('.tagsinput .tag:contains("'+answerText+'")');if(ob){ob.css({'background-color':color}).attr({'iscorrect':answerStatus});}};},changeAnswerStatus:function(e){var ob=$(e.currentTarget);var answerText=ob.text().trim();var answerStatus=this.changeAnswerObjectStatus(answerText);var color=answerStatus?'#cde69c':'#f00';ob.parent().css({'background-color':color}).attr({'iscorrect':answerStatus});},getTypedAnswers:function(){var tags=this.$el.find('.tagsinput .tag');var answersObject={};var iterator=0;tags.each(function(){answersObject[iterator]={text:$(this).find('span').text().trim(),iscorrect:$(this).find('span').attr('iscorrect')};iterator++;});return answersObject;},updateGoodAnswers:function(){_log('this.goodAnswersInput.val()',this.goodAnswersInput.val());var typedAnswers=this.getTypedAnswers();var answersArray=[];for(var typedAnswer in typedAnswers){answersArray.push({text:typedAnswers[typedAnswer].text,iscorrect:typedAnswers[typedAnswer].iscorrect||true});this.answerData.goodanswers=answersArray;};if(this.answerData.type=='select'){this.updateHtmlContent(answersArray);}
this.trigger('answerChange',this.answerData);},updateHtmlContent:function(answersArray){var input=this.componentView.$el.find('[aid="'+this.answerId+'"]');var optionsHtml='';for(var i=0;i<=answersArray.length-1;i++){var answer=answersArray[i];answerText=answer.text;optionsHtml+='<option>'+answerText+'</option>';};input.html(optionsHtml);}});;;function WindowFactory(){}
WindowFactory.createModalWindow=function(){var windowModel=new WindowModel({type:"modal",modal:true});var windowView=new WindowModalView({windowModel:windowModel});return windowView;}
WindowFactory.createProjectVersionWindow=function(){var windowModel=new ProjectVersionWindowModel({modal:true});var windowView=new ProjectVersionWindowView({windowModel:windowModel});return windowView;}
WindowFactory.createBorderWindow=function(){var windowModel=new BorderWindowModel({modal:false,draggable:true});var windowView=new BorderWindowView({windowModel:windowModel});return windowView;}
WindowFactory.createImageWindow=function(activeTab,sender){var windowModel=new ImagesWindowModel({modal:true});var windowView=new ImagesWindowView({windowModel:windowModel,activeTab:activeTab,sender:sender});return windowView;}
WindowFactory.createVideoWindow=function(){var windowModel=new VideoWindowModel({modal:true});var windowView=new VideoWindowView({windowModel:windowModel});return windowView;}
WindowFactory.createExportWindow=function(){var windowModel=new ExportWindowModel({modal:true});var windowView=new ExportWindowView({windowModel:windowModel});return windowView;}
WindowFactory.createImportWindow=function(){var windowModel=new ImportWindowModel({modal:true});var windowView=new ImportWindowView({windowModel:windowModel});return windowView;}
WindowFactory.createNewpageWindow=function(){var windowModel=new NewpageWindowModel({modal:true});var windowView=new NewpageWindowView({windowModel:windowModel});return windowView;}
WindowFactory.createStartingNewpageWindow=function(){var windowModel=new StartingNewpageWindowModel({modal:true});var windowView=new StartingNewpageWindowView({windowModel:windowModel});return windowView;}
WindowFactory.createPublishWindow=function(){var windowModel=new PublishWindowModel({modal:true});var windowView=new PublishWindowView({windowModel:windowModel});return windowView;}
WindowFactory.createCreateNewVariableWindow=function(){var windowModel=new CreateNewVariableWindowModel({modal:true});var windowView=new CreateNewVariableWindowView({windowModel:windowModel});return windowView;}
WindowFactory.createAnimateWindow=function(animtionData){var windowModel=new AnimationWindowModel({modal:true});var windowView=new AnimationView({windowModel:windowModel,animtionData:animtionData});return windowView;}
WindowFactory.createLibraryWindow=function(){var windowModel=new LibraryWindowModel({modal:true});var windowView=new LibraryWindowView({windowModel:windowModel});return windowView;}
WindowFactory.createProjectOptionsWindow=function(){var windowModel=new ProjectOptionsWindowModel({modal:true});var windowView=new ProjectOptionsWindowView({windowModel:windowModel});return windowView;}
WindowFactory.createShareWindow=function(){var windowModel=new ShareWindowModel({modal:true});var windowView=new ShareWindowView({windowModel:windowModel});return windowView;}
WindowFactory.createPreviewWindow=function(){var windowModel=new PreviewWindowModel({modal:true});var windowView=new PreviewWindowView({windowModel:windowModel});return windowView;}
WindowFactory.createTriggerWindow=function(){var windowModel=new TriggerWindowModel({modal:true});var windowView=new TriggerWindowView({windowModel:windowModel});return windowView;}
WindowFactory.createAddNewPageProgressWindow=function(addNewPageData){var windowModel=new AddNewPageProgressModel();var windowView=new AddNewPageProgressView({windowModel:windowModel,addNewPageData:addNewPageData});return windowView;}
WindowFactory.createPdfListWindow=function(pdfListData){var windowModel=new PdfListWindowModel();var windowView=new PdfListWindowView({windowModel:windowModel,pdfListData:pdfListData});return windowView;}
WindowFactory.createExportHtml5Window=function(){var windowModel=new WindowModel({draggable:false,modal:true});var windowView=new ExportHtmlWindowView({windowModel:windowModel});return windowView;}
WindowFactory.createExportScormWindow=function(){var windowModel=new WindowModel({draggable:false,modal:true});var windowView=new ExportScormWindowView({windowModel:windowModel});return windowView;}
WindowFactory.createExportPdfWindow=function(){var windowModel=new WindowModel({draggable:false,modal:true});var windowView=new ExportPdfWindowView({windowModel:windowModel});return windowView;}
WindowFactory.createMailingWindow=function(projectModel){var windowModel=new MailingWindowModel();var windowView=new MailingWindowView({windowModel:windowModel,model:projectModel});return windowView;}
WindowFactory.createGeneratePdfProgressWindow=function(data){var windowModel=new WindowModel({modal:false});var windowView=new GeneratePdfProgressView({windowModel:windowModel,data:data});return windowView;}
WindowFactory.createGraphBaizerPrevievWindow=function(data){var windowModel=new BaizerWindowModel({modal:false});var windowView=new BaizerWindowView({windowModel:windowModel,data:data});return windowView;}
WindowFactory.createTestDriveWindow=function(data){var windowModel=new TestDriveWindowModel();var windowView=new TestDriveWindowView({windowModel:windowModel,data:data});return windowView;}
WindowFactory.createTimerWindow=function(data){var windowModel=new TimerWindowModel();var windowView=new TimerWindowView({windowModel:windowModel,data:data});return windowView;}
WindowFactory.createFunctionNotAvailableWindow=function(data){var windowModel=new FunctionNotAvailableWindowModel();var windowView=new FunctionNotAvailableWindowView({windowModel:windowModel,data:data});return windowView;}
WindowFactory.createPhotopeaWindow=function(data){var windowModel=new PhotopeaWindowModel();var windowView=new PhotopeaWindowView({windowModel:windowModel,data:data});return windowView;}
WindowFactory.createPasteComponentsWindow=function(data){var windowModel=new PasteComponentsWindowModel();var windowView=new PasteComponentsWindowView({windowModel:windowModel,data:data});return windowView;}
WindowFactory.createSoundManagerWindow=function(data){var windowModel=new SoundManagerWindowModel();var windowView=new SoundManagerWindowView({windowModel:windowModel,data:data});return windowView;}
WindowFactory.createQuizfillInBlanksOptionsWindow=function(data){var windowModel=new QuizfillInBlanksOptionsWindowModel();var windowView=new QuizfillInBlanksOptionsWindowView({windowModel:windowModel,data:data});return windowView;}
WindowFactory.createEditorConatinerWindow=function(data){var windowModel=new EditorConatinerWindowModel();var windowView=new EditorConatinerWindowView({windowModel:windowModel,data:data});return windowView;}
WindowFactory.createAddMultiComponentsWindow=function(data){var windowModel=new AddMultiComponentsWindowModel();var windowView=new AddMultiComponentsWindowView({windowModel:windowModel,data:data});return windowView;};;var ContainerEditWindowView=WindowView.extend({tagName:'div',className:'window window-view containereditorwindow-view editor-window',template:_.template($('#containereditorwindow-template').html()),events:function(){return _.extend({},WindowView.prototype.events,{'click input[name="dropandhide"]':'changeDropAndHide','click input[name="onlygoodanswers"]':'changeOnlyGoodAnswers','click input[name="forcegoodsequence"]':'changeForceGoodSequence','click input[name="autoarrangeanswers"]':'changeAutoArrangeAnswers','change .dnd-afterbadanswer-select':'changeRevertType','change input[name="maxanswers"]':'changeMaxAnswers','keyup input[name="maxanswers"]':'changeMaxAnswers','change input[name="enoughanswers"]':'changeEnoughAnswers','keyup input[name="enoughanswers"]':'changeEnoughAnswers'});},changeMaxAnswers:function(e){var answers=this.componentModel.get('answers');answers[this.containerActionkey].opts.maxAnswers=$(e.target).val();this.componentModel.set('answers',answers);this.componentModel.trigger('change');},changeEnoughAnswers:function(e){var answers=this.componentModel.get('answers');answers[this.containerActionkey].opts.enoughAnswers=$(e.target).val();this.componentModel.set('answers',answers);this.componentModel.trigger('change');},changeRevertType:function(e){var answers=this.componentModel.get('answers');answers[this.containerActionkey].opts.revertType=$(e.target).val();this.componentModel.set('answers',answers);this.componentModel.trigger('change');},changeDropAndHide:function(e){var answers=this.componentModel.get('answers');answers[this.containerActionkey].opts.dropandhide=$(e.target).is(':checked');this.componentModel.set('answers',answers);this.componentModel.trigger('change');},changeOnlyGoodAnswers:function(e){var answers=this.componentModel.get('answers');answers[this.containerActionkey].opts.onlygoodanswers=$(e.target).is(':checked');this.componentModel.set('answers',answers);this.componentModel.trigger('change');},changeForceGoodSequence:function(e){var answers=this.componentModel.get('answers');answers[this.containerActionkey].opts.forceGoodSequence=$(e.target).is(':checked');this.componentModel.set('answers',answers);this.componentModel.trigger('change');},changeAutoArrangeAnswers:function(e){var answers=this.componentModel.get('answers');answers[this.containerActionkey].opts.autoArrangeAnswers=$(e.target).is(':checked');this.componentModel.set('answers',answers);this.componentModel.trigger('change');},initialize:function(data){this.componentModel=data.componentModel;this.containerActionkey=data.containerActionkey;this.windowModel=new WindowModel();this.runListeners();},afterRender:function(){},runListeners:function(){},onClose:function(){this.trigger('on-close');}});;;var AllContainerEditWindowView=WindowView.extend({tagName:'div',className:'window window-view containereditorwindow-view editor-window',template:_.template($('#containereditorwindow-template').html()),events:function(){return _.extend({},WindowView.prototype.events,{'click input[name="dropandhide"]':'changeDropAndHide','click input[name="onlygoodanswers"]':'changeOnlyGoodAnswers','click input[name="forcegoodsequence"]':'changeForceGoodSequence','click input[name="autoarrangeanswers"]':'changeAutoArrangeAnswers','change .dnd-afterbadanswer-select':'changeRevertType','change input[name="maxanswers"]':'changeMaxAnswers','keyup input[name="maxanswers"]':'changeMaxAnswers','change input[name="enoughanswers"]':'changeEnoughAnswers','keyup input[name="enoughanswers"]':'changeEnoughAnswers'});},changeMaxAnswers:function(e){var answers=this.componentModel.get('answers');_.each(answers,function(object,key){answers[key].opts.maxAnswers=$(e.target).val();});this.componentModel.set('answers',answers);this.componentModel.trigger('change');},changeEnoughAnswers:function(e){var answers=this.componentModel.get('answers');_.each(answers,function(object,key){answers[key].opts.enoughAnswers=$(e.target).val();});this.componentModel.set('answers',answers);this.componentModel.trigger('change');},changeRevertType:function(e){var answers=this.componentModel.get('answers');_.each(answers,function(object,key){answers[key].opts.revertType=$(e.target).val();});this.componentModel.set('answers',answers);this.componentModel.trigger('change');},changeDropAndHide:function(e){var answers=this.componentModel.get('answers');_.each(answers,function(object,key){answers[key].opts.dropandhide=$(e.target).is(':checked');});this.componentModel.set('answers',answers);this.componentModel.trigger('change');},changeOnlyGoodAnswers:function(e){var answers=this.componentModel.get('answers');_.each(answers,function(object,key){answers[key].opts.onlygoodanswers=$(e.target).is(':checked');});this.componentModel.set('answers',answers);this.componentModel.trigger('change');},changeForceGoodSequence:function(e){var answers=this.componentModel.get('answers');_.each(answers,function(object,key){answers[key].opts.forceGoodSequence=$(e.target).is(':checked');});this.componentModel.set('answers',answers);this.componentModel.trigger('change');},changeAutoArrangeAnswers:function(e){var answers=this.componentModel.get('answers');_.each(answers,function(object,key){answers[key].opts.autoArrangeAnswers=$(e.target).is(':checked');});this.componentModel.set('answers',answers);this.componentModel.trigger('change');},initialize:function(data){this.componentModel=data.componentModel;this.containerActionkey=data.containerActionkey;this.windowModel=new WindowModel();this.runListeners();},afterRender:function(){this.$el.css({left:'90px',top:'90px'});},runListeners:function(){},onClose:function(){this.trigger('on-close');}});;;var DnDOptionsWindowView=WindowView.extend({tagName:'div',className:'window window-view dndoptionswindow-view editor-window',template:_.template($('#dndoptionswindow-template').html()),events:function(){return _.extend({},WindowView.prototype.events,{'click input[name="revertobjects"]':'changeRevertObjects','click input[name="feedbacks"]':'changeFeedbacks','click input[name="disableongooddrop"]':'changeDisableOnGoodDrop','click input[name="mark-questions"]':'markQuestions'});},markQuestions:function(e){var opts=this.componentModel.get('opts');opts.markQuestions=$(e.target).is(':checked');this.componentModel.set('opts',opts);this.componentModel.trigger('change');},changeRevertObjects:function(e){var opts=this.componentModel.get('opts');opts.revertObjects=$(e.target).is(':checked');this.componentModel.set('opts',opts);this.componentModel.trigger('change');},changeFeedbacks:function(e){var feedbackShow=$(e.target).is(':checked');this.componentModel.set('feedbackShow',feedbackShow);},changeDisableOnGoodDrop:function(e){var opts=this.componentModel.get('opts');opts.disableOnGoodDrop=$(e.target).is(':checked');this.componentModel.set('opts',opts);this.componentModel.trigger('change');},initialize:function(data){this.componentModel=data.componentModel;this.windowModel=new WindowModel();this.runListeners();},afterRender:function(){},runListeners:function(){},onClose:function(){this.trigger('on-close');}});;;var FormSubmitOptionsWindowView=WindowView.extend({tagName:'div',className:'window window-view formsubmitoptionswindow-view editor-window',template:_.template($('#formsubmitoptionswindow-template').html()),bindings:{'.feedbacks':'feedbacks'},initialize:function(data){this.model=data.componentModel;this.windowModel=new WindowModel();},afterRender:function(){this.stickit();},onClose:function(){this.trigger('on-close');}});;;var QclConnectionEditWindowView=WindowView.extend({tagName:'div',className:'window window-view qclconnectioneditorwindow-view editor-window',template:_.template($('#qclconnectioneditorwindow-template').html()),events:function(){return _.extend({},WindowView.prototype.events,{'change .qcl-option-align':'changeAlign','change input[name="linewidth"]':'changeLineWidht','change input[name="size"]':'changeSize','change input[name="maxconnections"]':'changeMaxConnections'});},changeAlign:function(e){var objs=this.componentModel.get('objs');var answers=this.componentModel.get('answers');var _objs=[];if(answers[this.line].form!=='')
_objs.push(answers[this.line].from);_.each(answers[this.line].to,function(actionkey,index){_objs.push(actionkey);});_.each(_objs,function(object,key){objs[object].align=$(e.target).val();});this.componentModel.set('objs',objs);this.componentModel.trigger('change');this.componentModel.view.paintDots();},changeLineWidht:function(e){var objs=this.componentModel.get('objs');var answers=this.componentModel.get('answers');var _objs=[];if(answers[this.line].form!=='')
_objs.push(answers[this.line].from);_.each(answers[this.line].to,function(actionkey,index){_objs.push(actionkey);});_.each(_objs,function(object,key){objs[object].lineWidth=$(e.target).val();});this.componentModel.set('objs',objs);this.componentModel.trigger('change');this.componentModel.view.paintDots();},changeSize:function(e){var objs=this.componentModel.get('objs');var answers=this.componentModel.get('answers');var _objs=[];if(answers[this.line].form!=='')
_objs.push(answers[this.line].from);_.each(answers[this.line].to,function(actionkey,index){_objs.push(actionkey);});_.each(_objs,function(object,key){objs[object].size=$(e.target).val();});this.componentModel.set('objs',objs);this.componentModel.trigger('change');this.componentModel.view.paintDots();},changeMaxConnections:function(e){var objs=this.componentModel.get('objs');var answers=this.componentModel.get('answers');var _objs=[];if(answers[this.line].form!=='')
_objs.push(answers[this.line].from);_.each(answers[this.line].to,function(actionkey,index){_objs.push(actionkey);});_.each(_objs,function(object,key){objs[object].maxConnections=$(e.target).val();});this.componentModel.set('objs',objs);this.componentModel.trigger('change');},initialize:function(data){this.componentModel=data.componentModel;this.line=data.line;this.windowModel=new WindowModel();this.runListeners();},afterRender:function(){var _that=this;var objs=this.componentModel.get('objs');var answers=this.componentModel.get('answers');var connectionColor=objs[answers[this.line].from].color;this.colorPickerConnection=new ColorPickerView({color:connectionColor});this.$el.find('.connection-color-picker').html(this.colorPickerConnection.render().$el);this.colorPickerConnection.on('move',function(data){objs[answers[_that.line].from].color=data.color;_.each(answers[_that.line].to,function(val){objs[val].color=data.color;});_that.componentModel.set('objs',objs);_that.componentModel.view.paintDots();});this.colorPickerConnection.on('change',function(data){_that.componentModel.trigger('change');});this.colorPickerConnection.on('hide',function(data){_that.colorPickerConnection.updateColorPicker({color:objs[answers[_that.line].from].color});});},runListeners:function(){},onClose:function(){this.trigger('on-close');}});;;var QclAllConnectionsEditWindowView=WindowView.extend({tagName:'div',className:'window window-view qclconnectioneditorwindow-view editor-window',template:_.template($('#qclconnectioneditorwindow-template').html()),events:function(){return _.extend({},WindowView.prototype.events,{'change .qcl-option-align':'changeAlign','change input[name="linewidth"]':'changeLineWidht','change input[name="size"]':'changeSize','change input[name="maxconnections"]':'changeMaxConnections'});},changeAlign:function(e){var objs=this.componentModel.get('objs');_.each(objs,function(object,key){object.align=$(e.target).val();});this.componentModel.set('objs',objs);this.componentModel.trigger('change');this.componentModel.view.paintDots();},changeLineWidht:function(e){var objs=this.componentModel.get('objs');_.each(objs,function(object,key){object.lineWidth=$(e.target).val();});this.componentModel.set('objs',objs);this.componentModel.trigger('change');this.componentModel.view.paintDots();},changeSize:function(e){var objs=this.componentModel.get('objs');_.each(objs,function(object,key){object.size=$(e.target).val();});this.componentModel.set('objs',objs);this.componentModel.trigger('change');this.componentModel.view.paintDots();},changeMaxConnections:function(e){var objs=this.componentModel.get('objs');_.each(objs,function(object,key){object.maxConnections=$(e.target).val();});this.componentModel.set('objs',objs);this.componentModel.trigger('change');},initialize:function(data){this.componentModel=data.componentModel;this.containerActionkey=data.containerActionkey;this.windowModel=new WindowModel();this.runListeners();},afterRender:function(){var _that=this;var objs=this.componentModel.get('objs');var answers=this.componentModel.get('answers');var connectionColor=objs[answers[0].from].color;this.colorPickerConnection=new ColorPickerView({color:connectionColor});this.$el.find('.connection-color-picker').html(this.colorPickerConnection.render().$el);this.colorPickerConnection.on('move',function(data){_.each(objs,function(obj){obj.color=data.color;});connectionColor=data.color;_that.componentModel.set('objs',objs);_that.componentModel.view.paintDots();});this.colorPickerConnection.on('change',function(data){_that.componentModel.trigger('change');});this.colorPickerConnection.on('hide',function(data){_that.colorPickerConnection.updateColorPicker({color:connectionColor});});},runListeners:function(){},onClose:function(){this.trigger('on-close');}});;;var QclOneConnectionsEditWindowView=WindowView.extend({tagName:'div',className:'window window-view qclconnectioneditorwindow-view editor-window',template:_.template($('#qclconnectioneditorwindow-template').html()),events:function(){return _.extend({},WindowView.prototype.events,{'change .qcl-option-align':'changeAlign','change input[name="linewidth"]':'changeLineWidht','change input[name="size"]':'changeSize','change input[name="maxconnections"]':'changeMaxConnections'});},changeAlign:function(e){var actionkey=this.actionkey;var objs=this.componentModel.get('objs');var oneObject=objs[actionkey];if(oneObject){oneObject.align=$(e.target).val();}
this.componentModel.set('objs',objs);this.componentModel.trigger('change');this.componentModel.view.paintDots();},changeLineWidht:function(e){var actionkey=this.actionkey;var objs=this.componentModel.get('objs');var oneObject=objs[actionkey];if(oneObject){oneObject.lineWidth=$(e.target).val();}
this.componentModel.set('objs',objs);this.componentModel.trigger('change');this.componentModel.view.paintDots();},changeSize:function(e){var actionkey=this.actionkey;var objs=this.componentModel.get('objs');var oneObject=objs[actionkey];if(oneObject){oneObject.size=$(e.target).val();}
this.componentModel.set('objs',objs);this.componentModel.trigger('change');this.componentModel.view.paintDots();},changeMaxConnections:function(e){var actionkey=this.actionkey;var objs=this.componentModel.get('objs');var oneObject=objs[actionkey];if(oneObject){oneObject.maxConnections=$(e.target).val();}
this.componentModel.set('objs',objs);this.componentModel.trigger('change');},initialize:function(data){this.componentModel=data.componentModel;this.containerActionkey=data.containerActionkey;this.windowModel=new WindowModel();this.actionkey=data.actionkey;this.runListeners();},afterRender:function(){var _that=this;var actionkey=this.actionkey;var objs=this.componentModel.get('objs');var oneObject=objs[actionkey];var answers=this.componentModel.get('answers');var connectionColor=oneObject.color;this.colorPickerConnection=new ColorPickerView({color:connectionColor});this.$el.find('.connection-color-picker').html(this.colorPickerConnection.render().$el);this.colorPickerConnection.on('move',function(data){if(oneObject){oneObject.color=data.color;}
connectionColor=data.color;_that.componentModel.set('objs',objs);_that.componentModel.view.paintDots();});this.colorPickerConnection.on('change',function(data){_that.componentModel.trigger('change');});this.colorPickerConnection.on('hide',function(data){_that.colorPickerConnection.updateColorPicker({color:connectionColor});});},runListeners:function(){},onClose:function(){this.trigger('on-close');}});;;var QclOptionsWindowView=WindowView.extend({tagName:'div',className:'window window-view qcloptionswindow-view editor-window',template:_.template($('#qcloptionswindow-template').html()),events:function(){return _.extend({},WindowView.prototype.events,{'click input[name="onlysourcetarget"]':'changeOnlySourceTarget','click input[name="feedbacks"]':'changeFeedbacks','click input[name="allowbadanswer"]':'changeAllowBadAnswer','change .after-bad-answer':'changeAfterBadAnswer'});},changeOnlySourceTarget:function(e){var opts=this.componentModel.get('opts');opts.onlySourceTarget=$(e.target).is(':checked');this.componentModel.set('opts',opts);this.componentModel.trigger('change');},changeFeedbacks:function(e){var feedbackShow=$(e.target).is(':checked');this.componentModel.set('feedbackShow',feedbackShow);},changeAllowBadAnswer:function(e){var opts=this.componentModel.get('opts');opts.allowBadAnswer=$(e.target).is(':checked');this.componentModel.set('opts',opts);this.componentModel.trigger('change');},changeAfterBadAnswer:function(e){var opts=this.componentModel.get('opts');opts.afterBadAnswer=$(e.target).val();this.componentModel.set('opts',opts);this.componentModel.trigger('change');},initialize:function(data){this.componentModel=data.componentModel;this.windowModel=new WindowModel();this.runListeners();},afterRender:function(){},runListeners:function(){},onClose:function(){this.trigger('on-close');}});;;var CrosswordSettingWindow=WindowView.extend({tagName:'div',className:'window window-view crosswordsettingwindow-view editor-window',template:_.template($('#crosswordsettingwindow-template').html()),events:function(){return _.extend({},WindowView.prototype.events,{'click input[name="qcrossword-require-answers-to-all-questions"]':'changeRequireAnswersToAllQuestions','click input[name="qcrossword-time-limit-checkbox"]':'changeTimeLimitOption','click input[name="qcrossword-colorize-good-answer"]':'changeColorizeGoodAnswer','click input[name="qcrossword-colorize-good-word"]':'changeColorizeGoodWord','click input[name="qcrossword-colorize-crossword-after-write-last-word"]':'changeColorizeCrosswordAfterWriteLastWord','keyup input[name="qcrossword-min_answers_number"]':'changeMinAnswersNumber','keyup input[name="qcrossword-time-out"]':'changeQcrosswordTimeout'});},changeQcrosswordTimeout:function(e){var value=$(e.target).val();this.componentModel.set('qcrosswordTimeout',value);},changeMinAnswersNumber:function(e){var value=$(e.target).val();this.componentModel.set('minAnswersNumber',value);},changeColorizeCrosswordAfterWriteLastWord:function(e){var value=$(e.target).is(':checked');this.componentModel.set('colorizeCrosswordAfterWriteLastWord',value);},changeColorizeGoodWord:function(e){var value=$(e.target).is(':checked');this.componentModel.set('colorizeGoodWord',value);},changeColorizeGoodAnswer:function(e){var value=$(e.target).is(':checked');this.componentModel.set('colorizeGoodAnswer',value);},changeTimeLimitOption:function(e){var value=$(e.target).is(':checked');this.componentModel.set('timeLimitOption',value);if(value){this.$el.find('input[name="qcrossword-time-out"]').removeAttr('disabled');}else{this.$el.find('input[name="qcrossword-time-out"]').attr('disabled','');}},changeRequireAnswersToAllQuestions:function(e){var value=$(e.target).is(':checked');this.componentModel.set('requireAnswersToAllQuestions',value);if(value){this.$el.find('input[name="qcrossword-min_answers_number"]').attr('disabled','');}else{this.$el.find('input[name="qcrossword-min_answers_number"]').removeAttr('disabled');}},initialize:function(data){this.componentModel=data.componentModel;this.windowModel=new WindowModel();this.runListeners();},afterRender:function(){},runListeners:function(){},onClose:function(){this.trigger('on-close');}});;;var QuizWordsearchSettingWindow=WindowView.extend({tagName:'div',className:'window window-view quizwordsearchsettingwindow-view editor-window',template:_.template($('#quizwordsearchsettingwindow-template').html()),events:function(){return _.extend({},WindowView.prototype.events,{'click input[name="wordsearch-require-answers-to-all-questions"]':'changeRequireAnswersToAllQuestions','click input[name="wordsearch-time-limit-checkbox"]':'changeTimeLimitOption','keyup input[name="wordsearch-min_answers_number"]':'changeMinAnswersNumber','keyup input[name="wordsearch-time-out"]':'changeWordsearchTimeout'});},changeWordsearchTimeout:function(e){var value=$(e.target).val();this.componentModel.set('wordSearchTimeOut',parseInt(value));},changeMinAnswersNumber:function(e){var value=$(e.target).val();this.componentModel.set('minAnswersNumber',value);},changeTimeLimitOption:function(e){var value=$(e.target).is(':checked');this.componentModel.set('timeLimitOption',value);if(value){this.$el.find('input[name="wordsearch-time-out"]').removeAttr('disabled');}else{this.$el.find('input[name="wordsearch-time-out"]').attr('disabled','');}},changeRequireAnswersToAllQuestions:function(e){var value=$(e.target).is(':checked');this.componentModel.set('requireAnswersToAllQuestions',value);if(value){this.$el.find('input[name="wordsearch-min_answers_number"]').attr('disabled','');}else{this.$el.find('input[name="wordsearch-min_answers_number"]').removeAttr('disabled');}},initialize:function(data){this.componentModel=data.componentModel;this.windowModel=new WindowModel();this.runListeners();},afterRender:function(){},runListeners:function(){},onClose:function(){this.trigger('on-close');}});;;var PageSoundSettingWindow=LoadedWindowView.extend({tagName:'div',className:'window window-view pagesoundsettingwindow-view editor-window',template:_.template($('#pagesoundsettingwindow-template').html()),events:function(){return _.extend({},LoadedWindowView.prototype.events,{'click .upload':'uploadOnClick','click .delete-page-sound-button':'deleteSound','dragenter':'onFileDragOver','dragleave .loaded-dropzone':'onFileDragOut','drop .loaded-dropzone':'uploadOnFileDrop'});},initialize:function(data){this.componentModel=data.componentModel;this.windowModel=new WindowModel();this.runListeners();},deleteSound:function(){this.model.setFileName({fileName:''});this.render({pageModel:this.model});this.trigger('delete-sound',this.model,this);},afterRender:function(){},runListeners:function(){},onClose:function(){this.trigger('on-close');},renderAfterComplete:function(){this.render({pageModel:this.model.toJSON()});},});;;var PageNameWindowView=WindowView.extend({tagName:'div',className:'window window-view page-name-window-view editor-window',template:_.template($('#page-name-window-template').html()),events:function(){return _.extend({},WindowView.prototype.events,{'click .change-titles-pages-button':'changeTites','click .page-title-numbering-checkbox':'activeNumbering'});},initialize:function(data){this.pageCollection=data.pageCollection;this.windowModel=new WindowModel();this.runListeners();},activeNumbering:function(e){var numbering=$(e.target).is(':checked');if(numbering){$('.page-title-numbering-position-select').removeAttr('disabled');$('.page-title-numbering-input').removeAttr('disabled');}else{$('.page-title-numbering-position-select').attr('disabled','disabled');$('.page-title-numbering-input').attr('disabled','disabled');}},changeTites:function(){var pageName=$('.page-title-name-input').val();var pageNameS=pageName;var numbering=$('.page-title-numbering-checkbox').is(':checked');var numberingPosition=$('.page-title-numbering-position-select').val();var number=parseInt($('.page-title-numbering-input').val());var selectedPagesOptions=[];this.pageCollection.each(function(model){if(model.isSelected){var options=model.get('options');if(numbering){if(numberingPosition==='start'){pageNameS=number+pageName;}else{pageNameS=pageName+number;}}
options.set('pagename',pageNameS,{silent:true});selectedPagesOptions.push(options.toJSON());number++;}});this.trigger('on-pages-title-changed',selectedPagesOptions);this.close();},afterRender:function(){},runListeners:function(){},onClose:function(){this.trigger('on-close');}});;;var DeletePagesWindowView=WindowView.extend({tagName:'div',className:'window window-view page-name-window-view editor-window',template:_.template($('#delete-pages-window-template').html()),events:function(){return _.extend({},WindowView.prototype.events,{'click .delete-page-confirm':'deletePages','click .delete-page-cancel':'close'});},initialize:function(data){this.windowModel=new WindowModel();this.runListeners();},deletePages:function(){var _that=this;this.trigger('delete-pages');this.close();},afterRender:function(){},runListeners:function(){},onClose:function(){this.trigger('on-close');}});;;var AppController=Backbone.Controller.extend({editor:new EditorView(),styleEditor:new StyleEditorView(),isCreated:false,componentsCollection:new ComponentCollection(),cutComponentsCollection:new ComponentCollection(),sourcePageId:null,sourceProjectId:null,sourceUserId:null,copyStatus:'',keys:[],initialize:function(){var _that=this;var darkanEditorAplicationAPI=DarkanEditorAplicationAPI.getInstance();darkanEditorAplicationAPI.connect();$(document).bind("contextmenu",function(e){if(e.currentTarget.activeElement!=undefined){if(e.currentTarget.activeElement.localName==="input"||e.currentTarget.activeElement.localName==="textarea"||e.currentTarget.activeElement.className==='note-editable'){}else{return false;}}else{return false;}});$(document).on('mousedown',function(e){if(!$(e.target).parents().is('.context-menu')&&!$(e.target).is('.context-menu')){ContextMenuContainer.closeMenu();}});$(document.body).on('keyup paste','input[type="number"]',function(){var value=$(this).val();if(value=="")$(this).val('');});$(document).on('keydown',function(e){console.log(e);if(e.currentTarget.activeElement.localName==="input"||e.currentTarget.activeElement.localName==="textarea"||e.currentTarget.activeElement.className==='note-editable'){_log('Zaznaczony input',{},_log.error);}else{_that.keydown(e);}
return true;});$(document).on('keyup',function(e){_that.keyup(e);});$(document).on('drop',function(e){var isDarkanExtension=Utils.isDarkanExtension(e);_log('isDarkanExtension',isDarkanExtension);if(isDarkanExtension){var importWindow=WindowFactory.createImportWindow();$('body').append(importWindow.render().$el);importWindow.importPsdOnDrop(e);}});$(window).unload(function(e){if(_that.stageView!=undefined){_that.stageView.cleanBeforeClose();}});$('#scene-wrapper').mousedown(function(e){e.stopPropagation();_that.stageView.unsetActiveComponents();_that.setEditorsToStage(StageView.instance.model);});DataAccess.connect({},function(){_that.onConnect()},function(){_that.onNoConnect()});if(__meta__.userID!=-1){setInterval(function(){DataAccess.keepSession({},function(data){var dataJ=JSON.parse(data);if(!dataJ.login){window.location.href="http://"+__meta__.serverLink+"/auth/login";}},function(data){_log('data fault',data)});},60000);}},keydown:function(e){console.log('keydown '+e.which);var _that=this;if(this.keys[e.keyCode]==undefined){this.keys[e.keyCode]=true;if(this.imageWindow!=undefined){return;}
switch(e.which){case 65:if(e.ctrlKey){this.stageView.selectAllComponents();}
break;case 46:this.stageView.deleteActiveComponent();break;case 27:this.triggerView.escape();break;case 67:if(e.ctrlKey){var copyData=this.stageView.copyComponents();}
break;case 86:if(e.ctrlKey){this.stageView.pasteComponents();}
break;case 66:if(e.ctrlKey){_log('Show paste window');this.imageWindow=WindowFactory.createPasteComponentsWindow();this.imageWindow.on('paste-components',function(hash){_that.stageView.pasteComponents(hash);});this.imageWindow.on('on-close',function(){_that.imageWindow=undefined;});$('body').append(this.imageWindow.render().$el);}
break;case 88:if(e.ctrlKey){this.stageView.cutComponents();}
break;case 81:e.stopPropagation();e.preventDefault();if(e.ctrlKey){this.stageView.duplicateComponents();}
break;case 90:if(e.ctrlKey){HistoryListView.instance.back();}
break;case 89:if(e.ctrlKey){HistoryListView.instance.prev();}
break;case 37:case 38:case 39:case 40:this.stageView.moveActiveComponents(e);break;}}},keyup:function(e){delete this.keys[e.keyCode];},addComponent:function(componentType,onComponentAdded){var _that=this;var componentModel=ComponentFactory.createComponentModelByType(componentType);this.stageView.addComponent(componentModel,onComponentAdded);},openProjectVersionWindow:function(activeTab){var _that=this;var projectVersionWindow=WindowFactory.createProjectVersionWindow();$('body').append(projectVersionWindow.render().$el);},openImageWindow:function(activeTab,sender){var _that=this;var imageWindow=WindowFactory.createImageWindow(activeTab,sender);imageWindow.on('on-close',function(fileData){_that.imageWindow=undefined;});imageWindow.on('imageupload-ondrop',function(fileData){_that.addComponent('image',function(componentView){_log('fileData',fileData);componentView.uploadOnFileDrop2(fileData,true);});});imageWindow.on('imageupload-onclick',function(fileData,input){_that.addComponent('image',function(componentView){componentView.uploadOnInputData(fileData,input,true);});});imageWindow.on('imageupload-link',function(imageUrl){_that.addComponent('image',function(componentView){componentView.uploadOnLink(imageUrl,true);});});imageWindow.on('imageupload-on-paste',function(event,blob){_that.addComponent('image',function(componentView){componentView.uploadOnPaste(event,blob,true);});});$('body').append(imageWindow.render().$el);imageWindow.$el.find('.darkan-tabs').tabs("option","active",activeTab);this.imageWindow=imageWindow;},openVideoWindow:function(activeTab){var _that=this;var videoWindow=WindowFactory.createVideoWindow();videoWindow.on('imageupload-ondrop',function(fileData){_that.addComponent('video',function(componentView){componentView.uploadOnFileDrop2(fileData,true);});});videoWindow.on('imageupload-onclick',function(fileData,input){_that.addComponent('video',function(componentView){componentView.uploadOnInputData(fileData,input,false);});});videoWindow.on('putvideolink',function(data){_that.addComponent('video',function(componentView){componentView.putVideoLink(data);});});$('body').append(videoWindow.render().$el);videoWindow.$el.find('.darkan-tabs').tabs("option","active",activeTab);},openLibraryWindow:function(activeTab){var _that=this;var libraryWindow=WindowFactory.createLibraryWindow();$('body').append(libraryWindow.render().$el);libraryWindow.on('imagelibrary-onclick',function(fileData,input){_that.addComponent('image',function(componentView){componentView.createImageLibrary(fileData,input,true);});});libraryWindow.$el.find('.darkan-tabs').tabs("option","active",activeTab);},onMessageApiComming:function(e){_log('onMessageApiComming',e,_log.api);if(e.origin=='http://origin-domain.com'){if(e.data=='sizing?'){}}},onConnect:function(){var _that=this;if(this.isCreated){return;}
if(State.isTestDrive()){this.showTestDriveState();}
this.projectView=new ProjectView({model:ProjectModel.instance});this.pageModel=new PageModel();this.stageView=new StageView({model:this.pageModel});this.stageView.on('select-component',function(componentModel){_that.setEditorsToComponent(componentModel);});this.stageView.on('select-row',function(rowModel){_that.setEditorsToRow(rowModel);});this.stageView.on('select-multiple-components',function(componentsCollection){_that.setMultipleEditorToComponent(componentsCollection);});this.stageView.on('select-stage',function(stageModel){_that.setEditorsToStage(stageModel);});this.stageView.on('delete-from-cut-copy-collection',function(componetModel){_that.componentsCollection.remove(componetModel);_that.cutComponentsCollection.remove(componetModel);});this.stageView.on('imageupload-link',function(e){var imageUrl=e.originalEvent.dataTransfer.getData('text');var urlpattern=new RegExp('(http|ftp|https)://[a-z0-9\-_]+(\.[a-z0-9\-_]+)+([a-z0-9\-\.,@\?^=%&;:/~\+#]*[a-z0-9\-@\?^=%&;/~\+#])?','i');if(urlpattern.test(imageUrl)){if(e.shiftKey){_that.addComponent('infopoint-link',function(componentView){componentView.setLink(imageUrl);});}else{if(e.ctrlKey){_that.addComponent('infopoint-download',function(componentView){componentView.uploadOnDownloadFileDrop(e,false);});}else{_that.addComponent('image',function(componentView){componentView.uploadOnLink(imageUrl,true);});}}}else{_that.addComponent('text',function(componentView){componentView.setText(imageUrl);});}});this.stageView.on('imageupload-ondrop',function(e){var file=e.file;var imageName=file.name;var ext='mp3';var re=new RegExp("^.*\."+ext+"$");if(e.shiftKey){_that.addComponent('infopoint-download',function(componentView){componentView.uploadOnDownloadFileDrop(e,false);componentView.setLink(imageName);});}else{if(re.test(imageName)){_that.addComponent('infopoint-sound',function(componentView){componentView.uploadOnSoundFileDrop(e,false);});}else{if(e.ctrlKey){_that.addComponent('infopoint-download',function(componentView){componentView.uploadOnDownloadFileDrop(e,false);});}else{_that.addComponent('image',function(componentView){_log('addComponent on drop',componentView);_log('e',e);componentView.uploadOnFileDrop2(e,true);});}}}});this.stageView.on(' show-image-window',function(sender){_that.openImageWindow(0,sender)});StageView.instance=this.stageView;this.leftMenuView=new LeftMenuView({collection:toolbarItemsCollection});this.leftMenuView.on('menu-item-click',function(model){var componentType=model.get('componentName');switch(componentType){case'image':_that.openImageWindow(0);break;case'video':_that.openVideoWindow(0);break;case'library':_that.openLibraryWindow(0);break;case'shapes':_that.openLibraryWindow(4);break;case'remove':_that.stageView.deleteActiveComponent();break;default:_that.addComponent(componentType);break;}});this.bottomMenuView=new BottomMenuView();BottomMenuView.instance=this.bottomMenuView;this.rightMenuView=new RightMenuView({model:ProjectModel.instance,collection:ProjectModel.instance.collection,stage:this.stageView});this.rightMenuView.on('set-page',function(pageModel){_that.pageModel=pageModel;_that.stageView.setModel(pageModel);});this.rightMenuView.on('set-second-page',function(pageModel){_that.stageView.setSecondModel(pageModel);});this.rightMenuView.on('delete-page',function(){_that.stageView.deletePage();});this.rightMenuView.on('update-coming',function(pageModel){_that.stageView.updateComing(pageModel);});this.rightMenuView.on('update-component-coming',function(data){_that.stageView.updateComponentComing(data);});this.rightMenuView.on('update-timeline-coming',function(data){_that.stageView.updateTimelineComing(data);});this.rightMenuView.on('update-page-options-coming',function(data){_that.stageView.updatePageOptionsComing(data);});this.rightMenuView.on('update-add-components-coming',function(data){_that.stageView.updateAddComponentsComing(data);});this.rightMenuView.on('show-modal-window',function(){_that.stageView.clearStage();var newPageWindow=WindowFactory.createStartingNewpageWindow();_that.createNewPage(newPageWindow);});this.rightMenuView.on('hide-modal-window',function(data){var pageModel=data.pageModel;var collection=data.collection;if(_that.newPageWindow!=undefined){if(collection.length==1){_that.stageView.setModel(pageModel);}
_that.newPageWindow.close();_that.newPageWindow=undefined;}});this.rightMenuView.on('data-picker-picked',function(model){_that.stageView.dataPickerPicked(model);});RightMenuView.instance=this.rightMenuView;this.topMenuView=TopMenuView.create({projectModel:ProjectModel.instance});this.topMenuView.on('add-new-blank-page',function(){_that.createNewPage();});this.topMenuView.on('open-project-version-window',function(){_that.openProjectVersionWindow();});this.topMenuView.on('open-images-window',function(){_that.openImageWindow(2);});this.topMenuView.on('open-video-window',function(){_that.openVideoWindow(1);});this.topMenuView.on('imageupload-link',function(imageUrl){_that.addComponent('image',function(componentView){componentView.uploadOnLink(imageUrl,true);});});this.topMenuView.on('clear-project-popup',function(){var popup=PopupFactory.createStandardPopup({},_that.topMenuView);popup.on('ok-button-click',function(){_that.topMenuView.clearProject(function(){_that.stageView.resetStage();_that.rightMenuView.resetList();_that.rightMenuView.loadProject();},function(){});});$('body').append(popup.render({title:_lang('POPUP_DELPROJECT_TITLE'),content:_lang('POPUP_DELPROJECT_MESSAGE')}).$el);});this.topMenuView.render();this.createEditors();this.createTrigger();this.createStyles();_that.rightMenuView.loadProject();this.isCreated=true;},onNoConnect:function(data){_log('onNoConnect',data)},setEditorsToRow:function(rowModel){this.leftMenuView.turnOnDeleteButton();var componentsCollection=rowModel.get('objects');if(componentsCollection.length>0){this.timelineEditorView.destroy();this.timelineEditorView=EditorsFactory.createTimelineRowEditor();this.timelineEditorView.setCollection(componentsCollection);this.timelineEditorView.setRowModel(rowModel.get('options'));$('#botmenu-timeline-editor-wrapper').html(this.timelineEditorView.render().$el);this.timelineEditorView.afterRender();}else{this.timelineEditorView.destroy();}},setMultipleEditorToComponent:function(componentsCollection){if(componentsCollection.length>0){if(componentsCollection.length==1){this.setEditorsToComponent(componentsCollection.first());}else{this.leftMenuView.turnOnDeleteButton();this.timelineEditorView.destroy();this.timelineEditorView=EditorsFactory.createTimelineComponentsCollectionEditor();this.timelineEditorView.setCollection(componentsCollection);$('#botmenu-timeline-editor-wrapper').html(this.timelineEditorView.render().$el);this.timelineEditorView.afterRender();this.multipleSizeAndPositionEditorView.setCollection(componentsCollection);this.alignEditorView.setCollection(componentsCollection);this.editor.destroy();this.editor=EditorsFactory.createMultipleEditor();this.editor.setCollection(componentsCollection);$('#botmenu-editors-container').html(this.editor.render().$el);this.styleEditor.destroy();this.styleEditor=EditorsFactory.createMultipleEditor();this.styleEditor.setCollection(componentsCollection);$('#botmenu-styles').html(this.styleEditor.render().$el);this.multipleWcagEditorView.setCollection(componentsCollection);this.multipleParallaxeEditor.setCollection(componentsCollection);this.triggerView.setCollection(componentsCollection);this.soundEditor.destroy();this.soundEditor=this.multipleSoundEditorView;this.soundEditor.setCollection(componentsCollection);$('#botmenu-sound').html(this.soundEditor.render().$el);if(this.reportEditor){this.reportEditor.destroy();}
this.reportEditor=this.multipleReportEditorView;this.reportEditor.setCollection(componentsCollection);$('#botmenu-report').html(this.reportEditor.render().$el);this.scoreExerciseEditorView.setModel(componentsCollection);}}else{this.setEditorsToStage(this.stageView.model);this.scoreExerciseEditorView.setModel(componentsCollection);}},setEditorsToStage:function(stageModel){this.leftMenuView.turnOffDeleteButton();var pageOptions=stageModel.get('options');this.timelineEditorView.destroy();this.timelineEditorView=EditorsFactory.createTimelineStageEditor();this.timelineEditorView.setModel(pageOptions);$('#botmenu-timeline-editor-wrapper').html(this.timelineEditorView.render().$el);this.timelineEditorView.afterRender();this.sizeAndPositionEditorView.setModel(pageOptions);this.scoreEditorView.setModel();this.pagenoteEditorView.setModel(pageOptions);this.wcagEditorView.setModel(pageOptions);this.parallaxeEditorView.setModel(pageOptions);this.alignEditorView.deactivate();this.styleEditor.destroy();this.styleEditor=this.stageStyleEditor;this.styleEditor.setModel(pageOptions);$('#botmenu-styles').html(this.styleEditor.render().$el);this.styleEditor.afterRender();this.editor.destroy();this.editor=this.stageEditorView;this.editor.setModel(pageOptions);$('#botmenu-editors-container').html(this.editor.render().$el);this.editor.afterRender();this.triggerView.setModel(pageOptions);this.soundEditor.destroy();this.soundEditor=this.soundEditorView;this.soundEditor.setModel(stageModel);$('#botmenu-sound').html(this.soundEditor.render().$el);this.scoreExerciseEditorView.setModel(this.stageView.selectedComponentsCollection);if(this.reportEditor){this.reportEditor.destroy();}},setEditorsToComponent:function(componentModel){this.leftMenuView.turnOnDeleteButton();this.timelineEditorView.destroy();this.timelineEditorView=EditorsFactory.createTimelineComponentEditor();this.timelineEditorView.setModel(componentModel);$('#botmenu-timeline-editor-wrapper').html(this.timelineEditorView.render().$el);this.timelineEditorView.afterRender();this.sizeAndPositionEditorView.setModel(componentModel);this.wcagEditorView.setModel(componentModel);this.parallaxeEditorView.setModel(componentModel);this.alignEditorView.deactivate();this.triggerView.setModel(componentModel);var type=componentModel.get('type');var editor=this.editor;editor.destroy();this.styleEditor.destroy();if(this.reportEditor){this.reportEditor.destroy();this.reportEditor=undefined;}
switch(type){case'text':case'quiz-result':editor=EditorsFactory.createTextEditor();this.textToolbarEditorView.setModel(componentModel);this.styleEditor=StyleEditorsFactory.createTextEditor();break;case'timer':editor=EditorsFactory.createTimerEditor();this.textToolbarEditorView.setModel(componentModel);this.styleEditor=StyleEditorsFactory.createTimerEditor();break;case'image':editor=EditorsFactory.createImageEditor();this.styleEditor=StyleEditorsFactory.createImageEditor();break;case'video':editor=EditorsFactory.createVideoEditor();this.styleEditor=StyleEditorsFactory.createVideoEditor();break;case'quiz':editor=EditorsFactory.createQuizEditor();this.styleEditor=StyleEditorsFactory.createQuizEditor();this.reportEditor=this.reportEditorView;break;case'quiz-selectone':editor=EditorsFactory.createQuizSelectOneEditor();this.styleEditor=StyleEditorsFactory.createQuizSelectOneEditor();this.reportEditor=this.reportEditorView;break;case'quiz-fillinblinds':editor=EditorsFactory.createQuizFillInBlanksEditor();this.styleEditor=StyleEditorsFactory.createQuizFillInBlanksEditor();this.reportEditor=this.reportEditorView;break;case'quiz-dnd':editor=EditorsFactory.createQuizDnDEditor(this.stageView);this.styleEditor=StyleEditorsFactory.createQuizDnDEditor(this.stageView);this.reportEditor=this.reportEditorView;break;case'quiz-connectlines':editor=EditorsFactory.createQuizConnectLinesEditor(this.stageView);this.styleEditor=StyleEditorsFactory.createQuizConnectLinesEditor(this.stageView);this.reportEditor=this.reportEditorView;break;case'quiz-wordsearch':editor=EditorsFactory.createQuizWordsearchEditor(this.stageView);this.styleEditor=StyleEditorsFactory.createQuizWordsearchEditor(this.stageView);this.reportEditor=this.reportEditorView;break;case'scroller':editor=EditorsFactory.createScrollerEditor();this.styleEditor=StyleEditorsFactory.createScrollerEditor();break;case'crossword':editor=EditorsFactory.createCrosswordEditor();this.styleEditor=StyleEditorsFactory.createCrosswordEditor();this.reportEditor=this.reportEditorView;break;case'form-inputtext':editor=EditorsFactory.createFormInputTextEditor();this.styleEditor=StyleEditorsFactory.createFormInputTextEditor();this.reportEditor=this.reportEditorView;break;case'form-upload':editor=EditorsFactory.createFormUploadEditor();this.styleEditor=StyleEditorsFactory.createFormUploadEditor();break;case'form-textarea':editor=EditorsFactory.createFormTextareaEditor();this.styleEditor=StyleEditorsFactory.createFormTextareaEditor();this.reportEditor=this.reportEditorView;break;case'form-select':editor=EditorsFactory.createFormSelectEditor();this.styleEditor=StyleEditorsFactory.createFormSelectEditor();this.reportEditor=this.reportEditorView;break;case'form-checkbox':editor=EditorsFactory.createFormCheckboxEditor();this.styleEditor=StyleEditorsFactory.createFormCheckboxEditor();this.reportEditor=this.reportEditorView;break;case'form-radio':editor=EditorsFactory.createFormRadioEditor();this.styleEditor=StyleEditorsFactory.createFormRadioEditor();this.reportEditor=this.reportEditorView;break;case'form-submit':editor=EditorsFactory.createFormSubmitEditor(this.stageView);this.styleEditor=StyleEditorsFactory.createFormSubmitEditor(this.stageView);break;case'iframe':editor=EditorsFactory.createIframeEditor();this.styleEditor=StyleEditorsFactory.createIframeEditor();break;case'swf':editor=EditorsFactory.createSwfEditor();this.styleEditor=StyleEditorsFactory.createSwfEditor();break;case'drawedinfopoint-link':editor=EditorsFactory.createDrawedInfoPointLinkEditor();this.styleEditor=StyleEditorsFactory.createDrawedInfoPointLinkEditor();break;case'drawedinfopoint-download':editor=EditorsFactory.createDrawedInfoPointDownloadEditor();this.styleEditor=StyleEditorsFactory.createDrawedInfoPointDownloadEditor();break;case'drawedinfopoint-gallery':editor=EditorsFactory.createDrawedInfoPointGalleryEditor();this.styleEditor=StyleEditorsFactory.createDrawedInfoPointGalleryEditor();break;case'drawedinfopoint-popup':editor=EditorsFactory.createDrawedInfoPointPopupEditor();this.styleEditor=StyleEditorsFactory.createDrawedInfoPointPopupEditor();break;case'infopoint-popup':editor=EditorsFactory.createInfoPointPopupEditor();this.styleEditor=StyleEditorsFactory.createInfoPointPopupEditor();break;case'infopoint-link':editor=EditorsFactory.createInfoPointLinkEditor();this.styleEditor=StyleEditorsFactory.createInfoPointLinkEditor();break;case'infopoint-sound':editor=EditorsFactory.createInfoPointSoundEditor();this.styleEditor=StyleEditorsFactory.createInfoPointSoundEditor();break;case'infopoint-sound-control':editor=EditorsFactory.createInfoPointSoundControlEditor();this.styleEditor=StyleEditorsFactory.createInfoPointSoundControlEditor();break;case'infopoint-soundrecord':editor=EditorsFactory.createInfoPointSoundRecordEditor();this.styleEditor=StyleEditorsFactory.createInfoPointSoundRecordEditor();break;case'infopoint-gallery':editor=EditorsFactory.createInfoPointGalleryEditor();this.styleEditor=StyleEditorsFactory.createInfoPointGalleryEditor();break;case'infopoint-download':editor=EditorsFactory.createInfoPointDownloadEditor();this.styleEditor=StyleEditorsFactory.createInfoPointDownloadEditor();break;case'quiz-inputtext':editor=EditorsFactory.createQuizInputTextEditor();this.styleEditor=StyleEditorsFactory.createQuizInputTextEditor();this.reportEditor=this.reportEditorView;break;case'quiz-select':editor=EditorsFactory.createQuizSelectEditor();this.styleEditor=StyleEditorsFactory.createQuizSelectEditor();this.reportEditor=this.reportEditorView;break;default:editor=new EditorView();this.editor=editor;this.styleEditor=new StyleEditorView();console.log("No editor");break;}
this.editor=editor;editor.setModel(componentModel);this.styleEditor.setModel(componentModel);this.scoreExerciseEditorView.setModel(componentModel);$('#botmenu-editors-container').html(this.editor.render().$el);this.editor.afterRender();$('#botmenu-styles').html(this.styleEditor.render().$el);this.styleEditor.afterRender();this.soundEditor.destroy();this.soundEditor=this.soundEditorView;this.soundEditor.setModel(componentModel);$('#botmenu-sound').html(this.soundEditor.render().$el);if(this.reportEditor){this.reportEditor.setModel(componentModel);$('#botmenu-report').html(this.reportEditor.render().$el);}},createStyles:function(){StylesFactory.createAllStyles();this.stageStyleEditor=StyleEditorsFactory.createStageEditor();},createEditors:function(componentModel){this.textToolbarEditorView=EditorsFactory.createTextToolbarEditor();this.stageEditorView=EditorsFactory.createStageEditor();this.wcagEditorView=EditorsFactory.createWcagEditor();this.parallaxeEditorView=EditorsFactory.createParallaxeEditor();this.scoreEditorView=EditorsFactory.createScoreEditor();this.scoreExerciseEditorView=EditorsFactory.createScoreExerciseEditor();this.sizeAndPositionEditorView=EditorsFactory.createSizeAndPositionEditorView();this.alignEditorView=EditorsFactory.createAlignEditorView();this.alignEditorView.render();this.pagenoteEditorView=EditorsFactory.createPagenoteEditor();this.soundEditorView=EditorsFactory.createSoundEditor();this.reportEditorView=EditorsFactory.createReportEditor();this.timelineEditorView=EditorsFactory.createTimelineEditor();this.multipleSizeAndPositionEditorView=EditorsFactory.createMultipleSizeAndPositionEditor();this.multipleWcagEditorView=EditorsFactory.createMultipleWcagEditor();this.multipleParallaxeEditor=EditorsFactory.createMultipleParallaxeEditor();this.multipleSoundEditorView=EditorsFactory.createMultipleSoundEditor();this.multipleReportEditorView=EditorsFactory.createMultipleReportEditor();this.soundEditor=this.soundEditorView;this.reportEditor=this.reportEditorView;},createTrigger:function(){var _that=this;this.triggerView=new WindowFactory.createTriggerWindow();$('body').append(this.triggerView.render().$el);this.triggerView.$el.css({top:'100px',left:'calc(100% - 450px)'});if($(document).width()<1380){this.triggerView.minimize();}
$(window).resize(function(){if((_that.triggerView.$el.offset().left+200)>$(this).width()){_that.triggerView.$el.css({left:$(this).width()-200+"px"});}
BottomMenuView.instance.onResize();_that.stageView.renderScenePosition();});},showTestDriveState:function(){var _that=this;if(!this.getTestDriveAsVisited()){var testDriveWindow=WindowFactory.createTestDriveWindow();$('body').append(testDriveWindow.render().$el);}
var timerWindow=WindowFactory.createTimerWindow();timerWindow.on('onTimerComplete',function(){_that.showRestartWindow();});$('body').append(timerWindow.render().$el);},showRestartWindow:function(){Utils.setModalText({main:_lang('YOU_HAVE_NO_ACCESS_2'),extra:_lang('YOU_HAVE_NO_ACCESS_EXTRA_4')},true);Utils.showNormalModal();setTimeout(function(){window.location.reload();},5000);},getTestDriveAsVisited:function(){return Utils.getCookie('testdrive');},});;;var ProjectView=Backbone.View.extend({tagName:'li',className:'project-view',template:_.template($('#project-view-template').html()),events:{},initialize:function(){},render:function(){var template=this.template(this.serializeData());this.$el.html(template);return this;},afterRender:function(){this.createHistoryView();this.createWatcherView();var pagesLength=this.model.get('collection').length||0;this.createEditorsControllerView();this.createTriggerView();this.createStageView(this.model.get('collection').first());if(pagesLength==0){this.showModalWindow();}
this.createPageListView();ProjectModel.instance=this.model;},createStageView:function(pageModel){var _that=this;var pageModel=pageModel||ProjectModel.instance.createNewPageModel();this.stageView=new EditableStageView({model:pageModel});this.stageView.on(' show-image-window',function(sender){_that.openImageWindow(0,sender);});this.stageView.on('on-stage-render',function(pModel){_that.onStageRender(pModel);});this.stageView.on('on-stage-selected',function(pModel){_that.onStageSelected(pModel);});this.stageView.on('on-component-selected',function(cModel){_that.onComponentSelected(cModel);});this.stageView.on('on-components-selected',function(scc){_that.onComponentsSelected(scc);});this.stageView.on('update-timeline',function(){_that.updateTimeline();});StageView.instance=this.stageView;this.$el.find('.stage-view-container').html(this.stageView.renderStage().$el);this.stageView.afterRender();},createNewPageSection:function(){this.newPageSection=new NewPageSection();this.newPageSection.on('copy-page',this.copyPage,this);this.newPageSection.on('add-new-blank-page',this.addNewPageSection,this);this.newPageSection.on('add-new-psd-page',this.addNewPageSection,this);this.newPageSection.on('add-new-pdf-page',this.addNewPageSection,this);this.$el.find('.new-page-container').html(this.newPageSection.render().$el);this.newPageSection.afterRender();},createPageListView:function(){this.pagesList=new EditablePagesList({model:this.model});this.pagesList.on('toggle-project-list',this.toggleProjectList,this);this.pagesList.on('set-page',this.setPage,this);this.pagesList.on('change-tab-editor',this.changeTabEditor,this);this.pagesList.on('data-picker-picked',this.dataPickerPicked,this);this.pagesList.on('show-modal-window',this.showModalWindow,this);this.pagesList.on('on-page-added',this.onPageAdded,this);this.$el.find('.pages-list-wrapper').html(this.pagesList.render().$el);this.pagesList.afterRender();},dataPickerPicked:function(model){this.stageView.dataPickerPicked(model);},createTriggerView:function(){var _that=this;this.triggerView=new WindowFactory.createTriggerWindow();$('body').append(this.triggerView.render().$el);this.triggerView.$el.css({top:'100px',left:'calc(100% - 450px)'});$(window).resize(function(){if((_that.triggerView.$el.offset().left+200)>$(this).width()){_that.triggerView.$el.css({left:$(this).width()-200+"px"});}});},createEditorsControllerView:function(pageModel){var pageModel=pageModel||ProjectModel.instance.createNewPageModel();this.editorsController=new EditorsController({model:pageModel});this.editorsController.on('on-resize',this.onEditrsResize,this);this.editorsController.on('data-picker-picked',this.dataPickerPicked,this);this.$el.find('.editors-view-container').html(this.editorsController.render().$el);this.editorsController.afterRender();},onEditrsResize:function(editorControllerView){this.pagesMainList=this.$el.find('.pages-list-wrapper-main');var editorsMenuHeight=editorControllerView.$el.height();var pagesListProperHeight=editorsMenuHeight+82;this.pagesMainList.css('height','calc(100% - '+pagesListProperHeight+'px)');this.stageView.$el.css('height','calc(100% - '+editorsMenuHeight+'px)');},createHistoryView:function(){var _that=this;this.historyListView=new HistoryListView();HistoryListView.instance=this.historyListView;this.historyListView.on('load-history-project',function(data){_that.loadHistoryProject(data);});this.historyListView.on('load-history-page',function(data){_that.loadHistoryPage(data);});$('#history-wrapper').append(this.historyListView.render().$el);_log('dsad',$('#history-wrapper'));this.historyListView.start();},createWatcherView:function(){var _that=this;var projectWatcher=new ProjectWatcherView();},setPage:function(model){if(this.stageView){this.stageView.setModel(model);}},toggleProjectList:function(value){if(value){this.pagesList.hide();this.stageView.$el.css('width','100%');}else{this.pagesList.show();this.stageView.$el.css('width','calc(100% - 262px)');}},serializeData:function(){return{};},copyPage:function(){},copyPagesFromOtherProject:function(pageIds,userId,projectId){this.selectProjectView();this.pagesList.copyPagesFromOtherProject(pageIds,userId,projectId);},createNewPage:function(){this.pagesList.createNewPage();},showDeletePagesWindow:function(e){this.pagesList.showDeletePagesWindow(e);},duplicatePages:function(){this.pagesList.duplicatePages();},addNewPageSection:function(){var _that=this;var newPageModel=ProjectModel.instance.createNewPageModel();this.pagesList.addNewPage(newPageModel,function(createdPageModel){_that.newPageSection.destroy();_that.newPageSection=undefined;_that.pagesList.render();_that.pagesList.afterRender();_that.createStageView(createdPageModel);},function(data){});},addNewPsdPage:function(){},addNewPdfPage:function(){},onKeyDown:function(e){console.log('keydown '+e.which);var _that=this;switch(e.which){case 65:if(e.ctrlKey){this.stageView.selectAllComponents();}
break;case 46:this.stageView.deleteActiveComponent();break;case 27:var windows=$('body').find('.window, .context-menu').not('.trigger-window');_log('windows',windows);var oneWindow=windows.last();_log('oneWindow',oneWindow);if(oneWindow.length>0){oneWindow.trigger('close');}else{this.triggerView.escape();}
break;case 67:if(e.ctrlKey){this.stageView.copyComponents();}
break;case 86:if(e.ctrlKey){if(this.imageWindow){return;}
this.stageView.pasteComponents();}
break;case 66:if(e.ctrlKey){this.showPasteWindow();}
break;case 88:if(e.ctrlKey){this.stageView.cutComponents();}
break;case 81:e.stopPropagation();e.preventDefault();if(e.ctrlKey){this.stageView.duplicateComponents();}
break;case 90:if(e.ctrlKey){this.historyBack();}
break;case 89:if(e.ctrlKey){this.historyPrev();}
break;case 37:case 38:case 39:case 40:this.stageView.moveActiveComponents(e);break;case 32:if(e.ctrlKey){this.stageView.moveSelectedComponentsToNewLine();}
break;case 190:if(e.ctrlKey){var addMultiComponentsWindow=WindowFactory.createAddMultiComponentsWindow();addMultiComponentsWindow.on('add-multi-components',function(data){_that.stageView.addMultiComponents({type:'text',cData:data});});$('body').append(addMultiComponentsWindow.render().$el);addMultiComponentsWindow.afterRender();}
break;}},showPasteWindow:function(){_log('Show paste window');var _that=this;this.imageWindow=WindowFactory.createPasteComponentsWindow();this.imageWindow.on('paste-components',function(hash){_that.stageView.pasteComponents(hash);});this.imageWindow.on('on-close',function(){_that.imageWindow=undefined;});$('body').append(this.imageWindow.render().$el);},onLeftMenuClick:function(model){var _that=this;var componentType=model.get('componentName');switch(componentType){case'image':_that.openImageWindow(0);break;case'video':_that.openVideoWindow(0);break;case'library':_that.openLibraryWindow(0);break;case'shapes':_that.openLibraryWindow(4);break;case'remove':this.stageView.deleteActiveComponent();break;default:_that.addComponent(componentType);break;}},addComponent:function(componentType,onComponentAdded){var componentModel=ComponentFactory.createComponentModelByType(componentType);this.stageView.addComponent(componentModel,onComponentAdded);},openImageWindow:function(activeTab,sender){var _that=this;var imageWindow=WindowFactory.createImageWindow(activeTab,sender);imageWindow.on('on-close',function(fileData){_that.imageWindow=undefined;});imageWindow.on('imageupload-ondrop',function(fileData){_that.addComponent('image',function(componentView){_log('fileData',fileData);componentView.uploadOnFileDrop2(fileData,true);});});imageWindow.on('imageupload-onclick',function(fileData,input){_that.addComponent('image',function(componentView){componentView.uploadOnInputData(fileData,input,true);});});imageWindow.on('imageupload-link',function(imageUrl){_that.addComponent('image',function(componentView){componentView.uploadOnLink(imageUrl,true);});});imageWindow.on('imageupload-on-paste',function(event,blob){_that.addComponent('image',function(componentView){componentView.uploadOnPaste(event,blob,true);});});$('body').append(imageWindow.render().$el);imageWindow.$el.find('.darkan-tabs').tabs("option","active",activeTab);this.imageWindow=imageWindow;},openVideoWindow:function(activeTab){var _that=this;var videoWindow=WindowFactory.createVideoWindow();videoWindow.on('imageupload-ondrop',function(fileData){_that.addComponent('video',function(componentView){componentView.uploadOnFileDrop2(fileData,true);});});videoWindow.on('imageupload-onclick',function(fileData,input){_that.addComponent('video',function(componentView){componentView.uploadOnInputData(fileData,input,false);});});videoWindow.on('putvideolink',function(data){_that.addComponent('video',function(componentView){componentView.putVideoLink(data);});});$('body').append(videoWindow.render().$el);videoWindow.$el.find('.darkan-tabs').tabs("option","active",activeTab);},openLibraryWindow:function(activeTab){var _that=this;var libraryWindow=WindowFactory.createLibraryWindow();$('body').append(libraryWindow.render().$el);libraryWindow.on('imagelibrary-onclick',function(fileData,input){_log('fileData',fileData);_that.addComponent('image',function(componentView){componentView.createImageLibrary(fileData,input,true);});});libraryWindow.$el.find('.darkan-tabs').tabs("option","active",activeTab);},createNewPageTopMenu:function(){var newPageWindow=WindowFactory.createNewpageWindow();this.createNewPageWindow(newPageWindow);},createNewStartingPageWindow:function(){var newPageWindow=WindowFactory.createStartingNewpageWindow();this.createNewPageWindow(newPageWindow);},createNewPageWindow:function(newPageWindow){var _that=this;newPageWindow.on('add-new-blank-page',function(){var newPageModel=_that.pagesList.createNewPage();});newPageWindow.on('add-new-psd-page',function(){var importWindow=WindowFactory.createImportWindow();importWindow.on('close-window',function(){newPageWindow.close();newPageWindow=undefined;});$('body').append(importWindow.render().$el);importWindow.importPsdOnClick();});newPageWindow.on('add-new-pdf-page',function(){var importWindow=WindowFactory.createImportWindow();importWindow.on('close-window',function(){newPageWindow.close();newPageWindow=undefined;});$('body').append(importWindow.render().$el);importWindow.importPdf();});_that.newPageWindow=newPageWindow;$('body').append(newPageWindow.render().$el);},loadHistoryPage:function(data){var _that=this;if(!_.isObject(data)){return;}
_log('loadHistoryPage',data);var action=data.action||{};var nowAction=data.nowAction||{};var params=nowAction.params||{};var pageId=parseInt(params.pageId);var pageModel=this.getPageModelByPageId(pageId);if(pageModel){var page=data.page;_log('pageId',pageId,_log.error);_log('page.options.pageid',page.options.pageid,_log.error);if(page.options.pageid==pageId){var newPageModel=ProjectModel.instance.createPageModel(page);pageModel.set('options',newPageModel.get('options'),{silent:true});pageModel.set('lines',newPageModel.get('lines'),{silent:true});if(action.login==__meta__.login){pageModel.changesWereMade=false;pageModel.view.setPageAsActive(pageModel);pageModel.changesWereMade=true;pageModel.updateDinamicPageThumb();}}}},loadHistoryProject:function(data){var _that=this;if(!_.isObject(data)){return;}
var action=data.action||{};var nowAction=data.nowAction||{};var params=nowAction.params||{};var pageId=parseInt(params.pageId);_log('loadHistoryProject',data);this.model=new ProjectModel({options:new ProjectOptions(),collection:new PageCollection()});var collection=this.model.onGetProjectData(data);this.model.set('collection',collection);this.addEventsToCollection();this.pagesList.model=this.model;this.pagesList.render();this.pagesList.afterRender();var pageModel=this.getPageModelByPageId(pageId)||collection.first();if(pageModel){if(action.login==__meta__.login){pageModel.changesWereMade=false;pageModel.view.setPageAsActive(pageModel);pageModel.changesWereMade=true;pageModel.updateDinamicPageThumb();StageView.instance.createPageThumb(function(){pageModel.view.render();pageModel.view.afterRender();});}}},pageIsTheSame:function(pageId){return(pageId==StageView.instance.model.get('options').get('pageid'));},getPageModelByPageId:function(pageId){var pageModel;this.model.get('collection').each(function(model){if(model.get('options').get('pageid')==pageId){pageModel=model;}});return pageModel;},addEventsToCollection:function(){var collection=this.model.get('collection');collection.off();collection.on('reset add remove',function(){DarkanEditorAplicationAPI.getInstance().pagesCollectionChanged({pagesLength:collection.length});});},onStageRender:function(pModel){var _that=this;_that.triggerView.setModel(pModel.get('options'));_that.editorsController.setStageModel(pModel);},onStageSelected:function(pModel){var _that=this;setTimeout(function(){_that.triggerView.setModel(pModel.get('options'));_that.editorsController.setModelToOpenEditors(pModel);_that.disableTopMenuButtons(pModel);},100);},onComponentSelected:function(cModel){var _that=this;setTimeout(function(){_that.triggerView.setModel(cModel);_that.editorsController.setModelToOpenEditors(cModel);_that.disableTopMenuButtons(cModel);},100);},onComponentsSelected:function(scc){var _that=this;setTimeout(function(){_that.triggerView.setCollection(scc);_that.editorsController.setModelToOpenEditors(scc);_that.disableTopMenuButtons(scc);},100);},disableTopMenuButtons:function(model){this.trigger('disable-top-menu-buttons',model);},updateTimeline:function(){},changeTabEditor:function(params){this.editorsController.changeTabEditor(params);},topMenuAction:function(action){switch(action){case'open-existing-project':this.openExistingProject();break;case'move-components-to-new-layer':this.stageView.moveSelectedComponentsToNewLine();break;case'duplicate-components':this.stageView.duplicateComponents();break;case'paste-special-components':this.showPasteWindow();break;case'paste-components':this.stageView.pasteComponents();break;case'copy-components':this.stageView.copyComponents();break;case'cut-components':this.stageView.cutComponents();break;case'history-prev':this.historyPrev();break;case'history-back':this.historyBack();break;case'copy-conponents-from-other-project':this.historyBack();break;}},historyBack:function(){HistoryListView.instance.back();},historyPrev:function(){HistoryListView.instance.prev();},createPsdPage:function(data){this.pagesList.createPsdPage(data);},showModalWindow:function(){this.createNewStartingPageWindow();},onPageAdded:function(){if(this.newPageWindow){this.hideModalWindow();}},hideModalWindow:function(){this.newPageWindow.close();},openExistingProject:function(){this.trigger('open-existing-project');},show:function(){this.triggerView.show();this.$el.show();},hide:function(){this.triggerView.hide();this.$el.hide();},selectProjectView:function(projectModel){this.model.trigger('select-project-view',projectModel||ProjectView.instance.model);},goToNextPage:function(data,sender){var pageModel=this.pagesList.getSelectedPageModel();var pagesCollection=this.pagesList.getPagesCollection();var index=pagesCollection.indexOf(pageModel);var nextPageModel=pagesCollection.at(index+1);if(nextPageModel){this.pagesList.setPageAsActive(nextPageModel);}},goToPrewPage:function(data,sender){var pageModel=this.pagesList.getSelectedPageModel();var pagesCollection=this.pagesList.getPagesCollection();var index=pagesCollection.indexOf(pageModel);var nextPageModel=pagesCollection.at(index-1);if(nextPageModel){this.pagesList.setPageAsActive(nextPageModel);}},goToPage:function(data,sender){var pageIndex=parseInt(data.pageIndex);if(_.isNaN(pageIndex)){return;}
var pagesCollection=this.pagesList.getPagesCollection();var nextPageModel=pagesCollection.at(pageIndex);if(nextPageModel){this.pagesList.setPageAsActive(nextPageModel);}},sortPages:function(data,sender){var pageIndex=parseInt(data.pageIndex);var position=parseInt(data.position);if(_.isNaN(pageIndex)){return;}
if(_.isNaN(position)){return;}
if(position<0){return;}
if(pageIndex==position){return;}
var pagesCollection=this.pagesList.getPagesCollection();var pageModel=pagesCollection.at(pageIndex);if(!pageModel){return;}
var newPageModel=pagesCollection.at(position);if(!newPageModel){return;}
this.pagesList.updateSort('updateSort',pageModel,position);},});;;var ProjectListItemModel=Backbone.Model.extend({isSelected:false,defaults:function(){},});;;var ProjectItemModel=ProjectListItemModel.extend({defaults:function(){return{dimentions:"",folder:-1,name:"",pType:"userProjects",}},});;;var FolderItemModel=ProjectListItemModel.extend({defaults:function(){return{folder:'',folderID:'',name:'',pType:'folder',}},});;;var ShareUserItemModel=ProjectListItemModel.extend({defaults:function(){return{id:'',mail:'',user_id:'',project_id:''}},});;;var FoldersCollection=Backbone.Collection.extend({model:FolderItemModel,comparator:function(model){return model.get('name').toLowerCase();},searchStructore:function(value){filtered=this.filter(function(model){if(model.get('folderID')==0)return false;return model.get("name").toLowerCase().indexOf(value.toLowerCase())!=-1?true:false;});return filtered;}});var BreacrumbsCollection=Backbone.Collection.extend({model:FolderItemModel});;;var ProjectsCollection=Backbone.Collection.extend({model:ProjectItemModel,comparator:function(model){return model.get('name').toLowerCase();},searchStructore:function(value){var searchValue=value.toLowerCase();filtered=this.filter(function(model){var name=model.get("name").toLowerCase();var fromuser=model.get("fromuser");if(name.indexOf(searchValue)!=-1||(fromuser&&fromuser.toLowerCase().indexOf(searchValue)!=-1)){return true;}else{return false;}});return filtered;}});;;var ProjectListItemView=Backbone.View.extend({className:'projectlist-item project-item',template:_.template($('#projectslist-item-template').html()),selected:false,initialize:function(data){},render:function(){this.beforRender();this.model.isSelected=false;var template=this.template(this.model.toJSON());this.$el.html(template);this.afterRender();return this;},afterRender:function(){},beforRender:function(){},selectItem:function(e){this.trigger('select-item',e,this.model);},unselectItem:function(e){},setSelected:function(value){this.model.isSelected=value;this.$el.attr('itemselected',value);},activeEditingName:function(e){},update:function(e){},makeDroppable:function(){},unmakeDroppable:function(){}});;;var FolderItemView=ProjectListItemView.extend({className:'projectlist-item project-item',template:_.template($('#projectslist-folder-item-template').html()),events:{'click':'openFolder','click .edit-folder-name-button':'activeEditingName',},initialize:function(data){this.model.on('new-folder',this.renderIsNew,this);},openFolder:function(e){e.stopPropagation();this.trigger('open-folder',this.model);},renderIsNew:function(e){this.$el.addClass('new-folder');},beforRender:function(){},update:function(e){this.trigger('update-folder',this.model);},render:function(){this.beforRender();this.model.isSelected=false;var template=this.template(this.model.toJSON());this.$el.html(template);this.afterRender();return this;},});;;var NormalFolderItemView=FolderItemView.extend({className:'projectlist-item folder-item normal-folder-item',template:_.template($('#projectslist-normal-folder-item-template').html()),events:function(){return _.extend({},FolderItemView.prototype.events,{});},editFolderName:function(e){},afterRender:function(){},});;;var SharedTemplateFolderItemView=FolderItemView.extend({className:'projectlist-item folder-item shared-template-folder-item',template:_.template($('#projectslist-shared-template-folder-item-template').html()),events:function(){return _.extend({},FolderItemView.prototype.events,{});},editFolderName:function(e){},afterRender:function(){},});;;var ProjectItemView=ProjectListItemView.extend({className:'projectlist-item project-item',template:_.template($('#projectslist-project-item-template').html()),events:function(){return _.extend({},ProjectListItemView.prototype.events,{'click .share-project-button':'showShareeProjectWindow','click .open-project-href':'openProject',});},initialize:function(data){this.model.on('new-shared-user-project',this.renderIsNewSharedUserProject,this);},renderPType:function(){var pType=this.model.get('pType');this.$el.attr('ptype',pType);},renderIsNew:function(e){this.$el.addClass('new-project');},renderIsNewSharedUserProject:function(e){this.$el.addClass('new-shared-user-project');},openProject:function(e){this.trigger('open-project',this.model);},update:function(e){this.trigger('update-project',this.model);},showShareeProjectWindow:function(e){var shareProjectWindow=WindowFactory.createShareProjectWindow({projectModel:this.model});shareProjectWindow.setTitle('Share project');$('body').append(shareProjectWindow.render().$el);},afterRender:function(){this.renderPType();},render:function(){this.beforRender();this.model.isSelected=false;var template=this.template(this.model.toJSON());this.$el.html(template);this.afterRender();return this;},});;;var NormalProjectItemView=ProjectItemView.extend({className:'projectlist-item normal-project-item',template:_.template($('#projectslist-normal-project-item-template').html()),});;;var TemplateProjectItemView=ProjectItemView.extend({className:'projectlist-item template-project-item',template:_.template($('#projectslist-template-project-item-template').html()),});;;var SharedToUserProjectItemView=ProjectItemView.extend({className:'projectlist-item shared-to-user-project-item',template:_.template($('#projectslist-shared-to-user-project-item-template').html()),events:function(){return _.extend({},ProjectListItemView.prototype.events,{'click .open-project-href':'openProject',});},afterRender:function(){this.renderPType();this.renderFromUser();},renderFromUser:function(){var fromUser=this.model.get('fromuser');if(fromUser&&fromUser!=""){this.$el.attr('fromuser',true);}},});;;var ShareUserItemView=ProjectListItemView.extend({className:'share-user-item',template:_.template($('#projectslist-share-user-item-template').html()),events:{'click .share-user-remove-button':'unshareUser'},initialize:function(data){},unshareUser:function(){this.trigger('unshare-user',this.model);},});;;var NormalShareUserItemView=ShareUserItemView.extend({className:'share-user-item normal-share-user-item',template:_.template($('#projectslist-normal-share-user-item-template').html()),});;;var NotExistShareUserItemView=ShareUserItemView.extend({className:'share-user-item no-exist-share-user-item',template:_.template($('#projectslist-no-exist-share-user-item-template').html()),});;;var BreadcrumbItemView=ProjectListItemView.extend({className:'breadcrumb-item',template:_.template($('#projectslist-breadcrumb-item-template').html()),events:{'click':'backToFolder'},backToFolder:function(e){this.trigger('back-to-folder',this.model);}});;;var NormalBreadcrumbItemView=BreadcrumbItemView.extend({className:'normal-breadcrumb-item',template:_.template($('#projectslist-normal-breadcrumb-item-template').html()),});var SharedTemplateBreadcrumbItemView=BreadcrumbItemView.extend({className:'normal-breadcrumb-item shared-template-breadcrumb-item',template:_.template($('#projectslist-shared-template-breadcrumb-item-template').html()),});;;var SearchBreadcrumbItemView=BreadcrumbItemView.extend({className:'search-breadcrumb-item',template:_.template($('#projectslist-search-breadcrumb-item-template').html()),backToFolder:function(e){}});;;var TreeItemView=ProjectListItemView.extend({className:'tree-item',tagName:'li',template:_.template($('#projectslist-tree-item-template').html()),events:{'click':'goToFolder','select-parents':'selectParents','drop-folder-item':'dropFolderItem',},initialize:function(data){this.model.on('is-not-showing',this.renderShowingFalse,this);this.model.on('is-showing',this.renderShowingTrue,this);this.model.on('select-childs',this.selectChilds,this);this.model.on('change:name',this.render,this);},dropFolderItem:function(event,targetFolderModel){this.trigger('on-folder-move',this.model,targetFolderModel);},goToFolder:function(e){this.trigger('go-to-folder',this.model);},renderShowingTrue:function(model){_log('renderShowingTrue',model);this.$el.find('.folder-icon').attr('class','fa folder-icon fa-folder-open fa-2x');},renderShowingFalse:function(model){this.$el.removeClass('select-parents');this.$el.find('.folder-icon').attr('class','fa folder-icon fa-folder fa-2x');},selectParents:function(){_log('selectParents',this.model);this.$el.addClass('select-parents');},selectChilds:function(){},render:function(){var _that=this;this.beforRender();this.model.isSelected=false;var template=this.template(this.model.toJSON());this.$el.html(template);this.afterRender();return this;},makeFolderDroppable:function(){var _that=this;this.$el.droppable({greedy:true,activeClass:"tree-folder-state-hover",hoverClass:"tree-folder-state-active",drop:function(event,ui){_log('ui',ui);$(ui.draggable).trigger('drop-folder-item',_that.model);}});},makeProjectDroppable:function(){var _that=this;this.$el.droppable({greedy:true,activeClass:"tree-project-state-hover",hoverClass:"tree-project-state-active",drop:function(event,ui){_log('ui',ui);$(ui.draggable).trigger('drop-project-item',_that.model);}});},unmakeDroppable:function(){_log('is droppable',this.$el.hasClass('ui-droppable'));if(this.$el.hasClass('ui-droppable')){this.$el.droppable('destroy');}}});;;var NormalTreeItemView=TreeItemView.extend({className:'tree-item normal-tree-item',tagName:'li',template:_.template($('#projectslist-normal-tree-item-template').html()),});;;function FoldersFactory(){}
FoldersFactory.createFolderByType=function(type,model){switch(type){case'folder':return FoldersFactory.createNormalFolderView(model);break;case'stFolder':return FoldersFactory.createSharedTemplateFolderView(model);break;default:console.log("No component: "+type);break;}}
FoldersFactory.updateOptionsModel=function(model,options){for(var item in options){model.set(item,options[item],{silent:true});}}
FoldersFactory.createFolderModelByType=function(type,options){var opts=options||{};switch(type){case'folder':var model=new ProjectListItemModel();this.updateOptionsModel(model,opts);return model;break;case'stFolder':var model=new ProjectListItemModel();this.updateOptionsModel(model,opts);return model;break;default:console.log("No type: "+type);break;}}
FoldersFactory.createNormalFolderView=function(model){model=model||new ProjectListItemModel();var folderView=new NormalFolderItemView({model:model});return folderView;}
FoldersFactory.createSharedTemplateFolderView=function(model){model=model||new ProjectListItemModel();var folderView=new SharedTemplateFolderItemView({model:model});return folderView;};;function ProjectsFactory(){}
ProjectsFactory.createProjectByType=function(type,model){var template=model.get('template');if(template==1){switch(type){case'userProjects':case'userSharedProjects':return ProjectsFactory.createTemplateProjectView(model);break;case'sharedToUserProjects':return ProjectsFactory.createSharedToUserProjectView(model);break;default:return ProjectsFactory.createNormalProjectView(model);break;}}else{switch(type){case'userProjects':return ProjectsFactory.createNormalProjectView(model);break;case'userSharedProjects':return ProjectsFactory.createNormalProjectView(model);break;case'sharedToUserProjects':return ProjectsFactory.createSharedToUserProjectView(model);break;default:return ProjectsFactory.createNormalProjectView(model);break;}}}
ProjectsFactory.updateOptionsModel=function(model,options){for(var item in options){model.set(item,options[item],{silent:true});}}
ProjectsFactory.createProjectModelByType=function(type,options){var opts=options||{};switch(type){case'userProjects':var model=new ProjectListItemModel();this.updateOptionsModel(model,opts);return model;break;default:var model=new ProjectListItemModel();this.updateOptionsModel(model,opts);return model;break;}}
ProjectsFactory.createNormalProjectView=function(model){model=model||new ProjectListItemModel();var projectView=new NormalProjectItemView({model:model});return projectView;}
ProjectsFactory.createTemplateProjectView=function(model){model=model||new ProjectListItemModel();var projectView=new TemplateProjectItemView({model:model});return projectView;}
ProjectsFactory.createShareProjectView=function(model){model=model||new ProjectListItemModel();var projectView=new ShareProjectItemView({model:model});return projectView;}
ProjectsFactory.createSharedToUserProjectView=function(model){model=model||new ProjectListItemModel();var projectView=new SharedToUserProjectItemView({model:model});return projectView;};;function BreadcrumbsFactory(){}
BreadcrumbsFactory.createBreadcrumbByType=function(type,model){switch(type){case'folder':return BreadcrumbsFactory.createNormalBreadcrumbView(model);break;case'search-folder':return BreadcrumbsFactory.createSearchBreadcrumbView(model);break;case'stFolder':return BreadcrumbsFactory.createSharedTemplateBreadcrumbView(model);break;default:console.log("No component: "+type);break;}}
BreadcrumbsFactory.updateOptionsModel=function(model,options){for(var item in options){model.set(item,options[item],{silent:true});}}
BreadcrumbsFactory.createBreadcrumbModelByType=function(type,options){var opts=options||{};switch(type){case'folder':case'stFolder':var model=new FolderListItemModel();this.updateOptionsModel(model,opts);return model;break;default:console.log("No type: "+type);break;}}
BreadcrumbsFactory.createNormalBreadcrumbView=function(model){model=model||new FolderListItemModel();var breadcrumbView=new NormalBreadcrumbItemView({model:model});return breadcrumbView;}
BreadcrumbsFactory.createSharedTemplateBreadcrumbView=function(model){model=model||new FolderListItemModel();var breadcrumbView=new SharedTemplateBreadcrumbItemView({model:model});return breadcrumbView;}
BreadcrumbsFactory.createSearchBreadcrumbView=function(model){model=model||new FolderListItemModel();var breadcrumbView=new SearchBreadcrumbItemView({model:model});return breadcrumbView;};;function TreeFactory(){}
TreeFactory.createTreeByType=function(type,model){switch(type){case'folder':return TreeFactory.createNormalTreeView(model);break;default:console.log("No component: "+type);break;}}
TreeFactory.updateOptionsModel=function(model,options){for(var item in options){model.set(item,options[item],{silent:true});}}
TreeFactory.createTreeModelByType=function(type,options){var opts=options||{};switch(type){case'folder':var model=new FolderListItemModel();this.updateOptionsModel(model,opts);return model;break;default:console.log("No type: "+type);break;}}
TreeFactory.createNormalTreeView=function(model){model=model||new FolderListItemModel();var treeView=new NormalTreeItemView({model:model});return treeView;};;function ShareUserFactory(){}
ShareUserFactory.createShareUser=function(user){if(_.isUndefined(user.user_id)){var model=new ShareUserItemModel(user);_log('createShareUser',model);return ShareUserFactory.createNotExistShareUserView(model);}else{var model=new ShareUserItemModel(user);return ShareUserFactory.createNormalShareUserView(model);}}
ShareUserFactory.updateOptionsModel=function(model,options){for(var item in options){model.set(item,options[item],{silent:true});}}
ShareUserFactory.createShareUserModelByType=function(type,options){var opts=options||{};switch(type){case'userProjects':var model=new ShareUserItemModel();this.updateOptionsModel(model,opts);return model;break;default:var model=new ShareUserItemModel();this.updateOptionsModel(model,opts);return model;break;}}
ShareUserFactory.createNormalShareUserView=function(model){model=model||new ShareUserItemModel();var shareUserView=new NormalShareUserItemView({model:model});return shareUserView;}
ShareUserFactory.createNotExistShareUserView=function(model){model=model||new ShareUserItemModel();var shareUserView=new NotExistShareUserItemView({model:model});return shareUserView;};;var ProjectListModel=Backbone.Model.extend({defaults:function(){return{folders:new FoldersCollection(),objs:new ProjectsCollection(),lastFolderID:0,lastVisitedFolderID:-1,organizeBy:"alphabetical"}},});;;var ProjectListView=Backbone.View.extend({template:_.template($('#projectslist-template').html()),itemsCollection:new Backbone.Collection(),searchValue:'',initialize:function(data){this.model=data.model;},events:{'click .addproject':'showAddProjectWindow'},showAddProjectWindow:function(){this.trigger('add-project');},render:function(){var template=this.template();this.$el.html(template);return this;},renderFolderStructure:function(folderModel){this.activFolderModel=folderModel==undefined?this.activFolderModel:folderModel;folderModel=this.activFolderModel;this.model.get('folders').each(function(fModel){fModel.trigger('is-not-showing',fModel);});folderModel.trigger('is-showing',folderModel);folderModel.trigger('select-childs',folderModel);var folderID=folderModel.get('folderID');this.model.set('lastVisitedFolderID',folderID);if(this.searchValue!=''){var folderStructure=this.getFolderStructureBySearchValue(this.searchValue);this.$el.find('.folders-container').html('');this.$el.find('.projects-container').html('');this.$el.find('.folders-container').html('');this.$el.find('.projects-container').html('');var foldersCollection=folderStructure.foldersCollection;_.each(foldersCollection,this.addItemFolderView,this);var projectsCollection=folderStructure.projectsCollection;_.each(projectsCollection,this.addItemProjectView,this);}else{var folderStructure=this.getFolderStructureById(folderID);this.$el.find('.folders-container').html('');this.$el.find('.projects-container').html('');var foldersCollection=folderStructure.foldersCollection;_.each(foldersCollection,this.addItemFolderView,this);var projectsCollection=folderStructure.projectsCollection;_.each(projectsCollection,this.addItemProjectView,this);var itemsCollection=this.itemsCollection;itemsCollection.reset();_.each(foldersCollection,function(fModel){itemsCollection.add(fModel);});_.each(projectsCollection,function(pModel){itemsCollection.add(pModel);});this.itemsCollection=itemsCollection;if(this.itemsCollection.length==0){this.$el.find('.projects-container').html('<div class="noprojects-info"><span class="addproject">'+Lang.get('editor.noprojectsInfo')+'</span></div>')}}
return this;},addItemFolderView:function(listItem){_log('addItemFolderView',listItem);var folderView=FoldersFactory.createFolderByType(listItem.get('pType'),listItem);listItem.view=folderView;folderView.on('open-folder',this.openFolder,this);folderView.on('select-item',this.selectItem,this);folderView.on('delete-folder',this.deleteFolder,this);folderView.on('update-folder',this.updateFolder,this);folderView.on('on-folder-move',this.onFolderMove,this);folderView.on('make-folders-droppable',this.makeFoldersDroppableTrigger,this);folderView.on('unmake-folders-droppable',this.unmakeFoldersDroppableTrigger,this);this.$el.find('.folders-container').append(folderView.render().$el);},addItemProjectView:function(listItem){_log('addItemProjectView',listItem);_log('listItem',listItem.get('pType'));var projectView=ProjectsFactory.createProjectByType(listItem.get('pType'),listItem);listItem.view=projectView;projectView.on('open-project',this.openProject,this);projectView.on('select-item',this.selectItem,this);projectView.on('delete-project',this.deleteProject,this);projectView.on('copy-project',this.copyProject,this);projectView.on('template-project',this.templateProject,this);projectView.on('update-project',this.updateProject,this);projectView.on('make-projects-droppable',this.makeProjectsDroppableTrigger,this);projectView.on('unmake-projects-droppable',this.unmakeProjectsDroppableTrigger,this);projectView.on('on-project-move',this.onProjectMove,this);projectView.on('disconect-from-shared-projects',this.disconectFromSharedProjects,this);projectView.on('download-project',this.downloadProject,this);this.$el.find('.projects-container').append(projectView.render().$el);},disconectFromSharedProjects:function(projectModel){var _that=this;DataAccess.disconectFromSharedProjects({project:projectModel.toJSON()},function(data){_log('disconectFromSharedProjects',data,_log.dataaccessOutResult);if(!data.success){_Notify(Lang.get('utils.operationFailed'),'danger');return;}
var projectsCollection=_that.model.get('objs');projectsCollection.remove(projectModel);projectModel.view.remove();_Notify(Lang.get('utils.operationSuccessful'),'success');},function(data){_log('disconectFromSharedProjects',data,_log.dataaccessOutFault);});this.trigger('disconect-from-shared-projects',this.model);},updateFolder:function(folderModel){var _that=this;DataAccess.updateFolder({folder:folderModel.toJSON()},function(data){_log('updateFolder',data,_log.dataaccessOutResult);if(!data.success){_Notify(Lang.get('utils.operationFailed'),'danger');return;}
var name=data.data.folder.name;folderModel.set('name',name);},function(data){_log('updateFolder',data,_log.dataaccessOutFault);});},onFolderMove:function(sourceFolderModel,targetFolderModel){var _that=this;_log('onFolderMove sourceFolderModel',sourceFolderModel);_log('onFolderMove targetFolderModel',targetFolderModel);sourceFolderModel.set('folder',targetFolderModel.get('folderID'));this.renderFolderStructure();this.trigger('on-folder-moved',this.activFolderModel,this);DataAccess.moveFolder({sourceFolder:sourceFolderModel.toJSON(),targetFolder:targetFolderModel.toJSON()},function(data){_log('moveFolder',data,_log.dataaccessOutResult);if(!data.success){_Notify(Lang.get('utils.operationFailed'),'danger');return;}
_Notify(Lang.get('utils.operationSuccessful'),'success');},function(data){_log('moveFolder',data,_log.dataaccessOutFault);});},onProjectMove:function(sourceProjectModel,targetFolderModel){var _that=this;_log('onFolderMove sourceProjectModel',sourceProjectModel);_log('onFolderMove targetFolderModel',targetFolderModel);sourceProjectModel.set('folder',targetFolderModel.get('folderID'));this.renderFolderStructure();this.trigger('on-folder-moved',this.activFolderModel,this);DataAccess.moveProject({sourceProject:sourceProjectModel.toJSON(),targetFolder:targetFolderModel.toJSON()},function(data){_log('moveFolder',data,_log.dataaccessOutResult);if(!data.success){_Notify(Lang.get('utils.operationFailed'),'danger');return;}
_Notify(Lang.get('utils.operationSuccessful'),'success');},function(data){_log('moveFolder',data,_log.dataaccessOutFault);});},updateProject:function(projectModel){var _that=this;DataAccess.updateProject({project:projectModel.toJSON()},function(data){_log('updateProject',data,_log.dataaccessOutResult);if(!data.success){_Notify(Lang.get('utils.operationFailed'),'danger');return;}
var name=data.data.project.name;projectModel.set('name',name);},function(data){_log('updateProject',data,_log.dataaccessOutFault);});},deleteFolder:function(foldersStructure){var _that=this;this.trigger('on-folder-removed',this.activFolderModel,foldersStructure,this);},deleteProject:function(projectModel){var _that=this;var projectsCollection=this.model.get('objs');projectsCollection.remove(projectModel);this.renderFolderStructure();this.trigger('on-project-removed',this.activFolderModel,projectModel,this);},copyProject:function(projectModel){var _that=this;DataAccess.copyProject({project:projectModel.toJSON()},function(data){_log('copyProject',data,_log.dataaccessOutResult);if(!data.success){_Notify(Lang.get('utils.operationFailed'),'danger');return;}
switch(data.data.error){case 0:_that.showLimitProjectsWindow();return;break;default:break;}
_Notify(Lang.get('utils.operationSuccessful'),'success');var project=data.data.project;var newProjectModel=ProjectsFactory.createProjectModelByType(project.pType,project);_that.addNewProject(newProjectModel);},function(data){_log('copyProject',data,_log.dataaccessOutFault);});},showLimitProjectsWindow:function(){var limitProjectsWindow=WindowFactory.createLimitProjectsWindow();limitProjectsWindow.setTitle('Limit project');$('body').append(limitProjectsWindow.render().$el);},templateProject:function(projectModel){var _that=this;_log('projectModel',projectModel);DataAccess.templateProject({project:projectModel.toJSON()},function(data){_log('templateProject',data,_log.dataaccessOutResult);if(!data.success){_Notify(Lang.get('utils.operationFailed'),'danger');return;}
var project=data.data.project;_log('templateProject',project);var projectId=parseInt(project.project_id);var template=parseInt(project.template);var projectsCollection=_that.model.get('objs');var pModel=projectsCollection.findWhere({'project_id':projectId});_log('projectsCollection',projectsCollection);_log('projectId',projectId);if(pModel){pModel.set('template',template);}
_log('template',template);_log('pModel',pModel);_Notify(Lang.get('utils.operationSuccessful'),'success');_that.renderFolderStructure();},function(data){_log('templateProject',data,_log.dataaccessOutFault);});},downloadProject:function(projectModel){var _that=this;_log('projectModel',projectModel);DataAccess.downloadProject({project:projectModel.toJSON()},function(data){_log('downloadProject',data,_log.dataaccessOutResult);if(!data.success){_Notify(Lang.get('utils.operationFailed'),'danger');return;}
var link=data.data.link;_that.showDownloadZbitWindow(link);},function(data){_log('templateProject',data,_log.dataaccessOutFault);});},showDownloadZbitWindow:function(link){var downloadZbitWindow=WindowFactory.createDownloadZbitWindow({link:link});$('body').append(downloadZbitWindow.render().$el);},getFolderStructureById:function(folderID){var foldersCollection=this.model.get('folders');var fCollection=foldersCollection.where({'folder':folderID});var projectsCollection=this.model.get('objs');var pCollection=projectsCollection.where({'folder':folderID});return{foldersCollection:fCollection,projectsCollection:pCollection};},getFolderStructureBySearchValue:function(value){var foldersCollection=this.model.get('folders');var fCollection=foldersCollection.searchStructore(value);var projectsCollection=this.model.get('objs');var pCollection=projectsCollection.searchStructore(value);_log('value 2',value);_log('foldersCollection',foldersCollection);_log('projectsCollection',projectsCollection);_log('fCollection',fCollection);_log('pCollection',pCollection);return{foldersCollection:fCollection,projectsCollection:pCollection};},openFolder:function(folderModel){_log('openFolder',folderModel);this.resetSearchProjectsList();this.renderFolderStructure(folderModel);this.trigger('open-folder',folderModel,this);},backToFolder:function(folderModel){_log('backToFolder',folderModel);this.resetSearchProjectsList();this.renderFolderStructure(folderModel);},openProject:function(projectModel){this.trigger('open-project',projectModel);},selectItem:function(e,model){_log('e',e);_log('model',model);var itemsCollection=this.itemsCollection;if(e.shiftKey){var indexModel=itemsCollection.indexOf(model);var chFrom=0;var chTo=0;var check=false
for(var i=indexModel;i>=0;i--){var model=itemsCollection.at(i);if(model.isSelected){chFrom=i;chTo=indexModel;check=true;break;}}
if(!check){for(var i=indexModel;i<itemsCollection.length;i++){var model=itemsCollection.at(i);if(model.isSelected){chFrom=indexModel;chTo=i;check=true;break;}}}
if(check){itemsCollection.each(function(model,iModel){if((iModel<chFrom)||(iModel>chTo)){model.isSelected=false;model.view.setSelected(false);}else{model.isSelected=true;model.view.setSelected(true);}});}}else if(e.ctrlKey){if(model.isSelected){model.isSelected=false;model.view.setSelected(false);}else{model.isSelected=true;model.view.setSelected(true);}}else{itemsCollection.each(function(pModel){pModel.view.setSelected(false);});model.isSelected=true;model.view.setSelected(true);}},addNewFolder:function(folderModel){var foldersCollection=this.model.get('folders');foldersCollection.add(folderModel);foldersCollection.sort();_log('addNewFolder',this.model.get('folders'));this.renderFolderStructure();this.trigger('on-folder-added',this.activFolderModel,folderModel,this);},addNewProject:function(projectModel){var projectsCollection=this.model.get('objs');projectsCollection.add(projectModel);projectsCollection.sort();this.renderFolderStructure();this.trigger('on-project-added',this.activFolderModel,projectModel,this);},makeFoldersDroppableTrigger:function(folderModel){this.trigger('make-folders-droppable',folderModel);},unmakeFoldersDroppableTrigger:function(folderModel){this.trigger('unmake-folders-droppable',folderModel);},makeFoldersDroppable:function(folderModel){var folderStructure=this.getFolderStructureById(this.activFolderModel.get('folderID'));var foldersCollection=folderStructure.foldersCollection;_.each(foldersCollection,function(fModel){fModel.view.makeFolderDroppable();},this);},unmakeFoldersDroppable:function(folderModel){var folderStructure=this.getFolderStructureById(this.activFolderModel.get('folderID'));var foldersCollection=folderStructure.foldersCollection;_.each(foldersCollection,function(fModel){fModel.view.unmakeDroppable();},this);},makeProjectsDroppableTrigger:function(projectModel){this.trigger('make-projects-droppable',projectModel);},unmakeProjectsDroppableTrigger:function(projectModel){this.trigger('unmake-projects-droppable',projectModel);},makeProjectsDroppable:function(projectModel){var folderStructure=this.getFolderStructureById(this.activFolderModel.get('folderID'));var foldersCollection=folderStructure.foldersCollection;_.each(foldersCollection,function(fModel){fModel.view.makeProjectDroppable();},this);},unmakeProjectsDroppable:function(projectModel){var folderStructure=this.getFolderStructureById(this.activFolderModel.get('folderID'));var foldersCollection=folderStructure.foldersCollection;_.each(foldersCollection,function(fModel){fModel.view.unmakeDroppable();},this);},checkIfSharedProjectsChanged:function(data){var projectsToRemove=data.projects.projectsToRemove||[];var projectsToAdd=data.projects.projectsToAdd||[];var projectsNotShared=data.projects.projectsNotShared||[];_log('projectsToRemove',projectsToRemove);_log('projectsToAdd',projectsToAdd);var projectCollectionChanged=false;if(projectsToRemove.length>0||projectsToAdd.length>0||projectsNotShared.length>0){projectCollectionChanged=true;}
if(projectCollectionChanged){var projectsCollection=this.model.get('objs');var projectsToRemoveArray=[];for(var item in projectsToRemove){var projectId=projectsToRemove[item];var projectModel=projectsCollection.findWhere({'project_id':projectId});_log('projectsToRemove projectModel',projectModel);projectsCollection.remove(projectModel);}
var newSharedToUserProjects=[];for(var item in projectsToAdd){var project=projectsToAdd[item];var projectModel=projectsCollection.findWhere({'project_id':project.projectId});if(!projectModel){var newProjectModel=ProjectsFactory.createProjectModelByType(project.pType,project);_log('projectsToAdd newProjectModel',newProjectModel);if(newProjectModel){projectsCollection.add(newProjectModel);newSharedToUserProjects.push(newProjectModel);}}else{_log('project id exist',newProjectModel);}}
if(projectsNotShared.length){for(var item in projectsNotShared){var projectId=projectsNotShared[item];var projectModel=projectsCollection.findWhere({'project_id':projectId});if(projectModel){projectModel.set('pType','userProjects');projectModel.unset('fromuser');}
_log('projectsNotShared projectModel',projectModel);}}
this.renderFolderStructure();for(var i=0;i<newSharedToUserProjects.length;i++){var newProjectModel=newSharedToUserProjects[i];newProjectModel.trigger('new-shared-user-project');};}
return projectCollectionChanged;},searchProjectsList:function(value){this.searchValue=value;this.renderFolderStructure();},resetSearchProjectsList:function(){this.searchValue='';this.trigger('reset-search-projects-list');}});;;var BreadcrumbView=Backbone.View.extend({template:'#breadcrumb-template',breadcrumbsCollection:new BreacrumbsCollection(),initialize:function(data){this.model=data.model;},render:function(){this.$el.html('');_log('this.breadcrumbsCollection',this.breadcrumbsCollection);for(var i=this.breadcrumbsCollection.length-1;i>=0;i--){var breadcrumbItem=this.breadcrumbsCollection.at(i);this.addItemBreadcrumbView(breadcrumbItem);};return this;},addItemBreadcrumbView:function(listItem){var breadcrumbView=BreadcrumbsFactory.createBreadcrumbByType(listItem.get('pType'),listItem);breadcrumbView.on('back-to-folder',this.backToFolder,this);this.$el.append(breadcrumbView.render().$el);},refreshBreadcrumbs:function(folderModel){var _that=this;folderModel=folderModel==undefined?this.model.get('folders').findWhere({folderID:0}):folderModel;this.breadcrumbsCollection.reset();this.breadcrumbsCollection.add(folderModel);this.breadcrumbsCollection=this.getParentFolders(folderModel,this.breadcrumbsCollection);this.render();},getParentFolders:function(folderModel,breadcrumbsCollection){var foldersCollection=this.model.get('folders');var folder=folderModel.get('folder');var parentFlderModel=foldersCollection.findWhere({folderID:folder});if(parentFlderModel){breadcrumbsCollection.add(parentFlderModel);if(parentFlderModel.get('folder')!=-1){this.getParentFolders(parentFlderModel,breadcrumbsCollection);}}
return breadcrumbsCollection;},backToFolder:function(folderModel){_log('backToFolder',folderModel);this.refreshBreadcrumbs(folderModel);this.trigger('back-to-folder',folderModel,this);this.render();},setAsSearch:function(value){var foldersCollection=this.model.get('folders');var firstFolderModel=foldersCollection.findWhere({folderID:0});var folderModel=new FolderItemModel();folderModel.set('name',Lang.get('projects.breadcrumbSearch')+': ['+value+']');folderModel.set('pType','search-folder');this.breadcrumbsCollection.reset();this.breadcrumbsCollection.add(folderModel);this.breadcrumbsCollection.add(firstFolderModel);this.render();}});;;var TreeView=Backbone.View.extend({template:'#tree-template',initialize:function(){var _that=this;},render:function(){this.createHtmlTree();return this;},createHtmlTree:function(){var _that=this;this.$el.html('');var foldersCollection=this.model.get('folders').toArray();var fArray=this.getFoldersTreeArray(foldersCollection,-1);var ul=$('<ul>',{class:'main-tree-item'});var tree=this.createTree(fArray,ul);_log('fArray',fArray);_log('tree',tree);this.$el.append(tree);},createTree:function(foldersArray,ul){var _that=this;_.each(foldersArray,function(fModel){var treeView=TreeFactory.createNormalTreeView(fModel);fModel.treeView=treeView;treeView.on('go-to-folder',_that.goToFolder,_that);treeView.on('on-folder-move',_that.onFolderMove,_that);ul.append(treeView.render().$el);var ul2=$('<ul>');ul.append(ul2);_that.createTree(fModel.folders,ul2);});return ul;},onFolderMove:function(sourceFolderModel,targetFolderModel){this.trigger('on-folder-move',sourceFolderModel,targetFolderModel,this);},getFoldersTreeArray:function(foldersArray,folderID){var _that=this;var fArray=this.where(foldersArray,folderID);_.each(fArray,function(fModel){var folderID=fModel.get('folderID');fModel.folders=_that.getFoldersTreeArray(foldersArray,folderID);},this);return fArray;},where:function(foldersArray,folderID){var tempArray=[];_.each(foldersArray,function(fModel){if(fModel.get('folder')==folderID){tempArray.push(fModel);}},this);return tempArray;},goToFolder:function(folderModel){_log('backToFolder',folderModel);this.trigger('go-to-folder',folderModel,this);},update:function(activeFolderModel,folderModel){this.createHtmlTree();},makeFoldersDroppable:function(folderModel){var foldersCollection=this.model.get('folders').toArray();var droppableFoldersCollection=new FoldersCollection();_.each(foldersCollection,function(fModel){droppableFoldersCollection.add(fModel);},this);this.removeDroppableModels(folderModel,droppableFoldersCollection);droppableFoldersCollection.each(function(fModel){fModel.treeView.makeFolderDroppable();},this);},removeDroppableModels:function(folderModel,droppableFoldersCollection){var _that=this;droppableFoldersCollection.remove(folderModel);_log('removeDroppableModels tree model',folderModel,_log.timeline);_.each(folderModel.folders,function(fModel){_that.removeDroppableModels(fModel,droppableFoldersCollection);});},unmakeFoldersDroppable:function(folderModel){var foldersCollection=this.model.get('folders').toArray();_.each(foldersCollection,function(fModel){fModel.treeView.unmakeDroppable();},this);},makeProjectsDroppable:function(folderModel){var foldersCollection=this.model.get('folders').toArray();_.each(foldersCollection,function(fModel){fModel.treeView.makeProjectDroppable();},this);},unmakeProjectsDroppable:function(folderModel){var foldersCollection=this.model.get('folders').toArray();_.each(foldersCollection,function(fModel){fModel.treeView.unmakeDroppable();},this);}});;;var SearchView=Backbone.View.extend({template:_.template($('#search-template').html()),events:{'keyup .projects-list-search-input':'searchProjectList','paste .projects-list-search-input':'searchProjectList','click .remove-search-value':'removeSearchValue',},initialize:function(data){var _that=this;},render:function(){var template=this.template();this.$el.html(template);return this;},removeSearchValue:function(e){var searchInput=this.$el.find('.projects-list-search-input');searchInput.val('');searchInput.focus();this.trigger('on-search-projects-list','');},searchProjectList:function(e){var value=$(e.target).val();this.trigger('on-search-projects-list',value);},resetSearchProjectsList:function(){this.$el.find('.projects-list-search-input').val('');},});;;var ProjectListController=Backbone.View.extend({template:_.template($('#projectslist-controller-template').html()),initialize:function(){},render:function(){var template=this.template(this.serializeData());this.$el.html(template);return this;},afterRender:function(){var _that=this;this.showProjectsListLoader();DataAccess.getFoldersStructure({},function(data){_log('getFoldersStructure result',data,_log.dataaccessOutResult);_that.hideProjectsListLoader();_that.createProjectList(data);},function(data){_log('getFoldersStructure fault',data,_log.dataaccessOutFault);_that.hideProjectsListLoader();});},serializeData:function(){return{};},createProjectList:function(data){var foldersStructureFromDb=data.folderStructure;var userId=__meta__.userID;for(var i=0;i<foldersStructureFromDb.objs.length;i++){var obj=foldersStructureFromDb.objs[i];obj.project_id=parseInt(obj.project_id);if(obj.pType=='userProjects'){obj.user_id=parseInt(userId);}
if(obj.template){obj.template=parseInt(obj.template);}};var shareTemplateProjectData=data.shareTemplateProjectData;if(shareTemplateProjectData){var sharedTemplateFolder={folder:0,folderID:-5,name:Lang.get('editor.FOLDER_ITEM_SHARED_TEMPLATES'),pType:"stFolder",};foldersStructureFromDb.folders.push(sharedTemplateFolder);for(var i=0;i<shareTemplateProjectData.length;i++){var shareTemplateProjectItem=shareTemplateProjectData[i];shareTemplateProjectItem.folder=-5;foldersStructureFromDb.objs.push(shareTemplateProjectItem);};}
var model=new ProjectListModel(foldersStructureFromDb);var foldersCollection=new FoldersCollection(foldersStructureFromDb.folders);var projectsCollection=new ProjectsCollection(foldersStructureFromDb.objs);projectsCollection.sort();foldersCollection.sort();model.set('folders',foldersCollection);model.set('objs',projectsCollection);var lastVisitedFolderID=0;var firstFolderModel=foldersCollection.findWhere({'folderID':lastVisitedFolderID});_log('lastVisitedFolderID',model.get('lastVisitedFolderID'));_log('firstFolderModel',firstFolderModel);_log('foldersCollection',foldersCollection);_log('projectsCollection',projectsCollection);this.searchView=new SearchView();this.searchView.on('on-search-projects-list',this.onSearchProjectsList,this);this.$el.find('.search-wrapper').html(this.searchView.render().$el);this.treeView=new TreeView({model:model});this.treeView.on('go-to-folder',this.openFolder,this);this.treeView.on('on-folder-moved',this.openFolder,this);this.$el.find('.folders-tree-view').html(this.treeView.render().$el);this.breadcrumbView=new BreadcrumbView({model:model});this.breadcrumbView.on('back-to-folder',this.backToFolder,this);this.projectsListView=new ProjectListView({model:model});this.projectsListView.on('open-folder',this.onOpenFolder,this);this.projectsListView.on('open-project',this.openProject,this);this.projectsListView.on('on-folder-added',this.onFolderAdded,this);this.projectsListView.on('on-project-added',this.onProjectAdded,this);this.projectsListView.on('on-folder-removed',this.onFolderRemoved,this);this.projectsListView.on('on-project-removed',this.onProjectRemoved,this);this.projectsListView.on('add-project',this.addProject,this);this.projectsListView.on('on-folder-moved',this.onFolderMoved,this);this.projectsListView.on('make-folders-droppable',this.makeFoldersDroppable,this);this.projectsListView.on('unmake-folders-droppable',this.unmakeFoldersDroppable,this);this.projectsListView.on('make-projects-droppable',this.makeProjectsDroppable,this);this.projectsListView.on('unmake-projects-droppable',this.unmakeProjectsDroppable,this);this.projectsListView.on('reset-search-projects-list',this.resetSearchProjectsList,this);this.$el.find('.projects-list-views').html(this.projectsListView.render().$el);this.$el.find('.breadcrumb-view').html(this.breadcrumbView.render().$el);this.openFolder(firstFolderModel);},openProject:function(projectModel){this.trigger('open-project',projectModel);},onSearchProjectsList:function(value){if(value==''){this.breadcrumbView.refreshBreadcrumbs();}else{this.breadcrumbView.setAsSearch(value);}
this.projectsListView.searchProjectsList(value);},backToFolder:function(folderModel){this.projectsListView.backToFolder(folderModel);},onOpenFolder:function(folderModel){this.breadcrumbView.refreshBreadcrumbs(folderModel);},openFolder:function(folderModel){this.projectsListView.openFolder(folderModel);},createNewProject:function(newProjectModel){var _that=this;_log('newProjectModel',newProjectModel);_that.projectsListView.addNewProject(newProjectModel);},createNewFolder:function(newFolderModel){var _that=this;this.projectsListView.addNewFolder(newFolderModel);},onUploadZbit:function(newProjectModel){var _that=this;_log('newProjectModel',newProjectModel);_that.projectsListView.addNewProject(newProjectModel);},onFolderAdded:function(activeFolderModel,folderModel){this.treeView.update(activeFolderModel,folderModel);activeFolderModel.trigger('is-showing',activeFolderModel);folderModel.trigger('new-folder',folderModel);},onProjectAdded:function(activeFolderModel,projectModel){projectModel.trigger('new-project',projectModel);},onFolderRemoved:function(activeFolderModel,foldersStructure){foldersStructureFromDb=foldersStructure;_log('foldersStructure',foldersStructure);_log('foldersStructureFromDb',foldersStructureFromDb);this.createProjectList();var model=new ProjectListModel(foldersStructureFromDb);var foldersCollection=new FoldersCollection(foldersStructureFromDb.folders);var projectsCollection=new ProjectsCollection(foldersStructureFromDb.objs);projectsCollection.sort();foldersCollection.sort();model.set('folders',foldersCollection);model.set('objs',projectsCollection);this.treeView.model=model;this.breadcrumbView.model=model;this.projectsListView.model=model;this.treeView.update();var activeFolderModel=foldersCollection.findWhere({'folderID':activeFolderModel.get('folderID')});activeFolderModel.trigger('is-showing',activeFolderModel);this.openFolder(activeFolderModel);},onProjectRemoved:function(activeFolderModel){this.treeView.update(activeFolderModel);},onFolderMoved:function(activeFolderModel){this.treeView.update(activeFolderModel);},onFolderMovedTree:function(sourceFolderModel,targetFolderModel){this.treeView.onFolderMove(sourceFolderModel,targetFolderModel);},makeFoldersDroppable:function(folderModel){this.projectsListView.makeFoldersDroppable(folderModel);this.treeView.makeFoldersDroppable(folderModel);},unmakeFoldersDroppable:function(folderModel){this.projectsListView.unmakeFoldersDroppable(folderModel);this.treeView.unmakeFoldersDroppable(folderModel);},makeProjectsDroppable:function(projectModel){this.projectsListView.makeProjectsDroppable(projectModel);this.treeView.makeProjectsDroppable(projectModel);},unmakeProjectsDroppable:function(projectModel){this.projectsListView.unmakeProjectsDroppable(projectModel);this.treeView.unmakeProjectsDroppable(projectModel);},checkSharedProjects:function(){var _that=this;setInterval(function(){DataAccess.checkSharedProjects({},function(data){_log('checkSharedProjects',data,_log.dataaccessOutResult);if(!data.success){return;}
var sharedIsChanged=_that.projectsListView.checkIfSharedProjectsChanged(data.data);_log('sharedIsChanged',sharedIsChanged);},function(data){_log('checkSharedProjects',data,_log.dataaccessOutFault);});},8000);},resetSearchProjectsList:function(){this.searchView.resetSearchProjectsList();},showProjectsListLoader:function(){this.projectsListLoader=PreloaderFactory.createProjectsListControllerLoader();this.$el.parent().append(this.projectsListLoader.render().$el);},hideProjectsListLoader:function(){if(this.projectsListLoader){this.projectsListLoader.remove();}}});;var AppController2=Backbone.View.extend({className:'app-controller-2',template:_.template($('#app-controller-template').html()),keys:[],events:{drop:'onFileDrop'},initialize:function(){var _that=this;var darkanEditorAplicationAPI=DarkanEditorAplicationAPI.getInstance();darkanEditorAplicationAPI.connect();$(document).bind("contextmenu",function(e){if(e.currentTarget.activeElement!=undefined){if(e.currentTarget.activeElement.localName==="input"||e.currentTarget.activeElement.localName==="textarea"||e.currentTarget.activeElement.className==='note-editable'){}else{return false;}}else{return false;}});$(document).on('mousedown',function(e){if(!$(e.target).parents().is('.context-menu')&&!$(e.target).is('.context-menu')){ContextMenuContainer.closeMenu();}});$(document.body).on('keyup paste','input[type="number"]',function(){var value=$(this).val();if(value=="")$(this).val('');});$(document).on('keydown',function(e){if((e.currentTarget.activeElement.localName==="input"||e.currentTarget.activeElement.localName==="textarea"||e.currentTarget.activeElement.className==='note-editable')&&e.which!=27){_log('Zaznaczony input',{},_log.error);}else{_that.keydown(e);}
return true;});$(document).on('keyup',function(e){_that.keyup(e);});},onFileDrop:function(e){if($(e.target).parent().hasClass('component-inner')){return;}
if($('.window-import-view').length>0){return;}
var isDarkanExtension=Utils.isDarkanExtension(e);_log('isDarkanExtension',isDarkanExtension);if(isDarkanExtension){var importWindow=WindowFactory.createImportWindow();$('body').append(importWindow.render().$el);importWindow.importPsdOnDrop(e);}else{StageView.instance.uploadOnFileDrop(e);}},keydown:function(e){var _that=this;if(this.keys[e.keyCode]==undefined){this.keys[e.keyCode]=true;if(ProjectView.selected){ProjectView.selected.onKeyDown(e);}}},keyup:function(e){delete this.keys[e.keyCode];},render:function(){this.$el.attr('id','darkanapp');var template=this.template(this.serializeData());this.$el.html(template);return this;},afterRender:function(){this.connect();},serializeData:function(){return{};},connect:function(){var _that=this;DataAccess.connect({},function(){_that.onConnect()},function(){_that.onNoConnect()});this.keepSession();},onConnect:function(){var _that=this;if(this.isCreated){return;}
if(State.isTestDrive()){this.showTestDriveState();}
this.topMenuView=TopMenuView.create({projectModel:ProjectModel.instance});this.topMenuView.on('add-new-blank-page',function(){if(ProjectView.selected){ProjectView.selected.createNewPageTopMenu();}});this.topMenuView.on('open-project-version-window',function(){_that.openProjectVersionWindow();});this.topMenuView.on('open-images-window',function(){if(ProjectView.selected){ProjectView.selected.openImageWindow(2);}});this.topMenuView.on('open-video-window',function(){if(ProjectView.selected){ProjectView.selected.openVideoWindow(1);}});this.topMenuView.on('topmenu-action',function(action){if(ProjectView.selected){ProjectView.selected.topMenuAction(action);}});this.$el.find('#menu-top-wrapper').html(this.topMenuView.render().$el);this.leftMenuView=new LeftMenuView({collection:toolbarItemsCollection});this.leftMenuView.on('menu-item-click',function(model){if(ProjectView.selected){ProjectView.selected.onLeftMenuClick(model);}});this.$el.find('#menu-left-wrapper').html(this.leftMenuView.render().$el);this.projectsController=new ProjectsController();this.projectsController.on('disable-top-menu-buttons',this.disableTopMenuButtons,this);this.$el.find('#projects-controller-wrapper').html(this.projectsController.render().$el);this.projectsController.afterRender();this.isCreated=true;},disableTopMenuButtons:function(projectModel){this.topMenuView.disableTopMenuButtons(projectModel);},openProjectVersionWindow:function(activeTab){var _that=this;var projectVersionWindow=WindowFactory.createProjectVersionWindow();$('body').append(projectVersionWindow.render().$el);},onNoConnect:function(){},keepSession:function(){if(__meta__.userID!=-1){setInterval(function(){DataAccess.keepSession({},function(data){var dataJ=JSON.parse(data);if(!dataJ.login){window.location.href="http://"+__meta__.serverLink+"/auth/login";}},function(data){_log('data fault',data)});},60000);}},showTestDriveState:function(){var _that=this;if(!this.getTestDriveAsVisited()){var testDriveWindow=WindowFactory.createTestDriveWindow();$('body').append(testDriveWindow.render().$el);}
var timerWindow=WindowFactory.createTimerWindow();timerWindow.on('onTimerComplete',function(){_that.showRestartWindow();});$('body').append(timerWindow.render().$el);},getTestDriveAsVisited:function(){return Utils.getCookie('testdrive');},});;;var appController=new AppController2();$('.darkan-content').append(appController.render().$el);appController.afterRender();window.addEventListener("dragover",function(e){e=e||event;e.preventDefault();},false);window.addEventListener("drop",function(e){e=e||event;e.preventDefault();},false);;